
WITH RankedSuppliers AS (
    SELECT 
        s_name,
        s_address,
        s_phone,
        s_acctbal,
        ROW_NUMBER() OVER (PARTITION BY s_nationkey ORDER BY s_acctbal DESC) AS rank,
        s_suppkey
    FROM 
        supplier
),
FilteredParts AS (
    SELECT 
        p_name,
        p_type,
        p_size,
        p_retailprice,
        p_comment
    FROM 
        part
    WHERE 
        p_retailprice > 100 AND p_size < 20
),
CustomerOrders AS (
    SELECT 
        c.c_name,
        o.o_orderkey,
        SUM(l.l_extendedprice * (1 - l.l_discount)) AS total_revenue,
        COUNT(DISTINCT o.o_orderkey) AS order_count
    FROM 
        customer c
    JOIN 
        orders o ON c.c_custkey = o.o_custkey
    JOIN 
        lineitem l ON o.o_orderkey = l.l_orderkey
    GROUP BY 
        c.c_name
)
SELECT 
    r.r_name AS region,
    fs.p_name AS part_name,
    ra.s_name AS supplier_name,
    co.c_name AS customer_name,
    co.total_revenue,
    co.order_count
FROM 
    RankedSuppliers ra
JOIN 
    region r ON ra.rank = 1 
JOIN 
    FilteredParts fs ON ra.s_suppkey IN (
        SELECT ps.ps_suppkey 
        FROM partsupp ps 
        WHERE ps.ps_partkey IN (
            SELECT p.p_partkey 
            FROM part p 
            WHERE p.p_retailprice > 100 AND p.p_size < 20
        )
    )
JOIN 
    CustomerOrders co ON co.o_orderkey IN (
        SELECT o.o_orderkey 
        FROM orders o 
        WHERE o.o_orderstatus = 'O'
    )
WHERE 
    ra.s_acctbal > 5000
ORDER BY 
    region, total_revenue DESC;
