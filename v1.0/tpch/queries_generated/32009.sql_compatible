
WITH RECURSIVE PartHierarchy AS (
    SELECT p_partkey, p_name, p_mfgr, p_brand, p_type, p_size, p_retailprice, p_comment, 
           ROW_NUMBER() OVER (PARTITION BY p_brand ORDER BY p_retailprice DESC) AS rn
    FROM part
    WHERE p_size > 10
),
CustomerOrders AS (
    SELECT c.c_custkey, c.c_name, SUM(o.o_totalprice) AS total_spent, COUNT(o.o_orderkey) AS order_count
    FROM customer c
    JOIN orders o ON c.c_custkey = o.o_custkey
    WHERE o.o_orderdate >= DATE '1997-01-01'
    GROUP BY c.c_custkey, c.c_name
),
HighValueSuppliers AS (
    SELECT s.s_suppkey, s.s_name, s.s_acctbal,
           ROW_NUMBER() OVER (ORDER BY s.s_acctbal DESC) AS rank
    FROM supplier s
    WHERE s.s_acctbal IS NOT NULL AND s.s_acctbal > 100000
),
SalesData AS (
    SELECT l.l_orderkey, l.l_partkey, l.l_quantity * (l.l_extendedprice - l.l_extendedprice * l.l_discount) AS sale_amount,
           l.l_returnflag, l.l_shipdate
    FROM lineitem l
)
SELECT ph.p_brand, ph.p_name, SUM(sd.sale_amount) AS total_sales, 
       COUNT(DISTINCT sd.l_orderkey) AS num_orders, 
       cu.total_spent, hs.s_name AS high_value_supplier
FROM PartHierarchy ph
LEFT JOIN SalesData sd ON ph.p_partkey = sd.l_partkey
LEFT JOIN CustomerOrders cu ON cu.order_count > 10
LEFT JOIN HighValueSuppliers hs ON hs.rank <= 5
WHERE sd.l_shipdate BETWEEN DATE '1997-01-01' AND DATE '1997-12-31' 
GROUP BY ph.p_brand, ph.p_name, cu.total_spent, hs.s_name
HAVING SUM(sd.sale_amount) IS NOT NULL
ORDER BY total_sales DESC
FETCH FIRST 100 ROWS ONLY;
