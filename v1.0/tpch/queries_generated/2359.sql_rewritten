WITH SupplierRank AS (
    SELECT 
        s.s_suppkey,
        s.s_name,
        s.s_acctbal,
        RANK() OVER (PARTITION BY p.p_partkey ORDER BY s.s_acctbal DESC) as rank
    FROM supplier s
    JOIN partsupp ps ON s.s_suppkey = ps.ps_suppkey
    JOIN part p ON ps.ps_partkey = p.p_partkey
    WHERE s.s_acctbal IS NOT NULL
),
CustomerOrders AS (
    SELECT 
        c.c_custkey,
        c.c_name,
        SUM(o.o_totalprice) AS total_spent
    FROM customer c
    LEFT JOIN orders o ON c.c_custkey = o.o_custkey
    GROUP BY c.c_custkey, c.c_name
),
HighValueCustomers AS (
    SELECT 
        c.c_custkey,
        c.c_name
    FROM CustomerOrders c
    WHERE c.total_spent > (
        SELECT AVG(total_spent) FROM CustomerOrders
    )
)
SELECT 
    pr.p_partkey,
    pr.p_name,
    pr.p_retailprice,
    COALESCE(sr.s_name, 'No Supplier') AS supplier_name,
    CV.c_name AS high_value_customer_name,
    SUM(l.l_extendedprice * (1 - l.l_discount)) AS total_sales
FROM part pr
LEFT JOIN partsupp ps ON pr.p_partkey = ps.ps_partkey
LEFT JOIN supplier sr ON ps.ps_suppkey = sr.s_suppkey
LEFT JOIN lineitem l ON pr.p_partkey = l.l_partkey
LEFT JOIN HighValueCustomers CV ON l.l_orderkey IN (
    SELECT o.o_orderkey
    FROM orders o
    WHERE o.o_custkey = CV.c_custkey
)
WHERE l.l_shipdate >= '1997-01-01' 
AND l.l_shipdate < '1997-12-31'
GROUP BY pr.p_partkey, pr.p_name, pr.p_retailprice, sr.s_name, CV.c_name
ORDER BY total_sales DESC;