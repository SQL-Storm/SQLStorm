
WITH RankedOrders AS (
    SELECT 
        o.o_orderkey,
        o.o_orderdate,
        o.o_totalprice,
        o.o_orderstatus,
        ROW_NUMBER() OVER (PARTITION BY o.o_orderstatus ORDER BY o.o_orderdate DESC) AS order_rank
    FROM orders o
),
SupplierParts AS (
    SELECT 
        ps.ps_partkey,
        p.p_name,
        s.s_name,
        ps.ps_supplycost,
        ps.ps_availqty
    FROM partsupp ps
    INNER JOIN part p ON ps.ps_partkey = p.p_partkey
    INNER JOIN supplier s ON ps.ps_suppkey = s.s_suppkey
),
HighValueCustomers AS (
    SELECT 
        c.c_custkey,
        c.c_name,
        c.c_acctbal
    FROM customer c
    WHERE c.c_acctbal > (
        SELECT AVG(c2.c_acctbal) 
        FROM customer c2
    )
),
OrderDetails AS (
    SELECT 
        lo.l_orderkey,
        SUM(lo.l_extendedprice * (1 - lo.l_discount)) AS total_sales,
        COUNT(lo.l_linenumber) AS item_count
    FROM lineitem lo
    GROUP BY lo.l_orderkey
)
SELECT 
    r.o_orderkey,
    r.o_orderdate,
    r.o_totalprice,
    sp.p_name,
    sp.s_name,
    COALESCE(od.total_sales, 0) AS total_order_sales,
    (SELECT COUNT(DISTINCT c.c_custkey) 
     FROM HighValueCustomers hvc
     WHERE hvc.c_custkey = r.o_custkey) AS high_value_indicator
FROM RankedOrders r
LEFT JOIN OrderDetails od ON r.o_orderkey = od.l_orderkey
LEFT JOIN SupplierParts sp ON sp.ps_partkey IN (
    SELECT ps.ps_partkey 
    FROM partsupp ps 
    WHERE ps.ps_availqty > 10
)
WHERE r.order_rank <= 5
AND r.o_orderstatus = 'O'
ORDER BY r.o_orderdate DESC, r.o_totalprice DESC;
