
WITH RankedParts AS (
    SELECT 
        p.p_partkey,
        p.p_name,
        p.p_retailprice,
        ROW_NUMBER() OVER (PARTITION BY p.p_brand ORDER BY p.p_retailprice DESC) AS rn
    FROM 
        part p
    WHERE 
        p.p_retailprice > (SELECT AVG(p1.p_retailprice) FROM part p1 WHERE p1.p_type = p.p_type)
),
SupplierStats AS (
    SELECT 
        s.s_nationkey,
        COUNT(DISTINCT ps.ps_suppkey) AS total_suppliers,
        SUM(ps.ps_availqty) AS total_availqty,
        AVG(s.s_acctbal) AS avg_acctbal
    FROM 
        supplier s
    JOIN 
        partsupp ps ON s.s_suppkey = ps.ps_suppkey
    GROUP BY 
        s.s_nationkey
),
FilteredOrders AS (
    SELECT 
        o.o_orderkey,
        o.o_orderdate,
        o.o_totalprice,
        SUBSTRING(o.o_comment, 1, 20) AS short_comment,
        (SELECT COUNT(*) FROM lineitem l WHERE l.l_orderkey = o.o_orderkey AND l.l_returnflag = 'R') AS return_count
    FROM 
        orders o
    WHERE 
        o.o_totalprice > (SELECT AVG(o1.o_totalprice) FROM orders o1) 
        AND o.o_orderstatus IN ('O', 'P')
)
SELECT 
    np.n_name,
    COUNT(DISTINCT fo.o_orderkey) AS order_count,
    SUM(CASE WHEN fo.return_count > 0 THEN 1 ELSE 0 END) AS returned_orders,
    SUM(COALESCE(rp.p_retailprice, 0)) AS total_retailprice,
    AVG(ss.avg_acctbal) AS avg_supplier_acctbal
FROM 
    nation np
LEFT JOIN 
    SupplierStats ss ON ss.s_nationkey = np.n_nationkey
LEFT JOIN 
    FilteredOrders fo ON fo.o_orderkey IN (
        SELECT DISTINCT l.l_orderkey 
        FROM lineitem l 
        WHERE l.l_partkey IN (SELECT rp.p_partkey FROM RankedParts rp WHERE rp.rn <= 5)
    )
LEFT JOIN 
    RankedParts rp ON rp.p_partkey IN (
        SELECT DISTINCT ps.ps_partkey 
        FROM partsupp ps 
        WHERE ps.ps_availqty > 100
    )
GROUP BY 
    np.n_nationkey, np.n_name
HAVING 
    COUNT(DISTINCT fo.o_orderkey) > 0 OR SUM(COALESCE(rp.p_retailprice, 0)) > 0
ORDER BY 
    np.n_name ASC;
