
WITH StringAggregations AS (
    SELECT 
        p.p_partkey,
        UPPER(p.p_name) AS upper_name,
        LOWER(p.p_comment) AS lower_comment,
        CHAR_LENGTH(p.p_name) AS name_length,
        REPLACE(p.p_comment, ' ', '') AS comment_without_spaces,
        CONCAT(p.p_name, ' - ', p.p_comment) AS combined_info,
        SUBSTRING(p.p_name, 1, 10) AS name_part,
        CHAR_LENGTH(p.p_comment) AS comment_length,
        REGEXP_REPLACE(p.p_comment, '[^a-zA-Z]', '') AS comment_alphabets_only
    FROM 
        part p
),
CustomerAggregations AS (
    SELECT 
        c.c_custkey,
        SUBSTRING(c.c_name, 1, 5) AS short_name,
        CONCAT(c.c_address, ' - ', c.c_mktsegment) AS address_market,
        LPAD(c.c_custkey, 10, '0') AS padded_custkey,
        CHAR_LENGTH(c.c_address) AS address_length
    FROM 
        customer c
),
SupplierJoin AS (
    SELECT 
        s.s_suppkey,
        s.s_name,
        s.s_comment,
        n.n_name AS nation_name,
        CONCAT(n.n_name, ': ', s.s_comment) AS nation_comment_info
    FROM 
        supplier s
    JOIN 
        nation n ON s.s_nationkey = n.n_nationkey
)
SELECT 
    sa.p_partkey,
    sa.upper_name,
    ca.c_custkey,
    ca.short_name,
    sj.s_name,
    sj.nation_name,
    CHAR_LENGTH(sa.combined_info) AS combined_length,
    COUNT(DISTINCT sj.nation_comment_info) AS unique_nation_comment_info,
    MAX(ca.address_length) AS max_address_length
FROM 
    StringAggregations sa
JOIN 
    CustomerAggregations ca ON MOD(sa.p_partkey, 100) = MOD(ca.c_custkey, 100)
JOIN 
    SupplierJoin sj ON MOD(sj.s_suppkey, 100) = MOD(sa.p_partkey, 100)
GROUP BY 
    sa.p_partkey, sa.upper_name, ca.c_custkey, ca.short_name, sj.s_name, sj.nation_name
HAVING 
    CHAR_LENGTH(sa.combined_info) > 50
ORDER BY 
    combined_length DESC
FETCH FIRST 100 ROWS ONLY;
