
WITH RECURSIVE SupplierHierarchy AS (
    SELECT s_suppkey, s_name, s_nationkey, NULL AS parent_suppkey, s_acctbal
    FROM supplier
    WHERE s_acctbal > 1000
    UNION ALL
    SELECT s.s_suppkey, s.s_name, s.s_nationkey, sh.s_suppkey, s.s_acctbal
    FROM supplier s
    JOIN SupplierHierarchy sh ON s.s_nationkey = sh.s_nationkey
    WHERE s.s_acctbal > sh.s_acctbal
),
TotalSales AS (
    SELECT l.l_partkey, SUM(l.l_extendedprice * (1 - l.l_discount)) AS total_sales
    FROM lineitem l
    JOIN orders o ON l.l_orderkey = o.o_orderkey
    WHERE o.o_orderdate >= DATE '1997-01-01' AND o.o_orderdate < DATE '1998-01-01'
    GROUP BY l.l_partkey
),
PartSales AS (
    SELECT p.p_partkey, p.p_name, COALESCE(ts.total_sales, 0) AS total_sales
    FROM part p
    LEFT JOIN TotalSales ts ON p.p_partkey = ts.l_partkey
),
SupplierParts AS (
    SELECT ps.ps_partkey, COUNT(DISTINCT ps.ps_suppkey) AS num_suppliers
    FROM partsupp ps
    GROUP BY ps.ps_partkey
)
SELECT ph.p_partkey, ph.p_name, ph.total_sales, sp.num_suppliers
FROM PartSales ph
JOIN SupplierParts sp ON ph.p_partkey = sp.ps_partkey
LEFT JOIN SupplierHierarchy sh ON sh.s_nationkey = (
    SELECT nc.c_nationkey
    FROM customer nc
    WHERE nc.c_custkey = (SELECT o.o_custkey FROM orders o LIMIT 1)
    LIMIT 1
)
WHERE ph.total_sales > 1000.00 AND sp.num_suppliers > 5
ORDER BY ph.total_sales DESC, sp.num_suppliers ASC
LIMIT 10;
