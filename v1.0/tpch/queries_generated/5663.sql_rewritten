WITH RankedSuppliers AS (
    SELECT s.s_suppkey, s.s_name, s.s_nationkey, SUM(ps.ps_supplycost * ps.ps_availqty) AS total_cost
    FROM supplier s
    JOIN partsupp ps ON s.s_suppkey = ps.ps_suppkey
    GROUP BY s.s_suppkey, s.s_name, s.s_nationkey
),
TopSuppliers AS (
    SELECT rs.*, 
           ROW_NUMBER() OVER (PARTITION BY n.n_regionkey ORDER BY rs.total_cost DESC) AS rnk
    FROM RankedSuppliers rs
    JOIN nation n ON rs.s_nationkey = n.n_nationkey
),
OrderStats AS (
    SELECT o.o_orderkey, SUM(l.l_extendedprice * (1 - l.l_discount)) AS total_revenue
    FROM orders o
    JOIN lineitem l ON o.o_orderkey = l.l_orderkey
    WHERE o.o_orderdate >= DATE '1997-01-01' AND o.o_orderdate < DATE '1997-12-31'
    GROUP BY o.o_orderkey
)
SELECT 
    ns.r_name AS supplier_region,
    COUNT(DISTINCT os.o_orderkey) AS total_orders,
    SUM(os.total_revenue) AS total_generated_revenue,
    COUNT(DISTINCT ts.s_suppkey) AS number_of_top_suppliers
FROM TopSuppliers ts
JOIN nation ns ON ts.s_nationkey = ns.n_nationkey
JOIN OrderStats os ON ts.s_suppkey IN (
    SELECT ps.ps_suppkey
    FROM partsupp ps
    WHERE ps.ps_partkey IN (
        SELECT p.p_partkey
        FROM part p
        WHERE p.p_size = 20
    )
)
WHERE ts.rnk <= 5
GROUP BY ns.r_name
ORDER BY total_generated_revenue DESC;