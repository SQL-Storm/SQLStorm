WITH RECURSIVE supplier_hierarchy AS (
    SELECT s.s_suppkey, s.s_name, s.s_acctbal, 1 AS level
    FROM supplier s
    WHERE s.s_acctbal IS NOT NULL AND s.s_acctbal > (SELECT AVG(s_acctbal) FROM supplier WHERE s_acctbal IS NOT NULL)
    
    UNION ALL

    SELECT s.s_suppkey, s.s_name, s.s_acctbal, sh.level + 1
    FROM supplier s
    INNER JOIN supplier_hierarchy sh ON s.s_suppkey = sh.s_suppkey
    WHERE s.s_acctbal < sh.s_acctbal
),
top_part AS (
    SELECT p.p_partkey, p.p_name, SUM(l.l_extendedprice * (1 - l.l_discount)) AS total_revenue
    FROM part p
    JOIN lineitem l ON p.p_partkey = l.l_partkey
    WHERE l.l_shipdate BETWEEN DATE '1996-01-01' AND DATE '1996-12-31'
    GROUP BY p.p_partkey, p.p_name
    ORDER BY total_revenue DESC
    LIMIT 10
),
nations_with_order_counts AS (
    SELECT n.n_nationkey, n.n_name, COUNT(DISTINCT o.o_orderkey) AS order_count
    FROM nation n
    LEFT JOIN customer c ON n.n_nationkey = c.c_nationkey
    LEFT JOIN orders o ON c.c_custkey = o.o_custkey
    GROUP BY n.n_nationkey, n.n_name
),
supplier_orders AS (
    SELECT s.s_suppkey, COUNT(DISTINCT o.o_orderkey) AS supplier_order_count
    FROM supplier s
    LEFT JOIN partsupp ps ON s.s_suppkey = ps.ps_suppkey
    LEFT JOIN lineitem l ON ps.ps_partkey = l.l_partkey
    LEFT JOIN orders o ON l.l_orderkey = o.o_orderkey
    GROUP BY s.s_suppkey
),
final_selection AS (
    SELECT n.n_name, ns.order_count, so.supplier_order_count, sh.level
    FROM nations_with_order_counts ns
    JOIN supplier_orders so ON ns.order_count > so.supplier_order_count
    JOIN supplier_hierarchy sh ON sh.s_suppkey = so.s_suppkey
)
SELECT 
    fs.n_name,
    COALESCE(fs.order_count, 0) AS order_count,
    COALESCE(fs.supplier_order_count, 0) AS supplier_order_count,
    SHIP_TYPES.ship_type,
    CONCAT('Supplier: ', ss.s_name, ', Level: ', fs.level) AS supplier_info
FROM final_selection fs
LEFT JOIN (
    SELECT DISTINCT l_shipmode AS ship_type
    FROM lineitem
) SHIP_TYPES ON fs.supplier_order_count > 5
LEFT JOIN supplier ss ON ss.s_suppkey = fs.supplier_order_count
ORDER BY fs.order_count DESC, fs.supplier_order_count ASC;