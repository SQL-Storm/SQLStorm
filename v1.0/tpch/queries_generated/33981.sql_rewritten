WITH RECURSIVE SupplierHierarchy AS (
    SELECT s.s_suppkey, s.s_name, s.s_nationkey, s.s_acctbal,
           CAST(s.s_name AS varchar(255)) AS hierarchy_path
    FROM supplier s
    WHERE s.s_acctbal > (SELECT AVG(s2.s_acctbal) FROM supplier s2)
    
    UNION ALL
    
    SELECT ps.s_suppkey, s.s_name, s.n_nationkey, s.s_acctbal,
           CONCAT(h.hierarchy_path, ' -> ', s.s_name) AS hierarchy_path
    FROM SupplierHierarchy h
    JOIN partsupp ps ON h.s_suppkey = ps.ps_suppkey
    JOIN supplier s ON ps.ps_suppkey = s.s_suppkey
)
SELECT r.r_name, 
       COUNT(DISTINCT c.c_custkey) AS customer_count,
       SUM(o.o_totalprice) AS total_order_value,
       AVG(l.l_extendedprice) AS avg_lineitem_price,
       STRING_AGG(DISTINCT CONCAT(p.p_name, ' (', p.p_brand, ')'), ', ') AS parts_info,
       SUM(CASE 
           WHEN l.l_discount > 0.1 THEN l.l_extendedprice * (1 - l.l_discount) 
           ELSE 0 
           END) AS total_discounted_value
FROM region r
LEFT JOIN nation n ON r.r_regionkey = n.n_regionkey
LEFT JOIN supplier s ON n.n_nationkey = s.s_nationkey
LEFT JOIN customer c ON s.s_suppkey = c.c_nationkey
LEFT JOIN orders o ON c.c_custkey = o.o_custkey
LEFT JOIN lineitem l ON o.o_orderkey = l.l_orderkey
LEFT JOIN part p ON l.l_partkey = p.p_partkey
WHERE l.l_shipdate BETWEEN '1996-01-01' AND '1996-12-31'
  AND (o.o_orderstatus = 'F' OR o.o_orderstatus IS NULL)
GROUP BY r.r_name
HAVING SUM(l.l_quantity) > (SELECT AVG(l2.l_quantity) 
                             FROM lineitem l2 
                             WHERE l2.l_shipdate > cast('1998-10-01 12:34:56' as timestamp) - INTERVAL '1 year')
ORDER BY customer_count DESC
LIMIT 10;