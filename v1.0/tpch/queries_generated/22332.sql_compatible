
WITH RECURSIVE SupplyChain AS (
    SELECT s.s_suppkey, s.s_name, s.s_acctbal, p.p_partkey, p.p_name, 
           ps.ps_availqty, ps.ps_supplycost, 
           ROW_NUMBER() OVER (PARTITION BY s.s_suppkey ORDER BY ps.ps_supplycost DESC) AS rn
    FROM supplier s
    JOIN partsupp ps ON s.s_suppkey = ps.ps_suppkey
    JOIN part p ON ps.ps_partkey = p.p_partkey
    WHERE p.p_retailprice >= 200.00
      AND s.s_acctbal IS NOT NULL
    UNION ALL
    SELECT s.s_suppkey, s.s_name, s.s_acctbal, p.p_partkey, p.p_name, 
           ps.ps_availqty, ps.ps_supplycost, 
           NULL AS rn
    FROM SupplyChain sc
    JOIN supplier s ON sc.s_suppkey = s.s_suppkey
    JOIN partsupp ps ON s.s_suppkey = ps.ps_suppkey
    JOIN part p ON ps.ps_partkey = p.p_partkey
    WHERE (sc.rn < 5 OR sc.s_acctbal < 1000.00)
      AND (s.s_comment NOT LIKE '%important%' OR s.s_acctbal IS NULL)
),
CustomerOrders AS (
    SELECT c.c_custkey, COUNT(o.o_orderkey) AS total_orders,
           SUM(o.o_totalprice) AS total_spent,
           MAX(o.o_orderdate) AS last_order_date
    FROM customer c
    LEFT JOIN orders o ON c.c_custkey = o.o_custkey
    GROUP BY c.c_custkey
),
HighValueOrders AS (
    SELECT o.o_orderkey, o.o_custkey, SUM(l.l_extendedprice * (1 - l.l_discount)) AS high_value
    FROM orders o
    JOIN lineitem l ON o.o_orderkey = l.l_orderkey
    WHERE l.l_discount BETWEEN 0.1 AND 0.25
    GROUP BY o.o_orderkey, o.o_custkey
),
FinalReport AS (
    SELECT sc.s_name, sc.p_name, sc.ps_availqty, 
           COALESCE(co.total_orders, 0) AS total_orders, 
           COALESCE(co.total_spent, 0) AS total_spent, 
           COALESCE(hvo.high_value, 0) AS high_value, 
           DENSE_RANK() OVER (PARTITION BY sc.s_suppkey ORDER BY COALESCE(hvo.high_value, 0) DESC) AS value_rank
    FROM SupplyChain sc
    LEFT JOIN CustomerOrders co ON sc.s_suppkey = co.c_custkey
    LEFT JOIN HighValueOrders hvo ON co.c_custkey = hvo.o_custkey
    WHERE (co.total_spent IS NULL OR sc.ps_availqty > 10) 
      AND (hvo.high_value > 5000 OR hvo.high_value IS NULL)
)
SELECT * 
FROM FinalReport
WHERE value_rank <= 10
ORDER BY s_name, p_name;
