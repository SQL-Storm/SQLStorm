WITH RankedParts AS (
    SELECT 
        p.p_partkey,
        p.p_name,
        p.p_brand,
        p.p_mfgr,
        p.p_retailprice,
        ROW_NUMBER() OVER (PARTITION BY p.p_brand ORDER BY p.p_retailprice DESC) as price_rank
    FROM 
        part p
    WHERE 
        p.p_retailprice > (
            SELECT AVG(p2.p_retailprice) 
            FROM part p2 
            WHERE p2.p_size < 20
        )
),
TopSuppliers AS (
    SELECT 
        s.s_suppkey,
        s.s_name,
        s.s_acctbal,
        ROW_NUMBER() OVER (ORDER BY s.s_acctbal DESC) as acctbal_rank
    FROM 
        supplier s
    WHERE 
        s.s_comment LIKE '%reliable%'
),
CombinedData AS (
    SELECT 
        rp.p_partkey,
        rp.p_name,
        rp.p_brand,
        ts.s_suppkey,
        ts.s_name,
        ts.s_acctbal,
        rp.price_rank,
        ts.acctbal_rank
    FROM 
        RankedParts rp
    JOIN 
        partsupp ps ON rp.p_partkey = ps.ps_partkey
    JOIN 
        TopSuppliers ts ON ps.ps_suppkey = ts.s_suppkey
)
SELECT 
    c.c_custkey,
    c.c_name,
    c.c_mktsegment,
    SUM(cd.p_retailprice) AS total_value,
    COUNT(DISTINCT cd.p_partkey) AS unique_parts,
    SUM(ts.s_acctbal) AS total_acctbal
FROM 
    CombinedData cd
JOIN 
    customer c ON cd.s_suppkey = c.c_custkey  
WHERE 
    cd.price_rank <= 5 
    AND cd.acctbal_rank <= 10
GROUP BY 
    c.c_custkey, c.c_name, c.c_mktsegment
ORDER BY 
    total_value DESC;