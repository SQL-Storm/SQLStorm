
WITH RECURSIVE TopRegions AS (
    SELECT r.r_regionkey, r.r_name, r.r_comment, 
           ROW_NUMBER() OVER (ORDER BY COUNT(DISTINCT n.n_nationkey) DESC) AS region_rank
    FROM region r
    JOIN nation n ON r.r_regionkey = n.n_regionkey
    GROUP BY r.r_regionkey, r.r_name, r.r_comment
), SupplierStats AS (
    SELECT s.s_suppkey, s.s_name, SUM(ps.ps_supplycost) AS total_supply_cost,
           COUNT(DISTINCT ps.ps_partkey) AS total_parts,
           SUM(CASE WHEN ps.ps_availqty < 50 THEN ps.ps_availqty ELSE 0 END) AS limited_avail
    FROM supplier s
    JOIN partsupp ps ON s.s_suppkey = ps.ps_suppkey
    GROUP BY s.s_suppkey, s.s_name
), OrderStats AS (
    SELECT o.o_orderkey, o.o_custkey, SUM(l.l_extendedprice * (1 - l.l_discount)) AS order_total
    FROM orders o
    JOIN lineitem l ON o.o_orderkey = l.l_orderkey
    GROUP BY o.o_orderkey, o.o_custkey
), RankedOrders AS (
    SELECT o.custkey, o.o_orderkey, o.order_total,
           RANK() OVER (PARTITION BY o.custkey ORDER BY o.order_total DESC) AS order_rank
    FROM OrderStats o
)
SELECT r.r_name AS region_name, 
       COUNT(DISTINCT s.s_suppkey) AS supplier_count,
       SUM(ss.total_supply_cost) AS total_cost,
       AVG(ss.total_parts) AS avg_parts,
       MAX(ss.limited_avail) AS max_limited_avail,
       (SELECT COUNT(*) 
        FROM RankedOrders ro 
        WHERE ro.custkey IN (
            SELECT c.c_custkey 
            FROM customer c 
            WHERE c.c_nationkey = (
                SELECT n.n_nationkey 
                FROM nation n 
                WHERE n.n_regionkey = r.r_regionkey
            )
        ) AND ro.order_rank <= 5) AS top_order_customers
FROM TopRegions r
LEFT JOIN SupplierStats ss ON r.region_rank > 1
GROUP BY r.r_regionkey, r.r_name, r.r_comment
ORDER BY supplier_count DESC, total_cost DESC;
