WITH RankedParts AS (
    SELECT 
        p.p_partkey,
        p.p_name,
        p.p_brand,
        p.p_retailprice,
        ROW_NUMBER() OVER (PARTITION BY p.p_brand ORDER BY p.p_retailprice DESC) AS rk
    FROM 
        part p
    WHERE 
        p.p_retailprice > 100
),
SupplierStats AS (
    SELECT 
        s.s_nationkey,
        COUNT(DISTINCT s.s_suppkey) AS total_suppliers,
        AVG(s.s_acctbal) AS avg_acctbal
    FROM 
        supplier s
    WHERE 
        s.s_acctbal > 1000
    GROUP BY 
        s.s_nationkey
),
RelevantOrders AS (
    SELECT 
        o.o_orderkey,
        o.o_totalprice,
        o.o_orderdate,
        SUM(li.l_extendedprice * (1 - li.l_discount)) AS total_lineitem_value,
        COUNT(DISTINCT o.o_custkey) AS total_customers
    FROM 
        orders o
    LEFT JOIN 
        lineitem li ON o.o_orderkey = li.l_orderkey
    WHERE 
        o.o_orderdate >= DATE '1997-01-01'
    GROUP BY 
        o.o_orderkey, o.o_totalprice, o.o_orderdate
)
SELECT 
    r.r_name,
    COUNT(DISTINCT p.p_partkey) AS part_count,
    AVG(p.p_retailprice) AS avg_retail_price,
    ss.total_suppliers,
    ss.avg_acctbal,
    COALESCE(RO.total_lineitem_value, 0) AS total_order_value,
    COALESCE(RO.total_customers, 0) AS customer_count
FROM 
    RankedParts p
JOIN 
    supplier s ON p.p_partkey = (SELECT ps.ps_partkey FROM partsupp ps WHERE ps.ps_suppkey = s.s_suppkey LIMIT 1)
FULL OUTER JOIN 
    nation n ON s.s_nationkey = n.n_nationkey
JOIN 
    region r ON n.n_regionkey = r.r_regionkey
LEFT JOIN 
    SupplierStats ss ON s.s_nationkey = ss.s_nationkey
LEFT JOIN 
    RelevantOrders RO ON s.s_suppkey = (SELECT li.l_suppkey FROM lineitem li WHERE li.l_orderkey IN (SELECT o.o_orderkey FROM orders o WHERE o.o_custkey = s.s_nationkey) LIMIT 1)
WHERE 
    p.rk <= 5
GROUP BY 
    r.r_name, ss.total_suppliers, ss.avg_acctbal, RO.total_lineitem_value, RO.total_customers
ORDER BY 
    avg_retail_price DESC;