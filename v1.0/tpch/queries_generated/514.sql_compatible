
WITH RankedSuppliers AS (
    SELECT 
        s.s_suppkey,
        s.s_name,
        s.s_acctbal,
        RANK() OVER (PARTITION BY ps.ps_partkey ORDER BY s.s_acctbal DESC) AS supplier_rank
    FROM 
        supplier s
    JOIN 
        partsupp ps ON s.s_suppkey = ps.ps_suppkey
),
TotalLineItems AS (
    SELECT 
        l.l_orderkey,
        SUM(l.l_extendedprice * (1 - l.l_discount)) AS total_price
    FROM 
        lineitem l
    GROUP BY 
        l.l_orderkey
),
NationAggregates AS (
    SELECT 
        n.n_nationkey,
        MIN(s.s_acctbal) AS min_acctbal,
        MAX(s.s_acctbal) AS max_acctbal,
        COUNT(DISTINCT c.c_custkey) AS customer_count
    FROM 
        nation n
    JOIN 
        supplier s ON n.n_nationkey = s.s_nationkey
    JOIN 
        customer c ON n.n_nationkey = c.c_nationkey
    GROUP BY 
        n.n_nationkey
)
SELECT 
    r.r_name,
    COALESCE(ta.total_price, 0) AS total_amount,
    ROUND(AVG(na.min_acctbal), 2) AS avg_min_acctbal,
    ROUND(AVG(na.max_acctbal), 2) AS avg_max_acctbal,
    STRING_AGG(DISTINCT rs.s_name, ', ') AS top_suppliers
FROM 
    region r
LEFT JOIN 
    nation n ON r.r_regionkey = n.n_regionkey
LEFT JOIN 
    NationAggregates na ON n.n_nationkey = na.n_nationkey
LEFT JOIN 
    TotalLineItems ta ON ta.l_orderkey IN (
        SELECT 
            o.o_orderkey 
        FROM 
            orders o 
        WHERE 
            o.o_orderstatus = 'F' AND 
            o.o_orderdate >= DATE '1997-01-01' 
    )
LEFT JOIN 
    RankedSuppliers rs ON rs.s_suppkey IN (
        SELECT 
            ps.ps_suppkey 
        FROM 
            partsupp ps 
        WHERE 
            ps.ps_availqty > 50 AND 
            ps.ps_supplycost < (SELECT AVG(ps.ps_supplycost) FROM partsupp)
    )
GROUP BY 
    r.r_name
ORDER BY 
    total_amount DESC, 
    r.r_name;
