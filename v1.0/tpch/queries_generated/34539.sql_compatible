
WITH RECURSIVE RegionHierarchy AS (
    SELECT r_regionkey, r_name, r_comment, 1 AS depth
    FROM region
    WHERE r_regionkey = 1  
    UNION ALL
    SELECT r.r_regionkey, r.r_name, r.r_comment, rh.depth + 1
    FROM region r
    JOIN RegionHierarchy rh ON r.r_regionkey = rh.r_regionkey + 1  
),
CustomerOrderStats AS (
    SELECT c.c_custkey, c.c_name, COUNT(o.o_orderkey) AS order_count,
           SUM(o.o_totalprice) AS total_spent,
           AVG(o.o_totalprice) AS avg_order_value
    FROM customer c
    LEFT JOIN orders o ON c.c_custkey = o.o_custkey
    GROUP BY c.c_custkey, c.c_name
    HAVING SUM(o.o_totalprice) IS NOT NULL
),
SupplierPartStats AS (
    SELECT s.s_suppkey, SUM(ps.ps_availqty) AS total_available,
           SUM(ps.ps_supplycost) AS total_cost,
           MAX(ps.ps_supplycost) AS max_cost
    FROM supplier s
    JOIN partsupp ps ON s.s_suppkey = ps.ps_suppkey
    GROUP BY s.s_suppkey
),
TopProducts AS (
    SELECT p.p_partkey, p.p_name, SUM(l.l_extendedprice) AS total_revenue,
           DENSE_RANK() OVER (ORDER BY SUM(l.l_extendedprice) DESC) AS revenue_rank
    FROM part p
    JOIN lineitem l ON p.p_partkey = l.l_partkey
    WHERE l.l_shipdate >= DATE '1996-01-01' AND l.l_shipdate < DATE '1997-01-01'
    GROUP BY p.p_partkey, p.p_name
),
FinalReport AS (
    SELECT 
        rh.r_name AS region_name,
        c.c_name AS customer_name,
        COALESCE(cs.order_count, 0) AS order_count,
        COALESCE(cs.total_spent, 0.00) AS total_spent,
        COALESCE(cs.avg_order_value, 0.00) AS avg_order_value,
        ps.total_available,
        ps.total_cost,
        ps.max_cost,
        tp.p_name AS top_product_name,
        tp.total_revenue
    FROM RegionHierarchy rh
    LEFT JOIN CustomerOrderStats cs ON rh.r_regionkey = cs.c_custkey
    LEFT JOIN SupplierPartStats ps ON ps.total_available > 0
    LEFT JOIN TopProducts tp ON tp.revenue_rank <= 10  
    WHERE rh.depth <= 3  
)
SELECT * 
FROM FinalReport
WHERE (total_spent > 10000 OR total_available IS NOT NULL)
ORDER BY region_name, customer_name;
