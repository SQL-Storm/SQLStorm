
WITH RankedSizes AS (
    SELECT 
        p_name,
        p_size,
        ROW_NUMBER() OVER (PARTITION BY p_size ORDER BY p_retailprice DESC) AS rank
    FROM 
        part
),
FilteredParts AS (
    SELECT 
        p_partkey,
        p_name,
        p_retailprice,
        p_size,
        p_comment
    FROM 
        part
    WHERE 
        p_name LIKE '%widget%' AND
        p_retailprice > (
            SELECT AVG(p_retailprice) FROM part WHERE p_size < 5
        )
),
SupplierCount AS (
    SELECT 
        p_partkey,
        COUNT(DISTINCT ps_suppkey) AS supplier_count
    FROM 
        partsupp
    GROUP BY 
        p_partkey
)
SELECT 
    f.p_name,
    f.p_size,
    f.p_retailprice,
    f.p_comment,
    COALESCE(rc.supplier_count, 0) AS supplier_count,
    CONCAT('Size Rank: ', r.rank) AS size_rank_info
FROM 
    FilteredParts f
LEFT JOIN 
    SupplierCount rc ON f.p_partkey = rc.p_partkey
JOIN 
    RankedSizes r ON f.p_name = r.p_name
WHERE 
    r.rank <= 3
ORDER BY 
    f.p_retailprice DESC, f.p_name;
