
SELECT
    SUM(CASE WHEN LENGTH(p_name) > 10 THEN 1 ELSE 0 END) AS long_part_names,
    MIN(LENGTH(p_comment)) AS min_comment_length,
    MAX(LENGTH(s_comment)) AS max_supplier_comment_length,
    COUNT(DISTINCT c_nationkey) AS distinct_nations,
    AVG(LENGTH(s_name)) AS avg_supplier_name_length,
    ARRAY_AGG(DISTINCT SUBSTRING(p_type, 1, 10)) AS sample_part_types,
    COUNT(*) FILTER (WHERE o_orderstatus = 'O') AS open_orders,
    STRING_AGG(DISTINCT r_name, ', ') AS region_names,
    r.r_regionkey
FROM
    part
JOIN partsupp ON part.p_partkey = partsupp.ps_partkey
JOIN supplier ON partsupp.ps_suppkey = supplier.s_suppkey
JOIN customer ON supplier.s_nationkey = customer.c_nationkey
JOIN orders ON customer.c_custkey = orders.o_custkey
JOIN nation ON supplier.s_nationkey = nation.n_nationkey
JOIN region ON nation.n_regionkey = region.r_regionkey
GROUP BY r.r_regionkey
HAVING COUNT(DISTINCT o_orderkey) > 10
ORDER BY long_part_names DESC, avg_supplier_name_length ASC;
