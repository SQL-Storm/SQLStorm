WITH RankedCustomers AS (
    SELECT c.c_custkey, c.c_name, c.c_acctbal, 
           RANK() OVER (ORDER BY c.c_acctbal DESC) AS rank
    FROM customer c
    WHERE c.c_acctbal > 50000
),
HighValueSuppliers AS (
    SELECT s.s_suppkey, s.s_name, s.s_acctbal
    FROM supplier s
    WHERE s.s_acctbal > 200000
),
CustomerOrderStats AS (
    SELECT o.o_custkey, COUNT(o.o_orderkey) AS total_orders, 
           SUM(o.o_totalprice) AS total_revenue
    FROM orders o
    GROUP BY o.o_custkey
),
SupplierPartCount AS (
    SELECT ps.ps_suppkey, COUNT(DISTINCT ps.ps_partkey) AS num_parts
    FROM partsupp ps
    GROUP BY ps.ps_suppkey
),
FinalReport AS (
    SELECT rc.c_name, rc.c_acctbal, 
           cos.total_orders, cos.total_revenue,
           spc.num_parts
    FROM RankedCustomers rc
    JOIN CustomerOrderStats cos ON rc.c_custkey = cos.o_custkey
    LEFT JOIN SupplierPartCount spc ON rc.c_custkey = (
        SELECT s.s_nationkey FROM supplier s WHERE s.s_suppkey = spc.ps_suppkey
        LIMIT 1 
    )
    WHERE rc.rank <= 10
)

SELECT r.r_name, COUNT(fr.c_name) AS active_customers,
       AVG(fr.total_revenue) AS avg_revenue,
       SUM(fr.num_parts) AS total_parts_supplied
FROM FinalReport fr
JOIN nation n ON fr.c_custkey = n.n_nationkey
JOIN region r ON n.n_regionkey = r.r_regionkey
GROUP BY r.r_name
ORDER BY active_customers DESC, avg_revenue DESC;