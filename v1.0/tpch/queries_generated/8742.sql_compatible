
WITH supplier_part_count AS (
    SELECT s.s_suppkey, COUNT(DISTINCT ps.ps_partkey) AS part_count
    FROM supplier s
    JOIN partsupp ps ON s.s_suppkey = ps.ps_suppkey
    GROUP BY s.s_suppkey
),
customer_order_details AS (
    SELECT c.c_custkey, SUM(o.o_totalprice) AS total_spent
    FROM customer c
    JOIN orders o ON c.c_custkey = o.o_custkey
    WHERE o.o_orderstatus = 'F'
    GROUP BY c.c_custkey
),
nation_supplier AS (
    SELECT n.n_nationkey, COUNT(DISTINCT s.s_suppkey) AS supplier_count
    FROM nation n
    JOIN supplier s ON n.n_nationkey = s.s_nationkey
    GROUP BY n.n_nationkey
),
aggregate_data AS (
    SELECT 
        n.r_name AS region_name,
        COUNT(DISTINCT c.c_custkey) AS customer_count,
        SUM(spc.part_count) AS total_parts_supplied,
        SUM(cod.total_spent) AS total_spent_by_customers,
        SUM(ns.supplier_count) AS total_suppliers_in_region
    FROM region n
    JOIN nation n2 ON n.r_regionkey = n2.n_regionkey
    LEFT JOIN supplier_part_count spc ON spc.s_suppkey IN (SELECT s.s_suppkey FROM supplier s WHERE s.s_nationkey = n2.n_nationkey)
    LEFT JOIN customer_order_details cod ON cod.c_custkey IN (SELECT c.c_custkey FROM customer c WHERE c.c_nationkey = n2.n_nationkey)
    LEFT JOIN nation_supplier ns ON n2.n_nationkey = ns.n_nationkey
    GROUP BY n.r_name
)
SELECT region_name, customer_count, total_parts_supplied, total_spent_by_customers, total_suppliers_in_region
FROM aggregate_data
ORDER BY total_spent_by_customers DESC, customer_count DESC;
