WITH RECURSIVE nation_hierarchy AS (
    SELECT n_nationkey, n_name, n_regionkey, 0 AS level
    FROM nation
    WHERE n_name LIKE 'A%'
    UNION ALL
    SELECT n.n_nationkey, n.n_name, n.n_regionkey, nh.level + 1
    FROM nation n
    INNER JOIN nation_hierarchy nh ON n.n_regionkey = nh.n_nationkey
),
supplier_summary AS (
    SELECT s_nationkey, COUNT(s_suppkey) AS total_suppliers, SUM(s_acctbal) AS total_account_balance
    FROM supplier
    GROUP BY s_nationkey
),
lineitem_summary AS (
    SELECT l_orderkey, SUM(l_extendedprice * (1 - l_discount)) AS total_revenue
    FROM lineitem
    WHERE l_shipdate >= '1996-01-01' AND l_shipdate < '1997-01-01'
    GROUP BY l_orderkey
),
customer_orders AS (
    SELECT c.c_custkey, c.c_name, o.o_orderkey, o.o_totalprice, o.o_orderdate
    FROM customer c
    JOIN orders o ON c.c_custkey = o.o_custkey
    WHERE o.o_orderdate >= DATEADD(month, -6, cast('1998-10-01' as date))
),
ranked_orders AS (
    SELECT co.*, RANK() OVER (PARTITION BY co.c_custkey ORDER BY co.o_totalprice DESC) AS order_rank
    FROM customer_orders co
)
SELECT 
    n.n_name,
    ss.total_suppliers,
    ss.total_account_balance,
    SUM(l.total_revenue) AS total_lineitem_revenue,
    AVG(ro.o_totalprice) AS avg_order_price
FROM 
    nation n
LEFT JOIN supplier_summary ss ON n.n_nationkey = ss.s_nationkey
LEFT JOIN lineitem_summary l ON l.l_orderkey IN (SELECT o.o_orderkey FROM ranked_orders ro WHERE ro.order_rank = 1)
LEFT JOIN ranked_orders ro ON n.n_nationkey = (SELECT s.n_nationkey FROM supplier s WHERE s.s_suppkey = ro.o_orderkey)
GROUP BY 
    n.n_name, ss.total_suppliers, ss.total_account_balance
HAVING 
    SUM(l.total_revenue) IS NOT NULL OR AVG(ro.o_totalprice) > 1000
ORDER BY 
    avg_order_price DESC;