
WITH StringAggregation AS (
    SELECT 
        p.p_brand,
        STRING_AGG(DISTINCT p.p_name, ', ') AS aggregated_product_names,
        COUNT(DISTINCT ps.ps_suppkey) AS supplier_count,
        AVG(ps.ps_supplycost) AS average_supply_cost
    FROM 
        part p
    JOIN 
        partsupp ps ON p.p_partkey = ps.ps_partkey
    GROUP BY 
        p.p_brand
),
CustomerOrderDetails AS (
    SELECT 
        c.c_name,
        o.o_orderkey,
        SUM(l.l_extendedprice * (1 - l.l_discount)) AS total_revenue,
        STRING_AGG(DISTINCT CONCAT('Order: ', CAST(o.o_orderkey AS TEXT), ' - Amount: ', CAST(SUM(l.l_extendedprice * (1 - l.l_discount)) AS TEXT)), '; ' 
            ORDER BY o.o_orderkey) AS order_details
    FROM 
        customer c
    JOIN 
        orders o ON c.c_custkey = o.o_custkey
    JOIN 
        lineitem l ON o.o_orderkey = l.l_orderkey
    WHERE 
        c.c_mktsegment = 'HOUSEHOLD'
    GROUP BY 
        c.c_name
)
SELECT 
    sa.p_brand,
    sa.aggregated_product_names,
    sa.supplier_count,
    sa.average_supply_cost,
    cod.c_name,
    cod.order_details
FROM 
    StringAggregation sa
LEFT JOIN 
    CustomerOrderDetails cod ON sa.p_brand LIKE '%' || cod.c_name || '%'
ORDER BY 
    sa.supplier_count DESC, sa.average_supply_cost DESC;
