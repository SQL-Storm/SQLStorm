WITH RegionalSupplier AS (
    SELECT
        n.n_name AS nation_name,
        r.r_name AS region_name,
        COUNT(DISTINCT s.s_suppkey) AS supplier_count,
        SUM(s.s_acctbal) AS total_acctbal
    FROM
        supplier s
    JOIN
        nation n ON s.s_nationkey = n.n_nationkey
    JOIN
        region r ON n.n_regionkey = r.r_regionkey
    GROUP BY
        n.n_name, r.r_name
),
EligibleCustomers AS (
    SELECT
        c.c_custkey,
        c.c_name,
        c.c_acctbal,
        ROW_NUMBER() OVER (PARTITION BY c.c_nationkey ORDER BY c.c_acctbal DESC) AS rn
    FROM
        customer c
    WHERE
        c.c_acctbal IS NOT NULL
),
HighValueOrders AS (
    SELECT
        o.o_orderkey,
        o.o_orderstatus,
        o.o_totalprice
    FROM
        orders o
    WHERE
        o.o_orderstatus IN ('F', 'P') AND
        o.o_totalprice > (SELECT AVG(o_totalprice) FROM orders)
),
RevenueAnalysis AS (
    SELECT
        l.l_orderkey,
        SUM(l.l_extendedprice * (1 - l.l_discount)) AS revenue,
        COUNT(DISTINCT l.l_partkey) AS unique_parts
    FROM
        lineitem l
    WHERE
        l.l_shipdate >= DATEADD(month, -3, cast('1998-10-01' as date)) 
    GROUP BY
        l.l_orderkey
),
FinalMetrics AS (
    SELECT
        r.region_name,
        rc.nation_name,
        rc.supplier_count,
        rc.total_acctbal,
        COUNT(DISTINCT o.o_orderkey) AS total_orders,
        SUM(ha.revenue) AS total_revenue,
        AVG(ha.unique_parts) AS avg_unique_parts_per_order
    FROM
        RegionalSupplier rc
    LEFT JOIN
        HighValueOrders o ON rc.nation_name IN (
            SELECT n_name FROM nation WHERE n_nationkey IN (
                SELECT DISTINCT c_nationkey FROM customer
                WHERE c_custkey IN (SELECT c_custkey FROM EligibleCustomers WHERE rn <= 5)
            )
        )
    LEFT JOIN
        RevenueAnalysis ha ON o.o_orderkey = ha.l_orderkey
    GROUP BY
        r.region_name, rc.nation_name, rc.supplier_count, rc.total_acctbal
)
SELECT
    fm.region_name,
    fm.nation_name,
    fm.supplier_count,
    fm.total_acctbal,
    COALESCE(fm.total_orders, 0) AS total_orders,
    COALESCE(fm.total_revenue, 0.00) AS total_revenue,
    COALESCE(fm.avg_unique_parts_per_order, 0) AS avg_unique_parts_per_order
FROM
    FinalMetrics fm
ORDER BY
    fm.region_name DESC, fm.nation_name ASC;