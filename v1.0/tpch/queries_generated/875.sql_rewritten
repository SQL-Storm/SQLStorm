WITH RankedCustomers AS (
    SELECT 
        c.c_custkey,
        c.c_name,
        c.c_acctbal,
        RANK() OVER (PARTITION BY c.c_nationkey ORDER BY c.c_acctbal DESC) AS rank
    FROM 
        customer c
),
SupplierCosts AS (
    SELECT 
        ps.ps_partkey,
        SUM(ps.ps_supplycost * ps.ps_availqty) AS total_supply_cost
    FROM 
        partsupp ps
    GROUP BY 
        ps.ps_partkey
),
MonthlyOrderStats AS (
    SELECT 
        EXTRACT(MONTH FROM o.o_orderdate) AS order_month,
        COUNT(o.o_orderkey) AS order_count,
        SUM(o.o_totalprice) AS total_revenue
    FROM 
        orders o
    WHERE 
        o.o_orderdate >= cast('1998-10-01' as date) - INTERVAL '1 year'
    GROUP BY 
        EXTRACT(MONTH FROM o.o_orderdate)
),
HighValueOrders AS (
    SELECT 
        o.o_orderkey,
        SUM(l.l_extendedprice * (1 - l.l_discount)) AS order_value
    FROM 
        orders o
    JOIN 
        lineitem l ON o.o_orderkey = l.l_orderkey
    GROUP BY 
        o.o_orderkey
    HAVING 
        SUM(l.l_extendedprice * (1 - l.l_discount)) > 1000
)
SELECT 
    r.r_name AS region_name,
    nc.n_name AS nation_name,
    c.c_name AS customer_name,
    c.c_acctbal AS customer_balance,
    sc.total_supply_cost AS supplier_cost,
    mo.order_month,
    mo.order_count,
    mo.total_revenue,
    hvo.order_value
FROM 
    region r
LEFT JOIN 
    nation nc ON r.r_regionkey = nc.n_regionkey
LEFT JOIN 
    customer c ON nc.n_nationkey = c.c_nationkey
LEFT JOIN 
    SupplierCosts sc ON EXISTS (
        SELECT 1
        FROM partsupp ps
        JOIN supplier s ON ps.ps_suppkey = s.s_suppkey
        WHERE ps.ps_partkey IN (
            SELECT ps_partkey 
            FROM partsupp 
            WHERE ps_availqty > 0
            GROUP BY ps_partkey
            HAVING SUM(ps_supplycost) > 100
        )
        AND s.s_nationkey = c.c_nationkey
    )
LEFT JOIN 
    MonthlyOrderStats mo ON mo.order_month = EXTRACT(MONTH FROM cast('1998-10-01' as date))
LEFT JOIN 
    HighValueOrders hvo ON c.c_custkey = hvo.o_orderkey
WHERE 
    c.c_acctbal IS NOT NULL
    AND hvo.order_value IS NOT NULL
ORDER BY 
    region_name, nation_name, customer_balance DESC;