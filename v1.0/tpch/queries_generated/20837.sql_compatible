
WITH RECURSIVE parts_with_price AS (
    SELECT 
        p.p_partkey, 
        p.p_name, 
        p.p_retailprice, 
        1 AS level 
    FROM 
        part p 
    WHERE 
        p.p_retailprice IS NOT NULL 
    
    UNION ALL 
    
    SELECT 
        p.p_partkey, 
        p.p_name, 
        p.p_retailprice + (SELECT AVG(ps_supplycost) FROM partsupp WHERE ps_partkey = p.p_partkey) AS adjusted_price,
        pw.level + 1 
    FROM 
        part p 
    JOIN 
        parts_with_price pw ON p.p_partkey = pw.p_partkey + 10 
    WHERE 
        pw.level < 5
), 

supplier_data AS (
    SELECT 
        s.s_suppkey, 
        s.s_name, 
        SUM(CASE WHEN l.l_discount IS NULL THEN 0 ELSE l.l_discount END) AS total_discount,
        SUM(l.l_extendedprice * (1 - COALESCE(l.l_discount, 0))) AS revenue 
    FROM 
        supplier s 
    LEFT JOIN 
        partsupp ps ON s.s_suppkey = ps.ps_suppkey 
    LEFT JOIN 
        lineitem l ON ps.ps_partkey = l.l_partkey 
    GROUP BY 
        s.s_suppkey, s.s_name 
), 

region_data AS (
    SELECT 
        r.r_regionkey, 
        r.r_name,
        COUNT(DISTINCT n.n_nationkey) AS nation_count,
        CASE 
            WHEN COUNT(n.n_nationkey) = 0 THEN 'Unknown' 
            ELSE r.r_name 
        END AS region_name_with_nation_count 
    FROM 
        region r 
    LEFT JOIN 
        nation n ON r.r_regionkey = n.n_regionkey 
    GROUP BY 
        r.r_regionkey, r.r_name 
) 

SELECT 
    r.r_name AS region_name, 
    s.s_name AS supplier_name, 
    pw.p_name AS part_name, 
    pw.p_retailprice AS original_price,
    pw.adjusted_price AS new_price,
    sd.total_discount, 
    rd.nation_count 
FROM 
    region_data rd 
JOIN 
    supplier_data sd ON rd.nation_count = (SELECT COUNT(*) FROM nation WHERE n_regionkey = rd.r_regionkey) 
LEFT JOIN 
    parts_with_price pw ON pw.p_partkey % 10 = sd.s_suppkey 
LEFT JOIN 
    supplier s ON sd.s_suppkey = s.s_suppkey 
WHERE 
    (sd.revenue > (SELECT AVG(revenue) FROM supplier_data) OR sd.total_discount IS NULL)
AND 
    pw.adjusted_price > 100 
ORDER BY 
    region_name, supplier_name 
LIMIT 10;
