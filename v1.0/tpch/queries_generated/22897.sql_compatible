
WITH RECURSIVE nation_hierarchy AS (
    SELECT 
        n_nationkey, 
        n_name, 
        n_regionkey,
        0 AS level 
    FROM 
        nation 
    WHERE 
        n_regionkey = (SELECT MIN(n_regionkey) FROM nation)

    UNION ALL 

    SELECT 
        n.n_nationkey, 
        n.n_name, 
        n.n_regionkey, 
        nh.level + 1 AS level 
    FROM 
        nation n 
    JOIN 
        nation_hierarchy nh ON n.n_regionkey = nh.n_nationkey
),
high_value_customers AS (
    SELECT 
        c.c_custkey, 
        c.c_name, 
        c.c_acctbal, 
        ROW_NUMBER() OVER (PARTITION BY c.c_nationkey ORDER BY c.c_acctbal DESC) AS rn
    FROM 
        customer c
    WHERE 
        c.c_acctbal IS NOT NULL AND c.c_acctbal > (
            SELECT AVG(c2.c_acctbal) FROM customer c2)
),
part_supply_cost AS (
    SELECT 
        ps.ps_partkey,
        SUM(ps.ps_supplycost) AS total_supply_cost
    FROM 
        partsupp ps
    GROUP BY 
        ps.ps_partkey
),
top_parts AS (
    SELECT 
        p.p_partkey,
        p.p_name,
        p.p_mfgr,
        p.p_retailprice,
        COALESCE(pc.total_supply_cost, 0) AS total_supply_cost
    FROM 
        part p
    LEFT JOIN part_supply_cost pc ON p.p_partkey = pc.ps_partkey
    WHERE 
        p.p_retailprice > (SELECT AVG(p2.p_retailprice) FROM part p2)
)
SELECT 
    t1.n_name AS nation_name,
    t2.c_name AS customer_name,
    t2.c_acctbal,
    tp.p_name AS part_name,
    tp.total_supply_cost,
    COALESCE(l_agg.total_order_count, 0) AS order_count,
    SUM(tp.total_supply_cost) OVER (PARTITION BY t1.n_name) AS nation_total_cost
FROM 
    high_value_customers t2
JOIN 
    nation_hierarchy t1 ON t2.c_nationkey = t1.n_nationkey
LEFT JOIN 
    lineitem l ON t2.c_custkey = l.l_orderkey
JOIN 
    top_parts tp ON l.l_partkey = tp.p_partkey
LEFT JOIN (
    SELECT 
        l_orderkey, 
        COUNT(*) AS total_order_count
    FROM 
        lineitem 
    GROUP BY 
        l_orderkey
) AS l_agg ON l.l_orderkey = l_agg.l_orderkey
WHERE 
    t2.rn = 1 AND 
    (tp.total_supply_cost IS NULL OR tp.total_supply_cost > 100.00)
ORDER BY 
    nation_name, 
    customer_name;
