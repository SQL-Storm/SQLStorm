WITH RECURSIVE CustomerSales AS (
    SELECT 
        c.c_custkey,
        c.c_name,
        SUM(l.l_extendedprice * (1 - l.l_discount)) AS total_sales,
        ROW_NUMBER() OVER (PARTITION BY c.c_nationkey ORDER BY SUM(l.l_extendedprice * (1 - l.l_discount)) DESC) AS rank
    FROM customer c
    JOIN orders o ON c.c_custkey = o.o_custkey
    JOIN lineitem l ON o.o_orderkey = l.l_orderkey
    WHERE o.o_orderdate >= DATE '1996-01-01' AND o.o_orderdate < DATE '1997-01-01'
    GROUP BY c.c_custkey, c.c_name
),
TopCustomers AS (
    SELECT 
        c_nationkey,
        COUNT(*) AS customer_count,
        SUM(total_sales) AS total_sales_per_nation
    FROM CustomerSales 
    WHERE rank <= 5
    GROUP BY c_nationkey
)
SELECT 
    r.r_name AS region,
    COALESCE(tc.customer_count, 0) AS top_customer_count,
    COALESCE(tc.total_sales_per_nation, 0) AS total_sales
FROM region r
LEFT JOIN nation n ON r.r_regionkey = n.n_regionkey
LEFT JOIN TopCustomers tc ON n.n_nationkey = tc.c_nationkey
ORDER BY r.r_name;