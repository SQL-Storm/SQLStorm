WITH RankedSuppliers AS (
    SELECT s.s_suppkey, s.s_name, s.s_acctbal,
           ROW_NUMBER() OVER (PARTITION BY s.s_nationkey ORDER BY s.s_acctbal DESC) AS rn
    FROM supplier s
), FilteredParts AS (
    SELECT p.p_partkey, p.p_name, p.p_retailprice, 
           CASE 
               WHEN p.p_retailprice > (SELECT AVG(p2.p_retailprice) FROM part p2) THEN 'Above Average'
               ELSE 'Below Average'
           END AS price_category
    FROM part p
    WHERE p.p_size IN (SELECT DISTINCT ps.ps_partkey FROM partsupp ps WHERE ps.ps_availqty > 10)
), AggLineItems AS (
    SELECT l.l_orderkey, SUM(l.l_extendedprice * (1 - l.l_discount)) AS total_revenue
    FROM lineitem l
    WHERE l.l_shipmode = 'AIR' AND l.l_returnflag = 'N'
    GROUP BY l.l_orderkey
)
SELECT r.r_name, fp.price_category, SUM(ali.total_revenue) AS aggregated_revenue
FROM region r
LEFT JOIN nation n ON r.r_regionkey = n.n_regionkey
JOIN FilteredParts fp ON fp.p_partkey IN (
    SELECT ps.ps_partkey 
    FROM partsupp ps 
    JOIN supplier s ON ps.ps_suppkey = s.s_suppkey 
    WHERE s.s_acctbal > 5000 
      AND s.n_nationkey = n.n_nationkey
)
LEFT JOIN AggLineItems ali ON ali.l_orderkey IN (
    SELECT o.o_orderkey
    FROM orders o
    WHERE o.o_orderdate BETWEEN '1995-01-01' AND '1995-12-31' 
      AND o.o_orderstatus IN ('F', 'P')
)
WHERE n.n_name IS NOT NULL
GROUP BY r.r_name, fp.price_category
HAVING SUM(ali.total_revenue) > (SELECT AVG(total_revenue) FROM AggLineItems)
ORDER BY r.r_name, fp.price_category DESC
OFFSET 5 ROWS FETCH NEXT 10 ROWS ONLY;