WITH RECURSIVE OrderCTE AS (
    SELECT o_orderkey, o_custkey, o_orderdate, o_totalprice, 
           ROW_NUMBER() OVER (PARTITION BY o_custkey ORDER BY o_orderdate) as OrderRank
    FROM orders
    WHERE o_orderdate >= '1997-01-01'
),
SupplierCosts AS (
    SELECT ps.partkey, SUM(ps.ps_supplycost * ps.ps_availqty) AS TotalCost
    FROM partsupp ps
    JOIN part p ON ps.ps_partkey = p.p_partkey
    GROUP BY ps.ps_partkey
),
CustomerRegions AS (
    SELECT c.c_custkey, n.n_regionkey, r.r_name 
    FROM customer c
    JOIN nation n ON c.c_nationkey = n.n_nationkey
    JOIN region r ON n.n_regionkey = r.r_regionkey
)
SELECT cr.r_name,
       COUNT(DISTINCT oc.o_orderkey) AS TotalOrders,
       SUM(l.l_extendedprice * (1 - l.l_discount)) AS TotalRevenue,
       AVG(l.l_discount) AS AverageDiscount,
       MAX(sc.TotalCost) AS MaxSupplierCost
FROM CustomerRegions cr
LEFT JOIN OrderCTE oc ON cr.c_custkey = oc.o_custkey
LEFT JOIN lineitem l ON oc.o_orderkey = l.l_orderkey
LEFT JOIN SupplierCosts sc ON l.l_partkey = sc.partkey
WHERE cr.r_name IS NOT NULL
  AND l.l_shipdate >= '1997-01-01'
  AND l.l_returnflag = 'N'
GROUP BY cr.r_name
HAVING COUNT(DISTINCT oc.o_orderkey) > 5
ORDER BY TotalRevenue DESC;