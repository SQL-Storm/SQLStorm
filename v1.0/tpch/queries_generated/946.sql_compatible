
WITH top_customers AS (
    SELECT c.c_custkey, c.c_name, SUM(o.o_totalprice) AS total_spent
    FROM customer c
    JOIN orders o ON c.c_custkey = o.o_custkey
    GROUP BY c.c_custkey, c.c_name
    HAVING SUM(o.o_totalprice) > (
        SELECT AVG(total) 
        FROM (
            SELECT SUM(o_totalprice) AS total
            FROM orders 
            GROUP BY o_custkey
        ) AS cust_totals
    )
),
part_supplier_info AS (
    SELECT p.p_partkey, p.p_name, p.p_retailprice, s.s_suppkey, s.s_name, ps.ps_supplycost,
           ROW_NUMBER() OVER (PARTITION BY p.p_partkey ORDER BY ps.ps_supplycost ASC) AS rn
    FROM part p
    JOIN partsupp ps ON p.p_partkey = ps.ps_partkey
    JOIN supplier s ON ps.ps_suppkey = s.s_suppkey
),
discounted_lineitems AS (
    SELECT l.l_orderkey, l.l_partkey, l.l_quantity, l.l_extendedprice * (1 - l.l_discount) AS discounted_price
    FROM lineitem l
    WHERE l.l_discount > 0
),
order_summary AS (
    SELECT o.o_orderkey, SUM(d.discounted_price) AS total_discounted
    FROM orders o
    JOIN discounted_lineitems d ON o.o_orderkey = d.l_orderkey
    GROUP BY o.o_orderkey
)

SELECT DISTINCT r.r_name AS region, 
                nc.n_name AS nation, 
                c.total_spent, 
                COUNT(DISTINCT o.o_orderkey) AS order_count,
                SUM(COALESCE(p.p_retailprice, 0)) AS total_value,
                STRING_AGG(CONCAT(s.s_name, ': ', ps.ps_supplycost), '; ') AS suppliers_info
FROM nation nc
JOIN region r ON nc.n_regionkey = r.r_regionkey
LEFT JOIN top_customers c ON nc.n_nationkey = c.c_nationkey
LEFT JOIN orders o ON c.c_custkey = o.o_custkey
LEFT JOIN part_supplier_info p ON p.p_partkey IN (SELECT l.l_partkey FROM lineitem l WHERE l.l_orderkey = o.o_orderkey)
LEFT JOIN partsupp ps ON p.ps_suppkey = ps.ps_suppkey AND p.p_partkey = ps.ps_partkey
LEFT JOIN supplier s ON ps.ps_suppkey = s.s_suppkey
GROUP BY r.r_name, nc.n_name, c.total_spent
HAVING COUNT(DISTINCT o.o_orderkey) > 0 AND SUM(COALESCE(p.p_retailprice, 0)) > 1000
ORDER BY c.total_spent DESC, order_count DESC;
