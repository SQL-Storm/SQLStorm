
WITH RankedParts AS (
    SELECT 
        p.p_partkey,
        p.p_name,
        p.p_brand,
        DENSE_RANK() OVER (PARTITION BY p.p_brand ORDER BY p.p_retailprice DESC) AS price_rank,
        (SELECT COUNT(DISTINCT ps.s_suppkey) FROM partsupp ps WHERE ps.ps_partkey = p.p_partkey) AS supplier_count
    FROM part p
    WHERE p.p_size BETWEEN 1 AND 25 OR (p.p_container IN ('MED BOX', 'SMALL BOX') AND p.p_retailprice > 50)
),
FilteredSuppliers AS (
    SELECT 
        s.s_suppkey, 
        s.s_name, 
        s.s_acctbal, 
        n.n_name
    FROM supplier s
    JOIN nation n ON s.s_nationkey = n.n_nationkey
    WHERE n.n_name IS NOT NULL
    AND s.s_acctbal > (
        SELECT AVG(s2.s_acctbal) 
        FROM supplier s2 
        WHERE s2.s_name NOT LIKE 'SUPPLIER%'
    )
),
OrderSummary AS (
    SELECT 
        o.o_orderkey,
        SUM(l.l_extendedprice * (1 - l.l_discount)) AS total_sales,
        COUNT(l.l_orderkey) AS total_lines
    FROM orders o
    JOIN lineitem l ON o.o_orderkey = l.l_orderkey
    WHERE l.l_shipdate > DATE '1998-10-01' - INTERVAL '1 year'
    GROUP BY o.o_orderkey
),
FinalReport AS (
    SELECT 
        fp.p_partkey,
        fp.p_name,
        fs.s_name AS supplier_name,
        os.total_sales,
        fp.supplier_count,
        ROW_NUMBER() OVER (PARTITION BY fp.price_rank ORDER BY os.total_sales DESC) AS sales_rank
    FROM RankedParts fp
    LEFT JOIN FilteredSuppliers fs ON fp.supplier_count > 5
    LEFT JOIN OrderSummary os ON os.o_orderkey IN (
        SELECT o.o_orderkey 
        FROM orders o 
        WHERE o.o_orderstatus = 'F'
    )
)
SELECT * 
FROM FinalReport 
WHERE sales_rank <= 10 
OR supplier_name IS NULL
ORDER BY total_sales DESC NULLS LAST;
