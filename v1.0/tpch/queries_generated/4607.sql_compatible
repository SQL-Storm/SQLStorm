
WITH ranked_orders AS (
    SELECT 
        o.o_orderkey,
        o.o_orderdate,
        o.o_totalprice,
        CTE_ranked.cust_rank,
        ROW_NUMBER() OVER (PARTITION BY o.o_orderkey ORDER BY o.o_totalprice DESC) AS order_rank
    FROM 
        orders o
    JOIN (
        SELECT 
            c.c_custkey,
            RANK() OVER (PARTITION BY c.c_mktsegment ORDER BY SUM(o.o_totalprice) DESC) AS cust_rank
        FROM 
            customer c
        LEFT JOIN 
            orders o ON c.c_custkey = o.o_custkey
        GROUP BY 
            c.c_custkey
    ) CTE_ranked ON o.o_custkey = CTE_ranked.c_custkey
),
supplier_stats AS (
    SELECT 
        s.s_suppkey,
        SUM(ps.ps_supplycost * ps.ps_availqty) AS total_supply_cost,
        COUNT(DISTINCT ps.ps_partkey) AS total_parts
    FROM 
        supplier s
    JOIN 
        partsupp ps ON s.s_suppkey = ps.ps_suppkey
    GROUP BY 
        s.s_suppkey
),
nations_info AS (
    SELECT 
        n.n_nationkey,
        n.n_name,
        r.r_name AS region_name,
        COUNT(s.s_suppkey) AS total_suppliers
    FROM 
        nation n
    LEFT JOIN 
        region r ON n.n_regionkey = r.r_regionkey
    LEFT JOIN 
        supplier s ON n.n_nationkey = s.s_nationkey
    GROUP BY 
        n.n_nationkey, n.n_name, r.r_name
),
combined_info AS (
    SELECT 
        n.n_name,
        ns.region_name,
        COALESCE(SUM(ss.total_supply_cost), 0) AS total_cost,
        RANK() OVER (ORDER BY COALESCE(SUM(ss.total_supply_cost), 0) DESC) AS cost_rank
    FROM 
        nations_info ns
    LEFT JOIN 
        supplier_stats ss ON ns.total_suppliers > 0
    JOIN 
        nation n ON ns.n_nationkey = n.n_nationkey
    GROUP BY 
        n.n_name, ns.region_name
)
SELECT 
    r.o_orderkey,
    r.o_orderdate,
    r.o_totalprice,
    r.cust_rank,
    ci.n_name,
    ci.region_name,
    ci.total_cost,
    ci.cost_rank
FROM 
    ranked_orders r
LEFT JOIN 
    combined_info ci ON ci.n_name = (
        SELECT n.n_name 
        FROM nation n 
        JOIN supplier s ON n.n_nationkey = s.s_nationkey 
        WHERE s.s_suppkey = r.o_custkey
    )
WHERE 
    r.o_totalprice > (SELECT AVG(o_totalprice) FROM orders)
ORDER BY 
    r.o_orderdate DESC, r.o_orderkey;
