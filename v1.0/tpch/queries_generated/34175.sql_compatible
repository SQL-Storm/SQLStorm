
WITH RECURSIVE TotalSalesPerSupplier AS (
    SELECT s.s_suppkey,
           s.s_name,
           SUM(l.l_extendedprice * (1 - l.l_discount)) AS total_sales
    FROM supplier s
    JOIN partsupp ps ON s.s_suppkey = ps.ps_suppkey
    JOIN lineitem l ON ps.ps_partkey = l.l_partkey
    WHERE l.l_shipdate >= DATE '1997-01-01'
    GROUP BY s.s_suppkey, s.s_name

    UNION ALL

    SELECT s.s_suppkey,
           s.s_name,
           ts.total_sales + SUM(l.l_extendedprice * (1 - l.l_discount))
    FROM TotalSalesPerSupplier ts
    JOIN partsupp ps ON ts.s_suppkey = ps.ps_suppkey
    JOIN lineitem l ON ps.ps_partkey = l.l_partkey
    WHERE l.l_shipdate < DATE '1997-01-01'
    GROUP BY s.s_suppkey, s.s_name, ts.total_sales
),
RankedSuppliers AS (
    SELECT s.s_suppkey,
           s.s_name,
           ts.total_sales,
           RANK() OVER (ORDER BY ts.total_sales DESC) AS sales_rank
    FROM supplier s
    JOIN TotalSalesPerSupplier ts ON s.s_suppkey = ts.s_suppkey
)
SELECT r.s_suppkey,
       r.s_name,
       r.total_sales,
       COALESCE(NULLIF(r.sales_rank, 1), 0) AS rank_non_top
FROM RankedSuppliers r
WHERE r.sales_rank <= 10
  AND r.total_sales > (
      SELECT AVG(total_sales)
      FROM RankedSuppliers
  )
  OR r.s_name LIKE '%Inc%'
ORDER BY r.total_sales DESC;
