
WITH RankedOrders AS (
    SELECT o.o_orderkey, o.o_orderdate, o.o_totalprice, 
           RANK() OVER (PARTITION BY c.c_mktsegment ORDER BY o.o_totalprice DESC) AS order_rank
    FROM orders o
    JOIN customer c ON o.o_custkey = c.c_custkey
    WHERE o.o_orderdate >= '1997-01-01' AND o.o_orderdate < '1998-01-01'
),
PartSupplierDetails AS (
    SELECT ps.ps_partkey, ps.ps_suppkey, 
           SUM(ps.ps_availqty) AS total_available_qty,
           SUM(ps.ps_supplycost) AS total_supply_cost,
           COUNT(DISTINCT o.o_orderkey) AS order_count
    FROM partsupp ps
    JOIN lineitem l ON ps.ps_partkey = l.l_partkey
    JOIN RankedOrders ro ON l.l_orderkey = ro.o_orderkey
    GROUP BY ps.ps_partkey, ps.ps_suppkey
),
TopSuppliers AS (
    SELECT s.s_suppkey, s.s_name, s.s_acctbal, 
           SUM(psd.total_available_qty * psd.total_supply_cost) AS supplier_value
    FROM supplier s
    JOIN PartSupplierDetails psd ON s.s_suppkey = psd.ps_suppkey
    GROUP BY s.s_suppkey, s.s_name, s.s_acctbal
)
SELECT ts.s_name, ts.s_acctbal, ts.supplier_value, 
       RANK() OVER (ORDER BY ts.supplier_value DESC) AS supplier_rank
FROM TopSuppliers ts
WHERE ts.s_acctbal > 10000
ORDER BY supplier_rank
FETCH FIRST 10 ROWS ONLY;
