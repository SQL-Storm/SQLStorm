
WITH RECURSIVE region_hierarchy AS (
    SELECT r_regionkey, r_name, r_comment
    FROM region
    WHERE r_regionkey = 1
    UNION ALL
    SELECT r.r_regionkey, r.r_name, r.r_comment
    FROM region r
    JOIN region_hierarchy rh ON r.r_regionkey = rh.r_regionkey + 1
),
customer_summary AS (
    SELECT c.c_custkey, c.c_name, c.c_acctbal,
           ROW_NUMBER() OVER (PARTITION BY c.c_nationkey ORDER BY c.c_acctbal DESC) AS rank
    FROM customer c
    WHERE c.c_acctbal IS NOT NULL
),
supplier_stats AS (
    SELECT s.s_nationkey, COUNT(s.s_suppkey) AS total_suppliers,
           SUM(ps.ps_supplycost) AS total_supply_cost
    FROM supplier s
    JOIN partsupp ps ON s.s_suppkey = ps.ps_suppkey
    GROUP BY s.s_nationkey
)
SELECT rh.r_name, 
       COUNT(DISTINCT c.c_custkey) AS total_customers,
       SUM(l.l_extendedprice * (1 - l.l_discount)) AS total_revenue,
       COALESCE(ss.total_suppliers, 0) AS total_suppliers,
       COALESCE(ss.total_supply_cost, 0) AS total_supply_cost
FROM region_hierarchy rh
LEFT JOIN nation n ON rh.r_regionkey = n.n_regionkey
LEFT JOIN customer_summary c ON n.n_nationkey = c.c_nationkey
LEFT JOIN orders o ON c.c_custkey = o.o_custkey
LEFT JOIN lineitem l ON o.o_orderkey = l.l_orderkey
LEFT JOIN supplier_stats ss ON n.n_nationkey = ss.s_nationkey
WHERE l.l_shipdate BETWEEN DATE '1997-01-01' AND DATE '1997-12-31'
AND (o.o_orderstatus = 'O' OR o.o_orderstatus IS NULL)
GROUP BY rh.r_name
HAVING SUM(l.l_extendedprice * (1 - l.l_discount)) > 10000
ORDER BY total_revenue DESC
LIMIT 10;
