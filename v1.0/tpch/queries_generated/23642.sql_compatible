
WITH RECURSIVE supplier_hierarchy AS (
    SELECT s.s_suppkey, s.s_name, s.s_acctbal, 0 AS level
    FROM supplier s
    WHERE s.s_acctbal IS NOT NULL
    
    UNION ALL
    
    SELECT s.s_suppkey, s.s_name, s.s_acctbal, sh.level + 1
    FROM supplier_hierarchy sh
    JOIN partsupp ps ON ps.ps_suppkey = sh.s_suppkey
    JOIN supplier s ON s.s_suppkey = ps.ps_suppkey
    WHERE sh.level < 3
),
aggregated_sales AS (
    SELECT l.l_orderkey, SUM(l.l_extendedprice * (1 - l.l_discount)) AS total_sales
    FROM lineitem l
    GROUP BY l.l_orderkey
),
top_customers AS (
    SELECT c.c_custkey, c.c_name, SUM(o.o_totalprice) AS total_spent
    FROM customer c
    JOIN orders o ON c.c_custkey = o.o_custkey
    WHERE o.o_orderstatus IN ('F', 'P')
    GROUP BY c.c_custkey, c.c_name
    HAVING SUM(o.o_totalprice) > 10000
),
country_supply AS (
    SELECT n.n_name, SUM(ps.ps_supplycost * ps.ps_availqty) AS total_cost
    FROM nation n
    JOIN supplier s ON n.n_nationkey = s.s_nationkey
    JOIN partsupp ps ON ps.ps_suppkey = s.s_suppkey
    GROUP BY n.n_name
)
SELECT r.r_name,
       COALESCE(NULLIF(sh.level, 0), 'N/A') AS supplier_level,
       total_sales.total_sales,
       tc.total_spent,
       cs.total_cost
FROM region r
LEFT JOIN supplier_hierarchy sh ON sh.s_suppkey = r.r_regionkey
LEFT JOIN aggregated_sales total_sales ON total_sales.l_orderkey = (SELECT MAX(o.o_orderkey) FROM orders o)
LEFT JOIN top_customers tc ON tc.c_custkey = (SELECT MIN(c.custkey) FROM customer c)
LEFT JOIN country_supply cs ON cs.n_name = (SELECT r2.r_name FROM region r2 WHERE r2.r_regionkey = r.r_regionkey LIMIT 1)
WHERE r.r_name LIKE 'N%'
GROUP BY r.r_name, sh.level, total_sales.total_sales, tc.total_spent, cs.total_cost
ORDER BY r.r_name, total_sales.total_sales DESC
LIMIT 10

UNION ALL

SELECT 'Grand Total' AS r_name,
       CAST(NULL AS VARCHAR) AS supplier_level,
       SUM(total_sales.total_sales) AS total_sales,
       SUM(tc.total_spent) AS total_spent,
       SUM(cs.total_cost) AS total_cost
FROM aggregated_sales total_sales
FULL OUTER JOIN top_customers tc ON true
FULL OUTER JOIN country_supply cs ON true;
