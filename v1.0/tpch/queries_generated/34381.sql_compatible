
WITH RECURSIVE SupplierHierarchy AS (
    SELECT s_suppkey, s_name, s_acctbal, s_nationkey, 1 AS level
    FROM supplier
    WHERE s_acctbal > 1000
    UNION ALL
    SELECT s.s_suppkey, s.s_name, s.s_acctbal, s.s_nationkey, sh.level + 1
    FROM supplier s
    JOIN SupplierHierarchy sh ON s.s_nationkey = sh.s_nationkey
    WHERE s.s_acctbal > sh.s_acctbal
),
PartSuppliers AS (
    SELECT ps.ps_partkey, COUNT(DISTINCT ps.ps_suppkey) AS supplier_count, AVG(ps.ps_supplycost) AS avg_supply_cost
    FROM partsupp ps
    GROUP BY ps.ps_partkey
),
CustomerOrders AS (
    SELECT c.c_custkey, c.c_name, SUM(o.o_totalprice) AS total_spent
    FROM customer c
    JOIN orders o ON c.c_custkey = o.o_custkey
    WHERE o.o_orderdate >= '1997-01-01'
    GROUP BY c.c_custkey, c.c_name
),
TopNations AS (
    SELECT n.n_nationkey, n.n_name, SUM(c.c_acctbal) AS total_acctbal
    FROM nation n
    JOIN customer c ON n.n_nationkey = c.c_nationkey
    GROUP BY n.n_nationkey, n.n_name
    ORDER BY total_acctbal DESC
    LIMIT 5
)
SELECT 
    p.p_name,
    ph.supplier_count,
    ph.avg_supply_cost,
    co.c_name,
    co.total_spent,
    tn.n_name,
    tn.total_acctbal
FROM part p
LEFT JOIN PartSuppliers ph ON p.p_partkey = ph.ps_partkey
LEFT JOIN CustomerOrders co ON co.total_spent >= p.p_retailprice
JOIN TopNations tn ON tn.n_nationkey = (
    SELECT DISTINCT n.n_nationkey 
    FROM nation n 
    JOIN supplier s ON n.n_nationkey = s.s_nationkey
    WHERE s.s_suppkey IN (SELECT sh.s_suppkey FROM SupplierHierarchy sh WHERE sh.level <= 3) 
    LIMIT 1
)
ORDER BY p.p_partkey DESC
FETCH FIRST 100 ROWS ONLY;
