
WITH SupplierCost AS (
    SELECT 
        ps.s_suppkey,
        SUM(ps.ps_supplycost * ps.ps_availqty) AS total_supply_cost
    FROM 
        partsupp ps
    JOIN 
        supplier s ON ps.ps_suppkey = s.s_suppkey
    GROUP BY 
        ps.s_suppkey
),
OrderStats AS (
    SELECT 
        o.o_custkey,
        COUNT(o.o_orderkey) AS order_count,
        SUM(o.o_totalprice) AS total_spent,
        AVG(o.o_totalprice) AS avg_order_value
    FROM 
        orders o
    GROUP BY 
        o.o_custkey
),
RegionData AS (
    SELECT 
        r.r_regionkey,
        r.r_name,
        COUNT(DISTINCT n.n_nationkey) AS nation_count,
        SUM(s.s_acctbal) AS total_supplier_balance
    FROM 
        region r
    LEFT JOIN 
        nation n ON r.r_regionkey = n.n_regionkey
    LEFT JOIN 
        supplier s ON n.n_nationkey = s.s_nationkey
    GROUP BY 
        r.r_regionkey, r.r_name
)
SELECT 
    rd.r_name AS region_name,
    rd.nation_count,
    rd.total_supplier_balance,
    osc.order_count,
    osc.total_spent,
    osc.avg_order_value,
    sc.total_supply_cost
FROM 
    RegionData rd
LEFT JOIN 
    OrderStats osc ON rd.nation_count > 0 
LEFT JOIN 
    SupplierCost sc ON sc.s_suppkey = (SELECT ps.ps_suppkey 
                                        FROM partsupp ps 
                                        ORDER BY ps.ps_supplycost DESC 
                                        LIMIT 1)
WHERE 
    rd.total_supplier_balance IS NOT NULL
ORDER BY 
    rd.total_supplier_balance DESC,
    osc.total_spent DESC
LIMIT 10;
