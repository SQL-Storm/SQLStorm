
WITH ranked_parts AS (
    SELECT 
        p.p_partkey,
        p.p_name,
        p.p_retailprice,
        ROW_NUMBER() OVER (PARTITION BY p.p_type ORDER BY p.p_retailprice DESC) AS part_rank
    FROM 
        part p
), 
supplier_part AS (
    SELECT 
        ps.ps_partkey,
        SUM(ps.ps_availqty) AS total_availqty,
        AVG(ps.ps_supplycost) AS avg_supplycost
    FROM 
        partsupp ps
    GROUP BY 
        ps.ps_partkey
), 
customer_orders AS (
    SELECT 
        c.c_custkey,
        COUNT(o.o_orderkey) AS order_count,
        SUM(o.o_totalprice) AS total_spent
    FROM 
        customer c
    LEFT JOIN 
        orders o ON c.c_custkey = o.o_custkey
    GROUP BY 
        c.c_custkey
), 
high_spenders AS (
    SELECT
        co.c_custkey,
        co.total_spent,
        CASE 
            WHEN co.total_spent > 1000 THEN 'VIP'
            ELSE 'Regular'
        END AS spender_type
    FROM 
        customer_orders co
    WHERE 
        co.order_count > 5
)
SELECT 
    DISTINCT rp.p_name,
    sp.total_availqty,
    sp.avg_supplycost,
    hsp.total_spent,
    hsp.spender_type
FROM 
    ranked_parts rp
LEFT JOIN 
    supplier_part sp ON sp.ps_partkey = rp.p_partkey
FULL OUTER JOIN 
    high_spenders hsp ON hsp.c_custkey IN (SELECT n.c_nationkey FROM nation n WHERE n.n_name LIKE '%land%')
WHERE 
    rp.part_rank <= 10 
    AND (sp.total_availqty IS NOT NULL OR hsp.total_spent IS NULL)
ORDER BY 
    rp.p_retailprice DESC, 
    sp.avg_supplycost ASC NULLS LAST;  
