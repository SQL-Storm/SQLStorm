WITH RankedOrders AS (
    SELECT 
        o.o_orderkey,
        o.o_orderstatus,
        o.o_totalprice,
        o.o_orderdate,
        ROW_NUMBER() OVER (PARTITION BY o.o_orderstatus ORDER BY o.o_totalprice DESC) AS order_rank
    FROM 
        orders o
    WHERE 
        o.o_orderdate >= DATE '1996-01-01'
),
SupplierCost AS (
    SELECT 
        ps.ps_partkey,
        SUM(ps.ps_supplycost) AS total_supplycost
    FROM 
        partsupp ps
    GROUP BY 
        ps.ps_partkey
),
CustomerNation AS (
    SELECT 
        c.c_custkey,
        n.n_name AS nation_name,
        c.c_acctbal
    FROM 
        customer c
    JOIN 
        nation n ON c.c_nationkey = n.n_nationkey
    WHERE 
        c.c_acctbal > (
            SELECT AVG(c1.c_acctbal) 
            FROM customer c1 
            WHERE c1.c_mktsegment = 'BUILDING'
        )
)
SELECT 
    p.p_name,
    p.p_brand,
    r.r_name,
    cn.nation_name,
    COALESCE(sc.total_supplycost, 0) AS total_supplycost,
    SUM(wo.o_totalprice) AS total_order_value
FROM 
    part p
LEFT JOIN 
    SupplierCost sc ON p.p_partkey = sc.ps_partkey
LEFT JOIN 
    lineitem l ON p.p_partkey = l.l_partkey
LEFT JOIN 
    RankedOrders wo ON l.l_orderkey = wo.o_orderkey
JOIN 
    region r ON r.r_regionkey = (
        SELECT n.n_regionkey 
        FROM nation n 
        WHERE n.n_nationkey = p.p_partkey % (SELECT COUNT(*) FROM nation)
    )
JOIN 
    CustomerNation cn ON cn.c_custkey = (l.l_orderkey % (SELECT COUNT(*) FROM customer))
WHERE 
    p.p_size > 10 AND 
    (p.p_comment LIKE '%special%' OR p.p_retailprice < 100.00)
GROUP BY 
    p.p_name, 
    p.p_brand, 
    r.r_name, 
    cn.nation_name, 
    sc.total_supplycost
ORDER BY 
    total_order_value DESC;