
WITH RegionalSales AS (
    SELECT n.n_nationkey, r.r_name, SUM(l.l_extendedprice * (1 - l.l_discount)) AS total_sales
    FROM lineitem l
    JOIN orders o ON l.l_orderkey = o.o_orderkey
    JOIN customer c ON o.o_custkey = c.c_custkey
    JOIN supplier s ON l.l_suppkey = s.s_suppkey
    JOIN nation n ON s.s_nationkey = n.n_nationkey
    JOIN region r ON n.n_regionkey = r.r_regionkey
    WHERE l.l_shipdate >= DATE '1996-01-01' AND l.l_shipdate < DATE '1997-01-01'
    GROUP BY n.n_nationkey, r.r_name
),
SupplierRanking AS (
    SELECT s.s_suppkey, s.s_name, RANK() OVER (PARTITION BY n.n_regionkey ORDER BY SUM(l.l_extendedprice * (1 - l.l_discount)) DESC) AS rank_within_region
    FROM lineitem l
    JOIN supplier s ON l.l_suppkey = s.s_suppkey
    JOIN nation n ON s.s_nationkey = n.n_nationkey
    GROUP BY s.s_suppkey, s.s_name, n.n_regionkey
),
UnusualTransactions AS (
    SELECT DISTINCT o.o_orderkey, o.o_orderstatus, o.o_orderpriority
    FROM orders o
    LEFT JOIN lineitem l ON o.o_orderkey = l.l_orderkey
    WHERE o.o_orderstatus = 'O' AND (l.l_returnflag IS NULL OR l.l_returnflag NOT LIKE 'R%')
    AND o.o_orderdate BETWEEN DATE '1996-01-01' AND DATE '1996-12-31'
)
SELECT r.r_name, COUNT(DISTINCT s.s_suppkey) AS supplier_count, SUM(rs.total_sales) AS total_sales, 
       (SELECT COUNT(*) FROM UnusualTransactions) AS unusual_order_count
FROM RegionalSales rs
JOIN SupplierRanking sr ON rs.n_nationkey = sr.s_suppkey
JOIN region r ON r.r_regionkey = sr.n_nationkey
LEFT JOIN supplier s ON s.s_nationkey = r.r_regionkey
WHERE sr.rank_within_region <= 5
GROUP BY r.r_name
HAVING SUM(rs.total_sales) IS NOT NULL
ORDER BY total_sales DESC;
