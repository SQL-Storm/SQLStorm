WITH NationStats AS (
    SELECT n.n_name AS nation_name,
           SUM(s.s_acctbal) AS total_balance,
           COUNT(DISTINCT c.c_custkey) AS customer_count
    FROM nation n
    JOIN supplier s ON n.n_nationkey = s.s_nationkey
    JOIN customer c ON n.n_nationkey = c.c_nationkey
    GROUP BY n.n_name
),
PartStats AS (
    SELECT p.p_partkey,
           p.p_name,
           SUM(ps.ps_availqty) AS total_available_qty,
           AVG(ps.ps_supplycost) AS avg_supply_cost
    FROM part p
    JOIN partsupp ps ON p.p_partkey = ps.ps_partkey
    GROUP BY p.p_partkey, p.p_name
),
OrderStats AS (
    SELECT o.o_orderkey,
           COUNT(l.l_linenumber) AS lineitem_count,
           SUM(l.l_extendedprice) AS total_extended_price
    FROM orders o
    JOIN lineitem l ON o.o_orderkey = l.l_orderkey
    WHERE o.o_orderdate >= DATE '1997-01-01' AND o.o_orderdate < DATE '1998-01-01'
    GROUP BY o.o_orderkey
)
SELECT ns.nation_name,
       ns.total_balance,
       ns.customer_count,
       ps.p_partkey,
       ps.p_name,
       ps.total_available_qty,
       ps.avg_supply_cost,
       os.o_orderkey,
       os.lineitem_count,
       os.total_extended_price
FROM NationStats ns
JOIN PartStats ps ON ps.total_available_qty > 1000
JOIN OrderStats os ON os.lineitem_count > 5
ORDER BY ns.total_balance DESC, os.total_extended_price DESC
LIMIT 10;