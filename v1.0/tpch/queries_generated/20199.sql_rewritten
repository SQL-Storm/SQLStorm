WITH RankedOrders AS (
    SELECT 
        o.o_orderkey,
        o.o_orderstatus,
        o.o_totalprice,
        o.o_orderdate,
        ROW_NUMBER() OVER (PARTITION BY o.o_orderstatus ORDER BY o.o_totalprice DESC) AS StatusRank
    FROM orders o
    WHERE o.o_orderdate >= '1995-01-01' AND o.o_orderdate < cast('1998-10-01' as date)
),
SupplierAvailability AS (
    SELECT 
        ps.ps_partkey,
        SUM(ps.ps_availqty) AS total_avail_qty,
        AVG(ps.ps_supplycost) AS avg_supply_cost
    FROM partsupp ps
    GROUP BY ps.ps_partkey
),
HighValueCustomers AS (
    SELECT 
        c.c_custkey,
        c.c_name,
        c.c_acctbal
    FROM customer c
    WHERE c.c_acctbal > (SELECT AVG(c2.c_acctbal) FROM customer c2)
),
OrderLineDetails AS (
    SELECT 
        l.l_orderkey,
        l.l_discount,
        l.l_extendedprice,
        l.l_tax,
        l.l_quantity,
        CASE 
            WHEN l.l_returnflag = 'Y' THEN 'Returned' 
            ELSE 'Not Returned' 
        END AS return_status
    FROM lineitem l
    WHERE l.l_shipdate IS NOT NULL OR l.l_commitdate IS NOT NULL
),
FilteredNations AS (
    SELECT 
        n.n_nationkey,
        n.n_name
    FROM nation n
    WHERE n.n_comment IS NOT NULL AND LENGTH(n.n_comment) > 50
)
SELECT 
    r.r_name,
    SUM(Hi.CustValue) AS TotalCustValue,
    COUNT(DISTINCT Hi.c_custkey) AS UniqueHighValueCustomers,
    MAX(o.o_totalprice) AS MaxOrderValue,
    COUNT(DISTINCT l.l_orderkey) AS TotalOrderLines,
    AVG(s.avg_supply_cost) AS AverageSupplyCost,
    STRING_AGG(DISTINCT p.p_name, ', ') AS PartNames
FROM RankedOrders o
LEFT JOIN HighValueCustomers Hi ON o.o_orderkey IN (SELECT o2.o_orderkey FROM orders o2 WHERE o2.o_custkey = Hi.c_custkey)
JOIN OrderLineDetails l ON l.l_orderkey = o.o_orderkey
JOIN partsupp ps ON ps.ps_partkey = (SELECT ps2.ps_partkey FROM partsupp ps2 WHERE ps2.ps_availqty = (SELECT MAX(ps3.ps_availqty) FROM partsupp ps3 WHERE ps3.ps_partkey = ps.ps_partkey) LIMIT 1)
JOIN SupplierAvailability s ON s.ps_partkey = ps.ps_partkey
JOIN FilteredNations fn ON fn.n_nationkey = (SELECT DISTINCT n.n_nationkey FROM nation n JOIN supplier s2 ON n.n_nationkey = s2.s_nationkey WHERE s2.s_suppkey IN (SELECT ps_suppkey FROM partsupp WHERE ps_supplycost < s.avg_supply_cost))
JOIN region r ON fn.n_nationkey = r.r_regionkey
WHERE o.o_orderstatus IN ('O', 'F') 
  AND l.l_discount BETWEEN 0.05 AND 0.15
  AND (r.r_comment IS NULL OR r.r_comment <> '') 
GROUP BY r.r_name
HAVING SUM(l.l_quantity) > 100
ORDER BY TotalCustValue DESC, MaxOrderValue DESC;