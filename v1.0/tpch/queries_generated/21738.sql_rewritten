WITH RankedParts AS (
    SELECT 
        p.p_partkey,
        p.p_name,
        p.p_retailprice,
        ROW_NUMBER() OVER (PARTITION BY p.p_type ORDER BY p.p_retailprice DESC) AS rn
    FROM 
        part p
),
HighValueSuppliers AS (
    SELECT 
        s.s_suppkey,
        s.s_name,
        s.s_acctbal
    FROM 
        supplier s
    WHERE 
        s.s_acctbal > (SELECT AVG(s2.s_acctbal) FROM supplier s2)
),
OverlappingRelations AS (
    SELECT 
        n.n_name,
        r.r_name,
        COUNT(DISTINCT s.s_suppkey) AS supplier_count
    FROM 
        nation n
    JOIN 
        region r ON n.n_regionkey = r.r_regionkey
    LEFT JOIN 
        supplier s ON n.n_nationkey = s.s_nationkey
    GROUP BY 
        n.n_name, r.r_name
    HAVING 
        COUNT(s.s_suppkey) > 5
),
OrderProfit AS (
    SELECT 
        o.o_orderkey,
        SUM(l.l_extendedprice * (1 - l.l_discount)) AS total_profit
    FROM 
        orders o
    JOIN 
        lineitem l ON o.o_orderkey = l.l_orderkey
    GROUP BY 
        o.o_orderkey
),
FilteredOrders AS (
    SELECT 
        o.o_orderkey,
        o.o_orderdate,
        op.total_profit,
        CASE 
            WHEN op.total_profit IS NULL THEN 'No Profit'
            WHEN op.total_profit < 1000 THEN 'Low Profit'
            ELSE 'High Profit'
        END AS profit_status
    FROM 
        orders o
    LEFT JOIN 
        OrderProfit op ON o.o_orderkey = op.o_orderkey
    WHERE 
        o.o_orderdate > '1996-01-01'
),
FinalReport AS (
    SELECT 
        fr.o_orderkey,
        fr.o_orderdate,
        fr.total_profit,
        fr.profit_status,
        r.r_name,
        p.p_name,
        p.p_retailprice
    FROM 
        FilteredOrders fr
    JOIN 
        RankedParts rp ON fr.o_orderkey % 10 = rp.rn 
    LEFT JOIN 
        OverlappingRelations or ON or.supplier_count > 10
    JOIN 
        lineitem l ON fr.o_orderkey = l.l_orderkey
    JOIN 
        part p ON l.l_partkey = p.p_partkey
    WHERE 
        p.p_retailprice BETWEEN 100 AND 500
        AND (fr.total_profit IS NOT NULL OR fr.profit_status = 'No Profit')
    ORDER BY 
        fr.profit_status, fr.total_profit DESC
)
SELECT *
FROM FinalReport
WHERE EXISTS (
    SELECT 1
    FROM HighValueSuppliers hvs
    WHERE hvs.s_suppkey IN (
        SELECT ps.ps_suppkey
        FROM partsupp ps
        JOIN part p ON ps.ps_partkey = p.p_partkey
        WHERE p.p_retailprice < 200
    )
)
AND NOT EXISTS (
    SELECT 1
    FROM nation n
    WHERE n.n_nationkey = ANY (
        SELECT s.s_nationkey
        FROM supplier s
        WHERE s.s_acctbal IS NULL
    )
);