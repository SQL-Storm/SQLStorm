
WITH RankedSuppliers AS (
    SELECT s.s_suppkey, s.s_name, s.s_nationkey, SUM(ps.ps_supplycost * ps.ps_availqty) AS total_cost
    FROM supplier s
    JOIN partsupp ps ON s.s_suppkey = ps.ps_suppkey
    GROUP BY s.s_suppkey, s.s_name, s.s_nationkey
),
TopSuppliers AS (
    SELECT rs.s_suppkey, rs.s_name
    FROM RankedSuppliers rs
    WHERE rs.total_cost = (SELECT MAX(total_cost) FROM RankedSuppliers)
),
RecentOrders AS (
    SELECT o.o_orderkey, o.o_custkey, o.o_orderdate, l.l_partkey
    FROM orders o
    JOIN lineitem l ON o.o_orderkey = l.l_orderkey
    WHERE o.o_orderdate >= CURRENT_DATE - INTERVAL '1 year'
),
SupplierDetails AS (
    SELECT ts.s_suppkey, ts.s_name, n.n_name AS nation_name, SUM(lo.l_extendedprice * (1 - lo.l_discount)) AS total_revenue
    FROM TopSuppliers ts
    JOIN RecentOrders ro ON EXISTS (
        SELECT 1
        FROM lineitem lo
        WHERE lo.l_orderkey = ro.o_orderkey AND lo.l_suppkey = ts.s_suppkey
    )
    JOIN supplier s ON s.s_suppkey = ts.s_suppkey
    JOIN nation n ON s.s_nationkey = n.n_nationkey
    GROUP BY ts.s_suppkey, ts.s_name, n.n_name
)
SELECT sd.s_name, sd.nation_name, sd.total_revenue
FROM SupplierDetails sd
ORDER BY sd.total_revenue DESC
LIMIT 10;
