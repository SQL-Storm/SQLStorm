
WITH RECURSIVE CustomerHierarchy AS (
    SELECT c.c_custkey, c.c_name, c.c_nationkey, 
           CAST(c.c_name AS VARCHAR(255)) AS full_path
    FROM customer c
    WHERE c.c_acctbal IS NOT NULL AND c.c_name LIKE 'A%'
    
    UNION ALL
    
    SELECT c.c_custkey, c.c_name, c.c_nationkey,
           CONCAT(ch.full_path, ' -> ', c.c_name) AS full_path
    FROM CustomerHierarchy ch
    JOIN customer c ON ch.c_nationkey = c.c_nationkey 
    WHERE c.c_acctbal IS NOT NULL AND c.c_name LIKE 'B%'
),
OrderSummary AS (
    SELECT o.o_orderkey, o.o_custkey, o.o_totalprice,
           ROW_NUMBER() OVER (PARTITION BY o.o_orderstatus ORDER BY o.o_totalprice DESC) AS order_rank,
           SUM(l.l_extendedprice * (1 - l.l_discount)) OVER (PARTITION BY o.o_custkey) AS total_sales
    FROM orders o
    LEFT JOIN lineitem l ON o.o_orderkey = l.l_orderkey
),
SupplierCost AS (
    SELECT ps_partkey, ps_suppkey, SUM(ps_supplycost) AS total_cost,
           COUNT(*) FILTER (WHERE ps_availqty < 100) AS low_availability_count
    FROM partsupp
    GROUP BY ps_partkey, ps_suppkey
),
NationExceed AS (
    SELECT n.n_nationkey, COUNT(DISTINCT s.s_suppkey) AS supplier_count
    FROM nation n
    LEFT JOIN supplier s ON n.n_nationkey = s.s_nationkey
    GROUP BY n.n_nationkey
    HAVING COUNT(DISTINCT s.s_suppkey) > (SELECT AVG(supplier_count) FROM NationExceed)
)
SELECT 
    ch.full_path AS customer_hierarchy,
    os.o_orderkey, os.o_totalprice, os.order_rank, os.total_sales,
    sc.total_cost, sc.low_availability_count,
    r.r_name AS region_name,
    CASE 
        WHEN r.r_name IS NULL THEN 'Unknown Region'
        ELSE r.r_name
    END AS region_status
FROM OrderSummary os
JOIN customer c ON os.o_custkey = c.c_custkey
LEFT JOIN SupplierCost sc ON sc.ps_partkey IN (SELECT l.l_partkey FROM lineitem l WHERE l.l_orderkey = os.o_orderkey)
LEFT JOIN region r ON c.c_nationkey IN (SELECT n.n_nationkey FROM nation n WHERE n.n_nationkey = c.c_nationkey)
WHERE os.order_rank <= 10
  AND os.o_totalprice > (SELECT AVG(os2.o_totalprice) FROM OrderSummary os2 WHERE os2.o_custkey = os.o_custkey)
ORDER BY total_sales DESC NULLS LAST, customer_hierarchy;
