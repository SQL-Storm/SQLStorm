WITH RECURSIVE nation_customers AS (
    SELECT c.c_custkey, c.c_name, c.c_nationkey, 0 AS level
    FROM customer c
    JOIN nation n ON c.c_nationkey = n.n_nationkey
    WHERE n.n_name = 'USA'
    
    UNION ALL
    
    SELECT c.c_custkey, c.c_name, c.c_nationkey, nc.level + 1
    FROM customer c
    JOIN nation_customers nc ON c.c_nationkey = nc.c_nationkey
    WHERE nc.level < 3 AND c.c_custkey <> nc.c_custkey
), 
part_supplier_summary AS (
    SELECT ps.ps_partkey, 
           SUM(ps.ps_availqty) AS total_available_qty, 
           AVG(ps.ps_supplycost) AS avg_supply_cost,
           COUNT(DISTINCT ps.ps_suppkey) AS unique_suppliers
    FROM partsupp ps
    WHERE ps.ps_availqty IS NOT NULL
    GROUP BY ps.ps_partkey
),
lineitem_summary AS (
    SELECT l.l_orderkey, 
           SUM(l.l_extendedprice * (1 - l.l_discount)) AS total_sales,
           SUM(l.l_tax) AS total_tax,
           COUNT(DISTINCT l.l_returnflag) AS return_flag_count
    FROM lineitem l
    WHERE l.l_shipdate BETWEEN '1997-01-01' AND '1997-12-31'
    GROUP BY l.l_orderkey
),
nation_region_customer AS (
    SELECT n.n_nationkey, 
           r.r_regionkey, 
           COUNT(DISTINCT c.c_custkey) AS customer_count
    FROM nation n
    JOIN region r ON n.n_regionkey = r.r_regionkey
    JOIN customer c ON n.n_nationkey = c.c_nationkey
    GROUP BY n.n_nationkey, r.r_regionkey
),
final_aggregated AS (
    SELECT n.n_name AS nation, 
           r.r_name AS region,
           COALESCE(SUM(nr.customer_count), 0) AS total_customers,
           SUM(ps.total_available_qty) AS available_qty_overall,
           SUM(ls.total_sales) AS total_sales_overall
    FROM nation_region_customer nr
    FULL OUTER JOIN part_supplier_summary ps ON ps.ps_partkey IN (
        SELECT l.l_partkey
        FROM lineitem l
        JOIN orders o ON l.l_orderkey = o.o_orderkey
        WHERE o.o_orderstatus = 'F'
    )
    FULL OUTER JOIN lineitem_summary ls ON ls.l_orderkey IN (
        SELECT o.o_orderkey
        FROM orders o
        WHERE o.o_orderpriority = 'HIGH'
    )
    JOIN nation n ON nr.n_nationkey = n.n_nationkey
    JOIN region r ON nr.r_regionkey = r.r_regionkey
    GROUP BY n.n_name, r.r_name
)
SELECT DISTINCT nation, region, 
       CASE 
           WHEN total_customers IS NULL THEN 'No Customers' 
           ELSE CAST(total_customers AS VARCHAR) 
       END AS customer_count,
       COALESCE(available_qty_overall, 0) AS available_qty,
       COALESCE(total_sales_overall, 0) AS total_sales
FROM final_aggregated
WHERE total_sales_overall > (
    SELECT AVG(total_sales_overall) 
    FROM final_aggregated
    WHERE total_sales_overall IS NOT NULL
)
ORDER BY nation, region;