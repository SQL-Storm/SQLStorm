
WITH high_value_orders AS (
    SELECT o.o_orderkey, o.o_totalprice, o.o_orderdate, 
           ROW_NUMBER() OVER (PARTITION BY o.o_orderstatus ORDER BY o.o_totalprice DESC) AS rn
    FROM orders o
    WHERE o.o_orderdate >= DATE '1995-01-01'
      AND o.o_orderdate <= DATE '1996-12-31'
      AND o.o_totalprice > (
          SELECT AVG(o2.o_totalprice)
          FROM orders o2
          WHERE o2.o_orderstatus = o.o_orderstatus
      )
),
supplier_details AS (
    SELECT s.s_suppkey, s.s_name, s.s_acctbal, 
           RANK() OVER (PARTITION BY s.s_nationkey ORDER BY s.s_acctbal DESC) AS rnk
    FROM supplier s
    WHERE s.s_acctbal IS NOT NULL
),
part_availability AS (
    SELECT ps.ps_partkey, SUM(ps.ps_availqty) AS total_avail
    FROM partsupp ps
    GROUP BY ps.ps_partkey
),
order_line_item AS (
    SELECT li.l_orderkey, li.l_partkey, 
           SUM(li.l_extendedprice * (1 - li.l_discount)) AS net_revenue
    FROM lineitem li
    WHERE li.l_shipdate IS NOT NULL
    AND li.l_returnflag = 'N'
    GROUP BY li.l_orderkey, li.l_partkey
),
national_supplier AS (
    SELECT n.n_nationkey, n.n_name, COUNT(DISTINCT s.s_suppkey) AS supplier_count
    FROM nation n
    LEFT JOIN supplier s ON n.n_nationkey = s.s_nationkey
    GROUP BY n.n_nationkey, n.n_name
)
SELECT r.r_name, 
       COALESCE(SUM(hoi.o_totalprice), 0) AS total_order_value,
       COUNT(DISTINCT osi.l_orderkey) AS unique_orders,
       COUNT(DISTINCT s.s_suppkey) FILTER (WHERE sd.rnk <= 3) AS top_suppliers,
       COALESCE(ROUND(AVG(od.net_revenue), 2), 0) AS avg_net_revenue
FROM region r
LEFT JOIN national_supplier ns ON ns.n_nationkey = r.r_regionkey
LEFT JOIN high_value_orders hoi ON hoi.o_orderkey IN (
    SELECT o.o_orderkey
    FROM orders o
    WHERE o.o_orderstatus = 'F' AND o.o_totalprice IS NOT NULL
      AND EXISTS (
          SELECT 1
          FROM lineitem l
          WHERE l.l_orderkey = o.o_orderkey AND l.l_shipdate < DATE '1998-10-01'
      )
)
LEFT JOIN order_line_item od ON od.l_orderkey = hoi.o_orderkey
LEFT JOIN supplier s ON s.s_nationkey = ns.n_nationkey
LEFT JOIN supplier_details sd ON sd.s_suppkey = s.s_suppkey
WHERE r.r_name IS NOT NULL
GROUP BY r.r_name
HAVING COUNT(DISTINCT s.s_suppkey) > 1
   OR MAX(s.s_acctbal) IS NULL
ORDER BY total_order_value DESC, r.r_name;
