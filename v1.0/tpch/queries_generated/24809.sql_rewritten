WITH RankedParts AS (
    SELECT 
        p.p_partkey,
        p.p_name,
        p.p_retailprice,
        ROW_NUMBER() OVER (PARTITION BY p.p_type ORDER BY p.p_retailprice DESC) AS price_rank,
        p.p_comment,
        (CASE 
            WHEN p.p_size IS NULL THEN 'Unknown Size' 
            ELSE CAST(p.p_size AS VARCHAR)
            END) AS size_description
    FROM part p
    WHERE p.p_brand NOT LIKE 'Brand%')
,
SupplierStats AS (
    SELECT 
        s.s_suppkey,
        COUNT(DISTINCT ps.ps_partkey) AS unique_parts,
        SUM(ps.ps_availqty) AS total_avail_qty,
        MAX(ps.ps_supplycost) AS max_supply_cost,
        MIN(ps.ps_supplycost) AS min_supply_cost
    FROM supplier s
    JOIN partsupp ps ON s.s_suppkey = ps.ps_suppkey
    WHERE s.s_acctbal IS NOT NULL AND s.s_acctbal > 0
    GROUP BY s.s_suppkey
)
SELECT 
    r.r_name AS region_name,
    n.n_name AS nation_name,
    COUNT(DISTINCT sup.s_suppkey) AS supplier_count,
    SUM(COALESCE(l.l_extendedprice * (1 - l.l_discount), 0)) AS total_revenue,
    COUNT(DISTINCT p.p_partkey) AS part_count,
    AVG(coalesce(l.l_discount, 0)) as average_discount,
    (SELECT COUNT(*)
     FROM lineitem l2
     WHERE l2.l_shipdate BETWEEN DATE '1996-01-01' AND DATE '1997-12-31') AS lineitem_year_count
FROM region r
JOIN nation n ON r.r_regionkey = n.n_regionkey
JOIN supplier sup ON n.n_nationkey = sup.s_nationkey
LEFT JOIN partsupp ps ON sup.s_suppkey = ps.ps_suppkey
LEFT JOIN part p ON ps.ps_partkey = p.p_partkey
LEFT JOIN lineitem l ON l.l_suppkey = sup.s_suppkey
WHERE l.l_returnflag = 'R' OR (ps.ps_availqty > 100 AND p.p_retailprice < 100)
GROUP BY r.r_name, n.n_name
HAVING SUM(l.l_quantity) IS NOT NULL
   AND AVG(sup.s_acctbal) > (SELECT AVG(s.s_acctbal) FROM supplier s WHERE s.s_nationkey = n.n_nationkey) 
   OR COUNT(DISTINCT p.p_partkey) > 10
ORDER BY region_name, nation_name;