
WITH RankedSuppliers AS (
    SELECT s.s_suppkey,
           s.s_name,
           s.s_acctbal,
           RANK() OVER (PARTITION BY s.n_nationkey ORDER BY s.s_acctbal DESC) AS rank_by_balance
    FROM supplier s
), 
HighValueParts AS (
    SELECT p.p_partkey,
           p.p_name,
           p.p_retailprice,
           COUNT(DISTINCT ps.ps_suppkey) AS supplier_count
    FROM part p
    JOIN partsupp ps ON p.p_partkey = ps.ps_partkey
    WHERE p.p_retailprice > (
        SELECT AVG(p2.p_retailprice) 
        FROM part p2
        WHERE p2.p_size IS NOT NULL
    )
    GROUP BY p.p_partkey, p.p_name, p.p_retailprice
    HAVING COUNT(DISTINCT ps.ps_suppkey) > 2
), 
RecentOrders AS (
    SELECT o.o_orderkey,
           o.o_totalprice,
           o.o_orderdate,
           SUM(l.l_extendedprice * (1 - l.l_discount)) AS total_lineitem_value
    FROM orders o
    JOIN lineitem l ON o.o_orderkey = l.l_orderkey
    WHERE o.o_orderdate >= DATE '1998-10-01' - INTERVAL '1 year'
    GROUP BY o.o_orderkey, o.o_totalprice, o.o_orderdate
)
SELECT ns.r_name AS nation_name,
       SUM(COALESCE(r.s_acctbal, 0)) AS total_supplier_balance,
       COUNT(DISTINCT rv.o_orderkey) AS recent_order_count,
       SUM(hp.p_retailprice * hp.supplier_count) AS value_of_high_value_parts
FROM RankedSuppliers r
LEFT JOIN nation ns ON r.s_nationkey = ns.n_nationkey
LEFT JOIN RecentOrders rv ON rv.o_orderkey IN (
    SELECT o.o_orderkey
    FROM orders o
    WHERE o.o_orderstatus IN ('F', 'O')
)
JOIN HighValueParts hp ON hp.supplier_count > 1
GROUP BY ns.r_name
HAVING SUM(CASE WHEN r.rank_by_balance = 1 THEN r.s_acctbal ELSE 0 END) > 100000.00
ORDER BY total_supplier_balance DESC, recent_order_count ASC;
