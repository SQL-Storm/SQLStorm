
WITH RankedOrders AS (
    SELECT 
        o.o_orderkey,
        o.o_totalprice,
        o.o_orderdate,
        o.o_orderstatus,
        ROW_NUMBER() OVER (PARTITION BY o.o_orderstatus ORDER BY o.o_totalprice DESC) AS rn
    FROM orders o
    WHERE o.o_orderdate BETWEEN '1997-01-01' AND '1997-12-31'
),
TopOrders AS (
    SELECT 
        ro.o_orderkey,
        ro.o_totalprice,
        ro.o_orderdate
    FROM RankedOrders ro
    WHERE ro.rn <= 10
),
CustomerAgg AS (
    SELECT 
        c.c_custkey,
        c.c_name,
        SUM(o.o_totalprice) AS total_spent
    FROM customer c
    JOIN orders o ON c.c_custkey = o.o_custkey
    GROUP BY c.c_custkey, c.c_name
    HAVING SUM(o.o_totalprice) > 1000
),
PartSupplierAgg AS (
    SELECT 
        ps.ps_partkey,
        SUM(ps.ps_supplycost * ps.ps_availqty) AS supplier_value
    FROM partsupp ps
    GROUP BY ps.ps_partkey
    HAVING SUM(ps.ps_supplycost * ps.ps_availqty) > 5000
)

SELECT 
    to.o_orderkey,
    to.o_totalprice,
    ca.c_name,
    psa.supplier_value
FROM TopOrders to
JOIN CustomerAgg ca ON ca.c_custkey IN (
        SELECT o.o_custkey
        FROM orders o
        WHERE o.o_orderkey = to.o_orderkey
    )
JOIN PartSupplierAgg psa ON psa.ps_partkey IN (
        SELECT l.l_partkey
        FROM lineitem l
        WHERE l.l_orderkey = to.o_orderkey
    )
ORDER BY to.o_totalprice DESC, ca.total_spent DESC;
