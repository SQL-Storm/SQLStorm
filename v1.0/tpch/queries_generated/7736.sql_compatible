
WITH CustomerOrders AS (
    SELECT c.c_custkey, c.c_name, c.c_nationkey, SUM(o.o_totalprice) AS total_spent
    FROM customer c
    JOIN orders o ON c.c_custkey = o.o_custkey
    WHERE o.o_orderstatus = 'F'
    GROUP BY c.c_custkey, c.c_name, c.c_nationkey
),
HighSpenders AS (
    SELECT co.c_custkey, co.c_name, co.total_spent, n.n_name AS nation_name
    FROM CustomerOrders co
    JOIN nation n ON co.c_nationkey = n.n_nationkey
    WHERE co.total_spent > 10000
),
SupplierProductStats AS (
    SELECT ps.ps_suppkey, SUM(ps.ps_availqty) AS total_available_qty, AVG(ps.ps_supplycost) AS avg_supply_cost
    FROM partsupp ps
    JOIN part p ON ps.ps_partkey = p.p_partkey
    GROUP BY ps.ps_suppkey
)
SELECT hs.c_name, hs.total_spent, hs.nation_name, s.s_name AS supplier_name, s.total_available_qty, s.avg_supply_cost
FROM HighSpenders hs
JOIN SupplierProductStats s ON s.ps_suppkey = (
    SELECT ps.ps_suppkey
    FROM partsupp ps
    JOIN lineitem li ON ps.ps_partkey = li.l_partkey
    WHERE li.l_orderkey IN (
        SELECT o.o_orderkey 
        FROM orders o 
        WHERE o.o_custkey = hs.c_custkey
    )
    GROUP BY ps.ps_suppkey
    ORDER BY SUM(li.l_quantity) DESC
    LIMIT 1
)
ORDER BY hs.total_spent DESC, hs.nation_name, supplier_name;
