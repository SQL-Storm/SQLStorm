
WITH UserSummary AS (
    SELECT
        U.Id AS UserId,
        U.DisplayName,
        COALESCE(SUM(CASE WHEN P.PostTypeId = 2 THEN 1 ELSE 0 END), 0) AS AnswerCount,
        COALESCE(SUM(CASE WHEN P.PostTypeId = 1 THEN 1 ELSE 0 END), 0) AS QuestionCount,
        COUNT(DISTINCT B.Id) AS BadgeCount,
        COALESCE(SUM(V.BountyAmount), 0) AS TotalBountyEarned
    FROM Users U
    LEFT JOIN Posts P ON U.Id = P.OwnerUserId
    LEFT JOIN Badges B ON U.Id = B.UserId
    LEFT JOIN Votes V ON U.Id = V.UserId
    GROUP BY U.Id, U.DisplayName
),

RankedUsers AS (
    SELECT 
        UserId,
        DisplayName,
        AnswerCount,
        QuestionCount,
        BadgeCount,
        TotalBountyEarned,
        RANK() OVER (ORDER BY TotalBountyEarned DESC, AnswerCount DESC) AS Rank
    FROM UserSummary
),

TopUsers AS (
    SELECT 
        UserId,
        DisplayName,
        AnswerCount,
        QuestionCount,
        BadgeCount,
        TotalBountyEarned
    FROM RankedUsers
    WHERE Rank <= 10
)

SELECT 
    U.DisplayName,
    COALESCE(Ph.Name, 'No Post History') AS PostHistoryType,
    COUNT(DISTINCT Ph.Id) AS PostHistoryCount,
    AVG(EXTRACT(EPOCH FROM (P.LastActivityDate - P.CreationDate))) AS AvgPostAgeInSeconds,
    MAX(COALESCE(P.ViewCount, 0)) AS MaxViewCount,
    STRING_AGG(DISTINCT T.TagName, ', ') AS TagsUsed
FROM TopUsers U
LEFT JOIN Posts P ON U.UserId = P.OwnerUserId
LEFT JOIN PostHistory Ph ON P.Id = Ph.PostId
LEFT JOIN (SELECT DISTINCT UNNEST(SPLIT_PART(P.Tags, '>', 1)) AS TagName FROM Posts P) T ON TRUE
GROUP BY U.UserId, U.DisplayName, Ph.Name
HAVING COUNT(DISTINCT P.Id) > 5
ORDER BY MaxViewCount DESC, U.DisplayName;
