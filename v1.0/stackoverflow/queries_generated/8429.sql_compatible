
WITH UserReputation AS (
    SELECT U.Id AS UserId, U.Reputation, COUNT(DISTINCT P.Id) AS TotalPosts
    FROM Users U
    LEFT JOIN Posts P ON U.Id = P.OwnerUserId
    GROUP BY U.Id, U.Reputation
),
PopularTags AS (
    SELECT UNNEST(STRING_TO_ARRAY(T.Tags, ',')) AS TagName, COUNT(P.Id) AS PostCount
    FROM Posts P
    JOIN Tags T ON P.Tags LIKE CONCAT('%', T.TagName, '%')
    GROUP BY T.Tags
    ORDER BY PostCount DESC
    LIMIT 10
),
PostStatistics AS (
    SELECT 
        P.Id AS PostId,
        P.Title,
        P.CreationDate,
        P.ViewCount,
        P.Score,
        U.Reputation,
        T.TagName,
        C.CommentCount
    FROM Posts P
    LEFT JOIN Users U ON P.OwnerUserId = U.Id
    LEFT JOIN Comments C ON P.Id = C.PostId
    JOIN PopularTags T ON P.Tags LIKE CONCAT('%', T.TagName, '%')
)
SELECT 
    PS.PostId,
    PS.Title,
    PS.CreationDate,
    PS.ViewCount,
    PS.Score,
    PS.Reputation,
    COUNT(DISTINCT C.Id) AS TotalComments,
    T.TagName
FROM PostStatistics PS
LEFT JOIN Comments C ON PS.PostId = C.PostId
GROUP BY PS.PostId, PS.Title, PS.CreationDate, PS.ViewCount, PS.Score, PS.Reputation, T.TagName
ORDER BY PS.Score DESC, PS.ViewCount DESC;
