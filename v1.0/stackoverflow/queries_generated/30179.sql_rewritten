WITH RecursivePostHierarchy AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.OwnerUserId,
        p.CreationDate,
        p.AcceptedAnswerId,
        1 AS Level
    FROM 
        Posts p
    WHERE 
        p.PostTypeId = 1  

    UNION ALL

    SELECT 
        p2.Id,
        p2.Title,
        p2.OwnerUserId,
        p2.CreationDate,
        p2.AcceptedAnswerId,
        rp.Level + 1
    FROM 
        Posts p2
    INNER JOIN 
        RecursivePostHierarchy rp ON p2.ParentId = rp.PostId
),

PostScores AS (
    SELECT 
        p.Id AS PostId,
        p.Score,
        o.DisplayName AS OwnerDisplayName,
        COALESCE(SUM(v.BountyAmount), 0) AS TotalBounty
    FROM 
        Posts p
    LEFT JOIN 
        Users o ON p.OwnerUserId = o.Id
    LEFT JOIN 
        Votes v ON p.Id = v.PostId AND v.VoteTypeId = 8  
    GROUP BY 
        p.Id, o.DisplayName
),

PostHistoryDetails AS (
    SELECT 
        ph.PostId,
        ph.CreationDate,
        PHT.Name AS HistoryType,
        COUNT(DISTINCT ph.Id) AS EditCount
    FROM 
        PostHistory ph
    JOIN 
        PostHistoryTypes PHT ON ph.PostHistoryTypeId = PHT.Id
    WHERE 
        ph.CreationDate >= cast('2024-10-01 12:34:56' as timestamp) - INTERVAL '90 days'
    GROUP BY 
        ph.PostId, ph.CreationDate, PHT.Name
),

UserBadges AS (
    SELECT 
        b.UserId,
        COUNT(b.Id) AS BadgeCount,
        STRING_AGG(b.Name, ', ') AS BadgeNames
    FROM 
        Badges b
    WHERE 
        b.Date >= cast('2024-10-01 12:34:56' as timestamp) - INTERVAL '365 days'
    GROUP BY 
        b.UserId
)

SELECT 
    r.PostId,
    r.Title,
    ps.Score,
    ps.TotalBounty,
    r.OwnerUserId,
    ub.BadgeCount,
    ub.BadgeNames,
    phd.EditCount AS RecentEditCount,
    r.CreationDate AS QuestionDate,
    r.Level
FROM 
    RecursivePostHierarchy r
LEFT JOIN 
    PostScores ps ON r.PostId = ps.PostId
LEFT JOIN 
    UserBadges ub ON r.OwnerUserId = ub.UserId
LEFT JOIN 
    PostHistoryDetails phd ON r.PostId = phd.PostId 
ORDER BY 
    r.Level DESC,
    ps.Score DESC,
    r.CreationDate ASC;