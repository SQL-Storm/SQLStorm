
WITH 

LatestEdits AS (
    SELECT 
        Ph.PostId, 
        MAX(Ph.CreationDate) AS LastEditDate
    FROM 
        PostHistory Ph
    WHERE 
        Ph.PostHistoryTypeId IN (4, 5) 
    GROUP BY 
        Ph.PostId
),
PostEditDetails AS (
    SELECT 
        P.Id AS PostId, 
        P.Title, 
        P.Body, 
        L.LastEditDate,
        COALESCE(PH.Comment, '') AS LastComment
    FROM 
        Posts P
    JOIN 
        LatestEdits L ON P.Id = L.PostId
    LEFT JOIN 
        PostHistory PH ON P.Id = PH.PostId AND PH.CreationDate = L.LastEditDate
),

RecursivePostLinks AS (
    SELECT 
        PL.PostId, 
        PL.RelatedPostId
    FROM 
        PostLinks PL
    UNION ALL
    SELECT 
        PL.PostId, 
        PL.RelatedPostId
    FROM 
        PostLinks PL
    JOIN 
        RecursivePostLinks R ON PL.PostId = R.RelatedPostId
),

UserEngagement AS (
    SELECT 
        U.Id AS UserId,
        U.DisplayName,
        COUNT(DISTINCT P.Id) AS TotalPosts,
        COUNT(DISTINCT C.Id) AS TotalComments,
        COUNT(DISTINCT E.PostId) AS PostsEdited,
        SUM(COALESCE(V.BountyAmount, 0)) AS TotalBounty
    FROM 
        Users U
    LEFT JOIN 
        Posts P ON U.Id = P.OwnerUserId
    LEFT JOIN 
        Comments C ON P.Id = C.PostId
    LEFT JOIN 
        PostEditDetails E ON P.Id = E.PostId
    LEFT JOIN 
        Votes V ON P.Id = V.PostId AND V.VoteTypeId = 8 
    GROUP BY 
        U.Id, U.DisplayName
)

SELECT 
    U.UserId,
    U.DisplayName,
    U.TotalPosts,
    U.TotalComments,
    U.PostsEdited,
    U.TotalBounty,
    STRING_AGG(DISTINCT T.TagName, ', ') AS TagsUsed
FROM 
    UserEngagement U
LEFT JOIN 
    Posts P ON U.UserId = P.OwnerUserId
LEFT JOIN 
    (SELECT DISTINCT UNNEST(SPLIT(P.Tags, ',')) AS TagName FROM Posts P) AS Tags ON TRUE
LEFT JOIN 
    Tags T ON T.TagName = Tags.TagName
GROUP BY 
    U.UserId, U.DisplayName, U.TotalPosts, U.TotalComments, U.PostsEdited, U.TotalBounty
ORDER BY 
    U.TotalPosts DESC, U.TotalComments DESC;
