WITH UserPostStats AS (
    SELECT
        U.Id AS UserId,
        U.DisplayName,
        COUNT(P.Id) AS TotalPosts,
        SUM(CASE WHEN P.Score > 0 THEN 1 ELSE 0 END) AS UpvotedPosts,
        SUM(CASE WHEN P.Score < 0 THEN 1 ELSE 0 END) AS DownvotedPosts,
        SUM(CASE WHEN P.PostTypeId = 1 THEN 1 ELSE 0 END) AS QuestionCount,
        SUM(CASE WHEN P.PostTypeId = 2 THEN 1 ELSE 0 END) AS AnswerCount,
        MAX(P.CreationDate) AS LastPostDate
    FROM
        Users U
    LEFT JOIN
        Posts P ON U.Id = P.OwnerUserId
    GROUP BY
        U.Id, U.DisplayName
),

UserBadges AS (
    SELECT
        B.UserId,
        COUNT(*) AS BadgeCount,
        STRING_AGG(B.Name, ', ') AS BadgeNames
    FROM
        Badges B
    GROUP BY
        B.UserId
),

PopularTags AS (
    SELECT
        T.TagName,
        COUNT(P.Id) AS PostsWithTag
    FROM
        Tags T
    JOIN
        Posts P ON P.Tags LIKE '%' || T.TagName || '%'
    GROUP BY
        T.TagName
    HAVING
        COUNT(P.Id) > 10
),

PostHistoryStats AS (
    SELECT
        PH.UserId,
        COUNT(PH.Id) AS EditCount,
        MAX(PH.CreationDate) AS LastEditDate
    FROM
        PostHistory PH
    WHERE
        PH.PostHistoryTypeId IN (4, 5, 6)  
    GROUP BY
        PH.UserId
)

SELECT
    U.UserId,
    U.DisplayName,
    COALESCE(UPS.TotalPosts, 0) AS TotalPosts,
    COALESCE(UPS.UpvotedPosts, 0) AS UpvotedPosts,
    COALESCE(UPS.DownvotedPosts, 0) AS DownvotedPosts,
    COALESCE(UPS.QuestionCount, 0) AS QuestionCount,
    COALESCE(UPS.AnswerCount, 0) AS AnswerCount,
    COALESCE(UB.BadgeCount, 0) AS BadgeCount,
    COALESCE(UB.BadgeNames, 'None') AS BadgeNames,
    COALESCE(PH.EditCount, 0) AS PostEditCount,
    COALESCE(PH.LastEditDate, 'Never') AS LastEditDate,
    (SELECT STRING_AGG(T.TagName, ', ') 
     FROM PopularTags T 
     WHERE T.PostsWithTag = (SELECT MAX(PostsWithTag) FROM PopularTags)) AS MostPopularTag
FROM
    Users U
LEFT JOIN
    UserPostStats UPS ON U.Id = UPS.UserId
LEFT JOIN
    UserBadges UB ON U.Id = UB.UserId
LEFT JOIN
    PostHistoryStats PH ON U.Id = PH.UserId
WHERE
    U.Reputation > 1000
ORDER BY
    U.DisplayName;