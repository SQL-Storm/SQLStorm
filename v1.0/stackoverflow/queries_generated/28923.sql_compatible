
WITH RankedPosts AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.CreationDate,
        u.DisplayName AS OwnerDisplayName,
        STRING_AGG(DISTINCT t.TagName, ', ') AS Tags,
        COALESCE(p.AnswerCount, 0) AS AnswerCount,
        COALESCE(p.CommentCount, 0) AS CommentCount,
        COALESCE(p.ViewCount, 0) AS ViewCount,
        RANK() OVER (PARTITION BY p.PostTypeId ORDER BY p.Score DESC) AS RankScore
    FROM 
        Posts p
    LEFT JOIN 
        Users u ON p.OwnerUserId = u.Id
    LEFT JOIN 
        UNNEST(STRING_TO_ARRAY(SUBSTRING(p.Tags, 2, LENGTH(p.Tags) - 2), '><')) AS tag ON t.TagName = tag
    GROUP BY 
        p.Id, p.Title, p.CreationDate, u.DisplayName, p.AnswerCount, p.CommentCount, p.ViewCount
),
TopPostStats AS (
    SELECT 
        PostId,
        Title,
        OwnerDisplayName,
        Tags,
        AnswerCount,
        CommentCount,
        ViewCount
    FROM 
        RankedPosts
    WHERE 
        RankScore <= 5
)
SELECT 
    t.Title,
    t.OwnerDisplayName,
    t.Tags,
    t.AnswerCount,
    t.CommentCount,
    t.ViewCount,
    ph.CreationDate AS LastActivityDate,
    COALESCE(bg.Name, 'No Badge') AS UserBadge
FROM 
    TopPostStats t
LEFT JOIN 
    Posts ph ON t.PostId = ph.Id
LEFT JOIN 
    Badges bg ON t.OwnerDisplayName = bg.UserId
ORDER BY 
    t.ViewCount DESC;
