
WITH RecursivePosts AS (
    SELECT Id, PostTypeId, Title, OwnerUserId, AcceptedAnswerId, CreationDate,
           ROW_NUMBER() OVER(PARTITION BY OwnerUserId ORDER BY CreationDate DESC) AS PostRank
    FROM Posts
    WHERE CreationDate >= TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '1 year'
),
UserStats AS (
    SELECT u.Id AS UserId,
           u.DisplayName,
           COALESCE(SUM(CASE WHEN p.PostTypeId = 1 THEN 1 ELSE 0 END), 0) AS QuestionCount,
           COALESCE(SUM(CASE WHEN p.PostTypeId = 2 THEN 1 ELSE 0 END), 0) AS AnswerCount,
           COUNT(DISTINCT b.Id) AS BadgeCount,
           COUNT(DISTINCT v.Id) AS VoteCount,
           AVG(u.Reputation) AS AvgReputation
    FROM Users u
    LEFT JOIN Posts p ON u.Id = p.OwnerUserId
    LEFT JOIN Badges b ON u.Id = b.UserId
    LEFT JOIN Votes v ON u.Id = v.UserId
    WHERE u.Reputation > 100
    GROUP BY u.Id, u.DisplayName
),
TopUsers AS (
    SELECT UserId, DisplayName, QuestionCount, AnswerCount, BadgeCount, VoteCount, AvgReputation,
           RANK() OVER (ORDER BY QuestionCount DESC, AnswerCount DESC) AS Rank
    FROM UserStats
)
SELECT t.UserId, t.DisplayName, t.QuestionCount AS Questions, t.AnswerCount AS Answers, 
       t.BadgeCount AS Badges, t.VoteCount AS Votes, t.Rank,
       COALESCE((
           SELECT COUNT(*)
           FROM Comments c
           WHERE c.UserId = t.UserId AND c.CreationDate >= TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '1 year'
       ), 0) AS RecentCommentCount,
       (SELECT STRING_AGG(DISTINCT pt.Name, ', ')
        FROM Posts p
        JOIN PostTypes pt ON p.PostTypeId = pt.Id
        WHERE p.OwnerUserId = t.UserId AND p.CreationDate >= TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '1 year') AS PostTypesUsed
FROM (
    SELECT UserId, DisplayName, QuestionCount, AnswerCount, BadgeCount, VoteCount,
           CASE WHEN BadgeCount > 0 THEN CAST(BadgeCount AS TEXT) ELSE 'No Badges' END AS Badges,
           CASE WHEN VoteCount > 0 THEN CAST(VoteCount AS TEXT) ELSE 'No Votes' END AS Votes
    FROM TopUsers
    WHERE Rank <= 10
) AS t
LEFT JOIN RecursivePosts rp ON rp.OwnerUserId = t.UserId
WHERE rp.PostRank = 1
ORDER BY t.Rank;
