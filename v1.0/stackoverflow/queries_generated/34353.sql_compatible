
WITH RecursivePosts AS (
    SELECT 
        Id,
        Title,
        CreationDate,
        PostTypeId,
        ViewCount,
        Score,
        OwnerUserId,
        1 AS Level
    FROM Posts
    WHERE PostTypeId = 1  

    UNION ALL

    SELECT 
        p.Id,
        p.Title,
        p.CreationDate,
        p.PostTypeId,
        p.ViewCount,
        p.Score,
        p.OwnerUserId,
        rp.Level + 1
    FROM Posts p
    INNER JOIN RecursivePosts rp ON p.ParentId = rp.Id
    WHERE p.PostTypeId = 2 
),
UserStatistics AS (
    SELECT 
        u.Id AS UserId,
        u.DisplayName,
        SUM(COALESCE(b.Class, 0)) AS TotalBadges,
        SUM(COALESCE(v.BountyAmount, 0)) AS TotalBounties,
        COUNT(DISTINCT p.Id) AS TotalPosts,
        SUM(p.ViewCount) AS TotalViews
    FROM Users u
    LEFT JOIN Badges b ON u.Id = b.UserId
    LEFT JOIN Votes v ON u.Id = v.UserId AND v.VoteTypeId = 9 
    LEFT JOIN Posts p ON u.Id = p.OwnerUserId 
    GROUP BY u.Id, u.DisplayName
),
FilteredPosts AS (
    SELECT 
        rp.Id,
        rp.Title,
        rp.CreationDate,
        rp.ViewCount,
        rp.Score,
        us.UserId,
        us.DisplayName,
        us.TotalBadges,
        us.TotalBounties,
        us.TotalPosts,
        us.TotalViews
    FROM RecursivePosts rp
    INNER JOIN UserStatistics us ON rp.OwnerUserId = us.UserId
    WHERE rp.Score > 0 
),
PostHistoryAggregates AS (
    SELECT 
        ph.PostId,
        MAX(ph.CreationDate) AS LastEditDate,
        COUNT(*) AS TotalEdits,
        STRING_AGG(DISTINCT pht.Name, ', ') AS EditTypes
    FROM PostHistory ph
    JOIN PostHistoryTypes pht ON ph.PostHistoryTypeId = pht.Id
    GROUP BY ph.PostId
)
SELECT 
    fp.Id AS PostId,
    fp.Title,
    fp.ViewCount,
    fp.Score,
    fp.DisplayName AS Owner,
    fp.TotalBadges,
    fp.TotalBounties,
    ph.LastEditDate,
    ph.TotalEdits,
    ph.EditTypes
FROM FilteredPosts fp
LEFT JOIN PostHistoryAggregates ph ON fp.Id = ph.PostId
WHERE (fp.TotalViews > 1000 OR ph.TotalEdits > 5) 
ORDER BY fp.ViewCount DESC, fp.Score DESC
LIMIT 50 OFFSET 0;
