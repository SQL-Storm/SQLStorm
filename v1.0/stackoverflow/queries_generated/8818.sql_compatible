
WITH RankedPosts AS (
    SELECT 
        Posts.Id AS PostId,
        Posts.Title,
        Posts.CreationDate,
        Posts.Score,
        Posts.ViewCount,
        Users.DisplayName AS Author,
        COUNT(Comments.Id) AS CommentCount,
        AVG(CASE WHEN Votes.VoteTypeId = 2 THEN 1 ELSE 0 END) AS UpvoteCount,  
        AVG(CASE WHEN Votes.VoteTypeId = 3 THEN 1 ELSE 0 END) AS DownvoteCount, 
        ROW_NUMBER() OVER (PARTITION BY Posts.OwnerUserId ORDER BY Posts.Score DESC) AS UserPostRank,
        Posts.OwnerUserId
    FROM 
        Posts
    INNER JOIN 
        Users ON Posts.OwnerUserId = Users.Id
    LEFT JOIN 
        Comments ON Posts.Id = Comments.PostId
    LEFT JOIN 
        Votes ON Posts.Id = Votes.PostId
    WHERE 
        Posts.CreationDate > DATEADD(year, -1, '2024-10-01')
    GROUP BY 
        Posts.Id, Posts.Title, Posts.CreationDate, Posts.Score, Posts.ViewCount, Users.DisplayName, Posts.OwnerUserId
),
TopUsers AS (
    SELECT 
        OwnerUserId,
        COUNT(*) AS PostCount,
        SUM(Score) AS TotalScore,
        RANK() OVER (ORDER BY SUM(Score) DESC) AS UserRank
    FROM 
        Posts
    WHERE 
        Posts.CreationDate > DATEADD(year, -1, '2024-10-01')
    GROUP BY 
        OwnerUserId
    HAVING 
        COUNT(*) > 5
)
SELECT 
    RP.PostId,
    RP.Title,
    RP.CreationDate,
    RP.Score,
    RP.ViewCount,
    RP.Author,
    RP.CommentCount,
    RP.UpvoteCount,
    RP.DownvoteCount,
    TU.PostCount,
    TU.TotalScore,
    TU.UserRank
FROM 
    RankedPosts RP
JOIN 
    TopUsers TU ON RP.OwnerUserId = TU.OwnerUserId
ORDER BY 
    TU.UserRank, RP.Score DESC, RP.CreationDate DESC
LIMIT 
    50;
