WITH UserActivity AS (
    SELECT 
        u.Id AS UserId,
        u.Reputation,
        COUNT(p.Id) AS PostCount,
        SUM(c.Score) AS TotalCommentScore,
        AVG(v.BountyAmount) AS AvgBountyAmount
    FROM Users u
    LEFT JOIN Posts p ON u.Id = p.OwnerUserId
    LEFT JOIN Comments c ON p.Id = c.PostId
    LEFT JOIN Votes v ON p.Id = v.PostId AND v.UserId = u.Id
    WHERE u.Reputation > 0 
    GROUP BY u.Id, u.Reputation
),
TagStatistics AS (
    SELECT
        t.TagName,
        COUNT(p.Id) AS PostCount,
        SUM(p.ViewCount) AS TotalViews,
        AVG(p.Score) AS AvgScore
    FROM Tags t
    LEFT JOIN Posts p ON p.Tags LIKE '%' || t.TagName || '%'
    GROUP BY t.TagName
),
PostHistoryStats AS (
    SELECT 
        p.Id AS PostId,
        COUNT(ph.Id) AS RevisionCount,
        MAX(ph.CreationDate) AS LastRevisionDate
    FROM Posts p
    LEFT JOIN PostHistory ph ON p.Id = ph.PostId
    GROUP BY p.Id
)
SELECT 
    ua.UserId,
    ua.Reputation,
    ua.PostCount, 
    ua.TotalCommentScore,
    ua.AvgBountyAmount,
    ts.TagName,
    ts.PostCount AS TagPostCount,
    ts.TotalViews,
    ts.AvgScore,
    phs.RevisionCount,
    phs.LastRevisionDate
FROM UserActivity ua
JOIN TagStatistics ts ON ua.PostCount > 0
JOIN PostHistoryStats phs ON phs.PostId IN (SELECT Id FROM Posts WHERE OwnerUserId = ua.UserId)
ORDER BY ua.Reputation DESC, ts.PostCount DESC;