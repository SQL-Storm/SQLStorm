WITH UserMetrics AS (
    SELECT
        u.Id AS UserId,
        u.Reputation,
        u.CreationDate,
        COUNT(DISTINCT p.Id) AS PostCount,
        COUNT(DISTINCT c.Id) AS CommentCount,
        SUM(v.BountyAmount) AS TotalBountyAmount,
        AVG(vote.Score) AS AvgVoteScore
    FROM Users u
    LEFT JOIN Posts p ON p.OwnerUserId = u.Id
    LEFT JOIN Comments c ON c.UserId = u.Id
    LEFT JOIN Votes v ON v.UserId = u.Id
    GROUP BY u.Id, u.Reputation, u.CreationDate
),
PostMetrics AS (
    SELECT
        p.Id AS PostId,
        p.Title,
        p.ViewCount,
        p.Score,
        COUNT(c.Id) AS CommentCount,
        COUNT(DISTINCT v.Id) AS VoteCount
    FROM Posts p
    LEFT JOIN Comments c ON c.PostId = p.Id
    LEFT JOIN Votes v ON v.PostId = p.Id
    GROUP BY p.Id, p.Title, p.ViewCount, p.Score
)
SELECT
    um.UserId,
    um.Reputation,
    um.CreationDate,
    um.PostCount,
    um.CommentCount AS UserCommentCount,
    um.TotalBountyAmount,
    pm.PostId,
    pm.Title AS PostTitle,
    pm.ViewCount AS PostViewCount,
    pm.Score AS PostScore,
    pm.CommentCount AS PostCommentCount,
    pm.VoteCount AS PostVoteCount
FROM UserMetrics um
JOIN PostMetrics pm ON um.UserId = pm.PostId
ORDER BY um.Reputation DESC, pm.ViewCount DESC
LIMIT 100;