WITH UserStatistics AS (
    SELECT 
        U.Id AS UserId,
        U.Reputation,
        COUNT(DISTINCT P.Id) AS PostCount,
        SUM(CASE WHEN P.PostTypeId = 1 THEN 1 ELSE 0 END) AS QuestionCount,
        SUM(CASE WHEN P.PostTypeId = 2 THEN 1 ELSE 0 END) AS AnswerCount,
        SUM(V.Id IS NOT NULL) AS VoteCount
    FROM Users U
    LEFT JOIN Posts P ON U.Id = P.OwnerUserId
    LEFT JOIN Votes V ON P.Id = V.PostId
    GROUP BY U.Id, U.Reputation
),
PostStatistics AS (
    SELECT 
        P.Id AS PostId,
        P.Title,
        P.CreationDate,
        P.Score,
        P.ViewCount,
        COALESCE(AVG(C.Score), 0) AS AverageCommentScore,
        COUNT(C.Id) AS CommentCount
    FROM Posts P
    LEFT JOIN Comments C ON P.Id = C.PostId
    GROUP BY P.Id
),
BadgeStatistics AS (
    SELECT 
        B.UserId,
        COUNT(B.Id) AS BadgeCount,
        SUM(CASE WHEN B.Class = 1 THEN 1 ELSE 0 END) AS GoldBadgeCount,
        SUM(CASE WHEN B.Class = 2 THEN 1 ELSE 0 END) AS SilverBadgeCount,
        SUM(CASE WHEN B.Class = 3 THEN 1 ELSE 0 END) AS BronzeBadgeCount
    FROM Badges B
    GROUP BY B.UserId
)
SELECT 
    U.UserId,
    U.Reputation,
    U.PostCount,
    U.QuestionCount,
    U.AnswerCount,
    U.VoteCount,
    COALESCE(B.BadgeCount, 0) AS BadgeCount,
    COALESCE(B.GoldBadgeCount, 0) AS GoldBadgeCount,
    COALESCE(B.SilverBadgeCount, 0) AS SilverBadgeCount,
    COALESCE(B.BronzeBadgeCount, 0) AS BronzeBadgeCount,
    JSON_AGG(json_build_object(
        'PostId', P.PostId,
        'Title', P.Title,
        'CreationDate', P.CreationDate,
        'Score', P.Score,
        'ViewCount', P.ViewCount,
        'AverageCommentScore', P.AverageCommentScore,
        'CommentCount', P.CommentCount
    )) AS Posts
FROM UserStatistics U
LEFT JOIN BadgeStatistics B ON U.UserId = B.UserId
LEFT JOIN PostStatistics P ON U.UserId = P.OwnerUserId
GROUP BY U.UserId, U.Reputation, U.PostCount, U.QuestionCount, U.AnswerCount, U.VoteCount, B.BadgeCount, B.GoldBadgeCount, B.SilverBadgeCount, B.BronzeBadgeCount
ORDER BY U.Reputation DESC;