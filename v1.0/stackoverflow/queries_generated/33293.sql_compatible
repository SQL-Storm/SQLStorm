
WITH RecursiveCTE AS (
    SELECT 
        P.Id AS PostId,
        P.Title,
        P.CreationDate,
        P.Score,
        0 AS Level
    FROM 
        Posts P
    WHERE 
        P.PostTypeId = 1 
    UNION ALL
    SELECT 
        A.Id AS PostId,
        A.Title,
        A.CreationDate,
        A.Score,
        R.Level + 1
    FROM 
        Posts A
    INNER JOIN 
        RecursiveCTE R ON A.ParentId = R.PostId
    WHERE 
        A.PostTypeId = 2 
)
, PostVotes AS (
    SELECT 
        PostId,
        SUM(CASE WHEN VoteTypeId = 2 THEN 1 ELSE 0 END) AS UpVotes,
        SUM(CASE WHEN VoteTypeId = 3 THEN 1 ELSE 0 END) AS DownVotes
    FROM 
        Votes
    GROUP BY 
        PostId
)
, BadgeCount AS (
    SELECT 
        U.Id AS UserId,
        COUNT(DISTINCT B.Id) AS TotalBadges
    FROM 
        Users U
    LEFT JOIN 
        Badges B ON U.Id = B.UserId
    GROUP BY 
        U.Id
)
SELECT 
    R.PostId,
    R.Title,
    R.CreationDate,
    R.Score,
    COALESCE(PV.UpVotes, 0) AS UpVotes,
    COALESCE(PV.DownVotes, 0) AS DownVotes,
    BC.TotalBadges,
    R.Level
FROM 
    RecursiveCTE R
LEFT JOIN 
    PostVotes PV ON R.PostId = PV.PostId
LEFT JOIN 
    Users U ON R.OwnerUserId = U.Id
LEFT JOIN 
    BadgeCount BC ON U.Id = BC.UserId
WHERE 
    R.Score > 0 
    AND R.CreationDate >= DATEADD(week, -1, '2024-10-01') 
ORDER BY 
    R.Score DESC, 
    R.CreationDate DESC 
LIMIT 100;
