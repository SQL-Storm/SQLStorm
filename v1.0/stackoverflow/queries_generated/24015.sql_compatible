
WITH RankedPosts AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.Score,
        COUNT(c.Id) OVER (PARTITION BY p.Id) AS CommentCount,
        ROW_NUMBER() OVER (PARTITION BY p.Id ORDER BY p.CreationDate DESC) AS rn
    FROM 
        Posts p
        LEFT JOIN Comments c ON p.Id = c.PostId
    WHERE 
        p.PostTypeId IN (1, 2)
),

UserActivity AS (
    SELECT 
        u.Id AS UserId,
        COALESCE(SUM(v.BountyAmount), 0) AS TotalBountySpent,
        MAX(u.Reputation) AS MaxReputation
    FROM 
        Users u
        LEFT JOIN Votes v ON u.Id = v.UserId
    GROUP BY 
        u.Id
),

CloseReasons AS (
    SELECT 
        ph.PostId,
        STRING_AGG(DISTINCT cr.Name, ', ') AS CloseReasonNames
    FROM 
        PostHistory ph
        JOIN CloseReasonTypes cr ON CAST(ph.Comment AS INTEGER) = cr.Id 
    WHERE 
        ph.PostHistoryTypeId = 10 
    GROUP BY 
        ph.PostId
),

FinalUserMetrics AS (
    SELECT 
        u.UserId,
        u.TotalBountySpent,
        u.MaxReputation,
        COALESCE(cr.CloseReasonNames, 'None') AS CloseReasonsUsed,
        COUNT(rp.PostId) AS PostCount,
        SUM(rp.CommentCount) AS TotalComments
    FROM 
        UserActivity u
        LEFT JOIN RankedPosts rp ON u.UserId = rp.PostId
        LEFT JOIN CloseReasons cr ON rp.PostId = cr.PostId
    GROUP BY 
        u.UserId, u.TotalBountySpent, u.MaxReputation, cr.CloseReasonNames
),

ResultSet AS (
    SELECT 
        UserId,
        TotalBountySpent,
        MaxReputation,
        CloseReasonsUsed,
        PostCount,
        TotalComments,
        CASE 
            WHEN TotalComments < 5 THEN 'Low Engagement'
            WHEN TotalComments BETWEEN 5 AND 20 THEN 'Medium Engagement'
            ELSE 'High Engagement'
        END AS EngagementLevel
    FROM 
        FinalUserMetrics
    WHERE 
        TotalBountySpent > (SELECT AVG(TotalBountySpent) FROM UserActivity)
)

SELECT 
    f.UserId,
    f.TotalBountySpent,
    f.MaxReputation,
    f.CloseReasonsUsed,
    f.PostCount,
    f.TotalComments,
    f.EngagementLevel,
    COALESCE(p.Title, 'No Associated Title') AS PostTitle,
    CASE 
        WHEN f.TotalComments IS NULL THEN 'Unknown'
        ELSE 'Known'
    END AS CommentStatus
FROM 
    ResultSet f
    LEFT JOIN Posts p ON f.PostCount > 0 AND p.Id IN (SELECT PostId FROM RankedPosts WHERE rn = 1)
ORDER BY 
    f.TotalBountySpent DESC, 
    f.MaxReputation DESC;
