
WITH UserStats AS (
    SELECT 
        U.Id AS UserId,
        U.DisplayName,
        COUNT(DISTINCT P.Id) AS PostsCount,
        SUM(CASE WHEN P.PostTypeId = 2 THEN 1 ELSE 0 END) AS AnswersCount,
        SUM(P.ViewCount) AS TotalViews,
        SUM(P.Score) AS TotalScore
    FROM Users U
    LEFT JOIN Posts P ON U.Id = P.OwnerUserId
    GROUP BY U.Id, U.DisplayName
), 
TopUsers AS (
    SELECT 
        UserId,
        DisplayName,
        PostsCount,
        AnswersCount,
        TotalViews,
        TotalScore,
        RANK() OVER (ORDER BY TotalScore DESC) AS ScoreRank
    FROM UserStats
    WHERE TotalScore > 0
),
MostActiveTags AS (
    SELECT 
        T.TagName,
        COUNT(DISTINCT P.Id) AS PostsCount,
        SUM(CASE WHEN P.PostTypeId = 2 THEN 1 ELSE 0 END) AS AnswersCount
    FROM Tags T
    LEFT JOIN Posts P ON T.Id IN (SELECT unnest(string_to_array(P.Tags, '>')))
    GROUP BY T.TagName
),
TopTags AS (
    SELECT 
        TagName,
        PostsCount,
        AnswersCount,
        RANK() OVER (ORDER BY PostsCount DESC) AS PostsRank
    FROM MostActiveTags
    WHERE PostsCount > 0
)
SELECT 
    TU.DisplayName AS TopUser,
    TU.TotalScore,
    T.TagName AS ActiveTag,
    T.PostsCount AS TagPostsCount,
    T.AnswersCount AS TagAnswersCount
FROM TopUsers TU
JOIN TopTags T ON TU.PostsCount >= 50
WHERE TU.ScoreRank <= 10 AND T.PostsRank <= 5
ORDER BY TU.TotalScore DESC, T.PostsCount DESC;
