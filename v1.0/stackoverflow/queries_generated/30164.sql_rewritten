WITH UserReputation AS (
    SELECT 
        U.Id AS UserId,
        U.DisplayName,
        U.Reputation,
        U.CreationDate,
        ROW_NUMBER() OVER(PARTITION BY U.AccountId ORDER BY U.Reputation DESC) AS Rank
    FROM 
        Users U
    WHERE 
        U.Reputation > 1000
),
RecentPosts AS (
    SELECT 
        P.Id AS PostId,
        P.Title,
        P.Body,
        P.CreationDate,
        P.Score,
        P.ViewCount,
        U.DisplayName AS OwnerName,
        ROW_NUMBER() OVER(PARTITION BY P.OwnerUserId ORDER BY P.CreationDate DESC) AS PostRank
    FROM 
        Posts P
    JOIN 
        Users U ON P.OwnerUserId = U.Id
    WHERE 
        P.CreationDate >= cast('2024-10-01 12:34:56' as timestamp) - INTERVAL '30 days'
),
PostVotes AS (
    SELECT 
        V.PostId, 
        COUNT(CASE WHEN V.VoteTypeId = 2 THEN 1 END) AS UpVotes,
        COUNT(CASE WHEN V.VoteTypeId = 3 THEN 1 END) AS DownVotes,
        COUNT(*) AS TotalVotes
    FROM 
        Votes V
    GROUP BY 
        V.PostId
),
ClosedPosts AS (
    SELECT 
        PH.PostId,
        PH.CreationDate,
        PH.UserDisplayName,
        PH.Comment,
        PH.Text AS CloseReason,
        ROW_NUMBER() OVER(ORDER BY PH.CreationDate DESC) AS CloseRank
    FROM 
        PostHistory PH
    WHERE 
        PH.PostHistoryTypeId = 10
)

SELECT 
    R.UserId,
    R.DisplayName,
    R.Reputation,
    COALESCE(RP.PostRank, 0) AS RecentPostRank,
    COALESCE(RP.PostId, 0) AS RecentPostId,
    COALESCE(RP.Title, 'No Recent Post') AS RecentPostTitle,
    COALESCE(RP.ViewCount, 0) AS RecentPostViewCount,
    COALESCE(PV.UpVotes, 0) AS UpVotes,
    COALESCE(PV.DownVotes, 0) AS DownVotes,
    COALESCE(CP.CloseRank, 0) AS ClosePostRank,
    COALESCE(CP.CloseReason, 'Not Closed') AS RecentCloseReason
FROM 
    UserReputation R
LEFT JOIN 
    RecentPosts RP ON R.UserId = RP.OwnerUserId AND RP.PostRank = 1
LEFT JOIN 
    PostVotes PV ON PV.PostId = COALESCE(RP.PostId, 0)
LEFT JOIN 
    ClosedPosts CP ON CP.PostId = COALESCE(RP.PostId, 0)
WHERE 
    R.Rank <= 5
ORDER BY 
    R.Reputation DESC;