
WITH UserReputation AS (
    SELECT 
        U.Id AS UserId,
        U.DisplayName,
        U.Reputation,
        RANK() OVER (ORDER BY U.Reputation DESC) AS Rank
    FROM Users U
), 
PostSummary AS (
    SELECT 
        P.OwnerUserId,
        COUNT(P.Id) AS TotalPosts,
        SUM(CASE WHEN P.PostTypeId = 1 THEN 1 ELSE 0 END) AS Questions,
        SUM(CASE WHEN P.PostTypeId = 2 THEN 1 ELSE 0 END) AS Answers,
        SUM(P.ViewCount) AS TotalViews
    FROM Posts P
    GROUP BY P.OwnerUserId
),
ClosedPosts AS (
    SELECT 
        PH.UserId,
        COUNT(PH.Id) AS ClosedPostCount
    FROM PostHistory PH
    WHERE PH.PostHistoryTypeId = 10 
    GROUP BY PH.UserId
),
ActiveUsers AS (
    SELECT 
        U.Id,
        U.DisplayName,
        COALESCE(UP.TotalPosts, 0) AS TotalPosts,
        COALESCE(UP.Questions, 0) AS Questions,
        COALESCE(UP.Answers, 0) AS Answers,
        COALESCE(CLP.ClosedPostCount, 0) AS ClosedPostCount
    FROM Users U
    LEFT JOIN PostSummary UP ON U.Id = UP.OwnerUserId
    LEFT JOIN ClosedPosts CLP ON U.Id = CLP.UserId
)

SELECT 
    A.UserId,
    A.DisplayName,
    A.TotalPosts,
    A.Questions,
    A.Answers,
    A.ClosedPostCount,
    CASE 
        WHEN A.TotalPosts > 0 THEN ROUND((A.ClosedPostCount * 100.0) / A.TotalPosts, 2)
        ELSE 0 
    END AS ClosedPostPercentage,
    UR.Reputation,
    UR.Rank
FROM ActiveUsers A
JOIN UserReputation UR ON A.UserId = UR.UserId
ORDER BY UR.Rank
LIMIT 10;
