
WITH RecursiveTagHierarchy AS (
    SELECT 
        t.Id AS TagId,
        t.TagName,
        0 AS Depth
    FROM 
        Tags t
    WHERE 
        t.IsModeratorOnly = 0

    UNION ALL

    SELECT 
        t.Id,
        t.TagName,
        r.Depth + 1
    FROM 
        Tags t
    JOIN 
        RecursiveTagHierarchy r ON t.Id = r.TagId
), 

UserReputation AS (
    SELECT 
        u.Id AS UserId,
        u.Reputation,
        COUNT(p.Id) AS PostCount,
        SUM(CASE WHEN p.Score > 0 THEN 1 ELSE 0 END) AS PositivePosts,
        SUM(CASE WHEN p.Score < 0 THEN 1 ELSE 0 END) AS NegativePosts
    FROM 
        Users u 
    LEFT JOIN 
        Posts p ON u.Id = p.OwnerUserId
    GROUP BY 
        u.Id, u.Reputation
),

ActivePosts AS (
    SELECT 
        p.Id,
        p.Title,
        p.CreationDate,
        p.ViewCount,
        DENSE_RANK() OVER (ORDER BY p.ViewCount DESC) AS ViewRank,
        p.OwnerUserId
    FROM 
        Posts p 
    WHERE 
        p.CreationDate >= DATEADD(day, -30, CAST('2024-10-01' AS DATE))
)

SELECT 
    u.Id AS UserId,
    u.DisplayName,
    u.Reputation,
    ur.PostCount,
    ur.PositivePosts,
    ur.NegativePosts,
    p.Title,
    p.ViewCount,
    p.CreationDate,
    COALESCE(bt.Name, 'No Badge') AS TopBadge,
    COALESCE(tt.TagName, 'No Tags') AS PrimaryTag
FROM 
    Users u
JOIN 
    UserReputation ur ON u.Id = ur.UserId
LEFT JOIN 
    ActivePosts p ON u.Id = p.OwnerUserId
LEFT JOIN 
    Badges bt ON u.Id = bt.UserId AND bt.Class = 1 
LEFT JOIN 
    (SELECT 
        p.Id,
        UNNEST(SPLIT_PARTS(p.Tags, '><')) AS TagName
     FROM 
        Posts p WHERE p.Tags IS NOT NULL) AS tt ON p.Id = tt.Id
WHERE 
    ur.Reputation > 1000
    AND ur.PostCount > 5
    AND p.ViewCount IS NOT NULL
ORDER BY 
    u.Reputation DESC, p.ViewCount DESC;
