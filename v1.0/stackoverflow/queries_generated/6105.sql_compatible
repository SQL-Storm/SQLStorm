
WITH UserBadges AS (
    SELECT UserId, COUNT(*) AS BadgeCount
    FROM Badges
    GROUP BY UserId
),
UserStats AS (
    SELECT 
        U.Id AS UserId,
        U.DisplayName,
        U.Reputation,
        U.CreationDate,
        U.LastAccessDate,
        COALESCE(UB.BadgeCount, 0) AS BadgeCount,
        SUM(CASE WHEN P.PostTypeId = 1 THEN P.AnswerCount ELSE 0 END) AS QuestionCount,
        SUM(CASE WHEN P.PostTypeId = 2 THEN 1 ELSE 0 END) AS AnswerCount
    FROM Users U
    LEFT JOIN UserBadges UB ON U.Id = UB.UserId
    LEFT JOIN Posts P ON U.Id = P.OwnerUserId
    WHERE U.Reputation > 1000 
    GROUP BY U.Id, U.DisplayName, U.Reputation, U.CreationDate, U.LastAccessDate
),
TopUsers AS (
    SELECT UserId, DisplayName, Reputation, CreationDate, LastAccessDate, BadgeCount, QuestionCount, AnswerCount,
           RANK() OVER (ORDER BY Reputation DESC) AS ReputationRank,
           RANK() OVER (ORDER BY QuestionCount DESC) AS QuestionRank,
           RANK() OVER (ORDER BY AnswerCount DESC) AS AnswerRank
    FROM UserStats
)
SELECT 
    UserId,
    DisplayName,
    Reputation,
    CreationDate,
    LastAccessDate,
    BadgeCount,
    QuestionCount,
    AnswerCount,
    ReputationRank,
    QuestionRank,
    AnswerRank
FROM TopUsers
WHERE ReputationRank <= 10 OR QuestionRank <= 10 OR AnswerRank <= 10
ORDER BY Reputation DESC, QuestionCount DESC, AnswerCount DESC;
