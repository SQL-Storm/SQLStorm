
WITH RankedUsers AS (
    SELECT 
        U.Id AS UserId,
        U.DisplayName,
        U.Reputation,
        ROW_NUMBER() OVER (ORDER BY U.Reputation DESC) AS UserRank
    FROM 
        Users U
    WHERE 
        U.Reputation > 1000   
),
RecentPosts AS (
    SELECT 
        P.Id AS PostId,
        P.Title,
        P.CreationDate,
        P.ViewCount,
        P.OwnerUserId,
        P.PostTypeId,
        COUNT(C.Comment) AS CommentCount,
        SUM(CASE WHEN V.VoteTypeId = 2 THEN 1 ELSE 0 END) AS UpVotes,       
        SUM(CASE WHEN V.VoteTypeId = 3 THEN 1 ELSE 0 END) AS DownVotes      
    FROM 
        Posts P
    LEFT JOIN 
        Comments C ON P.Id = C.PostId
    LEFT JOIN 
        Votes V ON P.Id = V.PostId
    WHERE 
        P.CreationDate >= TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '30 days'   
    GROUP BY 
        P.Id, P.Title, P.CreationDate, P.ViewCount, P.OwnerUserId, P.PostTypeId
),
ClosedPostHistory AS (
    SELECT 
        PH.PostId,
        COUNT(PH.Id) AS CloseCount
    FROM 
        PostHistory PH
    WHERE 
        PH.PostHistoryTypeId = 10   
    GROUP BY 
        PH.PostId
),
FinalMetrics AS (
    SELECT 
        RP.PostId,
        RP.Title,
        RP.ViewCount,
        RP.CommentCount,
        RP.UpVotes,
        RP.DownVotes,
        COALESCE(CPH.CloseCount, 0) AS CloseCount,
        RU.DisplayName AS TopUser
    FROM 
        RecentPosts RP
    LEFT JOIN 
        ClosedPostHistory CPH ON RP.PostId = CPH.PostId
    LEFT JOIN 
        RankedUsers RU ON RP.OwnerUserId = RU.UserId
    WHERE 
        RP.ViewCount > 100  
)
SELECT 
    FM.PostId,
    FM.Title,
    FM.ViewCount,
    FM.CommentCount,
    FM.UpVotes,
    FM.DownVotes,
    FM.CloseCount,
    FM.TopUser
FROM 
    FinalMetrics FM
WHERE 
    FM.CloseCount < 2  
ORDER BY 
    FM.ViewCount DESC
LIMIT 10;
