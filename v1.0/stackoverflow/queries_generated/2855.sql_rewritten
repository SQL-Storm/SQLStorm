WITH PostScore AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        COALESCE(SUM(CASE WHEN v.VoteTypeId = 2 THEN 1 ELSE 0 END), 0) AS UpVotes,
        COALESCE(SUM(CASE WHEN v.VoteTypeId = 3 THEN 1 ELSE 0 END), 0) AS DownVotes,
        (COALESCE(SUM(CASE WHEN v.VoteTypeId = 2 THEN 1 ELSE 0 END), 0) - 
        COALESCE(SUM(CASE WHEN v.VoteTypeId = 3 THEN 1 ELSE 0 END), 0)) AS NetScore
    FROM 
        Posts p
    LEFT JOIN
        Votes v ON p.Id = v.PostId
    WHERE 
        p.CreationDate >= cast('2024-10-01 12:34:56' as timestamp) - INTERVAL '1 year'
    GROUP BY 
        p.Id, p.Title
), MostVotedPosts AS (
    SELECT 
        ps.PostId,
        ps.Title,
        ps.NetScore,
        ROW_NUMBER() OVER (ORDER BY ps.NetScore DESC) as Rank
    FROM 
        PostScore ps
    WHERE 
        ps.NetScore > 0
), PopularTags AS (
    SELECT 
        t.TagName,
        COUNT(pt.PostId) AS TagCount
    FROM 
        Tags t
    JOIN 
        Posts p ON p.Tags ILIKE '%' || t.TagName || '%'
    LEFT JOIN 
        PostLinks pl ON p.Id = pl.PostId
    GROUP BY 
        t.TagName
    ORDER BY 
        TagCount DESC
    LIMIT 5
), RecentHistory AS (
    SELECT 
        ph.PostId,
        ph.UserId,
        ph.CreationDate,
        p.Title,
        p.Body,
        MIN(ph.CreationDate) OVER (PARTITION BY ph.PostId) AS FirstEdit,
        MAX(ph.CreationDate) OVER (PARTITION BY ph.PostId) AS LastEdit
    FROM 
        PostHistory ph
    JOIN 
        Posts p ON ph.PostId = p.Id
    WHERE 
        ph.CreationDate >= cast('2024-10-01 12:34:56' as timestamp) - INTERVAL '6 months'
)
SELECT 
    mvp.Title,
    mvp.NetScore,
    rt.TagName,
    COUNT(rh.PostId) AS EditCount,
    AVG(EXTRACT(EPOCH FROM (rh.LastEdit - rh.FirstEdit))) AS AvgEditDuration
FROM 
    MostVotedPosts mvp
JOIN 
    RecentHistory rh ON mvp.PostId = rh.PostId
JOIN 
    PopularTags rt ON rt.TagName = ANY(string_to_array(mvp.Title, ' '))
GROUP BY 
    mvp.Title, mvp.NetScore, rt.TagName
HAVING 
    COUNT(rh.PostId) > 1
ORDER BY 
    mvp.NetScore DESC, COUNT(rh.PostId) DESC;