
WITH RankedPosts AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.CreationDate,
        p.Score,
        p.ViewCount,
        ROW_NUMBER() OVER (PARTITION BY p.OwnerUserId ORDER BY p.CreationDate DESC) AS rn
    FROM 
        Posts p
    WHERE 
        p.CreationDate >= TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '1 year'
),

RecentUserVotes AS (
    SELECT 
        v.UserId,
        COUNT(CASE WHEN v.VoteTypeId = 2 THEN 1 END) AS UpVotes,
        COUNT(CASE WHEN v.VoteTypeId = 3 THEN 1 END) AS DownVotes
    FROM 
        Votes v
    WHERE 
        v.CreationDate >= TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '6 months'
    GROUP BY 
        v.UserId
),

PostHistoryAnalysis AS (
    SELECT 
        ph.PostId,
        COUNT(*) FILTER (WHERE ph.PostHistoryTypeId IN (10, 11)) AS CloseReopenCount,
        COUNT(*) FILTER (WHERE ph.PostHistoryTypeId IN (12, 13)) AS DeleteUndeleteCount
    FROM 
        PostHistory ph
    WHERE 
        ph.CreationDate >= TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '2 years'
    GROUP BY 
        ph.PostId
),

PostComments AS (
    SELECT 
        c.PostId,
        COUNT(c.Id) AS CommentCount,
        MIN(c.CreationDate) AS FirstCommentDate
    FROM 
        Comments c
    GROUP BY 
        c.PostId
),

FinalAnalysis AS (
    SELECT 
        rp.PostId,
        rp.Title,
        rp.CreationDate,
        COALESCE(pc.CommentCount, 0) AS TotalComments,
        COALESCE(ruv.UpVotes, 0) AS UserUpVotes,
        COALESCE(ruv.DownVotes, 0) AS UserDownVotes,
        COALESCE(ph.CloseReopenCount, 0) AS CloseReopenModification,
        COALESCE(ph.DeleteUndeleteCount, 0) AS DeleteUndeleteModification
    FROM 
        RankedPosts rp
    LEFT JOIN 
        RecentUserVotes ruv ON ruv.UserId = rp.OwnerUserId
    LEFT JOIN 
        PostHistoryAnalysis ph ON ph.PostId = rp.PostId
    LEFT JOIN 
        PostComments pc ON pc.PostId = rp.PostId
    WHERE 
        rp.rn = 1
)

SELECT 
    fa.PostId,
    fa.Title,
    fa.CreationDate,
    fa.TotalComments,
    fa.UserUpVotes,
    fa.UserDownVotes,
    fa.CloseReopenModification,
    fa.DeleteUndeleteModification,
    CASE 
        WHEN fa.CloseReopenModification > 0 THEN 'Modified'
        ELSE 'Stable'
    END AS ModificationStatus,
    CASE 
        WHEN fa.UserUpVotes > fa.UserDownVotes THEN 'Positive Feedback'
        WHEN fa.UserUpVotes < fa.UserDownVotes THEN 'Negative Feedback'
        ELSE 'Neutral Feedback'
    END AS FeedbackStatus
FROM 
    FinalAnalysis fa
ORDER BY 
    fa.CreationDate DESC
LIMIT 100;
