
WITH RankedPosts AS (
    SELECT 
        p.Id,
        p.Title,
        u.DisplayName AS OwnerDisplayName,
        p.CreationDate,
        p.ViewCount,
        RANK() OVER (PARTITION BY p.PostTypeId ORDER BY p.Score DESC) AS RankScore
    FROM Posts p
    JOIN Users u ON p.OwnerUserId = u.Id
    WHERE p.CreationDate >= DATEADD(YEAR, -1, CAST('2024-10-01' AS DATE))
),
ClosedPosts AS (
    SELECT 
        ph.PostId,
        ph.CreationDate AS ClosedDate,
        cr.Name AS CloseReason
    FROM PostHistory ph
    JOIN CloseReasonTypes cr ON CAST(ph.Comment AS INTEGER) = cr.Id
    WHERE ph.PostHistoryTypeId = 10
),
PostSummary AS (
    SELECT 
        rp.Id,
        rp.Title,
        rp.OwnerDisplayName,
        rp.CreationDate,
        COALESCE(cp.ClosedDate, 'No Closure') AS ClosedDate,
        COALESCE(cp.CloseReason, 'N/A') AS CloseReason,
        rp.ViewCount,
        rp.RankScore
    FROM RankedPosts rp
    LEFT JOIN ClosedPosts cp ON rp.Id = cp.PostId
)
SELECT 
    ps.*,
    CASE 
        WHEN ps.ClosedDate != 'No Closure' THEN 'Closed'
        WHEN ps.RankScore <= 5 THEN 'Top Performers'
        ELSE 'Others' 
    END AS PostCategory
FROM PostSummary ps
WHERE ps.RankScore <= 10
AND ps.ViewCount > 100
ORDER BY ps.CreationDate DESC, ps.RankScore ASC
LIMIT 50;
