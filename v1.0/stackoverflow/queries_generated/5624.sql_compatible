
WITH UserActivity AS (
    SELECT 
        u.Id AS UserId,
        u.DisplayName,
        u.Reputation,
        COUNT(DISTINCT p.Id) AS PostCount,
        SUM(CASE WHEN p.Score > 0 THEN 1 ELSE 0 END) AS PositivePosts,
        SUM(CASE WHEN p.Score < 0 THEN 1 ELSE 0 END) AS NegativePosts,
        AVG(COALESCE(uc.Views, 0)) AS AverageViews,
        SUM(COALESCE(uc.UpVotes, 0)) AS TotalUpVotes,
        SUM(COALESCE(uc.DownVotes, 0)) AS TotalDownVotes
    FROM 
        Users u
    LEFT JOIN 
        Posts p ON u.Id = p.OwnerUserId
    LEFT JOIN 
        (
            SELECT 
                PostId,
                SUM(ViewCount) AS Views,
                SUM(UpVotes) AS UpVotes,
                SUM(DownVotes) AS DownVotes
            FROM 
                Posts
            GROUP BY 
                PostId
        ) AS uc ON p.Id = uc.PostId
    WHERE 
        u.Reputation > 0
    GROUP BY 
        u.Id, u.DisplayName, u.Reputation
),
TopUsers AS (
    SELECT 
        UserId,
        DisplayName,
        Reputation,
        PostCount,
        PositivePosts,
        NegativePosts,
        AverageViews,
        TotalUpVotes,
        TotalDownVotes,
        ROW_NUMBER() OVER (ORDER BY Reputation DESC, PostCount DESC) AS Rank
    FROM 
        UserActivity
)
SELECT 
    tu.DisplayName,
    tu.Reputation,
    tu.PostCount,
    tu.PositivePosts,
    tu.NegativePosts,
    tu.AverageViews,
    tu.TotalUpVotes,
    tu.TotalDownVotes
FROM 
    TopUsers tu
WHERE 
    tu.Rank <= 10
ORDER BY 
    tu.Rank;
