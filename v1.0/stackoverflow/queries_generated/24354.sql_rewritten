WITH UserRep AS (
    SELECT 
        u.Id AS UserId,
        u.Reputation,
        u.DisplayName,
        u.CreationDate,
        ROW_NUMBER() OVER (ORDER BY u.Reputation DESC) AS Rank
    FROM Users u
), 
PostStats AS (
    SELECT 
        p.OwnerUserId,
        COUNT(DISTINCT p.Id) AS PostCount,
        SUM(CASE WHEN p.PostTypeId = 1 THEN 1 ELSE 0 END) AS QuestionCount,
        SUM(CASE WHEN p.PostTypeId = 2 THEN 1 ELSE 0 END) AS AnswerCount,
        MAX(p.CreationDate) AS LastPostDate
    FROM Posts p
    GROUP BY p.OwnerUserId
),
ClosedPosts AS (
    SELECT 
        ph.UserId,
        ph.PostId,
        p.Title,
        ph.CreationDate AS CloseDate,
        cr.Name AS CloseReason
    FROM PostHistory ph
    JOIN CloseReasonTypes cr ON ph.Comment::int = cr.Id
    JOIN Posts p ON ph.PostId = p.Id
    WHERE ph.PostHistoryTypeId = 10
),
RecentActivity AS (
    SELECT 
        p.OwnerUserId,
        MAX(p.LastActivityDate) AS LastActivity
    FROM Posts p
    GROUP BY p.OwnerUserId
),
UserBadges AS (
    SELECT 
        b.UserId,
        COUNT(CASE WHEN b.Class = 1 THEN 1 END) AS GoldBadges,
        COUNT(CASE WHEN b.Class = 2 THEN 1 END) AS SilverBadges,
        COUNT(CASE WHEN b.Class = 3 THEN 1 END) AS BronzeBadges
    FROM Badges b
    GROUP BY b.UserId
)
SELECT 
    ur.UserId,
    ur.DisplayName,
    ur.Reputation,
    COALESCE(ps.PostCount, 0) AS TotalPosts,
    COALESCE(ps.QuestionCount, 0) AS TotalQuestions,
    COALESCE(ps.AnswerCount, 0) AS TotalAnswers,
    ua.LastActivity,
    COALESCE(ub.GoldBadges, 0) AS GoldBadges,
    COALESCE(ub.SilverBadges, 0) AS SilverBadges,
    COALESCE(ub.BronzeBadges, 0) AS BronzeBadges,
    COUNT(DISTINCT cp.PostId) AS ClosedPostsCount,
    STRING_AGG(DISTINCT cp.Title || ' (' || cp.CloseReason || ')', '; ') AS ClosedPostTitles
FROM UserRep ur
LEFT JOIN PostStats ps ON ur.UserId = ps.OwnerUserId
LEFT JOIN RecentActivity ua ON ur.UserId = ua.OwnerUserId
LEFT JOIN UserBadges ub ON ur.UserId = ub.UserId
LEFT JOIN ClosedPosts cp ON ur.UserId = cp.UserId
WHERE ur.Reputation IS NOT NULL
GROUP BY ur.UserId, ur.DisplayName, ur.Reputation, ua.LastActivity, ub.GoldBadges, ub.SilverBadges, ub.BronzeBadges
ORDER BY ur.Reputation DESC
LIMIT 100;