WITH UserBadges AS (
    SELECT 
        u.Id AS UserId,
        u.DisplayName,
        COUNT(b.Id) AS TotalBadges,
        SUM(CASE WHEN b.Class = 1 THEN 1 ELSE 0 END) AS GoldBadges,
        SUM(CASE WHEN b.Class = 2 THEN 1 ELSE 0 END) AS SilverBadges,
        SUM(CASE WHEN b.Class = 3 THEN 1 ELSE 0 END) AS BronzeBadges
    FROM 
        Users u
    LEFT JOIN 
        Badges b ON u.Id = b.UserId
    GROUP BY 
        u.Id
),
QuestionStatistics AS (
    SELECT 
        p.OwnerUserId,
        COUNT(p.Id) AS QuestionsAsked,
        AVG(COALESCE(p.Score, 0)) AS AverageScore,
        SUM(p.ViewCount) AS TotalViews,
        SUM(CASE WHEN p.AcceptedAnswerId IS NOT NULL THEN 1 ELSE 0 END) AS AcceptedAnswers
    FROM 
        Posts p
    WHERE 
        p.PostTypeId = 1
    GROUP BY 
        p.OwnerUserId
),
UserScores AS (
    SELECT 
        ub.UserId,
        ub.DisplayName,
        ub.TotalBadges,
        qs.QuestionsAsked,
        qs.AverageScore,
        qs.TotalViews,
        qs.AcceptedAnswers
    FROM 
        UserBadges ub
    LEFT JOIN 
        QuestionStatistics qs ON ub.UserId = qs.OwnerUserId
)
SELECT 
    u.UserId,
    u.DisplayName,
    COALESCE(u.TotalBadges, 0) AS TotalBadges,
    COALESCE(u.QuestionsAsked, 0) AS QuestionsAsked,
    COALESCE(u.AverageScore, -1) AS AverageScore,
    COALESCE(u.TotalViews, 0) AS TotalViews,
    COALESCE(u.AcceptedAnswers, 0) AS AcceptedAnswers,
    CASE 
        WHEN u.TotalBadges IS NULL THEN 'No Badges'
        WHEN u.TotalBadges > 3 THEN 'Badge Enthusiast'
        ELSE 'Novice Badge Holder'
    END AS BadgeCategory,
    (SELECT 
        STRING_AGG(DISTINCT p.Title, ', ' ORDER BY p.CreationDate DESC)
     FROM 
        Posts p 
     WHERE 
        p.OwnerUserId = u.UserId AND p.PostTypeId = 1) AS RecentQuestions
FROM 
    UserScores u
ORDER BY 
    u.TotalBadges DESC,
    u.AverageScore DESC
LIMIT 10;