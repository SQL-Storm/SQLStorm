
WITH UserReputation AS (
    SELECT 
        Id AS UserId,
        Reputation,
        CASE 
            WHEN Reputation IS NULL THEN 'Unknown'
            WHEN Reputation < 100 THEN 'Low' 
            WHEN Reputation BETWEEN 100 AND 500 THEN 'Medium' 
            ELSE 'High' 
        END AS ReputationCategory 
    FROM Users
), 
PostStatistics AS (
    SELECT 
        p.Id AS PostId,
        p.OwnerUserId,
        COUNT(c.Id) AS CommentCount,
        COUNT(v.Id) FILTER (WHERE v.VoteTypeId = 2) AS UpvoteCount,
        COUNT(v.Id) FILTER (WHERE v.VoteTypeId = 3) AS DownvoteCount,
        MAX(ph.CreationDate) AS LastPostHistoryDate,
        COUNT(DISTINCT ph.Id) AS EditCount
    FROM Posts p
    LEFT JOIN Comments c ON p.Id = c.PostId
    LEFT JOIN Votes v ON p.Id = v.PostId
    LEFT JOIN PostHistory ph ON p.Id = ph.PostId
    GROUP BY p.Id, p.OwnerUserId
),
UserPostDetails AS (
    SELECT 
        u.DisplayName,
        ur.UserId,
        ps.PostId,
        ps.CommentCount,
        ps.UpvoteCount,
        ps.DownvoteCount,
        ur.ReputationCategory
    FROM UserReputation ur
    JOIN PostStatistics ps ON ur.UserId = ps.OwnerUserId
    JOIN Users u ON ps.OwnerUserId = u.Id
),
TopUsers AS (
    SELECT 
        UserId, 
        COUNT(PostId) AS PostCount 
    FROM UserPostDetails 
    GROUP BY UserId
), 
UserRankings AS (
    SELECT 
        UserId, 
        DENSE_RANK() OVER (ORDER BY COUNT(PostId) DESC) AS UserRank 
    FROM TopUsers 
    WHERE PostCount > 0
)
SELECT 
    ud.DisplayName,
    ur.Reputation,
    ur.ReputationCategory,
    ps.PostId,
    ps.CommentCount,
    ps.UpvoteCount,
    ps.DownvoteCount,
    RANK() OVER (PARTITION BY ur.ReputationCategory ORDER BY ps.UpvoteCount DESC) AS UpvoteRank,
    ps.LastPostHistoryDate,
    COALESCE(ph.Comment, 'No Edit History') AS LastEditComment
FROM UserPostDetails ud
JOIN UserReputation ur ON ud.UserId = ur.UserId
LEFT JOIN PostHistory ph ON ud.PostId = ph.PostId
LEFT JOIN UserRankings urk ON ud.UserId = urk.UserId
WHERE ur.Reputation > 0
AND (ud.UpvoteCount - ud.DownvoteCount) > 5
ORDER BY ur.Reputation DESC, ud.UpvoteCount DESC
LIMIT 10;
