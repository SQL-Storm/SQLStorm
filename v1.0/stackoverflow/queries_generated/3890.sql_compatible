
WITH UserActivity AS (
    SELECT 
        u.Id AS UserId,
        u.DisplayName,
        COUNT(DISTINCT p.Id) AS PostCount,
        SUM(COALESCE(v.UpVotes, 0)) - SUM(COALESCE(v.DownVotes, 0)) AS Score,
        RANK() OVER (ORDER BY COUNT(DISTINCT p.Id) DESC) AS ActivityRank
    FROM Users u
    LEFT JOIN Posts p ON u.Id = p.OwnerUserId
    LEFT JOIN Votes v ON p.Id = v.PostId
    WHERE u.Reputation > 1000
    GROUP BY u.Id, u.DisplayName
),
TopUsers AS (
    SELECT 
        UserId,
        DisplayName,
        PostCount,
        Score
    FROM UserActivity
    WHERE ActivityRank <= 10
),
RecentActivity AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.CreationDate,
        p.OwnerUserId,
        u.DisplayName AS OwnerDisplayName,
        (SELECT COUNT(*) FROM Comments c WHERE c.PostId = p.Id) AS CommentCount
    FROM Posts p
    JOIN Users u ON p.OwnerUserId = u.Id
    WHERE p.CreationDate >= TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '30 days'
)
SELECT 
    tu.DisplayName AS TopUser,
    tu.PostCount,
    tu.Score,
    ra.PostId,
    ra.Title,
    ra.CreationDate,
    ra.OwnerDisplayName,
    ra.CommentCount
FROM TopUsers tu
FULL OUTER JOIN RecentActivity ra ON tu.UserId = ra.OwnerUserId
ORDER BY tu.Score DESC, ra.CreationDate DESC;
