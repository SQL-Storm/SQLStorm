WITH UserActivity AS (
    SELECT 
        u.Id AS UserId,
        u.DisplayName,
        COUNT(DISTINCT p.Id) AS PostCount,
        SUM(CASE WHEN v.VoteTypeId = 2 THEN 1 ELSE 0 END) AS UpVotes,
        SUM(CASE WHEN v.VoteTypeId = 3 THEN 1 ELSE 0 END) AS DownVotes,
        SUM(p.ViewCount) AS TotalViews,
        RANK() OVER (ORDER BY COUNT(DISTINCT p.Id) DESC) AS ActivityRank
    FROM 
        Users u
    LEFT JOIN 
        Posts p ON u.Id = p.OwnerUserId
    LEFT JOIN 
        Votes v ON p.Id = v.PostId
    WHERE 
        u.Reputation > 1000
    GROUP BY 
        u.Id, u.DisplayName
),
RecentPostStats AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.CreationDate,
        COALESCE(SUM(CASE WHEN v.VoteTypeId = 2 THEN 1 ELSE 0 END), 0) AS UpVotes,
        COALESCE(SUM(CASE WHEN v.VoteTypeId = 3 THEN 1 ELSE 0 END), 0) AS DownVotes,
        ROW_NUMBER() OVER (ORDER BY p.CreationDate DESC) AS RecentRank
    FROM 
        Posts p
    LEFT JOIN 
        Votes v ON p.Id = v.PostId
    WHERE 
        p.CreationDate >= cast('2024-10-01 12:34:56' as timestamp) - INTERVAL '1 month'
    GROUP BY 
        p.Id, p.Title, p.CreationDate
    HAVING 
        COALESCE(SUM(v.VoteTypeId), 0) > 0
),
TagStatistics AS (
    SELECT 
        t.TagName,
        COUNT(DISTINCT p.Id) AS PostCount,
        SUM(p.ViewCount) AS TotalViews,
        MAX(p.CreationDate) AS LastPostDate
    FROM 
        Tags t
    JOIN 
        Posts p ON POSITION(t.TagName IN p.Tags) > 0
    GROUP BY 
        t.TagName
),
CombinedStats AS (
    SELECT 
        ua.UserId,
        ua.DisplayName,
        ua.PostCount,
        ua.UpVotes AS UserUpVotes,
        ua.DownVotes AS UserDownVotes,
        rp.PostId,
        rp.Title,
        rp.CreationDate AS PostCreationDate,
        rp.UpVotes AS PostUpVotes,
        rp.DownVotes AS PostDownVotes,
        ts.TagName,
        ts.PostCount AS TagPostCount,
        ts.TotalViews AS TagTotalViews,
        ts.LastPostDate
    FROM 
        UserActivity ua
    FULL OUTER JOIN 
        RecentPostStats rp ON ua.ActivityRank <= 10
    FULL OUTER JOIN 
        TagStatistics ts ON ts.PostCount > 0
    WHERE 
        ua.PostCount IS NOT NULL OR rp.PostId IS NOT NULL
)
SELECT 
    UserId,
    DisplayName,
    PostCount,
    UserUpVotes,
    UserDownVotes,
    PostId,
    Title,
    PostCreationDate,
    PostUpVotes,
    PostDownVotes,
    TagName,
    TagPostCount,
    TagTotalViews,
    LastPostDate
FROM 
    CombinedStats
WHERE 
    (PostCreationDate IS NOT NULL AND UserPostCount > 1) 
    OR 
    (TagTotalViews IS NOT NULL AND TagPostCount > 5)
ORDER BY 
    UserId, PostCreationDate DESC, LastPostDate DESC;