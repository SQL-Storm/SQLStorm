
WITH TagStatistics AS (
    SELECT 
        t.TagName,
        COUNT(p.Id) AS PostCount,
        SUM(p.ViewCount) AS TotalViews,
        AVG(u.Reputation) AS AvgUserReputation,
        STRING_AGG(DISTINCT u.DisplayName, ', ') AS TopContributors
    FROM Tags t
    LEFT JOIN Posts p ON p.Tags ILIKE '%' || t.TagName || '%'
    LEFT JOIN Users u ON p.OwnerUserId = u.Id
    WHERE p.PostTypeId = 1 
    GROUP BY t.TagName
),

ClosedPosts AS (
    SELECT 
        ph.PostId,
        ph.CreationDate,
        ph.UserId,
        p.Title,
        pt.Name AS PostType,
        STRING_AGG(DISTINCT cr.Name, ', ') AS CloseReasons
    FROM PostHistory ph
    JOIN Posts p ON ph.PostId = p.Id
    JOIN PostHistoryTypes pht ON ph.PostHistoryTypeId = pht.Id
    JOIN CloseReasonTypes cr ON ph.Comment::integer = cr.Id
    JOIN PostTypes pt ON p.PostTypeId = pt.Id
    WHERE pht.Name = 'Post Closed'
    GROUP BY ph.PostId, ph.CreationDate, ph.UserId, p.Title, pt.Name
),

UserActivity AS (
    SELECT 
        u.Id AS UserId,
        u.DisplayName,
        COUNT(p.Id) AS PostsCreated,
        COUNT(c.Id) AS CommentsMade,
        SUM(v.BountyAmount) AS TotalBountyEarned
    FROM Users u
    LEFT JOIN Posts p ON p.OwnerUserId = u.Id
    LEFT JOIN Comments c ON c.UserId = u.Id
    LEFT JOIN Votes v ON v.UserId = u.Id
    GROUP BY u.Id, u.DisplayName
)

SELECT 
    ts.TagName,
    ts.PostCount,
    ts.TotalViews,
    ts.AvgUserReputation,
    ts.TopContributors,
    cp.Title AS ClosedPostTitle,
    cp.CreationDate AS PostClosedDate,
    cp.CloseReasons,
    ua.DisplayName AS UserName,
    ua.PostsCreated,
    ua.CommentsMade,
    ua.TotalBountyEarned
FROM TagStatistics ts
LEFT JOIN ClosedPosts cp ON ts.TagName = ANY(STRING_TO_ARRAY(cp.Title, ' '))
LEFT JOIN UserActivity ua ON cp.UserId = ua.UserId
ORDER BY ts.PostCount DESC, ts.TotalViews DESC;
