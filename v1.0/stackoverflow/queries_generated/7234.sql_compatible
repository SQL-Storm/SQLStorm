
WITH UserStats AS (
    SELECT 
        U.Id AS UserId,
        U.DisplayName,
        U.Reputation,
        COALESCE(B.BadgeCount, 0) AS BadgeCount,
        COUNT(DISTINCT P.Id) AS PostCount,
        SUM(CASE WHEN P.PostTypeId = 1 THEN 1 ELSE 0 END) AS QuestionCount,
        SUM(CASE WHEN P.PostTypeId = 2 THEN 1 ELSE 0 END) AS AnswerCount
    FROM 
        Users U
    LEFT JOIN 
        (SELECT UserId, COUNT(*) AS BadgeCount 
         FROM Badges 
         GROUP BY UserId) B ON U.Id = B.UserId
    LEFT JOIN 
        Posts P ON U.Id = P.OwnerUserId
    WHERE 
        U.Reputation > 100
    GROUP BY 
        U.Id, U.DisplayName, U.Reputation
),

PostStats AS (
    SELECT 
        P.Id AS PostId,
        P.Title,
        P.CreationDate,
        P.LastActivityDate,
        P.Score,
        P.ViewCount,
        U.DisplayName AS OwnerDisplayName,
        COUNT(C.ID) AS CommentCount,
        (SELECT COUNT(*) FROM Votes V WHERE V.PostId = P.Id AND V.VoteTypeId = 2) AS UpVoteCount,
        (SELECT COUNT(*) FROM Votes V WHERE V.PostId = P.Id AND V.VoteTypeId = 3) AS DownVoteCount
    FROM 
        Posts P
    JOIN 
        Users U ON P.OwnerUserId = U.Id
    LEFT JOIN 
        Comments C ON P.Id = C.PostId
    WHERE 
        P.CreationDate >= TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '1 year'
    GROUP BY 
        P.Id, P.Title, P.CreationDate, P.LastActivityDate, P.Score, P.ViewCount, U.DisplayName
),

FinalStats AS (
    SELECT 
        US.UserId,
        US.DisplayName,
        US.Reputation,
        US.BadgeCount,
        US.PostCount,
        US.QuestionCount,
        US.AnswerCount,
        PS.PostId,
        PS.Title,
        PS.CreationDate AS PostCreationDate,
        PS.LastActivityDate AS PostLastActivityDate,
        PS.Score AS PostScore,
        PS.ViewCount AS PostViewCount,
        PS.CommentCount,
        PS.UpVoteCount,
        PS.DownVoteCount
    FROM 
        UserStats US
    JOIN 
        PostStats PS ON US.UserId = PS.OwnerDisplayName
    ORDER BY 
        US.Reputation DESC, PS.Score DESC
)

SELECT 
    * 
FROM 
    FinalStats
LIMIT 100;
