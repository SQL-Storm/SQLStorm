
WITH RecursiveTagTree AS (
    SELECT 
        Id,
        TagName,
        Count,
        ExcerptPostId,
        WikiPostId,
        IsModeratorOnly,
        IsRequired,
        1 AS Level
    FROM Tags
    WHERE IsModeratorOnly = 0  
    UNION ALL
    SELECT 
        t.Id,
        t.TagName,
        t.Count,
        t.ExcerptPostId,
        t.WikiPostId,
        t.IsModeratorOnly,
        t.IsRequired,
        rt.Level + 1
    FROM Tags t
    INNER JOIN RecursiveTagTree rt ON rt.Id = t.WikiPostId
),
VoteSummary AS (
    SELECT
        PostId,
        COUNT(CASE WHEN VoteTypeId = 2 THEN 1 END) AS Upvotes,
        COUNT(CASE WHEN VoteTypeId = 3 THEN 1 END) AS Downvotes,
        COUNT(*) AS TotalVotes
    FROM Votes
    GROUP BY PostId
),
LatestPosts AS (
    SELECT 
        p.*,
        ROW_NUMBER() OVER (PARTITION BY p.OwnerUserId ORDER BY p.LastActivityDate DESC) AS rn
    FROM Posts p
    WHERE p.CreationDate >= (CAST('2024-10-01 12:34:56' AS TIMESTAMP) - INTERVAL '1 YEAR')  
),
PostCloseReasons AS (
    SELECT
        ph.PostId,
        MAX(ph.CreationDate) AS LastClosedDate,
        STRING_AGG(cr.Name, ', ') AS CloseReasons
    FROM PostHistory ph
    JOIN CloseReasonTypes cr ON CAST(ph.Comment AS INTEGER) = cr.Id
    WHERE ph.PostHistoryTypeId = 10  
    GROUP BY ph.PostId
)
SELECT 
    u.DisplayName AS UserName,
    u.Reputation,
    lp.Title,
    lp.Score,
    COALESCE(vs.Upvotes, 0) AS Upvotes,
    COALESCE(vs.Downvotes, 0) AS Downvotes,
    ppt.CloseReasons,
    rt.TagName,
    rt.Level,
    lp.CreationDate,
    lp.LastActivityDate
FROM LatestPosts lp
JOIN Users u ON lp.OwnerUserId = u.Id
LEFT JOIN VoteSummary vs ON lp.Id = vs.PostId
LEFT JOIN PostCloseReasons ppt ON lp.Id = ppt.PostId
LEFT JOIN RecursiveTagTree rt ON rt.Id = CAST(lp.Tags AS INTEGER)  
WHERE lp.Score > 10  
  AND (ppt.LastClosedDate IS NULL OR ppt.LastClosedDate < lp.LastActivityDate)  
ORDER BY lp.LastActivityDate DESC
LIMIT 100;
