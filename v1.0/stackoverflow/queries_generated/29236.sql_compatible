
WITH RankedPosts AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.Body,
        p.Tags,
        p.CreationDate,
        p.ViewCount,
        u.DisplayName AS OwnerDisplayName,
        COUNT(DISTINCT c.Id) AS CommentCount,
        COUNT(DISTINCT a.Id) AS AnswerCount,
        pt.Name AS PostType,
        ROW_NUMBER() OVER (PARTITION BY pt.Id ORDER BY p.ViewCount DESC) AS Rank
    FROM 
        Posts p
    JOIN 
        Users u ON p.OwnerUserId = u.Id 
    LEFT JOIN 
        Comments c ON p.Id = c.PostId 
    LEFT JOIN 
        Posts a ON p.Id = a.ParentId 
    JOIN 
        PostTypes pt ON p.PostTypeId = pt.Id
    WHERE 
        p.CreationDate >= DATE_SUB(CURRENT_DATE, INTERVAL 1 YEAR)
    GROUP BY 
        p.Id, p.Title, p.Body, p.Tags, p.CreationDate, p.ViewCount, u.DisplayName, pt.Name
),
PopularTags AS (
    SELECT 
        unnest(string_to_array(Tags, ',')) AS Tag,
        COUNT(*) AS TagCount 
    FROM 
        Posts 
    WHERE 
        CreationDate >= DATE_SUB(CURRENT_DATE, INTERVAL 1 YEAR)
    GROUP BY 
        Tag
    HAVING 
        COUNT(*) > 10
),
PostHistoryDetails AS (
    SELECT 
        ph.PostId,
        ph.CreationDate AS HistoryDate,
        p.Title AS PostTitle,
        p.Body AS PostBody,
        p.UserDisplayName AS EditorName,
        pht.Name AS HistoryType
    FROM 
        PostHistory ph
    JOIN 
        Posts p ON ph.PostId = p.Id
    JOIN 
        PostHistoryTypes pht ON ph.PostHistoryTypeId = pht.Id
    WHERE 
        ph.CreationDate >= DATE_SUB(CURRENT_DATE, INTERVAL 1 YEAR)
)
SELECT 
    rp.PostId,
    rp.Title,
    rp.OwnerDisplayName,
    rp.PostType,
    rp.ViewCount,
    rp.CommentCount,
    rp.AnswerCount,
    STRING_AGG(DISTINCT pt.Tag, ', ') AS PopularTags,
    STRING_AGG(DISTINCT CONCAT(ph.EditorName, ' - ', ph.HistoryType, ' on ', to_char(ph.HistoryDate, 'YYYY-MM-DD HH24:MI:SS')), '; ') AS EditHistory
FROM 
    RankedPosts rp
LEFT JOIN 
    PopularTags pt ON POSITION(pt.Tag IN rp.Tags) > 0
LEFT JOIN 
    PostHistoryDetails ph ON ph.PostId = rp.PostId
WHERE 
    rp.Rank <= 10
GROUP BY 
    rp.PostId, rp.Title, rp.OwnerDisplayName, rp.PostType, rp.ViewCount, rp.CommentCount, rp.AnswerCount
ORDER BY 
    rp.ViewCount DESC;
