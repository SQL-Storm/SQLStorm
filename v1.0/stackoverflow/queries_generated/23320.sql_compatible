
WITH RankedPosts AS (
    SELECT 
        P.Id AS PostId,
        P.Title,
        P.ViewCount,
        P.CreationDate,
        P.Score,
        ROW_NUMBER() OVER (PARTITION BY P.PostTypeId ORDER BY P.CreationDate DESC) AS Rank,
        COUNT(CASE WHEN V.VoteTypeId = 2 THEN 1 END) OVER (PARTITION BY P.Id) AS UpVoteCount,
        COUNT(CASE WHEN V.VoteTypeId = 3 THEN 1 END) OVER (PARTITION BY P.Id) AS DownVoteCount
    FROM 
        Posts P
    LEFT JOIN 
        Votes V ON P.Id = V.PostId
    WHERE 
        P.CreationDate >= DATE('2024-10-01') - INTERVAL '30 days' 
        AND P.Score IS NOT NULL
),
FilteredPosts AS (
    SELECT 
        RP.PostId,
        RP.Title,
        RP.ViewCount,
        RP.CreationDate,
        RP.Score,
        RP.Rank,
        RP.UpVoteCount,
        RP.DownVoteCount,
        (CASE WHEN RP.ViewCount IS NULL THEN 0 ELSE RP.ViewCount END) / 
        NULLIF((RP.UpVoteCount + RP.DownVoteCount), 0) AS EngagementRatio
    FROM 
        RankedPosts RP
    WHERE 
        RP.Rank <= 10 
),
PostsWithTags AS (
    SELECT 
        FP.*,
        STRING_AGG(T.TagName, ', ') AS Tags
    FROM 
        FilteredPosts FP
    LEFT JOIN 
        JSONB_ARRAY_ELEMENTS_TEXT(SUBSTRING(FP.Tags FROM 2 FOR (LENGTH(FP.Tags) - 2))) AS T(TagName) ON TRUE
    GROUP BY 
        FP.PostId, FP.Title, FP.ViewCount, FP.CreationDate, FP.Score, FP.Rank, FP.UpVoteCount, FP.DownVoteCount
),
PostHistoryData AS (
    SELECT 
        PH.PostId,
        JSON_AGG(PH.Comment) FILTER (WHERE PH.PostHistoryTypeId IN (10, 11)) AS CloseReasonComments
    FROM 
        PostHistory PH
    WHERE 
        PH.CreationDate >= DATE('2024-10-01') - INTERVAL '6 months'
    GROUP BY 
        PH.PostId
)
SELECT 
    PWT.PostId,
    PWT.Title,
    PWT.ViewCount,
    PWT.CreationDate,
    PWT.Score,
    PWT.Tags,
    PWT.EngagementRatio,
    COALESCE(PHD.CloseReasonComments, 'No comments') AS CloseReasonComments
FROM 
    PostsWithTags PWT
LEFT JOIN 
    PostHistoryData PHD ON PWT.PostId = PHD.PostId
WHERE 
    (PWT.EngagementRatio IS NOT NULL AND PWT.EngagementRatio > 1)
    OR
    (PWT.Score >= 10 AND PWT.ViewCount > 100)
ORDER BY 
    PWT.Score DESC, 
    PWT.ViewCount DESC,
    PWT.CreationDate DESC
LIMIT 50;
