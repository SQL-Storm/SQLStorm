WITH UserStatistics AS (
    SELECT 
        U.Id AS UserId,
        COUNT(DISTINCT P.Id) AS PostCount,
        SUM(V.VoteTypeId = 2) AS Upvotes,
        SUM(V.VoteTypeId = 3) AS Downvotes,
        AVG(U.Reputation) AS AverageReputation
    FROM 
        Users U
    LEFT JOIN 
        Posts P ON U.Id = P.OwnerUserId
    LEFT JOIN 
        Votes V ON P.Id = V.PostId
    GROUP BY 
        U.Id
),
PostStatistics AS (
    SELECT 
        P.Id AS PostId,
        P.Title,
        P.CreationDate,
        P.ViewCount,
        COUNT(C.Id) AS CommentCount,
        COALESCE(SUM(V.VoteTypeId = 2), 0) AS Upvotes,
        COALESCE(SUM(V.VoteTypeId = 3), 0) AS Downvotes
    FROM 
        Posts P
    LEFT JOIN 
        Comments C ON P.Id = C.PostId
    LEFT JOIN 
        Votes V ON P.Id = V.PostId
    GROUP BY 
        P.Id
),
PostTypeCounts AS (
    SELECT 
        PT.Name AS PostType,
        COUNT(P.Id) AS TypeCount
    FROM 
        Posts P
    JOIN 
        PostTypes PT ON P.PostTypeId = PT.Id
    GROUP BY 
        PT.Name
)
SELECT 
    U.UserId,
    U.PostCount,
    U.Upvotes,
    U.Downvotes,
    U.AverageReputation,
    P.PostId,
    P.Title,
    P.CreationDate,
    P.ViewCount,
    P.CommentCount,
    P.Upvotes AS PostUpvotes,
    P.Downvotes AS PostDownvotes,
    T.PostType,
    PTC.TypeCount
FROM 
    UserStatistics U
LEFT JOIN 
    PostStatistics P ON U.UserId = P.OwnerUserId
LEFT JOIN 
    PostTypeCounts PTC ON P.PostTypeId = PTC.PostTypeId
ORDER BY 
    U.AverageReputation DESC, U.PostCount DESC;