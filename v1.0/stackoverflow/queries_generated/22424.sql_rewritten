WITH RankedPosts AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.CreationDate,
        p.OwnerUserId,
        p.Score,
        ROW_NUMBER() OVER (PARTITION BY p.OwnerUserId ORDER BY p.Score DESC) AS RankScore
    FROM 
        Posts p
    WHERE
        p.PostTypeId = 1 AND 
        p.CreationDate >= DATEADD(year, -1, GETDATE()) 
), 
UserScoreSummary AS (
    SELECT 
        u.Id AS UserId,
        u.DisplayName,
        SUM(COALESCE(v.BountyAmount, 0)) AS TotalBounties,
        SUM(COALESCE(v.VoteTypeId, 0)) AS VoteScore, 
        COUNT(DISTINCT p.Id) AS TotalPosts,
        MAX(u.Reputation) AS MaxRep
    FROM 
        Users u
    LEFT JOIN 
        Posts p ON p.OwnerUserId = u.Id
    LEFT JOIN 
        Votes v ON v.UserId = u.Id
    GROUP BY 
        u.Id, u.DisplayName
),
TopBountyPost AS (
    SELECT 
        p.Id,
        p.Title,
        p.CreationDate,
        COALESCE(p.Score, 0) + COALESCE(v.BountyAmount, 0) AS AdjustedScore
    FROM 
        Posts p
    LEFT JOIN 
        Votes v ON v.PostId = p.Id AND v.VoteTypeId = 8  
    WHERE 
        p.PostTypeId = 1 AND
        p.CreationDate < DATEADD(month, -6, GETDATE()) 
),
PostHistorySummary AS (
    SELECT 
        ph.PostId,
        COUNT(CASE WHEN ph.PostHistoryTypeId IN (10, 11) THEN 1 END) AS CloseOpenCount,
        COUNT(CASE WHEN ph.PostHistoryTypeId = 12 THEN 1 END) AS DeletionCount
    FROM 
        PostHistory ph
    GROUP BY 
        ph.PostId
),
FinalSummary AS (
    SELECT
        up.UserId,
        up.DisplayName,
        us.TotalBounties,
        us.VoteScore,
        us.TotalPosts,
        phs.CloseOpenCount,
        phs.DeletionCount,
        r.Title,
        r.CreationDate
    FROM 
        UserScoreSummary us
    JOIN 
        Users up ON up.Id = us.UserId
    LEFT JOIN 
        RankedPosts r ON up.Id = r.OwnerUserId AND r.RankScore <= 1
    LEFT JOIN 
        PostHistorySummary phs ON r.PostId = phs.PostId
)
SELECT 
    f.UserId,
    f.DisplayName,
    f.TotalBounties,
    f.VoteScore,
    f.TotalPosts,
    f.CloseOpenCount,
    f.DeletionCount,
    COALESCE(tbp.Title, 'No Record') AS TopBountyTitle,
    COALESCE(tbp.AdjustedScore, 0) AS TopBountyAdjustedScore
FROM 
    FinalSummary f
LEFT JOIN 
    TopBountyPost tbp ON f.UserId = tbp.OwnerUserId
ORDER BY 
    f.TotalBounties DESC, 
    f.VoteScore DESC, 
    f.TotalPosts DESC
WITH TIES;