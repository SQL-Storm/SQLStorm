
WITH PotentialDuplicates AS (
    SELECT 
        p1.Id AS OriginalPostId,
        p1.Title AS OriginalTitle,
        p1.Tags AS OriginalTags,
        p2.Id AS RelatedPostId,
        p2.Title AS RelatedTitle,
        p2.Tags AS RelatedTags,
        ph.UserId AS ClosedByUserId,
        ph.UserDisplayName AS ClosedByUser,
        ph.CreationDate AS CloseDate,
        ph.Comment AS CloseReason
    FROM 
        Posts p1
    JOIN 
        PostLinks pl ON p1.Id = pl.PostId
    JOIN 
        Posts p2 ON pl.RelatedPostId = p2.Id
    JOIN 
        PostHistory ph ON p1.Id = ph.PostId
    WHERE 
        ph.PostHistoryTypeId = 10  
        AND p1.PostTypeId = 1      
        AND p2.PostTypeId IN (1, 2) 
),
TagStatistics AS (
    SELECT 
        SplitTags.TagName,
        COUNT(DISTINCT p.Id) AS PostCount,
        SUM(p.ViewCount) AS TotalViews,
        SUM(p.AnswerCount) AS TotalAnswers
    FROM 
        Posts p
    CROSS JOIN LATERAL 
        (SELECT unnest(string_to_array(substring(p.Tags, 2, length(p.Tags) - 2), '><')) AS TagName) AS SplitTags
    WHERE 
        p.PostTypeId = 1  
    GROUP BY 
        SplitTags.TagName
),
TopUsers AS (
    SELECT 
        u.Id AS UserId,
        u.DisplayName,
        COUNT(DISTINCT p.Id) AS QuestionsAsked,
        SUM(p.ViewCount) AS TotalViews,
        SUM(p.UpVotes) AS TotalUpVotes,
        SUM(p.DownVotes) AS TotalDownVotes
    FROM 
        Users u
    JOIN 
        Posts p ON u.Id = p.OwnerUserId
    WHERE 
        p.PostTypeId = 1 
    GROUP BY 
        u.Id, u.DisplayName
    ORDER BY 
        QuestionsAsked DESC
    LIMIT 10
)
SELECT 
    du.OriginalPostId,
    du.OriginalTitle,
    du.OriginalTags,
    du.RelatedPostId,
    du.RelatedTitle,
    du.RelatedTags,
    du.ClosedByUser,
    du.CloseDate,
    du.CloseReason,
    ts.TagName,
    ts.PostCount,
    ts.TotalViews,
    ts.TotalAnswers,
    tu.DisplayName AS TopUser,
    tu.QuestionsAsked,
    tu.TotalViews AS UserTotalViews,
    tu.TotalUpVotes,
    tu.TotalDownVotes
FROM 
    PotentialDuplicates du
LEFT JOIN 
    TagStatistics ts ON du.OriginalTags LIKE '%' || ts.TagName || '%'
LEFT JOIN 
    TopUsers tu ON du.ClosedByUserId = tu.UserId
ORDER BY 
    du.CloseDate DESC, 
    ts.PostCount DESC;
