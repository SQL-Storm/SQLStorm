
WITH UserActivity AS (
    SELECT 
        U.Id AS UserId,
        U.DisplayName,
        COALESCE(SUM(P.ViewCount), 0) AS TotalViews,
        COALESCE(SUM(P.AnswerCount), 0) AS TotalAnswers,
        COALESCE(SUM(P.CommentCount), 0) AS TotalComments,
        COUNT(DISTINCT CASE WHEN P.PostTypeId = 1 THEN P.Id END) AS QuestionCount,
        COUNT(DISTINCT CASE WHEN P.PostTypeId = 2 THEN P.Id END) AS AnswerCount,
        COUNT(DISTINCT B.Id) AS BadgeCount
    FROM Users U
    LEFT JOIN Posts P ON U.Id = P.OwnerUserId
    LEFT JOIN Badges B ON U.Id = B.UserId
    GROUP BY U.Id, U.DisplayName
),
RecentActivity AS (
    SELECT 
        UserId,
        MAX(CreationDate) AS LastActiveDate
    FROM Comments
    GROUP BY UserId
),
RankedUsers AS (
    SELECT 
        UA.UserId,
        UA.DisplayName,
        UA.TotalViews,
        UA.TotalAnswers,
        UA.TotalComments,
        UA.QuestionCount,
        UA.AnswerCount,
        UA.BadgeCount,
        COALESCE(RA.LastActiveDate, DATE '1900-01-01') AS LastActiveDate,
        RANK() OVER (ORDER BY UA.TotalViews DESC, UA.BadgeCount DESC) AS UserRank
    FROM UserActivity UA
    LEFT JOIN RecentActivity RA ON UA.UserId = RA.UserId
)
SELECT 
    U.UserId,
    U.DisplayName,
    U.TotalViews,
    U.TotalAnswers,
    U.QuestionCount,
    U.AnswerCount,
    U.BadgeCount,
    U.LastActiveDate,
    CASE 
        WHEN U.BadgeCount > 50 THEN 'Super User'
        WHEN U.BadgeCount BETWEEN 10 AND 50 THEN 'Active User'
        ELSE 'New User'
    END AS UserCategory,
    CASE 
        WHEN DATEDIFF(DATE '2024-10-01', U.LastActiveDate) > 365 THEN 'Inactive'
        ELSE 'Active'
    END AS UserStatus
FROM RankedUsers U
WHERE U.UserRank <= 100
ORDER BY U.UserRank, U.TotalViews DESC;
