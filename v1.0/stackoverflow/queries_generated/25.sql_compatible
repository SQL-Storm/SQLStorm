
WITH RankedPosts AS (
    SELECT 
        p.Id,
        p.Title,
        p.Score,
        p.CreationDate,
        p.OwnerUserId,
        RANK() OVER (PARTITION BY p.PostTypeId ORDER BY p.Score DESC) AS PostRank
    FROM 
        Posts p
    WHERE 
        p.CreationDate >= DATEADD(year, -1, CAST('2024-10-01' AS DATE))
),
UserBadges AS (
    SELECT 
        u.Id AS UserId,
        COUNT(b.Id) FILTER (WHERE b.Class = 1) AS GoldBadges,
        COUNT(b.Id) FILTER (WHERE b.Class = 2) AS SilverBadges,
        COUNT(b.Id) FILTER (WHERE b.Class = 3) AS BronzeBadges
    FROM 
        Users u
    LEFT JOIN 
        Badges b ON u.Id = b.UserId
    GROUP BY 
        u.Id
)
SELECT 
    up.DisplayName,
    COUNT(DISTINCT rp.Id) AS TopPostCount,
    ub.GoldBadges,
    ub.SilverBadges,
    ub.BronzeBadges,
    COALESCE(SUM(p.ViewCount), 0) AS TotalViews,
    COALESCE(SUM(p.UpVotes), 0) AS TotalUpVotes,
    COALESCE(SUM(p.DownVotes), 0) AS TotalDownVotes,
    COUNT(DISTINCT c.Id) AS CommentCount
FROM 
    Users up
LEFT JOIN 
    RankedPosts rp ON up.Id = rp.OwnerUserId AND rp.PostRank <= 5
LEFT JOIN 
    Posts p ON p.OwnerUserId = up.Id
LEFT JOIN 
    Comments c ON c.PostId = p.Id
LEFT JOIN 
    UserBadges ub ON up.Id = ub.UserId
WHERE 
    up.Reputation > 1000
GROUP BY 
    up.Id, up.DisplayName, ub.GoldBadges, ub.SilverBadges, ub.BronzeBadges
ORDER BY 
    TotalUpVotes DESC, TotalViews DESC
LIMIT 10;
