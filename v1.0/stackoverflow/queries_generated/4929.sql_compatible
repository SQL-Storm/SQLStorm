
WITH UserBadgeSummary AS (
    SELECT 
        u.Id AS UserId,
        u.DisplayName,
        COUNT(b.Id) AS BadgeCount,
        MAX(b.Date) AS LastBadgeDate
    FROM 
        Users u
    LEFT JOIN 
        Badges b ON u.Id = b.UserId
    GROUP BY 
        u.Id, u.DisplayName
),
PostSummary AS (
    SELECT 
        p.OwnerUserId,
        COUNT(p.Id) AS PostCount,
        SUM(p.Score) AS TotalScore,
        AVG(p.ViewCount) AS AvgViews,
        MAX(p.CreationDate) AS LastPostDate
    FROM 
        Posts p
    GROUP BY 
        p.OwnerUserId
),
UserActivity AS (
    SELECT 
        u.Id AS UserId,
        u.Reputation,
        u.CreationDate,
        COALESCE(bs.BadgeCount, 0) AS BadgeCount,
        COALESCE(ps.PostCount, 0) AS PostCount,
        COALESCE(ps.TotalScore, 0) AS TotalScore,
        COALESCE(ps.AvgViews, 0) AS AvgViews,
        COALESCE(bs.LastBadgeDate, DATE '1970-01-01') AS LastBadgeDate,
        COALESCE(ps.LastPostDate, DATE '1970-01-01') AS LastPostDate
    FROM 
        Users u
    LEFT JOIN 
        UserBadgeSummary bs ON u.Id = bs.UserId
    LEFT JOIN 
        PostSummary ps ON u.Id = ps.OwnerUserId
),
RankedUsers AS (
    SELECT 
        ua.*,
        ROW_NUMBER() OVER (ORDER BY ua.Reputation DESC, ua.BadgeCount DESC, ua.TotalScore DESC) AS Rank
    FROM 
        UserActivity ua
)
SELECT 
    ru.UserId,
    ru.DisplayName,
    ru.Reputation,
    ru.BadgeCount,
    ru.PostCount,
    ru.TotalScore,
    ru.AvgViews,
    ru.LastBadgeDate,
    ru.LastPostDate
FROM 
    RankedUsers ru
WHERE 
    ru.Rank <= 100
ORDER BY 
    ru.Rank;
