WITH RecursivePostCTE AS (
    
    SELECT 
        Id,
        Title,
        ParentId,
        CreationDate,
        0 AS Level
    FROM 
        Posts
    WHERE 
        ParentId IS NULL
    
    UNION ALL
    
    SELECT 
        p.Id,
        p.Title,
        p.ParentId,
        p.CreationDate,
        Level + 1
    FROM 
        Posts p
    INNER JOIN 
        RecursivePostCTE r ON p.ParentId = r.Id
),
PostStats AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        COUNT(c.Id) AS CommentCount,
        SUM(v.VoteTypeId = 2) AS UpVoteCount,
        SUM(v.VoteTypeId = 3) AS DownVoteCount,
        p.CreationDate,
        COALESCE(MAX(ph.CreationDate), p.CreationDate) AS LastEditDate
    FROM 
        Posts p
    LEFT JOIN 
        Comments c ON p.Id = c.PostId
    LEFT JOIN 
        Votes v ON p.Id = v.PostId
    LEFT JOIN 
        PostHistory ph ON p.Id = ph.PostId
    WHERE 
        p.CreationDate >= DATEADD(MONTH, -6, GETDATE()) 
    GROUP BY 
        p.Id, p.Title, p.CreationDate
),
UserBadges AS (
    SELECT 
        u.Id AS UserId,
        COUNT(CASE WHEN b.Class = 1 THEN 1 END) AS GoldBadges,
        COUNT(CASE WHEN b.Class = 2 THEN 1 END) AS SilverBadges,
        COUNT(CASE WHEN b.Class = 3 THEN 1 END) AS BronzeBadges
    FROM 
        Users u
    LEFT JOIN 
        Badges b ON u.Id = b.UserId
    GROUP BY 
        u.Id
)
SELECT 
    ps.PostId,
    ps.Title,
    ps.CommentCount,
    ps.UpVoteCount,
    ps.DownVoteCount,
    r.Level AS PostLevel,
    ub.UserId,
    ub.GoldBadges,
    ub.SilverBadges,
    ub.BronzeBadges,
    DATEDIFF(SECOND, ps.CreationDate, GETDATE()) AS AgeInSeconds,
    CASE 
        WHEN ps.LastEditDate IS NULL THEN 'Never Edited' 
        ELSE CAST(ps.LastEditDate AS VARCHAR(20))
    END AS LastEdit
FROM 
    PostStats ps
LEFT JOIN 
    RecursivePostCTE r ON ps.PostId = r.Id
LEFT JOIN 
    Users u ON ps.PostId IN (SELECT PostId FROM Comments WHERE UserId = u.Id)
LEFT JOIN 
    UserBadges ub ON u.Id = ub.UserId
WHERE 
    ps.UpVoteCount > ps.DownVoteCount 
ORDER BY 
    ps.CommentCount DESC, ps.UpVoteCount DESC;