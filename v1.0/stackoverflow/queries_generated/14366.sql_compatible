
WITH PostMetrics AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.CreationDate,
        p.LastActivityDate,
        EXTRACT(EPOCH FROM (p.LastActivityDate - p.CreationDate)) AS ResponseTime, 
        COALESCE(v.Upvotes, 0) AS TotalUpvotes,
        COALESCE(v.Downvotes, 0) AS TotalDownvotes,
        COUNT(DISTINCT c.Id) AS CommentCount,
        COUNT(DISTINCT a.Id) AS AnswerCount
    FROM 
        Posts p
    LEFT JOIN 
        Votes v ON p.Id = v.PostId
    LEFT JOIN 
        Comments c ON p.Id = c.PostId
    LEFT JOIN 
        Posts a ON p.Id = a.ParentId AND a.PostTypeId = 2 
    WHERE 
        p.PostTypeId = 1 
    GROUP BY 
        p.Id, p.Title, p.CreationDate, p.LastActivityDate
)

SELECT 
    AVG(ResponseTime) AS AverageResponseTime,
    SUM(TotalUpvotes) AS TotalVotes,
    MAX(ResponseTime) AS MaxResponseTime,
    MIN(ResponseTime) AS MinResponseTime,
    COUNT(PostId) AS TotalQuestions
FROM 
    PostMetrics;
