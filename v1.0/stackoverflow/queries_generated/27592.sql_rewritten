WITH RankedPosts AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.CreationDate,
        COALESCE(COUNT(DISTINCT a.Id), 0) AS AnswerCount,
        COALESCE(SUM(vt.BountyAmount), 0) AS TotalBounty,
        COALESCE(MAX(v.CreationDate), '1970-01-01') AS LatestVoteDate,
        STRING_AGG(DISTINCT t.TagName, ', ') AS Tags
    FROM 
        Posts p
    LEFT JOIN 
        Posts a ON p.Id = a.ParentId AND a.PostTypeId = 2
    LEFT JOIN 
        Votes v ON p.Id = v.PostId
    LEFT JOIN 
        Votes vt ON p.Id = vt.PostId AND vt.VoteTypeId IN (8, 9) 
    LEFT JOIN 
        STRING_TO_ARRAY(SUBSTRING(p.Tags, 2, LENGTH(p.Tags)-2), '><') AS tag_array ON EXISTS (SELECT 1 FROM Tags t WHERE t.TagName = tag_array)
    LEFT JOIN 
        Tags t ON t.TagName = tag_array
    WHERE 
        p.PostTypeId = 1 
    GROUP BY 
        p.Id, p.Title, p.CreationDate
),

SelectedPosts AS (
    SELECT 
        rp.PostId, 
        rp.Title, 
        rp.CreationDate,
        rp.AnswerCount,
        rp.TotalBounty,
        rp.LatestVoteDate,
        rp.Tags,
        RANK() OVER (ORDER BY rp.AnswerCount DESC, rp.TotalBounty DESC, rp.LatestVoteDate DESC) AS Rank
    FROM 
        RankedPosts rp
    WHERE 
        rp.AnswerCount > 0 
        AND rp.TotalBounty > 0
)

SELECT 
    sp.PostId,
    sp.Title,
    sp.CreationDate,
    sp.AnswerCount,
    sp.TotalBounty,
    sp.LatestVoteDate,
    sp.Tags,
    sp.Rank
FROM 
    SelectedPosts sp
WHERE 
    sp.Rank <= 10 
ORDER BY 
    sp.Rank;