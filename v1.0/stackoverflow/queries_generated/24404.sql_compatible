
WITH RankedPosts AS (
    SELECT
        p.Id AS PostId,
        p.Title,
        p.CreationDate,
        p.Score,
        p.ViewCount,
        ROW_NUMBER() OVER (PARTITION BY p.PostTypeId ORDER BY p.Score DESC, p.ViewCount DESC) AS PostRank,
        p.OwnerUserId,
        LENGTH(REGEXP_REPLACE(p.Tags, '<>', '')) AS TagCount,
        COALESCE((SELECT COUNT(DISTINCT c.Id) 
                  FROM Comments c 
                  WHERE c.PostId = p.Id), 0) AS CommentCount
    FROM
        Posts p
    WHERE
        p.CreationDate > DATE '2024-10-01' - INTERVAL '1 year'
),
UserActivity AS (
    SELECT
        u.Id AS UserId,
        u.Reputation,
        COUNT(DISTINCT b.Id) AS BadgeCount,
        SUM(COALESCE(v.BountyAmount, 0)) AS TotalBounty,
        AVG(EXTRACT(EPOCH FROM (TIMESTAMP '2024-10-01 12:34:56' - u.CreationDate))) / 3600 AS HoursOnPlatform
    FROM
        Users u
    LEFT JOIN
        Badges b ON u.Id = b.UserId
    LEFT JOIN
        Votes v ON u.Id = v.UserId
    GROUP BY
        u.Id, u.Reputation
),
PostAnalytics AS (
    SELECT
        rp.PostId,
        rp.Title,
        rp.CreationDate,
        rp.Score,
        rp.TagCount,
        ua.UserId,
        ua.Reputation,
        ua.BadgeCount,
        ua.TotalBounty,
        ua.HoursOnPlatform,
        CASE 
            WHEN ua.Reputation > 1000 THEN 'Expert'
            WHEN ua.Reputation BETWEEN 500 AND 1000 THEN 'Intermediate'
            ELSE 'Beginner'
        END AS UserLevel
    FROM
        RankedPosts rp
    LEFT JOIN
        Users ua ON rp.OwnerUserId = ua.Id
    WHERE
        rp.PostRank < 11 
)
SELECT
    pa.PostId,
    pa.Title,
    pa.CreationDate,
    pa.Score,
    pa.TagCount,
    pa.Reputation,
    pa.UserLevel,
    (CASE
        WHEN pa.TagCount = 0 THEN 'No Tags'
        ELSE 'Has Tags'
    END) AS TagStatus,
    CASE 
        WHEN pa.Score IS NULL THEN 'Unscored'
        WHEN pa.Score >= 100 THEN 'Highly Scored'
        WHEN pa.Score BETWEEN 0 AND 99 THEN 'Moderately Scored'
        ELSE 'Low Scored'
    END AS ScoreCategory
FROM
    PostAnalytics pa
WHERE
    pa.CommentCount > 5 OR pa.TotalBounty > 0
ORDER BY
    pa.Score DESC, pa.CreationDate DESC
LIMIT 50 OFFSET 0;
