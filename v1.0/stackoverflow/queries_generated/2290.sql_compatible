
WITH RankedPosts AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.ViewCount,
        p.Score,
        p.AnswerCount,
        p.CreationDate,
        ROW_NUMBER() OVER (PARTITION BY p.OwnerUserId ORDER BY p.CreationDate DESC) AS UserPostRank
    FROM 
        Posts p
    WHERE 
        p.CreationDate >= TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '1 year'
        AND p.ViewCount > 500
),
RecentBadges AS (
    SELECT 
        b.UserId,
        COUNT(b.Id) AS BadgeCount,
        MAX(b.Date) AS LastBadgeDate
    FROM 
        Badges b
    GROUP BY 
        b.UserId
    HAVING 
        MAX(b.Date) >= TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '6 months'
),
UserEngagement AS (
    SELECT 
        u.Id AS UserId,
        COALESCE(SUM(v.BountyAmount), 0) AS TotalBounty,
        COALESCE(SUM(c.Score), 0) AS TotalCommentScore,
        COALESCE(SUM(CASE WHEN vote.VoteTypeId = 2 THEN 1 ELSE 0 END), 0) AS TotalUpVotes,
        COALESCE(SUM(CASE WHEN vote.VoteTypeId = 3 THEN 1 ELSE 0 END), 0) AS TotalDownVotes
    FROM 
        Users u
    LEFT JOIN 
        Votes vote ON u.Id = vote.UserId
    LEFT JOIN 
        Comments c ON u.Id = c.UserId
    LEFT JOIN 
        Votes v ON v.UserId = u.Id
    GROUP BY 
        u.Id
)
SELECT 
    u.DisplayName,
    u.Reputation,
    r.Title,
    r.ViewCount,
    r.Score,
    r.AnswerCount,
    r.CreationDate,
    COALESCE(be.BadgeCount, 0) AS BadgeCount,
    COALESCE(SUM(ue.TotalBounty), 0) AS TotalBountyEarned,
    (COALESCE(ue.TotalUpVotes, 0) - COALESCE(ue.TotalDownVotes, 0)) AS NetVotes
FROM 
    Users u
JOIN 
    RankedPosts r ON u.Id = r.OwnerUserId
LEFT JOIN 
    RecentBadges be ON u.Id = be.UserId
LEFT JOIN 
    UserEngagement ue ON u.Id = ue.UserId
WHERE 
    r.UserPostRank <= 5
GROUP BY 
    u.DisplayName, u.Reputation, r.Title, r.ViewCount, 
    r.Score, r.AnswerCount, r.CreationDate, be.BadgeCount
ORDER BY 
    NetVotes DESC, u.Reputation DESC
LIMIT 10;
