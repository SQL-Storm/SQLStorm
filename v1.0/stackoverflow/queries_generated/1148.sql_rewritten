WITH UserPostStats AS (
    SELECT 
        u.Id AS UserId,
        u.DisplayName,
        COUNT(p.Id) AS TotalPosts,
        SUM(CASE WHEN p.PostTypeId = 1 THEN 1 ELSE 0 END) AS TotalQuestions,
        SUM(CASE WHEN p.PostTypeId = 2 THEN 1 ELSE 0 END) AS TotalAnswers,
        AVG(p.Score) AS AvgPostScore,
        COALESCE(SUM(v.BountyAmount), 0) AS TotalBounty
    FROM Users u
    LEFT JOIN Posts p ON u.Id = p.OwnerUserId
    LEFT JOIN Votes v ON p.Id = v.PostId AND v.VoteTypeId = 8 
    GROUP BY u.Id, u.DisplayName
),

TopUsers AS (
    SELECT UserId, TotalPosts, TotalQuestions, TotalAnswers, AvgPostScore, TotalBounty,
           ROW_NUMBER() OVER (ORDER BY TotalBounty DESC, TotalPosts DESC) AS Rank
    FROM UserPostStats
)

SELECT 
    u.DisplayName,
    ups.TotalPosts,
    ups.TotalQuestions,
    ups.TotalAnswers,
    ups.AvgPostScore,
    ups.TotalBounty,
    CASE 
        WHEN ups.TotalPosts = 0 THEN 'No posts' 
        ELSE ROUND(ups.AvgPostScore / NULLIF(ups.TotalPosts, 0), 2) 
    END AS AvgScorePerPost,
    CASE 
        WHEN ups.TotalQuestions > 100 THEN 'Super Contributor'
        WHEN ups.TotalAnswers < 10 THEN 'Needs Improvement'
        ELSE 'Regular Contributor'
    END AS ContributionLevel
FROM TopUsers ups
JOIN Users u ON ups.UserId = u.Id
WHERE ups.Rank <= 10
ORDER BY ups.TotalBounty DESC;