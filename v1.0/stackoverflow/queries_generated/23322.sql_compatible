
WITH RankedPosts AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.OwnerUserId,
        p.CreationDate,
        ROW_NUMBER() OVER (PARTITION BY p.OwnerUserId ORDER BY p.CreationDate DESC) AS UserPostRank
    FROM 
        Posts p
    WHERE 
        p.CreationDate >= TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '1 year'
),
PostMetrics AS (
    SELECT 
        rp.PostId,
        rp.Title,
        rp.OwnerUserId,
        COALESCE(SUM(CASE WHEN vt.Id = 2 THEN 1 ELSE 0 END), 0) AS TotalUpvotes, 
        COALESCE(SUM(CASE WHEN vt.Id = 3 THEN 1 ELSE 0 END), 0) AS TotalDownvotes, 
        COUNT(c.Id) AS CommentCount,
        COALESCE(MAX(bp.Date), DATE '1900-01-01') AS LastBadgeDate 
    FROM 
        RankedPosts rp
    LEFT JOIN 
        Votes vt ON rp.PostId = vt.PostId
    LEFT JOIN 
        Comments c ON rp.PostId = c.PostId
    LEFT JOIN 
        Badges bp ON rp.OwnerUserId = bp.UserId
    WHERE 
        bp.Date IS NULL OR bp.Date >= TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '6 months'
    GROUP BY 
        rp.PostId, rp.Title, rp.OwnerUserId
),
TopPosts AS (
    SELECT 
        pm.PostId,
        pm.Title,
        pm.OwnerUserId,
        (pm.TotalUpvotes - pm.TotalDownvotes) AS NetScore,
        DENSE_RANK() OVER (ORDER BY (pm.TotalUpvotes - pm.TotalDownvotes) DESC) AS ScoreRank
    FROM 
        PostMetrics pm
    WHERE 
        pm.TotalUpvotes - pm.TotalDownvotes > 0
)
SELECT 
    u.DisplayName,
    tp.Title,
    tp.NetScore,
    tp.ScoreRank,
    CASE 
        WHEN tp.ScoreRank = 1 THEN 'Gold Star'
        WHEN tp.ScoreRank <= 5 THEN 'Silver Star'
        ELSE 'Participant'
    END AS ParticipationLevel, 
    ph.Comment AS PostHistoryComment,
    (SELECT STRING_AGG(pt.Name, ', ') 
     FROM PostHistoryTypes pt 
     JOIN PostHistory ph_sub ON pt.Id = ph_sub.PostHistoryTypeId 
     WHERE ph_sub.PostId = tp.PostId
    ) AS PostHistoryTypes,
    CASE 
        WHEN LastBadgeDate > TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '1 month' THEN 'Recently Honored'
        ELSE 'Seasoned Contributor'
    END AS ContributorStatus
FROM 
    TopPosts tp
JOIN 
    Users u ON tp.OwnerUserId = u.Id
LEFT JOIN 
    PostHistory ph ON tp.PostId = ph.PostId 
WHERE 
    ph.Comment IS NOT NULL 
ORDER BY 
    tp.ScoreRank;
