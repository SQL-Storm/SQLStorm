
WITH RECURSIVE UserReputationHistory AS (
    SELECT 
        u.Id AS UserId,
        SUM(v.BountyAmount) AS TotalBounty,
        ROW_NUMBER() OVER(PARTITION BY u.Id ORDER BY COALESCE(v.CreationDate, u.CreationDate) DESC) AS rn
    FROM Users u
    LEFT JOIN Votes v ON u.Id = v.UserId
    GROUP BY u.Id
),

ActiveUsers AS (
    SELECT 
        u.Id AS UserId,
        u.Reputation,
        DATEDIFF(TIMESTAMP '2024-10-01 12:34:56', u.LastAccessDate) AS DaysSinceLastAccess
    FROM Users u
    WHERE u.LastAccessDate > TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '90 DAY'
),

TopUsers AS (
    SELECT 
        au.UserId,
        au.Reputation,
        COALESCE(ur.TotalBounty, 0) AS TotalBounty
    FROM ActiveUsers au
    LEFT JOIN UserReputationHistory ur ON au.UserId = ur.UserId
    WHERE ur.rn = 1
)

SELECT 
    u.DisplayName,
    u.Reputation,
    tu.TotalBounty,
    COUNT(DISTINCT p.Id) AS TotalPosts,
    SUM(COALESCE(p.ViewCount, 0)) AS TotalViews,
    AVG(COALESCE(c.Score, 0)) AS AvgCommentScore
FROM Users u
LEFT JOIN Posts p ON u.Id = p.OwnerUserId
LEFT JOIN Comments c ON p.Id = c.PostId
LEFT JOIN TopUsers tu ON u.Id = tu.UserId
WHERE u.Reputation >= 1000
GROUP BY u.DisplayName, u.Reputation, tu.TotalBounty
HAVING COUNT(DISTINCT p.Id) > 5 AND AVG(COALESCE(c.Score, 0)) > 0
ORDER BY u.Reputation DESC, TotalViews DESC
LIMIT 10;
