
WITH RankedPosts AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.Score,
        p.ViewCount,
        p.CreationDate,
        p.OwnerUserId,
        ROW_NUMBER() OVER (PARTITION BY p.OwnerUserId ORDER BY p.Score DESC, p.CreationDate DESC) AS rn,
        (SELECT COUNT(*) FROM Votes v WHERE v.PostId = p.Id AND v.VoteTypeId = 2) AS UpvoteCount,
        (SELECT COUNT(*) FROM Votes v WHERE v.PostId = p.Id AND v.VoteTypeId = 3) AS DownvoteCount
    FROM Posts p
    WHERE p.CreationDate >= DATE_SUB(CURRENT_DATE(), INTERVAL 1 YEAR)
),
UserStats AS (
    SELECT 
        u.Id AS UserId,
        u.DisplayName,
        COUNT(DISTINCT p.Id) AS TotalPosts,
        SUM(p.Score) AS TotalScore,
        SUM(COALESCE(b.Class, 0)) AS BadgePoints, 
        AVG(p.ViewCount) AS AvgPostViewCount
    FROM Users u
    LEFT JOIN Posts p ON u.Id = p.OwnerUserId
    LEFT JOIN Badges b ON u.Id = b.UserId
    GROUP BY u.Id, u.DisplayName
),
ClosedPosts AS (
    SELECT 
        ph.PostId,
        ph.CreationDate,
        C.Name AS CloseReason,
        SUM(CASE WHEN ph.PostHistoryTypeId IN (10, 11) THEN 1 ELSE 0 END) AS CloseVoteCount
    FROM PostHistory ph
    JOIN CloseReasonTypes C ON ph.Comment @> jsonb_build_array(C.Id) 
    WHERE ph.PostHistoryTypeId IN (10, 11) 
    GROUP BY ph.PostId, ph.CreationDate, C.Name
)
SELECT 
    rp.PostId,
    rp.Title,
    rp.Score,
    rp.ViewCount,
    us.TotalPosts,
    us.TotalScore,
    us.BadgePoints,
    us.AvgPostViewCount,
    cp.CloseReason,
    cp.CloseVoteCount
FROM RankedPosts rp
JOIN UserStats us ON rp.OwnerUserId = us.UserId
LEFT JOIN ClosedPosts cp ON rp.PostId = cp.PostId
WHERE 
    (rp.UpvoteCount - rp.DownvoteCount) > 5 
    AND (cp.CloseVoteCount IS NULL OR cp.CloseVoteCount = 0) 
ORDER BY 
    rp.Score DESC,
    us.TotalScore DESC,
    us.TotalPosts DESC
LIMIT 100;
