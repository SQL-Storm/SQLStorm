
WITH TagCounts AS (
    SELECT
        t.TagName,
        COUNT(t.Id) AS TagPostCount
    FROM
        Tags t
    JOIN
        Posts p ON t.Id = ANY(string_to_array(substring(p.Tags, 2, length(p.Tags) - 2), '><')::text[]) 
    GROUP BY
        t.TagName
),
UserActivity AS (
    SELECT
        u.Id AS UserId,
        u.DisplayName,
        SUM(CASE WHEN p.PostTypeId = 1 THEN 1 ELSE 0 END) AS QuestionCount,
        SUM(CASE WHEN p.PostTypeId = 2 THEN 1 ELSE 0 END) AS AnswerCount,
        SUM(CASE WHEN c.Id IS NOT NULL THEN 1 ELSE 0 END) AS CommentCount,
        SUM(CASE WHEN v.Id IS NOT NULL THEN 1 ELSE 0 END) AS VoteCount
    FROM
        Users u
    LEFT JOIN
        Posts p ON u.Id = p.OwnerUserId
    LEFT JOIN
        Comments c ON p.Id = c.PostId
    LEFT JOIN
        Votes v ON p.Id = v.PostId
    GROUP BY
        u.Id, u.DisplayName
),
PopularTags AS (
    SELECT
        tc.TagName,
        tc.TagPostCount,
        RANK() OVER (ORDER BY tc.TagPostCount DESC) AS Rank
    FROM
        TagCounts tc
    WHERE
        tc.TagPostCount > 10
),
PopularUsers AS (
    SELECT
        ua.UserId,
        ua.DisplayName,
        ua.QuestionCount,
        ua.AnswerCount,
        ua.CommentCount,
        ua.VoteCount,
        RANK() OVER (ORDER BY (ua.QuestionCount + ua.AnswerCount + ua.CommentCount + ua.VoteCount) DESC) AS Rank
    FROM
        UserActivity ua
    WHERE
        (ua.QuestionCount + ua.AnswerCount + ua.CommentCount + ua.VoteCount) > 5
)
SELECT
    pu.DisplayName AS PopularUser,
    pu.QuestionCount,
    pu.AnswerCount,
    pu.CommentCount,
    pu.VoteCount,
    pt.TagName,
    pt.TagPostCount
FROM
    PopularUsers pu
JOIN
    PopularTags pt ON pu.Rank = pt.Rank
ORDER BY
    pu.Rank, pt.TagPostCount DESC;
