
WITH RecursiveUserVoteHistory AS (
    SELECT
        U.Id AS UserId,
        U.DisplayName,
        U.Reputation,
        V.CreationDate AS VoteDate,
        P.Id AS PostId,
        P.Title,
        V.VoteTypeId,
        ROW_NUMBER() OVER (PARTITION BY U.Id ORDER BY V.CreationDate DESC) AS VoteRank
    FROM
        Users U
    JOIN
        Votes V ON U.Id = V.UserId
    JOIN
        Posts P ON V.PostId = P.Id
    WHERE
        U.Reputation > 1000
),
FrequentTags AS (
    SELECT
        T.TagName,
        COUNT(P.Id) AS PostCount
    FROM
        Tags T
    JOIN
        Posts P ON P.Tags LIKE '%' || T.TagName || '%'
    GROUP BY
        T.TagName
    HAVING
        COUNT(P.Id) > 10
),
PostActivitySummary AS (
    SELECT
        P.Id AS PostId,
        P.Title,
        COALESCE(C.Count, 0) AS CommentCount,
        COALESCE(V.TotalVotes, 0) AS TotalVotes,
        P.Score,
        P.CreationDate,
        (SELECT COUNT(*) FROM PostHistory PH WHERE PH.PostId = P.Id) AS HistoryCount
    FROM
        Posts P
    LEFT JOIN (
        SELECT PostId, COUNT(*) AS Count
        FROM Comments
        GROUP BY PostId
    ) C ON C.PostId = P.Id
    LEFT JOIN (
        SELECT PostId, COUNT(*) AS TotalVotes
        FROM Votes
        GROUP BY PostId
    ) V ON V.PostId = P.Id
    WHERE
        P.CreationDate >= TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '1 year'
)
SELECT
    U.DisplayName AS UserName,
    U.Reputation,
    U.CreationDate AS UserCreationDate,
    P.Title AS PostTitle,
    P.Score AS PostScore,
    COALESCE(Tags.TagName, 'No Tags') AS PostTags,
    P.CommentCount,
    P.TotalVotes,
    P.HistoryCount,
    VoteHistory.VoteDate AS LastVoteDate,
    CASE 
        WHEN VoteHistory.VoteRank = 1 THEN 'Most Recent Vote'
        ELSE NULL
    END AS VoteStatus
FROM
    Users U
JOIN
    RecursiveUserVoteHistory VoteHistory ON U.Id = VoteHistory.UserId
JOIN
    PostActivitySummary P ON VoteHistory.PostId = P.PostId
LEFT JOIN (
    SELECT
        T.TagName,
        PT.PostId
    FROM
        FrequentTags FT
    JOIN
        Tags T ON T.TagName = FT.TagName
    JOIN
        Posts PT ON PT.Tags LIKE '%' || T.TagName || '%'
) Tags ON Tags.PostId = P.PostId
WHERE
    VoteHistory.VoteRank = 1
ORDER BY
    U.Reputation DESC,
    P.Score DESC
LIMIT 50;
