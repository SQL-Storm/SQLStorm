WITH UserVotes AS (
    SELECT 
        v.UserId,
        COUNT(CASE WHEN v.VoteTypeId = 2 THEN 1 END) AS UpVotesCount,
        COUNT(CASE WHEN v.VoteTypeId = 3 THEN 1 END) AS DownVotesCount,
        SUM(CASE WHEN v.VoteTypeId = 8 THEN v.BountyAmount ELSE 0 END) AS TotalBounty
    FROM Votes v
    GROUP BY v.UserId
),
TopUsers AS (
    SELECT 
        u.Id,
        u.DisplayName,
        u.Reputation,
        uv.UpVotesCount,
        uv.DownVotesCount,
        uv.TotalBounty,
        RANK() OVER (ORDER BY u.Reputation DESC) AS UserRank
    FROM Users u
    JOIN UserVotes uv ON u.Id = uv.UserId
),
PopularPosts AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.Score,
        p.ViewCount,
        COUNT(c.Id) AS CommentCount
    FROM Posts p
    LEFT JOIN Comments c ON p.Id = c.PostId
    WHERE p.CreationDate >= cast('2024-10-01 12:34:56' as timestamp) - INTERVAL '30 days'
    GROUP BY p.Id
    HAVING COUNT(c.Id) > 0
),
TopPosts AS (
    SELECT 
        pp.PostId,
        pp.Title,
        pp.Score,
        pp.ViewCount,
        pp.CommentCount,
        RANK() OVER (ORDER BY pp.Score DESC) AS PostRank
    FROM PopularPosts pp
)
SELECT 
    tu.DisplayName AS UserName,
    tu.Reputation,
    tu.UpVotesCount,
    tu.DownVotesCount,
    tu.TotalBounty,
    tp.Title AS TopPostTitle,
    tp.Score AS PostScore,
    tp.ViewCount AS PostViews,
    tp.CommentCount AS PostComments
FROM TopUsers tu
JOIN TopPosts tp ON tu.UserRank = 1
WHERE tu.UpVotesCount > 10
ORDER BY tu.Reputation DESC, tp.PostScore DESC;