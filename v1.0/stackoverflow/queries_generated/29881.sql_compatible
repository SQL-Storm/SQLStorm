
WITH UserStats AS (
    SELECT 
        U.Id AS UserId,
        U.DisplayName,
        U.Reputation,
        COUNT(DISTINCT P.Id) AS PostCount,
        SUM(CASE WHEN P.PostTypeId = 1 THEN 1 ELSE 0 END) AS QuestionsCount,
        SUM(CASE WHEN P.PostTypeId = 2 THEN 1 ELSE 0 END) AS AnswersCount,
        SUM(CASE WHEN P.UpVotes > P.DownVotes THEN 1 ELSE 0 END) AS PositiveVotes,
        SUM(B.Class) AS BadgePoints
    FROM 
        Users U
    LEFT JOIN 
        Posts P ON U.Id = P.OwnerUserId
    LEFT JOIN 
        Badges B ON U.Id = B.UserId
    WHERE 
        U.Reputation > 100
    GROUP BY 
        U.Id, U.DisplayName, U.Reputation
),
TopUsers AS (
    SELECT 
        UserId,
        DisplayName,
        Reputation,
        PostCount,
        QuestionsCount,
        AnswersCount,
        PositiveVotes,
        BadgePoints,
        RANK() OVER (ORDER BY Reputation DESC, PostCount DESC) AS Rank
    FROM 
        UserStats
),
MostTaggedQuestions AS (
    SELECT 
        P.Id AS PostId,
        P.Title,
        P.Tags,
        COUNT(DISTINCT T.Id) AS TagCount
    FROM 
        Posts P
    JOIN 
        Tags T ON POSITION(CONCAT('<', T.TagName, '>') IN P.Tags) > 0
    WHERE 
        P.PostTypeId = 1 
    GROUP BY 
        P.Id, P.Title, P.Tags
    HAVING 
        COUNT(DISTINCT T.Id) > 3
),
CombinedData AS (
    SELECT 
        TU.UserId,
        TU.DisplayName,
        TU.Reputation,
        TU.PostCount,
        TU.QuestionsCount,
        TU.AnswersCount,
        TU.PositiveVotes,
        TU.BadgePoints,
        MQ.Title AS MostTaggedQuestionTitle,
        MQ.TagCount
    FROM 
        TopUsers TU
    LEFT JOIN 
        MostTaggedQuestions MQ ON TU.UserId = (SELECT OwnerUserId FROM Posts WHERE Id = (SELECT MIN(PostId) FROM PostHistory WHERE PostHistoryTypeId = 10))
)

SELECT 
    CD.DisplayName,
    CD.Reputation,
    CD.PostCount,
    CD.QuestionsCount,
    CD.AnswersCount,
    CD.PositiveVotes,
    CD.BadgePoints,
    CD.MostTaggedQuestionTitle,
    CD.TagCount,
    TU.Rank
FROM 
    CombinedData CD
JOIN 
    TopUsers TU ON CD.UserId = TU.UserId
WHERE 
    TU.Rank <= 10 
ORDER BY 
    CD.Reputation DESC, CD.PostCount DESC;
