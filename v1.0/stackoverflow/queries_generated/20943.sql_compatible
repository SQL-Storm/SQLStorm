
WITH UserReputationRanks AS (
    SELECT 
        U.Id AS UserId,
        U.DisplayName,
        U.Reputation,
        RANK() OVER (ORDER BY U.Reputation DESC) AS ReputationRank
    FROM 
        Users U
),
PostStatistics AS (
    SELECT 
        P.Id AS PostId,
        P.Title,
        P.Score,
        COALESCE(P.ViewCount, 0) AS ViewCount,
        COALESCE(P.AnswerCount, 0) AS AnswerCount,
        COALESCE(P.CommentCount, 0) AS CommentCount,
        COALESCE(P.FavoriteCount, 0) AS FavoriteCount,
        P.CreationDate,
        PT.Name AS PostType,
        U.DisplayName AS OwnerDisplayName
    FROM 
        Posts P
    JOIN 
        PostTypes PT ON P.PostTypeId = PT.Id
    LEFT JOIN 
        Users U ON P.OwnerUserId = U.Id
),
ClosedPostHistory AS (
    SELECT 
        PH.PostId,
        MIN(PH.CreationDate) AS FirstClosedDate,
        COUNT(*) AS CloseCount
    FROM 
        PostHistory PH
    WHERE 
        PH.PostHistoryTypeId IN (10, 11)  
    GROUP BY 
        PH.PostId
),
RankedPosts AS (
    SELECT 
        PS.PostId,
        PS.Title,
        PS.Score,
        PS.ViewCount,
        PS.AnswerCount,
        PS.CommentCount,
        PS.FavoriteCount,
        CPH.FirstClosedDate,
        CPH.CloseCount,
        UP.ReputationRank
    FROM 
        PostStatistics PS
    LEFT JOIN 
        ClosedPostHistory CPH ON PS.PostId = CPH.PostId
    JOIN 
        Users U ON PS.OwnerDisplayName = U.DisplayName
    JOIN 
        UserReputationRanks UP ON U.Id = UP.UserId
    WHERE 
        PS.Score > (SELECT AVG(Score) FROM Posts)  
)
SELECT 
    RP.PostId,
    RP.Title,
    RP.Score,
    RP.ViewCount,
    RP.AnswerCount,
    RP.CommentCount,
    RP.FavoriteCount,
    RP.FirstClosedDate,
    RP.CloseCount,
    RP.ReputationRank,
    CASE 
        WHEN RP.FirstClosedDate IS NOT NULL THEN 'Yes' 
        ELSE 'No' 
    END AS IsClosed,
    CONCAT(UP.DisplayName, ' (Rank ', RP.ReputationRank, ')') AS OwnerDetails
FROM 
    RankedPosts RP
LEFT JOIN 
    Users UP ON RP.OwnerDisplayName = UP.DisplayName  
WHERE 
    RP.CloseCount IS NULL OR RP.CloseCount = 0  
ORDER BY 
    RP.Score DESC, 
    RP.ViewCount DESC;
