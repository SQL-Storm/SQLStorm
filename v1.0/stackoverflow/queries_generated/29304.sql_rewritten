WITH TagStats AS (
    SELECT 
        t.TagName,
        COUNT(p.Id) AS PostCount,
        SUM(CASE WHEN pt.Name = 'Question' THEN 1 ELSE 0 END) AS QuestionCount,
        SUM(CASE WHEN pt.Name = 'Answer' THEN 1 ELSE 0 END) AS AnswerCount,
        SUM(CASE WHEN pt.Name = 'Wiki' THEN 1 ELSE 0 END) AS WikiCount
    FROM 
        Tags t
        LEFT JOIN Posts p ON t.Id = ANY(string_to_array(p.Tags, ',')::int[])
        LEFT JOIN PostTypes pt ON p.PostTypeId = pt.Id
    GROUP BY 
        t.TagName
),
UserActivity AS (
    SELECT 
        u.DisplayName,
        SUM(p.ViewCount) AS TotalViews,
        SUM(CASE WHEN v.VoteTypeId = 2 THEN 1 ELSE 0 END) AS TotalUpvotes,
        SUM(CASE WHEN v.VoteTypeId = 3 THEN 1 ELSE 0 END) AS TotalDownvotes,
        COUNT(DISTINCT p.Id) AS TotalPosts
    FROM 
        Users u
        LEFT JOIN Posts p ON u.Id = p.OwnerUserId
        LEFT JOIN Votes v ON p.Id = v.PostId
    GROUP BY 
        u.DisplayName
),
PostEngagement AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        COUNT(c.Id) AS CommentCount,
        COUNT(DISTINCT v.UserId) AS VoteCount,
        MAX(p.CreationDate) as LastActivity
    FROM 
        Posts p
        LEFT JOIN Comments c ON p.Id = c.PostId
        LEFT JOIN Votes v ON p.Id = v.PostId
    WHERE 
        p.CreationDate >= cast('2024-10-01 12:34:56' as timestamp) - INTERVAL '1 year' 
    GROUP BY 
        p.Id, p.Title
),
TopTags AS (
    SELECT 
        ts.TagName,
        ts.PostCount,
        ts.QuestionCount,
        ts.AnswerCount,
        ts.WikiCount,
        ROW_NUMBER() OVER (ORDER BY ts.PostCount DESC) AS Rank
    FROM 
        TagStats ts
)
SELECT 
    ua.DisplayName,
    ua.TotalViews,
    ua.TotalUpvotes,
    ua.TotalDownvotes,
    ua.TotalPosts,
    pt.PostId,
    pt.Title,
    pt.CommentCount,
    pt.VoteCount,
    pt.LastActivity,
    tt.TagName,
    tt.PostCount AS TagPostCount,
    tt.QuestionCount AS TagQuestionCount,
    tt.AnswerCount AS TagAnswerCount,
    tt.WikiCount AS TagWikiCount
FROM 
    UserActivity ua
    JOIN PostEngagement pt ON ua.TotalPosts > 0
    LEFT JOIN TopTags tt ON pt.Title ILIKE '%' || tt.TagName || '%'
WHERE 
    tt.Rank <= 10
ORDER BY 
    ua.TotalViews DESC;