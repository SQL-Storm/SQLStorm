
WITH UserActivity AS (
    SELECT 
        u.Id AS UserId,
        u.DisplayName,
        COUNT(DISTINCT p.Id) AS TotalPosts,
        COUNT(DISTINCT CASE WHEN p.PostTypeId = 1 THEN p.Id END) AS Questions,
        COUNT(DISTINCT CASE WHEN p.PostTypeId = 2 THEN p.Id END) AS Answers,
        SUM(COALESCE(p.ViewCount, 0)) AS TotalViews,
        SUM(COALESCE(c.Score, 0)) AS TotalCommentScore,
        SUM(COALESCE(v.BountyAmount, 0)) AS TotalBounty,
        DENSE_RANK() OVER (ORDER BY COUNT(DISTINCT p.Id) DESC) AS ActivityRank
    FROM Users u
    LEFT JOIN Posts p ON u.Id = p.OwnerUserId
    LEFT JOIN Comments c ON p.Id = c.PostId
    LEFT JOIN Votes v ON p.Id = v.PostId
    WHERE u.Reputation > 1000 
    GROUP BY u.Id, u.DisplayName
),
PopularTags AS (
    SELECT 
        TRIM(SUBSTRING_INDEX(SUBSTRING_INDEX(p.Tags, '>', n.n), '<', -1)) AS Tag,
        COUNT(p.Id) AS PostCount
    FROM Posts p
    JOIN (
        SELECT 1 AS n UNION ALL SELECT 2 UNION ALL SELECT 3 UNION ALL SELECT 4 
        UNION ALL SELECT 5 UNION ALL SELECT 6 UNION ALL SELECT 7 UNION ALL SELECT 8 
        UNION ALL SELECT 9 UNION ALL SELECT 10
    ) n ON LENGTH(p.Tags) - LENGTH(REPLACE(p.Tags, '>', '')) >= n.n - 1
    WHERE p.PostTypeId = 1 
    GROUP BY Tag
    ORDER BY PostCount DESC
    LIMIT 5
),
UserTagActivities AS (
    SELECT 
        ua.UserId,
        ut.Tag,
        COUNT(DISTINCT p.Id) AS PostsWithTag
    FROM UserActivity ua
    JOIN Posts p ON p.OwnerUserId = ua.UserId
    JOIN LATERAL (SELECT TRIM(SUBSTRING_INDEX(SUBSTRING_INDEX(t, '<', -1), '>', -1)) AS tag 
                   FROM string_to_array(p.Tags, '>') AS t) AS tags ON TRUE
    JOIN PopularTags ut ON tags.tag = ut.Tag
    GROUP BY ua.UserId, ut.Tag
)

SELECT 
    ua.UserId,
    ua.DisplayName,
    ua.TotalPosts,
    ua.Questions,
    ua.Answers,
    ua.TotalViews,
    ua.TotalCommentScore,
    ua.TotalBounty,
    ut.Tag AS MostActiveTag,
    COALESCE(uta.PostsWithTag, 0) AS UserPostsWithTag
FROM UserActivity ua
LEFT JOIN (
    SELECT UserId, Tag, MAX(PostsWithTag) AS PostsWithTag
    FROM UserTagActivities
    GROUP BY UserId, Tag
) uta ON ua.UserId = uta.UserId
ORDER BY ua.ActivityRank
LIMIT 10;
