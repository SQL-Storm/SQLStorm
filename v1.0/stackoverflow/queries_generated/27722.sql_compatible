
WITH TagStats AS (
    SELECT 
        T.TagName,
        COUNT(DISTINCT P.Id) AS PostCount,
        SUM(CASE WHEN P.PostTypeId = 1 THEN 1 ELSE 0 END) AS QuestionCount,
        SUM(CASE WHEN P.PostTypeId = 2 THEN 1 ELSE 0 END) AS AnswerCount,
        AVG(P.Score) AS AverageScore,
        STRING_AGG(DISTINCT U.DisplayName, ', ') AS ContributingUsers,
        COUNT(DISTINCT C.Id) AS TotalComments
    FROM Tags T
    LEFT JOIN Posts P ON P.Tags LIKE CONCAT('%', T.TagName, '%')
    LEFT JOIN Users U ON P.OwnerUserId = U.Id
    LEFT JOIN Comments C ON C.PostId = P.Id
    GROUP BY T.TagName
),
PostHistoryAggregate AS (
    SELECT 
        PH.PostId,
        STRING_AGG(PH.UserDisplayName, ', ') AS Editors,
        COUNT(CASE WHEN PH.PostHistoryTypeId IN (10, 11) THEN 1 END) AS CloseReopenCount,
        COUNT(CASE WHEN PH.PostHistoryTypeId = 12 THEN 1 END) AS DeleteCount,
        COUNT(CASE WHEN PH.PostHistoryTypeId = 19 THEN 1 END) AS ProtectCount,
        COUNT(CASE WHEN PH.PostHistoryTypeId = 20 THEN 1 END) AS UnprotectCount
    FROM PostHistory PH
    GROUP BY PH.PostId
),
FinalStats AS (
    SELECT 
        TS.TagName,
        TS.PostCount,
        TS.QuestionCount,
        TS.AnswerCount,
        TS.AverageScore,
        TS.ContributingUsers,
        PH.CloseReopenCount,
        PH.DeleteCount,
        PH.ProtectCount,
        PH.UnprotectCount
    FROM TagStats TS
    LEFT JOIN PostHistoryAggregate PH ON PH.PostId IN (
        SELECT Id FROM Posts WHERE Tags LIKE CONCAT('%', TS.TagName, '%')
    )
)
SELECT 
    FS.TagName,
    FS.PostCount,
    FS.QuestionCount,
    FS.AnswerCount,
    FS.AverageScore,
    FS.ContributingUsers,
    COALESCE(FS.CloseReopenCount, 0) AS CloseReopenCount,
    COALESCE(FS.DeleteCount, 0) AS DeleteCount,
    COALESCE(FS.ProtectCount, 0) AS ProtectCount,
    COALESCE(FS.UnprotectCount, 0) AS UnprotectCount
FROM FinalStats FS
ORDER BY FS.PostCount DESC, FS.AverageScore DESC;
