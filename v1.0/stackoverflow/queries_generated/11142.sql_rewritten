WITH UserVoteStats AS (
    SELECT 
        u.Id AS UserId,
        u.DisplayName,
        COUNT(v.Id) AS VoteCount,
        SUM(CASE WHEN v.VoteTypeId = 2 THEN 1 ELSE 0 END) AS UpvoteCount,
        SUM(CASE WHEN v.VoteTypeId = 3 THEN 1 ELSE 0 END) AS DownvoteCount
    FROM 
        Users u
    LEFT JOIN 
        Votes v ON u.Id = v.UserId
    GROUP BY 
        u.Id
),
PostActivityStats AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        COUNT(c.Id) AS CommentCount,
        COUNT(v.Id) AS VoteCount,
        SUM(CASE WHEN v.VoteTypeId = 2 THEN 1 ELSE 0 END) AS Upvotes,
        SUM(CASE WHEN v.VoteTypeId = 3 THEN 1 ELSE 0 END) AS Downvotes
    FROM 
        Posts p
    LEFT JOIN 
        Comments c ON p.Id = c.PostId
    LEFT JOIN 
        Votes v ON p.Id = v.PostId
    GROUP BY 
        p.Id
),
PostHistoryStats AS (
    SELECT 
        ph.PostId,
        COUNT(ph.Id) AS EditCount,
        MAX(ph.CreationDate) AS LastEditDate
    FROM 
        PostHistory ph
    GROUP BY 
        ph.PostId
)
SELECT 
    u.DisplayName AS UserName,
    ups.VoteCount AS UserVoteCount,
    ups.UpvoteCount AS UserUpvoteCount,
    ups.DownvoteCount AS UserDownvoteCount,
    ps.PostId,
    ps.Title AS PostTitle,
    ps.CommentCount AS PostCommentCount,
    ps.VoteCount AS PostVoteCount,
    ps.Upvotes AS PostUpvotes,
    ps.Downvotes AS PostDownvotes,
    phs.EditCount AS PostEditCount,
    phs.LastEditDate AS PostLastEditDate
FROM 
    UserVoteStats ups
JOIN 
    PostActivityStats ps ON TRUE
LEFT JOIN 
    PostHistoryStats phs ON ps.PostId = phs.PostId
WHERE 
    ups.UserId IN (SELECT Id FROM Users WHERE Reputation > 1000)  
ORDER BY 
    ps.PostVoteCount DESC, 
    ps.CommentCount DESC;