WITH RankedPosts AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        u.DisplayName AS Author,
        p.CreationDate,
        p.Score,
        COUNT(c.Id) AS CommentCount,
        ROW_NUMBER() OVER (PARTITION BY p.Id ORDER BY p.CreationDate DESC) AS rn
    FROM 
        Posts p
    JOIN 
        Users u ON p.OwnerUserId = u.Id
    LEFT JOIN 
        Comments c ON p.Id = c.PostId
    GROUP BY 
        p.Id, u.DisplayName
),
TopPosts AS (
    SELECT 
        PostId,
        Title,
        Author,
        CreationDate,
        Score,
        CommentCount
    FROM 
        RankedPosts
    WHERE 
        rn = 1 AND CommentCount > 5
),
ClosedPosts AS (
    SELECT 
        ph.PostId, 
        ph.CreationDate AS ClosedDate, 
        COALESCE(rp.Title, 'Unknown Title') AS Title
    FROM 
        PostHistory ph
    LEFT JOIN 
        Posts rp ON ph.PostId = rp.Id
    WHERE 
        ph.PostHistoryTypeId = 10 
)
SELECT 
    tp.Title,
    tp.Author,
    tp.CreationDate,
    tp.Score,
    COALESCE(cp.ClosedDate, 'Not Closed') AS StatusDate,
    CASE 
        WHEN cp.ClosedDate IS NOT NULL THEN 'Closed'
        ELSE 'Active'
    END AS PostStatus,
    SUM(v.BountyAmount) AS TotalBounty
FROM 
    TopPosts tp
LEFT JOIN 
    ClosedPosts cp ON tp.PostId = cp.PostId
LEFT JOIN 
    Votes v ON tp.PostId = v.PostId AND v.VoteTypeId = 8 
GROUP BY 
    tp.PostId, tp.Title, tp.Author, tp.CreationDate, tp.Score, cp.ClosedDate
ORDER BY 
    tp.Score DESC, tp.CommentCount DESC;