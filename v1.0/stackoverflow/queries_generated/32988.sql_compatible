
WITH RecursivePosts AS (
    SELECT 
        p.Id AS PostId,
        p.OwnerUserId,
        p.Title,
        p.PostTypeId,
        COALESCE(p.AcceptedAnswerId, 0) AS AcceptedAnswerId,
        0 AS Level
    FROM 
        Posts p
    WHERE 
        p.ParentId IS NULL 

    UNION ALL 

    SELECT 
        p.Id AS PostId,
        p.OwnerUserId,
        p.Title,
        p.PostTypeId,
        COALESCE(p.AcceptedAnswerId, 0) AS AcceptedAnswerId,
        rp.Level + 1 
    FROM 
        Posts p
    INNER JOIN 
        RecursivePosts rp ON p.ParentId = rp.PostId
),
PostVotes AS (
    SELECT 
        PostId,
        COUNT(CASE WHEN VoteTypeId = 2 THEN 1 END) AS UpVotes,
        COUNT(CASE WHEN VoteTypeId = 3 THEN 1 END) AS DownVotes,
        COUNT(CASE WHEN VoteTypeId = 10 THEN 1 END) AS Deletions
    FROM 
        Votes
    GROUP BY 
        PostId
),
RecentPostEdits AS (
    SELECT 
        PostId,
        COUNT(*) AS EditCount,
        MAX(CreationDate) AS LastEditDate
    FROM 
        PostHistory
    WHERE 
        PostHistoryTypeId IN (4, 5, 6)
    GROUP BY 
        PostId
),
TopUsers AS (
    SELECT 
        u.Id,
        u.DisplayName,
        SUM(CASE WHEN ph.PostHistoryTypeId IN (10, 11) THEN 1 ELSE 0 END) AS CloseReopenCount
    FROM 
        Users u
    LEFT JOIN 
        PostHistory ph ON u.Id = ph.UserId
    GROUP BY 
        u.Id, u.DisplayName
    ORDER BY 
        CloseReopenCount DESC
    LIMIT 10
)
SELECT 
    rp.PostId,
    rp.Title,
    rp.OwnerUserId,
    u.DisplayName AS OwnerDisplayName,
    rp.Level,
    COALESCE(pv.UpVotes, 0) AS UpVotes,
    COALESCE(pv.DownVotes, 0) AS DownVotes,
    COALESCE(rv.EditCount, 0) AS RecentEditCount,
    COALESCE(rv.LastEditDate, '1970-01-01') AS LastEditDate,
    t.DisplayName AS TopUserDisplayName,
    t.CloseReopenCount
FROM 
    RecursivePosts rp
LEFT JOIN 
    Users u ON rp.OwnerUserId = u.Id
LEFT JOIN 
    PostVotes pv ON rp.PostId = pv.PostId
LEFT JOIN 
    RecentPostEdits rv ON rp.PostId = rv.PostId
LEFT JOIN 
    TopUsers t ON u.Id = t.Id
WHERE 
    rp.PostTypeId = 1  
ORDER BY 
    rp.Level ASC, 
    UpVotes DESC
LIMIT 100;
