WITH RankedPosts AS (
    SELECT
        p.Id AS PostId,
        p.Title,
        p.CreationDate,
        p.Score,
        p.ViewCount,
        p.AnswerCount,
        RANK() OVER (PARTITION BY p.PostTypeId ORDER BY p.Score DESC) AS RankByScore,
        ROW_NUMBER() OVER (PARTITION BY p.PostTypeId ORDER BY p.CreationDate DESC) AS RecentPosts
    FROM
        Posts p
    WHERE
        p.CreationDate >= DATEADD(YEAR, -1, GETDATE())
),
ActiveUsers AS (
    SELECT
        u.Id AS UserId,
        u.DisplayName,
        u.Reputation,
        u.Views,
        COUNT(DISTINCT p.Id) AS PostCount,
        SUM(v.BountyAmount) AS TotalBounties
    FROM
        Users u
    LEFT JOIN
        Posts p ON u.Id = p.OwnerUserId
    LEFT JOIN
        Votes v ON p.Id = v.PostId AND v.VoteTypeId IN (8, 9)  
    WHERE
        u.LastAccessDate >= DATEADD(MONTH, -6, GETDATE())
    GROUP BY
        u.Id, u.DisplayName, u.Reputation, u.Views
),
TagStatistics AS (
    SELECT
        t.TagName,
        COUNT(p.Id) AS PostCount,
        AVG(COALESCE(p.ViewCount, 0)) AS AvgViews,
        SUM(COALESCE(p.Score, 0)) AS TotalScore
    FROM
        Tags t
    LEFT JOIN
        Posts p ON p.Tags LIKE CONCAT('%', t.TagName, '%')
    GROUP BY
        t.TagName
)
SELECT
    u.DisplayName AS ActiveUser,
    u.Reputation,
    r.PostId,
    r.Title,
    r.CreationDate,
    r.Score AS PostScore,
    r.ViewCount,
    ts.TagName,
    ts.PostCount AS TagPostCount,
    ts.AvgViews AS AverageTagViews,
    u.TotalBounties
FROM
    ActiveUsers u
JOIN
    RankedPosts r ON u.PostCount > 0
LEFT JOIN
    TagStatistics ts ON ts.PostCount > 10  
WHERE
    r.RankByScore <= 5  
ORDER BY
    u.Reputation DESC, r.Score DESC, ts.TagPostCount DESC;