
WITH PostStats AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.CreationDate,
        p.ViewCount,
        p.Score,
        p.AnswerCount,
        COALESCE(c.CommentCount, 0) AS CommentCount,
        u.Reputation AS OwnerReputation,
        pt.Name AS PostType,
        COUNT(v.Id) AS VoteCount
    FROM 
        Posts p
    LEFT JOIN 
        Comments c ON c.PostId = p.Id
    LEFT JOIN 
        Users u ON u.Id = p.OwnerUserId
    LEFT JOIN 
        PostTypes pt ON pt.Id = p.PostTypeId
    LEFT JOIN 
        Votes v ON v.PostId = p.Id
    GROUP BY 
        p.Id, p.Title, p.CreationDate, p.ViewCount, p.Score, p.AnswerCount, u.Reputation, c.CommentCount, pt.Name
),
AverageStats AS (
    SELECT 
        AVG(ViewCount) AS AvgViewCount,
        AVG(Score) AS AvgScore,
        AVG(AnswerCount) AS AvgAnswerCount,
        AVG(CommentCount) AS AvgCommentCount,
        AVG(OwnerReputation) AS AvgOwnerReputation,
        AVG(VoteCount) AS AvgVoteCount
    FROM 
        PostStats
)
SELECT 
    ps.PostId,
    ps.Title,
    ps.ViewCount,
    ps.Score,
    ps.AnswerCount,
    ps.CommentCount,
    ps.OwnerReputation,
    ps.PostType,
    ps.VoteCount,
    as.AvgViewCount,
    as.AvgScore,
    as.AvgAnswerCount,
    as.AvgCommentCount,
    as.AvgOwnerReputation,
    as.AvgVoteCount
FROM 
    PostStats ps
CROSS JOIN 
    AverageStats as
ORDER BY 
    ps.ViewCount DESC
FETCH FIRST 100 ROWS ONLY;
