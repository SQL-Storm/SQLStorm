
WITH RankedBadges AS (
    SELECT 
        b.UserId,
        b.Name AS BadgeName,
        b.Class,
        ROW_NUMBER() OVER (PARTITION BY b.UserId ORDER BY b.Date DESC) AS BadgeRank
    FROM Badges b
),
MostActivePosts AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.ViewCount,
        COUNT(c.Id) AS CommentCount,
        COALESCE(SUM(v.BountyAmount), 0) AS TotalBounty,
        ROW_NUMBER() OVER (ORDER BY COUNT(c.Id) DESC, COALESCE(SUM(v.BountyAmount), 0) DESC) AS ActivityRank
    FROM Posts p
    LEFT JOIN Comments c ON p.Id = c.PostId
    LEFT JOIN Votes v ON p.Id = v.PostId AND v.VoteTypeId IN (8, 9) 
    WHERE p.PostTypeId = 1 
    GROUP BY p.Id, p.Title, p.ViewCount
),
UserReputation AS (
    SELECT 
        u.Id AS UserId,
        u.DisplayName,
        COALESCE(SUM(b.Class), 0) AS TotalBadgeClass,
        COALESCE(AVG(r.Reputation), 0) AS AverageReputation,
        COUNT(DISTINCT p.Id) AS QuestionsAsked
    FROM Users u
    LEFT JOIN RankedBadges b ON u.Id = b.UserId AND b.BadgeRank = 1 
    LEFT JOIN Posts p ON u.Id = p.OwnerUserId
    LEFT JOIN Votes r ON r.UserId = u.Id
    GROUP BY u.Id, u.DisplayName
),
TopUsers AS (
    SELECT 
        ur.UserId,
        ur.DisplayName,
        ur.AverageReputation,
        ur.QuestionsAsked,
        ROW_NUMBER() OVER (ORDER BY ur.AverageReputation DESC, ur.QuestionsAsked DESC) AS UserRank
    FROM UserReputation ur
)
SELECT 
    tu.DisplayName,
    tu.AverageReputation,
    tu.QuestionsAsked,
    mp.Title AS MostActivePost,
    mp.CommentCount,
    mp.TotalBounty,
    rb.BadgeName
FROM TopUsers tu
JOIN MostActivePosts mp ON mp.ActivityRank <= 10
LEFT JOIN RankedBadges rb ON tu.UserId = rb.UserId
WHERE tu.UserRank <= 5
ORDER BY tu.AverageReputation DESC, tu.QuestionsAsked DESC;
