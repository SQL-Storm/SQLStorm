WITH RecursivePostCTE AS (
    SELECT 
        p.Id,
        p.Title,
        p.OwnerUserId,
        p.CreationDate,
        p.Score,
        0 AS Level,
        CAST(p.Title AS VARCHAR(MAX)) AS FullHierarchy
    FROM Posts p
    WHERE p.ParentId IS NULL
    
    UNION ALL
    
    SELECT 
        p.Id,
        p.Title,
        p.OwnerUserId,
        p.CreationDate,
        p.Score,
        r.Level + 1,
        CAST(r.FullHierarchy + ' -> ' + p.Title AS VARCHAR(MAX))
    FROM Posts p
    INNER JOIN RecursivePostCTE r ON p.ParentId = r.Id
)

SELECT 
    u.DisplayName AS UserName,
    COUNT(DISTINCT p.Id) AS TotalPosts,
    SUM(p.Score) AS TotalScore,
    AVG(p.Score) AS AverageScore,
    STRING_AGG(DISTINCT t.TagName, ', ') AS Tags,
    MAX(b.Name) AS HighestBadge,
    MIN(COALESCE(c.Text, 'No comments')) AS FirstComment,
    MAX(rp.FullHierarchy) AS PostHierarchy
FROM Users u
LEFT JOIN Posts p ON u.Id = p.OwnerUserId
LEFT JOIN Tags t ON t.ExcerptPostId = p.Id
LEFT JOIN Badges b ON u.Id = b.UserId
LEFT JOIN Comments c ON c.PostId = p.Id
LEFT JOIN RecursivePostCTE rp ON rp.OwnerUserId = u.Id
WHERE u.Reputation >= 1000
GROUP BY u.DisplayName
HAVING COUNT(DISTINCT p.Id) > 10 
   AND MAX(p.CreationDate) < cast('2024-10-01 12:34:56' as timestamp) - INTERVAL '30 days'
ORDER BY TotalPosts DESC, TotalScore DESC
OFFSET 0 ROWS FETCH NEXT 5 ROWS ONLY;