
WITH RankedPosts AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.Body,
        p.CreationDate,
        u.DisplayName AS OwnerDisplayName,
        COUNT(a.Id) AS AnswerCount,
        STRING_AGG(DISTINCT t.TagName, ', ') AS Tags,
        ROW_NUMBER() OVER (PARTITION BY u.Id ORDER BY p.CreationDate DESC) AS UserPostRank
    FROM 
        Posts p
    JOIN 
        Users u ON p.OwnerUserId = u.Id
    LEFT JOIN 
        Posts a ON p.Id = a.ParentId AND a.PostTypeId = 2
    LEFT JOIN 
        Tags t ON t.Id IN (
            SELECT unnest(STRING_TO_ARRAY(TRIM(BOTH '<>' FROM p.Tags), '>'))
        )
    GROUP BY 
        p.Id, p.Title, p.Body, p.CreationDate, u.DisplayName
),
RecentClosePosts AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        H.CreationDate AS CloseDate,
        H.Comment AS CloseReason,
        u.DisplayName AS ModeratorDisplayName
    FROM 
        Posts p
    JOIN 
        PostHistory H ON p.Id = H.PostId AND H.PostHistoryTypeId = 10
    JOIN 
        Users u ON H.UserId = u.Id
    WHERE 
        H.CreationDate > CURRENT_DATE - INTERVAL '30 days'
),
TopModerators AS (
    SELECT 
        userId,
        COUNT(*) AS CloseCount
    FROM 
        PostHistory
    WHERE 
        PostHistoryTypeId = 10
    GROUP BY 
        userId
    ORDER BY 
        CloseCount DESC
    LIMIT 5
)
SELECT 
    rp.PostId,
    rp.Title,
    rp.Body,
    rp.CreationDate,
    rp.OwnerDisplayName,
    rp.AnswerCount,
    rp.Tags,
    rcp.CloseDate,
    rcp.CloseReason,
    rcp.ModeratorDisplayName,
    tm.CloseCount AS ModeratorCloseCount
FROM 
    RankedPosts rp
LEFT JOIN 
    RecentClosePosts rcp ON rp.PostId = rcp.PostId
LEFT JOIN 
    TopModerators tm ON rcp.ModeratorDisplayName = (SELECT DisplayName FROM Users WHERE Id = tm.userId)
WHERE 
    rp.UserPostRank = 1
ORDER BY 
    rp.CreationDate DESC;
