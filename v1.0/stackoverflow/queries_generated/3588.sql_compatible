
WITH UserReputation AS (
    SELECT 
        u.Id AS UserId,
        u.Reputation,
        COUNT(b.Id) AS BadgeCount,
        SUM(CASE WHEN b.Class = 1 THEN 1 ELSE 0 END) AS GoldBadges,
        SUM(CASE WHEN b.Class = 2 THEN 1 ELSE 0 END) AS SilverBadges,
        SUM(CASE WHEN b.Class = 3 THEN 1 ELSE 0 END) AS BronzeBadges
    FROM 
        Users u
    LEFT JOIN 
        Badges b ON u.Id = b.UserId
    GROUP BY 
        u.Id, u.Reputation
),
PostStatistics AS (
    SELECT 
        p.OwnerUserId,
        COUNT(p.Id) AS PostCount,
        SUM(p.ViewCount) AS TotalViews,
        SUM(p.Score) AS TotalScore,
        AVG(p.Score) AS AvgScore
    FROM 
        Posts p
    WHERE 
        p.CreationDate >= TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '1 year'
    GROUP BY 
        p.OwnerUserId
),
CombinedStats AS (
    SELECT 
        u.Id AS UserId,
        u.DisplayName,
        COALESCE(ps.PostCount, 0) AS PostCount,
        COALESCE(ps.TotalViews, 0) AS TotalViews,
        COALESCE(ps.TotalScore, 0) AS TotalScore,
        COALESCE(ps.AvgScore, 0) AS AvgScore,
        ur.Reputation AS UserReputation,
        ur.BadgeCount AS UserBadgeCount,
        ur.GoldBadges,
        ur.SilverBadges,
        ur.BronzeBadges
    FROM 
        Users u
    LEFT JOIN 
        PostStatistics ps ON u.Id = ps.OwnerUserId
    LEFT JOIN 
        UserReputation ur ON u.Id = ur.UserId
)
SELECT 
    UserId,
    DisplayName,
    PostCount,
    TotalViews,
    TotalScore,
    AvgScore,
    UserReputation,
    UserBadgeCount,
    GoldBadges,
    SilverBadges,
    BronzeBadges
FROM 
    CombinedStats
WHERE 
    PostCount > 0
ORDER BY 
    UserReputation DESC, TotalScore DESC
LIMIT 10
UNION ALL
SELECT 
    p.OwnerUserId AS UserId,
    U.DisplayName,
    COUNT(p.Id) AS PostCount,
    0 AS TotalViews,
    0 AS TotalScore,
    0 AS AvgScore,
    ur.Reputation AS UserReputation,
    ur.BadgeCount AS UserBadgeCount,
    ur.GoldBadges,
    ur.SilverBadges,
    ur.BronzeBadges
FROM 
    Posts p
JOIN 
    Users U ON p.OwnerUserId = U.Id
LEFT JOIN 
    UserReputation ur ON U.Id = ur.UserId
WHERE 
    p.OwnerUserId IS NOT NULL AND p.Score < 0
GROUP BY 
    p.OwnerUserId, U.DisplayName, ur.Reputation, ur.BadgeCount, ur.GoldBadges, ur.SilverBadges, ur.BronzeBadges
ORDER BY 
    UserReputation DESC
LIMIT 5;
