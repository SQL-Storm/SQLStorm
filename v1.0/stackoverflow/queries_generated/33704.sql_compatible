
WITH RECURSIVE UserVotes AS (
    SELECT 
        U.Id AS UserId,
        U.DisplayName,
        COUNT(V.Id) AS TotalVotes
    FROM Users U
    LEFT JOIN Votes V ON U.Id = V.UserId
    GROUP BY U.Id, U.DisplayName
),
TopUsers AS (
    SELECT 
        UserId,
        DisplayName,
        TotalVotes,
        RANK() OVER (ORDER BY TotalVotes DESC) AS UserRank
    FROM UserVotes
),
PostStatistics AS (
    SELECT 
        P.Id AS PostId,
        P.Title,
        P.CreationDate,
        COALESCE(PV.TotalPostVotes, 0) AS TotalPostVotes,
        COALESCE(A.Count, 0) AS AnswerCount,
        COALESCE(C.Count, 0) AS CommentCount,
        ROW_NUMBER() OVER (ORDER BY P.CreationDate DESC) AS PostRank
    FROM Posts P
    LEFT JOIN (
        SELECT 
            PostId, 
            COUNT(*) AS TotalPostVotes
        FROM Votes 
        GROUP BY PostId
    ) PV ON P.Id = PV.PostId
    LEFT JOIN (
        SELECT 
            PostId,
            COUNT(*) AS Count
        FROM Comments 
        GROUP BY PostId
    ) C ON P.Id = C.PostId
    LEFT JOIN (
        SELECT 
            ParentId,
            COUNT(*) AS Count
        FROM Posts 
        WHERE PostTypeId = 2
        GROUP BY ParentId
    ) A ON P.Id = A.ParentId
)
SELECT 
    U.DisplayName AS TopVoter,
    P.Title AS PostTitle,
    P.CreationDate,
    P.TotalPostVotes,
    P.AnswerCount,
    P.CommentCount
FROM TopUsers U
JOIN Posts P ON P.OwnerUserId = U.UserId
JOIN PostStatistics PS ON PS.PostId = P.Id
WHERE U.UserRank <= 10
  AND PS.TotalPostVotes > 0
  AND P.CreationDate >= CURRENT_TIMESTAMP - INTERVAL '1 year' 
  AND P.CreationDate >= TIMESTAMP '2024-10-01 12:34:56'
ORDER BY U.TotalVotes DESC, P.CreationDate DESC;
