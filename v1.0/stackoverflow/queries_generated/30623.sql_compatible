
WITH RecursivePostHistory AS (
    SELECT 
        ph.Id,
        ph.PostId,
        ph.CreationDate,
        p.Title,
        ph.UserDisplayName,
        ph.Comment,
        ph.PostHistoryTypeId,
        CAST(NULL AS VARCHAR(50)) AS ParentUserDisplayName
    FROM 
        PostHistory ph
    JOIN 
        Posts p ON ph.PostId = p.Id
    WHERE 
        ph.PostHistoryTypeId IN (1, 2, 4, 6) 
    UNION ALL
    SELECT 
        ph.Id,
        ph.PostId,
        ph.CreationDate,
        p.Title,
        ph.UserDisplayName,
        ph.Comment,
        ph.PostHistoryTypeId,
        rph.UserDisplayName
    FROM 
        PostHistory ph
    JOIN 
        Posts p ON ph.PostId = p.Id
    JOIN 
        RecursivePostHistory rph ON ph.PostId = rph.PostId 
        AND ph.CreationDate < rph.CreationDate
    WHERE 
        ph.PostHistoryTypeId IN (4, 6) 
),
RecentPosts AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.CreationDate,
        p.LastActivityDate,
        COUNT(c.Id) AS CommentCount,
        SUM(CASE WHEN v.VoteTypeId = 2 THEN 1 ELSE 0 END) AS UpvoteCount
    FROM 
        Posts p
    LEFT JOIN 
        Comments c ON p.Id = c.PostId
    LEFT JOIN 
        Votes v ON p.Id = v.PostId
    WHERE 
        p.CreationDate > DATEADD(DAY, -30, '2024-10-01') 
    GROUP BY 
        p.Id, p.Title, p.CreationDate, p.LastActivityDate
),
TopPosts AS (
    SELECT 
        p.*,
        ROW_NUMBER() OVER (PARTITION BY p.PostTypeId ORDER BY p.ViewCount DESC) AS Rank
    FROM 
        Posts p
    WHERE 
        p.ViewCount IS NOT NULL
)
SELECT 
    pp.PostId,
    pp.Title,
    pp.CreationDate,
    pp.LastActivityDate,
    rp.UserDisplayName,
    rp.Comment,
    rp.PostHistoryTypeId,
    rp.ParentUserDisplayName,
    rpo.CommentCount,
    rpo.UpvoteCount
FROM 
    RecentPosts rpo
JOIN 
    RecursivePostHistory rp ON rpo.PostId = rp.PostId
JOIN 
    TopPosts pp ON pp.Id = rpo.PostId
WHERE 
    pp.Rank <= 10
    AND (rp.PostHistoryTypeId IS NULL OR rp.PostHistoryTypeId NOT IN (10, 12)) 
ORDER BY 
    rpo.UpvoteCount DESC, 
    rpo.CommentCount DESC;
