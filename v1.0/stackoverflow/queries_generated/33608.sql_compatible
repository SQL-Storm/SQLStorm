
WITH RECURSIVE UserPostStats AS (
    SELECT 
        u.Id AS UserId,
        COUNT(p.Id) AS PostCount,
        SUM(CASE WHEN pt.Id = 1 THEN 1 ELSE 0 END) AS QuestionCount,
        SUM(CASE WHEN pt.Id = 2 THEN 1 ELSE 0 END) AS AnswerCount,
        SUM(CASE WHEN pt.Id = 1 THEN p.Score ELSE 0 END) AS TotalScore
    FROM Users u
    LEFT JOIN Posts p ON u.Id = p.OwnerUserId
    LEFT JOIN PostTypes pt ON p.PostTypeId = pt.Id
    WHERE u.Reputation >= 500
    GROUP BY u.Id
),
RankedUsers AS (
    SELECT 
        UserId,
        PostCount,
        QuestionCount,
        AnswerCount,
        TotalScore,
        RANK() OVER (ORDER BY TotalScore DESC) AS ScoreRank
    FROM UserPostStats
),
RecentPosts AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.CreationDate,
        p.LastActivityDate,
        p.Score,
        u.DisplayName AS OwnerName,
        ROW_NUMBER() OVER (PARTITION BY u.Id ORDER BY p.LastActivityDate DESC) AS RecentPostRank
    FROM Posts p
    JOIN Users u ON p.OwnerUserId = u.Id
    WHERE p.CreationDate > TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '7 days'
),
ActiveUsers AS (
    SELECT 
        u.Id AS UserId,
        u.DisplayName,
        BestScore.TotalScore,
        rp.PostId,
        rp.Title,
        rp.CreationDate,
        rp.RecentPostRank
    FROM Users u
    JOIN RankedUsers BestScore ON u.Id = BestScore.UserId
    LEFT JOIN RecentPosts rp ON u.DisplayName = rp.OwnerName
    WHERE BestScore.ScoreRank <= 10
)

SELECT 
    au.DisplayName,
    au.TotalScore,
    au.Title,
    au.CreationDate,
    COALESCE(p.Score, 0) AS RecentPostScore,
    CASE 
        WHEN au.TotalScore IS NULL THEN 'No Score'
        ELSE 'Score Present'
    END AS ScoreStatus,
    STRING_AGG(DISTINCT pt.Name, ', ') AS PostTypeNames
FROM ActiveUsers au
LEFT JOIN Posts p ON au.PostId = p.Id
LEFT JOIN PostTypes pt ON p.PostTypeId = pt.Id
LEFT JOIN Votes v ON p.Id = v.PostId AND v.VoteTypeId IN (2, 3)
WHERE au.RecentPostRank = 1 OR au.RecentPostRank IS NULL
GROUP BY au.DisplayName, au.TotalScore, au.Title, au.CreationDate
ORDER BY au.TotalScore DESC, au.DisplayName ASC;
