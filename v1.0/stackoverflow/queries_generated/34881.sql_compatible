
WITH RECURSIVE UserScoreRank AS (
    SELECT 
        Id AS UserId,
        Reputation,
        CreationDate,
        ROW_NUMBER() OVER (ORDER BY Reputation DESC) AS ReputationRank
    FROM Users
),
RecentVotes AS (
    SELECT 
        V.PostId,
        SUM(CASE WHEN V.VoteTypeId = 2 THEN 1 ELSE 0 END) AS UpVotes,
        SUM(CASE WHEN V.VoteTypeId = 3 THEN 1 ELSE 0 END) AS DownVotes
    FROM Votes V
    WHERE V.CreationDate >= CAST('2024-10-01 12:34:56' AS TIMESTAMP) - INTERVAL '30 DAY'
    GROUP BY V.PostId
),
PostAggregates AS (
    SELECT 
        P.Id AS PostId,
        P.Title,
        COALESCE(RV.UpVotes, 0) AS TotalUpVotes,
        COALESCE(RV.DownVotes, 0) AS TotalDownVotes,
        PT.Name AS PostType,
        P.AnswerCount,
        P.ViewCount,
        P.CreationDate
    FROM Posts P
    LEFT JOIN RecentVotes RV ON P.Id = RV.PostId
    INNER JOIN PostTypes PT ON P.PostTypeId = PT.Id
    WHERE P.ViewCount > 100 
),
PopularPosts AS (
    SELECT 
        PostId,
        Title,
        TotalUpVotes,
        TotalDownVotes,
        PostType,
        AnswerCount,
        ViewCount,
        CreationDate,
        RANK() OVER (ORDER BY TotalUpVotes DESC) AS RankByUpVotes
    FROM PostAggregates
),
PostHistorySummary AS (
    SELECT 
        PH.PostId,
        PH.PostHistoryTypeId,
        COUNT(*) AS ChangeCount,
        MAX(PH.CreationDate) AS LastChangeDate
    FROM PostHistory PH
    WHERE PH.CreationDate >= CAST('2024-10-01 12:34:56' AS TIMESTAMP) - INTERVAL '1 YEAR'
    GROUP BY PH.PostId, PH.PostHistoryTypeId
)
SELECT 
    PP.Title,
    PP.TotalUpVotes,
    PP.TotalDownVotes,
    PP.PostType,
    PP.AnswerCount,
    PP.ViewCount,
    UP.UserId,
    UP.Reputation,
    UP.ReputationRank,
    COALESCE(PHS.ChangeCount, 0) AS NumberOfChanges,
    COALESCE(PHS.LastChangeDate, 'No Changes') AS LastChange
FROM PopularPosts PP
LEFT JOIN UserScoreRank UP ON PP.PostId IN (SELECT ParentId FROM Posts WHERE AcceptAnswerId = PP.PostId)
LEFT JOIN PostHistorySummary PHS ON PP.PostId = PHS.PostId
WHERE PP.RankByUpVotes <= 10
ORDER BY PP.TotalUpVotes DESC;
