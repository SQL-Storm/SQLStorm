
WITH TagStats AS (
    SELECT 
        t.TagName,
        COUNT(p.Id) AS PostCount,
        SUM(COALESCE(p.ViewCount, 0)) AS TotalViews,
        MAX(p.CreationDate) AS MostRecentPostDate
    FROM 
        Tags t
    LEFT JOIN 
        Posts p ON p.Tags LIKE CONCAT('%', t.TagName, '%')
    GROUP BY 
        t.TagName
),
UserEngagement AS (
    SELECT 
        u.Id AS UserId,
        u.DisplayName,
        COUNT(DISTINCT c.Id) AS CommentCount,
        SUM(CASE WHEN v.VoteTypeId = 2 THEN 1 ELSE 0 END) AS UpVoteCount,
        SUM(CASE WHEN v.VoteTypeId = 3 THEN 1 ELSE 0 END) AS DownVoteCount
    FROM 
        Users u
    LEFT JOIN 
        Comments c ON c.UserId = u.Id
    LEFT JOIN 
        Votes v ON v.UserId = u.Id
    GROUP BY 
        u.Id, u.DisplayName
),
TopPosts AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.ViewCount,
        p.Score,
        u.DisplayName AS OwnerName
    FROM 
        Posts p
    JOIN 
        Users u ON p.OwnerUserId = u.Id
    WHERE 
        p.PostTypeId = 1
    ORDER BY 
        p.ViewCount DESC
    LIMIT 10
)

SELECT 
    ts.TagName,
    ts.PostCount,
    ts.TotalViews,
    ts.MostRecentPostDate,
    ue.DisplayName AS ActiveUser,
    ue.CommentCount AS UserCommentCount,
    ue.UpVoteCount,
    ue.DownVoteCount,
    tp.Title AS TopPostTitle,
    tp.ViewCount AS TopPostViews,
    tp.Score AS TopPostScore,
    tp.OwnerName AS TopPostOwner
FROM 
    TagStats ts
JOIN 
    UserEngagement ue ON ue.CommentCount > 0
JOIN 
    TopPosts tp ON tp.ViewCount > 1000
ORDER BY 
    ts.TotalViews DESC, ue.UpVoteCount DESC;
