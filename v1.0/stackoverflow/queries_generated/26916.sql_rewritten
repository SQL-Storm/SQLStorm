WITH RankedPosts AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.ViewCount,
        p.Score,
        p.CreationDate,
        p.Tags,
        p.AnswerCount,
        ROW_NUMBER() OVER (PARTITION BY p.OwnerUserId ORDER BY p.ViewCount DESC) AS ViewRank
    FROM Posts p
    WHERE p.PostTypeId = 1 
),  
TagStats AS (
    SELECT 
        UNNEST(string_to_array(SUBSTRING(p.Tags, 2, LENGTH(p.Tags)-2), '><')) AS TagName, 
        COUNT(*) AS PostCount,
        SUM(CASE WHEN p.Score > 0 THEN 1 ELSE 0 END) AS PositiveScoreCount,
        AVG(p.Score) AS AvgScore
    FROM Posts p
    WHERE p.PostTypeId = 1 
    GROUP BY TagName
), 
TopUsers AS (
    SELECT 
        u.Id AS UserId,
        u.DisplayName,
        COUNT(DISTINCT p.Id) AS QuestionsAnswered,
        SUM(v.BountyAmount) AS TotalBounty
    FROM Users u 
    JOIN Posts p ON u.Id = p.OwnerUserId
    JOIN Votes v ON v.PostId = p.Id
    WHERE p.PostTypeId = 2 
    GROUP BY u.Id
)

SELECT 
    rp.Title,
    rp.ViewCount,
    rp.Score,
    ts.TagName,
    ts.PostCount,
    ts.PositiveScoreCount,
    ts.AvgScore,
    tu.DisplayName,
    tu.QuestionsAnswered,
    tu.TotalBounty
FROM RankedPosts rp
JOIN TagStats ts ON rp.Tags LIKE '%' || ts.TagName || '%'
JOIN TopUsers tu ON tu.UserId = (SELECT OwnerUserId FROM Posts WHERE Id = rp.PostId)
WHERE rp.ViewRank = 1
ORDER BY ts.PostCount DESC, rp.ViewCount DESC;