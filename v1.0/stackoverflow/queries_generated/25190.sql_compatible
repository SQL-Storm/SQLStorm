
WITH user_post_activity AS (
    SELECT 
        u.Id AS UserId,
        u.DisplayName,
        COUNT(p.Id) AS TotalPosts,
        COUNT(DISTINCT c.Id) AS TotalComments,
        SUM(CASE WHEN p.PostTypeId = 1 THEN 1 ELSE 0 END) AS QuestionsPosted,
        SUM(CASE WHEN p.PostTypeId = 2 THEN 1 ELSE 0 END) AS AnswersPosted,
        SUM(CASE WHEN p.UpVotes > 0 THEN 1 ELSE 0 END) AS UpVotesReceived,
        SUM(CASE WHEN p.DownVotes > 0 THEN 1 ELSE 0 END) AS DownVotesReceived,
        AVG(u.Reputation) AS AverageReputation
    FROM 
        Users u
    LEFT JOIN 
        Posts p ON u.Id = p.OwnerUserId
    LEFT JOIN 
        Comments c ON p.Id = c.PostId
    GROUP BY 
        u.Id, u.DisplayName
),
post_statistics AS (
    SELECT
        p.Id AS PostId,
        p.Title,
        p.ViewCount,
        p.Score,
        STRING_AGG(DISTINCT t.TagName, ', ') AS AssociatedTags,
        COUNT(v.Id) FILTER (WHERE v.VoteTypeId = 2) AS TotalUpVotes,
        COUNT(v.Id) FILTER (WHERE v.VoteTypeId = 3) AS TotalDownVotes,
        MAX(ph.CreationDate) AS LastEditedDate
    FROM
        Posts p
    LEFT JOIN
        Tags t ON p.Tags LIKE CONCAT('%', t.TagName, '%')
    LEFT JOIN
        Votes v ON p.Id = v.PostId
    LEFT JOIN 
        PostHistory ph ON p.Id = ph.PostId
    GROUP BY 
        p.Id, p.Title, p.ViewCount, p.Score
),
combined_stats AS (
    SELECT 
        up.DisplayName,
        up.TotalPosts,
        up.TotalComments,
        up.QuestionsPosted,
        up.AnswersPosted,
        up.UpVotesReceived,
        up.DownVotesReceived,
        up.AverageReputation,
        ps.Title,
        ps.ViewCount,
        ps.Score,
        ps.AssociatedTags,
        ps.TotalUpVotes,
        ps.TotalDownVotes,
        ps.LastEditedDate
    FROM 
        user_post_activity up
    JOIN 
        post_statistics ps ON up.UserId = ps.PostId 
)
SELECT 
    DisplayName,
    TotalPosts,
    TotalComments,
    QuestionsPosted,
    AnswersPosted,
    UpVotesReceived,
    DownVotesReceived,
    AverageReputation,
    Title AS PostTitle,
    ViewCount,
    Score,
    AssociatedTags,
    TotalUpVotes,
    TotalDownVotes,
    LastEditedDate
FROM 
    combined_stats
ORDER BY 
    TotalPosts DESC,
    AverageReputation DESC
LIMIT 20;
