
WITH UserPostStats AS (
    SELECT 
        u.Id AS UserId,
        u.DisplayName,
        COUNT(p.Id) AS PostCount,
        SUM(CASE WHEN p.Score > 0 THEN 1 ELSE 0 END) AS PositivePostCount,
        SUM(CASE WHEN p.Score < 0 THEN 1 ELSE 0 END) AS NegativePostCount,
        AVG(COALESCE(p.ViewCount, 0)) AS AvgViews,
        SUM(COALESCE(p.UpVotes, 0)) - SUM(COALESCE(p.DownVotes, 0)) AS NetVotes,
        DENSE_RANK() OVER (ORDER BY SUM(COALESCE(p.UpVotes, 0)) - SUM(COALESCE(p.DownVotes, 0)) DESC) AS VoteRank
    FROM 
        Users u
    LEFT JOIN 
        Posts p ON u.Id = p.OwnerUserId
    GROUP BY 
        u.Id, u.DisplayName
),
TopUsers AS (
    SELECT 
        UserId,
        DisplayName,
        PostCount,
        PositivePostCount,
        NegativePostCount,
        AvgViews,
        NetVotes,
        VoteRank,
        ROW_NUMBER() OVER (ORDER BY VoteRank) AS RowNum
    FROM 
        UserPostStats
    WHERE 
        PostCount > 0
),
TopPosts AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.CreationDate,
        COALESCE(c.CommentCount, 0) AS CommentCount,
        COALESCE(v.VoteCount, 0) AS VoteCount,
        COALESCE(b.BadgeCount, 0) AS BadgeCount,
        p.ViewCount,
        (CASE 
            WHEN p.CreationDate < TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '1 year' THEN 'Old Post'
            ELSE 'New Post'
        END) AS PostAge,
        p.OwnerUserId
    FROM 
        Posts p
    LEFT JOIN 
        (SELECT 
            PostId, COUNT(*) AS CommentCount 
         FROM 
            Comments 
         GROUP BY 
            PostId) c ON p.Id = c.PostId
    LEFT JOIN 
        (SELECT 
            PostId, COUNT(*) AS VoteCount 
         FROM 
            Votes 
         GROUP BY 
            PostId) v ON p.Id = v.PostId
    LEFT JOIN 
        (SELECT 
            UserId, COUNT(*) AS BadgeCount 
         FROM 
            Badges 
         GROUP BY 
            UserId) b ON p.OwnerUserId = b.UserId
)
SELECT 
    TOPU.UserId,
    TOPU.DisplayName,
    TOPU.PostCount,
    TOPU.PositivePostCount,
    TOPU.NegativePostCount,
    TOPU.AvgViews,
    TOPU.NetVotes,
    PP.PostId,
    PP.Title,
    PP.CreationDate,
    PP.CommentCount,
    PP.VoteCount,
    PP.BadgeCount,
    PP.ViewCount,
    PP.PostAge
FROM 
    TopUsers TOPU
JOIN 
    TopPosts PP ON TOPU.UserId = PP.OwnerUserId
WHERE 
    TOPU.VoteRank <= 5 
ORDER BY 
    TOPU.NetVotes DESC,
    PP.VoteCount DESC;
