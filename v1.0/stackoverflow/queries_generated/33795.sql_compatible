
WITH RankedPosts AS (
    SELECT
        p.Id AS PostId,
        p.Title,
        p.CreationDate,
        p.Score,
        p.ViewCount,
        u.DisplayName AS OwnerDisplayName,
        ROW_NUMBER() OVER (PARTITION BY p.OwnerUserId ORDER BY p.CreationDate DESC) AS OwnerPostRank
    FROM Posts p
    JOIN Users u ON p.OwnerUserId = u.Id
    WHERE p.PostTypeId = 1 
),
RecentActivities AS (
    SELECT
        ph.PostId,
        ph.CreationDate AS HistoryDate,
        ph.UserId,
        u.DisplayName AS EditorDisplayName,
        T.Name AS HistoryType
    FROM PostHistory ph
    JOIN Users u ON ph.UserId = u.Id
    JOIN PostHistoryTypes T ON ph.PostHistoryTypeId = T.Id
    WHERE ph.CreationDate > TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '30 days'
),
PostStatistics AS (
    SELECT
        rp.PostId,
        rp.Title,
        rp.OwnerDisplayName,
        ARRAY_AGG(DISTINCT ta.TagName) AS Tags,
        COUNT(DISTINCT c.Id) AS CommentCount,
        COALESCE(SUM(v.BountyAmount), 0) AS TotalBounty,
        COUNT(DISTINCT pa.Id) AS RelatedPostsCount
    FROM RankedPosts rp
    LEFT JOIN Comments c ON rp.PostId = c.PostId
    LEFT JOIN Votes v ON rp.PostId = v.PostId AND v.VoteTypeId = 8 
    LEFT JOIN PostLinks pl ON rp.PostId = pl.PostId
    LEFT JOIN Posts pa ON pl.RelatedPostId = pa.Id
    WHERE rp.OwnerPostRank = 1 
    GROUP BY rp.PostId, rp.Title, rp.OwnerDisplayName
),
FinalSelection AS (
    SELECT
        ps.PostId,
        ps.Title,
        ps.OwnerDisplayName,
        ps.CommentCount,
        ps.TotalBounty,
        ra.HistoryDate,
        ra.EditorDisplayName,
        ra.HistoryType
    FROM PostStatistics ps
    LEFT JOIN RecentActivities ra ON ps.PostId = ra.PostId
    ORDER BY ps.TotalBounty DESC, ps.CommentCount DESC
)
SELECT
    fs.PostId,
    fs.Title,
    fs.OwnerDisplayName,
    fs.CommentCount,
    fs.TotalBounty,
    COUNT(DISTINCT fs.HistoryType) AS UniqueHistoryTypes
FROM FinalSelection fs
GROUP BY fs.PostId, fs.Title, fs.OwnerDisplayName, fs.CommentCount, fs.TotalBounty
HAVING fs.TotalBounty > 0
ORDER BY UniqueHistoryTypes DESC, fs.CommentCount DESC
LIMIT 10;
