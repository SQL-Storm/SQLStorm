WITH UserStatistics AS (
    SELECT
        U.Id AS UserId,
        U.DisplayName,
        U.Reputation,
        COALESCE(SUM(CASE WHEN V.VoteTypeId = 2 THEN 1 ELSE 0 END), 0) AS TotalUpvotes,
        COALESCE(SUM(CASE WHEN V.VoteTypeId = 3 THEN 1 ELSE 0 END), 0) AS TotalDownvotes,
        COALESCE(SUM(CASE WHEN B.Class = 1 THEN 1 ELSE 0 END), 0) AS GoldBadges,
        COALESCE(SUM(CASE WHEN B.Class = 2 THEN 1 ELSE 0 END), 0) AS SilverBadges,
        COALESCE(SUM(CASE WHEN B.Class = 3 THEN 1 ELSE 0 END), 0) AS BronzeBadges
    FROM Users U
    LEFT JOIN Votes V ON U.Id = V.UserId
    LEFT JOIN Badges B ON U.Id = B.UserId
    WHERE U.Reputation > 100
    GROUP BY U.Id
),
RecentPosts AS (
    SELECT
        P.OwnerUserId,
        COUNT(P.Id) AS TotalPosts,
        SUM(P.ViewCount) AS TotalViews,
        MAX(P.CreationDate) AS LastPostDate
    FROM Posts P
    WHERE P.CreationDate > cast('2024-10-01' as date) - INTERVAL '90 days'
    GROUP BY P.OwnerUserId
),
OverallStatistics AS (
    SELECT
        U.UserId,
        U.DisplayName,
        U.Reputation,
        COALESCE(UP.TotalUpvotes, 0) AS TotalUpvotes,
        COALESCE(UP.TotalDownvotes, 0) AS TotalDownvotes,
        COALESCE(RP.TotalPosts, 0) AS TotalRecentPosts,
        COALESCE(RP.TotalViews, 0) AS TotalViews,
        U.GoldBadges,
        U.SilverBadges,
        U.BronzeBadges,
        ROW_NUMBER() OVER (ORDER BY U.Reputation DESC) AS UserRank
    FROM UserStatistics U
    LEFT JOIN RecentPosts RP ON U.UserId = RP.OwnerUserId
)

SELECT
    O.UserId,
    O.DisplayName,
    O.Reputation,
    O.TotalUpvotes,
    O.TotalDownvotes,
    O.TotalRecentPosts,
    O.TotalViews,
    O.GoldBadges,
    O.SilverBadges,
    O.BronzeBadges,
    O.UserRank,
    CASE 
        WHEN O.TotalUpvotes > O.TotalDownvotes THEN 'Positive Contributor'
        WHEN O.TotalUpvotes < O.TotalDownvotes THEN 'Needs Improvement'
        ELSE 'Balanced Contributor'
    END AS ContributorType,
    CASE 
        WHEN O.TotalRecentPosts = 0 THEN 'No Recent Activity'
        WHEN O.TotalRecentPosts < 5 THEN 'Moderate Activity'
        ELSE 'Active User'
    END AS ActivityLevel
FROM OverallStatistics O
WHERE O.Reputation IS NOT NULL
AND O.TotalUpvotes > 0
ORDER BY O.UserRank
LIMIT 50;