WITH RECURSIVE UserReputation AS (
    SELECT 
        Id, 
        Reputation,
        CreationDate,
        DisplayName,
        LastAccessDate,
        UpVotes,
        DownVotes,
        1 AS Level
    FROM Users
    WHERE Reputation > 1000
    
    UNION ALL
    
    SELECT 
        u.Id, 
        u.Reputation,
        u.CreationDate,
        u.DisplayName,
        u.LastAccessDate,
        u.UpVotes,
        u.DownVotes,
        ur.Level + 1
    FROM Users u
    INNER JOIN UserReputation ur ON u.Reputation > ur.Reputation
    WHERE ur.Level < 10
),
PostData AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.CreationDate AS PostDate,
        p.OwnerUserId,
        p.Score,
        p.ViewCount,
        COUNT(c.Id) AS CommentCount,
        SUM(COALESCE(v.BountyAmount, 0)) AS TotalBounty
    FROM Posts p
    LEFT JOIN Comments c ON p.Id = c.PostId
    LEFT JOIN Votes v ON p.Id = v.PostId AND v.VoteTypeId = 8 
    WHERE p.CreationDate > (cast('2024-10-01 12:34:56' as timestamp) - INTERVAL '1 year')
    GROUP BY p.Id
),
RankedPosts AS (
    SELECT 
        pd.*,
        ROW_NUMBER() OVER (PARTITION BY pd.OwnerUserId ORDER BY pd.Score DESC) AS PostRank,
        RANK() OVER (ORDER BY pd.Score DESC) AS GlobalRank
    FROM PostData pd
),
UserActivity AS (
    SELECT 
        u.DisplayName,
        COUNT(DISTINCT p.Id) AS TotalPosts,
        SUM(COALESCE(c.CommentCount, 0)) AS TotalComments,
        SUM(u.UpVotes) AS TotalUpVotes,
        SUM(u.DownVotes) AS TotalDownVotes,
        RANK() OVER (ORDER BY SUM(u.UpVotes) - SUM(u.DownVotes) DESC) AS UserReputationRank
    FROM Users u
    JOIN Posts p ON u.Id = p.OwnerUserId
    LEFT JOIN (
        SELECT 
            PostId, 
            COUNT(Id) AS CommentCount 
        FROM Comments 
        GROUP BY PostId
    ) c ON p.Id = c.PostId
    GROUP BY u.Id
),
FinalReport AS (
    SELECT 
        ua.DisplayName,
        ua.TotalPosts,
        ua.TotalComments,
        ua.TotalUpVotes,
        ua.TotalDownVotes,
        ur.Reputation AS UserReputation,
        ur.Level AS ReputationLevel,
        rp.Title,
        rp.PostDate,
        rp.Score,
        rp.CommentCount,
        rp.TotalBounty,
        rp.GlobalRank
    FROM UserActivity ua
    JOIN UserReputation ur ON ua.DisplayName = ur.DisplayName
    LEFT JOIN RankedPosts rp ON ua.TotalPosts > 0
    WHERE ur.Reputation > 1000
    ORDER BY ua.TotalPosts DESC, ur.Reputation DESC
)

SELECT 
    DisplayName, 
    TotalPosts, 
    TotalComments, 
    TotalUpVotes, 
    TotalDownVotes, 
    UserReputation, 
    ReputationLevel, 
    Title, 
    PostDate, 
    Score, 
    CommentCount, 
    TotalBounty, 
    GlobalRank
FROM FinalReport
WHERE ReputationLevel <= 5 
ORDER BY ReputationLevel, TotalPosts DESC;