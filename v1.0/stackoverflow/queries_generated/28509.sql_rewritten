WITH TagCounts AS (
    SELECT 
        tag.TagName,
        COUNT(DISTINCT p.Id) AS PostCount
    FROM 
        Tags AS tag
    JOIN 
        Posts AS p ON tag.Id = p.Tags
    WHERE 
        p.CreationDate >= cast('2024-10-01' as date) - INTERVAL '1 year'
    GROUP BY 
        tag.TagName
),
MostActiveUsers AS (
    SELECT 
        u.DisplayName,
        COUNT(DISTINCT p.Id) AS ContributionCount,
        SUM(COALESCE(c.CommentCount, 0)) AS TotalComments
    FROM 
        Users u
    LEFT JOIN 
        Posts p ON u.Id = p.OwnerUserId
    LEFT JOIN 
        Comments c ON p.Id = c.PostId
    WHERE 
        u.Reputation > 1000
    GROUP BY 
        u.DisplayName
),
TopTags AS (
    SELECT 
        tc.TagName,
        tc.PostCount,
        ROW_NUMBER() OVER (ORDER BY tc.PostCount DESC) AS TagRank
    FROM 
        TagCounts tc
),
UserScore AS (
    SELECT 
        mau.DisplayName,
        mau.ContributionCount,
        mau.TotalComments,
        COALESCE(SUM(b.Class), 0) AS TotalBadges
    FROM
        MostActiveUsers mau
    LEFT JOIN 
        Badges b ON mau.DisplayName = b.UserId
    GROUP BY 
        mau.DisplayName, mau.ContributionCount, mau.TotalComments
)
SELECT 
    ut.DisplayName,
    ut.ContributionCount,
    ut.TotalComments,
    ut.TotalBadges,
    tt.TagName,
    tt.PostCount
FROM 
    UserScore ut
JOIN 
    TopTags tt ON ut.ContributionCount > tt.PostCount
WHERE 
    tt.TagRank <= 5
ORDER BY 
    ut.ContributionCount DESC, tt.PostCount DESC;