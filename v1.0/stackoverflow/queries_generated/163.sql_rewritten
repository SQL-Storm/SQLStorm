WITH RankedPosts AS (
    SELECT p.Id AS PostId, 
           p.Title, 
           p.CreationDate, 
           p.Score, 
           p.ViewCount, 
           ROW_NUMBER() OVER (PARTITION BY p.OwnerUserId ORDER BY p.CreationDate DESC) AS rn,
           COUNT(DISTINCT c.Id) OVER (PARTITION BY p.Id) AS CommentCount,
           SUM(v.BountyAmount) OVER (PARTITION BY p.Id) AS TotalBounty,
           COALESCE(u.Reputation, 0) AS UserReputation
    FROM Posts p
    LEFT JOIN Comments c ON p.Id = c.PostId
    LEFT JOIN Users u ON p.OwnerUserId = u.Id
    LEFT JOIN Votes v ON p.Id = v.PostId
    WHERE p.CreationDate >= cast('2024-10-01 12:34:56' as timestamp) - INTERVAL '365 days'
),
UserBadges AS (
    SELECT UserId, 
           COUNT(CASE WHEN Class = 1 THEN 1 END) AS GoldCount, 
           COUNT(CASE WHEN Class = 2 THEN 1 END) AS SilverCount, 
           COUNT(CASE WHEN Class = 3 THEN 1 END) AS BronzeCount
    FROM Badges
    GROUP BY UserId
)
SELECT rp.PostId, 
       rp.Title, 
       rp.CreationDate, 
       rp.Score, 
       rp.ViewCount, 
       rp.CommentCount, 
       rp.TotalBounty, 
       ub.GoldCount, 
       ub.SilverCount, 
       ub.BronzeCount
FROM RankedPosts rp
LEFT JOIN UserBadges ub ON rp.OwnerUserId = ub.UserId
WHERE rp.rn = 1
  AND (rp.UserReputation > 1000 OR ub.GoldCount > 0)
ORDER BY rp.Score DESC, rp.ViewCount DESC
LIMIT 50;