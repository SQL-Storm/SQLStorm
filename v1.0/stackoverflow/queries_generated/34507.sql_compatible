
WITH RecursivePostHierarchy AS (
    
    SELECT
        p.Id AS PostId,
        p.Title,
        p.CreationDate,
        p.AcceptedAnswerId,
        0 AS Level
    FROM Posts p
    WHERE p.PostTypeId = 1  

    UNION ALL

    SELECT
        a.Id AS PostId,
        a.Title,
        a.CreationDate,
        a.AcceptedAnswerId,
        Level + 1
    FROM Posts a
    INNER JOIN RecursivePostHierarchy rp ON a.ParentId = rp.PostId
)

SELECT
    u.DisplayName AS UserName,
    COUNT(DISTINCT p.Id) AS QuestionCount,
    COUNT(DISTINCT a.Id) AS AnswerCount,
    SUM(CASE WHEN ph.PostHistoryTypeId = 10 THEN 1 ELSE 0 END) AS Closures,
    AVG(EXTRACT(EPOCH FROM (TIMESTAMP '2024-10-01 12:34:56' - p.CreationDate)) / 60) AS AvgTimeToClose,
    STRING_AGG(DISTINCT t.TagName, ', ') AS Tags
FROM Users u
LEFT JOIN Posts p ON u.Id = p.OwnerUserId AND p.PostTypeId = 1 
LEFT JOIN Posts a ON a.ParentId = p.Id 
LEFT JOIN PostHistory ph ON ph.PostId = p.Id 
LEFT JOIN Tags t ON t.Id IN (SELECT unnest(string_to_array(p.Tags, '<>'))) 
WHERE u.Reputation > 1000 
GROUP BY u.DisplayName
HAVING COUNT(DISTINCT p.Id) > 10 AND COUNT(DISTINCT a.Id) > 5 
ORDER BY AvgTimeToClose DESC
LIMIT 50;
