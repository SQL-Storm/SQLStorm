
WITH RecursivePostCTE AS (
    SELECT 
        P.Id AS PostId,
        P.Title,
        P.CreationDate,
        P.OwnerUserId,
        0 AS Level,
        CAST(P.Title AS VARCHAR(100)) AS Path
    FROM 
        Posts P
    WHERE 
        P.PostTypeId = 1 

    UNION ALL

    SELECT 
        P2.Id AS PostId,
        P2.Title,
        P2.CreationDate,
        P2.OwnerUserId,
        Level + 1,
        CAST(CTE.Path || ' -> ' || P2.Title AS VARCHAR(100))
    FROM 
        Posts P2
    INNER JOIN 
        Posts P ON P2.ParentId = P.Id
    INNER JOIN 
        RecursivePostCTE CTE ON P.Id = CTE.PostId
    WHERE 
        Level < 10 
),

PostStatistics AS (
    SELECT 
        P.Id AS PostId,
        P.Title,
        COUNT(CA.Id) AS AnswerCount,
        COALESCE(SUM(V.BountyAmount), 0) AS TotalBounties,
        ROW_NUMBER() OVER (ORDER BY COUNT(CA.Id) DESC) AS Rank
    FROM 
        Posts P
    LEFT JOIN 
        Posts CA ON CA.ParentId = P.Id AND CA.PostTypeId = 2 
    LEFT JOIN 
        Votes V ON V.PostId = P.Id AND V.VoteTypeId = 8 
    WHERE 
        P.PostTypeId = 1 
    GROUP BY 
        P.Id, P.Title
),

TopPosts AS (
    SELECT 
        PS.PostId,
        PS.Title,
        PS.AnswerCount,
        PS.TotalBounties
    FROM 
        PostStatistics PS 
    WHERE 
        PS.Rank <= 10
),

PostVoteSummary AS (
    SELECT 
        P.Id AS PostId,
        P.Title,
        COUNT(V.Id) AS VoteCount,
        COUNT(CASE WHEN V.VoteTypeId = 2 THEN 1 END) AS UpVotes,
        COUNT(CASE WHEN V.VoteTypeId = 3 THEN 1 END) AS DownVotes
    FROM 
        Posts P
    LEFT JOIN 
        Votes V ON V.PostId = P.Id
    WHERE 
        P.PostTypeId = 1 
    GROUP BY 
        P.Id, P.Title
)

SELECT 
    T.Title,
    T.AnswerCount,
    T.TotalBounties,
    PVS.VoteCount,
    PVS.UpVotes,
    PVS.DownVotes,
    (SELECT STRING_AGG(UserId::TEXT, ', ') 
     FROM (SELECT DISTINCT UserId FROM Badges WHERE UserId IN (SELECT OwnerUserId FROM Posts WHERE Id = T.PostId)) AS DistinctUsers) AS BadgeOwners,
    RP.Path AS PostHierarchy
FROM 
    TopPosts T
LEFT JOIN 
    PostVoteSummary PVS ON T.PostId = PVS.PostId
LEFT JOIN 
    RecursivePostCTE RP ON T.PostId = RP.PostId
ORDER BY 
    T.TotalBounties DESC, T.AnswerCount DESC;
