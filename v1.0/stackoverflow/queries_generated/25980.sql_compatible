
WITH RecentPosts AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.Body,
        p.CreationDate,
        p.ViewCount,
        p.Score,
        p.Tags,
        u.DisplayName AS OwnerDisplayName
    FROM Posts p
    JOIN Users u ON p.OwnerUserId = u.Id
    WHERE p.CreationDate >= TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '30 days'
      AND p.PostTypeId = 1  
), 
TagStats AS (
    SELECT 
        unnest(string_to_array(substring(Tags, 2, length(Tags) - 2), '><')) AS TagName,
        COUNT(*) AS TagCount
    FROM RecentPosts
    GROUP BY TagName
), 
MostPopularTags AS (
    SELECT 
        TagName,
        TagCount,
        RANK() OVER (ORDER BY TagCount DESC) AS TagRank
    FROM TagStats
),
TopUsers AS (
    SELECT 
        u.Id AS UserId,
        u.DisplayName,
        SUM(CASE WHEN v.VoteTypeId = 2 THEN 1 ELSE 0 END) AS TotalUpvotes,
        SUM(CASE WHEN v.VoteTypeId = 3 THEN 1 ELSE 0 END) AS TotalDownvotes,
        (SUM(CASE WHEN v.VoteTypeId = 2 THEN 1 ELSE 0 END) - SUM(CASE WHEN v.VoteTypeId = 3 THEN 1 ELSE 0 END)) AS NetVotes
    FROM Votes v
    JOIN Posts po ON v.PostId = po.Id
    JOIN Users u ON po.OwnerUserId = u.Id
    WHERE po.CreationDate >= TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '30 days'
      AND po.PostTypeId = 1  
    GROUP BY u.Id, u.DisplayName
),
ActiveUsers AS (
    SELECT 
        u.Id,
        u.DisplayName,
        COUNT(c.Id) AS CommentCount,
        COUNT(DISTINCT p.Id) AS PostCount
    FROM Users u
    LEFT JOIN Comments c ON u.Id = c.UserId
    LEFT JOIN Posts p ON u.Id = p.OwnerUserId AND p.CreationDate >= TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '30 days'
    GROUP BY u.Id, u.DisplayName
)
SELECT 
    r.PostId,
    r.Title,
    r.OwnerDisplayName,
    r.CreationDate,
    r.ViewCount,
    r.Score,
    t.TagName,
    u.DisplayName AS ActiveUser,
    u.CommentCount,
    u.PostCount,
    us.TotalUpvotes,
    us.TotalDownvotes,
    us.NetVotes
FROM RecentPosts r
JOIN MostPopularTags t ON r.Tags ILIKE '%' || t.TagName || '%'
JOIN TopUsers us ON r.OwnerUserId = us.UserId
JOIN ActiveUsers u ON r.OwnerUserId = u.Id
WHERE t.TagRank <= 5  
ORDER BY r.CreationDate DESC, us.NetVotes DESC;
