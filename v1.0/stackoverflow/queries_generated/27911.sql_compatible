
WITH RecentPosts AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.Body,
        p.CreationDate,
        p.OwnerUserId,
        p.Tags,
        COALESCE(pc.CommentCount, 0) AS CommentCount,
        COALESCE(pa.AnswerCount, 0) AS AnswerCount
    FROM 
        Posts p
    LEFT JOIN (
        SELECT PostId, COUNT(*) AS CommentCount
        FROM Comments
        GROUP BY PostId
    ) pc ON pc.PostId = p.Id
    LEFT JOIN (
        SELECT ParentId, COUNT(*) AS AnswerCount
        FROM Posts 
        WHERE PostTypeId = 2
        GROUP BY ParentId
    ) pa ON pa.ParentId = p.Id
    WHERE 
        p.CreationDate >= TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '30 days'
        AND p.PostTypeId = 1 
), TagStatistics AS (
    SELECT 
        t.TagName,
        COUNT(rp.PostId) AS PostCount,
        AVG(u.Reputation) AS AvgUserReputation,
        SUM(rp.ViewCount) AS TotalViews,
        SUM(rp.Score) AS TotalScore
    FROM 
        Tags t
    JOIN RecentPosts rp ON rp.Tags LIKE '%' || t.TagName || '%'
    JOIN Users u ON u.Id = rp.OwnerUserId
    GROUP BY 
        t.TagName
), MostActiveTags AS (
    SELECT 
        TagName,
        PostCount,
        AvgUserReputation,
        TotalViews,
        TotalScore,
        RANK() OVER (ORDER BY PostCount DESC) AS TagRank
    FROM 
        TagStatistics
)
SELECT 
    TagName,
    PostCount,
    AvgUserReputation,
    TotalViews,
    TotalScore
FROM 
    MostActiveTags
WHERE 
    TagRank <= 10
ORDER BY 
    PostCount DESC, TagName;
