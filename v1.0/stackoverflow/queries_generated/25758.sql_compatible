
WITH RankedPosts AS (
  SELECT 
    p.Id AS PostId,
    p.Title,
    p.Body,
    p.CreationDate,
    u.DisplayName AS OwnerDisplayName,
    COUNT(c.Id) AS CommentCount,
    COUNT(a.Id) AS AnswerCount,
    p.ViewCount,
    STRING_AGG(t.TagName, ', ') AS Tags,
    ROW_NUMBER() OVER (PARTITION BY p.PostTypeId ORDER BY p.CreationDate DESC) AS RN
  FROM 
    Posts p
  LEFT JOIN 
    Comments c ON c.PostId = p.Id
  LEFT JOIN 
    Posts a ON a.AcceptedAnswerId = p.Id
  LEFT JOIN 
    Users u ON u.Id = p.OwnerUserId
  LEFT JOIN 
    PostsTags pt ON pt.PostId = p.Id
  LEFT JOIN 
    Tags t ON t.Id = pt.TagId
  WHERE 
    p.CreationDate >= TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '1 year'
  GROUP BY 
    p.Id, p.Title, p.Body, p.CreationDate, u.DisplayName, p.ViewCount
),
FilteredPosts AS (
  SELECT 
    rp.* 
  FROM 
    RankedPosts rp 
  WHERE 
    rp.RN <= 5 
    AND rp.CommentCount > 0
)
SELECT 
  fp.PostId,
  fp.Title,
  LEFT(fp.Body, 150) AS ShortBody,  
  fp.OwnerDisplayName,
  fp.CommentCount,
  fp.AnswerCount,
  fp.ViewCount,
  fp.Tags
FROM 
  FilteredPosts fp
ORDER BY 
  fp.CreationDate DESC;
