
WITH RecursiveTagCTE AS (
    SELECT 
        Id,
        TagName,
        Count,
        ExcerptPostId,
        1 AS Depth
    FROM Tags
    WHERE IsModeratorOnly = 0  

    UNION ALL

    SELECT 
        T.Id,
        T.TagName,
        T.Count,
        T.ExcerptPostId,
        RTC.Depth + 1
    FROM Tags T
    INNER JOIN RecursiveTagCTE RTC ON T.WikiPostId = RTC.Id
    WHERE T.IsRequired = 0  
),
PostsWithTagStats AS (
    SELECT 
        P.Id AS PostId,
        P.Title,
        P.CreationDate,
        P.ViewCount,
        COUNT(CASE WHEN V.VoteTypeId = 2 THEN 1 END) AS UpvoteCount,  
        SUM(COALESCE(CASE WHEN V.VoteTypeId = 3 THEN 1 ELSE 0 END, 0)) AS DownvoteCount,  
        STRING_AGG(DISTINCT T.TagName, ', ') AS TagsList  
    FROM Posts P
    LEFT JOIN Votes V ON P.Id = V.PostId
    LEFT JOIN Tags T ON T.ExcerptPostId = P.Id
    GROUP BY P.Id, P.Title, P.CreationDate, P.ViewCount
),
CloseReasons AS (
    SELECT 
        PH.PostId,
        PH.Comment AS CloseReason,
        PH.CreationDate
    FROM PostHistory PH
    WHERE PH.PostHistoryTypeId = 10  
),
FinalPostStats AS (
    SELECT 
        PWT.PostId,
        PWT.Title,
        PWT.CreationDate,
        PWT.ViewCount,
        PWT.UpvoteCount,
        PWT.DownvoteCount,
        PWT.TagsList,
        COALESCE(CR.CloseReason, 'Not Closed') AS CloseReason
    FROM PostsWithTagStats PWT
    LEFT JOIN CloseReasons CR ON PWT.PostId = CR.PostId
)
SELECT 
    FPS.PostId,
    FPS.Title,
    FPS.CreationDate,
    FPS.ViewCount,
    FPS.UpvoteCount,
    FPS.DownvoteCount,
    FPS.TagsList,
    FPS.CloseReason,
    RANK() OVER (ORDER BY FPS.UpvoteCount DESC) AS Rank,  
    ROW_NUMBER() OVER (PARTITION BY COALESCE(FPS.CloseReason, 'Not Closed') ORDER BY FPS.CreationDate DESC) AS CloseReasonOrder  
FROM FinalPostStats FPS
WHERE FPS.ViewCount > 100  
ORDER BY FPS.UpvoteCount DESC, FPS.ViewCount DESC;
