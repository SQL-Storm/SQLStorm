
WITH RecursivePostHistory AS (
    SELECT ph.PostId, 
           ph.CreationDate,
           ph.UserId,
           ph.PostHistoryTypeId,
           1 AS Depth
    FROM PostHistory ph
    WHERE ph.PostHistoryTypeId IN (10, 11)  
    
    UNION ALL
    
    SELECT ph.PostId, 
           ph.CreationDate,
           ph.UserId,
           ph.PostHistoryTypeId,
           rph.Depth + 1
    FROM PostHistory ph
    INNER JOIN RecursivePostHistory rph ON ph.PostId = rph.PostId 
    WHERE ph.CreationDate > rph.CreationDate  
)

SELECT p.Id AS PostId,
       p.Title,
       p.Score,
       COUNT(DISTINCT c.Id) AS CommentCount,
       COALESCE(SUM(CASE WHEN v.VoteTypeId = 2 THEN 1 ELSE 0 END), 0) AS UpvoteCount,
       COALESCE(SUM(CASE WHEN v.VoteTypeId = 3 THEN 1 ELSE 0 END), 0) AS DownvoteCount,
       COUNT(DISTINCT b.Id) AS BadgeCount,
       ph.LastAction,
       LAST_VALUE(ph.PostHistoryTypeId) OVER (PARTITION BY p.Id ORDER BY ph.CreationDate ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS LastHistoryType,
       STRING_AGG(t.TagName, ', ') AS Tags
FROM Posts p
LEFT JOIN Comments c ON p.Id = c.PostId
LEFT JOIN Votes v ON p.Id = v.PostId
LEFT JOIN Badges b ON p.OwnerUserId = b.UserId
LEFT JOIN (
    SELECT p.Id, 
           'Closed' AS LastAction
    FROM RecursivePostHistory rph
    INNER JOIN Posts p ON rph.PostId = p.Id
    WHERE rph.PostHistoryTypeId = 10 
    
    UNION
    
    SELECT p.Id, 
           'Reopened' AS LastAction
    FROM RecursivePostHistory rph
    INNER JOIN Posts p ON rph.PostId = p.Id
    WHERE rph.PostHistoryTypeId = 11 
) ph ON p.Id = ph.Id
LEFT JOIN LATERAL (
    SELECT STRING_AGG(t.TagName, ', ') AS TagName
    FROM Tags t 
    WHERE t.Id IN (SELECT CAST(UNNEST(string_to_array(p.Tags, ',')) AS INT))  
) t ON true
WHERE p.CreationDate > CAST('2024-10-01 12:34:56' AS timestamp) - INTERVAL '1 year'  
GROUP BY p.Id, p.Title, p.Score, ph.LastAction
ORDER BY p.Score DESC, CommentCount DESC;
