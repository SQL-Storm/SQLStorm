
WITH RecursivePostHierarchy AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.OwnerUserId,
        p.CreationDate,
        0 AS Level
    FROM 
        Posts p 
    WHERE 
        p.PostTypeId = 1

    UNION ALL

    SELECT 
        a.Id AS PostId,
        a.Title,
        a.OwnerUserId,
        a.CreationDate,
        ph.Level + 1
    FROM 
        Posts a
    JOIN 
        RecursivePostHierarchy ph ON a.ParentId = ph.PostId
)
SELECT 
    u.Id AS UserId,
    u.DisplayName,
    COUNT(DISTINCT p.PostId) AS TotalPosts,
    COUNT(DISTINCT CASE WHEN p.Level = 0 THEN 1 END) AS TotalQuestions,
    COUNT(DISTINCT CASE WHEN p.Level > 0 THEN 1 END) AS TotalAnswers,
    COALESCE(SUM(v.BountyAmount), 0) AS TotalBounty,
    AVG(COALESCE(v.BountyAmount, 0)) AS AvgBounty,
    MAX(p.CreationDate) AS LastActivityDate,
    STRING_AGG(DISTINCT t.TagName, ', ') AS Tags
FROM 
    Users u
LEFT JOIN 
    RecursivePostHierarchy p ON u.Id = p.OwnerUserId
LEFT JOIN 
    Votes v ON p.PostId = v.PostId AND v.VoteTypeId = 8  
LEFT JOIN 
    LATERAL (
        SELECT 
            unnest(string_to_array(p2.Tags, ',')) AS TagName
        FROM 
            Posts p2
        WHERE 
            p2.Id = p.PostId
    ) AS t ON TRUE
GROUP BY 
    u.Id, u.DisplayName
HAVING 
    COUNT(DISTINCT p.PostId) > 5  
ORDER BY 
    TotalPosts DESC, LastActivityDate DESC;
