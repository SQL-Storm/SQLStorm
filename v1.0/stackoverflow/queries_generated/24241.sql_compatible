
WITH RankedPosts AS (
    SELECT 
        P.Id AS PostId,
        P.Title,
        P.CreationDate,
        P.Score,
        P.ViewCount,
        U.DisplayName AS Owner,
        RANK() OVER (PARTITION BY P.PostTypeId ORDER BY P.CreationDate DESC) AS RankByCreation
    FROM 
        Posts P
    LEFT JOIN 
        Users U ON P.OwnerUserId = U.Id
    WHERE 
        P.PostTypeId IN (1, 2) 
        AND P.CreationDate >= TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '1 year'
),
ClosedPosts AS (
    SELECT 
        PH.PostId,
        PH.Comment AS CloseReason,
        PH.CreationDate AS CloseDate
    FROM 
        PostHistory PH
    WHERE 
        PH.PostHistoryTypeId = 10 
        AND PH.CreationDate >= TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '6 months'
),
PostStatistics AS (
    SELECT 
        RP.PostId,
        RP.Title,
        RP.CreationDate,
        RP.Score,
        RP.ViewCount,
        RP.Owner,
        COALESCE(CP.CloseReason, 'Not Closed') AS CloseReason,
        COUNT(CM.Id) AS CommentCount,
        AVG(COALESCE(VB.BountyAmount, 0)) AS AverageBounty
    FROM 
        RankedPosts RP
    LEFT JOIN 
        ClosedPosts CP ON RP.PostId = CP.PostId
    LEFT JOIN 
        Comments CM ON RP.PostId = CM.PostId
    LEFT JOIN 
        Votes VB ON RP.PostId = VB.PostId AND VB.VoteTypeId = 8 
    GROUP BY 
        RP.PostId, RP.Title, RP.CreationDate, RP.Score, RP.ViewCount, RP.Owner, CP.CloseReason
),
FinalReport AS (
    SELECT 
        PS.*,
        CASE 
            WHEN PS.Score >= 10 THEN 'High Score'
            WHEN PS.Score BETWEEN 5 AND 9 THEN 'Medium Score'
            ELSE 'Low Score'
        END AS ScoreCategory,
        CASE 
            WHEN PS.ViewCount IS NULL OR PS.ViewCount = 0 THEN 'No Views Yet'
            WHEN PS.ViewCount < 100 THEN 'Low Visibility'
            ELSE 'High Visibility'
        END AS VisibilityStatus
    FROM 
        PostStatistics PS
)
SELECT 
    FR.PostId,
    FR.Title,
    FR.CreationDate,
    FR.Score,
    FR.ViewCount,
    FR.Owner,
    FR.CloseReason,
    FR.CommentCount,
    FR.AverageBounty,
    FR.ScoreCategory,
    FR.VisibilityStatus
FROM 
    FinalReport FR
WHERE 
    FR.RankByCreation <= 5 
ORDER BY 
    FR.Score DESC, 
    FR.ViewCount DESC
LIMIT 10 OFFSET 0;
