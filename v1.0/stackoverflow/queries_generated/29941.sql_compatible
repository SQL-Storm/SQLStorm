
WITH RankedPosts AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.Body,
        p.CreationDate,
        p.ViewCount,
        p.Score,
        p.Tags,
        u.DisplayName AS OwnerDisplayName,
        RANK() OVER (PARTITION BY p.Tags ORDER BY p.CreationDate DESC) AS TagRank
    FROM 
        Posts p
    JOIN 
        Users u ON p.OwnerUserId = u.Id
    WHERE 
        p.PostTypeId = 1 
),
RecentEdits AS (
    SELECT 
        ph.PostId,
        ph.CreationDate AS EditDate,
        ph.UserDisplayName,
        ph.Text AS EditComment,
        ROW_NUMBER() OVER (PARTITION BY ph.PostId ORDER BY ph.CreationDate DESC) AS EditRank
    FROM 
        PostHistory ph
    WHERE 
        ph.PostHistoryTypeId IN (4, 5, 6) 
),
PostStatistics AS (
    SELECT 
        rp.PostId,
        rp.Title,
        rp.OwnerDisplayName,
        rp.ViewCount,
        rp.Score,
        (SELECT COUNT(*) FROM Comments c WHERE c.PostId = rp.PostId) AS CommentCount,
        (SELECT COUNT(*) FROM Votes v WHERE v.PostId = rp.PostId AND v.VoteTypeId IN (2, 3)) AS VoteCount 
    FROM 
        RankedPosts rp
    GROUP BY
        rp.PostId, rp.Title, rp.OwnerDisplayName, rp.ViewCount, rp.Score
)
SELECT 
    ps.PostId,
    ps.Title,
    ps.OwnerDisplayName,
    ps.ViewCount,
    ps.Score,
    ps.CommentCount,
    ps.VoteCount,
    COALESCE(re.EditDate, 'No Edits') AS LastEditDate,
    COALESCE(re.UserDisplayName, 'N/A') AS LastEditor,
    COALESCE(re.EditComment, 'N/A') AS LastEditComment
FROM 
    PostStatistics ps
LEFT JOIN 
    RecentEdits re ON ps.PostId = re.PostId AND re.EditRank = 1
WHERE 
    ps.TagRank = 1 
ORDER BY 
    ps.Score DESC, ps.ViewCount DESC
LIMIT 100;
