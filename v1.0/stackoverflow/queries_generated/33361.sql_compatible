
WITH PostDetails AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.CreationDate,
        p.ViewCount,
        p.Score,
        p.AnswerCount,
        p.CommentCount,
        u.DisplayName AS OwnerDisplayName,
        u.Reputation AS OwnerReputation,
        COALESCE((
            SELECT COUNT(*) 
            FROM Votes v 
            WHERE v.PostId = p.Id AND v.VoteTypeId = 2
        ), 0) AS UpVotes,
        COALESCE((
            SELECT COUNT(*) 
            FROM Votes v 
            WHERE v.PostId = p.Id AND v.VoteTypeId = 3
        ), 0) AS DownVotes
    FROM 
        Posts p
    JOIN 
        Users u ON p.OwnerUserId = u.Id
    WHERE 
        p.PostTypeId = 1 
),
RecentPostEdits AS (
    SELECT 
        ph.PostId,
        MAX(ph.CreationDate) AS LastEditDate
    FROM 
        PostHistory ph
    WHERE 
        ph.PostHistoryTypeId IN (4, 5, 6) 
    GROUP BY 
        ph.PostId
),
UserBadges AS (
    SELECT 
        b.UserId,
        COUNT(CASE WHEN b.Class = 1 THEN 1 END) AS GoldBadges,
        COUNT(CASE WHEN b.Class = 2 THEN 1 END) AS SilverBadges,
        COUNT(CASE WHEN b.Class = 3 THEN 1 END) AS BronzeBadges
    FROM 
        Badges b
    GROUP BY 
        b.UserId
),
PostSummary AS (
    SELECT
        pd.PostId,
        pd.Title,
        pd.CreationDate,
        pd.ViewCount,
        pd.Score,
        pd.AnswerCount,
        pd.CommentCount,
        pd.OwnerDisplayName,
        pd.OwnerReputation,
        pd.UpVotes,
        pd.DownVotes,
        COALESCE(re.LastEditDate, 'Never Edited') AS LastEditDate,
        ub.GoldBadges,
        ub.SilverBadges,
        ub.BronzeBadges
    FROM 
        PostDetails pd
    LEFT JOIN 
        RecentPostEdits re ON pd.PostId = re.PostId
    LEFT JOIN 
        UserBadges ub ON pd.OwnerDisplayName = ub.UserId
)
SELECT 
    PostId,
    Title,
    CreationDate,
    ViewCount,
    Score,
    AnswerCount,
    CommentCount,
    OwnerDisplayName,
    OwnerReputation,
    UpVotes,
    DownVotes,
    LastEditDate,
    GoldBadges,
    SilverBadges,
    BronzeBadges
FROM 
    PostSummary
WHERE
    OwnerReputation > 1000 
ORDER BY 
    Score DESC, 
    CreationDate DESC
LIMIT 50
UNION ALL
SELECT 
    NULL AS PostId,
    'Total Questions' AS Title,
    NULL AS CreationDate,
    SUM(ViewCount) AS ViewCount,
    SUM(Score) AS Score,
    SUM(AnswerCount) AS AnswerCount,
    SUM(CommentCount) AS CommentCount,
    NULL AS OwnerDisplayName,
    NULL AS OwnerReputation,
    SUM(UpVotes) AS UpVotes,
    SUM(DownVotes) AS DownVotes,
    NULL AS LastEditDate,
    NULL AS GoldBadges,
    NULL AS SilverBadges,
    NULL AS BronzeBadges
FROM 
    PostSummary;
