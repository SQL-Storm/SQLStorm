
WITH TagStatistics AS (
    SELECT 
        t.TagName,
        COUNT(p.Id) AS PostCount,
        SUM(CASE WHEN p.PostTypeId = 1 THEN 1 ELSE 0 END) AS QuestionCount,
        SUM(CASE WHEN p.PostTypeId = 2 THEN 1 ELSE 0 END) AS AnswerCount,
        SUM(CASE WHEN p.PostTypeId IN (4, 5) THEN 1 ELSE 0 END) AS WikiCount,
        MIN(p.CreationDate) AS FirstPostDate,
        MAX(p.LastActivityDate) AS LastPostDate,
        AVG(p.ViewCount) AS AverageViews
    FROM 
        Tags t
    LEFT JOIN 
        Posts p ON p.Tags LIKE '%' || t.TagName || '%'
    GROUP BY 
        t.TagName
),
TopUsers AS (
    SELECT 
        u.Id AS UserId,
        u.DisplayName,
        SUM(CASE WHEN v.VoteTypeId = 2 THEN 1 ELSE 0 END) AS UpvotesReceived,
        SUM(CASE WHEN v.VoteTypeId = 3 THEN 1 ELSE 0 END) AS DownvotesReceived,
        COUNT(DISTINCT p.Id) AS AnsweredQuestions,
        COUNT(DISTINCT CASE WHEN b.Class = 1 THEN b.Id END) AS GoldBadges,
        COUNT(DISTINCT CASE WHEN b.Class = 2 THEN b.Id END) AS SilverBadges,
        COUNT(DISTINCT CASE WHEN b.Class = 3 THEN b.Id END) AS BronzeBadges
    FROM 
        Users u
    LEFT JOIN 
        Votes v ON v.UserId = u.Id
    LEFT JOIN 
        Posts p ON p.OwnerUserId = u.Id
    LEFT JOIN 
        Badges b ON b.UserId = u.Id
    WHERE 
        u.Reputation > 1000
    GROUP BY 
        u.Id, u.DisplayName
),
AnalyticalResults AS (
    SELECT 
        ts.TagName,
        ts.PostCount,
        ts.QuestionCount,
        ts.AnswerCount,
        ts.WikiCount,
        ts.FirstPostDate,
        ts.LastPostDate,
        ts.AverageViews,
        tu.DisplayName AS TopUser,
        tu.UpvotesReceived,
        tu.DownvotesReceived,
        tu.AnsweredQuestions,
        tu.GoldBadges,
        tu.SilverBadges,
        tu.BronzeBadges
    FROM 
        TagStatistics ts
    LEFT JOIN 
        TopUsers tu ON tu.AnsweredQuestions = (
            SELECT MAX(AnsweredQuestions) 
            FROM TopUsers
        )
    ORDER BY 
        ts.PostCount DESC
)
SELECT 
    TagName,
    PostCount,
    QuestionCount,
    AnswerCount,
    WikiCount,
    FirstPostDate,
    LastPostDate,
    AverageViews,
    TopUser,
    UpvotesReceived,
    DownvotesReceived,
    AnsweredQuestions,
    GoldBadges,
    SilverBadges,
    BronzeBadges
FROM 
    AnalyticalResults
WHERE 
    PostCount > 10
    AND AnswerCount > 5
ORDER BY 
    AverageViews DESC;
