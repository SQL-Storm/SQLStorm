
WITH UserActivity AS (
    SELECT 
        U.Id AS UserId,
        U.DisplayName,
        COALESCE(SUM(CASE WHEN V.VoteTypeId IN (2, 3) THEN 1 ELSE 0 END), 0) AS TotalVotes,
        COALESCE(SUM(CASE WHEN C.Id IS NOT NULL THEN 1 ELSE 0 END), 0) AS TotalComments,
        COUNT(DISTINCT P.Id) AS TotalPosts,
        COUNT(DISTINCT BH.Id) AS TotalBadges,
        RANK() OVER (ORDER BY U.Reputation DESC) AS RankByReputation
    FROM Users U
    LEFT JOIN Votes V ON V.UserId = U.Id 
    LEFT JOIN Comments C ON C.UserId = U.Id 
    LEFT JOIN Posts P ON P.OwnerUserId = U.Id 
    LEFT JOIN Badges BH ON BH.UserId = U.Id 
    GROUP BY U.Id, U.DisplayName, U.Reputation
),
PostDetails AS (
    SELECT 
        P.Id AS PostId,
        P.Title,
        P.CreationDate,
        COALESCE(COUNT(C.Id), 0) AS CommentCount,
        P.Score,
        (SELECT COALESCE(SUM(V.BountyAmount), 0) 
         FROM Votes V 
         WHERE V.PostId = P.Id AND V.VoteTypeId = 8) AS TotalBounty
    FROM Posts P 
    LEFT JOIN Comments C ON C.PostId = P.Id 
    GROUP BY P.Id, P.Title, P.CreationDate, P.Score
),
RecentPostUpdates AS (
    SELECT 
        PH.PostId,
        PH.CreationDate,
        PH.UserDisplayName,
        PH.Comment,
        PH.PostHistoryTypeId
    FROM PostHistory PH
    WHERE PH.CreationDate > DATEADD(day, -30, '2024-10-01')
),
TopFourRecentPostUpdates AS (
    SELECT 
        PostId,
        UserDisplayName,
        Comment,
        CreationDate,
        ROW_NUMBER() OVER (PARTITION BY PostId ORDER BY CreationDate DESC) AS rn
    FROM RecentPostUpdates
)

SELECT 
    UA.DisplayName AS UserDisplayName,
    UA.TotalVotes,
    UA.TotalComments,
    UA.TotalPosts,
    UA.TotalBadges,
    UA.RankByReputation,
    PD.Title AS PostTitle,
    PD.CreationDate AS PostCreationDate,
    PD.CommentCount AS PostCommentCount,
    PD.Score AS PostScore,
    PD.TotalBounty,
    TUP.UserDisplayName AS LastEditor,
    TUP.Comment AS LastUpdateComment,
    TUP.CreationDate AS LastUpdateDate
FROM UserActivity UA
JOIN PostDetails PD ON UA.UserId = PD.PostId 
LEFT JOIN TopFourRecentPostUpdates TUP ON PD.PostId = TUP.PostId AND TUP.rn <= 4
WHERE UA.TotalVotes > 10
  AND PD.CommentCount > 0
  AND (TUP.CreationDate IS NOT NULL OR UA.TotalPosts > 3) 
ORDER BY UA.TotalVotes DESC, PD.TotalBounty DESC
OFFSET 0 ROWS FETCH NEXT 50 ROWS ONLY;
