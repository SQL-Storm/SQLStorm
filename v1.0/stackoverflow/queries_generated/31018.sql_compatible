
WITH RecursivePostChain AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.CreationDate,
        p.OwnerUserId,
        p.AcceptedAnswerId,
        1 AS Level
    FROM Posts p
    WHERE p.PostTypeId = 1

    UNION ALL

    SELECT 
        a.Id,
        a.Title,
        a.CreationDate,
        a.OwnerUserId,
        a.AcceptedAnswerId,
        rpc.Level + 1
    FROM Posts a
    INNER JOIN RecursivePostChain rpc ON a.ParentId = rpc.PostId
),
PostActivity AS (
    SELECT 
        p.Id AS PostId,
        COUNT(c.Id) AS CommentCount,
        SUM(CASE WHEN v.VoteTypeId = 2 THEN 1 ELSE 0 END) AS UpvoteCount,
        SUM(CASE WHEN v.VoteTypeId = 3 THEN 1 ELSE 0 END) AS DownvoteCount,
        SUM(CASE WHEN v.VoteTypeId IN (6, 10, 12, 14) THEN 1 ELSE 0 END) AS CloseVoteCount
    FROM Posts p
    LEFT JOIN Comments c ON p.Id = c.PostId
    LEFT JOIN Votes v ON p.Id = v.PostId
    GROUP BY p.Id
),
PostSummary AS (
    SELECT 
        rpc.PostId,
        rpc.Title,
        rpc.CreationDate,
        u.DisplayName AS Owner,
        pa.CommentCount,
        pa.UpvoteCount,
        pa.DownvoteCount,
        pa.CloseVoteCount,
        CASE 
            WHEN rpc.AcceptedAnswerId IS NOT NULL THEN 'Accepted Answer'
            ELSE 'No Accepted Answer'
        END AS AnswerStatus
    FROM RecursivePostChain rpc
    LEFT JOIN Users u ON rpc.OwnerUserId = u.Id
    LEFT JOIN PostActivity pa ON rpc.PostId = pa.PostId
)
SELECT 
    ps.PostId,
    ps.Title,
    ps.CreationDate,
    ps.Owner,
    ps.CommentCount,
    ps.UpvoteCount,
    ps.DownvoteCount,
    ps.CloseVoteCount,
    ps.AnswerStatus,
    CASE
        WHEN ps.CommentCount = 0 THEN 'No Comments'
        WHEN ps.CloseVoteCount > 0 THEN 'Closed'
        ELSE 'Open'
    END AS PostStatus,
    COALESCE((
        SELECT STRING_AGG(CAST(RelatedPostId AS varchar), ', ')
        FROM PostLinks pl
        WHERE pl.PostId = ps.PostId
    ), 'No Related Posts') AS RelatedPosts
FROM PostSummary ps
WHERE ps.CommentCount > 5 OR ps.UpvoteCount >= 10
ORDER BY ps.CreationDate DESC;
