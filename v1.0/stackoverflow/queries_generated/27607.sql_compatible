
WITH TagCounts AS (
    SELECT 
        T.TagName,
        COUNT(DISTINCT P.Id) AS PostCount
    FROM 
        Tags T
    JOIN 
        Posts P ON P.Tags LIKE '%' || T.TagName || '%'
    GROUP BY 
        T.TagName
),
TopTags AS (
    SELECT 
        TagName
    FROM 
        TagCounts
    ORDER BY 
        PostCount DESC
    LIMIT 10
),
PostsWithTopTags AS (
    SELECT 
        P.Id AS PostId,
        P.Title,
        P.Body,
        P.CreationDate,
        P.ViewCount,
        COUNT(C.Comment) AS CommentCount
    FROM 
        Posts P
    JOIN 
        TopTags T ON P.Tags LIKE '%' || T.TagName || '%'
    LEFT JOIN 
        Comments C ON C.PostId = P.Id
    GROUP BY 
        P.Id, P.Title, P.Body, P.CreationDate, P.ViewCount
),
PostDetails AS (
    SELECT 
        PWT.PostId,
        PWT.Title,
        PWT.Body,
        PWT.CreationDate,
        PWT.ViewCount,
        PWT.CommentCount,
        U.DisplayName AS OwnerDisplayName,
        U.Reputation AS OwnerReputation,
        PH.CreationDate AS LastEditDate,
        PH.Comment AS EditComment
    FROM 
        PostsWithTopTags PWT
    LEFT JOIN 
        Users U ON U.Id = PWT.OwnerUserId
    LEFT JOIN 
        PostHistory PH ON PH.PostId = PWT.PostId 
        AND PH.PostHistoryTypeId IN (5, 4) 
    ORDER BY 
        PWT.CreationDate DESC
)
SELECT 
    PD.PostId,
    PD.Title,
    PD.Body,
    PD.CreationDate,
    PD.ViewCount,
    PD.CommentCount,
    PD.OwnerDisplayName,
    PD.OwnerReputation,
    PD.LastEditDate,
    PD.EditComment
FROM 
    PostDetails PD
WHERE 
    PD.CommentCount >= 5
ORDER BY 
    PD.ViewCount DESC;
