WITH UserReputationCTE AS (
    SELECT 
        u.Id AS UserId,
        u.DisplayName,
        u.Reputation,
        COUNT(DISTINCT p.Id) AS PostCount,
        SUM(CASE WHEN p.PostTypeId = 2 THEN 1 ELSE 0 END) AS AnswerCount,
        SUM(CASE WHEN p.PostTypeId = 1 THEN 1 ELSE 0 END) AS QuestionCount
    FROM Users u
    LEFT JOIN Posts p ON u.Id = p.OwnerUserId
    GROUP BY u.Id, u.DisplayName, u.Reputation
),
RankedUsers AS (
    SELECT
        UserId,
        DisplayName,
        Reputation,
        PostCount,
        AnswerCount,
        QuestionCount,
        RANK() OVER (ORDER BY Reputation DESC) AS ReputationRank
    FROM UserReputationCTE
),
RecentActivity AS (
    SELECT 
        p.OwnerUserId,
        COUNT(c.Id) AS CommentCount,
        MAX(p.LastActivityDate) AS LastActive
    FROM Posts p
    LEFT JOIN Comments c ON p.Id = c.PostId
    WHERE p.CreationDate >= cast('2024-10-01' as date) - INTERVAL '30 days'
    GROUP BY p.OwnerUserId
),
CombinedData AS (
    SELECT 
        ru.UserId,
        ru.DisplayName,
        ru.Reputation,
        ru.PostCount,
        ru.AnswerCount,
        ru.QuestionCount,
        ra.CommentCount,
        ra.LastActive,
        CASE 
            WHEN ra.LastActive IS NULL THEN 'Inactive'
            ELSE 'Active'
        END AS ActivityStatus
    FROM RankedUsers ru
    LEFT JOIN RecentActivity ra ON ru.UserId = ra.OwnerUserId
)
SELECT 
    cd.DisplayName,
    cd.Reputation,
    cd.PostCount,
    cd.AnswerCount,
    cd.QuestionCount,
    COALESCE(cd.CommentCount, 0) AS CommentCount,
    cd.LastActive,
    cd.ActivityStatus
FROM CombinedData cd
WHERE cd.ReputationRank <= 10
ORDER BY cd.Reputation DESC, cd.DisplayName ASC;