
WITH UserReputation AS (
    SELECT 
        U.Id AS UserId,
        U.DisplayName,
        U.Reputation,
        U.CreationDate,
        ROW_NUMBER() OVER (ORDER BY U.Reputation DESC) AS Rank
    FROM Users U
    WHERE U.Reputation > 0
),
PostDetails AS (
    SELECT 
        P.Id AS PostId,
        P.Title,
        P.CreationDate,
        P.Score,
        COUNT(C.Id) AS CommentCount,
        SUM(CASE WHEN V.VoteTypeId = 2 THEN 1 ELSE 0 END) AS UpVotes,
        SUM(CASE WHEN V.VoteTypeId = 3 THEN 1 ELSE 0 END) AS DownVotes,
        P.AnswerCount,
        U.DisplayName AS OwnerDisplayName
    FROM Posts P
    LEFT JOIN Comments C ON P.Id = C.PostId
    LEFT JOIN Votes V ON P.Id = V.PostId
    INNER JOIN Users U ON P.OwnerUserId = U.Id
    WHERE P.PostTypeId = 1  
    GROUP BY P.Id, P.Title, P.CreationDate, P.Score, U.DisplayName, P.AnswerCount
),
PostHistoric AS (
    SELECT 
        PH.PostId,
        PH.CreationDate,
        PHT.Name AS PostHistoryType,
        COUNT(*) AS HistoryCount
    FROM PostHistory PH
    JOIN PostHistoryTypes PHT ON PH.PostHistoryTypeId = PHT.Id
    WHERE PH.CreationDate >= DATEADD(year, -1, CAST('2024-10-01' AS DATE))
    GROUP BY PH.PostId, PH.CreationDate, PHT.Name
),
CombinedPosts AS (
    SELECT 
        PD.PostId,
        PD.Title,
        PD.CreationDate,
        PD.Score,
        PD.CommentCount,
        PD.UpVotes,
        PD.DownVotes,
        PD.AnswerCount,
        PD.OwnerDisplayName,
        COALESCE(PH.HistoryCount, 0) AS HistoryCount
    FROM PostDetails PD
    LEFT JOIN PostHistoric PH ON PD.PostId = PH.PostId
)
SELECT 
    UR.UserId,
    UR.DisplayName,
    UR.Reputation,
    CP.Title,
    CP.Score,
    CP.CommentCount,
    CP.UpVotes,
    CP.DownVotes,
    CP.AnswerCount,
    CP.CreationDate,
    CP.HistoryCount,
    CASE 
        WHEN UR.Rank <= 10 THEN 'Top User'
        ELSE 'Regular User'
    END AS UserTier
FROM UserReputation UR
JOIN CombinedPosts CP ON UR.UserId = CP.OwnerDisplayName
WHERE (CP.CommentCount > 5 OR CP.UpVotes > 10)
ORDER BY UR.Reputation DESC, CP.Score DESC;
