
WITH UserActivity AS (
    SELECT 
        u.Id AS UserId,
        u.DisplayName,
        COUNT(DISTINCT p.Id) AS PostCount,
        SUM(CASE WHEN v.VoteTypeId = 2 THEN 1 ELSE 0 END) AS UpVotes,
        SUM(CASE WHEN v.VoteTypeId = 3 THEN 1 ELSE 0 END) AS DownVotes,
        SUM(p.ViewCount) AS TotalViews,
        ROW_NUMBER() OVER (PARTITION BY u.Id ORDER BY SUM(p.ViewCount) DESC) AS ActivityRank
    FROM 
        Users u
    LEFT JOIN 
        Posts p ON u.Id = p.OwnerUserId
    LEFT JOIN 
        Votes v ON p.Id = v.PostId
    GROUP BY 
        u.Id, u.DisplayName
),
RecentPosts AS (
    SELECT 
        p.Id,
        p.Title,
        p.CreationDate,
        p.ViewCount,
        u.DisplayName AS OwnerName,
        p.AcceptedAnswerId,
        ROW_NUMBER() OVER (PARTITION BY u.Id ORDER BY p.CreationDate DESC) AS RecentPostRank
    FROM 
        Posts p
    JOIN 
        Users u ON p.OwnerUserId = u.Id
    WHERE 
        p.CreationDate > (TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '30 days')
),
PostDetails AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        COALESCE(pr.DisplayName, 'Community User') AS OwnerName,
        COALESCE(pa.Title, 'No accepted answer') AS AcceptedAnswerTitle,
        CASE 
            WHEN p.ClosedDate IS NOT NULL THEN 'Closed' 
            ELSE 'Open' 
        END AS PostStatus
    FROM 
        Posts p
    LEFT JOIN 
        Posts pa ON p.AcceptedAnswerId = pa.Id
    LEFT JOIN 
        Users pr ON p.OwnerUserId = pr.Id
    WHERE 
        p.Title IS NOT NULL
)
SELECT 
    ua.UserId,
    ua.DisplayName,
    ua.PostCount,
    ua.UpVotes,
    ua.DownVotes,
    ua.TotalViews,
    pp.Title AS RecentPostTitle,
    pp.CreationDate AS RecentPostDate,
    pp.OwnerName AS RecentPostOwner,
    pd.AcceptedAnswerTitle,
    pd.PostStatus
FROM 
    UserActivity ua
LEFT JOIN 
    RecentPosts pp ON ua.UserId = pp.OwnerUserId AND pp.RecentPostRank = 1
LEFT JOIN 
    PostDetails pd ON pp.Id = pd.PostId
WHERE 
    ua.ActivityRank <= 10
ORDER BY 
    ua.TotalViews DESC
OFFSET 
    0 ROWS
FETCH NEXT 
    10 ROWS ONLY;
