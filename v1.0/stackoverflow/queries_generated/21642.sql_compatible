
WITH RankedPosts AS (
    SELECT 
        p.Id AS PostId,
        p.Title,
        p.CreationDate,
        p.Score,
        p.ViewCount,
        p.AnswerCount,
        p.CommentCount,
        ROW_NUMBER() OVER (PARTITION BY p.PostTypeId ORDER BY p.Score DESC) AS Rank,
        COUNT(v.Id) AS VoteCount
    FROM 
        Posts p
    LEFT JOIN 
        Votes v ON p.Id = v.PostId AND v.VoteTypeId IN (2, 3) 
    WHERE 
        p.CreationDate >= TIMESTAMP '2024-10-01 12:34:56' - INTERVAL '30 days'
    GROUP BY 
        p.Id, p.Title, p.CreationDate, p.Score, p.ViewCount, p.AnswerCount, p.CommentCount
),
PostDetails AS (
    SELECT 
        rp.PostId,
        rp.Title,
        rp.CreationDate,
        rp.Score,
        rp.ViewCount,
        rp.AnswerCount,
        rp.CommentCount,
        rp.Rank,
        COALESCE(SUM(CASE WHEN bh.PostHistoryTypeId = 10 THEN 1 ELSE 0 END), 0) AS CloseCount,
        COUNT(DISTINCT b.UserId) AS BadgeCount 
    FROM 
        RankedPosts rp
    LEFT JOIN 
        PostHistory bh ON rp.PostId = bh.PostId
    LEFT JOIN 
        Badges b ON rp.PostId = b.UserId
    WHERE 
        rp.Rank <= 5 
    GROUP BY 
        rp.PostId, rp.Title, rp.CreationDate, rp.Score, rp.ViewCount, rp.AnswerCount, rp.CommentCount, rp.Rank
),
TopPostStats AS (
    SELECT 
        pd.*,
        CASE 
            WHEN pd.CloseCount > 0 THEN 'Closed'
            ELSE 'Open'
        END AS PostStatus,
        CONCAT('Score: ', pd.Score, ', Votes: ', pd.VoteCount) AS ScoreVoteSummary
    FROM 
        PostDetails pd
)
SELECT 
    tps.*,
    COALESCE(linked.RelatedPostId, 'No Related Post') AS RelatedPostId
FROM 
    TopPostStats tps
LEFT JOIN 
    PostLinks linked ON tps.PostId = linked.PostId
WHERE 
    tps.PostStatus = 'Open'
ORDER BY 
    tps.CreationDate DESC
LIMIT 10;
