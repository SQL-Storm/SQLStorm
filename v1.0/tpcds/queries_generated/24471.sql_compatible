
WITH RankedSales AS (
    SELECT 
        ws_bill_customer_sk, 
        ws_ship_customer_sk, 
        ws_item_sk, 
        ws_order_number,
        ws_net_profit, 
        DENSE_RANK() OVER (PARTITION BY ws_bill_customer_sk ORDER BY ws_net_profit DESC) AS rank_profit
    FROM 
        web_sales
    WHERE 
        ws_net_profit IS NOT NULL
), 
CustomerAddresses AS (
    SELECT 
        c.c_customer_sk, 
        COALESCE(ca.ca_city, 'Unknown') AS city,
        COALESCE(ca.ca_state, 'N/A') AS state,
        COALESCE(ca.ca_country, 'No Country') AS country
    FROM 
        customer c
    LEFT JOIN 
        customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk 
), 
SalesAggregate AS (
    SELECT 
        ca.city, 
        ca.state,
        COUNT(DISTINCT rs.ws_order_number) AS total_orders,
        SUM(rs.ws_net_profit) AS total_profit
    FROM 
        RankedSales rs
    RIGHT JOIN 
        CustomerAddresses ca ON rs.ws_bill_customer_sk = ca.c_customer_sk
    GROUP BY 
        ca.city, 
        ca.state
), 
IncomeAnalysis AS (
    SELECT 
        ca.state,
        SUM(CASE 
            WHEN hd.hd_income_band_sk IS NULL THEN 0 
            ELSE 1 
        END) AS income_count,
        AVG(hd.hd_dep_count) AS avg_dependent_count
    FROM 
        household_demographics hd
    RIGHT JOIN 
        CustomerAddresses ca ON hd.hd_demo_sk = ca.c_customer_sk
    GROUP BY 
        ca.state
)
SELECT 
    sa.city,
    sa.state,
    sa.total_orders,
    sa.total_profit,
    ia.income_count,
    ia.avg_dependent_count,
    CASE 
        WHEN ia.avg_dependent_count IS NULL THEN 'No Income Data' 
        ELSE ia.avg_dependent_count 
    END AS income_status
FROM 
    SalesAggregate sa
FULL OUTER JOIN 
    IncomeAnalysis ia ON sa.state = ia.state
WHERE 
    (sa.total_profit > 1000 OR ia.income_count > 5)
ORDER BY 
    sa.total_profit DESC, 
    ia.income_count ASC;
