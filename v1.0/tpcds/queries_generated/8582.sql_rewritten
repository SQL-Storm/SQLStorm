WITH customer_data AS (
    SELECT c.c_customer_sk, c.c_first_name, c.c_last_name, cd.cd_gender, cd.cd_marital_status, 
           cd.cd_education_status, cd.cd_purchase_estimate, 
           COUNT(CASE WHEN sr_item_sk IS NOT NULL THEN 1 END) AS return_count,
           SUM(COALESCE(sr_return_amt, 0)) AS total_return_amount,
           SUM(COALESCE(ws_ext_sales_price, 0)) AS total_sales_amount
    FROM customer c
    LEFT JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    LEFT JOIN store_returns sr ON c.c_customer_sk = sr.sr_customer_sk 
    LEFT JOIN web_sales ws ON c.c_customer_sk = ws.ws_ship_customer_sk 
    GROUP BY c.c_customer_sk, c.c_first_name, c.c_last_name, cd.cd_gender, 
             cd.cd_marital_status, cd.cd_education_status, cd.cd_purchase_estimate
),
date_summary AS (
    SELECT d.d_year, d.d_month_seq, SUM(total_sales_amount) AS monthly_sales, 
           SUM(total_return_amount) AS monthly_returns
    FROM customer_data
    JOIN date_dim d ON d.d_date_sk = YEAR(cast('2002-10-01' as date)) * 10000 + MONTH(cast('2002-10-01' as date)) * 100 + 1
    GROUP BY d.d_year, d.d_month_seq
),
income_summary AS (
    SELECT ib.ib_income_band_sk, 
           COUNT(c.c_customer_sk) AS customer_count, 
           SUM(total_sales_amount) AS total_income
    FROM customer_data c
    JOIN household_demographics hd ON c.c_customer_sk = hd.hd_demo_sk 
    JOIN income_band ib ON hd.hd_income_band_sk = ib.ib_income_band_sk
    GROUP BY ib.ib_income_band_sk
)
SELECT 
    cs.c_first_name,
    cs.c_last_name,
    d.d_year,
    d.d_month_seq,
    ib.ib_income_band_sk,
    cs.total_sales_amount,
    d.monthly_sales,
    d.monthly_returns,
    is.customer_count,
    is.total_income
FROM customer_data cs
JOIN date_summary d ON d.d_year = YEAR(cast('2002-10-01' as date)) AND d.d_month_seq = MONTH(cast('2002-10-01' as date))
JOIN income_summary is ON cs.c_customer_sk = is.customer_count
WHERE total_sales_amount > 10000
ORDER BY d.d_year, d.d_month_seq, cs.c_last_name;