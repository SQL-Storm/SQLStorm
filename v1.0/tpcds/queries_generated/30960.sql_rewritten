WITH RECURSIVE sales_hierarchy AS (
    SELECT
        ws.bill_customer_sk AS customer_sk,
        SUM(ws.net_paid) AS total_sales,
        COUNT(ws.order_number) AS order_count,
        ROW_NUMBER() OVER (PARTITION BY ws.bill_customer_sk ORDER BY SUM(ws.net_paid) DESC) as rank
    FROM
        web_sales ws
    WHERE
        ws.sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_year = 2001)
    GROUP BY
        ws.bill_customer_sk
),
customer_info AS (
    SELECT
        c.c_customer_sk,
        CONCAT(c.c_first_name, ' ', c.c_last_name) AS full_name,
        cd.cd_gender,
        cd.cd_marital_status,
        hd.hd_income_band_sk
    FROM
        customer c
    LEFT JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    LEFT JOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk
),
top_customers AS (
    SELECT
        sh.customer_sk,
        c.full_name,
        c.cd_gender,
        c.cd_marital_status,
        c.hd_income_band_sk,
        sh.total_sales,
        sh.order_count
    FROM
        sales_hierarchy sh
    JOIN customer_info c ON sh.customer_sk = c.c_customer_sk
    WHERE
        sh.rank <= 10
),
sales_summary AS (
    SELECT
        COALESCE(gd.ib_income_band_sk, 0) AS income_band,
        COUNT(tc.customer_sk) AS customer_count,
        SUM(tc.total_sales) AS total_sales,
        AVG(tc.order_count) AS avg_orders
    FROM
        income_band gd
    LEFT JOIN top_customers tc ON gd.ib_income_band_sk = tc.hd_income_band_sk
    GROUP BY
        gd.ib_income_band_sk
)
SELECT
    i.ib_income_band_sk,
    i.ib_lower_bound,
    i.ib_upper_bound,
    ss.customer_count,
    ss.total_sales,
    ss.avg_orders
FROM
    income_band i
LEFT JOIN sales_summary ss ON i.ib_income_band_sk = ss.income_band
ORDER BY
    i.ib_income_band_sk;