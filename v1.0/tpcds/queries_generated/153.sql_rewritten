WITH sales_summary AS (
    SELECT 
        ws_sold_date_sk,
        ws_item_sk,
        SUM(ws_quantity) AS total_quantity,
        SUM(ws_net_profit) AS total_profit,
        COUNT(DISTINCT ws_order_number) AS order_count
    FROM 
        web_sales
    GROUP BY 
        ws_sold_date_sk, ws_item_sk
),
daily_profit AS (
    SELECT 
        d_date_id,
        SUM(total_profit) AS total_daily_profit,
        SUM(total_quantity) AS total_daily_quantity,
        RANK() OVER (ORDER BY SUM(total_profit) DESC) AS profit_rank
    FROM 
        date_dim 
    JOIN 
        sales_summary ON d_date_sk = ws_sold_date_sk
    GROUP BY 
        d_date_id
),
item_details AS (
    SELECT 
        i_item_sk,
        i_item_id,
        i_product_name,
        COALESCE(i_current_price, 0) AS current_price
    FROM 
        item
),
customer_info AS (
    SELECT 
        c_customer_sk,
        cd_gender,
        cd_age_group,
        cd_demo_sk
    FROM 
        customer
    JOIN 
        customer_demographics ON c_current_cdemo_sk = cd_demo_sk
    WHERE 
        cd_gender = 'F'
)
SELECT 
    dd.d_date_id,
    SUM(dp.total_daily_profit) as total_profit,
    COUNT(DISTINCT ci.c_customer_sk) AS unique_female_customers,
    (SELECT COUNT(DISTINCT ci_inner.c_customer_sk)
     FROM customer_info ci_inner 
     WHERE ci_inner.cd_age_group = '30-40') AS count_age_group_30_40,
    MAX(id.current_price) AS max_item_price,
    STRING_AGG(DISTINCT id.i_product_name, ', ') AS top_products
FROM 
    daily_profit dp
JOIN 
    daily_profit dp_sub ON dp.profit_rank <= 5
JOIN 
    date_dim dd ON dp.ws_sold_date_sk = dd.d_date_sk
JOIN 
    item_details id ON dp.ws_item_sk = id.i_item_sk
LEFT JOIN 
    customer_info ci ON ci.c_customer_sk IN (
        SELECT 
            DISTINCT ws_bill_customer_sk 
        FROM 
            web_sales 
        WHERE 
            ws_sold_date_sk = dp.ws_sold_date_sk
    )
WHERE 
    dd.d_dow NOT IN (1, 7) 
GROUP BY 
    dd.d_date_id
ORDER BY 
    total_profit DESC;