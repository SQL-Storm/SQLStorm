
WITH RECURSIVE AddressCTE AS (
    SELECT ca_address_sk, ca_street_number, ca_street_name, ca_city, ca_state, ca_zip, 
           ROW_NUMBER() OVER (PARTITION BY ca_city ORDER BY ca_address_sk) AS rn
    FROM customer_address
    WHERE ca_state = 'CA'
), CustomerPurchase AS (
    SELECT c.c_customer_id, c.c_first_name, c.c_last_name, 
           COALESCE(SUM(ws.ws_net_paid_inc_tax), 0) AS total_spent
    FROM customer c
    LEFT JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
    WHERE ws.ws_sold_date_sk IN (
        SELECT d.d_date_sk 
        FROM date_dim d 
        WHERE d.d_year = 2023
    )
    GROUP BY c.c_customer_id, c.c_first_name, c.c_last_name
), HighValueCustomers AS (
    SELECT *, DENSE_RANK() OVER (ORDER BY total_spent DESC) AS rank
    FROM CustomerPurchase
    WHERE total_spent > (
        SELECT AVG(total_spent) 
        FROM CustomerPurchase
    )
), ShipModeCount AS (
    SELECT sm.sm_type, COUNT(ws.ws_order_number) AS order_count
    FROM ship_mode sm
    LEFT JOIN web_sales ws ON sm.sm_ship_mode_sk = ws.ws_ship_mode_sk
    GROUP BY sm.sm_type
), ShipModeHighValueCustomers AS (
    SELECT cvc.c_customer_id, cvc.c_first_name, cvc.c_last_name,
           smc.order_count
    FROM HighValueCustomers cvc
    LEFT JOIN ShipModeCount smc ON cvc.total_spent >= 1000
)
SELECT a.ca_street_number, 
       a.ca_street_name, 
       a.ca_city, 
       a.ca_zip, 
       hvc.c_customer_id, 
       hvc.c_first_name, 
       hvc.c_last_name, 
       COALESCE(smh.order_count, 0) AS total_orders
FROM AddressCTE a
JOIN ShipModeHighValueCustomers hvc ON a.ca_city = hvc.c_city
LEFT JOIN (
    SELECT c.c_customer_id, COUNT(*) AS city_customer_count
    FROM customer c
    GROUP BY c.c_customer_id
) AS city_count ON hvc.c_customer_id = city_count.c_customer_id
WHERE a.rn < 5
ORDER BY a.ca_street_name, total_orders DESC
LIMIT 10;
