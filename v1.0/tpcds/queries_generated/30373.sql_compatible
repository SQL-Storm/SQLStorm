
WITH RECURSIVE sales_summary AS (
    SELECT 
        ws.web_site_sk,
        ws.web_name,
        SUM(ws.ws_net_profit) AS total_net_profit,
        COUNT(DISTINCT ws.ws_order_number) AS total_orders,
        ROW_NUMBER() OVER (PARTITION BY ws.web_site_sk ORDER BY SUM(ws.ws_net_profit) DESC) AS rank
    FROM 
        web_sales ws
    JOIN 
        date_dim dd ON ws.ws_sold_date_sk = dd.d_date_sk
    WHERE 
        dd.d_year = 2023
    GROUP BY 
        ws.web_site_sk, ws.web_name
    HAVING 
        SUM(ws.ws_net_profit) > 10000

    UNION ALL

    SELECT 
        ss.web_site_sk,
        ss.web_name,
        ss.total_net_profit + 1000 AS total_net_profit,
        ss.total_orders + 1 AS total_orders,
        ss.rank
    FROM 
        sales_summary ss
    WHERE 
        ss.total_net_profit < 20000
)

SELECT 
    ca.ca_city,
    ca.ca_state,
    SUM(COALESCE(ss.total_net_profit, 0)) AS total_sales_profit,
    AVG(ss.total_orders) AS average_orders,
    MAX(ss.rank) AS max_rank
FROM 
    customer_address ca
LEFT JOIN 
    customer c ON ca.ca_address_sk = c.c_current_addr_sk
LEFT JOIN 
    sales_summary ss ON c.c_customer_sk = ss.web_site_sk 
GROUP BY 
    ca.ca_city, ca.ca_state
HAVING 
    SUM(COALESCE(ss.total_net_profit, 0)) IS NOT NULL 
    AND MAX(ss.rank) IS NOT NULL
ORDER BY 
    total_sales_profit DESC
LIMIT 10;
