
WITH CustomerReturns AS (
    SELECT 
        cr.returning_customer_sk,
        cr.returning_cdemo_sk,
        SUM(cr.return_amount) AS total_return_amount,
        COUNT(cr.return_quantity) AS total_returned_items
    FROM 
        catalog_returns cr
    WHERE 
        cr.return_quantity > 0
    GROUP BY 
        cr.returning_customer_sk, cr.returning_cdemo_sk
), 
SalesData AS (
    SELECT 
        ws.bill_customer_sk,
        ws.bill_cdemo_sk,
        SUM(ws.ext_sales_price) AS total_sales_amount,
        COUNT(ws.order_number) AS total_orders,
        AVG(ws.net_profit) AS average_profit
    FROM 
        web_sales ws
    JOIN 
        CustomerReturns cr ON ws.bill_customer_sk = cr.returning_customer_sk
    GROUP BY 
        ws.bill_customer_sk, ws.bill_cdemo_sk
)
SELECT 
    CASE 
        WHEN cd.cd_gender = 'M' THEN 'Male'
        WHEN cd.cd_gender = 'F' THEN 'Female'
        ELSE 'Unspecified' 
    END AS customer_gender,
    cd.cd_marital_status,
    s.total_sales_amount,
    s.total_orders,
    s.average_profit,
    cr.total_return_amount,
    cr.total_returned_items,
    COALESCE(NULLIF(cr.total_return_amount, 0), 'No Returns') AS return_status
FROM 
    customer_demographics cd
LEFT JOIN 
    SalesData s ON cd.cd_demo_sk = s.bill_cdemo_sk
LEFT JOIN 
    CustomerReturns cr ON cd.cd_demo_sk = cr.returning_cdemo_sk
WHERE 
    (s.total_sales_amount > 1000 OR cr.total_returned_items > 5)
ORDER BY 
    customer_gender DESC, 
    total_sales_amount DESC;
