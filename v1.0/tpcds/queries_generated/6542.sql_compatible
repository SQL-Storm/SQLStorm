
WITH CustomerSales AS (
    SELECT 
        c.c_customer_id,
        SUM(COALESCE(ss.ss_ext_sales_price, 0) + COALESCE(ws.ws_ext_sales_price, 0)) AS total_sales
    FROM customer c
    LEFT JOIN store_sales ss ON c.c_customer_sk = ss.ss_customer_sk
    LEFT JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
    GROUP BY c.c_customer_id
),
GenderDistribution AS (
    SELECT 
        cd.cd_gender,
        COUNT(DISTINCT cs.c_customer_id) AS customer_count,
        SUM(cs.total_sales) AS total_sales
    FROM CustomerSales cs
    JOIN customer_demographics cd ON cs.c_customer_id = cd.cd_demo_sk
    GROUP BY cd.cd_gender
),
SalesByWarehouse AS (
    SELECT 
        w.w_warehouse_id,
        SUM(COALESCE(ss.ss_ext_sales_price, 0)) AS store_sales,
        SUM(COALESCE(ws.ws_ext_sales_price, 0)) AS online_sales,
        SUM(COALESCE(ss.ss_ext_sales_price, 0) + COALESCE(ws.ws_ext_sales_price, 0)) AS total_sales
    FROM warehouse w
    LEFT JOIN store_sales ss ON w.w_warehouse_sk = ss.ss_warehouse_sk
    LEFT JOIN web_sales ws ON w.w_warehouse_sk = ws.ws_warehouse_sk
    GROUP BY w.w_warehouse_id
),
SalesStatistics AS (
    SELECT 
        gd.cd_gender,
        COUNT(gd.customer_count) AS customer_count,
        SUM(gd.total_sales) AS total_sales,
        AVG(gd.total_sales) AS avg_sales,
        MAX(gd.total_sales) AS max_sales,
        MIN(gd.total_sales) AS min_sales
    FROM GenderDistribution gd
    GROUP BY gd.cd_gender
)
SELECT 
    s.w_warehouse_id,
    ss.cd_gender,
    ss.customer_count,
    ss.total_sales,
    ss.avg_sales,
    ss.max_sales,
    ss.min_sales
FROM SalesByWarehouse s
CROSS JOIN (SELECT cd.cd_gender 
            FROM customer_demographics cd 
            ORDER BY RANDOM() LIMIT 1) AS subquery
JOIN SalesStatistics ss ON ss.cd_gender = subquery.cd_gender
ORDER BY s.w_warehouse_id, ss.total_sales DESC;
