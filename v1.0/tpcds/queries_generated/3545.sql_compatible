
WITH RankedSales AS (
    SELECT 
        ws.web_site_id, 
        ws.ws_order_number,
        ws.ws_quantity,
        ws.ws_sales_price,
        ROW_NUMBER() OVER (PARTITION BY ws.web_site_id ORDER BY ws.ws_sales_price DESC) AS rank_sales
    FROM 
        web_sales ws
    WHERE 
        ws.ws_sales_price > 0
),
StoreSalesSummary AS (
    SELECT 
        ss.ss_store_sk,
        SUM(ss.ss_sales_price) AS total_sales,
        COUNT(DISTINCT ss.ss_ticket_number) AS total_transactions
    FROM 
        store_sales ss
    GROUP BY 
        ss.ss_store_sk
),
CustomerReturns AS (
    SELECT 
        sr.sr_customer_sk,
        SUM(COALESCE(sr.sr_return_amt_inc_tax, 0)) AS total_returned
    FROM 
        store_returns sr
    GROUP BY 
        sr.sr_customer_sk
),
ReturnPercentage AS (
    SELECT 
        cs.cc_call_center_sk,
        (SUM(COALESCE(CR.total_returned, 0)) / NULLIF(SUM(ss.total_sales), 0)) * 100 AS return_rate
    FROM 
        StoreSalesSummary ss
    LEFT JOIN 
        CustomerReturns CR ON ss.ss_store_sk = CR.sr_customer_sk
    GROUP BY 
        cs.cc_call_center_sk
)
SELECT 
    site.web_site_id,
    ss.total_sales,
    rp.return_rate,
    ROW_NUMBER() OVER (ORDER BY rp.return_rate DESC) AS site_rank
FROM 
    RankedSales site
JOIN 
    ReturnPercentage rp ON site.web_site_id = rp.cc_call_center_sk
WHERE 
    rp.return_rate > 5
ORDER BY 
    rp.return_rate DESC;
