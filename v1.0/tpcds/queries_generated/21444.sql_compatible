
WITH CustomerStats AS (
    SELECT 
        c.c_customer_sk, 
        COUNT(DISTINCT sr_ticket_number) AS return_count, 
        AVG(COALESCE(sr_return_amt, 0)) AS avg_return_amt,
        SUM(COALESCE(sr_return_quantity, 0)) AS total_return_quantity
    FROM 
        customer c
    LEFT JOIN 
        store_returns sr ON c.c_customer_sk = sr.sr_customer_sk
    GROUP BY 
        c.c_customer_sk
),
ItemSales AS (
    SELECT 
        ws_item_sk,
        SUM(ws_quantity) AS total_quantity_sold,
        SUM(ws_net_paid) AS total_sales
    FROM 
        web_sales
    GROUP BY 
        ws_item_sk
),
ReturnsSummary AS (
    SELECT 
        i.i_item_sk,
        SUM(COALESCE(cr_return_quantity, 0)) AS total_catalog_returns,
        SUM(COALESCE(wr_return_quantity, 0)) AS total_web_returns
    FROM 
        item i
    LEFT JOIN 
        catalog_returns cr ON i.i_item_sk = cr.cr_item_sk
    LEFT JOIN 
        web_returns wr ON i.i_item_sk = wr.wr_item_sk
    GROUP BY 
        i.i_item_sk
),
RankedReturns AS (
    SELECT 
        ir.*,
        ROW_NUMBER() OVER (PARTITION BY ir.i_item_sk ORDER BY ir.total_catalog_returns + ir.total_web_returns DESC) AS rank
    FROM 
        ReturnsSummary ir
)
SELECT 
    c.c_customer_id, 
    cs.return_count, 
    cs.avg_return_amt, 
    is.total_quantity_sold,
    is.total_sales,
    rr.i_item_sk,
    rr.total_catalog_returns,
    rr.total_web_returns
FROM 
    CustomerStats cs
JOIN 
    customer c ON c.c_customer_sk = cs.c_customer_sk
JOIN 
    ItemSales is ON is.ws_item_sk IN (SELECT i_item_sk FROM item WHERE i_brand_id = (SELECT i_brand_id FROM item GROUP BY i_brand_id ORDER BY COUNT(*) DESC LIMIT 1))
LEFT JOIN 
    RankedReturns rr ON rr.i_item_sk IN (SELECT i_item_sk FROM item WHERE i_category_id = (SELECT DISTINCT i_category_id FROM item WHERE i_color LIKE '%Red%' AND i_formulation = 'Liquid' LIMIT 5))
WHERE 
    cs.total_return_quantity > 0 
    AND (is.total_sales / NULLIF(is.total_quantity_sold, 0) > 20 OR cs.avg_return_amt > 50)
ORDER BY 
    cs.return_count DESC, is.total_sales DESC
LIMIT 100;
