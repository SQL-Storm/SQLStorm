
WITH RECURSIVE sales_data AS (
    SELECT
        ws.web_site_sk,
        SUM(ws.ws_sales_price) AS total_sales,
        COUNT(ws.ws_order_number) AS order_count
    FROM
        web_sales ws
    JOIN
        web_site w ON ws.ws_web_site_sk = w.web_site_sk
    GROUP BY
        ws.web_site_sk
    HAVING
        SUM(ws.ws_sales_price) IS NOT NULL
        AND COUNT(ws.ws_order_number) > 5
),

customer_stats AS (
    SELECT
        c.c_customer_sk,
        MAX(CASE WHEN cd.cd_gender = 'M' THEN 1 ELSE 0 END) AS male_count,
        MAX(CASE WHEN cd.cd_gender = 'F' THEN 1 ELSE 0 END) AS female_count,
        COUNT(*) AS customer_count
    FROM
        customer c
    LEFT JOIN
        customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    GROUP BY
        c.c_customer_sk
),

address_counts AS (
    SELECT
        c.c_customer_id,
        COUNT(DISTINCT ca.ca_address_id) AS address_count
    FROM
        customer c
    JOIN
        customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
    GROUP BY
        c.c_customer_id
),

promotion_usage AS (
    SELECT
        p.p_promo_id,
        COUNT(ws.ws_order_number) AS usage_count
    FROM
        promotion p
    LEFT JOIN
        web_sales ws ON p.p_promo_sk = ws.ws_promo_sk
    GROUP BY
        p.p_promo_id
    HAVING
        COUNT(ws.ws_order_number) > 0
)

SELECT
    w.web_name AS website_name,
    COALESCE(sd.total_sales, 0) AS total_sales,
    COALESCE(sd.order_count, 0) AS total_orders,
    COALESCE(cust.male_count, 0) AS male_customers,
    COALESCE(cust.female_count, 0) AS female_customers,
    CASE
        WHEN addr.address_count IS NULL THEN 'No Addresses'
        ELSE CONCAT('Addresses: ', CAST(addr.address_count AS VARCHAR))
    END AS address_info,
    COALESCE(promo.usage_count, 0) AS promotion_usage
FROM
    sales_data sd
FULL OUTER JOIN
    customer_stats cust ON cust.customer_count > 0
FULL OUTER JOIN
    address_counts addr ON addr.c_customer_id = cust.c_customer_sk
FULL OUTER JOIN
    promotion_usage promo ON promo.usage_count > 0
JOIN
    web_site w ON w.web_site_sk = sd.web_site_sk
WHERE
    w.web_open_date_sk IS NOT NULL
ORDER BY
    total_sales DESC, total_orders DESC, male_customers DESC
LIMIT 10;
