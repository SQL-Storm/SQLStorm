
WITH AddressInfo AS (
    SELECT 
        ca_address_sk, 
        TRIM(CONCAT_WS(' ', ca_street_number, ca_street_name, ca_street_type, 
            CASE WHEN ca_suite_number IS NOT NULL THEN CONCAT('Suite ', ca_suite_number) ELSE '' END)) AS full_address,
        ca_city, 
        ca_state, 
        ca_zip
    FROM customer_address
),
CustomerInfo AS (
    SELECT 
        c_customer_sk,
        CONCAT(c_first_name, ' ', c_last_name) AS full_name,
        c_email_address,
        cd_gender,
        cd_marital_status,
        cd_education_status,
        cd_birth_year
    FROM customer c
    JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
),
SalesInfo AS (
    SELECT 
        ws_item_sk,
        SUM(ws_quantity) AS total_sales_quantity,
        SUM(ws_net_paid) AS total_sales_amount,
        COUNT(DISTINCT ws_order_number) AS order_count
    FROM web_sales
    GROUP BY ws_item_sk
),
PromotionInfo AS (
    SELECT 
        p.p_promo_id,
        p.p_promo_name,
        COUNT(DISTINCT ws_order_number) AS promo_usage_count
    FROM promotion p
    JOIN web_sales ws ON p.p_promo_sk = ws.ws_promo_sk
    GROUP BY p.p_promo_id, p.p_promo_name
)
SELECT 
    ci.full_name,
    ci.c_email_address,
    ai.full_address,
    ai.ca_city,
    ai.ca_state,
    ai.ca_zip,
    sa.total_sales_quantity,
    sa.total_sales_amount,
    pi.promo_usage_count,
    DATEDIFF(CURRENT_DATE, DATE(CONCAT(ci.cd_birth_year, '-01-01'))) AS age
FROM CustomerInfo ci
JOIN AddressInfo ai ON ci.c_customer_sk = ai.ca_address_sk
LEFT JOIN SalesInfo sa ON ci.c_customer_sk = sa.ws_item_sk
LEFT JOIN PromotionInfo pi ON sa.ws_item_sk IN (
    SELECT cs_item_sk FROM catalog_sales 
    WHERE cs_order_number IN (
        SELECT ws_order_number FROM web_sales WHERE ws_bill_customer_sk = ci.c_customer_sk
    )
)
WHERE ci.cd_gender = 'F' AND ci.cd_marital_status = 'M' AND ai.ca_state = 'CA'
ORDER BY sa.total_sales_amount DESC, ci.full_name;
