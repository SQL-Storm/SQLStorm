
WITH RankedSales AS (
    SELECT 
        ws_customer_sk,
        SUM(ws_ext_sales_price) AS total_sales,
        RANK() OVER (PARTITION BY ws_customer_sk ORDER BY SUM(ws_ext_sales_price) DESC) AS sales_rank
    FROM web_sales
    GROUP BY ws_customer_sk
),
HighValueCustomers AS (
    SELECT 
        c.c_customer_id,
        cd.cd_gender,
        cd.cd_marital_status,
        RANK() OVER (ORDER BY total_sales DESC) AS customer_rank
    FROM RankedSales rs
    JOIN customer c ON rs.ws_customer_sk = c.c_customer_sk
    JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    WHERE rs.total_sales > 50000
),
StoreSalesAnalysis AS (
    SELECT 
        ss_store_sk,
        COUNT(DISTINCT ss_customer_sk) AS unique_customers,
        SUM(ss_ext_sales_price) AS total_store_sales,
        MAX(ss_sales_price) AS max_item_price
    FROM store_sales
    GROUP BY ss_store_sk
    HAVING COUNT(ss_customer_sk) > 10
),
PromotionsUsed AS (
    SELECT 
        ws.web_site_id,
        COUNT(DISTINCT ws.ws_order_number) AS orders_with_promotions
    FROM web_sales ws
    JOIN promotion p ON ws.ws_promo_sk = p.p_promo_sk
    WHERE p.p_discount_active = 'Y'
    GROUP BY ws.web_site_id
),
SalesConfidence AS (
    SELECT 
        hvc.c_customer_id,
        COUNT(DISTINCT hs.ws_order_number) AS high_profit_orders,
        AVG(hs.ws_net_profit) AS average_profit
    FROM HighValueCustomers hvc
    JOIN web_sales hs ON hvc.c_customer_id = hs.ws_bill_customer_sk
    WHERE hs.ws_net_profit IS NOT NULL
    GROUP BY hvc.c_customer_id
    HAVING AVG(hs.ws_net_profit) > 100
)
SELECT 
    hvc.c_customer_id,
    hvc.cd_gender,
    ssa.total_store_sales,
    pwu.orders_with_promotions,
    sc.high_profit_orders,
    sc.average_profit
FROM HighValueCustomers hvc
JOIN StoreSalesAnalysis ssa ON hvc.c_customer_id = ssa.ss_store_sk
LEFT JOIN PromotionsUsed pwu ON pwu.web_site_id = (
        SELECT wp.web_site_id
        FROM web_page wp
        WHERE wp.wp_customer_sk = hvc.c_customer_id
        ORDER BY wp.wp_creation_date_sk DESC
        FETCH FIRST 1 ROWS ONLY
    )
LEFT JOIN SalesConfidence sc ON hvc.c_customer_id = sc.c_customer_id
WHERE hvc.customer_rank <= 50
ORDER BY ssa.total_store_sales DESC, sc.average_profit DESC
FETCH FIRST 10 ROWS ONLY;
