
WITH RECURSIVE sales_hierarchy AS (
    SELECT cs_bill_customer_sk, SUM(cs_net_profit) AS total_profit
    FROM catalog_sales
    WHERE cs_sold_date_sk BETWEEN 2452001 AND 2452010
    GROUP BY cs_bill_customer_sk
    UNION ALL
    SELECT s.ss_customer_sk, SUM(s.ss_net_profit) AS total_profit
    FROM store_sales s
    INNER JOIN sales_hierarchy sh ON s.ss_customer_sk = sh.cs_bill_customer_sk
    WHERE s.ss_sold_date_sk BETWEEN 2452001 AND 2452010
    GROUP BY s.ss_customer_sk
),
income_distribution AS (
    SELECT cd_demo_sk, COUNT(*) AS demographic_count
    FROM customer_demographics cd
    JOIN customer c ON cd.cd_demo_sk = c.c_current_cdemo_sk
    WHERE c.c_birth_year IS NOT NULL
    GROUP BY cd_demo_sk
),
top_sales AS (
    SELECT cs.cs_item_sk, SUM(cs.cs_net_profit) AS total_item_profit
    FROM catalog_sales cs
    INNER JOIN item i ON cs.cs_item_sk = i.i_item_sk
    WHERE cs.cs_sold_date_sk BETWEEN 2452001 AND 2452010
    AND i.i_current_price > (SELECT AVG(i2.i_current_price) FROM item i2)
    GROUP BY cs.cs_item_sk
    HAVING SUM(cs.cs_net_profit) > 1000
)

SELECT 
    c.c_customer_id, 
    ca.ca_city, 
    CONCAT('Customer Gender: ', cd.cd_gender) AS gender_info,
    COALESCE(si.total_profit, 0) AS total_sales_profit,
    id.demographic_count
FROM customer c
LEFT JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
LEFT JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
LEFT JOIN (SELECT cs_bill_customer_sk, SUM(total_profit) AS total_profit FROM sales_hierarchy GROUP BY cs_bill_customer_sk) si ON c.c_customer_sk = si.cs_bill_customer_sk
LEFT JOIN income_distribution id ON cd.cd_demo_sk = id.cd_demo_sk
WHERE cd.cd_marital_status = 'M'
AND ca.ca_state = 'CA'
AND id.demographic_count IS NOT NULL
ORDER BY total_sales_profit DESC
LIMIT 10;
