
WITH RECURSIVE top_customers AS (
    SELECT c.c_customer_id, SUM(ws.ws_net_paid) AS total_spent
    FROM customer c
    JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
    GROUP BY c.c_customer_id
    ORDER BY total_spent DESC
    LIMIT 5
),
sales_summary AS (
    SELECT 
        d.d_year,
        d.d_month_seq,
        SUM(ws.ws_quantity) AS total_quantity_sold,
        SUM(ws.ws_net_paid) AS total_sales,
        COUNT(DISTINCT ws.ws_order_number) AS total_orders
    FROM date_dim d
    JOIN web_sales ws ON d.d_date_sk = ws.ws_sold_date_sk
    GROUP BY d.d_year, d.d_month_seq
),
inventory_status AS (
    SELECT 
        i.i_item_id,
        SUM(i.inv_quantity_on_hand) AS total_quantity_in_stock
    FROM inventory i
    GROUP BY i.i_item_id
),
customer_returns AS (
    SELECT 
        sr_item_sk,
        COUNT(sr_return_quantity) AS total_returns,
        SUM(sr_return_amt_inc_tax) AS total_return_amount
    FROM store_returns
    GROUP BY sr_item_sk
)
SELECT 
    c.c_customer_id,
    tc.total_spent,
    ss.d_year,
    ss.d_month_seq,
    ss.total_quantity_sold,
    ss.total_sales,
    ss.total_orders,
    COALESCE(ir.total_quantity_in_stock, 0) AS total_quantity_in_stock,
    COALESCE(cr.total_returns, 0) AS total_returns,
    COALESCE(cr.total_return_amount, 0) AS total_return_amount
FROM top_customers tc
JOIN sales_summary ss ON 1=1
LEFT JOIN inventory_status ir ON ir.i_item_id IN (SELECT DISTINCT ws.ws_item_sk FROM web_sales ws WHERE ws.ws_bill_customer_sk = tc.c_customer_id)
LEFT JOIN customer_returns cr ON cr.sr_item_sk IN (SELECT DISTINCT wr.wr_item_sk FROM web_returns wr WHERE wr.wr_returning_customer_sk = tc.c_customer_id)
ORDER BY tc.total_spent DESC, ss.d_year, ss.d_month_seq;
