
WITH ranked_web_sales AS (
    SELECT 
        ws.sold_date_sk, 
        ws.item_sk,
        ws.ws_net_profit,
        RANK() OVER (PARTITION BY ws.sold_date_sk ORDER BY ws.ws_net_profit DESC) AS rank_profit
    FROM 
        web_sales ws
    WHERE 
        ws.ws_net_profit IS NOT NULL
),
total_sales AS (
    SELECT 
        d.d_date,
        SUM(ws.ws_net_profit) AS total_net_profit
    FROM 
        date_dim d
    JOIN 
        web_sales ws ON d.d_date_sk = ws.ws_sold_date_sk
    GROUP BY 
        d.d_date
),
customer_info AS (
    SELECT 
        c.c_customer_sk,
        cd.cd_gender,
        hd.hd_income_band_sk
    FROM 
        customer c
    LEFT JOIN 
        customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    LEFT JOIN 
        household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk
)
SELECT 
    ci.c_customer_sk,
    ci.cd_gender,
    ib.ib_lower_bound,
    ib.ib_upper_bound,
    COUNT(DISTINCT rws.item_sk) AS unique_items_ranked,
    MAX(t.total_net_profit) AS max_total_net_profit,
    AVG(CASE WHEN rws.rank_profit <= 5 THEN rws.ws_net_profit ELSE NULL END) AS avg_top_5_net_profit
FROM 
    customer_info ci
LEFT JOIN 
    income_band ib ON ci.hd_income_band_sk = ib.ib_income_band_sk
LEFT JOIN 
    ranked_web_sales rws ON ci.c_customer_sk = rws.item_sk
LEFT JOIN 
    total_sales t ON CAST(rws.sold_date_sk AS DATE) = t.d_date
GROUP BY 
    ci.c_customer_sk, ci.cd_gender, ib.ib_lower_bound, ib.ib_upper_bound
HAVING 
    COUNT(DISTINCT rws.item_sk) > 0
ORDER BY 
    max_total_net_profit DESC
LIMIT 50;
