
WITH CustomerCity AS (
    SELECT 
        c.c_customer_sk,
        c.c_city,
        c.c_first_name || ' ' || c.c_last_name AS full_name,
        d.d_date AS purchase_date,
        d.d_month_seq,
        d.d_year
    FROM 
        customer AS c 
    JOIN 
        date_dim AS d ON c.c_first_sales_date_sk = d.d_date_sk 
    WHERE 
        c.c_city IS NOT NULL
),
AddressCount AS (
    SELECT 
        ca_city,
        COUNT(DISTINCT ca_address_sk) AS address_count
    FROM 
        customer_address
    GROUP BY 
        ca_city
),
MonthlyPurchases AS (
    SELECT 
        c.c_city,
        COUNT(*) AS total_purchases,
        SUM(CASE WHEN c.c_city ILIKE '%York%' THEN 1 ELSE 0 END) AS york_purchases
    FROM 
        CustomerCity AS c
    GROUP BY 
        c.c_city
)
SELECT 
    a.ca_city,
    m.total_purchases,
    m.york_purchases,
    a.address_count,
    (m.york_purchases / NULLIF(m.total_purchases, 0)::float) * 100 AS york_percentage
FROM 
    AddressCount AS a
JOIN 
    MonthlyPurchases AS m ON a.ca_city = m.c_city
WHERE 
    a.address_count > 10
ORDER BY 
    york_percentage DESC;
