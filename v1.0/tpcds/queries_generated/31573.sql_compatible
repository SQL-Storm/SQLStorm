
WITH RECURSIVE sales_hierarchy AS (
    SELECT 
        s_store_sk,
        s_store_name,
        1 AS level,
        s_manager,
        CAST(s_store_name AS VARCHAR(100)) AS full_path
    FROM 
        store
    WHERE 
        s_manager IS NOT NULL
    
    UNION ALL
    
    SELECT 
        st.s_store_sk,
        st.s_store_name,
        sh.level + 1,
        st.s_manager,
        CAST(sh.full_path || ' -> ' || st.s_store_name AS VARCHAR(100)) AS full_path
    FROM 
        store st
    JOIN 
        sales_hierarchy sh ON st.s_manager = sh.s_store_name
)
SELECT 
    ca.c_city,
    COUNT(DISTINCT c.c_customer_id) AS num_customers,
    SUM(ws.ws_net_profit) AS total_net_profit,
    ROUND(AVG(CASE WHEN cd.cd_gender = 'F' THEN ws.ws_net_profit END), 2) AS avg_female_profit,
    ROUND(AVG(CASE WHEN cd.cd_gender = 'M' THEN ws.ws_net_profit END), 2) AS avg_male_profit
FROM 
    customer c 
LEFT JOIN 
    customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
LEFT JOIN 
    customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
LEFT JOIN 
    web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk 
LEFT JOIN 
    store_returns sr ON c.c_customer_sk = sr.sr_customer_sk 
LEFT JOIN 
    sales_hierarchy sh ON sh.s_store_sk = sr.s_store_sk 
WHERE 
    ca.ca_state = 'CA' 
    AND (ws.ws_sales_price - ws.ws_net_paid > 0 OR sr.sr_return_quantity IS NOT NULL) 
GROUP BY 
    ca.c_city
HAVING 
    COUNT(DISTINCT c.c_customer_id) > 10 
ORDER BY 
    total_net_profit DESC
LIMIT 10;
