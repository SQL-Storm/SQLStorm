WITH top_items AS (
    SELECT ws_item_sk, SUM(ws_quantity) AS total_quantity
    FROM web_sales
    WHERE ws_sold_date_sk BETWEEN (SELECT MAX(d_date_sk) FROM date_dim WHERE d_year = 2000) - 30 AND (SELECT MAX(d_date_sk) FROM date_dim WHERE d_year = 2000)
    GROUP BY ws_item_sk
    ORDER BY total_quantity DESC
    LIMIT 10
), 
customer_age AS (
    SELECT c_customer_sk, EXTRACT(YEAR FROM cast('2002-10-01' as date)) - c_birth_year AS age
    FROM customer
    WHERE c_birth_year IS NOT NULL
), 
demographics AS (
    SELECT cd_demo_sk, cd_gender, cd_marital_status, cd_education_status
    FROM customer_demographics
), 
sales AS (
    SELECT ws_bill_customer_sk, SUM(ws_net_paid) AS total_spent
    FROM web_sales
    WHERE ws_sold_date_sk BETWEEN (SELECT MAX(d_date_sk) FROM date_dim WHERE d_year = 2000) - 30 AND (SELECT MAX(d_date_sk) FROM date_dim WHERE d_year = 2000)
    GROUP BY ws_bill_customer_sk
)
SELECT 
    c.first_name,
    c.last_name,
    ca.ca_city,
    ca.ca_state,
    age.age,
    d.cd_gender,
    d.cd_marital_status,
    d.cd_education_status,
    COALESCE(s.total_spent, 0) AS total_spent,
    ti.total_quantity
FROM customer c
JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
JOIN customer_age age ON c.c_customer_sk = age.c_customer_sk
JOIN demographics d ON c.c_current_cdemo_sk = d.cd_demo_sk
LEFT JOIN sales s ON c.c_customer_sk = s.ws_bill_customer_sk
JOIN top_items ti ON ti.ws_item_sk = c.c_current_cdemo_sk
ORDER BY total_spent DESC, age.age ASC
LIMIT 100;