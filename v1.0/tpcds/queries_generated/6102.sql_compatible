
WITH SalesData AS (
    SELECT 
        cs_item_sk,
        SUM(cs_quantity) AS total_quantity,
        SUM(cs_ext_sales_price) AS total_sales,
        SUM(cs_ext_discount_amt) AS total_discount,
        SUM(cs_ext_tax) AS total_tax,
        cs_sold_date_sk
    FROM 
        catalog_sales
    WHERE 
        cs_sold_date_sk BETWEEN DATE '2022-01-01' AND DATE '2023-01-01'
    GROUP BY 
        cs_item_sk, cs_sold_date_sk
),
CustomerStats AS (
    SELECT 
        cd_demo_sk,
        COUNT(DISTINCT c_customer_sk) AS customer_count,
        AVG(cd_purchase_estimate) AS avg_purchase_estimate,
        SUM(cd_dep_count) AS total_dependents
    FROM 
        customer_demographics AS cd
    JOIN 
        customer AS c ON cd_demo_sk = c.c_current_cdemo_sk
    GROUP BY 
        cd_demo_sk
),
DateInfo AS (
    SELECT 
        d_date_sk,
        d_year,
        d_month_seq,
        d_week_seq
    FROM 
        date_dim
)
SELECT 
    di.d_year, 
    di.d_month_seq, 
    si.total_sales, 
    cs.customer_count, 
    cs.avg_purchase_estimate, 
    cs.total_dependents
FROM 
    SalesData AS si
JOIN 
    DateInfo AS di ON si.cs_sold_date_sk = di.d_date_sk
JOIN 
    CustomerStats AS cs ON si.cs_item_sk = cs.cd_demo_sk 
ORDER BY 
    di.d_year, 
    di.d_month_seq, 
    si.total_sales DESC 
LIMIT 100;
