
WITH RankedSales AS (
    SELECT 
        ws.web_site_sk,
        ws.z_quantity,
        RANK() OVER (PARTITION BY ws.web_site_sk ORDER BY ws.sold_date_sk DESC) AS sale_rank
    FROM web_sales ws
    WHERE ws.ws_sold_date_sk BETWEEN 20210101 AND 20211231
), 
CustomerReturns AS (
    SELECT 
        wr.returning_customer_sk,
        SUM(wr.return_quantity) AS total_returns,
        COUNT(DISTINCT wr.order_number) AS return_orders
    FROM web_returns wr
    WHERE wr.returned_date_sk BETWEEN 20220101 AND 20221231
    GROUP BY wr.returning_customer_sk
) 
SELECT 
    ca.ca_city,
    COUNT(DISTINCT c.c_customer_sk) AS total_customers,
    COUNT(DISTINCT CASE WHEN dem.cd_gender = 'F' THEN c.c_customer_sk END) AS female_customers,
    SUM(ws.ws_net_profit) AS total_net_profit,
    AVG(COALESCE(ct.total_returns, 0)) AS avg_returns_per_customer
FROM customer c
JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
LEFT JOIN customer_demographics dem ON c.c_current_cdemo_sk = dem.cd_demo_sk
LEFT JOIN RankedSales rs ON c.c_customer_sk = rs.ws_bill_customer_sk
LEFT JOIN CustomerReturns ct ON ct.returning_customer_sk = c.c_customer_sk
LEFT JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
WHERE ca.ca_state = 'CA'
  AND (c.c_birth_year IS NULL OR c.c_birth_year > 1980)
GROUP BY ca.ca_city, c.c_customer_sk, dem.cd_gender
ORDER BY total_net_profit DESC
LIMIT 10;
