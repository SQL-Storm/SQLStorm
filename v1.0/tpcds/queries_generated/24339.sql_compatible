
WITH RankedSales AS (
    SELECT 
        ws.ws_item_sk,
        SUM(ws.ws_quantity) AS total_quantity,
        SUM(ws.ws_net_profit) AS total_profit,
        ROW_NUMBER() OVER (PARTITION BY ws.ws_item_sk ORDER BY SUM(ws.ws_net_profit) DESC) AS rank_within_item
    FROM web_sales ws
    JOIN customer c ON ws.ws_bill_customer_sk = c.c_customer_sk
    WHERE c.c_birth_year >= 1970 AND (c.c_preferred_cust_flag = 'Y' OR c.c_email_address IS NOT NULL)
    GROUP BY ws.ws_item_sk
), 
HighProfitItems AS (
    SELECT 
        i.i_item_id,
        rs.total_quantity,
        rs.total_profit,
        d.d_year
    FROM RankedSales rs
    JOIN item i ON rs.ws_item_sk = i.i_item_sk
    JOIN date_dim d ON d.d_date_sk = (
        SELECT MAX(d_date_sk) 
        FROM date_dim 
        WHERE d_year = (SELECT MAX(d_year) FROM date_dim)
    )
    WHERE rs.rank_within_item = 1 AND rs.total_profit > (SELECT AVG(total_profit) FROM RankedSales)
), 
DetailedReport AS (
    SELECT 
        hip.i_item_id,
        hip.total_quantity,
        hip.total_profit,
        COALESCE(ca.ca_city, 'Unknown') AS city,
        COALESCE(sm.sm_type, 'Unspecified') AS ship_type
    FROM HighProfitItems hip
    LEFT JOIN inventory inv ON inv.inv_item_sk = hip.i_item_id
    LEFT JOIN warehouse w ON w.w_warehouse_sk = inv.inv_warehouse_sk
    LEFT JOIN customer_address ca ON ca.ca_address_sk = (
        SELECT c.c_current_addr_sk 
        FROM customer c 
        WHERE c.c_customer_sk = hip.i_item_id 
        LIMIT 1
    )
    LEFT JOIN ship_mode sm ON sm.sm_ship_mode_sk = (
        SELECT ws.ws_ship_mode_sk 
        FROM web_sales ws 
        WHERE ws.ws_item_sk = hip.i_item_id 
        LIMIT 1
    )
)
SELECT 
    d.i_item_id,
    d.total_quantity,
    d.total_profit,
    d.city,
    d.ship_type,
    CONCAT('Total Profit: $', ROUND(d.total_profit, 2)) AS profit_statement,
    CASE 
        WHEN d.total_profit IS NULL THEN 'No Profit'
        WHEN d.total_profit > 10000 THEN 'High Profit'
        ELSE 'Low Profit'
    END AS profit_category
FROM DetailedReport d
ORDER BY d.total_profit DESC 
LIMIT 10;
