WITH SalesData AS (
    SELECT
        ws.web_site_sk,
        SUM(ws.ws_ext_sales_price) AS total_sales,
        COUNT(DISTINCT ws.ws_order_number) AS total_orders,
        ROW_NUMBER() OVER (PARTITION BY ws.web_site_sk ORDER BY SUM(ws.ws_ext_sales_price) DESC) AS sales_rank
    FROM web_sales ws
    WHERE ws.ws_sold_date_sk BETWEEN 2450000 AND 2450671 
    GROUP BY ws.web_site_sk
),
CustomerStats AS (
    SELECT
        c.c_customer_sk,
        cd.cd_gender,
        COALESCE(SUM(ss.ss_ext_sales_price), 0) AS total_store_sales,
        COALESCE(SUM(ws.ws_ext_sales_price), 0) AS total_web_sales
    FROM customer c
    LEFT JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    LEFT JOIN store_sales ss ON c.c_customer_sk = ss.ss_customer_sk
    LEFT JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
    GROUP BY c.c_customer_sk, cd.cd_gender
),
TopCustomers AS (
    SELECT
        cs.c_customer_sk,
        SUM(cs.total_store_sales + cs.total_web_sales) AS grand_total,
        cd.cd_gender
    FROM CustomerStats cs
    JOIN customer_demographics cd ON cs.c_customer_sk = cd.cd_demo_sk_sk
    WHERE grand_total > 1000 
    GROUP BY cs.c_customer_sk, cd.cd_gender
    ORDER BY grand_total DESC
    LIMIT 10
)
SELECT 
    t.web_site_sk,
    t.total_sales,
    t.total_orders,
    COALESCE(tc.grand_total, 0) AS top_customer_sales,
    tc.cd_gender
FROM SalesData t
FULL OUTER JOIN TopCustomers tc ON t.web_site_sk = tc.c_customer_sk
WHERE (t.total_sales IS NOT NULL OR tc.grand_total > 500) 
ORDER BY t.total_sales DESC NULLS LAST, tc.top_customer_sales DESC;