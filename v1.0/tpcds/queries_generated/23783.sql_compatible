
WITH RankedSales AS (
    SELECT 
        ws_item_sk,
        ws_order_number,
        ws_sales_price,
        ROW_NUMBER() OVER(PARTITION BY ws_item_sk ORDER BY ws_sales_price DESC) AS rnk
    FROM 
        web_sales
    WHERE 
        ws_sales_price IS NOT NULL
),
HighValueItems AS (
    SELECT 
        ws_item_sk,
        AVG(ws_sales_price) AS avg_sales_price
    FROM 
        RankedSales
    WHERE 
        rnk <= 5
    GROUP BY 
        ws_item_sk
),
ItemReturns AS (
    SELECT 
        rcr_item_sk,
        SUM(cr_return_quantity) AS total_returned
    FROM 
        catalog_returns
    GROUP BY 
        rcr_item_sk
),
RecentReturns AS (
    SELECT 
        wr_item_sk,
        COUNT(*) AS return_count
    FROM 
        web_returns
    WHERE 
        wr_returned_date_sk >= (SELECT MAX(d_date_sk) FROM date_dim WHERE d_year = 2001)
    GROUP BY 
        wr_item_sk
),
SalesSummary AS (
    SELECT 
        ws_item_sk,
        SUM(ws_quantity) AS total_sales,
        SUM(ws_ext_sales_price) AS total_revenue
    FROM 
        web_sales
    WHERE 
        ws_ship_date_sk >= (SELECT MAX(d_date_sk) FROM date_dim WHERE d_year = 2001)
    GROUP BY 
        ws_item_sk
)
SELECT 
    i.i_item_id,
    COALESCE(hvi.avg_sales_price, 0) AS average_high_value_sales_price,
    COALESCE(ss.total_sales, 0) AS total_sales,
    COALESCE(ss.total_revenue, 0) AS total_revenue,
    COALESCE(ir.total_returned, 0) AS total_catalog_returned,
    COALESCE(rr.return_count, 0) AS total_web_returns
FROM 
    item i
LEFT JOIN 
    HighValueItems hvi ON i.i_item_sk = hvi.ws_item_sk
LEFT JOIN 
    SalesSummary ss ON i.i_item_sk = ss.ws_item_sk
LEFT JOIN 
    ItemReturns ir ON i.i_item_sk = ir.rcr_item_sk
LEFT JOIN 
    RecentReturns rr ON i.i_item_sk = rr.wr_item_sk
WHERE 
    (COALESCE(hvi.avg_sales_price, 0) > 100 OR COALESCE(ss.total_revenue, 0) > 1000 OR COALESCE(rr.return_count, 0) > 0)
    AND (i.i_current_price IS NOT NULL)
    AND (i.i_rec_start_date <= DATE '2002-10-01' OR i.i_rec_start_date IS NULL)
ORDER BY 
    total_revenue DESC
LIMIT 100;
