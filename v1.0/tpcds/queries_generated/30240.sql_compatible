
WITH RECURSIVE sales_data AS (
    SELECT 
        ws_sold_date_sk, 
        ws_item_sk, 
        SUM(ws_net_profit) AS total_profit,
        COUNT(ws_order_number) AS order_count
    FROM 
        web_sales 
    WHERE 
        ws_sold_date_sk >= 2450000 
    GROUP BY 
        ws_sold_date_sk, ws_item_sk

    UNION ALL

    SELECT 
        sd.ws_sold_date_sk, 
        sd.ws_item_sk, 
        SUM(sd.ws_net_profit) + p.total_profit,
        COUNT(sd.ws_order_number) + p.order_count
    FROM 
        web_sales sd
    JOIN 
        sales_data p ON sd.ws_item_sk = p.ws_item_sk AND sd.ws_sold_date_sk = p.ws_sold_date_sk + 1 
    WHERE 
        sd.ws_sold_date_sk < 2450100 
    GROUP BY 
        sd.ws_sold_date_sk, sd.ws_item_sk, p.total_profit, p.order_count
),

customer_profit AS (
    SELECT 
        c.c_customer_sk,
        SUM(ws.net_profit) AS total_net_profit,
        COUNT(ws.ws_order_number) AS total_orders,
        cd.cd_gender,
        cd.cd_marital_status
    FROM 
        customer c
    LEFT JOIN 
        web_sales ws ON ws.ws_bill_customer_sk = c.c_customer_sk
    JOIN 
        customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk
    GROUP BY 
        c.c_customer_sk, cd.cd_gender, cd.cd_marital_status
),

warehouse_sales AS (
    SELECT 
        w.w_warehouse_sk,
        w.w_warehouse_name,
        SUM(ss.ss_net_profit) AS total_warehouse_profit
    FROM 
        warehouse w
    LEFT JOIN 
        store_sales ss ON ss.ss_store_sk = w.w_warehouse_sk
    GROUP BY 
        w.w_warehouse_sk, w.w_warehouse_name
)

SELECT 
    c.c_customer_sk,
    COUNT(DISTINCT ws.ws_order_number) AS distinct_orders,
    AVG(ws.ws_net_profit) AS average_profit,
    w.w_warehouse_name,
    wp.wp_url,
    cd.cd_gender,
    CASE 
        WHEN cd.cd_marital_status = 'M' THEN 'Married'
        ELSE 'Single/Other'
    END AS marital_category
FROM 
    customer c
JOIN 
    web_sales ws ON ws.ws_bill_customer_sk = c.c_customer_sk
JOIN 
    customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk
LEFT JOIN 
    warehouse_sales w ON w.w_warehouse_sk = (SELECT MIN(w_warehouse_sk) FROM warehouse)
LEFT JOIN 
    web_page wp ON wp.wp_web_page_sk = (SELECT MAX(wp_web_page_sk) FROM web_page)
WHERE 
    c.c_birth_year BETWEEN 1970 AND 2000 
    AND (cd.cd_purchase_estimate IS NULL OR cd.cd_purchase_estimate > 1000)
GROUP BY 
    c.c_customer_sk, w.w_warehouse_name, wp.wp_url, cd.cd_gender, cd.cd_marital_status
ORDER BY 
    average_profit DESC
LIMIT 100;
