
WITH CustomerReturns AS (
    SELECT 
        cr_returning_customer_sk,
        SUM(cr_return_amount) AS total_returned_amount,
        COUNT(DISTINCT cr_order_number) AS return_count,
        MAX(cr_returned_date_sk) AS last_return_date
    FROM catalog_returns
    GROUP BY cr_returning_customer_sk
),
CustomerSales AS (
    SELECT 
        ws_ship_customer_sk,
        SUM(ws_net_paid) AS total_sales,
        COUNT(DISTINCT ws_order_number) AS sales_count,
        AVG(ws_net_paid) AS avg_order_amount,
        PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY ws_net_paid) OVER (PARTITION BY ws_ship_customer_sk) AS median_order_amount
    FROM web_sales
    GROUP BY ws_ship_customer_sk
),
CombinedData AS (
    SELECT 
        cs.ws_ship_customer_sk AS customer_sk,
        COALESCE(s.total_sales, 0) AS total_sales,
        COALESCE(r.total_returned_amount, 0) AS total_returned_amount,
        COALESCE(s.sales_count, 0) AS sales_count,
        COALESCE(r.return_count, 0) AS return_count,
        s.avg_order_amount,
        s.median_order_amount,
        CASE 
            WHEN COALESCE(s.total_sales, 0) > 0 THEN (COALESCE(r.total_returned_amount, 0) / COALESCE(s.total_sales, 0)) * 100
            ELSE NULL
        END AS return_percentage
    FROM CustomerSales s
    FULL OUTER JOIN CustomerReturns r ON s.ws_ship_customer_sk = r.cr_returning_customer_sk
)
SELECT 
    c.c_customer_id,
    COALESCE(cd.cd_gender, 'U') AS gender,
    COALESCE(d.total_sales, 0) AS total_sales,
    COALESCE(d.return_count, 0) AS return_count,
    CASE 
        WHEN d.return_count > 0 THEN 'Frequent Returner' 
        WHEN d.total_sales < 100 THEN 'Low Spender' 
        ELSE 'Regular Customer'
    END AS customer_type,
    CONCAT(c.c_first_name, ' ', c.c_last_name) AS full_name,
    RANK() OVER (ORDER BY d.return_percentage DESC NULLS LAST) AS return_rank
FROM CombinedData d
JOIN customer c ON d.customer_sk = c.c_customer_sk
LEFT JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
WHERE d.return_percentage IS NOT NULL
ORDER BY d.return_percentage DESC;
