
WITH StringProcessing AS (
    SELECT 
        c.c_first_name,
        c.c_last_name,
        CONCAT(c.c_first_name, ' ', c.c_last_name) AS full_name,
        LENGTH(c.c_first_name) AS first_name_length,
        LENGTH(c.c_last_name) AS last_name_length,
        REGEXP_REPLACE(c.c_email_address, '@.*$', '') AS email_local_part,
        SUBSTRING_INDEX(c.c_email_address, '@', -1) AS email_domain,
        UPPER(c.c_last_name) AS upper_last_name,
        LOWER(c.c_first_name) AS lower_first_name
    FROM customer c
    WHERE LPAD(c.c_customer_id, 16, '0') LIKE '0000%'
),
AggregateData AS (
    SELECT 
        AVG(first_name_length) AS avg_first_name_length,
        AVG(last_name_length) AS avg_last_name_length,
        COUNT(DISTINCT full_name) AS unique_full_names,
        COUNT(DISTINCT email_local_part) AS unique_email_local_parts,
        COUNT(DISTINCT email_domain) AS unique_email_domains
    FROM StringProcessing
)
SELECT 
    ad.avg_first_name_length,
    ad.avg_last_name_length,
    ad.unique_full_names,
    ad.unique_email_local_parts,
    ad.unique_email_domains,
    (SELECT COUNT(*) FROM customer_address ca WHERE ca.ca_city LIKE '%ville%') AS cities_containing_ville,
    (SELECT COUNT(*) FROM web_page wp WHERE wp.wp_url LIKE '%.com') AS web_pages_with_com_domain,
    (SELECT COUNT(*) FROM item i WHERE i.i_item_desc LIKE '%organic%') AS organic_items_count
FROM AggregateData ad;
