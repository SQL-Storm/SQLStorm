
WITH CustomerReturns AS (
    SELECT
        cr_returning_customer_sk,
        SUM(cr_return_amount) AS total_return_amount,
        COUNT(cr_order_number) AS total_returns
    FROM
        catalog_returns
    GROUP BY
        cr_returning_customer_sk
),
TopReturningCustomers AS (
    SELECT
        cr_returning_customer_sk,
        RANK() OVER (ORDER BY total_return_amount DESC) AS rank
    FROM
        CustomerReturns
    WHERE
        total_return_amount > (SELECT AVG(total_return_amount) FROM CustomerReturns)
),
SalesData AS (
    SELECT
        ws_shipping_date_sk,
        ws_item_sk,
        SUM(ws_net_paid_inc_tax) AS total_sales,
        SUM(ws_quantity) AS total_units_sold
    FROM
        web_sales
    GROUP BY
        ws_shipping_date_sk, ws_item_sk
),
ReturnSalesAnalysis AS (
    SELECT
        t.rank,
        s.ws_item_sk,
        COALESCE(r.total_return_amount, 0) AS total_return_amount,
        s.total_sales,
        s.total_units_sold,
        (s.total_sales - COALESCE(r.total_return_amount, 0)) AS net_sales
    FROM
        SalesData s
    JOIN
        TopReturningCustomers t ON s.ws_item_sk IN (SELECT cr_item_sk FROM catalog_returns WHERE cr_returning_customer_sk = t.cr_returning_customer_sk)
    LEFT JOIN
        CustomerReturns r ON r.cr_returning_customer_sk = t.cr_returning_customer_sk
)
SELECT
    r.rank,
    r.ws_item_sk,
    r.total_return_amount,
    r.total_sales,
    r.total_units_sold,
    r.net_sales
FROM
    ReturnSalesAnalysis r
JOIN
    customer c ON c.c_customer_sk = r.rank
WHERE
    c.c_birth_country IS NOT NULL
ORDER BY
    r.rank, r.net_sales DESC
FETCH FIRST 100 ROWS ONLY;
