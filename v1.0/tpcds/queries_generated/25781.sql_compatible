
WITH CustomerAddresses AS (
    SELECT 
        ca_address_sk,
        TRIM(UPPER(ca_street_name)) AS normalized_street_name,
        CONCAT(TRIM(ca_street_number), ' ', TRIM(ca_street_name), ' ', TRIM(ca_street_type)) AS full_address
    FROM 
        customer_address
    WHERE 
        ca_city LIKE '%New%' OR ca_city LIKE '%Los%' 
),
CustomerDemographics AS (
    SELECT 
        cd_demo_sk,
        CASE 
            WHEN cd_gender = 'M' THEN 'Male'
            WHEN cd_gender = 'F' THEN 'Female'
            ELSE 'Other'
        END AS gender,
        CONCAT(cd_marital_status, ' ', TRIM(cd_education_status)) AS marital_and_education
    FROM 
        customer_demographics
),
DateInformation AS (
    SELECT 
        d_date_sk,
        d_year,
        d_month_seq,
        d_week_seq,
        d_day_name
    FROM 
        date_dim
    WHERE 
        d_year >= 2020 AND d_year <= 2023
),
MergedData AS (
    SELECT 
        c.c_customer_sk,
        c.c_first_name,
        c.c_last_name,
        c.c_email_address,
        a.normalized_street_name,
        a.full_address,
        d.d_year,
        d.d_month_seq
    FROM 
        customer c
    JOIN 
        CustomerAddresses a ON c.c_current_addr_sk = a.ca_address_sk
    JOIN 
        CustomerDemographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    JOIN 
        DateInformation d ON c.c_first_shipto_date_sk = d.d_date_sk
)
SELECT 
    gender,
    COUNT(*) AS customer_count,
    AVG(CAST(SUBSTRING(full_address, LOCATE(' ', full_address, LOCATE(' ', full_address) + 1) + 1) AS UNSIGNED)) AS avg_address_parts,
    d_year,
    d_month_seq
FROM 
    MergedData
GROUP BY 
    gender, d_year, d_month_seq
ORDER BY 
    d_year, d_month_seq, customer_count DESC;
