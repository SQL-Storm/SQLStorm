
SELECT
    c.c_customer_id,
    c.c_first_name,
    c.c_last_name,
    SUM(ss.ss_ext_sales_price) AS total_store_sales,
    SUM(ws.ws_ext_sales_price) AS total_web_sales,
    COALESCE(SUM(sr.sr_return_amt), 0) AS total_store_returns,
    COALESCE(SUM(wr.wr_return_amt), 0) AS total_web_returns,
    cd.cd_gender,
    cd.cd_marital_status,
    hd.hd_income_band_sk
FROM
    customer AS c
JOIN
    store_sales AS ss ON c.c_customer_sk = ss.ss_customer_sk
JOIN
    web_sales AS ws ON c.c_customer_sk = ws.ws_bill_customer_sk
LEFT JOIN
    store_returns AS sr ON ss.ss_order_number = sr.sr_ticket_number AND c.c_customer_sk = sr.sr_customer_sk
LEFT JOIN
    web_returns AS wr ON ws.ws_order_number = wr.wr_order_number AND c.c_customer_sk = wr.wr_returning_customer_sk
JOIN
    customer_demographics AS cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
JOIN
    household_demographics AS hd ON cd.cd_demo_sk = hd.hd_demo_sk
WHERE
    ss.ss_sold_date_sk BETWEEN 20220101 AND 20221231
    OR ws.ws_sold_date_sk BETWEEN 20220101 AND 20221231
GROUP BY
    c.c_customer_id,
    c.c_first_name,
    c.c_last_name,
    cd.cd_gender,
    cd.cd_marital_status,
    hd.hd_income_band_sk
HAVING
    SUM(ss.ss_ext_sales_price) > 5000
    OR SUM(ws.ws_ext_sales_price) > 5000
ORDER BY
    total_store_sales DESC,
    total_web_sales DESC;
