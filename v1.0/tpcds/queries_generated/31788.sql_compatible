
WITH RECURSIVE SalesCTE AS (
    SELECT 
        ss_sold_date_sk,
        SUM(ss_net_profit) AS total_profit,
        s_store_id
    FROM 
        store_sales
    JOIN 
        store ON store.s_store_sk = store_sales.ss_store_sk
    WHERE 
        ss_sold_date_sk >= (SELECT MAX(d_date_sk) FROM date_dim WHERE d_year = 2022)
    GROUP BY 
        ss_sold_date_sk, s_store_id
    UNION ALL
    SELECT
        ss_sold_date_sk,
        SUM(ss_net_profit) + total_profit AS total_profit,
        s_store_id
    FROM 
        store_sales
    JOIN 
        store ON store.s_store_sk = store_sales.ss_store_sk
    JOIN 
        SalesCTE ON SalesCTE.ss_sold_date_sk = store_sales.ss_sold_date_sk - INTERVAL '1 day'
    GROUP BY 
        ss_sold_date_sk, s_store_id, total_profit
),

CustomerReturns AS (
    SELECT 
        sr_item_sk,
        COUNT(DISTINCT sr_ticket_number) AS total_returns
    FROM 
        store_returns
    GROUP BY 
        sr_item_sk
),

WebReturns AS (
    SELECT 
        wr_item_sk,
        COUNT(DISTINCT wr_order_number) AS total_web_returns
    FROM 
        web_returns
    GROUP BY 
        wr_item_sk
),

ProfitAnalysis AS (
    SELECT 
        i_item_sk,
        i_item_id,
        i_product_name,
        COALESCE(total_profit, 0) AS total_profit,
        COALESCE(total_returns, 0) AS total_returns,
        COALESCE(total_web_returns, 0) AS total_web_returns,
        (COALESCE(total_profit, 0) - (COALESCE(total_returns, 0) * 5) - (COALESCE(total_web_returns, 0) * 5)) AS net_profit
    FROM 
        item
    LEFT JOIN 
        (SELECT 
            ss_item_sk, SUM(total_profit) AS total_profit 
         FROM 
            SalesCTE 
         GROUP BY 
            ss_item_sk) AS sales_profit ON item.i_item_sk = sales_profit.ss_item_sk
    LEFT JOIN 
        CustomerReturns ON item.i_item_sk = CustomerReturns.sr_item_sk
    LEFT JOIN 
        WebReturns ON item.i_item_sk = WebReturns.wr_item_sk
)

SELECT 
    i_item_id,
    i_product_name,
    total_profit,
    total_returns,
    total_web_returns,
    net_profit
FROM 
    ProfitAnalysis
WHERE 
    net_profit > 100
ORDER BY 
    net_profit DESC
LIMIT 10;
