
WITH sales_data AS (
    SELECT 
        ws.ws_order_number,
        ws.ws_sold_date_sk,
        ws.ws_item_sk,
        ws.ws_quantity,
        ws.ws_sales_price,
        ws.ws_ext_sales_price,
        ws.ws_net_profit,
        ROW_NUMBER() OVER (PARTITION BY ws.ws_order_number ORDER BY ws.ws_net_profit DESC) AS rn
    FROM web_sales ws
    WHERE ws.ws_sold_date_sk IN (
        SELECT d.d_date_sk 
        FROM date_dim d 
        WHERE d.d_year = 2023 AND d.d_month_seq <= 12
    )
),
total_sales AS (
    SELECT 
        sd.ws_order_number,
        SUM(sd.ws_ext_sales_price) AS total_sales,
        SUM(sd.ws_net_profit) AS total_net_profit
    FROM sales_data sd
    GROUP BY sd.ws_order_number
),
customer_sales_totals AS (
    SELECT 
        c.c_customer_sk,
        SUM(ts.total_sales) AS customer_sales,
        COUNT(DISTINCT ts.ws_order_number) AS orders_count
    FROM total_sales ts
    JOIN web_sales ws ON ts.ws_order_number = ws.ws_order_number
    JOIN customer c ON ws.ws_bill_customer_sk = c.c_customer_sk
    GROUP BY c.c_customer_sk
),
high_value_customers AS (
    SELECT 
        c.c_customer_sk,
        cd.cd_gender,
        cd.cd_marital_status,
        c.c_first_name,
        c.c_last_name,
        c.c_email_address,
        c.c_birth_year,
        cs.customer_sales
    FROM customer_sales_totals cs
    JOIN customer c ON cs.c_customer_sk = c.c_customer_sk
    JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    WHERE cs.customer_sales > (
        SELECT AVG(customer_sales) 
        FROM customer_sales_totals
    )
)
SELECT 
    hvc.c_first_name,
    hvc.c_last_name,
    hvc.c_email_address,
    hvc.cd_gender,
    hvc.cd_marital_status,
    hvc.c_birth_year,
    COALESCE(SUBSTRING(hvc.c_email_address, POSITION('@' IN hvc.c_email_address) + 1), 'No Domain') AS email_domain,
    hvc.customer_sales
FROM high_value_customers hvc
LEFT JOIN customer_address ca ON hvc.c_customer_sk = ca.ca_customer_sk
WHERE ca.ca_state = 'CA'
ORDER BY hvc.customer_sales DESC
FETCH FIRST 10 ROWS ONLY;
