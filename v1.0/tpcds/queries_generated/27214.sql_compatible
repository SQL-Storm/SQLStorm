
WITH AddressData AS (
    SELECT ca_address_sk, 
           CONCAT(ca_street_number, ' ', ca_street_name, ' ', ca_street_type) AS full_address,
           UPPER(ca_city) AS city_upper,
           LOWER(ca_state) AS state_lower,
           CONCAT(ca_zip, '-', ca_country) AS zip_country,
           LENGTH(ca_street_name) AS street_name_length
    FROM customer_address
),
DemographicsData AS (
    SELECT cd_demo_sk,
           COUNT(c.c_customer_sk) AS customer_count,
           SUM(CASE WHEN cd_gender = 'M' THEN 1 ELSE 0 END) AS male_count,
           SUM(CASE WHEN cd_gender = 'F' THEN 1 ELSE 0 END) AS female_count,
           AVG(cd_purchase_estimate) AS avg_purchase_estimate,
           MAX(cd_dep_count) AS max_dependents
    FROM customer_demographics cd
    JOIN customer c ON c.c_current_cdemo_sk = cd.cd_demo_sk
    GROUP BY cd_demo_sk
),
SalesData AS (
    SELECT ws_item_sk,
           SUM(ws_quantity) AS total_quantity,
           SUM(ws_net_profit) AS total_profit,
           COUNT(DISTINCT ws_order_number) AS distinct_orders
    FROM web_sales
    GROUP BY ws_item_sk
),
FinalAggregation AS (
    SELECT ad.full_address,
           ad.city_upper,
           ad.state_lower,
           ad.zip_country,
           d.customer_count,
           d.male_count,
           d.female_count,
           d.avg_purchase_estimate,
           d.max_dependents,
           s.total_quantity,
           s.total_profit,
           s.distinct_orders
    FROM AddressData ad
    JOIN DemographicsData d ON d.cd_demo_sk = (SELECT MIN(cd_demo_sk) FROM DemographicsData)
    JOIN SalesData s ON s.ws_item_sk = (SELECT MIN(ws_item_sk) FROM SalesData)
)
SELECT *
FROM FinalAggregation
WHERE street_name_length > 10
ORDER BY total_profit DESC, customer_count DESC
FETCH FIRST 50 ROWS ONLY;
