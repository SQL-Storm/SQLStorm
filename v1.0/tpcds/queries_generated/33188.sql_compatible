
WITH RECURSIVE address_hierarchy AS (
    SELECT 
        ca_address_sk, 
        ca_street_name, 
        ca_city, 
        ca_state, 
        ca_country, 
        1 AS level
    FROM 
        customer_address
    WHERE 
        ca_state = 'CA'
    
    UNION ALL
    
    SELECT 
        ca.ca_address_sk,
        CONCAT(ca.ca_street_name, ' - Level ', ah.level + 1),
        ca.ca_city,
        ca.ca_state,
        ca.ca_country,
        ah.level + 1
    FROM 
        customer_address ca
        JOIN address_hierarchy ah ON ca.ca_address_sk = ah.ca_address_sk
    WHERE 
        ah.level < 3
),
sales_summary AS (
    SELECT 
        c.c_customer_sk,
        SUM(ws.ws_sales_price) AS total_sales,
        COUNT(DISTINCT ws.ws_order_number) AS total_orders
    FROM 
        customer c
        JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
    GROUP BY 
        c.c_customer_sk
),
demographic_info AS (
    SELECT 
        cd.cd_demo_sk,
        cd.cd_gender,
        cd.cd_marital_status,
        cd.cd_purchase_estimate,
        hb.ib_income_band_sk
    FROM 
        customer_demographics cd
        LEFT JOIN household_demographics hb ON cd.cd_demo_sk = hb.hd_demo_sk
)
SELECT 
    a.ca_street_name,
    a.ca_city,
    a.ca_state,
    a.ca_country,
    d.cd_gender,
    d.cd_marital_status,
    d.cd_purchase_estimate,
    COALESCE(s.total_sales, 0) AS total_sales,
    COALESCE(s.total_orders, 0) AS total_orders
FROM 
    address_hierarchy a
    LEFT JOIN demographic_info d ON a.ca_address_sk = d.cd_demo_sk
    LEFT JOIN sales_summary s ON d.cd_demo_sk = s.c_customer_sk
WHERE 
    (a.ca_city IS NOT NULL AND a.ca_city <> '')
    AND (d.cd_purchase_estimate > 1000 OR d.cd_gender = 'F')
GROUP BY 
    a.ca_street_name, 
    a.ca_city, 
    a.ca_state, 
    a.ca_country, 
    d.cd_gender, 
    d.cd_marital_status, 
    d.cd_purchase_estimate, 
    s.total_sales, 
    s.total_orders
ORDER BY 
    total_sales DESC, 
    a.ca_city ASC
LIMIT 100;
