
WITH RECURSIVE SalesHierarchy AS (
    SELECT 
        cs_bill_customer_sk AS CustomerID,
        SUM(cs_ext_sales_price) AS TotalSales,
        1 AS Level
    FROM 
        catalog_sales
    GROUP BY 
        cs_bill_customer_sk
    UNION ALL
    SELECT 
        sr_customer_sk AS CustomerID,
        SUM(sr_return_amt_inc_tax) * -1 AS TotalSales,
        Level + 1
    FROM 
        store_returns
    JOIN SalesHierarchy sh ON Level < 5
    GROUP BY 
        sr_customer_sk, Level
),
CustomerStats AS (
    SELECT 
        c.c_customer_sk,
        c.c_first_name,
        c.c_last_name,
        cd.cd_gender,
        MAX(sh.TotalSales) AS MaxSales,
        COUNT(sh.CustomerID) AS SalesCount
    FROM 
        customer c
    JOIN 
        customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    LEFT JOIN 
        SalesHierarchy sh ON c.c_customer_sk = sh.CustomerID
    GROUP BY 
        c.c_customer_sk, c.c_first_name, c.c_last_name, cd.cd_gender
),
TopCustomers AS (
    SELECT 
        c.*, 
        DENSE_RANK() OVER (PARTITION BY c.cd_gender ORDER BY c.MaxSales DESC) AS Rank
    FROM 
        CustomerStats c
)
SELECT 
    CONCAT(c.c_first_name, ' ', c.c_last_name) AS FullName,
    c.MaxSales,
    c.Rank
FROM 
    TopCustomers c
WHERE 
    c.Rank <= 5
ORDER BY 
    c.cd_gender, c.MaxSales DESC;
