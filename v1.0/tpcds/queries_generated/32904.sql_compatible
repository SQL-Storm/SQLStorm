
WITH RECURSIVE sales_hierarchy AS (
    SELECT
        s_store_sk,
        s_store_name,
        CAST(s_store_name AS VARCHAR(100)) AS hierarchy_path,
        s_manager,
        1 AS level
    FROM
        store
    WHERE
        s_store_name IS NOT NULL

    UNION ALL

    SELECT
        s.s_store_sk,
        s.s_store_name,
        CONCAT(h.hierarchy_path, ' > ', s.s_store_name) AS hierarchy_path,
        s.s_manager,
        h.level + 1 AS level
    FROM
        sales_hierarchy h
    JOIN store s ON h.s_manager = s.s_store_name
)

SELECT
    c.c_customer_id,
    c.c_first_name,
    c.c_last_name,
    da.ca_city,
    da.ca_state,
    SUM(ws.ws_net_profit) AS total_profit,
    PERCENTILE_CONT(0.5) WITHIN GROUP (ORDER BY ws.ws_net_profit) OVER (PARTITION BY da.ca_state) AS median_profit,
    COUNT(CASE WHEN ws.ws_quantity > 10 THEN 1 END) AS high_quantity_sales,
    STRING_AGG(DISTINCT CASE WHEN ws.ws_net_profit > 100 THEN i.i_product_name END, ', ') AS profitable_products
FROM
    web_sales ws
JOIN
    customer c ON ws.ws_bill_customer_sk = c.c_customer_sk
JOIN
    customer_address da ON c.c_current_addr_sk = da.ca_address_sk
JOIN
    item i ON ws.ws_item_sk = i.i_item_sk
LEFT JOIN
    store s ON ws.ws_warehouse_sk = s.s_store_sk
LEFT JOIN 
    sales_hierarchy sh ON sh.s_store_sk = s.s_store_sk
WHERE
    da.ca_state IN ('NY', 'CA')
    AND ws.ws_sold_date_sk BETWEEN 2458297 AND 2458901
    AND i.i_current_price IS NOT NULL
GROUP BY
    c.c_customer_id, c.c_first_name, c.c_last_name, da.ca_city, da.ca_state
ORDER BY
    total_profit DESC
LIMIT 10;
