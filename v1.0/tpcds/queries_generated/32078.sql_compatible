
WITH RECURSIVE SalesData AS (
    SELECT
        ws_sold_date_sk,
        ws_item_sk,
        ws_order_number,
        ws_quantity,
        ws_net_profit,
        1 AS level
    FROM
        web_sales
    WHERE
        ws_quantity > 0

    UNION ALL

    SELECT
        sd.ws_sold_date_sk,
        sd.ws_item_sk,
        sd.ws_order_number,
        sd.ws_quantity,
        sd.ws_net_profit * 1.1 AS ws_net_profit,  
        sd.level + 1
    FROM
        SalesData sd
    JOIN 
        web_sales ws ON sd.ws_item_sk = ws.ws_item_sk
    WHERE
        sd.level < 5
)

SELECT
    c.c_customer_id,
    c.c_first_name,
    c.c_last_name,
    SUM(sd.ws_net_profit) AS total_profit,
    MAX(sd.ws_quantity) AS max_sold_quantity,
    AVG(sd.ws_net_profit) AS avg_net_profit,
    COUNT(sd.ws_order_number) AS total_orders
FROM
    SalesData sd
JOIN
    customer c ON c.c_customer_sk = sd.ws_item_sk
LEFT JOIN
    customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
LEFT JOIN 
    date_dim d ON sd.ws_sold_date_sk = d.d_date_sk
WHERE
    cd.cd_gender = 'F'
    AND d.d_year > 1998
    AND d.d_current_year = 'Y'
GROUP BY
    c.c_customer_id, 
    c.c_first_name, 
    c.c_last_name
HAVING 
    SUM(sd.ws_net_profit) > 10000
ORDER BY 
    total_profit DESC
FETCH FIRST 10 ROWS ONLY;
