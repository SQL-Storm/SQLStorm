WITH RECURSIVE SalesHierarchy AS (
    SELECT c.c_customer_sk, c.c_last_name, c.c_first_name, 
           SUM(ws.ws_ext_sales_price) AS total_sales
    FROM customer c
    JOIN web_sales ws ON c.c_customer_sk = ws.ws_ship_customer_sk
    WHERE ws.ws_sold_date_sk >= (SELECT d.d_date_sk 
                                  FROM date_dim d 
                                  WHERE d.d_year = 2001 AND d.d_moy = 1 LIMIT 1)
    GROUP BY c.c_customer_sk, c.c_last_name, c.c_first_name
    
    UNION ALL

    SELECT sh.c_customer_sk, sh.c_last_name, sh.c_first_name, 
           (sh.total_sales * 1.1) AS total_sales
    FROM SalesHierarchy sh
    JOIN customer c ON sh.c_customer_sk = c.c_current_cdemo_sk
)

SELECT DISTINCT c.c_first_name, c.c_last_name, sh.total_sales,
       CASE WHEN sh.total_sales IS NULL THEN 'No Sales' ELSE 'Sales Present' END AS sale_status
FROM customer c
LEFT JOIN SalesHierarchy sh ON c.c_customer_sk = sh.c_customer_sk
WHERE sh.total_sales >= COALESCE((SELECT AVG(total_sales) FROM SalesHierarchy), 0)
AND c.c_birth_year BETWEEN 1970 AND 2000
AND (c.c_preferred_cust_flag = 'Y' OR c.c_birth_country IS NULL)
ORDER BY sh.total_sales DESC
LIMIT 100;