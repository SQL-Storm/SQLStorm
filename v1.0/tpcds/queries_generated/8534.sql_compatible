
WITH CustomerStats AS (
    SELECT
        c.c_customer_sk,
        c.c_first_name,
        c.c_last_name,
        cd.cd_gender,
        cd.cd_marital_status,
        cd.cd_education_status,
        COUNT(DISTINCT ws.ws_order_number) AS Total_Orders,
        SUM(ws.ws_net_profit) AS Total_Profit,
        AVG(CASE WHEN r.r_reason_sk IS NOT NULL THEN 1 ELSE 0 END) * 100 AS Return_Rate,
        SUM(CASE WHEN ws.ws_sales_price > 100 THEN 1 ELSE 0 END) AS High_Value_Orders
    FROM
        customer c
    JOIN
        customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    LEFT JOIN
        web_sales ws ON c.c_customer_sk = ws.ws_ship_customer_sk
    LEFT JOIN
        web_returns wr ON ws.ws_order_number = wr.wr_order_number
    LEFT JOIN
        catalog_returns cr ON ws.ws_order_number = cr.cr_order_number
    LEFT JOIN
        store_sales ss ON c.c_customer_sk = ss.ss_customer_sk
    LEFT JOIN
        store_returns sr ON ss.ss_ticket_number = sr.sr_ticket_number
    LEFT JOIN
        reason r ON wr.wr_reason_sk = r.r_reason_sk OR sr.sr_reason_sk = r.r_reason_sk
    GROUP BY
        c.c_customer_sk, c.c_first_name, c.c_last_name, cd.cd_gender, cd.cd_marital_status, cd.cd_education_status
    HAVING
        COUNT(DISTINCT ws.ws_order_number) > 10 AND SUM(ws.ws_net_profit) > 5000
),
DateStats AS (
    SELECT
        d.d_year,
        COUNT(DISTINCT c.c_customer_sk) AS Active_Customers,
        SUM(ws.ws_net_profit) AS Yearly_Profit
    FROM
        date_dim d
    JOIN
        web_sales ws ON d.d_date_sk = ws.ws_sold_date_sk
    JOIN
        customer c ON ws.ws_ship_customer_sk = c.c_customer_sk
    GROUP BY
        d.d_year
)
SELECT
    cs.c_customer_sk,
    cs.c_first_name,
    cs.c_last_name,
    cs.cd_gender,
    cs.cd_marital_status,
    cs.cd_education_status,
    ds.Active_Customers,
    ds.Yearly_Profit,
    cs.Total_Orders,
    cs.Total_Profit,
    cs.Return_Rate,
    cs.High_Value_Orders
FROM
    CustomerStats cs
JOIN
    DateStats ds ON cs.c_customer_sk IN (SELECT c.c_customer_sk FROM customer c WHERE c.c_sales_date_sk = ds.d_year)
ORDER BY
    cs.Total_Profit DESC, cs.Return_Rate ASC
FETCH FIRST 100 ROWS ONLY;
