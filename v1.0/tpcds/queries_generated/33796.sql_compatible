
WITH RECURSIVE item_hierarchy AS (
    SELECT i_item_sk, i_item_id, i_product_name, i_current_price, i_brand, 
           0 AS level
    FROM item
    WHERE i_current_price IS NOT NULL
    UNION ALL
    SELECT i.i_item_sk, i.i_item_id, i.i_product_name, i.i_current_price, 
           i.i_brand, ih.level + 1
    FROM item i
    JOIN item_hierarchy ih ON i.i_item_sk = ih.i_item_sk
    WHERE i.i_current_price IS NOT NULL
),
customer_info AS (
    SELECT c.c_customer_sk, 
           CONCAT(c.c_first_name, ' ', c.c_last_name) AS full_name,
           d.d_date AS first_purchase_date,
           cd.cd_marital_status,
           hd.hd_buy_potential
    FROM customer c
    JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    LEFT JOIN date_dim d ON c.c_first_sales_date_sk = d.d_date_sk
    LEFT JOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk
),
sales_summary AS (
    SELECT ws_bill_customer_sk, SUM(ws_net_paid) AS total_sales, 
           COUNT(DISTINCT ws_order_number) AS order_count
    FROM web_sales
    WHERE ws_sold_date_sk BETWEEN 2450000 AND 2451000
    GROUP BY ws_bill_customer_sk
),
high_value_customers AS (
    SELECT ci.full_name, ss.total_sales, ss.order_count
    FROM customer_info ci
    JOIN sales_summary ss ON ci.c_customer_sk = ss.ws_bill_customer_sk
    WHERE ss.total_sales > (SELECT AVG(total_sales) FROM sales_summary) 
    AND ci.cd_marital_status = 'M'
)
SELECT ih.i_item_id, ih.i_product_name, ih.i_current_price, 
       ih.level, hvc.full_name, hvc.total_sales
FROM item_hierarchy ih
JOIN high_value_customers hvc ON ih.i_brand = 'BrandX'
ORDER BY ih.level DESC, hvc.total_sales DESC;
