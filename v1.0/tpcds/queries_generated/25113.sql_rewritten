WITH address_cte AS (
    SELECT 
        ca.city AS city,
        COUNT(ca.ca_address_sk) AS address_count,
        SUM(LENGTH(ca.ca_street_name) - LENGTH(REPLACE(ca.ca_street_name, ' ', '')) + 1) AS word_count_street_name,
        AVG(LENGTH(ca.ca_street_name)) AS avg_length_street_name
    FROM 
        customer_address ca
    GROUP BY 
        ca.city
),
demographics_cte AS (
    SELECT 
        cd.cd_gender AS gender,
        COUNT(cd.cd_demo_sk) AS demographic_count,
        AVG(cd.cd_purchase_estimate) AS avg_purchase_estimate,
        MAX(cd.cd_dep_count) AS max_dependents
    FROM 
        customer_demographics cd
    GROUP BY 
        cd.cd_gender
),
sales_cte AS (
    SELECT 
        ws_bill_customer_sk,
        SUM(ws_ext_sales_price) AS total_sales,
        COUNT(ws_order_number) AS order_count
    FROM 
        web_sales
    GROUP BY 
        ws_bill_customer_sk
),
final_cte AS (
    SELECT 
        a.city,
        a.address_count,
        a.word_count_street_name,
        a.avg_length_street_name,
        d.gender,
        d.demographic_count,
        d.avg_purchase_estimate,
        d.max_dependents,
        s.total_sales,
        s.order_count
    FROM 
        address_cte a
    JOIN 
        demographics_cte d ON a.city = d.gender 
    JOIN 
        sales_cte s ON d.demographic_count = s.ws_bill_customer_sk 
)
SELECT 
    city,
    address_count,
    word_count_street_name,
    avg_length_street_name,
    gender,
    demographic_count,
    avg_purchase_estimate,
    max_dependents,
    total_sales,
    order_count
FROM 
    final_cte
WHERE 
    total_sales > 10000
ORDER BY 
    address_count DESC, total_sales DESC;