
WITH RankedSales AS (
    SELECT 
        c.c_customer_id,
        SUM(ws.ws_net_paid) AS total_sales,
        COUNT(DISTINCT ws.ws_order_number) AS order_count,
        ROW_NUMBER() OVER (PARTITION BY c.c_customer_id ORDER BY SUM(ws.ws_net_paid) DESC) AS rank_sales
    FROM 
        customer c
    JOIN 
        web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
    WHERE 
        ws.ws_ship_date_sk IS NOT NULL
    GROUP BY 
        c.c_customer_id
),
HighSpenders AS (
    SELECT 
        c.c_customer_id AS customer_id, 
        rs.total_sales,
        rs.order_count 
    FROM 
        RankedSales rs
    JOIN 
        customer c ON c.c_customer_id = rs.c_customer_id
    WHERE 
        rs.rank_sales = 1 AND
        rs.total_sales > (SELECT AVG(total_sales) FROM RankedSales)
),
FrequentReturners AS (
    SELECT 
        wr.wr_returning_customer_sk,
        COUNT(wr.wr_order_number) AS return_count
    FROM 
        web_returns wr
    WHERE 
        wr.wr_return_quantity > 0
    GROUP BY 
        wr.wr_returning_customer_sk
    HAVING 
        return_count > (SELECT AVG(return_count) FROM (
            SELECT COUNT(wr_order_number) AS return_count 
            FROM web_returns 
            GROUP BY wr_returning_customer_sk
        ) AS averages)
)
SELECT 
    hs.customer_id,
    hs.total_sales,
    hs.order_count,
    COALESCE(fr.return_count, 0) AS return_count,
    hs.total_sales - COALESCE(fr.return_count * 10.0, 0) AS effective_sales
FROM 
    HighSpenders hs
LEFT JOIN 
    FrequentReturners fr ON hs.customer_id = fr.wr_returning_customer_sk
WHERE 
    hs.total_sales - COALESCE(fr.return_count * 10.0, 0) > 0
ORDER BY 
    effective_sales DESC
LIMIT 100
UNION ALL
SELECT 
    'TOTALS' AS customer_id,
    SUM(hs.total_sales) AS total_sales,
    SUM(hs.order_count) AS total_orders,
    SUM(COALESCE(fr.return_count, 0)) AS total_return_count,
    SUM(hs.total_sales) - SUM(COALESCE(fr.return_count * 10.0, 0)) AS total_effective_sales
FROM 
    HighSpenders hs
LEFT JOIN 
    FrequentReturners fr ON hs.customer_id = fr.wr_returning_customer_sk
HAVING 
    SUM(hs.total_sales) - SUM(COALESCE(fr.return_count * 10.0, 0)) > 0
ORDER BY 
    total_effective_sales DESC;
