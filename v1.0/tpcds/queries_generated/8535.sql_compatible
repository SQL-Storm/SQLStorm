
WITH RankedSales AS (
    SELECT 
        ws_bill_customer_sk, 
        ws_sold_date_sk, 
        SUM(ws_sales_price) AS total_sales,
        RANK() OVER (PARTITION BY ws_bill_customer_sk ORDER BY SUM(ws_sales_price) DESC) AS sales_rank
    FROM 
        web_sales
    GROUP BY 
        ws_bill_customer_sk, ws_sold_date_sk
),
CustomerDemographics AS (
    SELECT 
        c.c_customer_sk,
        cd.cd_gender, 
        cd.cd_marital_status, 
        cd.cd_education_status, 
        cd.cd_buy_potential
    FROM 
        customer AS c
    JOIN 
        customer_demographics AS cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
),
HighValueCustomers AS (
    SELECT 
        r.ws_bill_customer_sk,
        SUM(r.total_sales) AS total_spent
    FROM 
        RankedSales AS r
    WHERE 
        r.sales_rank = 1
    GROUP BY 
        r.ws_bill_customer_sk
    HAVING 
        SUM(r.total_sales) > 1000
),
SalesWithDemographics AS (
    SELECT 
        hvc.ws_bill_customer_sk,
        cd.cd_gender,
        cd.cd_marital_status,
        cd.cd_education_status,
        hvc.total_spent
    FROM 
        HighValueCustomers AS hvc
    JOIN 
        CustomerDemographics AS cd ON hvc.ws_bill_customer_sk = cd.c_customer_sk
)
SELECT 
    cd.cd_gender AS gender, 
    cd.cd_marital_status AS marital_status, 
    cd.cd_education_status AS education_status, 
    COUNT(*) AS num_customers, 
    AVG(hvc.total_spent) AS avg_spent
FROM 
    SalesWithDemographics AS hvc
JOIN 
    CustomerDemographics AS cd ON hvc.ws_bill_customer_sk = cd.c_customer_sk
GROUP BY 
    cd.cd_gender, cd.cd_marital_status, cd.cd_education_status
ORDER BY 
    num_customers DESC;
