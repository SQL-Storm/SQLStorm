WITH RECURSIVE SalesCTE AS (
    SELECT ws.bill_customer_sk,
           SUM(ws.ws_ext_sales_price) AS total_sales,
           ROW_NUMBER() OVER (PARTITION BY ws.bill_customer_sk ORDER BY SUM(ws.ws_ext_sales_price) DESC) AS sales_rank
    FROM web_sales ws
    WHERE ws.ws_sold_date_sk >= (
        SELECT MIN(d_date_sk)
        FROM date_dim
        WHERE d_year = 2001
    )
    GROUP BY ws.bill_customer_sk
),
TopCustomerSales AS (
    SELECT c.c_customer_id,
           c.c_first_name,
           c.c_last_name,
           s.total_sales
    FROM customer c
    JOIN SalesCTE s ON c.c_customer_sk = s.bill_customer_sk
    WHERE s.sales_rank <= 10
)
SELECT DISTINCT 
       c.c_customer_id,
       c.c_first_name,
       c.c_last_name,
       COALESCE(s.total_sales, 0) AS total_sales,
       CASE 
           WHEN s.total_sales IS NOT NULL THEN 'Top Customer'
           ELSE 'Regular Customer'
       END AS customer_type,
       c.c_email_address,
       CASE 
           WHEN c.c_birth_month = 12 THEN 'Holiday Season'
           ELSE 'Regular Month'
       END AS special_month
FROM customer c
LEFT JOIN TopCustomerSales s ON c.c_customer_id = s.c_customer_id
WHERE c.c_preferred_cust_flag = 'Y'
  AND (c.c_birth_year % 2 = 0 OR c.c_birth_day IS NULL)
ORDER BY total_sales DESC, c.c_last_name ASC;