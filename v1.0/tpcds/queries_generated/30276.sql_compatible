
WITH RECURSIVE SalesHierarchy AS (
    SELECT cc.cc_call_center_id, cc.cc_name, cc.cc_manager, 0 AS level
    FROM call_center cc
    WHERE cc.cc_call_center_sk IS NOT NULL

    UNION ALL

    SELECT cc.cc_call_center_id, cc.cc_name, cc.cc_manager, sh.level + 1
    FROM call_center cc
    JOIN SalesHierarchy sh ON cc.cc_manager = sh.cc_name
),
DateRange AS (
    SELECT d.d_date, d.d_year, d.d_month_seq
    FROM date_dim d
    WHERE d.d_date BETWEEN '2022-01-01' AND '2022-12-31'
),
SalesData AS (
    SELECT 
        ws.ws_order_number,
        SUM(ws.ws_ext_sales_price) AS total_sales,
        SUM(ws.ws_ext_tax) AS total_tax,
        COUNT(DISTINCT ws.ws_item_sk) AS total_items,
        d.d_year
    FROM web_sales ws
    JOIN DateRange d ON ws.ws_sold_date_sk = d.d_date_sk
    GROUP BY ws.ws_order_number, d.d_year
),
AggregatedSales AS (
    SELECT 
        d.d_year,
        COUNT(DISTINCT sa.ws_order_number) AS total_orders,
        SUM(sa.total_sales) AS overall_sales,
        SUM(sa.total_tax) AS overall_tax
    FROM SalesData sa
    JOIN DateRange d ON sa.d_year = d.d_year
    GROUP BY d.d_year
    HAVING SUM(sa.total_sales) > 10000
)
SELECT 
    sah.cc_call_center_id,
    sah.cc_name,
    sah.cc_manager,
    ags.total_orders,
    ags.overall_sales,
    ags.overall_tax,
    ROW_NUMBER() OVER (PARTITION BY sah.cc_call_center_id ORDER BY ags.overall_sales DESC) AS sales_rank
FROM SalesHierarchy sah
LEFT JOIN AggregatedSales ags ON ags.d_year BETWEEN 2020 AND 2022
WHERE sah.level < 3
ORDER BY sah.cc_call_center_id, sales_rank;
