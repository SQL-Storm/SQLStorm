WITH RankedSales AS (
    SELECT 
        ws_item_sk, 
        ws_order_number, 
        ws_sales_price,
        ROW_NUMBER() OVER (PARTITION BY ws_item_sk ORDER BY ws_sales_price DESC) AS sales_rank
    FROM 
        web_sales 
    WHERE 
        ws_sold_date_sk >= (SELECT MAX(d_date_sk) FROM date_dim WHERE d_year = 2001) - 365
),
CustomerReturnSummary AS (
    SELECT 
        wr.returning_customer_sk,
        SUM(wr_return_quantity) AS total_returned_quantity,
        SUM(wr_return_amt) AS total_returned_amt,
        COUNT(DISTINCT wr_order_number) AS total_returned_orders,
        COUNT(*) FILTER (WHERE wr_return_quantity IS NULL) AS null_returns 
    FROM 
        web_returns wr 
    JOIN 
        customer c ON wr_returning_customer_sk = c.c_customer_sk
    GROUP BY 
        wr.returning_customer_sk
),
ItemReturnRates AS (
    SELECT 
        sr_item_sk, 
        AVG(sr_return_quantity::decimal) / NULLIF(SUM(ss_quantity), 0) AS return_rate
    FROM 
        store_returns sr 
    LEFT JOIN 
        store_sales ss ON sr_item_sk = ss.ss_item_sk 
    GROUP BY 
        sr_item_sk
)
SELECT 
    c.c_first_name,
    c.c_last_name,
    ca.ca_city,
    COALESCE(crs.total_returned_quantity, 0) AS total_returned_quantity,
    COALESCE(crs.total_returned_amt, 0) AS total_returned_amt,
    ir.return_rate,
    COUNT(DISTINCT s.ss_ticket_number) AS total_sales_tickets,
    COUNT(DISTINCT ws.ws_order_number) FILTER (WHERE ws_ship_date_sk IS NOT NULL) AS completed_shipments,
    CASE 
        WHEN ir.return_rate IS NOT NULL AND ir.return_rate > 0.1 THEN 'High Return Rate'
        ELSE 'Normal Return Rate'
    END AS return_rate_category
FROM 
    customer c 
LEFT JOIN 
    customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk 
LEFT JOIN 
    CustomerReturnSummary crs ON crs.returning_customer_sk = c.c_customer_sk
LEFT JOIN 
    store_sales s ON c.c_customer_sk = s.ss_customer_sk 
LEFT JOIN 
    ItemReturnRates ir ON s.ss_item_sk = ir.sr_item_sk 
JOIN 
    RankedSales rs ON rs.ws_item_sk = ir.sr_item_sk
WHERE 
    c.c_birth_year IS NOT NULL 
    AND ((cast('2002-10-01' as date) - DATE(c.c_birth_month || '/' || c.c_birth_day || '/' || c.c_birth_year))::integer < 10 * 365 
    OR c.c_last_name LIKE '%son')
GROUP BY 
    c.c_first_name, c.c_last_name, ca.ca_city, crs.total_returned_quantity, crs.total_returned_amt, ir.return_rate 
ORDER BY 
    COALESCE(crs.total_returned_amt, 0) DESC 
LIMIT 100;