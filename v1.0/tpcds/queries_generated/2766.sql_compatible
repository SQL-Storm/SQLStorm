
WITH RankedSales AS (
    SELECT 
        ws.web_site_sk,
        ws.web_name,
        SUM(ws.ws_sales_price) AS total_sales,
        ROW_NUMBER() OVER (PARTITION BY ws.web_site_sk ORDER BY SUM(ws.ws_sales_price) DESC) AS rank
    FROM 
        web_sales ws
    JOIN 
        date_dim dd ON ws.ws_sold_date_sk = dd.d_date_sk
    WHERE 
        dd.d_year = 2023 
        AND (ws.ws_net_profit > 1000 OR ws.ws_net_paid_inc_tax > 5000)
    GROUP BY 
        ws.web_site_sk, ws.web_name
),
TopStores AS (
    SELECT 
        s.s_store_sk,
        s.s_store_name,
        COUNT(ss.ss_ticket_number) AS total_transactions,
        AVG(ss.ss_net_paid) AS avg_transaction_value
    FROM 
        store s
    LEFT JOIN 
        store_sales ss ON s.s_store_sk = ss.ss_store_sk
    GROUP BY 
        s.s_store_sk, s.s_store_name
),
CustomerReturns AS (
    SELECT 
        cr.returning_customer_sk,
        COUNT(DISTINCT cr.cr_order_number) AS return_orders,
        SUM(cr.cr_return_amt) AS total_return_amount
    FROM 
        catalog_returns cr
    WHERE 
        cr.cr_returned_date_sk >= (
            SELECT 
                MIN(ss.ss_sold_date_sk)
            FROM 
                store_sales ss
            WHERE 
                ss.ss_item_sk IN (
                    SELECT 
                        ws.ws_item_sk
                    FROM 
                        web_sales ws
                    JOIN 
                        RankedSales rs ON ws.ws_web_site_sk = rs.web_site_sk
                    WHERE 
                        rs.rank <= 5
                )
        )
    GROUP BY 
        cr.returning_customer_sk
)
SELECT 
    ts.s_store_name,
    ts.total_transactions,
    ts.avg_transaction_value,
    COALESCE(cr.return_orders, 0) AS return_orders,
    COALESCE(cr.total_return_amount, 0) AS total_return_amount,
    RANK() OVER (ORDER BY ts.avg_transaction_value DESC) AS store_rank
FROM 
    TopStores ts
LEFT JOIN 
    CustomerReturns cr ON ts.s_store_sk = cr.returning_customer_sk
WHERE 
    ts.total_transactions > 0
ORDER BY 
    store_rank, ts.s_store_name;
