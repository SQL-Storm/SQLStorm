WITH RECURSIVE ItemHierarchy AS (
    SELECT 
        i.i_item_sk,
        i.i_item_id,
        COALESCE(i.i_item_desc, 'No description') AS item_description,
        COALESCE(b.ib_lower_bound, 0) AS lower_bound,
        COALESCE(b.ib_upper_bound, 999999) AS upper_bound,
        CAST(NULL AS DECIMAL(7,2)) AS total_sales_price,
        1 AS depth
    FROM item i
    LEFT JOIN household_demographics h ON i.i_item_sk = h.hd_demo_sk
    LEFT JOIN income_band b ON h.hd_income_band_sk = b.ib_income_band_sk
    WHERE i.i_current_price IS NOT NULL

    UNION ALL

    SELECT 
        ih.i_item_sk,
        ih.i_item_id,
        ih.item_description,
        ih.lower_bound,
        ih.upper_bound,
        SUM(COALESCE(s.ws_sales_price, 0)) AS total_sales_price,
        ih.depth + 1
    FROM ItemHierarchy ih
    LEFT JOIN web_sales s ON ih.i_item_sk = s.ws_item_sk AND s.ws_bill_customer_sk IS NOT NULL
    GROUP BY ih.i_item_sk, ih.i_item_id, ih.item_description, ih.lower_bound, ih.upper_bound, ih.depth
)

SELECT 
    Manufacturer.i_manufact AS manufacturer,
    SUM(IH.total_sales_price) AS total_sales,
    COUNT(DISTINCT c.c_customer_id) AS unique_customers,
    MAX(IH.depth) AS hierarchy_depth,
    (SELECT COUNT(DISTINCT ws_order_number) 
     FROM web_sales 
     WHERE ws_ship_date_sk > (SELECT MAX(d.d_date_sk) 
                               FROM date_dim d 
                               WHERE d.d_date = cast('2002-10-01' as date) - INTERVAL '30 DAY')) AS recent_orders
FROM ItemHierarchy IH
JOIN item I ON IH.i_item_sk = I.i_item_sk
JOIN warehouse W ON I.i_item_sk <=> W.w_warehouse_sk
JOIN call_center C ON W.w_warehouse_sk = C.cc_call_center_sk
JOIN customer c ON c.c_current_cdemo_sk = I.i_item_sk
LEFT JOIN household_demographics HD ON c.c_customer_sk = HD.hd_demo_sk
LEFT JOIN (SELECT i.i_manufact, SUM(s.ws_sales_price) AS sales_price
            FROM web_sales s
            JOIN item i ON s.ws_item_sk = i.i_item_sk
            GROUP BY i.i_manufact
            HAVING SUM(s.ws_sales_price) > 1000) AS Manufacturer ON I.i_manufact = Manufacturer.i_manufact
GROUP BY Manufacturer.i_manufact
ORDER BY total_sales DESC
LIMIT 10
OFFSET (SELECT COUNT(DISTINCT ws_order_number) / 2);