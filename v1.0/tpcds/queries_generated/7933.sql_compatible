
WITH sales_summary AS (
    SELECT 
        ws_item_sk,
        SUM(ws_quantity) AS total_quantity_sold,
        SUM(ws_sales_price) AS total_sales_value,
        SUM(ws_net_profit) AS total_net_profit
    FROM web_sales
    WHERE ws_sold_date_sk BETWEEN 2450103 AND 2450788
    GROUP BY ws_item_sk
),
item_details AS (
    SELECT 
        i.i_item_sk,
        i.i_item_id,
        i.i_item_desc,
        i.i_brand,
        i.i_category_id,
        ce.tra_sales_category_description AS sales_category
    FROM item i
    LEFT JOIN (
        SELECT 
            wc.wc_category_sk,
            cat.ca_description AS tra_sales_category_description
        FROM category cat
        JOIN web_sales_category wc ON cat.ca_sk = wc.wc_category_sk
    ) ce ON i.i_category_id = ce.wc_category_sk
),
customer_summary AS (
    SELECT 
        c.c_customer_sk,
        COUNT(DISTINCT cs.cs_order_number) AS total_orders,
        AVG(ws.net_profit) AS average_profit
    FROM customer c
    JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
    JOIN catalog_sales cs ON ws.ws_item_sk = cs.cs_item_sk
    GROUP BY c.c_customer_sk
)
SELECT 
    id.i_item_id,
    id.i_item_desc,
    id.i_brand,
    s.total_quantity_sold,
    s.total_sales_value,
    s.total_net_profit,
    cs.total_orders,
    cs.average_profit
FROM sales_summary s
JOIN item_details id ON s.ws_item_sk = id.i_item_sk
LEFT JOIN customer_summary cs ON cs.total_orders > 5
WHERE s.total_net_profit > 1000
ORDER BY s.total_quantity_sold DESC
FETCH FIRST 10 ROWS ONLY;
