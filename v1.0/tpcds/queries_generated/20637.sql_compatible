
WITH RankedReturns AS (
    SELECT 
        sr_item_sk,
        sr_return_qty,
        sr_return_amt,
        ROW_NUMBER() OVER (PARTITION BY sr_item_sk ORDER BY sr_return_time_sk DESC) AS rn
    FROM 
        store_returns
), 
CustomerStats AS (
    SELECT 
        c.c_customer_sk,
        c.c_preferred_cust_flag,
        cd.cd_gender,
        COUNT(DISTINCT sr.sr_ticket_number) AS total_returns
    FROM 
        customer c
    LEFT JOIN 
        customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    LEFT JOIN 
        store_returns sr ON c.c_customer_sk = sr.sr_customer_sk
    GROUP BY 
        c.c_customer_sk, c.c_preferred_cust_flag, cd.cd_gender
), 
ReturnValue AS (
    SELECT 
        cr.refunded_customer_sk,
        SUM(cr.cr_return_amt) AS total_refunded,
        MAX(cr.cr_return_quantity) AS max_returned_qty
    FROM 
        catalog_returns cr
    GROUP BY 
        cr.refunded_customer_sk
)
SELECT 
    cs.c_customer_sk,
    cs.c_preferred_cust_flag,
    cs.cd_gender,
    COALESCE(rv.total_refunded, 0) AS total_refunded,
    COALESCE(rv.max_returned_qty, 0) AS max_returned_qty,
    RANK() OVER (ORDER BY COALESCE(rv.total_refunded, 0) DESC) AS refund_rank
FROM 
    CustomerStats cs
LEFT JOIN 
    ReturnValue rv ON cs.c_customer_sk = rv.refunded_customer_sk
WHERE 
    (cs.total_returns IS NULL OR cs.total_returns > 5) 
    AND (cs.cd_gender = 'F' OR cs.cd_gender IS NULL)
ORDER BY 
    refund_rank
LIMIT 50;
