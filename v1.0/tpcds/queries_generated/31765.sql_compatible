
WITH RECURSIVE AddressHierarchy AS (
    SELECT ca_address_sk, ca_street_name, ca_city, ca_state, 1 AS level
    FROM customer_address
    WHERE ca_state IS NOT NULL
    UNION ALL
    SELECT ca_address_sk, CONCAT(ca_street_name, ' (Level ', level + 1, ')') AS ca_street_name, ca_city, ca_state, level + 1
    FROM customer_address
    JOIN AddressHierarchy ON customer_address.ca_address_sk = AddressHierarchy.ca_address_sk
    WHERE level < 3
),
SalesData AS (
    SELECT 
        ws.web_site_id, 
        SUM(ws.ws_sales_price) AS total_sales,
        COUNT(DISTINCT ws.ws_order_number) AS order_count
    FROM web_sales ws
    GROUP BY ws.web_site_id
),
ReturnData AS (
    SELECT 
        wr.wr_web_page_sk, 
        SUM(wr.wr_return_amt) AS total_return_amt,
        COUNT(wr.wr_return_quantity) AS return_count
    FROM web_returns wr
    GROUP BY wr.wr_web_page_sk
)
SELECT 
    a.ca_street_name,
    a.ca_city,
    a.ca_state,
    s.web_site_id,
    COALESCE(sd.total_sales, 0) AS total_sales,
    COALESCE(rd.total_return_amt, 0) AS total_return_amt,
    (COALESCE(sd.total_sales, 0) - COALESCE(rd.total_return_amt, 0)) AS net_sales,
    RANK() OVER (PARTITION BY a.ca_state ORDER BY (COALESCE(sd.total_sales, 0) - COALESCE(rd.total_return_amt, 0)) DESC) AS sales_rank
FROM AddressHierarchy a
LEFT JOIN SalesData sd ON a.ca_street_name LIKE CONCAT('%', sd.web_site_id, '%')
LEFT JOIN ReturnData rd ON a.ca_street_name = CONCAT('Return_', rd.wr_web_page_sk)
JOIN warehouse w ON w.w_warehouse_sk = 1
WHERE a.level = 1
AND (a.ca_state IS NOT NULL OR a.ca_city IS NULL)
GROUP BY 
    a.ca_street_name, 
    a.ca_city, 
    a.ca_state, 
    s.web_site_id
ORDER BY sales_rank, a.ca_city;
