
WITH RECURSIVE customer_hierarchy AS (
    SELECT c_customer_sk, c_first_name, c_last_name, c_current_addr_sk
    FROM customer
    WHERE c_current_addr_sk IS NOT NULL
    UNION ALL
    SELECT c.c_customer_sk, c.c_first_name, c.c_last_name, c.c_current_addr_sk
    FROM customer c
    JOIN customer_hierarchy ch ON c.c_current_addr_sk = ch.c_current_addr_sk
),
item_sales AS (
    SELECT
        ws_item_sk,
        SUM(ws_sales_price) AS total_sales,
        COUNT(ws_order_number) AS order_count
    FROM web_sales
    GROUP BY ws_item_sk
),
high_value_items AS (
    SELECT i.i_item_sk, 
           i.i_product_name, 
           i.i_current_price, 
           is.total_sales, 
           is.order_count
    FROM item i
    JOIN item_sales is ON i.i_item_sk = is.ws_item_sk
    WHERE is.total_sales > (
        SELECT AVG(total_sales) 
        FROM item_sales
    )
),
ranked_sales AS (
    SELECT 
        hvi.i_item_sk,
        hvi.i_product_name,
        hvi.i_current_price,
        hvi.total_sales,
        RANK() OVER (ORDER BY hvi.total_sales DESC) AS sales_rank
    FROM high_value_items hvi
)
SELECT 
    ch.c_first_name,
    ch.c_last_name,
    r.i_product_name,
    r.total_sales,
    r.sales_rank,
    CASE 
        WHEN r.sales_rank <= 10 THEN 'Top Seller'
        ELSE 'Other'
    END AS sales_category,
    d.d_date,
    w.w_warehouse_name
FROM customer_hierarchy ch
JOIN ranked_sales r ON ch.c_current_addr_sk IN (
        SELECT ca_address_sk 
        FROM customer_address 
        WHERE ca_address_sk = ch.c_current_addr_sk
    )
JOIN date_dim d ON d.d_date_sk = 
    (SELECT MAX(ws_sold_date_sk) FROM web_sales WHERE ws_item_sk = r.i_item_sk)
LEFT JOIN warehouse w ON w.w_warehouse_sk IN (
       SELECT inv.inv_warehouse_sk
       FROM inventory inv 
       WHERE inv.inv_item_sk = r.i_item_sk
       AND inv.inv_quantity_on_hand > 0
)
WHERE d.d_year = 2023
GROUP BY ch.c_first_name, ch.c_last_name, r.i_product_name, r.total_sales, r.sales_rank, d.d_date, w.w_warehouse_name
ORDER BY r.total_sales DESC, ch.c_last_name, ch.c_first_name;
