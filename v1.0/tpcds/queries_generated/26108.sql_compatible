
WITH processed_customer_names AS (
    SELECT 
        c.c_customer_sk,
        TRIM(c.c_first_name) || ' ' || TRIM(c.c_last_name) AS full_name,
        c.c_birth_day,
        c.c_birth_month,
        c.c_birth_year,
        CASE
            WHEN cd.cd_gender = 'M' THEN 'Male'
            WHEN cd.cd_gender = 'F' THEN 'Female'
            ELSE 'Other'
        END AS gender,
        STRING_AGG(DISTINCT ca.ca_street_number || ' ' || ca.ca_street_name || ' ' || ca.ca_street_type, ', ') AS full_address
    FROM 
        customer c
    JOIN 
        customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    JOIN 
        customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
    GROUP BY 
        c.c_customer_sk, c.c_first_name, c.c_last_name, c.c_birth_day, c.c_birth_month, c.c_birth_year, cd.cd_gender
),
dated_customers AS (
    SELECT 
        pc.c_customer_sk,
        pc.full_name,
        pc.gender,
        DATEADD(YEAR, (YEAR(CAST('2002-10-01' AS DATE)) - pc.c_birth_year), CAST(CONCAT(pc.c_birth_year, '-', LPAD(pc.c_birth_month, 2, '0'), '-', LPAD(pc.c_birth_day, 2, '0')) AS DATE)) AS birth_date,
        CAST('2002-10-01' AS DATE) AS constant_date,
        CASE
            WHEN EXTRACT(YEAR FROM CAST('2002-10-01' AS DATE)) - pc.c_birth_year < 18 THEN 'Minor'
            WHEN EXTRACT(YEAR FROM CAST('2002-10-01' AS DATE)) - pc.c_birth_year >= 18 AND EXTRACT(YEAR FROM CAST('2002-10-01' AS DATE)) - pc.c_birth_year < 60 THEN 'Adult'
            ELSE 'Senior'
        END AS age_group
    FROM 
        processed_customer_names pc
)
SELECT 
    dc.full_name,
    dc.gender,
    dc.birth_date,
    dc.age_group,
    COUNT(DISTINCT w.ws_order_number) AS total_orders,
    AVG(w.ws_sales_price) AS avg_order_value
FROM 
    dated_customers dc
LEFT JOIN 
    web_sales w ON dc.c_customer_sk = w.ws_bill_customer_sk
GROUP BY 
    dc.full_name, dc.gender, dc.birth_date, dc.age_group
ORDER BY 
    total_orders DESC, avg_order_value DESC
LIMIT 100;
