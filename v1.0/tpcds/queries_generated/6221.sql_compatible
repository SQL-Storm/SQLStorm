
WITH sales_data AS (
    SELECT 
        COALESCE(ws.ws_sales_price, cs.cs_sales_price, ss.ss_sales_price) AS sales_price,
        COALESCE(ws.ws_ship_date_sk, cs.cs_ship_date_sk, ss.ss_sold_date_sk) AS sold_date_sk,
        COALESCE(cd.cd_gender, hd.hd_buy_potential) AS customer_segment,
        COUNT(DISTINCT ws.ws_order_number) AS total_orders,
        SUM(COALESCE(ws.ws_quantity, cs.cs_quantity, ss.ss_quantity)) AS total_quantity
    FROM 
        web_sales ws
    FULL OUTER JOIN 
        catalog_sales cs ON ws.ws_order_number = cs.cs_order_number
    FULL OUTER JOIN 
        store_sales ss ON ws.ws_order_number = ss.ss_ticket_number
    LEFT JOIN 
        customer_demographics cd ON ws.ws_bill_cdemo_sk = cd.cd_demo_sk
    LEFT JOIN 
        household_demographics hd ON ws.ws_bill_cdemo_sk = hd.hd_demo_sk
    WHERE 
        (ws.ws_sold_date_sk IS NOT NULL OR cs.cs_sold_date_sk IS NOT NULL OR ss.ss_sold_date_sk IS NOT NULL)
        AND (ws.ws_sales_price > 0 OR cs.cs_sales_price > 0 OR ss.ss_sales_price > 0)
    GROUP BY 
        sold_date_sk, customer_segment
    HAVING 
        COUNT(DISTINCT ws.ws_order_number) > 0
),

total_sales AS (
    SELECT 
        sold_date_sk,
        SUM(total_quantity) AS overall_quantity,
        SUM(total_orders) AS overall_orders
    FROM 
        sales_data
    GROUP BY 
        sold_date_sk
)

SELECT 
    dd.d_date,
    ts.overall_quantity,
    ts.overall_orders,
    AVG(sd.sales_price) AS avg_sales_price
FROM 
    total_sales ts
JOIN 
    date_dim dd ON ts.sold_date_sk = dd.d_date_sk
JOIN 
    sales_data sd ON ts.sold_date_sk = sd.sold_date_sk
WHERE 
    dd.d_year = 2023
GROUP BY 
    dd.d_date, ts.overall_quantity, ts.overall_orders
ORDER BY 
    dd.d_date DESC;
