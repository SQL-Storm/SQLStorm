
WITH RECURSIVE sales_hierarchy AS (
    SELECT 
        s_store_sk,
        s_store_name,
        s_number_employees,
        s_floor_space,
        ROW_NUMBER() OVER (PARTITION BY s_store_sk ORDER BY s_number_employees DESC) AS hierarchy_level
    FROM store
    WHERE s_closed_date_sk IS NULL
),
item_sales AS (
    SELECT 
        ws_item_sk,
        SUM(ws_sales_price) AS total_sales,
        COUNT(DISTINCT ws_order_number) AS order_count
    FROM web_sales
    WHERE ws_sold_date_sk BETWEEN 2001 AND 2091 
    GROUP BY ws_item_sk
),
customer_performance AS (
    SELECT 
        c.c_customer_sk,
        COUNT(DISTINCT ws_order_number) AS total_orders,
        SUM(ws_sales_price) AS total_spent
    FROM customer c
    JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
    GROUP BY c.c_customer_sk
),
high_value_customers AS (
    SELECT 
        cp.c_customer_sk,
        cp.total_orders,
        cp.total_spent,
        RANK() OVER (ORDER BY cp.total_spent DESC) AS rank
    FROM customer_performance cp
    WHERE cp.total_spent > 1000
),
sales_summary AS (
    SELECT 
        it.i_item_id,
        it.i_item_desc,
        is.total_sales,
        hs.s_store_name,
        hs.hierarchy_level
    FROM item_sales is
    JOIN item it ON is.ws_item_sk = it.i_item_sk
    LEFT JOIN sales_hierarchy hs ON hs.s_store_sk = it.i_item_id 
)
SELECT 
    hvc.c_customer_sk,
    hvc.total_orders,
    hvc.total_spent,
    ss.i_item_id,
    ss.i_item_desc,
    ss.total_sales,
    ss.s_store_name,
    ss.hierarchy_level
FROM high_value_customers hvc
JOIN sales_summary ss ON hvc.c_customer_sk = ss.i_item_id 
WHERE hvc.rank <= 100
  AND (ss.total_sales IS NOT NULL OR ss.total_sales > 100)
ORDER BY hvc.total_spent DESC, ss.total_sales DESC
LIMIT 50;
