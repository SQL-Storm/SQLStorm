
WITH AddressDetails AS (
    SELECT 
        ca_city,
        ca_state,
        CONCAT(ca_street_number, ' ', ca_street_name, ' ', ca_street_type) AS full_address,
        LENGTH(CONCAT(ca_street_number, ' ', ca_street_name, ' ', ca_street_type)) AS address_length
    FROM 
        customer_address
),
Demographics AS (
    SELECT 
        cd_gender,
        cd_marital_status,
        cd_education_status,
        CONCAT(cd_gender, '-', cd_marital_status, '-', cd_education_status) AS demographic_profile
    FROM 
        customer_demographics
),
DateDetails AS (
    SELECT 
        d_date,
        d_year,
        d_month_seq,
        CONCAT(d_day_name, ' ', d_month_seq, ' ', d_year) AS formatted_date
    FROM 
        date_dim
),
AddressWithDemo AS (
    SELECT 
        a.ca_city,
        a.ca_state,
        a.full_address,
        a.address_length,
        d.demographic_profile
    FROM 
        AddressDetails a
    JOIN 
        Demographics d ON d.cd_gender = 'F'  
),
SalesData AS (
    SELECT 
        ws.web_site_id,
        ws_order_number,
        SUM(ws_ext_sales_price) AS total_sales,
        COUNT(*) AS total_orders
    FROM 
        web_sales ws
    GROUP BY 
        ws.web_site_id,
        ws_order_number
)
SELECT 
    ad.ca_city,
    ad.ca_state,
    ad.full_address,
    ad.address_length,
    ad.demographic_profile,
    ds.formatted_date,
    sd.total_sales,
    sd.total_orders
FROM 
    AddressWithDemo ad
JOIN 
    DateDetails ds ON ds.d_year = EXTRACT(YEAR FROM CAST('2002-10-01' AS DATE))  
JOIN 
    SalesData sd ON sd.web_site_id IN ('W00001', 'W00002')  
ORDER BY 
    ad.address_length DESC, sd.total_sales DESC
LIMIT 100;
