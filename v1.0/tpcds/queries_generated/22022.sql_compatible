
WITH RECURSIVE customer_rank AS (
    SELECT c.c_customer_sk,
           c.c_first_name,
           c.c_last_name,
           cd.cd_gender,
           cd.cd_marital_status,
           ROW_NUMBER() OVER (PARTITION BY cd.cd_gender ORDER BY c.c_birth_year DESC) AS rank_gender
    FROM customer c
    JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    WHERE cd.cd_marital_status IS NOT NULL
), product_sales AS (
    SELECT ws_item_sk,
           SUM(ws_sales_price * ws_quantity) AS total_sales,
           COUNT(DISTINCT ws_order_number) AS order_count
    FROM web_sales
    GROUP BY ws_item_sk
), high_value_customers AS (
    SELECT c.c_customer_sk,
           SUM(COALESCE(ws.net_profit, 0)) AS total_net_profit
    FROM customer c
    LEFT JOIN web_sales ws ON c.c_customer_sk = ws.ws_ship_customer_sk
    WHERE c.c_birth_month = (SELECT MAX(c2.c_birth_month)
                             FROM customer c2
                             WHERE c2.c_birth_year = c.c_birth_year)
    GROUP BY c.c_customer_sk
    HAVING SUM(COALESCE(ws.net_profit, 0)) > 1000
), qualified_promotions AS (
    SELECT p.p_promo_id,
           COUNT(DISTINCT ws.ws_order_number) AS promotion_order_count
    FROM promotion p
    LEFT JOIN web_sales ws ON p.p_item_sk = ws.ws_item_sk
    WHERE p.p_channel_email = 'Y'
    GROUP BY p.p_promo_id
    HAVING COUNT(DISTINCT ws.ws_order_number) > 5
)
SELECT 
    c_rank.c_first_name,
    c_rank.c_last_name,
    c_rank.rank_gender,
    COALESCE(hvc.total_net_profit, 0) AS total_net_profit,
    COALESCE(ps.total_sales, 0) AS total_sales,
    COALESCE(promo.promotion_order_count, 0) AS promotion_order_count
FROM customer_rank c_rank
LEFT JOIN high_value_customers hvc ON c_rank.c_customer_sk = hvc.c_customer_sk
LEFT JOIN product_sales ps ON ps.ws_item_sk = (SELECT i_item_sk FROM item WHERE i_current_price = (SELECT MAX(i_current_price) FROM item))
LEFT JOIN qualified_promotions promo ON promo.p_promo_id = (SELECT p.p_promo_id FROM promotion p WHERE p.p_start_date_sk = (SELECT MAX(p2.p_start_date_sk) FROM promotion p2))
WHERE c_rank.rank_gender <= 5
ORDER BY total_net_profit DESC, total_sales DESC;
