
WITH RECURSIVE Inventory_CTE AS (
    SELECT
        inv_date_sk,
        inv_item_sk,
        inv_warehouse_sk,
        inv_quantity_on_hand,
        1 AS hierarchy_level
    FROM inventory
    WHERE inv_quantity_on_hand > 0
    UNION ALL
    SELECT
        i.inv_date_sk,
        i.inv_item_sk,
        i.inv_warehouse_sk,
        i.inv_quantity_on_hand - 10 AS inv_quantity_on_hand,
        hierarchy_level + 1
    FROM Inventory_CTE it
    JOIN inventory i ON it.inv_item_sk = i.inv_item_sk AND it.inv_warehouse_sk = i.inv_warehouse_sk
    WHERE it.inv_quantity_on_hand - 10 > 0
),
CustomerStats AS (
    SELECT 
        c.c_customer_sk,
        cd.cd_gender,
        cd.cd_marital_status,
        SUM(COALESCE(ss.ss_net_paid_inc_tax, 0)) AS total_spent,
        COUNT(ss.ss_ticket_number) AS purchase_count,
        MAX(ss.ss_sold_date_sk) AS last_purchase_date,
        MIN(ss.ss_sold_date_sk) AS first_purchase_date,
        DATEDIFF(MAX(ss.ss_sold_date_sk), MIN(ss.ss_sold_date_sk)) AS days_between_purchases
    FROM customer c
    LEFT JOIN store_sales ss ON c.c_customer_sk = ss.ss_customer_sk
    LEFT JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    GROUP BY c.c_customer_sk, cd.cd_gender, cd.cd_marital_status
),
ShipModeStats AS (
    SELECT 
        sm.sm_ship_mode_id,
        COUNT(DISTINCT ws.ws_order_number) AS total_orders,
        SUM(ws.ws_net_profit) AS total_profit
    FROM web_sales ws
    JOIN ship_mode sm ON ws.ws_ship_mode_sk = sm.sm_ship_mode_sk
    GROUP BY sm.sm_ship_mode_id
),
TopCustomers AS (
    SELECT 
        cs.c_customer_sk,
        cs.total_spent,
        ROW_NUMBER() OVER (ORDER BY cs.total_spent DESC) AS customer_rank
    FROM CustomerStats cs
    WHERE cs.total_spent > 1000
)
SELECT 
    c.c_first_name,
    c.c_last_name,
    cs.total_spent,
    cs.purchase_count,
    cs.days_between_purchases,
    sm_stats.total_orders,
    sm_stats.total_profit,
    inv.inv_quantity_on_hand
FROM customer c
JOIN CustomerStats cs ON c.c_customer_sk = cs.c_customer_sk
LEFT JOIN ShipModeStats sm_stats ON cs.purchase_count > 0
LEFT JOIN Inventory_CTE inv ON cs.c_customer_sk = inv.inv_item_sk 
JOIN TopCustomers tc ON cs.c_customer_sk = tc.c_customer_sk
WHERE tc.customer_rank <= 10 
ORDER BY cs.total_spent DESC, c.c_last_name ASC;
