WITH SalesAggregate AS (
    SELECT 
        ws.web_site_sk,
        SUM(ws.ws_quantity) AS total_quantity_sold,
        SUM(ws.ws_net_profit) AS total_net_profit,
        ROW_NUMBER() OVER(PARTITION BY ws.web_site_sk ORDER BY SUM(ws.ws_quantity) DESC) AS site_rank
    FROM web_sales ws
    JOIN customer c ON ws.ws_bill_customer_sk = c.c_customer_sk
    LEFT JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    LEFT JOIN date_dim dd ON ws.ws_sold_date_sk = dd.d_date_sk
    WHERE dd.d_year = 2001 AND cd.cd_gender = 'F'
    GROUP BY ws.web_site_sk
),
TopStores AS (
    SELECT 
        wa.w_warehouse_id,
        wa.w_warehouse_name,
        SUM(sa.total_net_profit) AS total_net_profit_store
    FROM warehouse wa
    JOIN SalesAggregate sa ON wa.w_warehouse_sk = sa.web_site_sk
    GROUP BY wa.w_warehouse_id, wa.w_warehouse_name
    HAVING SUM(sa.total_net_profit) > (
        SELECT AVG(total_net_profit) FROM SalesAggregate
    )
)
SELECT 
    ts.w_warehouse_name,
    ts.total_net_profit_store,
    CASE 
        WHEN ts.total_net_profit_store IS NULL THEN 'No Profit'
        ELSE 'Profit Achieved'
    END AS profit_status,
    (SELECT COUNT(*) FROM web_sales ws2 WHERE ws2.ws_web_site_sk = ts.w_warehouse_id) AS total_sales_count,
    COALESCE(
        (SELECT AVG(car.sr_return_quantity)
         FROM store_returns car
         WHERE car.sr_store_sk IN 
             (SELECT s.s_store_sk 
              FROM store s 
              WHERE s.s_open_date_sk < cast('2002-10-01' as date))
        ), 0) AS average_store_returns
FROM TopStores ts
ORDER BY ts.total_net_profit_store DESC
LIMIT 10;