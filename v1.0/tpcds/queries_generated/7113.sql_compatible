
WITH TopCustomers AS (
    SELECT
        c.c_customer_id,
        SUM(ws.ws_net_profit) AS total_profit
    FROM
        customer c
    JOIN
        web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
    GROUP BY
        c.c_customer_id
    ORDER BY
        total_profit DESC
    LIMIT 10
), 
MonthlySales AS (
    SELECT
        d.d_year,
        d.d_month_seq,
        SUM(ws.ws_net_sales) AS total_sales
    FROM
        date_dim d
    JOIN
        web_sales ws ON d.d_date_sk = ws.ws_sold_date_sk
    GROUP BY
        d.d_year, d.d_month_seq
), 
PromotionalImpact AS (
    SELECT
        p.p_promo_name,
        COUNT(DISTINCT ws.ws_order_number) AS num_orders,
        SUM(ws.ws_net_profit) AS total_profit
    FROM
        promotion p
    JOIN
        web_sales ws ON p.p_promo_sk = ws.ws_promo_sk
    GROUP BY
        p.p_promo_name
), 
InventoryDetails AS (
    SELECT
        w.w_warehouse_name,
        item.i_item_id,
        SUM(inv.inv_quantity_on_hand) AS total_quantity
    FROM
        inventory inv
    JOIN
        warehouse w ON inv.inv_warehouse_sk = w.w_warehouse_sk
    JOIN
        item ON inv.inv_item_sk = item.i_item_sk
    GROUP BY
        w.w_warehouse_name, item.i_item_id
)
SELECT
    tc.c_customer_id,
    ms.d_year,
    ms.d_month_seq,
    pi.p_promo_name,
    pi.total_profit AS promo_profit,
    id.w_warehouse_name,
    id.total_quantity
FROM
    TopCustomers tc
JOIN
    MonthlySales ms ON ms.total_sales > 100000
JOIN
    PromotionalImpact pi ON pi.total_profit > 10000
JOIN
    InventoryDetails id ON id.total_quantity > 50
ORDER BY
    promo_profit DESC, id.total_quantity DESC;
