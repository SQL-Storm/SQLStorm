
WITH CustomerReturns AS (
    SELECT 
        cr_returning_customer_sk,
        SUM(cr_return_amount) AS total_return_amount,
        COUNT(cr_return_quantity) AS total_returns
    FROM catalog_returns
    GROUP BY cr_returning_customer_sk
),
WebReturns AS (
    SELECT 
        wr_returning_customer_sk,
        SUM(wr_return_amt) AS total_web_return_amount,
        COUNT(wr_return_quantity) AS total_web_returns
    FROM web_returns
    GROUP BY wr_returning_customer_sk
),
ItemSales AS (
    SELECT 
        ws_item_sk,
        SUM(ws_quantity) AS total_quantity_sold,
        SUM(ws_net_paid) AS total_sales_amount
    FROM web_sales
    GROUP BY ws_item_sk
),
AggregatedReturns AS (
    SELECT 
        COALESCE(cr.cr_returning_customer_sk, wr.wr_returning_customer_sk) AS returning_customer_sk,
        COALESCE(cr.total_return_amount, 0) + COALESCE(wr.total_web_return_amount, 0) AS total_return_amount,
        COALESCE(cr.total_returns, 0) + COALESCE(wr.total_web_returns, 0) AS total_returns
    FROM CustomerReturns cr
    FULL OUTER JOIN WebReturns wr
    ON cr.cr_returning_customer_sk = wr.wr_returning_customer_sk
)
SELECT 
    c.c_customer_sk,
    c.c_first_name,
    c.c_last_name,
    COALESCE(ar.total_return_amount, 0) AS total_return_amount,
    COALESCE(ar.total_returns, 0) AS total_returns,
    i.total_quantity_sold,
    i.total_sales_amount,
    i.total_sales_amount - COALESCE(ar.total_return_amount, 0) AS net_sales_amount
FROM customer c
LEFT JOIN AggregatedReturns ar
ON c.c_customer_sk = ar.returning_customer_sk
LEFT JOIN ItemSales i
ON i.ws_item_sk IN (
    SELECT ws_item_sk
    FROM web_sales
    WHERE ws_bill_customer_sk = c.c_customer_sk
)
WHERE c.c_preferred_cust_flag = 'Y'
AND (ar.total_return_amount IS NULL OR ar.total_return_amount > 100)
ORDER BY net_sales_amount DESC
FETCH FIRST 100 ROWS ONLY;
