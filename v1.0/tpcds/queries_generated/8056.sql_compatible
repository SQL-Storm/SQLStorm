
WITH sales_data AS (
    SELECT 
        s.ss_item_sk,
        SUM(s.ss_quantity) AS total_quantity,
        SUM(s.ss_net_paid_inc_tax) AS total_sales,
        COUNT(DISTINCT s.ss_customer_sk) AS unique_customers,
        d.d_year,
        d.d_month_seq,
        d.d_week_seq,
        w.w_warehouse_name,
        c.c_first_name,
        c.c_last_name
    FROM 
        store_sales s
    JOIN 
        date_dim d ON s.ss_sold_date_sk = d.d_date_sk
    JOIN 
        store w ON s.ss_store_sk = w.s_store_sk
    JOIN 
        customer c ON s.ss_customer_sk = c.c_customer_sk
    WHERE 
        d.d_year = 2023 
        AND d.d_month_seq BETWEEN 1 AND 12
    GROUP BY 
        s.ss_item_sk, d.d_year, d.d_month_seq, d.d_week_seq, w.w_warehouse_name, c.c_first_name, c.c_last_name
),
item_stats AS (
    SELECT 
        i.i_item_sk,
        i.i_item_desc,
        AVG(i.i_current_price) AS avg_price,
        MAX(i.i_current_price) AS max_price,
        MIN(i.i_current_price) AS min_price
    FROM 
        item i
    GROUP BY 
        i.i_item_sk, i.i_item_desc
)
SELECT 
    sd.total_quantity,
    sd.total_sales,
    sd.unique_customers,
    is.avg_price,
    is.max_price,
    is.min_price,
    sd.d_year,
    sd.d_month_seq,
    sd.d_week_seq,
    sd.w_warehouse_name,
    sd.c_first_name,
    sd.c_last_name
FROM 
    sales_data sd
JOIN 
    item_stats is ON sd.ss_item_sk = is.i_item_sk
ORDER BY 
    sd.total_sales DESC, sd.total_quantity DESC
FETCH FIRST 100 ROWS ONLY;
