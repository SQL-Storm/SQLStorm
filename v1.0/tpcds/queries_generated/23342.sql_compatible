
WITH RankedSales AS (
    SELECT 
        ws.bill_customer_sk,
        ws.ws_item_sk,
        ws.ws_sales_price,
        ROW_NUMBER() OVER (PARTITION BY ws.bill_customer_sk ORDER BY ws.ws_sales_price DESC) as sales_rank
    FROM
        web_sales ws
    WHERE
        ws.ws_sold_date_sk BETWEEN 10101 AND 10130
),
HighValueCustomers AS (
    SELECT 
        cd.cd_demo_sk, 
        SUM(CASE WHEN rs.sales_rank = 1 THEN ws.ws_sales_price ELSE 0 END) as highest_sales
    FROM 
        RankedSales rs
    JOIN customer c ON rs.bill_customer_sk = c.c_customer_sk
    JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    GROUP BY cd.cd_demo_sk
    HAVING SUM(ws.ws_sales_price) > 500
),
CustomerAddresses AS (
    SELECT 
        ca.ca_address_id,
        ca.ca_city,
        ca.ca_state,
        ca.ca_zip,
        COALESCE(ca.ca_country, 'Unknown') AS country
    FROM
        customer_address ca
    WHERE 
        EXISTS (SELECT 1 FROM HighValueCustomers hvc WHERE hvc.cd_demo_sk = ca.ca_address_sk)
),
AggregateSales AS (
    SELECT 
        ws.ws_ship_date_sk,
        SUM(ws.ws_sales_price) AS total_sales,
        COUNT(DISTINCT ws.ws_ship_customer_sk) AS unique_customers
    FROM 
        web_sales ws
    GROUP BY 
        ws.ws_ship_date_sk
)
SELECT 
    ca.ca_city,
    ca.ca_state,
    ca.ca_zip,
    ca.country,
    COALESCE(ag.total_sales, 0) AS total_sales,
    COALESCE(ag.unique_customers, 0) AS unique_customers
FROM 
    CustomerAddresses ca
LEFT JOIN 
    AggregateSales ag ON ca.ca_zip = CAST(ag.unique_customers AS VARCHAR)
WHERE 
    (ca.ca_city IS NOT NULL OR ca.ca_state IS NOT NULL)
    AND ca.ca_state NOT IN ('NY', 'CA')
ORDER BY 
    total_sales DESC NULLS LAST;
