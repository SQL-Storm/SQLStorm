WITH RECURSIVE customer_hierarchy AS (
    SELECT 
        c_customer_sk,
        c_first_name || ' ' || c_last_name AS full_name,
        NULL AS parent_customer_sk,
        0 AS level
    FROM customer
    WHERE c_customer_sk IS NOT NULL

    UNION ALL

    SELECT 
        c.c_customer_sk,
        c.c_first_name || ' ' || c.c_last_name AS full_name,
        ch.c_customer_sk AS parent_customer_sk,
        ch.level + 1
    FROM customer_hierarchy ch
    JOIN customer c ON ch.c_customer_sk = c.c_current_cdemo_sk
)

, sales_by_customer AS (
    SELECT 
        ws.bill_customer_sk,
        SUM(ws.ws_ext_sales_price) AS total_sales,
        COUNT(ws.ws_order_number) AS order_count,
        RANK() OVER (PARTITION BY ws.bill_customer_sk ORDER BY SUM(ws.ws_ext_sales_price) DESC) AS sales_rank
    FROM web_sales ws
    JOIN customer_hierarchy ch ON ws.bill_customer_sk = ch.c_customer_sk
    GROUP BY ws.bill_customer_sk
)

SELECT 
    ch.full_name,
    COALESCE(sbc.total_sales, 0) AS total_sales,
    sbc.order_count,
    ch.level
FROM customer_hierarchy ch
LEFT JOIN sales_by_customer sbc ON ch.c_customer_sk = sbc.bill_customer_sk
WHERE ch.level < 3
ORDER BY ch.level, total_sales DESC;