
WITH RECURSIVE customer_returns AS (
    SELECT 
        sr_customer_sk,
        SUM(sr_return_quantity) AS total_returns,
        SUM(sr_return_amt_inc_tax) AS total_return_amt
    FROM 
        store_returns
    WHERE 
        sr_returned_date_sk >= (SELECT d_date_sk FROM date_dim WHERE d_year = 2023 AND d_moy = 1)
    GROUP BY 
        sr_customer_sk
),
income_summary AS (
    SELECT 
        c.c_customer_sk,
        COALESCE(hd.hd_income_band_sk, 0) AS income_band,
        COUNT(DISTINCT c.c_customer_id) AS customer_count,
        SUM(CASE WHEN cd.cd_gender = 'F' THEN 1 ELSE 0 END) AS female_count,
        SUM(CASE WHEN cd.cd_marital_status = 'M' THEN 1 ELSE 0 END) AS married_count
    FROM 
        customer c
    LEFT JOIN 
        household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk
    LEFT JOIN 
        customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    GROUP BY 
        c.c_customer_sk, income_band
)
SELECT 
    COALESCE(s.income_band, 'Unknown') AS income_band,
    cs.customer_count,
    NULLIF(s.total_returns, 0) AS total_returns,
    ROUND(AVG(s.total_return_amt), 2) AS average_return_amt
FROM 
    income_summary cs
LEFT JOIN 
    customer_returns s ON cs.c_customer_sk = s.sr_customer_sk
GROUP BY 
    income_band, cs.customer_count
ORDER BY 
    income_band DESC
LIMIT 10;
