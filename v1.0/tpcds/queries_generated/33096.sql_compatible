
WITH RECURSIVE item_hierarchy AS (
    SELECT i_item_sk, i_item_id, i_item_desc, i_current_price, 1 AS level
    FROM item
    WHERE i_current_price > 100.00

    UNION ALL

    SELECT ih.i_item_sk, ih.i_item_id, ih.i_item_desc, ih.i_current_price, ih.level + 1
    FROM item_hierarchy ih
    JOIN item i ON ih.i_item_sk = i.i_item_sk
    WHERE ih.level < 5 
),
customer_sales AS (
    SELECT 
        c.c_customer_id,
        SUM(ws.ws_net_profit) AS total_profit,
        COUNT(ws.ws_order_number) AS total_orders
    FROM customer c
    JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
    GROUP BY c.c_customer_id
),
top_customers AS (
    SELECT c.c_customer_id, cs.total_profit, cs.total_orders, 
           ROW_NUMBER() OVER (ORDER BY cs.total_profit DESC) AS rank
    FROM customer c
    JOIN customer_sales cs ON c.c_customer_id = cs.c_customer_id
    WHERE c.c_birth_year > 1980
    AND cs.total_orders > 10
),
shipping_summary AS (
    SELECT 
        sm.sm_ship_mode_id,
        COUNT(ws.ws_order_number) AS num_shipments,
        SUM(ws.ws_ext_ship_cost) AS total_shipping_cost
    FROM web_sales ws
    JOIN ship_mode sm ON ws.ws_ship_mode_sk = sm.sm_ship_mode_sk
    GROUP BY sm.sm_ship_mode_id
)
SELECT 
    tc.c_customer_id AS customer_id,
    tc.total_profit,
    tc.total_orders,
    ss.num_shipments,
    ss.total_shipping_cost,
    ih.i_item_desc,
    ih.i_current_price
FROM top_customers tc
LEFT JOIN shipping_summary ss ON tc.total_orders > ss.num_shipments
JOIN item_hierarchy ih ON ih.i_item_desc LIKE '%sale%'
WHERE 
    NOT EXISTS (
        SELECT 1 
        FROM store_sales ss
        WHERE ss.ss_customer_sk = tc.c_customer_id 
        AND ss.ss_net_paid > 1000.00
    )
ORDER BY tc.rank, ss.total_shipping_cost DESC;
