
WITH RECURSIVE CustomerReturns AS (
    SELECT sr_returned_date_sk, sr_item_sk, sr_customer_sk, sr_return_quantity, sr_return_amt, sr_reason_sk
    FROM store_returns
    WHERE sr_returned_date_sk BETWEEN 1 AND 30
    UNION ALL
    SELECT sr.returned_date_sk, sr.item_sk, sr.customer_sk, sr.return_quantity * 2, sr.return_amt * 0.9, sr.reason_sk
    FROM store_returns sr
    JOIN CustomerReturns cr ON sr.customer_sk = cr.sr_customer_sk
    WHERE cr.sr_return_quantity < 100
),
WarehouseInventory AS (
    SELECT inv_date_sk, inv_item_sk, inv_warehouse_sk, inv_quantity_on_hand
    FROM inventory
    WHERE inv_quantity_on_hand IS NOT NULL
),
AggregateSales AS (
    SELECT ws_item_sk, SUM(ws_sales_price) AS total_sales, COUNT(ws_order_number) AS total_orders
    FROM web_sales
    WHERE ws_bill_customer_sk IS NOT NULL
    GROUP BY ws_item_sk
)
SELECT ca.ca_address_sk, 
       ca.ca_city,
       COALESCE((SELECT COUNT(*) FROM customer_demographics cd 
                 WHERE cd.cd_dep_count IS NOT NULL 
                 AND cd.cd_dep_count > 2), 0) AS high_dependents,
       COUNT(DISTINCT cr.sr_customer_sk) AS unique_customers_returned,
       COALESCE(SUM(cr.sr_return_amt), 0) AS total_returned_amount,
       SUM(CASE 
               WHEN wi.inv_quantity_on_hand < 10 THEN 1 
               ELSE 0 
           END) AS low_inventory_count
FROM customer_address ca
LEFT JOIN CustomerReturns cr ON ca.ca_address_sk = cr.sr_customer_sk
LEFT JOIN WarehouseInventory wi ON wi.inv_item_sk = cr.sr_item_sk
JOIN AggregateSales asale ON asale.ws_item_sk = cr.sr_item_sk
GROUP BY ca.ca_address_sk, ca.ca_city
HAVING COUNT(DISTINCT cr.sr_returned_date_sk) > 1
ORDER BY total_returned_amount DESC, ca.ca_city
LIMIT 50
OFFSET (SELECT COUNT(DISTINCT ca.ca_address_sk) FROM customer_address ca) / 2;
