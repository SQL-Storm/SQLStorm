WITH RECURSIVE Income_CTE AS (
    SELECT hd_demo_sk, 
           hd_income_band_sk, 
           hd_buy_potential, 
           hd_dep_count, 
           hd_vehicle_count,
           ROW_NUMBER() OVER (PARTITION BY hd_income_band_sk ORDER BY hd_dep_count DESC) as rn
    FROM household_demographics
), 
Sales_CTE AS (
    SELECT ws_item_sk,
           SUM(ws_net_profit) AS total_profit,
           SUM(ws_quantity) AS total_quantity,
           COUNT(DISTINCT ws_order_number) AS total_orders
    FROM web_sales
    WHERE ws_sold_date_sk BETWEEN (SELECT d_date_sk FROM date_dim WHERE d_date = cast('2002-10-01' as date) - INTERVAL '30 days') 
                               AND (SELECT d_date_sk FROM date_dim WHERE d_date = cast('2002-10-01' as date))
    GROUP BY ws_item_sk
), 
Shipping_Details AS (
    SELECT ws.ship_mode_sk, 
           sm.sm_type,
           SUM(ws.ws_ext_ship_cost) AS total_ship_cost
    FROM web_sales ws
    JOIN ship_mode sm ON ws.ws_ship_mode_sk = sm.sm_ship_mode_sk
    GROUP BY ws.ship_mode_sk, sm.sm_type
)
SELECT ca.ca_country,
       COUNT(DISTINCT c.c_customer_sk) AS customer_count,
       SUM(COALESCE(Sales_CTE.total_profit, 0)) AS total_profit,
       SUM(Sales_CTE.total_quantity) AS total_quantity,
       AVG(CASE WHEN Income_CTE.rn = 1 THEN hd_dep_count ELSE NULL END) AS avg_deps_highest_income,
       STRING_AGG(DISTINCT sd.sm_type, ', ') AS shipping_modes,
       MAX(sd.total_ship_cost) AS max_shipping_cost
FROM customer_address ca
JOIN customer c ON ca.ca_address_sk = c.c_current_addr_sk
LEFT JOIN Sales_CTE ON c.c_customer_sk = Sales_CTE.ws_item_sk
LEFT JOIN Income_CTE ON c.c_current_hdemo_sk = Income_CTE.hd_demo_sk
LEFT JOIN Shipping_Details sd ON Sales_CTE.ws_item_sk = sd.ship_mode_sk
WHERE ca.ca_country IS NOT NULL
GROUP BY ca.ca_country
HAVING COUNT(c.c_customer_sk) > 10
ORDER BY total_profit DESC;