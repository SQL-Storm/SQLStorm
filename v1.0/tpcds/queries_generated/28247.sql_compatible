
WITH AddressParts AS (
    SELECT 
        ca_address_sk,
        TRIM(CONCAT(ca_street_number, ' ', ca_street_name, ' ', ca_street_type)) AS full_address,
        ca_city,
        ca_state,
        ca_zip
    FROM customer_address
),
CustomerNames AS (
    SELECT 
        c_customer_sk,
        CONCAT(TRIM(c_first_name), ' ', TRIM(c_last_name)) AS full_name,
        c_email_address
    FROM customer
),
CustomerDetails AS (
    SELECT 
        c.c_customer_sk,
        c.full_name,
        c.c_email_address,
        a.full_address,
        a.ca_city,
        a.ca_state,
        a.ca_zip,
        d.d_date,
        d.d_month_seq
    FROM CustomerNames c
    JOIN customer_address a ON c.c_customer_sk = a.ca_address_sk
    JOIN date_dim d ON c.c_customer_sk = d.d_date_sk
)
SELECT 
    SUBSTRING(full_name, 1, 20) AS name_preview,
    ca_city,
    ca_state,
    COUNT(*) AS address_count,
    MIN(d_date) AS first_interaction,
    MAX(d_date) AS last_interaction,
    COUNT(DISTINCT ca_zip) AS distinct_zip_codes,
    STRING_AGG(c_email_address, '; ') AS email_list
FROM CustomerDetails
GROUP BY 
    full_name,
    ca_city,
    ca_state
HAVING 
    COUNT(*) > 1
ORDER BY 
    address_count DESC;
