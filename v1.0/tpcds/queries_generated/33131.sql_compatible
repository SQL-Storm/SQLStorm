
WITH RECURSIVE item_hierarchy AS (
    SELECT i_item_sk, i_item_id, i_product_name, i_current_price, i_size, 
           ARRAY[i_item_id] AS path
    FROM item 
    WHERE i_rec_start_date <= DATE '2002-10-01' AND (i_rec_end_date IS NULL OR i_rec_end_date > DATE '2002-10-01')

    UNION ALL

    SELECT i.i_item_sk, i.i_item_id, i.i_product_name, 
           i.i_current_price, i.i_size, 
           ih.path || i.i_item_id
    FROM item i
    JOIN item_hierarchy ih ON i.i_brand_id = ih.i_item_sk
    WHERE i.i_rec_start_date <= DATE '2002-10-01' AND (i.i_rec_end_date IS NULL OR i.i_rec_end_date > DATE '2002-10-01')
)

SELECT 
    c.c_customer_id,
    c.c_first_name,
    c.c_last_name,
    ca.ca_city,
    COUNT(DISTINCT ws.ws_order_number) AS total_orders,
    SUM(ws.ws_net_paid) AS total_spent,
    SUM(ws.ws_net_profit) AS total_profit,
    SUM(ws.ws_ext_discount_amt) AS total_discount,
    AVG(ws.ws_net_paid) OVER (PARTITION BY ca.ca_state ORDER BY SUM(ws.ws_net_paid) DESC) AS avg_order_value_by_state,
    (SELECT ib.ib_income_band_sk 
     FROM household_demographics hd
     JOIN income_band ib ON hd.hd_income_band_sk = ib.ib_income_band_sk
     WHERE hd.hd_demo_sk = c.c_current_hdemo_sk) AS income_band,
    ih.path AS item_path
FROM customer c
JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
LEFT JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk AND ws.ws_sold_date_sk BETWEEN 1 AND 365
LEFT JOIN item_hierarchy ih ON ws.ws_item_sk = ih.i_item_sk
WHERE ca.ca_state IS NOT NULL
GROUP BY c.c_customer_id, c.c_first_name, c.c_last_name, ca.ca_city, ca.ca_state, ih.path
HAVING SUM(ws.ws_net_paid) > (SELECT AVG(ws_inner.ws_net_paid) FROM web_sales ws_inner WHERE ws_inner.ws_sold_date_sk >= 1) OR income_band IS NULL
ORDER BY total_spent DESC
LIMIT 100;
