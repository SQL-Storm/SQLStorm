
WITH AddressDetails AS (
    SELECT 
        ca_state,
        ca_city,
        ca_street_name,
        ca_street_number,
        CONCAT(ca_street_number, ' ', ca_street_name, ' ', ca_street_type) AS full_address,
        COUNT(*) AS address_count
    FROM 
        customer_address
    GROUP BY 
        ca_state, ca_city, ca_street_name, ca_street_number
),
GenderDemographics AS (
    SELECT 
        cd_gender,
        COUNT(c.c_customer_sk) AS customer_count,
        AVG(cd_dep_count) AS avg_dependents,
        AVG(cd_buy_potential) AS avg_buy_potential
    FROM 
        customer c
    JOIN 
        customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    GROUP BY 
        cd_gender
),
SalesStatistics AS (
    SELECT 
        ws_item_sk,
        SUM(ws_sales_price) AS total_sales,
        COUNT(ws_order_number) AS total_orders,
        AVG(ws_sales_price) AS avg_order_value
    FROM 
        web_sales
    GROUP BY 
        ws_item_sk
),
FinalReport AS (
    SELECT 
        a.ca_city,
        a.ca_state,
        a.full_address,
        d.cd_gender,
        d.customer_count,
        d.avg_dependents,
        s.total_sales,
        s.total_orders,
        s.avg_order_value,
        ROW_NUMBER() OVER (PARTITION BY a.ca_city, a.ca_state ORDER BY s.total_sales DESC) AS sales_rank
    FROM 
        AddressDetails a
    JOIN 
        GenderDemographics d ON a.ca_state = 'CA'  
    JOIN 
        SalesStatistics s ON s.ws_item_sk IN (SELECT i_item_sk FROM item WHERE i_category = 'Electronics')  
)
SELECT 
    ca_city,
    ca_state,
    full_address,
    cd_gender,
    customer_count,
    avg_dependents,
    total_sales,
    total_orders,
    avg_order_value,
    sales_rank
FROM 
    FinalReport
WHERE 
    sales_rank <= 5  
ORDER BY 
    ca_city, total_sales DESC;
