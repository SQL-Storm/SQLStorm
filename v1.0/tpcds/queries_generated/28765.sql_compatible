
WITH processed_addresses AS (
    SELECT 
        ca.city AS city_name,
        CONCAT_WS(', ', ca.street_number, ca.street_name, ca.street_type) AS full_address,
        LENGTH(ca.city) AS city_length,
        UPPER(ca.state) AS state_uppercase,
        SUBSTRING(ca.zip, 1, 5) AS zip_prefix
    FROM 
        customer_address ca
    WHERE 
        ca.city IS NOT NULL
),
customer_demographics_processed AS (
    SELECT 
        cd_demo_sk,
        CASE
            WHEN cd_gender = 'M' THEN 'Male'
            WHEN cd_gender = 'F' THEN 'Female'
            ELSE 'Unknown'
        END AS gender_full,
        cd_marital_status,
        cd_education_status,
        COALESCE(cd_purchase_estimate, 0) AS purchase_estimate
    FROM 
        customer_demographics
),
date_info AS (
    SELECT 
        d_date AS sale_date,
        d_month_seq,
        d_year,
        d_week_seq,
        d_quarter_seq
    FROM 
        date_dim
    WHERE 
        d_year >= 2021
),
sales_summary AS (
    SELECT 
        ws.ship_mode_sk,
        COUNT(*) AS total_sales,
        SUM(ws.ext_sales_price) AS total_revenue
    FROM 
        web_sales ws
    JOIN 
        date_info di ON ws.sold_date_sk = di.d_date_sk
    GROUP BY 
        ws.ship_mode_sk
)
SELECT 
    paa.city_name,
    paa.full_address,
    cdp.gender_full,
    ss.total_sales,
    ss.total_revenue,
    di.d_month_seq,
    di.d_year
FROM 
    processed_addresses paa
JOIN 
    customer_demographics_processed cdp ON paa.zip_prefix = cdp.cd_demo_sk 
LEFT JOIN 
    sales_summary ss ON ss.ship_mode_sk = paa.state_uppercase 
JOIN 
    date_info di ON di.d_year = cdp.purchase_estimate
WHERE 
    paa.city_length > 3 
ORDER BY 
    ss.total_revenue DESC, 
    paa.city_name ASC
LIMIT 100;
