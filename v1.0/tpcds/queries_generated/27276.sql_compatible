
WITH CustomerStats AS (
    SELECT 
        c.c_customer_sk,
        c.c_first_name,
        c.c_last_name,
        CONCAT(c.c_first_name, ' ', c.c_last_name) AS full_name,
        cd.cd_gender,
        cd.cd_marital_status,
        cd.cd_purchase_estimate,
        cd.cd_credit_rating,
        DENSE_RANK() OVER (PARTITION BY cd.cd_gender ORDER BY cd.cd_purchase_estimate DESC) AS purchase_rank
    FROM customer c
    JOIN customer_demographics cd ON c.c_customer_sk = cd.cd_demo_sk
),
AddressStats AS (
    SELECT 
        ca.ca_address_sk,
        ca.ca_city,
        ca.ca_state,
        ca.ca_country,
        COUNT(DISTINCT c.c_customer_sk) AS customer_count,
        STRING_AGG(DISTINCT CONCAT(c.c_first_name, ' ', c.c_last_name), ', ') AS customers
    FROM customer_address ca
    JOIN customer c ON ca.ca_address_sk = c.c_current_addr_sk
    GROUP BY ca.ca_address_sk, ca.ca_city, ca.ca_state, ca.ca_country
),
TopCustomers AS (
    SELECT 
        cs.full_name,
        cs.cd_gender,
        ca.ca_city,
        ca.ca_state,
        ca.ca_country,
        cs.purchase_rank
    FROM CustomerStats cs
    JOIN customer_address ca ON cs.c_customer_sk = ca.ca_current_addr_sk
    WHERE cs.purchase_rank <= 5
)
SELECT 
    tc.full_name,
    tc.cd_gender,
    tc.ca_city,
    tc.ca_state,
    tc.ca_country,
    a.customer_count,
    COALESCE(a.customers, 'No customers') AS customer_names
FROM TopCustomers tc
LEFT JOIN AddressStats a ON (tc.ca_city = a.ca_city AND tc.ca_state = a.ca_state AND tc.ca_country = a.ca_country)
ORDER BY tc.purchase_rank, tc.full_name;
