
WITH RECURSIVE Address_Hierarchy AS (
    SELECT ca_address_sk, ca_city, ca_state, ca_country, 0 AS level
    FROM customer_address
    WHERE ca_state IS NOT NULL
    UNION ALL
    SELECT a.ca_address_sk, a.ca_city, a.ca_state, a.ca_country, h.level + 1
    FROM customer_address a
    JOIN Address_Hierarchy h ON a.ca_city = h.ca_city AND a.ca_state <> h.ca_state
    WHERE h.level < 5
), 
Customer_Details AS (
    SELECT c.c_customer_sk, cd.cd_gender, cd.cd_marital_status, cd.cd_education_status, 
           SUM(ws.ws_sales_price) AS total_spent,
           COUNT(DISTINCT ws.ws_order_number) AS total_orders
    FROM customer c
    LEFT JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    LEFT JOIN web_sales ws ON c.c_customer_sk = ws.ws_ship_customer_sk
    GROUP BY c.c_customer_sk, cd.cd_gender, cd.cd_marital_status, cd.cd_education_status
),
Income_Aggregates AS (
    SELECT hd.hd_income_band_sk, 
           MAX(hd.hd_dep_count) AS max_dep_count, 
           MIN(hd.hd_vehicle_count) AS min_vehicle_count,
           COUNT(DISTINCT c.c_customer_sk) AS customer_count
    FROM household_demographics hd
    JOIN customer c ON hd.hd_demo_sk = c.c_current_hdemo_sk
    GROUP BY hd.hd_income_band_sk
)
SELECT a.ca_city, a.ca_state, a.ca_country, 
       cd.cd_gender, cd.cd_marital_status, cd.cd_education_status,
       COALESCE(ia.max_dep_count, 0) AS max_dependents, 
       COALESCE(ia.min_vehicle_count, 0) AS min_vehicles,
       cd.total_spent, cd.total_orders
FROM Address_Hierarchy a
LEFT JOIN Customer_Details cd ON cd.c_customer_sk IN (SELECT c.c_current_hdemo_sk FROM customer c WHERE c.c_current_addr_sk = a.ca_address_sk)
LEFT JOIN Income_Aggregates ia ON cd.cd_gender = CASE WHEN a.ca_country = 'USA' THEN 'M' ELSE 'F' END
WHERE (cd.cd_marital_status IS NULL OR cd.cd_marital_status <> 'S')
  AND (cd.total_orders > 1 OR (cd.total_orders = 1 AND cd.total_spent > 100.00))
ORDER BY a.ca_country, a.ca_city, cd.total_spent DESC
LIMIT 50;
