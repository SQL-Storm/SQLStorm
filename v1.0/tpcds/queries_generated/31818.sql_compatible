
WITH RECURSIVE sales_hierarchy AS (
    SELECT
        s_store_sk,
        SUM(ss_net_profit) AS total_profit,
        1 AS level
    FROM store_sales
    GROUP BY s_store_sk
    
    UNION ALL
    
    SELECT
        s.s_store_sk,
        sh.total_profit * 1.1 AS total_profit,
        sh.level + 1
    FROM sales_hierarchy sh
    JOIN store s ON s.s_store_sk = sh.s_store_sk
    WHERE sh.level < 5
),

customer_details AS (
    SELECT
        c.c_customer_sk,
        ca.ca_state,
        cd.cd_gender,
        cd.cd_income_band_sk,
        ROW_NUMBER() OVER (PARTITION BY ca_state ORDER BY c.c_birth_year DESC) AS birth_rank
    FROM customer c
    JOIN customer_demographics cd ON cd.cd_demo_sk = c.c_current_cdemo_sk
    JOIN customer_address ca ON ca.ca_address_sk = c.c_current_addr_sk
    WHERE c.c_birth_year IS NOT NULL
),

items_with_returns AS (
    SELECT
        i.i_item_sk,
        COALESCE(SUM(cr.cr_return_quantity), 0) AS total_returns,
        SUM(ws.ws_net_profit) AS total_sales_profit
    FROM item i
    LEFT JOIN web_sales ws ON ws.ws_item_sk = i.i_item_sk
    LEFT JOIN catalog_returns cr ON cr.cr_item_sk = i.i_item_sk
    GROUP BY i.i_item_sk
),

performance_benchmark AS (
    SELECT
        s.s_store_name,
        sh.total_profit,
        cd.ca_state,
        SUM(iwr.total_sales_profit) AS sales_profit,
        AVG(NULLIF(iwr.total_returns, 0)) AS avg_returns,
        COUNT(DISTINCT c.c_customer_sk) AS distinct_customers
    FROM sales_hierarchy sh
    JOIN store s ON s.s_store_sk = sh.s_store_sk
    JOIN customer_details cd ON cd.cd_income_band_sk = 1
    JOIN items_with_returns iwr ON iwr.total_sales_profit > 10000
    JOIN customer c ON c.c_current_addr_sk = cd.c_customer_sk
    GROUP BY s.s_store_name, sh.total_profit, cd.ca_state
)

SELECT 
    pb.s_store_name,
    pb.total_profit AS store_profit,
    pb.avg_returns AS average_item_returns,
    pb.distinct_customers AS unique_customers,
    (pb.sales_profit / NULLIF(pb.total_profit, 0)) * 100 AS profit_margin_percentage
FROM performance_benchmark pb
WHERE pb.distinct_customers > 30
ORDER BY profit_margin_percentage DESC
FETCH FIRST 10 ROWS ONLY;
