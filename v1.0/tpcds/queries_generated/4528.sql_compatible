
WITH SalesData AS (
    SELECT
        ws.web_site_id,
        SUM(ws.ws_net_profit) AS total_profit,
        COUNT(ws.ws_order_number) AS total_orders
    FROM
        web_sales ws
    JOIN
        customer c ON ws.ws_bill_customer_sk = c.c_customer_sk
    WHERE
        c.c_birth_year < 1990
    GROUP BY
        ws.web_site_id
),
CustomerDemographics AS (
    SELECT
        cd.cd_gender,
        COUNT(cd.cd_demo_sk) AS gender_count
    FROM
        customer_demographics cd
    WHERE
        cd.cd_credit_rating = 'High'
    GROUP BY
        cd.cd_gender
),
WarehouseItemCounts AS (
    SELECT
        inv.inv_warehouse_sk,
        COUNT(inv.inv_item_sk) AS item_count
    FROM
        inventory inv
    GROUP BY
        inv.inv_warehouse_sk
),
Returns AS (
    SELECT
        sr_store_sk,
        SUM(sr_return_quantity) AS total_returns,
        AVG(sr_return_amt) AS avg_return_amt
    FROM
        store_returns sr
    GROUP BY
        sr_store_sk
)
SELECT
    w.warehouse_id,
    COALESCE(sd.total_profit, 0) AS total_profit,
    COALESCE(sd.total_orders, 0) AS total_orders,
    COALESCE(cd.gender_count, 0) AS high_credit_gender_count,
    COALESCE(wic.item_count, 0) AS total_items_in_warehouse,
    COALESCE(r.total_returns, 0) AS total_returns,
    COALESCE(r.avg_return_amt, 0) AS average_return_amount
FROM
    warehouse w
LEFT JOIN SalesData sd ON w.warehouse_sk = sd.web_site_id
LEFT JOIN CustomerDemographics cd ON cd.cd_gender IS NOT NULL
LEFT JOIN WarehouseItemCounts wic ON w.warehouse_sk = wic.inv_warehouse_sk
LEFT JOIN Returns r ON w.warehouse_sk = r.sr_store_sk
ORDER BY
    total_profit DESC,
    total_orders DESC,
    high_credit_gender_count DESC;
