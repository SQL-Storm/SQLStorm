
WITH customer_stats AS (
    SELECT 
        c.c_customer_sk,
        COUNT(DISTINCT wr_order_number) AS total_web_returns,
        SUM(wr_return_amt) AS total_return_amount,
        SUM(wr_return_tax) AS total_return_tax,
        AVG(wr_return_quantity) AS avg_return_quantity
    FROM 
        customer c
    LEFT JOIN 
        web_returns wr ON c.c_customer_sk = wr.wr_returning_customer_sk
    GROUP BY 
        c.c_customer_sk
),
store_sales_summary AS (
    SELECT 
        s_store_sk,
        SUM(ss_sales_price) AS total_sales,
        COUNT(DISTINCT ss_ticket_number) AS total_sales_transactions
    FROM 
        store_sales ss
    GROUP BY 
        s_store_sk
),
item_sales_summary AS (
    SELECT 
        ws_item_sk,
        SUM(ws_ext_sales_price) AS total_web_sales,
        SUM(ws_net_profit) AS total_web_profit
    FROM 
        web_sales
    GROUP BY 
        ws_item_sk
)
SELECT 
    ca.ca_city,
    COUNT(DISTINCT c.c_customer_sk) AS total_customers,
    SUM(is.total_web_sales) AS total_web_sales_per_city,
    SUM(ss.total_sales) AS total_store_sales_per_city,
    SUM(cs.total_return_amount) AS total_return_amount_per_city,
    AVG(cs.total_return_tax) AS avg_return_tax_per_city
FROM 
    customer_address ca
JOIN 
    customer c ON ca.ca_address_sk = c.c_current_addr_sk
LEFT JOIN 
    customer_stats cs ON c.c_customer_sk = cs.c_customer_sk
LEFT JOIN 
    store_sales_summary ss ON ss.s_store_sk IN (
        SELECT s_store_sk FROM store WHERE s_city = ca.ca_city
    )
LEFT JOIN 
    item_sales_summary is ON is.ws_item_sk IN (
        SELECT ws_item_sk FROM web_sales WHERE ws_ship_addr_sk = c.c_current_addr_sk
    )
GROUP BY 
    ca.ca_city
ORDER BY 
    total_web_sales_per_city DESC
LIMIT 10;
