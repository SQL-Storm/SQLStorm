
WITH RECURSIVE sales_summary AS (
    SELECT 
        ws_item_sk,
        SUM(ws_sales_price) AS total_sales,
        SUM(ws_quantity) AS total_quantity,
        COUNT(ws_order_number) AS total_orders
    FROM web_sales
    GROUP BY ws_item_sk
    UNION ALL
    SELECT 
        cs_item_sk,
        SUM(cs_sales_price) AS total_sales,
        SUM(cs_quantity) AS total_quantity,
        COUNT(cs_order_number) AS total_orders
    FROM catalog_sales
    GROUP BY cs_item_sk
)
SELECT
    i.i_item_id,
    COALESCE(ss.total_sales, 0) AS web_sales,
    COALESCE(cs.total_sales, 0) AS catalog_sales,
    COALESCE(ss.total_sales, 0) + COALESCE(cs.total_sales, 0) AS total_sales,
    RANK() OVER (ORDER BY COALESCE(ss.total_sales, 0) + COALESCE(cs.total_sales, 0) DESC) AS sales_rank,
    d.d_year,
    d.d_month_seq,
    (SELECT COUNT(DISTINCT ws.c_customer_sk) 
     FROM web_sales ws 
     WHERE ws.ws_item_sk = i.i_item_sk) AS unique_customers
FROM item i
LEFT JOIN (
    SELECT ws_item_sk, SUM(ws_sales_price) AS total_sales
    FROM web_sales
    GROUP BY ws_item_sk
) ss ON i.i_item_sk = ss.ws_item_sk
LEFT JOIN (
    SELECT cs_item_sk, SUM(cs_sales_price) AS total_sales
    FROM catalog_sales
    GROUP BY cs_item_sk
) cs ON i.i_item_sk = cs.cs_item_sk
JOIN date_dim d ON d.d_date_sk IN (
    SELECT ws_sold_date_sk 
    FROM web_sales 
    WHERE ws_item_sk = i.i_item_sk
    UNION
    SELECT cs_sold_date_sk 
    FROM catalog_sales 
    WHERE cs_item_sk = i.i_item_sk
)
WHERE d.d_year = 2022
AND (d.d_month_seq BETWEEN 1 AND 12)
GROUP BY i.i_item_id, ss.total_sales, cs.total_sales, d.d_year, d.d_month_seq
ORDER BY total_sales DESC;
