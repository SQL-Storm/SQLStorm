
WITH RECURSIVE sales_hierarchy AS (
    SELECT c.c_customer_id,
           c.c_first_name,
           c.c_last_name,
           COALESCE(COUNT(ss.ss_ticket_number), 0) AS total_sales,
           SUM(ss.ss_net_paid) AS total_revenue
    FROM customer c
    LEFT JOIN store_sales ss ON c.c_customer_sk = ss.ss_customer_sk
    GROUP BY c.c_customer_id, c.c_first_name, c.c_last_name
    HAVING COALESCE(COUNT(ss.ss_ticket_number), 0) > 5

    UNION ALL

    SELECT s.hierarchy_customer_id,
           s.hierarchy_first_name,
           s.hierarchy_last_name,
           s.total_sales + COALESCE(COUNT(ss2.ss_ticket_number), 0) AS total_sales,
           s.total_revenue + SUM(ss2.ss_net_paid) AS total_revenue
    FROM sales_hierarchy s
    JOIN store_sales ss2 ON s.total_sales > 5 AND s.c_customer_id = ss2.ss_customer_sk
    GROUP BY s.hierarchy_customer_id, s.hierarchy_first_name, s.hierarchy_last_name, s.total_sales, s.total_revenue
)
SELECT ca.ca_city,
       COUNT(DISTINCT sh.c_customer_id) AS active_customers,
       AVG(sh.total_revenue) AS avg_revenue,
       MAX(sh.total_sales) AS max_sales
FROM sales_hierarchy sh
JOIN customer_address ca ON sh.c_customer_id = ca.ca_address_id
LEFT JOIN (
    SELECT c.c_customer_id,
           SUM(ws.ws_net_profit) AS net_profit
    FROM customer c
    LEFT JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
    GROUP BY c.c_customer_id
    HAVING SUM(ws.ws_net_profit) > 1000
) web_sum ON sh.c_customer_id = web_sum.c_customer_id
WHERE ca.ca_state = 'CA'
  AND (sh.total_revenue IS NOT NULL OR web_sum.net_profit IS NOT NULL)
GROUP BY ca.ca_city
ORDER BY active_customers DESC
LIMIT 10;
