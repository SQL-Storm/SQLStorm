
WITH SalesData AS (
    SELECT 
        ws.web_site_id AS WebsiteID,
        SUM(ws.ws_ext_sales_price) AS TotalSales,
        COUNT(DISTINCT ws.ws_order_number) AS OrderCount,
        AVG(ws.ws_sales_price) AS AvgSalesPrice,
        CAST(d.d_date AS DATE) AS SaleDate
    FROM 
        web_sales ws
    JOIN 
        date_dim d ON ws.ws_sold_date_sk = d.d_date_sk
    WHERE 
        d.d_year = 2022
    GROUP BY 
        ws.web_site_id, d.d_date
), RankedSales AS (
    SELECT 
        WebsiteID,
        TotalSales,
        OrderCount,
        AvgSalesPrice,
        SaleDate,
        RANK() OVER (ORDER BY TotalSales DESC) AS SalesRank
    FROM 
        SalesData
), CustomerStats AS (
    SELECT 
        c.c_customer_id AS CustomerID,
        COUNT(DISTINCT ws.ws_order_number) AS TotalOrders,
        SUM(ws.ws_ext_sales_price) AS TotalSpent
    FROM 
        customer c
    JOIN 
        web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
    GROUP BY 
        c.c_customer_id
    HAVING 
        COUNT(DISTINCT ws.ws_order_number) > 5
), IncomeAnalysis AS (
    SELECT 
        h.hd_income_band_sk AS IncomeBand,
        COUNT(DISTINCT c.c_customer_id) AS CustomerCount,
        AVG(cs.TotalNetProfit) AS AvgNetProfit
    FROM 
        household_demographics h
    JOIN 
        customer c ON h.hd_demo_sk = c.c_current_hdemo_sk
    JOIN 
        (SELECT 
            ss.ss_customer_sk,
            SUM(ss.ss_net_profit) AS TotalNetProfit
        FROM 
            store_sales ss
        GROUP BY 
            ss.ss_customer_sk) cs ON c.c_customer_sk = cs.ss_customer_sk
    GROUP BY 
        h.hd_income_band_sk
)
SELECT 
    rs.WebsiteID,
    rs.TotalSales,
    rs.OrderCount,
    rs.AvgSalesPrice,
    ca.CustomerID,
    ca.TotalOrders,
    ca.TotalSpent,
    ia.IncomeBand,
    ia.CustomerCount,
    ia.AvgNetProfit
FROM 
    RankedSales rs
JOIN 
    CustomerStats ca ON ca.TotalOrders > 10
JOIN 
    IncomeAnalysis ia ON ca.TotalSpent > (SELECT AVG(TotalSpent) FROM CustomerStats)
WHERE 
    rs.SalesRank <= 20
ORDER BY 
    rs.TotalSales DESC, ca.TotalSpent DESC;
