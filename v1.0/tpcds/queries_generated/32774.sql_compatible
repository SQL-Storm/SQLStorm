
WITH RECURSIVE MonthlyReturns AS (
    SELECT 
        wr_returned_date_sk,
        wr_return_time_sk,
        SUM(wr_return_quantity) AS total_returned,
        SUM(wr_return_amt) AS total_return_amt,
        COUNT(DISTINCT wr_order_number) AS order_count,
        wr_order_number,
        wr_return_qty,
        wr_returning_customer_sk
    FROM 
        web_returns
    GROUP BY 
        wr_returned_date_sk, wr_return_time_sk, wr_order_number, wr_return_qty, wr_returning_customer_sk

    UNION ALL

    SELECT 
        wr_returned_date_sk + 1,
        wr_return_time_sk,
        SUM(wr_return_quantity) AS total_returned,
        SUM(wr_return_amt) AS total_return_amt,
        COUNT(DISTINCT wr_order_number) AS order_count,
        wr_order_number,
        wr_return_qty,
        wr_returning_customer_sk
    FROM 
        web_returns
    WHERE 
        wr_returned_date_sk < (SELECT MAX(wr_returned_date_sk) FROM web_returns)
    GROUP BY 
        wr_returned_date_sk, wr_return_time_sk, wr_order_number, wr_return_qty, wr_returning_customer_sk
)

SELECT 
    dd.d_year,
    dd.d_month_seq,
    ca.ca_country,
    COUNT(DISTINCT mr.wr_returning_customer_sk) AS returning_customers,
    SUM(mr.wr_return_amt) AS total_return_amt,
    SUM(mr.wr_return_quantity) AS total_returned_qty,
    AVG(mr.total_return_amt) OVER (PARTITION BY dd.d_year ORDER BY dd.d_month_seq) AS avg_monthly_return_amt,
    CASE 
        WHEN SUM(mr.wr_return_qty) IS NULL THEN 'No Returns'
        ELSE 'Returns Present'
    END AS returns_status
FROM 
    MonthlyReturns mr
JOIN 
    date_dim dd ON dd.d_date_sk = mr.wr_returned_date_sk
JOIN 
    customer_address ca ON ca.ca_address_sk = (
        SELECT 
            c.c_current_addr_sk
        FROM 
            customer c
        WHERE 
            c.c_customer_sk = mr.w_returning_customer_sk
    )
LEFT JOIN 
    store_sales ss ON ss.ss_sold_date_sk = mr.wr_returned_date_sk 
                   AND ss.ss_item_sk = (
                       SELECT 
                           wr_item_sk 
                       FROM 
                           web_returns wr 
                       WHERE 
                           wr_order_number = mr.wr_order_number
                   )
GROUP BY 
    dd.d_year, dd.d_month_seq, ca.ca_country
HAVING 
    COUNT(DISTINCT mr.wr_returning_customer_sk) > 0
ORDER BY 
    dd.d_year, dd.d_month_seq;
