
WITH RECURSIVE SalesCTE AS (
    SELECT
        ws_item_sk,
        SUM(ws_quantity) AS total_quantity,
        SUM(ws_net_paid_inc_tax) AS total_sales,
        DENSE_RANK() OVER (PARTITION BY ws_item_sk ORDER BY SUM(ws_net_paid_inc_tax) DESC) AS rank
    FROM web_sales
    GROUP BY ws_item_sk

    UNION ALL

    SELECT
        c.cs_item_sk,
        SUM(c.cs_quantity) AS total_quantity,
        SUM(c.cs_net_paid_inc_tax) AS total_sales,
        DENSE_RANK() OVER (PARTITION BY c.cs_item_sk ORDER BY SUM(c.cs_net_paid_inc_tax) DESC) AS rank
    FROM catalog_sales c
    JOIN SalesCTE s ON c.cs_item_sk = s.ws_item_sk
    GROUP BY c.cs_item_sk
)

SELECT
    i.i_item_id,
    i.i_item_desc,
    COALESCE(s.total_quantity, 0) AS total_sales_volume,
    COALESCE(s.total_sales, 0) AS total_sales_value,
    CASE
        WHEN s.rank = 1 THEN 'Top Seller'
        WHEN s.rank IS NULL THEN 'No Sales'
        ELSE 'Sold'
    END AS sales_status
FROM item i
LEFT JOIN SalesCTE s ON i.i_item_sk = s.ws_item_sk
WHERE (s.total_sales IS NOT NULL AND s.total_sales > 1000 OR s.total_sales IS NULL)
AND i.i_rec_start_date <= DATE '2002-10-01'
AND (i.i_rec_end_date IS NULL OR i.i_rec_end_date >= DATE '2002-10-01')
ORDER BY total_sales_value DESC, total_sales_volume DESC;
