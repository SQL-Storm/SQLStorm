
WITH ranked_sales AS (
    SELECT 
        ws.ws_order_number,
        ws.ws_item_sk,
        ws.ws_quantity,
        ws.ws_net_profit,
        ROW_NUMBER() OVER (PARTITION BY ws.ws_order_number ORDER BY ws.ws_net_profit DESC) AS rn,
        COALESCE(NULLIF(ws.ws_net_paid_inc_ship_tax, 0), NULL) AS adjusted_net_paid
    FROM web_sales ws
    WHERE ws.ws_ship_date_sk > 0
),

sales_summary AS (
    SELECT 
        rs.ws_order_number,
        SUM(rs.ws_quantity) AS total_quantity,
        SUM(rs.ws_net_profit) AS total_profit,
        MAX(COALESCE(rs.adjusted_net_paid, 0)) AS max_adjusted_paid
    FROM ranked_sales rs
    WHERE rs.rn = 1
    GROUP BY rs.ws_order_number
),

top_customers AS (
    SELECT 
        c.c_customer_id,
        SUM(ss.ss_net_profit) AS total_spent,
        COUNT(DISTINCT ss.ss_ticket_number) AS total_purchases
    FROM customer c
    JOIN store_sales ss ON c.c_customer_sk = ss.ss_customer_sk
    GROUP BY c.c_customer_id
    HAVING SUM(ss.ss_net_profit) > 1000
),

customer_address_ext AS (
    SELECT 
        ca.ca_address_sk, 
        ca.ca_city, 
        ca.ca_state,
        COALESCE(SUBSTRING_INDEX(ca.ca_street_name, ' ', 1), '') AS street_prefix,
        CASE 
            WHEN ca.ca_zip LIKE '12345%' THEN 'Local'
            WHEN ca.ca_zip IS NULL THEN 'Unknown'
            ELSE 'Remote'
        END AS address_type
    FROM customer_address ca
)

SELECT 
    c.c_customer_id AS customer_id,
    ca.ca_city AS city,
    ca.ca_state AS state,
    ss.total_quantity,
    ss.total_profit,
    ts.total_spent,
    ts.total_purchases,
    CASE 
        WHEN ts.total_spent IS NULL THEN 'No Purchases'
        WHEN ts.total_spent > 5000 THEN 'VIP Customer'
        ELSE 'Regular Customer'
    END AS customer_category,
    (SELECT COUNT(*) 
     FROM catalog_sales cs 
     WHERE cs.cs_bill_customer_sk = c.c_customer_sk 
     AND cs.cs_ship_mode_sk IN (SELECT sm.sm_ship_mode_sk FROM ship_mode sm WHERE sm.sm_type = 'Ship')) AS catalog_sales_count
FROM customer c
LEFT JOIN customer_address_ext ca ON c.c_current_addr_sk = ca.ca_address_sk
LEFT JOIN sales_summary ss ON ss.ws_order_number IN (SELECT ws.ws_order_number FROM web_sales ws WHERE ws.ws_bill_customer_sk = c.c_customer_sk)
LEFT JOIN top_customers ts ON ts.c_customer_id = c.c_customer_id
WHERE ca.address_type IS NOT NULL 
AND (ca.street_prefix IS NULL OR LENGTH(ca.street_prefix) > 0)
ORDER BY ss.total_profit DESC
LIMIT 10;
