
WITH RECURSIVE sales_hierarchy AS (
    SELECT c.c_customer_sk,
           SUM(ws.ws_ext_sales_price) AS total_sales,
           ROW_NUMBER() OVER (PARTITION BY c.c_customer_sk ORDER BY SUM(ws.ws_ext_sales_price) DESC) AS sales_rank
    FROM customer c
    JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
    GROUP BY c.c_customer_sk
), 
top_customers AS (
    SELECT c.c_first_name,
           c.c_last_name,
           sh.total_sales
    FROM customer c
    JOIN sales_hierarchy sh ON c.c_customer_sk = sh.c_customer_sk
    WHERE sh.sales_rank <= 5
),
daily_sales AS (
    SELECT d.d_date,
           SUM(ws.ws_ext_sales_price) AS daily_sales,
           d.d_day_name
    FROM date_dim d
    JOIN web_sales ws ON d.d_date_sk = ws.ws_sold_date_sk
    GROUP BY d.d_date, d.d_day_name
)
SELECT tc.c_first_name,
       tc.c_last_name,
       COALESCE(d.daily_sales, 0) AS sales_on_date,
       CASE WHEN d.d_day_name IN ('Saturday', 'Sunday') THEN 'Weekend' ELSE 'Weekday' END AS day_type,
       (SELECT COUNT(DISTINCT ws.ws_order_number)
        FROM web_sales ws
        WHERE ws.ws_bill_customer_sk = tc.c_customer_sk) AS total_orders
FROM top_customers tc
LEFT JOIN daily_sales d ON d.d_date = '2002-10-01'
ORDER BY tc.total_sales DESC, d.daily_sales DESC;
