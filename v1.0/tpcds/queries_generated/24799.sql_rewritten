WITH RECURSIVE CustomerReturns AS (
    SELECT
        wr.returning_customer_sk,
        wr.return_quantity,
        wr.returned_date_sk,
        wr.returned_time_sk,
        wr.return_amt,
        wr.return_tax,
        wr.return_amt_inc_tax,
        wr.return_fee,
        wr.return_ship_cost,
        wr.net_loss,
        ROW_NUMBER() OVER (PARTITION BY wr.returning_customer_sk ORDER BY wr.returned_date_sk DESC) AS rn
    FROM
        web_returns wr
    WHERE
        wr.return_quantity > 0
), 
CustomerDemographicsWithAddresses AS (
    SELECT 
        c.c_customer_sk,
        c.c_first_name,
        c.c_last_name,
        ca.ca_city,
        ca.ca_state,
        cd.cd_gender, 
        cd.cd_marital_status,
        cd.cd_purchase_estimate,
        CASE 
            WHEN cd.cd_marital_status IS NULL THEN 'Unknown Marital Status'
            ELSE cd.cd_marital_status
        END AS marital_status_handled
    FROM 
        customer c
    LEFT JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    LEFT JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
    WHERE 
        c.c_first_name IS NOT NULL 
        AND (cd.cd_gender = 'F' OR cd.cd_gender IS NULL)
), 
MonthlySales AS (
    SELECT
        d.d_year,
        d.d_month_seq,
        SUM(ws.ws_net_profit) AS total_net_profit,
        COUNT(DISTINCT ws.ws_order_number) AS total_orders
    FROM 
        date_dim d
    JOIN web_sales ws ON ws.ws_sold_date_sk = d.d_date_sk
    GROUP BY 
        d.d_year, d.d_month_seq
),
CustomerRankedReturns AS (
    SELECT 
        cr.returning_customer_sk,
        SUM(cr.return_quantity) AS total_returns,
        SUM(cr.return_amt_inc_tax) AS total_returned_amt,
        RANK() OVER (ORDER BY SUM(cr.return_quantity) DESC) AS return_rank
    FROM 
        CustomerReturns cr
    GROUP BY 
        cr.returning_customer_sk
)

SELECT
    civ.returning_customer_sk,
    civ.total_returns,
    civ.total_returned_amt,
    cd.c_first_name,
    cd.c_last_name,
    cd.ca_city,
    cd.ca_state,
    cd.marital_status_handled,
    ms.total_net_profit,
    ms.total_orders
FROM 
    CustomerRankedReturns civ
JOIN CustomerDemographicsWithAddresses cd ON cd.c_customer_sk = civ.returning_customer_sk
LEFT JOIN MonthlySales ms ON ms.d_year = EXTRACT(YEAR FROM cast('2002-10-01' as date)) AND ms.d_month_seq = EXTRACT(MONTH FROM cast('2002-10-01' as date))
WHERE 
    civ.total_returns > 10
    AND (cd.ca_state IS NOT NULL OR cd.ca_city IS NOT NULL)
    AND (cd.cd_purchase_estimate > 100 OR cd.cd_gender IS NULL)
ORDER BY 
    civ.total_returns DESC, 
    cd.c_last_name, 
    cd.c_first_name;