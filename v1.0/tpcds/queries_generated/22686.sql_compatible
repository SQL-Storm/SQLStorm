
WITH ranked_sales AS (
    SELECT 
        ws.web_site_sk,
        ws_quantity,
        ws_net_profit,
        RANK() OVER (PARTITION BY ws.web_site_sk ORDER BY ws_net_profit DESC) AS sales_rank
    FROM 
        web_sales ws
    WHERE 
        ws_sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_year = 2023)
),
customer_preferences AS (
    SELECT 
        c.c_customer_sk,
        SUM(CASE 
            WHEN cd_gender = 'M' AND cd_marital_status = 'M' THEN 1
            ELSE 0 
        END) AS male_married_count,
        SUM(CASE 
            WHEN cd_gender = 'F' AND cd_marital_status = 'S' THEN 1
            ELSE 0 
        END) AS female_single_count,
        COUNT(DISTINCT inv_warehouse_sk) AS warehouse_count,
        MAX(cd_purchase_estimate) AS max_purchase_estimate
    FROM 
        customer c
    LEFT JOIN 
        customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    LEFT JOIN 
        inventory i ON c.c_customer_sk = i.inv_item_sk 
    GROUP BY 
        c.c_customer_sk
)
SELECT 
    ca.ca_country,
    COALESCE(cp.male_married_count, 0) AS male_married,
    COALESCE(cp.female_single_count, 0) AS female_single,
    SUM(rs.ws_quantity) AS total_quantity,
    AVG(agg.players) AS avg_players
FROM 
    customer_address ca 
LEFT JOIN 
    customer_preferences cp ON ca.ca_address_sk = cp.c_customer_sk
LEFT JOIN 
    ranked_sales rs ON cp.c_customer_sk = rs.web_site_sk
LEFT JOIN 
    (SELECT COUNT(*) AS players, wp.web_page_sk FROM web_page wp GROUP BY wp.web_page_sk HAVING COUNT(wp.web_page_sk) > 1) agg 
ON 
    1 = 1
WHERE 
    ca.ca_state IN ('CA', 'NY') AND 
    (cp.max_purchase_estimate > 1000 OR cp.max_purchase_estimate IS NULL)
GROUP BY 
    ca.ca_country, cp.male_married_count, cp.female_single_count
HAVING 
    COUNT(DISTINCT rs.sales_rank) > 2
ORDER BY 
    total_quantity DESC, cp.max_purchase_estimate DESC NULLS LAST;
