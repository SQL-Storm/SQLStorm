
WITH sales_summary AS (
    SELECT 
        ws_sold_date_sk,
        ws_item_sk,
        SUM(ws_quantity) AS total_quantity,
        SUM(ws_sales_price) AS total_sales,
        SUM(ws_ext_discount_amt) AS total_discount
    FROM 
        web_sales
    GROUP BY 
        ws_sold_date_sk, ws_item_sk
),
top_items AS (
    SELECT 
        ss.ws_item_sk AS item_sk,
        SUM(ss.total_quantity) AS total_quantity_sold,
        SUM(ss.total_sales) AS total_sales_amount
    FROM 
        sales_summary ss
    JOIN 
        date_dim dd ON ss.ws_sold_date_sk = dd.d_date_sk
    WHERE 
        dd.d_year = 2023 AND dd.d_moy IN (11, 12) 
    GROUP BY 
        ss.ws_item_sk
    ORDER BY 
        total_sales_amount DESC
    LIMIT 10
),
item_details AS (
    SELECT 
        i.i_item_id,
        i.i_product_name,
        i.i_current_price,
        i.i_category,
        i.i_item_sk
    FROM 
        item i
    JOIN 
        top_items ti ON i.i_item_sk = ti.item_sk
)
SELECT 
    itd.i_item_id,
    itd.i_product_name,
    itd.i_current_price,
    ti.total_quantity_sold,
    ti.total_sales_amount,
    (ti.total_sales_amount - ws_discount.total_discount) AS net_revenue
FROM 
    item_details itd
JOIN 
    web_sales ws ON itd.i_item_sk = ws.ws_item_sk
JOIN 
    store s ON ws.ws_store_sk = s.s_store_sk
JOIN 
    (SELECT 
        ws_item_sk, 
        SUM(ws_ext_discount_amt) AS total_discount 
     FROM 
        web_sales 
     GROUP BY 
        ws_item_sk) ws_discount ON ws_discount.ws_item_sk = itd.i_item_sk
GROUP BY 
    itd.i_item_id, 
    itd.i_product_name, 
    itd.i_current_price, 
    ti.total_quantity_sold, 
    ti.total_sales_amount,
    ws_discount.total_discount
ORDER BY 
    net_revenue DESC;
