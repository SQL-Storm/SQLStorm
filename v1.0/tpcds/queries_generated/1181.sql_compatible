
WITH RankedSales AS (
    SELECT 
        ws.web_site_sk,
        ws.net_profit,
        ROW_NUMBER() OVER (PARTITION BY ws.web_site_sk ORDER BY ws.net_profit DESC) AS rank
    FROM web_sales ws
    WHERE ws.sold_date_sk >= (SELECT MAX(d_date_sk) - 30 FROM date_dim)
),
TotalSales AS (
    SELECT 
        ws.web_site_sk,
        SUM(ws.net_profit) AS total_sales_profit
    FROM web_sales ws
    JOIN date_dim dd ON ws.sold_date_sk = dd.d_date_sk
    GROUP BY ws.web_site_sk
)
SELECT 
    c.c_customer_id,
    ca.ca_city,
    SUM(ws.net_profit) AS total_net_profit,
    COUNT(DISTINCT ws.ws_order_number) AS total_orders,
    COALESCE(RS.rank, 0) AS profitability_rank,
    CASE 
        WHEN SUM(ws.net_profit) IS NULL THEN 'No Profit'
        WHEN SUM(ws.net_profit) > 1000 THEN 'High Profit'
        WHEN SUM(ws.net_profit) BETWEEN 500 AND 1000 THEN 'Medium Profit'
        ELSE 'Low Profit' 
    END AS profit_category
FROM customer c
JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
LEFT JOIN RankedSales RS ON ws.web_site_sk = RS.web_site_sk
JOIN TotalSales TS ON ws.web_site_sk = TS.web_site_sk
WHERE ca.ca_state = 'CA' 
  AND c.c_birth_year < 1990
  AND (c.c_preferred_cust_flag = 'Y' OR c.c_first_name LIKE 'J%')
GROUP BY c.c_customer_id, ca.ca_city, RS.rank
HAVING SUM(ws.net_profit) > 100
ORDER BY total_net_profit DESC;
