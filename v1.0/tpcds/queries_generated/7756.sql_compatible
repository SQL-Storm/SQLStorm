
WITH sales_data AS (
    SELECT 
        ws.web_site_id,
        ws.ws_net_paid,
        ws.ws_net_profit,
        c.c_first_name,
        c.c_last_name,
        d.d_year,
        d.d_month_seq,
        i.i_category,
        COUNT(ws.ws_order_number) AS total_orders,
        SUM(ws.ws_quantity) AS total_quantity,
        SUM(ws.ws_net_paid) AS total_revenue
    FROM
        web_sales ws
    JOIN 
        customer c ON ws.ws_bill_customer_sk = c.c_customer_sk
    JOIN 
        date_dim d ON ws.ws_sold_date_sk = d.d_date_sk
    JOIN 
        item i ON ws.ws_item_sk = i.i_item_sk
    WHERE 
        d.d_year = 2022 AND
        i.i_category = 'Electronics'
    GROUP BY 
        ws.web_site_id, 
        ws.ws_net_paid,
        ws.ws_net_profit,
        c.c_first_name, 
        c.c_last_name, 
        d.d_year, 
        d.d_month_seq, 
        i.i_category
),
average_sales AS (
    SELECT
        web_site_id,
        AVG(total_revenue) AS avg_revenue_per_order,
        AVG(total_profit) AS avg_profit_per_order
    FROM (
        SELECT 
            web_site_id,
            total_revenue,
            total_orders,
            (total_revenue / NULLIF(total_orders, 0)) AS total_profit
        FROM sales_data
    ) AS derived
    GROUP BY web_site_id
)
SELECT 
    web_site_id,
    avg_revenue_per_order,
    avg_profit_per_order
FROM 
    average_sales
ORDER BY 
    avg_revenue_per_order DESC
LIMIT 10;
