
WITH Ranked_Sales AS (
    SELECT 
        ws.web_site_sk, 
        ws.ws_order_number, 
        ws.ws_sales_price,
        ROW_NUMBER() OVER (PARTITION BY ws.web_site_sk ORDER BY ws.ws_sales_price DESC) AS rn
    FROM 
        web_sales AS ws
    WHERE 
        ws.ws_sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_year = 2023)
),
Flagged_Customers AS (
    SELECT 
        c.c_customer_sk,
        CASE 
            WHEN cd.cd_gender = 'M' THEN 'Male'
            WHEN cd.cd_gender = 'F' THEN 'Female'
            ELSE 'Unknown' 
        END AS gender_desc,
        SUM(COALESCE(sr.sr_return_quantity, 0)) AS total_returns,
        COUNT(DISTINCT ws.ws_order_number) AS total_orders
    FROM 
        customer AS c 
    LEFT JOIN 
        customer_demographics AS cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    LEFT JOIN 
        store_returns AS sr ON c.c_customer_sk = sr.sr_customer_sk
    LEFT JOIN 
        web_sales AS ws ON c.c_customer_sk = ws.ws_bill_customer_sk
    GROUP BY 
        c.c_customer_sk, gender_desc
),
Final_Report AS (
    SELECT 
        fc.c_customer_sk,
        fc.gender_desc,
        rc.ws_order_number,
        rc.ws_sales_price,
        CASE 
            WHEN fc.total_returns > 0 THEN 'Returned'
            ELSE 'No Return' 
        END AS return_status
    FROM 
        Flagged_Customers AS fc
    JOIN 
        Ranked_Sales AS rc ON fc.c_customer_sk = rc.web_site_sk
    WHERE 
        rc.rn <= 5
)
SELECT 
    fr.c_customer_sk,
    fr.gender_desc,
    fr.ws_order_number,
    fr.ws_sales_price,
    fr.return_status,
    COALESCE(SUBSTRING(i.i_item_desc FROM 1 FOR 20), 'N/A') AS item_description
FROM 
    Final_Report AS fr
LEFT JOIN 
    item AS i ON i.i_item_sk = (SELECT cs.cs_item_sk FROM catalog_sales AS cs WHERE cs.cs_order_number = fr.ws_order_number LIMIT 1)
WHERE 
    fr.return_status = 'No Return' 
ORDER BY 
    fr.gender_desc, fr.ws_sales_price DESC
FETCH FIRST 100 ROWS ONLY;
