
WITH RECURSIVE CustomerHierarchy AS (
    SELECT c_customer_sk, c_first_name, c_last_name, c_current_cdemo_sk
    FROM customer
    WHERE c_customer_sk = (SELECT MIN(c_customer_sk) FROM customer)
    UNION ALL
    SELECT c.c_customer_sk, c.c_first_name, c.c_last_name, c.c_current_cdemo_sk
    FROM customer c
    JOIN CustomerHierarchy ch ON ch.c_current_cdemo_sk = c.c_current_cdemo_sk
),
SalesSummary AS (
    SELECT ws_bill_customer_sk,
           SUM(ws_net_profit) AS total_profit,
           COUNT(ws_order_number) AS total_orders
    FROM web_sales
    GROUP BY ws_bill_customer_sk
),
HighValueCustomers AS (
    SELECT ch.c_customer_sk,
           ch.c_first_name,
           ch.c_last_name,
           COALESCE(ss.total_profit, 0) AS total_profit,
           COALESCE(ss.total_orders, 0) AS total_orders
    FROM CustomerHierarchy ch
    LEFT JOIN SalesSummary ss ON ch.c_customer_sk = ss.ws_bill_customer_sk
    WHERE COALESCE(ss.total_profit, 0) > 1000
)
SELECT hvc.c_customer_sk,
       hvc.c_first_name,
       hvc.c_last_name,
       hvc.total_profit,
       hvc.total_orders,
       da.ca_country
FROM HighValueCustomers hvc
LEFT JOIN customer_address da ON da.ca_address_sk = hvc.c_current_addr_sk
WHERE da.ca_country IS NOT NULL
AND UPPER(hvc.c_first_name) LIKE 'A%'
ORDER BY hvc.total_profit DESC
FETCH FIRST 10 ROWS ONLY;
