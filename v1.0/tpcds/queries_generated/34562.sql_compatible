
WITH RECURSIVE address_hierarchy AS (
    SELECT ca_address_sk, ca_address_id, ca_street_name, ca_city, ca_state, 1 AS level
    FROM customer_address
    WHERE ca_city = 'Los Angeles'

    UNION ALL

    SELECT ca.ca_address_sk, ca.ca_address_id, ca.ca_street_name, ca.ca_city, ca.ca_state, ah.level + 1
    FROM customer_address ca
    JOIN address_hierarchy ah ON ca.ca_address_sk = ah.ca_address_sk
    WHERE ca.ca_city <> ah.ca_city AND ah.level < 10
),
sales_summary AS (
    SELECT 
        ws.web_site_sk,
        SUM(ws.ws_sales_price) AS total_sales,
        COUNT(ws.ws_order_number) AS total_orders,
        AVG(ws.ws_net_profit) AS avg_profit
    FROM web_sales ws
    JOIN date_dim dd ON ws.ws_sold_date_sk = dd.d_date_sk
    WHERE dd.d_year = 2023
    GROUP BY ws.web_site_sk
),
demographics_summary AS (
    SELECT 
        cd.cd_demo_sk,
        COUNT(c.c_customer_sk) AS customer_count,
        AVG(cd.cd_purchase_estimate) AS avg_purchase_estimate
    FROM customer c
    LEFT JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    GROUP BY cd.cd_demo_sk
),
combined_sales AS (
    SELECT 
        ws.ws_item_sk,
        SUM(ws.ws_sales_price) AS total_sales_price,
        SUM(COALESCE(ws.ws_net_profit, 0)) AS total_profit
    FROM web_sales ws
    GROUP BY ws.ws_item_sk
)

SELECT 
    ca.ca_street_name,
    ca.ca_city,
    ss.web_site_sk,
    ss.total_sales,
    ss.total_orders,
    ds.customer_count,
    ds.avg_purchase_estimate,
    cs.total_sales_price,
    cs.total_profit
FROM address_hierarchy ca
LEFT JOIN sales_summary ss ON ca.ca_address_sk = ss.web_site_sk
LEFT JOIN demographics_summary ds ON ds.cd_demo_sk = ss.web_site_sk
LEFT JOIN combined_sales cs ON cs.ws_item_sk = ss.web_site_sk
WHERE (ds.customer_count > 100 OR ss.total_sales > 10000)
AND ss.total_orders IS NOT NULL
ORDER BY ca.ca_city ASC, ss.total_sales DESC;
