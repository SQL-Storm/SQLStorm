
WITH CustomerDetails AS (
    SELECT c.c_customer_sk,
           CONCAT(c.c_first_name, ' ', c.c_last_name) AS customer_full_name,
           cd.cd_gender,
           cd.cd_marital_status,
           cd.cd_education_status,
           ca.ca_city,
           ca.ca_state
    FROM customer c
    JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
),
AggregatedData AS (
    SELECT cd.ca_city,
           cd.ca_state,
           COUNT(c.c_customer_sk) AS customer_count,
           SUM(cd.cd_dep_count) AS total_dependents,
           AVG(cd.cd_purchase_estimate) AS avg_purchase_estimate,
           STRING_AGG(DISTINCT cd.cd_gender) AS genders
    FROM CustomerDetails cd
    GROUP BY cd.ca_city, cd.ca_state
)
SELECT ad.ca_city,
       ad.ca_state,
       ad.customer_count,
       ad.total_dependents,
       ad.avg_purchase_estimate,
       ad.genders,
       CONCAT(ad.ca_city, ', ', ad.ca_state) AS location,
       LENGTH(ad.genders) AS number_of_genders
FROM AggregatedData ad
ORDER BY ad.customer_count DESC, ad.ca_city;
