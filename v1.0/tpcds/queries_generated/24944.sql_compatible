
WITH RankedPromotions AS (
    SELECT 
        p.p_promo_sk,
        p.p_promo_name,
        ROW_NUMBER() OVER (PARTITION BY p.p_promo_sk ORDER BY p.p_cost DESC) AS promo_rank
    FROM 
        promotion p
    WHERE 
        p.p_discount_active = 'Y'
), 
CustomerReturns AS (
    SELECT 
        c.c_customer_sk,
        COUNT(DISTINCT CASE WHEN wr.wr_return_amt IS NOT NULL THEN 1 END) AS web_returns,
        COUNT(DISTINCT CASE WHEN sr.sr_returned_date_sk IS NOT NULL THEN 1 END) AS store_returns
    FROM 
        customer c
    LEFT JOIN 
        web_returns wr ON c.c_customer_sk = wr.wr_returning_customer_sk
    LEFT JOIN 
        store_returns sr ON c.c_customer_sk = sr.sr_customer_sk
    GROUP BY 
        c.c_customer_sk
),
SalesSummary AS (
    SELECT 
        ws.ws_bill_customer_sk,
        SUM(ws.ws_net_profit) AS total_net_profit,
        COUNT(ws.ws_order_number) AS total_orders,
        MAX(ws.ws_ship_date_sk) AS last_order_date
    FROM 
        web_sales ws
    GROUP BY 
        ws.ws_bill_customer_sk
)
SELECT 
    ca.ca_city AS location,
    COUNT(DISTINCT CASE WHEN cd.cd_marital_status = 'M' THEN c.c_customer_sk END) AS married_customers,
    SUM(ss.total_net_profit) AS total_web_sales_profit,
    AVG(cs.cs_sales_price) AS average_catalog_sales_price,
    (SELECT COUNT(*) FROM RankedPromotions WHERE promo_rank = 1) AS active_promotion_count,
    COALESCE((SELECT COUNT(*) FROM CustomerReturns WHERE web_returns > 0), 0) AS total_active_web_returning_customers,
    CASE 
        WHEN (SELECT COUNT(*) FROM CustomerReturns) = 0 THEN NULL 
        ELSE MAX(cr.returned_date_sk) END AS last_return_record
FROM 
    customer c
LEFT JOIN 
    customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
LEFT JOIN 
    store s ON c.c_current_addr_sk = s.s_store_sk 
LEFT JOIN 
    SalesSummary ss ON c.c_customer_sk = ss.ws_bill_customer_sk
LEFT JOIN 
    catalog_sales cs ON c.c_customer_sk = cs.cs_bill_customer_sk
LEFT JOIN 
    warehouse w ON w.w_warehouse_sk = cs.cs_warehouse_sk
LEFT JOIN 
    (SELECT sm.sm_ship_mode_sk, COUNT(DISTINCT sm.sm_type) AS shipping_modes FROM ship_mode sm GROUP BY sm.sm_ship_mode_sk) shipping_modes ON shipping_modes.sm_ship_mode_sk IS NOT NULL
WHERE 
    ca.ca_country IS NOT NULL
GROUP BY 
    ca.ca_city, c.c_customer_sk, cd.cd_marital_status, ss.total_net_profit, cs.cs_sales_price
HAVING 
    SUM(ss.total_orders) > 10
ORDER BY 
    total_web_sales_profit DESC
LIMIT 100 OFFSET 0;
