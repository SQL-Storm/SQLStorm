
WITH RECURSIVE annual_sales AS (
    SELECT 
        dd.d_year AS year,
        SUM(ws.ws_ext_sales_price) AS total_sales
    FROM 
        date_dim dd
    JOIN 
        web_sales ws ON dd.d_date_sk = ws.ws_sold_date_sk
    GROUP BY 
        dd.d_year
    UNION ALL
    SELECT 
        year - 1 AS year,
        SUM(ws.ws_ext_sales_price) AS total_sales
    FROM 
        date_dim dd
    JOIN 
        web_sales ws ON dd.d_date_sk = ws.ws_sold_date_sk
    JOIN 
        annual_sales prev ON prev.year = dd.d_year + 1
    GROUP BY 
        year
),
popular_items AS (
    SELECT 
        i.i_item_id,
        COUNT(cs.cs_order_number) AS purchase_count
    FROM 
        item i 
    JOIN 
        catalog_sales cs ON i.i_item_sk = cs.cs_item_sk
    GROUP BY 
        i.i_item_id
),
high_sales_customers AS (
    SELECT 
        c.c_customer_id,
        SUM(ws.ws_net_paid) AS total_spent
    FROM 
        customer c
    JOIN 
        web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
    GROUP BY 
        c.c_customer_id
    HAVING 
        total_spent > (
            SELECT 
                AVG(total_spent) 
            FROM 
                (SELECT 
                    SUM(ws2.ws_net_paid) AS total_spent
                FROM 
                    customer c2 
                JOIN 
                    web_sales ws2 ON c2.c_customer_sk = ws2.ws_bill_customer_sk
                GROUP BY 
                    c2.c_customer_id) AS avg_spending
        )
)
SELECT 
    a.year,
    a.total_sales,
    pi.i_item_id,
    pi.purchase_count,
    hc.c_customer_id,
    hc.total_spent
FROM 
    annual_sales a
LEFT JOIN 
    popular_items pi ON pi.purchase_count = (
        SELECT 
            MAX(purchase_count) 
            FROM 
                popular_items
    )
LEFT JOIN 
    high_sales_customers hc ON hc.total_spent = (
        SELECT 
            MAX(total_spent)
            FROM 
                high_sales_customers
    )
JOIN 
    date_dim dd ON dd.d_year = a.year
WHERE 
    dd.d_holiday = 'Y'
ORDER BY 
    a.year DESC, 
    hc.total_spent DESC;
