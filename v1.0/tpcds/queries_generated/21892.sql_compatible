
WITH RECURSIVE CustomerHierarchy AS (
    SELECT c.c_customer_sk, c.c_customer_id, c.c_current_cdemo_sk, c.c_first_name, c.c_last_name, 1 AS level
    FROM customer c
    WHERE c.c_preferred_cust_flag = 'Y'
    UNION ALL
    SELECT c.c_customer_sk, c.c_customer_id, c.c_current_cdemo_sk, c.c_first_name, c.c_last_name, ch.level + 1
    FROM customer c
    JOIN CustomerHierarchy ch ON c.c_current_cdemo_sk = ch.c_current_cdemo_sk
    WHERE ch.level < 5
),
TotalSales AS (
    SELECT ws.ws_bill_customer_sk, SUM(ws.ws_net_profit) AS total_profit
    FROM web_sales ws
    GROUP BY ws.ws_bill_customer_sk
),
ItemStatistics AS (
    SELECT i.i_item_sk, 
           COUNT(DISTINCT ws.ws_order_number) AS order_count,
           AVG(ws.ws_ext_sales_price) AS avg_price,
           SUM(ws.ws_net_profit) AS total_net_profit
    FROM item i
    LEFT JOIN web_sales ws ON i.i_item_sk = ws.ws_item_sk
    GROUP BY i.i_item_sk
),
HighValueItems AS (
    SELECT i.i_item_sk, i.i_item_id
    FROM ItemStatistics i
    WHERE i.total_net_profit > (
        SELECT AVG(total_net_profit)
        FROM ItemStatistics
    )
),
RecentReturns AS (
    SELECT sr.sr_refunded_customer_sk, COUNT(*) AS return_count
    FROM store_returns sr
    WHERE sr.sr_returned_date_sk > (
        SELECT MAX(d.d_date_sk) - 30
        FROM date_dim d
    )
    GROUP BY sr.sr_refunded_customer_sk
),
FinalReport AS (
    SELECT ch.c_customer_id, 
           ch.c_first_name, 
           ch.c_last_name, 
           COALESCE(ts.total_profit, 0) AS customer_profit,
           COUNT(DISTINCT hi.i_item_id) AS high_value_item_count,
           COALESCE(rr.return_count, 0) AS recent_return_count
    FROM CustomerHierarchy ch
    LEFT JOIN TotalSales ts ON ch.c_customer_sk = ts.ws_bill_customer_sk
    LEFT JOIN HighValueItems hi ON hi.i_item_sk IN (
        SELECT ws.ws_item_sk 
        FROM web_sales ws 
        WHERE ws.ws_bill_customer_sk = ch.c_customer_sk
    )
    LEFT JOIN RecentReturns rr ON rr.sr_refunded_customer_sk = ch.c_customer_sk
    GROUP BY ch.c_customer_id, ch.c_first_name, ch.c_last_name, ts.total_profit, rr.return_count
)
SELECT * 
FROM FinalReport
WHERE customer_profit > 500
ORDER BY customer_profit DESC, high_value_item_count DESC, recent_return_count ASC
FETCH FIRST 50 ROWS ONLY;
