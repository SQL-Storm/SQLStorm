
WITH RankedSales AS (
    SELECT 
        ws.web_site_sk,
        SUM(ws.ws_sales_price) AS total_sales,
        COUNT(ws.ws_order_number) AS order_count,
        ROW_NUMBER() OVER (PARTITION BY ws.web_site_sk ORDER BY SUM(ws.ws_sales_price) DESC) AS rank
    FROM web_sales ws
    JOIN customer_address ca ON ws.ws_ship_addr_sk = ca.ca_address_sk
    WHERE ca.ca_country = 'United States'
    GROUP BY ws.web_site_sk
),
FilteredSales AS (
    SELECT 
        rs.web_site_sk,
        rs.total_sales,
        rs.order_count
    FROM RankedSales rs
    WHERE rs.rank <= 3
),
TotalOrders AS (
    SELECT 
        SUM(order_count) AS total_order_count
    FROM FilteredSales
),
RevenueStats AS (
    SELECT 
        fs.web_site_sk,
        fs.total_sales,
        fs.order_count,
        (fs.total_sales / NULLIF(to.total_order_count, 0)) AS avg_sales_per_order
    FROM FilteredSales fs
    CROSS JOIN TotalOrders to
)
SELECT 
    ws.web_site_id,
    CONCAT('Total Sales: ', CAST(rs.total_sales AS VARCHAR), 
           ', Order Count: ', CAST(rs.order_count AS VARCHAR), 
           ', Avg Sales/Order: ', CAST(rs.avg_sales_per_order AS VARCHAR)) AS sales_summary
FROM RevenueStats rs
JOIN web_site ws ON rs.web_site_sk = ws.web_site_sk
WHERE rs.total_sales > (
        SELECT AVG(total_sales) 
        FROM RevenueStats
        WHERE avg_sales_per_order IS NOT NULL
    )
ORDER BY rs.total_sales DESC
FETCH FIRST 5 ROWS ONLY;
