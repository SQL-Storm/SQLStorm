
WITH SalesData AS (
    SELECT 
        ss_customer_sk,
        ss_item_sk,
        SUM(ss_quantity) AS total_quantity,
        SUM(ss_net_profit) AS total_profit,
        ROW_NUMBER() OVER (PARTITION BY ss_customer_sk ORDER BY SUM(ss_net_profit) DESC) AS rn
    FROM 
        store_sales
    WHERE 
        ss_sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_year = 2023 AND d_month_seq BETWEEN 1 AND 3)
    GROUP BY 
        ss_customer_sk, ss_item_sk
),
TopProfitableSales AS (
    SELECT 
        sd.ss_customer_sk,
        sd.ss_item_sk,
        sd.total_quantity,
        sd.total_profit
    FROM 
        SalesData sd
    WHERE 
        sd.rn <= 5
),
CustomerDetails AS (
    SELECT 
        c.c_customer_sk,
        c.c_first_name,
        c.c_last_name,
        cd.cd_gender,
        cd.cd_marital_status,
        COALESCE(hd.hd_income_band_sk, -1) AS income_band,
        COUNT(DISTINCT c.c_customer_id) OVER (PARTITION BY c.c_customer_sk) AS unique_visits
    FROM 
        customer c
        LEFT JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
        LEFT JOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk
)
SELECT 
    cd.c_customer_sk,
    cd.c_first_name,
    cd.c_last_name,
    cd.cd_gender,
    cd.cd_marital_status,
    COALESCE(CASE WHEN cd.income_band = -1 THEN 'Unknown' ELSE CAST(cd.income_band AS CHAR) END, 'Not Specified') AS income_band,
    SUM(tp.total_quantity) AS total_items_sold,
    SUM(tp.total_profit) AS total_profit_earned,
    COUNT(DISTINCT tp.ss_item_sk) AS distinct_items_sold
FROM 
    TopProfitableSales tp
JOIN 
    CustomerDetails cd ON tp.ss_customer_sk = cd.c_customer_sk
GROUP BY 
    cd.c_customer_sk, cd.c_first_name, cd.c_last_name, cd.cd_gender, cd.cd_marital_status, cd.income_band
HAVING 
    SUM(tp.total_profit) > 10000
ORDER BY 
    total_profit_earned DESC, total_items_sold ASC
LIMIT 10;
