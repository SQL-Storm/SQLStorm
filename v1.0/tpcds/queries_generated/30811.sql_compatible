
WITH RECURSIVE daily_sales AS (
    SELECT
        d.d_date,
        SUM(ws.ws_ext_sales_price) AS total_sales,
        SUM(ws.ws_quantity) AS total_quantity,
        ROW_NUMBER() OVER (PARTITION BY d.d_date ORDER BY SUM(ws.ws_ext_sales_price) DESC) AS rank
    FROM
        date_dim d
        LEFT JOIN web_sales ws ON d.d_date_sk = ws.ws_sold_date_sk
    GROUP BY
        d.d_date
),
top_customers AS (
    SELECT
        c.c_customer_id,
        SUM(ws.ws_net_paid) AS total_spent
    FROM
        customer c
        JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
    GROUP BY
        c.c_customer_id
    HAVING
        SUM(ws.ws_net_paid) > 500
),
customer_demographics_with_income AS (
    SELECT
        cd.cd_gender,
        cd.cd_marital_status,
        ib.ib_lower_bound,
        ib.ib_upper_bound,
        COUNT(DISTINCT c.c_customer_sk) AS customer_count
    FROM
        customer c
        JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
        LEFT JOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk
        LEFT JOIN income_band ib ON hd.hd_income_band_sk = ib.ib_income_band_sk
    GROUP BY
        cd.cd_gender, cd.cd_marital_status, ib.ib_lower_bound, ib.ib_upper_bound
)
SELECT
    d.d_date,
    ds.total_sales,
    ds.total_quantity,
    cn.c_customer_id,
    cn.total_spent,
    cdwi.cd_gender,
    cdwi.cd_marital_status,
    cdwi.ib_lower_bound,
    cdwi.ib_upper_bound,
    cdwi.customer_count
FROM
    daily_sales ds
    JOIN date_dim d ON ds.d_date = d.d_date
    FULL OUTER JOIN top_customers cn ON cn.total_spent > 500
    FULL OUTER JOIN customer_demographics_with_income cdwi ON TRUE
WHERE
    d.d_date >= DATE '2023-01-01' AND d.d_date <= DATE '2023-12-31'
ORDER BY
    ds.total_sales DESC, cn.total_spent DESC
FETCH FIRST 100 ROWS ONLY;
