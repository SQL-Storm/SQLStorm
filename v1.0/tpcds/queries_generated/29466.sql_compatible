
WITH processed_addresses AS (
    SELECT 
        ca_address_sk,
        TRIM(CONCAT(ca_street_number, ' ', ca_street_name, ' ', ca_street_type)) AS full_address,
        LOWER(ca_city) AS city_lower,
        UPPER(ca_state) AS state_upper,
        CONCAT(ca_zip, ', ', ca_country) AS zip_country
    FROM customer_address
), customer_info AS (
    SELECT 
        c.c_customer_sk,
        CONCAT(c.c_first_name, ' ', c.c_last_name) AS full_name,
        cd.cd_gender,
        cd.cd_marital_status,
        cd.cd_education_status,
        cd.cd_purchase_estimate,
        d.d_date AS birth_date,
        hd.hd_income_band_sk,
        hd.hd_buy_potential
    FROM customer c
    JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    JOIN household_demographics hd ON c.c_customer_sk = hd.hd_demo_sk
    JOIN date_dim d ON c.c_birth_day = d.d_dom AND c.c_birth_month = d.d_moy AND c.c_birth_year = d.d_year
), sales_info AS (
    SELECT 
        ws_bill_customer_sk,
        SUM(ws_net_profit) AS total_net_profit
    FROM web_sales
    GROUP BY ws_bill_customer_sk
)
SELECT 
    ca.full_address,
    ci.full_name,
    ci.cd_gender,
    ci.cd_marital_status,
    ci.cd_education_status,
    ci.cd_purchase_estimate,
    ci.hd_income_band_sk,
    COALESCE(si.total_net_profit, 0) AS total_net_profit,
    COUNT(wp.web_site_id) AS web_visit_count
FROM processed_addresses ca
JOIN customer_info ci ON ca.ca_address_sk = ci.c_customer_sk
LEFT JOIN sales_info si ON ci.c_customer_sk = si.ws_bill_customer_sk
JOIN web_page wp ON wp.wp_customer_sk = ci.c_customer_sk
GROUP BY 
    ca.full_address, 
    ci.full_name, 
    ci.cd_gender, 
    ci.cd_marital_status, 
    ci.cd_education_status, 
    ci.cd_purchase_estimate, 
    ci.hd_income_band_sk
ORDER BY total_net_profit DESC
LIMIT 100;
