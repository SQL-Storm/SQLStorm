
WITH AddressInfo AS (
    SELECT 
        ca_address_sk,
        TRIM(ca_street_number) || ' ' || TRIM(ca_street_name) || ' ' || TRIM(ca_street_type) AS full_address,
        TRIM(ca_city) AS city,
        TRIM(ca_state) AS state,
        TRIM(ca_country) AS country,
        LENGTH(TRIM(ca_street_name)) AS street_name_length
    FROM 
        customer_address 
    WHERE 
        ca_city IS NOT NULL AND ca_state IS NOT NULL
),
CustomerPurchases AS (
    SELECT 
        c.c_customer_sk,
        SUM(COALESCE(ws.ws_ext_sales_price, 0)) AS total_spent,
        COUNT(DISTINCT ws.ws_order_number) AS total_orders
    FROM 
        customer c
        LEFT JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
    GROUP BY 
        c.c_customer_sk
),
Demographics AS (
    SELECT 
        cd.cd_demo_sk,
        cd.cd_gender,
        cd.cd_marital_status,
        cd.cd_education_status,
        ci.city,
        ci.state,
        ci.country,
        ci.full_address,
        cp.total_spent,
        cp.total_orders,
        c.c_customer_sk
    FROM 
        customer_demographics cd
        JOIN CustomerPurchases cp ON cd.cd_demo_sk = cp.c_customer_sk
        JOIN customer c ON cd.cd_demo_sk = c.c_current_cdemo_sk
        JOIN AddressInfo ci ON c.c_current_addr_sk = ci.ca_address_sk
)
SELECT 
    d.cd_gender,
    d.cd_marital_status,
    d.cd_education_status,
    COUNT(d.c_customer_sk) AS customer_count,
    AVG(d.total_spent) AS avg_spent,
    MAX(d.total_orders) AS max_orders,
    MIN(d.street_name_length) AS min_street_name_length,
    COUNT(DISTINCT d.city) AS unique_cities
FROM 
    Demographics d
GROUP BY 
    d.cd_gender, d.cd_marital_status, d.cd_education_status
ORDER BY 
    customer_count DESC;
