WITH RECURSIVE OrderHierarchy AS (
    SELECT 
        ws_item_sk, 
        ws_order_number, 
        ws_sales_price, 
        ws_ship_date_sk, 
        ROW_NUMBER() OVER (PARTITION BY ws_item_sk ORDER BY ws_order_number) AS rn
    FROM 
        web_sales
    WHERE 
        ws_ship_date_sk >= (SELECT d_date_sk FROM date_dim WHERE d_date = cast('2002-10-01' as date) - INTERVAL '1 year')
),
SalesData AS (
    SELECT 
        c.c_customer_id, 
        SUM(ws_sales_price) AS total_sales_price,
        COUNT(ws_order_number) AS order_count,
        AVG(ws_sales_price) AS avg_sales_price
    FROM 
        web_sales ws
    JOIN 
        customer c ON ws.ws_ship_customer_sk = c.c_customer_sk
    GROUP BY 
        c.c_customer_id
),
TopCustomers AS (
    SELECT 
        c.c_customer_id, 
        sd.total_sales_price, 
        sd.order_count, 
        sd.avg_sales_price
    FROM 
        SalesData sd
    JOIN 
        customer c ON sd.c_customer_id = c.c_customer_id
    WHERE 
        sd.total_sales_price = (SELECT MAX(total_sales_price) FROM SalesData)
)
SELECT 
    o.ws_order_number,
    o.ws_item_sk,
    o.ws_sales_price,
    th.c_customer_id,
    th.total_sales_price,
    th.order_count
FROM 
    OrderHierarchy o
LEFT JOIN 
    TopCustomers th ON o.ws_item_sk = th.c_customer_id
WHERE 
    o.rn <= 5
ORDER BY 
    o.ws_order_number DESC;