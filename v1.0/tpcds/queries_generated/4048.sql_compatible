
WITH SalesData AS (
    SELECT 
        ws.ws_item_sk,
        ws.ws_order_number,
        ws.ws_ext_sales_price,
        ws.ws_ext_discount_amt,
        ws.ws_net_paid,
        wd.w_web_page_id,
        It.i_item_desc,
        COUNT(ws.ws_order_number) OVER (PARTITION BY ws.ws_item_sk) AS order_count
    FROM 
        web_sales ws
    JOIN 
        web_page wd ON ws.ws_web_page_sk = wd.wp_web_page_sk
    JOIN 
        item It ON ws.ws_item_sk = It.i_item_sk
    WHERE 
        ws.ws_sold_date_sk >= (SELECT MAX(d_date_sk) FROM date_dim WHERE d_year = 2023)
        AND It.i_item_desc IS NOT NULL
),
Summary AS (
    SELECT 
        wd.w_web_page_id,
        SUM(sd.ws_ext_sales_price) AS total_sales,
        SUM(sd.ws_ext_discount_amt) AS total_discount,
        AVG(sd.ws_net_paid) AS average_net_paid,
        MAX(sd.order_count) AS max_orders_per_item
    FROM 
        SalesData sd
    LEFT JOIN 
        web_page wd ON sd.w_web_page_id = wd.wp_web_page_id
    GROUP BY 
        wd.w_web_page_id
)
SELECT 
    sw.w_web_page_id,
    sw.total_sales,
    sw.total_discount,
    sw.average_net_paid,
    CASE 
        WHEN sw.max_orders_per_item IS NULL THEN 'No sales'
        ELSE CAST(sw.max_orders_per_item AS VARCHAR) 
    END AS max_orders
FROM 
    Summary sw
WHERE 
    sw.total_sales > 1000
ORDER BY 
    sw.total_sales DESC
LIMIT 10 OFFSET 5;
