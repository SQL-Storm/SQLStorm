
WITH CustomerStats AS (
    SELECT 
        C.c_customer_id,
        CD.cd_gender,
        SUM(WS.ws_ext_sales_price) AS total_sales,
        COUNT(DISTINCT WS.ws_order_number) AS order_count,
        COUNT(DISTINCT WS.ws_ship_date_sk) AS shipping_days
    FROM 
        customer C
    JOIN 
        customer_demographics CD ON C.c_current_cdemo_sk = CD.cd_demo_sk
    JOIN 
        web_sales WS ON C.c_customer_sk = WS.ws_bill_customer_sk
    WHERE 
        CD.cd_marital_status = 'M' 
        AND CD.cd_income_band_sk IN (
            SELECT ib_income_band_sk 
            FROM income_band 
            WHERE ib_lower_bound >= 50000 AND ib_upper_bound < 100000
        )
    GROUP BY 
        C.c_customer_id, CD.cd_gender
),
SalesByCity AS (
    SELECT 
        CA.ca_city,
        SUM(CS.total_sales) AS city_sales
    FROM 
        CustomerStats CS
    JOIN 
        customer_address CA ON CA.ca_address_sk = CS.c_current_addr_sk
    GROUP BY 
        CA.ca_city
),
TopCities AS (
    SELECT 
        ca_city,
        city_sales,
        ROW_NUMBER() OVER (ORDER BY city_sales DESC) AS city_rank
    FROM 
        SalesByCity
)
SELECT 
    TC.ca_city,
    TC.city_sales,
    C.cd_gender
FROM 
    TopCities TC
JOIN 
    CustomerStats C ON C.total_sales > (
        SELECT AVG(total_sales) 
        FROM CustomerStats
    )
WHERE 
    TC.city_rank <= 10
ORDER BY 
    TC.city_sales DESC, C.cd_gender;
