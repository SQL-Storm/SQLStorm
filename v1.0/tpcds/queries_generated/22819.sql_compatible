
WITH RECURSIVE sales_cte AS (
    SELECT 
        ws_sold_date_sk, 
        ws_item_sk,
        COUNT(ws_order_number) AS order_count,
        SUM(ws_sales_price) AS total_sales,
        DENSE_RANK() OVER (PARTITION BY ws_item_sk ORDER BY SUM(ws_sales_price) DESC) AS sales_rank
    FROM 
        web_sales
    WHERE 
        ws_sold_date_sk BETWEEN 1 AND 10000
    GROUP BY 
        ws_sold_date_sk, ws_item_sk
),
customer_info AS (
    SELECT 
        c_customer_sk,
        COALESCE(cd_marital_status, 'Unknown') AS marital_status,
        cd_gender,
        COUNT(DISTINCT c_customer_sk) OVER (PARTITION BY cd_gender) AS gender_count
    FROM 
        customer
    JOIN 
        customer_demographics ON c_current_cdemo_sk = cd_demo_sk
),
high_value_customers AS (
    SELECT 
        ci.c_customer_sk,
        SUM(s.total_sales) AS total_spent,
        MAX(s.order_count) AS max_orders
    FROM 
        customer_info ci
    LEFT JOIN 
        sales_cte s ON ci.c_customer_sk = s.ws_item_sk
    GROUP BY 
        ci.c_customer_sk
    HAVING 
        SUM(s.total_sales) > 10000 OR MAX(s.order_count) > 50
),
recent_sales AS (
    SELECT 
        ss.ss_item_sk,
        SUM(ss.ss_net_profit) AS total_profit,
        COUNT(ss.ss_ticket_number) AS total_transactions
    FROM 
        store_sales ss
    JOIN 
        store s ON ss.ss_store_sk = s.s_store_sk
    WHERE 
        s.s_state IN ('CA', 'NY') AND
        ss.ss_sold_date_sk IN (SELECT DISTINCT ws_sold_date_sk FROM web_sales WHERE ws_sold_date_sk < 10000)
    GROUP BY 
        ss.ss_item_sk
)
SELECT 
    COALESCE(hi.c_customer_sk, 'No Customer') AS customer_sk,
    hi.total_spent,
    hi.max_orders,
    rs.total_profit,
    rs.total_transactions,
    CASE 
        WHEN hi.total_spent > 5000 THEN 'Gold' 
        WHEN hi.total_spent > 2500 THEN 'Silver' 
        ELSE 'Bronze' 
    END AS customer_tier
FROM 
    high_value_customers hi
FULL OUTER JOIN 
    recent_sales rs ON hi.c_customer_sk = rs.ss_item_sk
WHERE 
    (hi.total_spent IS NOT NULL OR rs.total_profit IS NOT NULL) AND
    (hi.total_spent < 20000 OR rs.total_transactions < 10)
ORDER BY 
    COALESCE(hi.total_spent, 0) DESC, 
    COALESCE(rs.total_profit, 0) DESC;
