WITH CustomerReturns AS (
    SELECT 
        c.c_customer_id,
        SUM(sr_return_amount) AS total_returned,
        COUNT(sr_ticket_number) AS return_count
    FROM 
        customer AS c
    JOIN 
        store_returns AS sr ON c.c_customer_sk = sr.sr_customer_sk
    GROUP BY 
        c.c_customer_id
),
HighReturnCustomers AS (
    SELECT 
        cr.c_customer_id,
        cr.total_returned,
        cr.return_count,
        DENSE_RANK() OVER (ORDER BY cr.total_returned DESC) AS return_rank
    FROM 
        CustomerReturns AS cr
    WHERE 
        cr.return_count > 1
),
PromotionsApplied AS (
    SELECT 
        ws.ws_order_number,
        SUM(ws.ws_ext_discount_amt) AS total_discount
    FROM 
        web_sales AS ws
    WHERE 
        ws.ws_ship_date_sk BETWEEN 24000 AND 24500 
    GROUP BY 
        ws.ws_order_number
),
TopPromos AS (
    SELECT 
        p.p_promo_id,
        COUNT(DISTINCT ws.ws_order_number) AS promo_usage_count
    FROM 
        promotion AS p
    JOIN 
        web_sales AS ws ON p.p_promo_sk = ws.ws_promo_sk
    GROUP BY 
        p.p_promo_id
    ORDER BY 
        promo_usage_count DESC
    LIMIT 5
)

SELECT 
    c.c_customer_id,
    COALESCE(cr.total_returned, 0) AS total_returned,
    CASE 
        WHEN cr.return_count IS NOT NULL THEN cr.return_count
        ELSE 0
    END AS return_count,
    tp.promo_id,
    tp.promo_usage_count
FROM 
    customer AS c
LEFT JOIN 
    HighReturnCustomers AS cr ON c.c_customer_id = cr.c_customer_id
JOIN 
    TopPromos AS tp ON tp.promo_id IS NOT NULL
WHERE 
    c.c_current_cdemo_sk IN (
        SELECT cd_demo_sk 
        FROM customer_demographics 
        WHERE cd_credit_rating = 'Bad'
    )
ORDER BY 
    cr.total_returned DESC NULLS LAST, 
    tp.promo_usage_count DESC;