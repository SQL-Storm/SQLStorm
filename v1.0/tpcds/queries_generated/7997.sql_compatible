
WITH sales_data AS (
    SELECT ws.ws_item_sk, 
           SUM(ws.ws_quantity) AS total_quantity, 
           SUM(ws.ws_ext_sales_price) AS total_sales,
           SUM(ws.ws_ext_discount_amt) AS total_discount,
           d.d_year AS sales_year,
           d.d_month AS sales_month
    FROM web_sales ws
    JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk
    WHERE d.d_year >= 2020
    GROUP BY ws.ws_item_sk, d.d_year, d.d_month
),
customer_info AS (
    SELECT c.c_customer_sk,
           cd.cd_gender,
           cd.cd_marital_status,
           cd.cd_education_status,
           SUM(sd.total_sales) AS total_purchases
    FROM sales_data sd
    JOIN customer c ON sd.ws_item_sk = c.c_customer_sk
    JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    GROUP BY c.c_customer_sk, cd.cd_gender, cd.cd_marital_status, cd.cd_education_status
),
average_sales AS (
    SELECT cd.gender, 
           cd.marital_status, 
           cd.education_status, 
           AVG(ci.total_purchases) AS avg_purchases
    FROM customer_info ci
    JOIN (SELECT DISTINCT cd.cd_gender AS gender, 
                 cd.cd_marital_status AS marital_status, 
                 cd.cd_education_status AS education_status 
          FROM customer_demographics cd) cd ON ci.cd_gender = cd.gender
    GROUP BY cd.gender, cd.marital_status, cd.education_status
)
SELECT gender, 
       marital_status, 
       education_status, 
       avg_purchases
FROM average_sales
ORDER BY avg_purchases DESC
LIMIT 10;
