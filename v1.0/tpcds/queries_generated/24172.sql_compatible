
WITH RecursiveCustomerCTE AS (
    SELECT c.c_customer_sk, c.c_customer_id, c.c_first_name, c.c_last_name,
           CASE 
               WHEN cd.cd_gender = 'F' THEN 'Female'
               WHEN cd.cd_gender = 'M' THEN 'Male'
               ELSE 'Other'
           END AS gender,
           CA.ca_city,
           ROW_NUMBER() OVER (PARTITION BY CA.ca_state ORDER BY c.c_last_name) AS city_rank,
           c.c_birth_year
    FROM customer c
    LEFT JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    JOIN customer_address CA ON c.c_current_addr_sk = CA.ca_address_sk
    WHERE c.c_birth_year IS NOT NULL
      AND c.c_birth_month BETWEEN 1 AND 12
), FilteredCustomers AS (
    SELECT *,
           (CASE 
                WHEN year_diff BETWEEN 18 AND 25 THEN 'Youth'
                WHEN year_diff BETWEEN 26 AND 35 THEN 'Young Adult'
                WHEN year_diff BETWEEN 36 AND 50 THEN 'Adult'
                ELSE 'Senior'
           END) AS age_group
    FROM RecursiveCustomerCTE
    CROSS JOIN (SELECT EXTRACT(YEAR FROM DATE '2002-10-01') - c_birth_year AS year_diff 
                FROM customer) AS age_diff_subquery
    WHERE year_diff >= 0
), SalesAggregation AS (
    SELECT c.c_customer_sk,
           SUM(CASE 
                   WHEN ss.ss_quantity > 0 THEN ss.ss_net_paid
                   ELSE 0
               END) AS total_spent,
           COUNT(ss.ss_ticket_number) AS purchase_count
    FROM store_sales ss
    JOIN FilteredCustomers c ON ss.ss_customer_sk = c.c_customer_sk
    GROUP BY c.c_customer_sk
)
SELECT fc.c_customer_id, fc.c_first_name, fc.c_last_name, 
       fc.gender, fc.age_group, 
       COALESCE(sa.total_spent, 0) AS total_spent,
       COALESCE(sa.purchase_count, 0) AS purchase_count,
       CASE 
           WHEN sa.total_spent IS NULL THEN 'No Purchases'
           WHEN sa.total_spent = 0 THEN 'Freebie Seeker'
           ELSE 'Regular Customer'
       END AS customer_status
FROM FilteredCustomers fc
LEFT JOIN SalesAggregation sa ON fc.c_customer_sk = sa.c_customer_sk
WHERE fc.city_rank = 1
  AND (fc.ca_city LIKE '%ville' OR fc.ca_city IS NULL) 
ORDER BY fc.gender, fc.age_group DESC, total_spent DESC
LIMIT 100;
