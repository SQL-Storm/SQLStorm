
WITH customer_info AS (
    SELECT
        c.c_customer_sk,
        c.c_first_name,
        c.c_last_name,
        cd.cd_gender,
        cd.cd_marital_status,
        cd.cd_purchase_estimate,
        ROW_NUMBER() OVER (PARTITION BY c.c_customer_sk ORDER BY cd.cd_purchase_estimate DESC) AS rank
    FROM customer c
    LEFT JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    WHERE cd.cd_gender IS NOT NULL
),
address_info AS (
    SELECT
        ca.ca_address_sk,
        ca.ca_city,
        ca.ca_state,
        COUNT(c.c_customer_sk) AS customer_count
    FROM customer_address ca
    LEFT JOIN customer c ON c.c_current_addr_sk = ca.ca_address_sk
    GROUP BY ca.ca_address_sk, ca.ca_city, ca.ca_state
),
purchase_stats AS (
    SELECT
        COALESCE(SUM(ws.ws_net_profit), 0) AS total_profit,
        COALESCE(SUM(cs.cs_net_profit), 0) AS catalog_profit,
        COALESCE(ws.ws_item_sk, cs.cs_item_sk) AS item_sk
    FROM web_sales ws
    FULL OUTER JOIN catalog_sales cs ON ws.ws_item_sk = cs.cs_item_sk
    WHERE (ws.ws_sold_date_sk IS NOT NULL OR cs.cs_sold_date_sk IS NOT NULL)
    GROUP BY ws.ws_item_sk, cs.cs_item_sk
),
order_info AS (
    SELECT
        cr.cr_item_sk,
        SUM(cr.cr_return_quantity) AS total_returns,
        SUM(cr.cr_return_amount) AS total_return_amount
    FROM catalog_returns cr
    GROUP BY cr.cr_item_sk
)
SELECT
    ci.c_first_name,
    ci.c_last_name,
    ai.ca_city,
    ai.ca_state,
    ps.total_profit,
    ps.catalog_profit,
    oi.total_returns,
    oi.total_return_amount
FROM customer_info ci
JOIN address_info ai ON ai.customer_count > 5
LEFT JOIN purchase_stats ps ON ps.item_sk = ci.c_customer_sk
FULL OUTER JOIN order_info oi ON oi.cr_item_sk = ci.c_customer_sk
WHERE ci.rank = 1
AND (oi.total_returns IS NULL OR oi.total_return_amount > 100)
ORDER BY ai.ca_state ASC, ci.c_last_name ASC, ci.c_first_name ASC;
