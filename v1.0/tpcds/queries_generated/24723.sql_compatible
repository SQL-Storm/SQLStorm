
WITH RegionSales AS (
    SELECT s_state, SUM(ws_ext_sales_price) AS total_sales
    FROM web_sales ws
    JOIN customer c ON ws.ws_ship_customer_sk = c.c_customer_sk
    JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
    GROUP BY s_state
),
ItemSales AS (
    SELECT i.i_item_id, COUNT(ws.ws_order_number) AS order_count, AVG(ws.ws_net_profit) AS avg_profit
    FROM item i
    LEFT JOIN web_sales ws ON i.i_item_sk = ws.ws_item_sk
    WHERE i.i_current_price IS NOT NULL
    GROUP BY i.i_item_id
),
HighProfitItems AS (
    SELECT i_item_id
    FROM ItemSales
    WHERE avg_profit > (
        SELECT AVG(avg_profit) * 0.8 FROM ItemSales
    )
)
SELECT r.s_state,
       COALESCE(r.total_sales, 0) AS total_sales,
       COUNT(DISTINCT i.i_item_id) AS high_profit_item_count
FROM RegionSales r
FULL OUTER JOIN item i ON i.i_item_id IN (
    SELECT h.i_item_id
    FROM HighProfitItems h
)
GROUP BY r.s_state, r.total_sales
ORDER BY r.s_state ASC NULLS LAST;
