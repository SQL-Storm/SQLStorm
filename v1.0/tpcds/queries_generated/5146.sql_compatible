
WITH customer_info AS (
    SELECT c.c_customer_sk, c.c_first_name, c.c_last_name, cd.cd_gender, 
           cd.cd_income_band_sk, cd.cd_age_group, 
           SUM(ws.ws_quantity) AS total_quantity, 
           SUM(ws.ws_sales_price) AS total_spent
    FROM customer c
    JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
    WHERE cd.cd_gender = 'F' AND cd.cd_income_band_sk IS NOT NULL
    GROUP BY c.c_customer_sk, c.c_first_name, c.c_last_name, cd.cd_gender, cd.cd_income_band_sk, cd.cd_age_group
),
product_info AS (
    SELECT i.i_item_sk, i.i_product_name, i.i_current_price
    FROM item i
    WHERE i.i_rec_start_date <= DATE '2002-10-01' AND 
          (i.i_rec_end_date IS NULL OR i.i_rec_end_date > DATE '2002-10-01')
),
monthly_sales AS (
    SELECT d.d_year, d.d_month_seq, SUM(ws.ws_quantity) AS monthly_sales_qty, 
           SUM(ws.ws_sales_price) AS monthly_sales_amt
    FROM date_dim d
    JOIN web_sales ws ON d.d_date_sk = ws.ws_sold_date_sk
    WHERE d.d_year = EXTRACT(YEAR FROM DATE '2002-10-01')
    GROUP BY d.d_year, d.d_month_seq
)
SELECT ci.c_first_name, ci.c_last_name, ci.cd_gender, ci.cd_income_band_sk, 
       pi.i_product_name, pi.i_current_price,
       ms.monthly_sales_qty, ms.monthly_sales_amt
FROM customer_info ci
JOIN product_info pi ON pi.i_item_sk IN (
    SELECT ws.ws_item_sk 
    FROM web_sales ws 
    WHERE ws.ws_bill_customer_sk = ci.c_customer_sk
)
JOIN monthly_sales ms ON ms.monthly_sales_qty > 0
ORDER BY ci.c_last_name, ci.c_first_name, pi.i_product_name;
