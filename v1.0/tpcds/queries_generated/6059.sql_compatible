
WITH demographic_summary AS (
    SELECT 
        cd_gender,
        hd_income_band_sk,
        COUNT(DISTINCT c_customer_sk) AS customer_count,
        SUM(cd_purchase_estimate) AS total_purchase_estimate,
        AVG(cd_dep_count) AS average_dependents,
        AVG(cd_dep_employed_count) AS average_employed_dependents
    FROM 
        customer
    JOIN 
        customer_demographics ON c_current_cdemo_sk = cd_demo_sk
    JOIN 
        household_demographics ON hd_demo_sk = c_current_hdemo_sk
    GROUP BY 
        cd_gender, hd_income_band_sk
),
sales_summary AS (
    SELECT 
        CAST(d.d_date AS DATE) AS sales_date,
        COALESCE(SUM(ws_ext_sales_price), 0) AS total_web_sales,
        COALESCE(SUM(cs_ext_sales_price), 0) AS total_catalog_sales,
        COALESCE(SUM(ss_ext_sales_price), 0) AS total_store_sales
    FROM 
        date_dim d
    LEFT JOIN 
        web_sales ws ON d.d_date_sk = ws.ws_sold_date_sk
    LEFT JOIN 
        catalog_sales cs ON d.d_date_sk = cs.cs_sold_date_sk
    LEFT JOIN 
        store_sales ss ON d.d_date_sk = ss.ss_sold_date_sk
    GROUP BY 
        d.d_date
),
final_summary AS (
    SELECT 
        ds.sales_date,
        ds.total_web_sales,
        ds.total_catalog_sales,
        ds.total_store_sales,
        ds.total_web_sales + ds.total_catalog_sales + ds.total_store_sales AS total_sales,
        ds.total_web_sales / NULLIF(ds.total_web_sales + ds.total_catalog_sales + ds.total_store_sales, 0) AS web_sales_percentage,
        ds.total_catalog_sales / NULLIF(ds.total_web_sales + ds.total_catalog_sales + ds.total_store_sales, 0) AS catalog_sales_percentage,
        ds.total_store_sales / NULLIF(ds.total_web_sales + ds.total_catalog_sales + ds.total_store_sales, 0) AS store_sales_percentage,
        ds.total_web_sales / NULLIF(s.total_purchase_estimate, 0) AS web_sales_per_purchase_estimate
    FROM 
        sales_summary ds
    JOIN 
        demographic_summary s ON 1 = 1  
)
SELECT 
    fs.sales_date,
    fs.total_web_sales,
    fs.total_catalog_sales,
    fs.total_store_sales,
    fs.total_sales,
    fs.web_sales_percentage,
    fs.catalog_sales_percentage,
    fs.store_sales_percentage,
    fs.web_sales_per_purchase_estimate
FROM 
    final_summary fs
ORDER BY 
    fs.sales_date DESC
LIMIT 100;
