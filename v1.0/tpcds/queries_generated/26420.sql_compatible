
WITH address_data AS (
    SELECT 
        CONCAT(ca_street_number, ' ', ca_street_name, ' ', ca_street_type, 
            CASE WHEN ca_suite_number IS NOT NULL THEN CONCAT(' Suite ', ca_suite_number) ELSE '' END) AS full_address,
        ca_city,
        ca_state,
        ca_country,
        ca_address_sk
    FROM 
        customer_address
),
customer_data AS (
    SELECT 
        CONCAT(c_first_name, ' ', c_last_name) AS full_name,
        cd.gender,
        cd.marital_status,
        cd.education_status,
        ad.full_address,
        ad.ca_city,
        ad.ca_state,
        ad.ca_country,
        c.c_customer_sk
    FROM 
        customer AS c
    JOIN customer_demographics AS cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    JOIN address_data AS ad ON c.c_current_addr_sk = ad.ca_address_sk
),
item_data AS (
    SELECT 
        i.item_id, 
        i.item_desc, 
        i.current_price,
        CONCAT(i_brand, ' - ', i_category) AS brand_category
    FROM 
        item AS i
),
sales_summary AS (
    SELECT 
        ws.bill_customer_sk,
        SUM(ws.net_paid) AS total_sales,
        COUNT(ws.order_number) AS order_count
    FROM 
        web_sales AS ws
    GROUP BY 
        ws.bill_customer_sk
)
SELECT 
    cd.full_name,
    cd.gender,
    cd.marital_status,
    cd.education_status,
    cd.full_address,
    cd.ca_city,
    cd.ca_state,
    cd.ca_country,
    COALESCE(ss.total_sales, 0) AS total_sales,
    COALESCE(ss.order_count, 0) AS order_count,
    ARRAY_AGG(DISTINCT id.item_id || ': ' || id.item_desc || ' (' || id.current_price || ')') AS purchased_items,
    COUNT(DISTINCT id.item_id) AS distinct_items_purchased
FROM 
    customer_data AS cd
LEFT JOIN 
    sales_summary AS ss ON cd.c_customer_sk = ss.bill_customer_sk
LEFT JOIN 
    web_sales AS ws ON ws.bill_customer_sk = cd.c_customer_sk
LEFT JOIN 
    item_data AS id ON ws.ws_item_sk = id.i_item_sk
GROUP BY 
    cd.full_name, cd.gender, cd.marital_status, cd.education_status, cd.full_address, cd.ca_city, cd.ca_state, cd.ca_country, ss.total_sales, ss.order_count
ORDER BY 
    total_sales DESC
LIMIT 100;
