
WITH CustomerReturns AS (
    SELECT 
        sr_customer_sk,
        SUM(sr_return_quantity) AS total_return_quantity,
        SUM(sr_return_amt_inc_tax) AS total_return_amt,
        SUM(sr_return_tax) AS total_return_tax,
        COUNT(DISTINCT sr_ticket_number) AS return_count
    FROM 
        store_returns
    WHERE 
        sr_returned_date_sk = (SELECT MAX(d_date_sk) FROM date_dim WHERE d_year = 2023)
    GROUP BY 
        sr_customer_sk
),
ItemStatistics AS (
    SELECT 
        ws_item_sk,
        AVG(ws_net_profit) AS avg_net_profit,
        COUNT(DISTINCT ws_order_number) AS order_count,
        SUM(ws_quantity) AS total_quantity_sold
    FROM 
        web_sales
    WHERE 
        ws_sold_date_sk BETWEEN (SELECT MIN(d_date_sk) FROM date_dim WHERE d_year = 2023) AND (SELECT MAX(d_date_sk) FROM date_dim WHERE d_year = 2023)
    GROUP BY 
        ws_item_sk
),
ReturnableItems AS (
    SELECT 
        i_item_sk,
        i_item_id,
        i_product_name,
        COALESCE(NULLIF(total_return_quantity, 0), NULL) AS total_return_quantity,
        COALESCE(NULLIF(total_return_qty, 0), i_current_price * 0.1) AS penalty_due_to_return
    FROM 
        item
    LEFT JOIN (
        SELECT 
            sr_item_sk,
            SUM(sr_return_quantity) AS total_return_quantity
        FROM 
            store_returns
        GROUP BY 
            sr_item_sk
    ) AS Returns ON item.i_item_sk = Returns.sr_item_sk
)
SELECT 
    c.c_customer_id,
    COALESCE(d.cd_gender, 'Unknown') AS customer_gender,
    r.total_return_quantity,
    r.total_return_amt,
    r.return_count,
    i.i_item_id,
    i.i_product_name,
    COALESCE(itemStats.avg_net_profit, 0) AS average_net_profit,
    COALESCE(itemStats.order_count, 0) AS item_order_count,
    CASE
        WHEN r.total_return_quantity > 10 THEN 'High Return'
        WHEN r.total_return_quantity BETWEEN 5 AND 10 THEN 'Moderate Return'
        ELSE 'Low Return'
    END AS return_category,
    (SELECT STRING_AGG(DISTINCT w.web_name, ', ') 
     FROM web_site w 
     WHERE w.web_site_sk IN (SELECT ws.web_site_sk FROM web_sales ws WHERE ws_bill_customer_sk = c.c_customer_sk)) AS web_sites_used
FROM 
    customer c
LEFT JOIN 
    CustomerReturns r ON c.c_customer_sk = r.sr_customer_sk
LEFT JOIN 
    customer_demographics d ON c.c_current_cdemo_sk = d.cd_demo_sk
LEFT JOIN 
    ReturnableItems i ON i.total_return_quantity > 0
LEFT JOIN 
    ItemStatistics itemStats ON itemStats.ws_item_sk = i.i_item_sk
WHERE 
    (r.return_count IS NOT NULL AND r.return_count > 0) OR 
    (itemStats.order_count IS NOT NULL AND itemStats.order_count > 0)
ORDER BY 
    r.total_return_amt DESC, average_net_profit DESC
FETCH FIRST 100 ROWS ONLY;
