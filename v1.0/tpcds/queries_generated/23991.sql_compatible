
WITH RecursiveAddress AS (
    SELECT 
        ca_address_sk, 
        ca_city, 
        ca_state, 
        ca_zip,
        ROW_NUMBER() OVER (PARTITION BY ca_state ORDER BY ca_address_sk) AS rn
    FROM customer_address
),
SalesData AS (
    SELECT 
        ws_ext_sales_price,
        ws_ship_mode_sk,
        DENSE_RANK() OVER (PARTITION BY ws_ship_mode_sk ORDER BY ws_ext_sales_price DESC) AS sales_rank,
        (SELECT COUNT(*) FROM web_sales ws2 WHERE ws2.ws_ship_mode_sk = ws.ws_ship_mode_sk) AS mode_count
    FROM web_sales ws
    WHERE ws_ext_sales_price IS NOT NULL
),
ReturnData AS (
    SELECT 
        sr_returned_date_sk,
        SUM(sr_return_quantity) AS total_returned,
        AVG(sr_return_amt) AS avg_return_amt
    FROM store_returns
    WHERE sr_returned_date_sk IS NOT NULL
    GROUP BY sr_returned_date_sk
    HAVING SUM(sr_return_quantity) > 0
),
JoinData AS (
    SELECT 
        ca.ca_city,
        COUNT(DISTINCT c.c_customer_sk) AS customer_count,
        SUM(sd.ws_ext_sales_price) AS total_sales,
        COALESCE(rd.total_returned, 0) AS total_returned,
        CASE 
            WHEN SUM(sd.ws_ext_sales_price) > 0 AND COALESCE(rd.total_returned, 0) = 0 THEN 'No Returns'
            WHEN COALESCE(rd.total_returned, 0) = 0 THEN 'Returned None'
            WHEN (SUM(sd.ws_ext_sales_price) / COALESCE(rd.total_returned, 1)) > 100 THEN 'High Return Ratio'
            ELSE 'Normal Return Ratio'
        END AS return_status
    FROM customer c
    JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
    LEFT JOIN SalesData sd ON c.c_customer_id = (SELECT DISTINCT c.c_customer_id FROM web_sales WHERE ws_ship_customer_sk = c.c_customer_sk LIMIT 1)
    LEFT JOIN ReturnData rd ON rd.sr_returned_date_sk = sd.ws_ship_mode_sk
    WHERE ca.ca_state = 'CA'
    GROUP BY ca.ca_city
)
SELECT 
    ca.ca_city,
    ca.customer_count,
    ca.total_sales,
    ca.total_returned,
    ca.return_status,
    DENSE_RANK() OVER (ORDER BY ca.total_sales DESC) AS sales_rank,
    NULLIF(ca.total_returned, 0) / NULLIF(ca.total_sales, 0) AS return_ratio
FROM JoinData ca
WHERE ca.return_status != 'No Returns'
  AND ca.customer_count > 5
ORDER BY ca.total_sales DESC, ca.customer_count ASC
LIMIT 100;
