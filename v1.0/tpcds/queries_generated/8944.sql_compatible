
WITH sales_summary AS (
    SELECT 
        cs_item_sk,
        SUM(cs_quantity) AS total_quantity,
        SUM(cs_ext_sales_price) AS total_sales,
        SUM(cs_ext_discount_amt) AS total_discount,
        COUNT(DISTINCT cs_order_number) AS order_count,
        COUNT(DISTINCT cs_bill_customer_sk) AS unique_customers
    FROM catalog_sales
    WHERE cs_sold_date_sk BETWEEN 2500 AND 2610
    GROUP BY cs_item_sk
),
item_details AS (
    SELECT 
        i.i_item_sk,
        i.i_item_id,
        i.i_brand,
        i.i_category,
        i.i_current_price
    FROM item i
),
combined_sales AS (
    SELECT
        id.i_item_id,
        id.i_brand,
        id.i_category,
        id.i_current_price,
        ss.total_quantity,
        ss.total_sales,
        ss.total_discount,
        ss.order_count,
        ss.unique_customers
    FROM sales_summary ss
    JOIN item_details id ON ss.cs_item_sk = id.i_item_sk
)
SELECT 
    c.c_first_name,
    c.c_last_name,
    cs.i_item_id,
    cs.total_quantity,
    cs.total_sales,
    cs.total_discount,
    cs.order_count,
    cs.unique_customers
FROM combined_sales cs
JOIN customer c ON c.c_customer_sk = (
    SELECT 
        cs_bill_customer_sk 
    FROM catalog_sales c 
    WHERE c.cs_item_sk = cs.i_item_id 
    ORDER BY c.cs_sold_date_sk DESC
    FETCH FIRST 1 ROW ONLY
)
WHERE cs.total_sales > 1000
ORDER BY cs.total_sales DESC
FETCH FIRST 50 ROWS ONLY;
