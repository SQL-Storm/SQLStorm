
WITH RECURSIVE item_hierarchy AS (
    SELECT 
        i.item_id AS item_id,
        i.brand AS brand,
        i.class AS class,
        i.category AS category,
        0 AS level
    FROM item i
    WHERE i.rec_start_date <= DATE '2002-10-01' AND (i.rec_end_date IS NULL OR i.rec_end_date > DATE '2002-10-01')

    UNION ALL

    SELECT 
        i.item_id,
        i.brand,
        i.class,
        i.category,
        ih.level + 1
    FROM item i
    JOIN item_hierarchy ih ON i.brand = ih.brand AND ih.level < 2 
)
SELECT 
    ca.city AS customer_city,
    COUNT(DISTINCT c.customer_id) AS total_customers,
    COUNT(DISTINCT ws.order_number) AS total_web_sales,
    SUM(ws.net_profit) AS total_net_profit,
    AVG(ws.net_paid) AS avg_net_paid,
    ih.category AS item_category,
    RANK() OVER (PARTITION BY ih.category ORDER BY SUM(ws.net_profit) DESC) AS category_profit_rank
FROM customer c
JOIN customer_address ca ON c.current_addr_sk = ca.ca_address_sk
LEFT JOIN web_sales ws ON c.c_customer_sk = ws.bill_customer_sk
LEFT JOIN item_hierarchy ih ON ws.item_sk = (SELECT i.item_sk FROM item i WHERE i.item_id = ih.item_id)
WHERE ca.city IS NOT NULL
GROUP BY 
    ca.city, 
    ih.category
HAVING 
    SUM(ws.net_profit) > (
        SELECT AVG(total_net_profit)
        FROM (
            SELECT SUM(ws.net_profit) AS total_net_profit
            FROM web_sales ws
            GROUP BY ws.bill_customer_sk
        ) AS avg_net
    ) AND 
    ih.category IS NOT NULL
ORDER BY 
    total_customers DESC, 
    total_net_profit DESC
LIMIT 100;
