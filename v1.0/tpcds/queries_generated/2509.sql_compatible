
WITH CustomerReturnStats AS (
    SELECT
        c.c_customer_sk,
        c.c_current_addr_sk,
        SUM(COALESCE(sr.return_quantity, 0)) AS total_return_quantity,
        SUM(COALESCE(sr.return_amt_inc_tax, 0)) AS total_return_amt
    FROM
        customer c
    LEFT JOIN
        store_returns sr ON c.c_customer_sk = sr.customer_sk
    GROUP BY
        c.c_customer_sk, c.c_current_addr_sk
),
StoreSalesStats AS (
    SELECT
        ss.s_store_sk,
        COUNT(ss.ticket_number) AS total_sales,
        SUM(ss.net_profit) AS total_net_profit
    FROM
        store_sales ss
    WHERE
        ss.sold_date_sk IN (
            SELECT d.date_sk
            FROM date_dim d
            WHERE d.year = 2023
        )
    GROUP BY
        ss.s_store_sk
),
ReturnRatio AS (
    SELECT
        sr.c_customer_sk,
        COALESCE(SUM(CASE WHEN sr.total_return_quantity IS NOT NULL THEN sr.total_return_quantity END), 0) AS returns,
        COALESCE(s.total_sales, 0) AS total_sales,
        CASE 
            WHEN COALESCE(s.total_sales, 0) = 0 THEN 0
            ELSE COALESCE(SUM(sr.total_return_quantity), 0) / s.total_sales
        END AS return_ratio
    FROM
        CustomerReturnStats sr
    LEFT JOIN
        StoreSalesStats s ON sr.c_customer_sk = s.s_store_sk
    GROUP BY
        sr.c_customer_sk, s.total_sales
),
TopCustomers AS (
    SELECT
        c.c_customer_sk,
        c.c_first_name,
        c.c_last_name,
        rr.return_ratio
    FROM
        ReturnRatio rr
    JOIN
        customer c ON rr.c_customer_sk = c.c_customer_sk
    WHERE
        rr.return_ratio > 0.5
    ORDER BY
        rr.return_ratio DESC
    LIMIT 10
)
SELECT
    tc.c_customer_sk,
    tc.c_first_name,
    tc.c_last_name,
    COALESCE(cls.total_net_profit, 0) AS customer_net_profit, 
    COALESCE(crs.total_return_amt, 0) AS customer_return_amt
FROM
    TopCustomers tc
LEFT JOIN
    (SELECT
        cs.bill_customer_sk,
        SUM(cs.net_profit) AS total_net_profit
     FROM
        catalog_sales cs
     GROUP BY
        cs.bill_customer_sk) cls ON tc.c_customer_sk = cls.bill_customer_sk
LEFT JOIN
    (SELECT
        sr.customer_sk,
        SUM(sr.return_amt_inc_tax) AS total_return_amt
     FROM
        store_returns sr
     GROUP BY
        sr.customer_sk) crs ON tc.c_customer_sk = crs.customer_sk
ORDER BY
    customer_return_amt DESC;
