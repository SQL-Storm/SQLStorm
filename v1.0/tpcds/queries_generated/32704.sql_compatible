
WITH RECURSIVE SalesHierarchy AS (
    SELECT 
        s_store_sk, 
        s_store_name,
        ARRAY[ss_ticket_number] AS ticket_numbers,
        ss_sales_price,
        ROW_NUMBER() OVER (PARTITION BY s_store_sk ORDER BY ss_sales_price DESC) AS rn
    FROM store_sales
    JOIN store ON store.s_store_sk = store_sales.ss_store_sk
    WHERE ss_sold_date_sk BETWEEN (SELECT d_date_sk FROM date_dim WHERE d_date = '2001-01-01') 
                              AND (SELECT d_date_sk FROM date_dim WHERE d_date = '2001-12-31')
    UNION ALL
    SELECT 
        sh.s_store_sk, 
        sh.s_store_name,
        sh.ticket_numbers || ss_ticket_number,
        ss_sales_price,
        ROW_NUMBER() OVER (PARTITION BY sh.s_store_sk ORDER BY ss_sales_price DESC)
    FROM SalesHierarchy sh
    JOIN store_sales ON sh.s_store_sk = store_sales.ss_store_sk
    WHERE ss_sales_price > (SELECT AVG(ss_sales_price) FROM store_sales WHERE s_store_sk = sh.s_store_sk)
          AND ss_ticket_number NOT IN (SELECT UNNEST(sh.ticket_numbers))
),
AggregatedSales AS (
    SELECT 
        s_store_name,
        COUNT(DISTINCT UNNEST(ticket_numbers)) AS unique_sales,
        SUM(ss_sales_price) AS total_sales,
        AVG(ss_sales_price) AS average_sales
    FROM SalesHierarchy
    WHERE rn <= 3
    GROUP BY s_store_name
)
SELECT 
    s_store_name,
    unique_sales,
    total_sales,
    average_sales,
    CASE 
        WHEN average_sales IS NULL THEN 'No Data'
        WHEN average_sales < 20 THEN 'Low'
        WHEN average_sales < 50 THEN 'Medium'
        ELSE 'High'
    END AS sales_category
FROM AggregatedSales
ORDER BY total_sales DESC
LIMIT 10;
