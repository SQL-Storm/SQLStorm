
WITH SalesSummary AS (
    SELECT 
        d.d_date,
        ws.web_site_id,
        ws.web_name,
        SUM(ws.ws_net_profit) AS total_profit,
        COUNT(DISTINCT ws.ws_order_number) AS total_orders,
        AVG(ws.ws_net_paid_inc_tax) AS avg_order_value,
        COUNT(DISTINCT CASE WHEN cs.cs_item_sk IS NOT NULL THEN cs.cs_item_sk END) AS catalog_sales_count
    FROM
        web_sales ws
    JOIN 
        date_dim d ON ws.ws_sold_date_sk = d.d_date_sk
    LEFT JOIN 
        catalog_sales cs ON ws.ws_order_number = cs.cs_order_number AND ws.ws_item_sk = cs.cs_item_sk
    JOIN 
        web_site ws ON ws.web_site_sk = ws.ws_site_sk
    GROUP BY 
        d.d_date, ws.web_site_id, ws.web_name
),
CustomerDemographics AS (
    SELECT 
        cd.cd_demo_sk,
        cd.cd_gender,
        cd.cd_marital_status,
        cd.cd_purchase_estimate,
        MAX(cd.cd_dep_count) AS max_dependent_count
    FROM 
        customer_demographics cd
    WHERE 
        cd.cd_purchase_estimate IS NOT NULL
    GROUP BY 
        cd.cd_demo_sk, cd.cd_gender, cd.cd_marital_status
),
HighValueCustomers AS (
    SELECT 
        c.c_customer_sk,
        c.c_first_name,
        c.c_last_name,
        SUM(ss.ss_net_paid) AS total_spent,
        CD.*
    FROM 
        customer c
    JOIN 
        store_sales ss ON c.c_customer_sk = ss.ss_customer_sk
    JOIN 
        CustomerDemographics CD ON c.c_current_cdemo_sk = CD.cd_demo_sk
    WHERE 
        ss.ss_sales_price > 50
    GROUP BY 
        c.c_customer_sk, c.c_first_name, c.c_last_name, CD.cd_demo_sk, CD.cd_gender, CD.cd_marital_status, CD.cd_purchase_estimate
    HAVING 
        SUM(ss.ss_net_paid) >= 5000
)
SELECT 
    S.d_date,
    S.web_site_id,
    S.web_name,
    S.total_profit,
    S.total_orders,
    S.avg_order_value,
    COALESCE(H.total_spent, 0) AS high_value_customer_spending,
    CASE 
        WHEN S.total_orders = 0 THEN 'No Orders'
        ELSE ROUND((S.total_profit / NULLIF(S.total_orders, 0)), 2)
    END AS profit_per_order,
    (SELECT COUNT(DISTINCT cr_return_number) 
     FROM catalog_returns 
     WHERE cr_item_sk IN 
      (SELECT DISTINCT ws.ws_item_sk FROM web_sales ws WHERE ws.ws_sold_date_sk = S.d_date) 
     AND cr_return_quantity > 0) AS total_returns
FROM 
    SalesSummary S
LEFT JOIN 
    HighValueCustomers H ON S.web_site_id = H.c_customer_sk
WHERE
    S.total_profit > (SELECT AVG(total_profit) FROM SalesSummary)
ORDER BY 
    S.d_date DESC,
    S.total_profit DESC
LIMIT 100 OFFSET 0;
