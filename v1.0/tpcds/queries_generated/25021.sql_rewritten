WITH AddressCounts AS (
    SELECT 
        ca_city,
        COUNT(*) AS address_count
    FROM 
        customer_address
    GROUP BY 
        ca_city
),
CustomerCounts AS (
    SELECT 
        ca.city AS city,
        COUNT(c.c_customer_sk) AS customer_count,
        COUNT(DISTINCT c.c_customer_id) AS distinct_customers
    FROM 
        customer c
    JOIN 
        customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
    GROUP BY 
        ca.city
),
SalesData AS (
    SELECT 
        DATE_FORMAT(d.d_date, '%Y-%m') AS month,
        SUM(ws.ws_sales_price) AS total_sales,
        SUM(cs.cs_sales_price) AS catalog_sales,
        SUM(ss.ss_sales_price) AS store_sales,
        SUM(ws.ws_sales_price + cs.cs_sales_price + ss.ss_sales_price) AS combined_sales
    FROM 
        date_dim d
    LEFT JOIN 
        web_sales ws ON d.d_date_sk = ws.ws_sold_date_sk
    LEFT JOIN 
        catalog_sales cs ON d.d_date_sk = cs.cs_sold_date_sk
    LEFT JOIN 
        store_sales ss ON d.d_date_sk = ss.ss_sold_date_sk
    GROUP BY 
        month
)
SELECT 
    ac.ca_city,
    cc.customer_count,
    cc.distinct_customers,
    sd.month,
    sd.total_sales,
    sd.catalog_sales,
    sd.store_sales,
    sd.combined_sales
FROM 
    AddressCounts ac
JOIN 
    CustomerCounts cc ON ac.city = cc.city
JOIN 
    SalesData sd ON MONTH(sd.month) = MONTH(cast('2002-10-01' as date)()) AND YEAR(sd.month) = YEAR(cast('2002-10-01' as date)())
ORDER BY 
    ac.city, sd.month DESC;