
WITH ranked_sales AS (
    SELECT 
        ws.web_site_sk,
        ws.web_site_id,
        SUM(ws.net_profit) AS total_net_profit,
        RANK() OVER (PARTITION BY ws.web_site_id ORDER BY SUM(ws.net_profit) DESC) AS profit_rank
    FROM 
        web_sales ws
    INNER JOIN 
        date_dim dd ON ws.sold_date_sk = dd.d_date_sk
    WHERE 
        dd.d_year = 2023
    GROUP BY 
        ws.web_site_sk, 
        ws.web_site_id
),
customer_returns AS (
    SELECT 
        cr.returning_customer_sk,
        COUNT(cr.returning_customer_sk) AS total_returns,
        SUM(cr.return_amount) AS total_return_amount
    FROM 
        web_returns cr
    INNER JOIN 
        customer cust ON cr.returning_customer_sk = cust.c_customer_sk
    WHERE 
        cust.c_current_cdemo_sk IS NOT NULL 
    GROUP BY 
        cr.returning_customer_sk
)
SELECT 
    ca.city,
    SUM(COALESCE(sr.return_quantity, 0) + COALESCE(ws.quantity, 0)) AS total_items,
    AVG(COALESCE(cr.total_return_amount, 0)) AS avg_return_amount,
    rs.total_net_profit
FROM 
    customer_address ca
LEFT JOIN 
    store_returns sr ON ca.ca_address_sk = sr.addr_sk
LEFT JOIN 
    web_sales ws ON ca.ca_address_sk = ws.bill_addr_sk
LEFT JOIN 
    customer_returns cr ON ca.ca_address_sk = cr.returning_customer_sk
LEFT JOIN 
    ranked_sales rs ON ws.web_site_sk = rs.web_site_sk
WHERE 
    rs.profit_rank = 1
GROUP BY 
    ca.city, 
    rs.total_net_profit
ORDER BY 
    total_items DESC, 
    avg_return_amount DESC;
