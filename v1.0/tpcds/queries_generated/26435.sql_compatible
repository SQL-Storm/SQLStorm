
WITH AddressSummary AS (
    SELECT 
        ca_state, 
        ca_city, 
        COUNT(DISTINCT ca_address_id) AS unique_address_count,
        SUM(LENGTH(ca_street_name)) AS total_street_name_length,
        STRING_AGG(DISTINCT ca_street_name, ', ') AS street_names,
        MAX(ca_gmt_offset) AS max_gmt_offset,
        MIN(ca_gmt_offset) AS min_gmt_offset
    FROM 
        customer_address
    GROUP BY 
        ca_state, 
        ca_city
),
DemographicSummary AS (
    SELECT 
        cd_gender,
        COUNT(c_customer_sk) AS customer_count,
        AVG(cd_purchase_estimate) AS avg_purchase_estimate,
        STRING_AGG(DISTINCT cd_credit_rating, ', ') AS credit_ratings,
        MAX(cd_dep_count) AS max_dependents
    FROM 
        customer c
    JOIN 
        customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    GROUP BY 
        cd_gender
)
SELECT 
    AS.ca_state AS address_state,
    AS.ca_city AS address_city,
    AS.unique_address_count AS address_count,
    AS.total_street_name_length,
    AS.street_names,
    DS.cd_gender,
    DS.customer_count,
    DS.avg_purchase_estimate,
    DS.credit_ratings,
    DS.max_dependents
FROM 
    AddressSummary AS
JOIN 
    DemographicSummary DS
ON 
    AS.max_gmt_offset BETWEEN -5 AND -3
ORDER BY 
    AS.unique_address_count DESC, 
    DS.customer_count DESC;
