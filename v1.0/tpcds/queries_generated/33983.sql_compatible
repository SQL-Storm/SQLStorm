
WITH RECURSIVE sales_hierarchy AS (
    SELECT 
        ws.web_site_id,
        SUM(ws.ws_net_paid) AS total_sales,
        1 AS level
    FROM 
        web_sales ws
    JOIN 
        web_site w ON ws.ws_web_site_sk = w.web_site_sk
    GROUP BY 
        ws.web_site_id
    
    UNION ALL
    
    SELECT 
        w.web_site_id,
        SUM(ws.ws_net_paid) AS total_sales,
        sh.level + 1
    FROM 
        web_sales ws
    JOIN 
        web_site w ON ws.ws_web_site_sk = w.web_site_sk
    JOIN 
        sales_hierarchy sh ON w.web_site_id = sh.web_site_id
    GROUP BY 
        w.web_site_id, sh.level
)
SELECT 
    c.c_first_name,
    c.c_last_name,
    ca.ca_city,
    SUM(ws.ws_net_paid_inc_tax) AS total_spent,
    ROW_NUMBER() OVER (PARTITION BY ca.ca_city ORDER BY SUM(ws.ws_net_paid_inc_tax) DESC) AS city_rank,
    CASE 
        WHEN SUM(ws.ws_net_paid_inc_tax) IS NULL THEN 'No Spent Yet'
        ELSE 'Regular Customer'
    END AS customer_status
FROM 
    customer c
LEFT JOIN 
    web_sales ws ON c.c_customer_sk = ws.ws_ship_customer_sk
LEFT JOIN 
    customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
WHERE 
    c.c_birth_year BETWEEN 1980 AND 1995
    AND EXISTS (
        SELECT 1 
        FROM store_sales ss 
        WHERE ss.ss_customer_sk = c.c_customer_sk
        AND ss.ss_sold_date_sk = (
            SELECT MAX(ss2.ss_sold_date_sk) 
            FROM store_sales ss2 
            WHERE ss2.ss_customer_sk = c.c_customer_sk
        )
    )
GROUP BY 
    c.c_first_name, c.c_last_name, ca.ca_city
HAVING 
    SUM(ws.ws_net_paid_inc_tax) > 1000
ORDER BY 
    total_spent DESC
FETCH FIRST 10 ROWS ONLY;
