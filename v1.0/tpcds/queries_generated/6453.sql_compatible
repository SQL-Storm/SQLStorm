
WITH CustomerSales AS (
    SELECT
        c.c_first_name,
        c.c_last_name,
        SUM(ws.ws_net_paid) AS total_web_sales,
        COUNT(DISTINCT ws.ws_order_number) AS total_orders,
        d.d_year,
        d.d_month,
        d.d_day_name
    FROM
        customer c
    JOIN
        web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
    JOIN
        date_dim d ON ws.ws_sold_date_sk = d.d_date_sk
    WHERE
        d.d_year = 2023
    GROUP BY
        c.c_first_name, c.c_last_name, d.d_year, d.d_month, d.d_day_name
),
TopCustomers AS (
    SELECT
        c_first_name,
        c_last_name,
        total_web_sales,
        total_orders,
        ROW_NUMBER() OVER (ORDER BY total_web_sales DESC) AS sales_rank,
        d_year
    FROM
        CustomerSales
)
SELECT
    c_first_name,
    c_last_name,
    total_web_sales,
    total_orders,
    sales_rank,
    SUM(total_web_sales) OVER (PARTITION BY d_year ORDER BY sales_rank) AS cumulative_sales
FROM
    TopCustomers
WHERE
    sales_rank <= 10
ORDER BY
    total_web_sales DESC;
