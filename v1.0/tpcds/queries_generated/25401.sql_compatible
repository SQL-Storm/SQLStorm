
WITH AddressDetails AS (
    SELECT 
        ca_address_id,
        CONCAT(ca_street_number, ' ', ca_street_name, ' ', ca_street_type) AS full_address,
        ca_city,
        ca_state,
        ca_zip,
        LENGTH(ca_street_name) AS street_name_length,
        CASE 
            WHEN ca_state IN ('CA', 'NY', 'TX') THEN 'High Volume'
            ELSE 'Regular Volume'
        END AS volume_category
    FROM customer_address
),
Demographics AS (
    SELECT 
        cd_demo_sk,
        cd_gender,
        cd_marital_status,
        cd_education_status,
        cd_purchase_estimate,
        SUBSTRING(cd_credit_rating, 1, 3) AS short_credit_rating
    FROM customer_demographics
),
SalesData AS (
    SELECT 
        ws_item_sk,
        SUM(ws_quantity) AS total_sold,
        AVG(ws_sales_price) AS avg_sales_price
    FROM web_sales
    GROUP BY ws_item_sk
),
FinalOutput AS (
    SELECT 
        ad.full_address,
        ad.ca_city,
        ad.ca_zip,
        dem.cd_gender,
        dem.cd_marital_status,
        sd.total_sold,
        sd.avg_sales_price,
        ad.volume_category
    FROM AddressDetails ad
    JOIN customer c ON c.c_current_addr_sk = ad.ca_address_id
    JOIN Demographics dem ON c.c_current_cdemo_sk = dem.cd_demo_sk
    JOIN SalesData sd ON sd.ws_item_sk = c.c_customer_sk
    WHERE ad.street_name_length > 10
    ORDER BY ad.ca_city, sd.total_sold DESC
)
SELECT *
FROM FinalOutput
WHERE volume_category = 'High Volume'
AND avg_sales_price > (SELECT AVG(avg_sales_price) FROM SalesData)
LIMIT 100;
