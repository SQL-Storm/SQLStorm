
WITH ranked_sales AS (
    SELECT 
        ws.web_site_id,
        ws.ws_item_sk,
        ws.ws_order_number,
        ws.ws_net_paid,
        ROW_NUMBER() OVER (PARTITION BY ws.web_site_id ORDER BY ws.ws_net_paid DESC) AS rank
    FROM 
        web_sales ws
    JOIN 
        web_site w ON ws.ws_web_site_sk = w.web_site_sk
    WHERE 
        w.web_open_date_sk < (SELECT MAX(d_date_sk) FROM date_dim WHERE d_year = 2001)
)
SELECT 
    a.ca_city,
    COALESCE(SUM(ws.ws_net_paid), 0) AS total_sales,
    COUNT(DISTINCT c.c_customer_id) AS unique_customers,
    STRING_AGG(DISTINCT CONCAT(c.c_first_name, ' ', c.c_last_name), '; ') AS customer_names
FROM 
    customer_address a
LEFT JOIN 
    customer c ON a.ca_address_sk = c.c_current_addr_sk
LEFT JOIN 
    ranked_sales rs ON c.c_customer_sk = rs.ws_bill_customer_sk
LEFT JOIN 
    web_sales ws ON rs.ws_order_number = ws.ws_order_number AND rs.ws_item_sk = ws.ws_item_sk
WHERE
    a.ca_state = 'CA' AND
    EXISTS (
        SELECT 1 
        FROM store_returns sr 
        WHERE sr.sr_customer_sk = c.c_customer_sk 
        AND sr.sr_return_quantity > 0
    )
GROUP BY 
    a.ca_city
HAVING 
    SUM(COALESCE(ws.ws_net_paid, 0)) / NULLIF(COUNT(DISTINCT c.c_customer_id), 0) > 100
ORDER BY 
    total_sales DESC
FETCH FIRST 10 ROWS ONLY;
