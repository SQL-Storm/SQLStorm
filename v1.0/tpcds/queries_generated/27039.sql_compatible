
WITH AddressStats AS (
    SELECT 
        ca_state,
        COUNT(DISTINCT ca_address_id) AS unique_addresses,
        COUNT(ca_address_id) AS total_addresses,
        MAX(LENGTH(ca_street_name)) AS max_street_name_length,
        MIN(LENGTH(ca_street_name)) AS min_street_name_length
    FROM 
        customer_address
    GROUP BY 
        ca_state
),
CustomerStats AS (
    SELECT 
        cd_marital_status,
        cd_gender,
        AVG(cd_purchase_estimate) AS average_purchase_estimate,
        COUNT(DISTINCT cd_demo_sk) AS demographic_count
    FROM 
        customer_demographics
    GROUP BY 
        cd_marital_status, cd_gender
),
WebSalesStats AS (
    SELECT 
        ws_bill_site_sk,
        SUM(ws_net_profit) AS total_net_profit,
        COUNT(ws_order_number) AS total_orders,
        MAX(ws_sales_price) AS highest_sales_price
    FROM 
        web_sales
    GROUP BY 
        ws_bill_site_sk
),
CombinedStats AS (
    SELECT 
        a.ca_state,
        a.unique_addresses,
        a.total_addresses,
        a.max_street_name_length,
        a.min_street_name_length,
        c.cd_marital_status,
        c.cd_gender,
        c.average_purchase_estimate,
        c.demographic_count,
        w.total_net_profit,
        w.total_orders,
        w.highest_sales_price
    FROM 
        AddressStats a
    CROSS JOIN 
        CustomerStats c 
    CROSS JOIN 
        WebSalesStats w 
)
SELECT 
    ca_state,
    MAX(unique_addresses) AS max_unique_addresses,
    AVG(average_purchase_estimate) AS overall_avg_purchase_estimate,
    SUM(total_net_profit) AS total_profit,
    MIN(min_street_name_length) AS overall_min_street_length,
    MAX(max_street_name_length) AS overall_max_street_length
FROM 
    CombinedStats
GROUP BY 
    ca_state
ORDER BY 
    total_profit DESC;
