
WITH RankedReturns AS (
    SELECT 
        wr.returning_customer_sk,
        wr.returned_date_sk,
        SUM(wr.return_quantity) AS total_return_quantity,
        SUM(wr.return_amt) AS total_return_amt,
        ROW_NUMBER() OVER (PARTITION BY wr.returning_customer_sk ORDER BY SUM(wr.return_amt) DESC) AS rn
    FROM 
        web_returns wr
    JOIN 
        customer c ON wr.returning_customer_sk = c.c_customer_sk
    WHERE 
        c.c_birth_year BETWEEN 1980 AND 1990 
        AND c.c_preferred_cust_flag = 'Y'
    GROUP BY 
        wr.returning_customer_sk, wr.returned_date_sk
),
TopReturns AS (
    SELECT 
        return_date,
        SUM(total_return_quantity) AS overall_return_quantity,
        AVG(total_return_amt) AS average_return_amt
    FROM (
        SELECT 
            wr.returned_date_sk AS return_date,
            rr.total_return_quantity,
            rr.total_return_amt
        FROM 
            RankedReturns rr
        JOIN 
            date_dim dd ON rr.returned_date_sk = dd.d_date_sk
        WHERE 
            rr.rn <= 5
    ) AS DailyReturns
    GROUP BY 
        return_date
)
SELECT 
    dd.d_date AS date,
    tr.overall_return_quantity,
    tr.average_return_amt
FROM 
    TopReturns tr
JOIN 
    date_dim dd ON tr.return_date = dd.d_date_sk
ORDER BY 
    dd.d_date DESC
FETCH FIRST 100 ROWS ONLY;
