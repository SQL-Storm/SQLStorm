
WITH RankedCustomers AS (
    SELECT 
        c.c_customer_sk, 
        c.c_first_name, 
        c.c_last_name, 
        cd.cd_gender, 
        cd.cd_marital_status, 
        cd.cd_income_band_sk, 
        ROW_NUMBER() OVER (PARTITION BY cd.cd_gender ORDER BY cd.cd_purchase_estimate DESC) AS rank
    FROM customer c
    JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
),
SalesSummary AS (
    SELECT 
        ws.ws_ship_customer_sk, 
        SUM(ws.ws_net_paid_inc_tax) AS total_sales, 
        COUNT(DISTINCT ws.ws_order_number) AS order_count
    FROM web_sales ws
    GROUP BY ws.ws_ship_customer_sk
),
HighestSpenders AS (
    SELECT 
        r.c_customer_sk, 
        r.c_first_name, 
        r.c_last_name, 
        s.total_sales 
    FROM RankedCustomers r
    JOIN SalesSummary s ON r.c_customer_sk = s.ws_ship_customer_sk
    WHERE r.rank <= 5
),
StoresWithReturns AS (
    SELECT 
        s.s_store_sk, 
        SUM(sr.sr_return_quantity) AS total_returns
    FROM store s
    LEFT JOIN store_returns sr ON s.s_store_sk = sr.s_store_sk
    GROUP BY s.s_store_sk
)
SELECT 
    r.c_first_name, 
    r.c_last_name, 
    r.cd_gender, 
    hs.total_sales, 
    sw.total_returns, 
    CASE 
        WHEN hs.total_sales IS NULL THEN 'No Sales' 
        WHEN sw.total_returns > 0 THEN 'Returns Involved' 
        ELSE 'No Returns' 
    END AS sales_status
FROM HighestSpenders hs
LEFT JOIN RankedCustomers r ON hs.c_customer_sk = r.c_customer_sk
LEFT JOIN StoresWithReturns sw ON sw.s_store_sk = 1  
WHERE r.cd_marital_status = 'M' 
  AND EXISTS (
      SELECT 1 
      FROM date_dim d 
      WHERE d.d_year = 2001 
      AND d.d_date >= DATEADD(DAY, -30, '2002-10-01')
)
ORDER BY hs.total_sales DESC, r.c_last_name, r.c_first_name;
