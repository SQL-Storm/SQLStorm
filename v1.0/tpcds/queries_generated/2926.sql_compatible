
WITH RankedSales AS (
    SELECT 
        c.c_customer_id,
        c.c_first_name,
        c.c_last_name,
        SUM(ws.ws_net_profit) AS total_net_profit,
        DENSE_RANK() OVER (ORDER BY SUM(ws.ws_net_profit) DESC) AS rnk
    FROM 
        customer c
    JOIN 
        web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
    GROUP BY 
        c.c_customer_id, c.c_first_name, c.c_last_name
),
CustomerAddress AS (
    SELECT 
        ca.ca_address_id, 
        ca.ca_city, 
        ca.ca_state,
        ROW_NUMBER() OVER (PARTITION BY ca.ca_city ORDER BY ca.ca_city) AS address_rank
    FROM 
        customer_address ca
),
HighValueCustomers AS (
    SELECT 
        rs.c_customer_id, 
        rs.total_net_profit,
        ca.ca_address_id,
        ca.ca_city,
        ca.ca_state
    FROM 
        RankedSales rs
    LEFT JOIN 
        CustomerAddress ca ON rs.c_customer_id = (SELECT c.c_customer_id FROM customer c WHERE c.c_current_addr_sk = ca.ca_address_id) 
    WHERE 
        rs.total_net_profit > 10000
)

SELECT 
    cvc.c_customer_id,
    cvc.total_net_profit,
    cvc.ca_address_id,
    cvc.ca_city,
    cvc.ca_state
FROM 
    HighValueCustomers cvc
WHERE 
    EXISTS (SELECT 1 
            FROM store s 
            WHERE s.s_closed_date_sk IS NULL 
              AND s.s_city = cvc.ca_city)
UNION 
SELECT 
    cvc.c_customer_id,
    cvc.total_net_profit,
    cvc.ca_address_id,
    cvc.ca_city,
    cvc.ca_state
FROM 
    HighValueCustomers cvc
WHERE 
    NOT EXISTS (SELECT 1 
                 FROM call_center cc 
                 WHERE cc.cc_city = cvc.ca_city)
ORDER BY 
    total_net_profit DESC;
