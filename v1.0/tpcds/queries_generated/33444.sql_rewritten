WITH RECURSIVE revenue_analysis AS (
    SELECT
        wc.warehouse_id,
        SUM(ws_ext_sales_price) AS total_sales,
        COUNT(DISTINCT ws_order_number) AS order_count,
        ROW_NUMBER() OVER (PARTITION BY wc.warehouse_id ORDER BY SUM(ws_ext_sales_price) DESC) AS rank
    FROM
        web_sales
    JOIN warehouse wc ON ws_warehouse_sk = w_warehouse_sk
    GROUP BY
        wc.warehouse_id
),
customer_analysis AS (
    SELECT 
        c.c_customer_sk,
        cd.cd_gender,
        SUM(ws_ext_sales_price) AS total_sales,
        COUNT(ws_order_number) AS total_orders
    FROM 
        customer c
    JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
    JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    GROUP BY 
        c.c_customer_sk, cd.cd_gender
),
top_customers AS (
    SELECT 
        ca.c_customer_sk,
        ca.cd_gender,
        ca.total_sales,
        ca.total_orders,
        RANK() OVER (ORDER BY ca.total_sales DESC) AS sales_rank
    FROM 
        customer_analysis ca
    WHERE 
        ca.total_orders > 5
),
date_summary AS (
    SELECT 
        d.d_year,
        SUM(ws.ws_ext_sales_price) AS total_revenue,
        COUNT(ws.ws_order_number) AS total_orders
    FROM
        date_dim d
    JOIN web_sales ws ON d.d_date_sk = ws.ws_sold_date_sk
    GROUP BY 
        d.d_year
),
income_distribution AS (
    SELECT 
        h.hd_income_band_sk,
        COUNT(c.c_customer_sk) AS customer_count,
        AVG(ws.ws_net_profit) AS average_profit
    FROM
        household_demographics h
    JOIN customer c ON h.hd_demo_sk = c.c_current_hdemo_sk
    LEFT JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
    GROUP BY 
        h.hd_income_band_sk
)
SELECT 
    ra.warehouse_id,
    ra.total_sales,
    ra.order_count,
    tc.cd_gender,
    tc.total_sales AS customer_total_sales,
    ds.total_revenue AS yearly_revenue,
    id.customer_count,
    id.average_profit
FROM 
    revenue_analysis ra
LEFT JOIN 
    top_customers tc ON ra.total_sales = tc.total_sales
JOIN 
    date_summary ds ON ds.d_year = EXTRACT(YEAR FROM cast('2002-10-01' as date))
LEFT JOIN 
    income_distribution id ON id.hd_income_band_sk = tc.cd_gender
WHERE 
    ra.rank = 1
ORDER BY 
    ra.total_sales DESC, id.customer_count DESC;