
WITH RankedSales AS (
    SELECT
        ws_item_sk,
        SUM(ws_net_paid) AS total_net_paid,
        COUNT(DISTINCT ws_order_number) AS total_orders,
        RANK() OVER (PARTITION BY ws_item_sk ORDER BY SUM(ws_net_paid) DESC) AS sales_rank
    FROM
        web_sales
    WHERE
        ws_sold_date_sk BETWEEN 2451545 AND 2451999
    GROUP BY
        ws_item_sk
),
CustomerDemographics AS (
    SELECT
        cd_demo_sk,
        cd_gender AS gender,
        cd_marital_status AS marital_status,
        cd_education_status,
        COUNT(c_customer_sk) AS customer_count
    FROM
        customer
        JOIN customer_demographics ON c_current_cdemo_sk = cd_demo_sk
    GROUP BY
        cd_demo_sk, cd_gender, cd_marital_status, cd_education_status
),
ItemSales AS (
    SELECT
        i_item_sk,
        i_item_id,
        COALESCE(SUM(ss_quantity), 0) AS total_store_sales,
        COALESCE(SUM(cs_quantity), 0) AS total_catalog_sales
    FROM
        item
        LEFT JOIN store_sales ON i_item_sk = ss_item_sk
        LEFT JOIN catalog_sales ON i_item_sk = cs_item_sk
    GROUP BY
        i_item_sk, i_item_id
)
SELECT
    ca.city,
    ca.state,
    cd.gender,
    cd.marital_status,
    COUNT(DISTINCT ws.ws_bill_customer_sk) AS unique_customers,
    SUM(COALESCE(rs.total_net_paid, 0)) AS total_web_sales,
    SUM(COALESCE(is.total_store_sales, 0)) AS total_store_sales,
    SUM(COALESCE(is.total_catalog_sales, 0)) AS total_catalog_sales,
    CASE 
        WHEN COUNT(DISTINCT ws.ws_bill_customer_sk) = 0 THEN 'No Customers'
        ELSE 'Customers Present'
    END AS customer_status
FROM
    web_sales ws
    JOIN CustomerDemographics cd ON ws.ws_bill_cdemo_sk = cd.cd_demo_sk
    JOIN RankedSales rs ON ws.ws_item_sk = rs.ws_item_sk
    LEFT JOIN ItemSales is ON ws.ws_item_sk = is.i_item_sk
    LEFT JOIN customer_address ca ON ws.ws_bill_addr_sk = ca.ca_address_sk
GROUP BY
    ca.city, ca.state, cd.gender, cd.marital_status
HAVING
    SUM(COALESCE(rs.total_net_paid, 0)) > 1000
ORDER BY
    total_web_sales DESC, ca.city ASC;
