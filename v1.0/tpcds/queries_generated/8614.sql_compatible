
WITH CustomerSales AS (
    SELECT 
        c.c_customer_sk,
        SUM(ss.ss_net_paid) AS total_sales,
        COUNT(ss.ss_ticket_number) AS total_transactions,
        AVG(ss.ss_net_paid) AS avg_transaction_value
    FROM 
        customer c
    JOIN 
        store_sales ss ON c.c_customer_sk = ss.ss_customer_sk
    WHERE 
        c.c_birth_year BETWEEN 1980 AND 1990
    GROUP BY 
        c.c_customer_sk
),
DemographicData AS (
    SELECT 
        cd.cd_demo_sk,
        d.d_year,
        d.d_month_seq,
        d.d_dom,
        cd.cd_gender,
        cd.cd_marital_status,
        SUM(cs.total_sales) AS total_sales,
        COUNT(cs.total_transactions) AS total_transactions,
        AVG(cs.avg_transaction_value) AS avg_transaction_value
    FROM 
        customer_demographics cd
    JOIN 
        CustomerSales cs ON cd.cd_demo_sk = cs.c_customer_sk
    JOIN 
        date_dim d ON d.d_date_sk = DATE '2002-10-01'
    GROUP BY 
        cd.cd_demo_sk, d.d_year, d.d_month_seq, d.d_dom, cd.cd_gender, cd.cd_marital_status
),
WarehouseStatistics AS (
    SELECT 
        w.w_warehouse_sk,
        SUM(ss.ss_net_profit) AS total_profit,
        AVG(ss.ss_net_paid) AS avg_sale_per_item
    FROM 
        warehouse w
    JOIN 
        store_sales ss ON w.w_warehouse_sk = ss.ss_store_sk
    GROUP BY 
        w.w_warehouse_sk
)
SELECT 
    dd.cd_gender,
    dd.cd_marital_status,
    dd.total_sales AS demographic_total_sales,
    ws.total_profit AS warehouse_total_profit,
    ws.avg_sale_per_item,
    dd.avg_transaction_value
FROM 
    DemographicData dd
JOIN 
    WarehouseStatistics ws ON dd.total_sales > ws.avg_sale_per_item
WHERE 
    dd.total_transactions > 5
ORDER BY 
    dd.total_sales DESC;
