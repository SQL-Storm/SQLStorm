WITH RankedSales AS (
    SELECT
        ws.web_site_sk,
        ws.ws_item_sk,
        ws.ws_order_number,
        ROW_NUMBER() OVER (PARTITION BY ws.web_site_sk ORDER BY ws.ws_net_profit DESC) as RankProfit,
        SUM(ws.ws_quantity) OVER (PARTITION BY ws.web_site_sk) as TotalQuantity,
        SUM(ws.ws_net_profit) OVER (PARTITION BY ws.web_site_sk) as TotalProfit
    FROM
        web_sales ws
    JOIN
        date_dim dd ON ws.ws_sold_date_sk = dd.d_date_sk
    WHERE
        dd.d_year = 2001
        AND dd.d_month_seq BETWEEN 1 AND 6
)
SELECT 
    w.warehouse_name,
    SUM(rs.TotalQuantity) AS Total_Items_Sold,
    SUM(rs.TotalProfit) AS Total_Profit,
    AVG(CASE WHEN rs.RankProfit <= 10 THEN rs.ws_net_profit END) AS Avg_Top_10_Profit,
    COUNT(DISTINCT ws.ws_order_number) AS Total_Orders
FROM 
    RankedSales rs
JOIN 
    warehouse w ON rs.web_site_sk = w.w_warehouse_sk
JOIN 
    store s ON s.s_store_sk = rs.ws_item_sk 
LEFT JOIN 
    customer_demographics cd ON cd.cd_demo_sk = (
        SELECT 
            c.c_current_cdemo_sk 
        FROM 
            customer c 
        WHERE 
            c.c_customer_sk = rs.ws_bill_customer_sk 
            LIMIT 1
    )
WHERE 
    w.w_warehouse_name IS NOT NULL
    AND (cd.cd_gender = 'F' OR cd.cd_marital_status = 'S')
GROUP BY 
    w.warehouse_name
HAVING 
    SUM(rs.TotalProfit) > 1000
ORDER BY 
    Total_Profit DESC;