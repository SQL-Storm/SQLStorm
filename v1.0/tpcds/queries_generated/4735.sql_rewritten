WITH RankedSales AS (
    SELECT 
        ws_bill_customer_sk,
        SUM(ws_net_profit) AS total_profit,
        RANK() OVER (PARTITION BY ws_bill_customer_sk ORDER BY SUM(ws_net_profit) DESC) AS profit_rank
    FROM 
        web_sales
    GROUP BY 
        ws_bill_customer_sk
),
HighValueCustomers AS (
    SELECT 
        c.c_customer_sk,
        c.c_first_name,
        c.c_last_name,
        cr.return_count
    FROM 
        customer c
    LEFT JOIN (
        SELECT 
            sr_customer_sk,
            COUNT(sr_return_quantity) AS return_count
        FROM 
            store_returns
        GROUP BY 
            sr_customer_sk
        HAVING 
            COUNT(sr_return_quantity) > 0
    ) cr ON c.c_customer_sk = cr.sr_customer_sk
    WHERE 
        cr.return_count IS NOT NULL
),
ProfitAnalysis AS (
    SELECT 
        r.ws_bill_customer_sk,
        r.total_profit,
        h.c_first_name,
        h.c_last_name,
        h.return_count
    FROM 
        RankedSales r
    JOIN 
        HighValueCustomers h ON r.ws_bill_customer_sk = h.c_customer_sk
    WHERE 
        r.total_profit > 10000
),
FinalResults AS (
    SELECT 
        c.c_customer_sk,
        c.c_first_name,
        c.c_last_name,
        COALESCE(SUM(CASE WHEN sa.sm_ship_mode_id IS NOT NULL THEN 1 END), 0) AS shipped_count,
        COALESCE(MAX(a.warehouse_name), 'No Warehouse') AS warehouse_used,
        SUM(p.p_cost) AS total_cost
    FROM 
        customer c
    LEFT JOIN 
        web_sales ws ON ws.ws_bill_customer_sk = c.c_customer_sk
    LEFT JOIN 
        ship_mode sa ON ws.ws_ship_mode_sk = sa.sm_ship_mode_sk
    LEFT JOIN 
        inventory i ON ws.ws_item_sk = i.inv_item_sk
    LEFT JOIN 
        warehouse a ON i.inv_warehouse_sk = a.w_warehouse_sk
    LEFT JOIN 
        promotion p ON ws.ws_promo_sk = p.p_promo_sk
    WHERE 
        c.c_preferred_cust_flag = 'Y'
    GROUP BY 
        c.c_customer_sk, c.c_first_name, c.c_last_name;