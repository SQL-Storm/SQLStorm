
WITH RECURSIVE Sales_CTE AS (
    SELECT 
        ws.web_site_id, 
        SUM(ws.net_profit) AS total_profit,
        COUNT(ws.order_number) AS total_orders,
        ROW_NUMBER() OVER (PARTITION BY ws.web_site_id ORDER BY SUM(ws.net_profit) DESC) AS rank
    FROM 
        web_sales ws
    WHERE 
        ws.ship_date_sk >= 20230101
    GROUP BY 
        ws.web_site_id
),
Customer_Stats AS (
    SELECT 
        c.c_customer_id,
        COUNT(DISTINCT ws.order_number) AS total_orders,
        COUNT(DISTINCT ws.order_number) FILTER (WHERE ws.net_profit > 0) AS successful_orders,
        SUM(ws.net_profit) AS total_profit
    FROM 
        customer c
    LEFT JOIN 
        web_sales ws ON c.c_customer_sk = ws.ship_customer_sk
    WHERE 
        c.c_preferred_cust_flag = 'Y'
    GROUP BY 
        c.c_customer_id
),
Top_Customers AS (
    SELECT 
        cs.c_customer_id,
        cs.total_orders,
        cs.successful_orders,
        cs.total_profit,
        RANK() OVER (ORDER BY cs.total_profit DESC) AS profit_rank
    FROM 
        Customer_Stats cs
)
SELECT 
    a.ca_city, 
    a.ca_state, 
    COUNT(DISTINCT c.c_customer_id) AS customer_count,
    COALESCE(SUM(ts.total_profit), 0) AS total_profit,
    AVG(ts.total_profit) AS avg_profit_per_customer,
    (SELECT STRING_AGG(c.customer_id, ',') 
     FROM Top_Customers tc
     JOIN customer c ON tc.c_customer_id = c.c_customer_id
     WHERE tc.profit_rank <= 10) AS top_customers
FROM 
    customer_address a
LEFT JOIN 
    customer c ON a.ca_address_sk = c.c_current_addr_sk
LEFT JOIN 
    Top_Customers ts ON c.c_customer_id = ts.c_customer_id
GROUP BY 
    a.ca_city, a.ca_state
HAVING 
    COUNT(DISTINCT c.c_customer_id) > 5
ORDER BY 
    total_profit DESC;
