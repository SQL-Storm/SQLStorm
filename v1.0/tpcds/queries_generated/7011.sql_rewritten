WITH CustomerSales AS (
    SELECT
        c.c_customer_id,
        SUM(ss.ss_sales_price) AS total_sales,
        COUNT(ss.ss_ticket_number) AS sales_count
    FROM
        customer c
    JOIN store_sales ss ON c.c_customer_sk = ss.ss_customer_sk
    WHERE
        c.c_birth_year BETWEEN 1980 AND 2000
    GROUP BY
        c.c_customer_id
),
TopCustomers AS (
    SELECT
        cs.c_customer_id,
        cs.total_sales,
        cs.sales_count,
        DENSE_RANK() OVER (ORDER BY cs.total_sales DESC) AS sales_rank
    FROM
        CustomerSales cs
),
CustomerDemographics AS (
    SELECT
        cd.cd_gender,
        cd.cd_marital_status,
        tc.total_sales,
        tc.sales_count
    FROM
        TopCustomers tc
    JOIN customer_demographics cd ON tc.c_customer_id = cd.cd_demo_sk
    WHERE
        tc.sales_rank <= 10  
)
SELECT
    cd.cd_gender,
    cd.cd_marital_status,
    COUNT(*) AS customer_count,
    AVG(tc.total_sales) AS avg_sales,
    SUM(tc.sales_count) AS total_sales_count
FROM
    CustomerDemographics cd
JOIN TopCustomers tc ON cd.total_sales = tc.total_sales
GROUP BY
    cd.cd_gender, cd.cd_marital_status
ORDER BY
    customer_count DESC;