
WITH RECURSIVE salesperson_hierarchy AS (
    SELECT c.c_customer_sk AS sales_id, 
           c.c_first_name, 
           c.c_last_name, 
           1 AS level
    FROM customer c
    WHERE c.c_current_cdemo_sk IS NOT NULL
    
    UNION ALL
    
    SELECT c.c_customer_sk, 
           c.c_first_name, 
           c.c_last_name, 
           sh.level + 1
    FROM customer c
    JOIN salesperson_hierarchy sh ON c.c_current_cdemo_sk = sh.sales_id
), sales_summary AS (
    SELECT 
        w.w_warehouse_id,
        SUM(ws.ws_ext_sales_price) AS total_sales,
        COUNT(DISTINCT ws.ws_order_number) AS total_orders,
        MAX(ws.ws_net_profit) AS max_profit
    FROM web_sales ws
    JOIN warehouse w ON ws.ws_warehouse_sk = w.w_warehouse_sk
    WHERE ws.ws_sold_date_sk BETWEEN (SELECT MIN(d_date_sk) FROM date_dim WHERE d_year = 2023)
                                  AND (SELECT MAX(d_date_sk) FROM date_dim WHERE d_year = 2023)
    GROUP BY w.w_warehouse_id
), customer_return_summary AS (
    SELECT 
        cr.cr_returning_customer_sk,
        SUM(cr.cr_return_amt) AS total_returns,
        COUNT(cr.cr_return_quantity) AS return_count
    FROM catalog_returns cr
    GROUP BY cr.cr_returning_customer_sk
), combined_sales AS (
    SELECT 
        ss.w_warehouse_id,
        COALESCE(s.total_sales, 0) AS total_sales,
        COALESCE(s.total_orders, 0) AS total_orders,
        COALESCE(s.max_profit, 0) AS max_profit,
        COALESCE(rs.total_returns, 0) AS total_returns,
        COALESCE(rs.return_count, 0) AS return_count
    FROM sales_summary s
    FULL OUTER JOIN (SELECT cr.cr_returning_customer_sk AS warehouse_id, total_returns, return_count
                     FROM customer_return_summary cr
                     JOIN customer c ON c.c_customer_sk = cr.cr_returning_customer_sk) rs 
    ON s.w_warehouse_id = rs.warehouse_id
), ranked_sales AS (
    SELECT 
        c.*, 
        ROW_NUMBER() OVER (PARTITION BY c.w_warehouse_id ORDER BY c.total_sales DESC) AS rank
    FROM combined_sales c
)
SELECT 
    a.ca_city AS city,
    SUM(b.total_sales) AS total_sales,
    COUNT(b.total_orders) AS total_orders,
    SUM(b.total_returns) AS total_returns,
    MAX(b.max_profit) AS max_profit
FROM ranked_sales b
LEFT JOIN customer_address a ON b.warehouse_id = a.ca_address_sk
WHERE b.rank <= 10
GROUP BY a.ca_city
HAVING SUM(b.total_sales) > 10000
ORDER BY total_sales DESC, city ASC;
