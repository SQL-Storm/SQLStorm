
WITH RECURSIVE date_series AS (
    SELECT d_date_sk, d_date, d_year, d_month_seq, d_week_seq 
    FROM date_dim
    WHERE d_date BETWEEN '2000-01-01' AND '2000-12-31'
    UNION ALL
    SELECT d_date_sk, d_date + INTERVAL '1 DAY', d_year, d_month_seq, d_week_seq
    FROM date_series
    WHERE d_date < '2000-12-31'
),
customer_summary AS (
    SELECT cd_demo_sk,
           SUM(COALESCE(ss_net_profit, 0)) AS total_net_profit,
           COUNT(DISTINCT cs_order_number) AS total_orders
    FROM customer c
    LEFT JOIN store_sales ss ON c.c_customer_sk = ss.ss_customer_sk
    LEFT JOIN catalog_sales cs ON c.c_customer_sk = cs.cs_bill_customer_sk
    LEFT JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    WHERE cd.cd_gender = 'F'
      AND cd.cd_marital_status = 'M'
    GROUP BY cd_demo_sk
),
monthly_performance AS (
    SELECT ds.d_year, ds.d_month_seq,
           SUM(cs.total_net_profit) AS monthly_profit,
           SUM(cs.total_orders) AS monthly_orders
    FROM customer_summary cs
    JOIN date_series ds ON ds.d_date_sk = cs.ss_sold_date_sk
    GROUP BY ds.d_year, ds.d_month_seq
),
ranked_performance AS (
    SELECT mp.d_year, mp.d_month_seq, mp.monthly_profit, mp.monthly_orders,
           RANK() OVER (PARTITION BY mp.d_month_seq ORDER BY mp.monthly_profit DESC) AS profit_rank
    FROM monthly_performance mp
)
SELECT d_year, d_month_seq, monthly_profit, monthly_orders, profit_rank
FROM ranked_performance
WHERE profit_rank <= 5
ORDER BY d_year, d_month_seq, monthly_profit DESC;
