
WITH RECURSIVE SalesHierarchy AS (
    SELECT s_store_sk, 
           SUM(ss_net_profit) AS total_profit,
           1 AS level
    FROM store_sales
    GROUP BY s_store_sk
    UNION ALL
    SELECT sh.s_store_sk, 
           sh.total_profit + SUM(ss.ss_net_profit),
           sh.level + 1
    FROM SalesHierarchy sh
    JOIN store s ON s.s_store_sk = sh.s_store_sk
    JOIN store_sales ss ON s.s_store_sk = ss.ss_store_sk
    WHERE sh.level < 5
    GROUP BY sh.s_store_sk, sh.total_profit, sh.level
),
CustomerReturns AS (
    SELECT sr_customer_sk, 
           COUNT(sr_ticket_number) AS total_returns,
           SUM(sr_return_amt_inc_tax) AS total_return_value
    FROM store_returns
    GROUP BY sr_customer_sk
),
CustomerDemographics AS (
    SELECT cd.cd_demo_sk,
           cd.cd_gender,
           cd.cd_marital_status,
           cd.cd_purchase_estimate,
           cd.cd_credit_rating
    FROM customer_demographics cd
    WHERE cd.cd_purchase_estimate > (
        SELECT AVG(cd_purchase_estimate) 
        FROM customer_demographics
    )
)
SELECT s.s_store_name,
       sh.total_profit,
       COALESCE(cr.total_returns, 0) AS total_returns,
       COALESCE(cr.total_return_value, 0) AS total_return_value,
       COUNT(DISTINCT c.c_customer_sk) AS unique_customers,
       ROW_NUMBER() OVER (PARTITION BY s.s_store_name ORDER BY sh.total_profit DESC) AS store_rank
FROM store s
LEFT JOIN SalesHierarchy sh ON s.s_store_sk = sh.s_store_sk
LEFT JOIN CustomerReturns cr ON cr.sr_customer_sk = (
    SELECT sr_customer_sk 
    FROM store_returns 
    WHERE sr_store_sk = s.s_store_sk
    ORDER BY sr_return_value DESC
    LIMIT 1
)
LEFT JOIN customer c ON c.c_customer_sk = cr.sr_customer_sk
WHERE s.s_country = 'USA'
GROUP BY s.s_store_name, sh.total_profit, cr.total_returns, cr.total_return_value
HAVING sh.total_profit > 10000.00
ORDER BY sh.total_profit DESC;
