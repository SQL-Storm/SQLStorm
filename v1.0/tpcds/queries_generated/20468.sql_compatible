
WITH customer_sales AS (
    SELECT 
        c.c_customer_id,
        SUM(CASE 
            WHEN ws.net_paid_inc_tax IS NOT NULL THEN ws.net_paid_inc_tax 
            ELSE 0 
        END) AS total_web_sales,
        SUM(CASE 
            WHEN cs.net_paid_inc_tax IS NOT NULL THEN cs.net_paid_inc_tax 
            ELSE 0 
        END) AS total_catalog_sales,
        SUM(CASE 
            WHEN ss.net_paid_inc_tax IS NOT NULL THEN ss.net_paid_inc_tax 
            ELSE 0 
        END) AS total_store_sales
    FROM customer c
    LEFT JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
    LEFT JOIN catalog_sales cs ON c.c_customer_sk = cs.cs_bill_customer_sk
    LEFT JOIN store_sales ss ON c.c_customer_sk = ss.ss_customer_sk
    GROUP BY c.c_customer_id
),
customer_demo_info AS (
    SELECT 
        cd.cd_demo_sk,
        cd.cd_gender,
        cd.cd_marital_status,
        cd.cd_purchase_estimate,
        cd.cd_credit_rating,
        cd.cd_dep_count,
        cd.cd_dep_employed_count,
        ca.ca_city,
        ca.ca_state,
        ROW_NUMBER() OVER (PARTITION BY cd.cd_gender ORDER BY cd.cd_purchase_estimate DESC) as rnk,
        c.c_customer_id
    FROM customer_demographics cd
    JOIN customer c ON cd.cd_demo_sk = c.c_current_cdemo_sk
    JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
)
SELECT 
    cs.c_customer_id,
    MAX(demo.cd_gender) AS gender,
    MAX(demo.cd_marital_status) AS marital_status,
    COALESCE(MAX(demo.cd_purchase_estimate), 0) AS purchase_estimate,
    COALESCE(MAX(demo.ca_city), 'UNKNOWN') AS city,
    COALESCE(MAX(demo.ca_state), 'UNKNOWN') AS state,
    COALESCE(SUM(cs.total_web_sales), 0) AS total_web_sales,
    COALESCE(SUM(cs.total_catalog_sales), 0) AS total_catalog_sales,
    COALESCE(SUM(cs.total_store_sales), 0) AS total_store_sales,
    CASE 
        WHEN COALESCE(SUM(cs.total_web_sales), 0) > COALESCE(SUM(cs.total_catalog_sales), 0)
        THEN 'Web is best'
        ELSE 'Catalog or Store is better'
    END AS sales_comparison
FROM customer_sales cs
JOIN customer_demo_info demo ON cs.c_customer_id = demo.c_customer_id
WHERE demo.rnk <= 5
GROUP BY cs.c_customer_id
HAVING COALESCE(SUM(cs.total_store_sales), 0) + COALESCE(SUM(cs.total_catalog_sales), 0) + COALESCE(SUM(cs.total_web_sales), 0) > 1000
ORDER BY total_web_sales DESC;
