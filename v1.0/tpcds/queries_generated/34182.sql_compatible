
WITH RECURSIVE SalesCTE AS (
    SELECT 
        ws_sold_date_sk, 
        ws_item_sk, 
        SUM(ws_net_profit) AS total_net_profit,
        ROW_NUMBER() OVER (PARTITION BY ws_item_sk ORDER BY SUM(ws_net_profit) DESC) AS rn
    FROM 
        web_sales
    GROUP BY 
        ws_sold_date_sk, ws_item_sk
),
HighProfitItems AS (
    SELECT 
        item.i_item_id, 
        item.i_item_desc, 
        COALESCE(SUM(sales.total_net_profit), 0) AS total_net_profit
    FROM 
        item
    LEFT JOIN 
        SalesCTE sales ON item.i_item_sk = sales.ws_item_sk
    GROUP BY 
        item.i_item_id, item.i_item_desc
    HAVING 
        total_net_profit > (SELECT AVG(total_net_profit) FROM SalesCTE)
),
CustomerReturns AS (
    SELECT 
        cr_returning_customer_sk, 
        COUNT(DISTINCT cr_order_number) AS return_count, 
        SUM(cr_return_amount) AS total_return_amount
    FROM 
        catalog_returns
    GROUP BY 
        cr_returning_customer_sk
),
PopularReturns AS (
    SELECT 
        r.r_reason_desc, 
        COUNT(cr.cr_item_sk) AS reason_count
    FROM 
        reason r
    LEFT JOIN 
        catalog_returns cr ON r.r_reason_sk = cr.cr_reason_sk
    GROUP BY 
        r.r_reason_desc
    ORDER BY 
        reason_count DESC
    LIMIT 5
)
SELECT 
    ca.ca_city, 
    COUNT(DISTINCT c.c_customer_id) AS customer_count, 
    SUM(ws.ws_net_profit) AS total_sales_profit,
    (SELECT 
         COUNT(*) 
     FROM 
         CustomerReturns cr 
     WHERE 
         cr.return_count > 2) AS frequent_returning_customers,
    (SELECT 
         STRING_AGG(pr.r_reason_desc, ', ') 
     FROM 
         PopularReturns pr) AS popular_return_reasons
FROM 
    customer c
LEFT JOIN 
    customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
LEFT JOIN 
    web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
LEFT JOIN 
    HighProfitItems hpi ON ws.ws_item_sk = hpi.i_item_id
WHERE 
    ca.ca_state = 'CA'
    AND ws.ws_sold_date_sk > (SELECT MIN(d_date_sk) FROM date_dim WHERE d_year = 2022)
GROUP BY 
    ca.ca_city
HAVING 
    SUM(ws.ws_net_profit) > 10000
ORDER BY 
    customer_count DESC;
