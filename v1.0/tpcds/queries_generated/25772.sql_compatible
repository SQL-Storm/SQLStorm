
WITH Address_Concat AS (
    SELECT 
        ca_address_sk,
        CONCAT_WS(' ', ca_street_number, ca_street_name, ca_street_type, COALESCE(ca_suite_number, '')) AS full_address,
        ca_city,
        ca_state,
        ca_zip,
        ca_country
    FROM 
        customer_address
),
Customer_Demographics AS (
    SELECT 
        cd_demo_sk,
        CONCAT(cd_gender, '_', cd_marital_status, '_', cd_education_status) AS demographic_key,
        cd_purchase_estimate,
        cd_credit_rating
    FROM 
        customer_demographics
),
Date_Dimension AS (
    SELECT 
        d_date_sk,
        CONCAT(EXTRACT(YEAR FROM d_date), '-', EXTRACT(MONTH FROM d_date), '-', EXTRACT(DAY FROM d_date)) AS formatted_date,
        d_day_name,
        d_month_seq,
        d_year
    FROM 
        date_dim
),
Item_Descriptions AS (
    SELECT 
        i_item_sk,
        UPPER(i_item_desc) AS item_desc_upper,
        LENGTH(i_item_desc) AS item_desc_length
    FROM 
        item
),
Sales_Analysis AS (
    SELECT 
        ws_item_sk,
        SUM(ws_quantity) AS total_quantity,
        SUM(ws_sales_price) AS total_sales
    FROM 
        web_sales
    GROUP BY 
        ws_item_sk
)

SELECT 
    a.full_address,
    cd.demographic_key,
    d.formatted_date,
    i.item_desc_upper,
    sa.total_quantity,
    sa.total_sales
FROM 
    Address_Concat a
JOIN 
    customer c ON c.c_current_addr_sk = a.ca_address_sk
JOIN 
    Customer_Demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
JOIN 
    Date_Dimension d ON d.d_date_sk = c.c_first_sales_date_sk
JOIN 
    Item_Descriptions i ON i.i_item_sk = sa.ws_item_sk
JOIN 
    Sales_Analysis sa ON sa.ws_item_sk = i.i_item_sk
WHERE 
    a.ca_state = 'CA' 
    AND cd.cd_credit_rating = 'Excellent' 
    AND d.d_year = 2023
ORDER BY 
    sa.total_sales DESC
LIMIT 100;
