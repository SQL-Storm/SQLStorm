
WITH RankedSales AS (
    SELECT 
        ws.web_site_id,
        SUM(ws.ws_ext_sales_price) AS total_sales,
        DENSE_RANK() OVER (PARTITION BY ws.web_site_id ORDER BY SUM(ws.ws_ext_sales_price) DESC) AS sales_rank
    FROM 
        web_sales ws
    INNER JOIN 
        date_dim dd ON ws.ws_sold_date_sk = dd.d_date_sk
    WHERE 
        dd.d_year = 2001
    GROUP BY 
        ws.web_site_id
),
CustomerReturns AS (
    SELECT 
        wr_returning_customer_sk, 
        SUM(wr_return_amt) AS total_return_amt
    FROM 
        web_returns
    GROUP BY 
        wr_returning_customer_sk
),
MonthlySales AS (
    SELECT 
        dd.d_month_seq,
        SUM(ws.ws_ext_sales_price) AS monthly_sales
    FROM 
        web_sales ws
    INNER JOIN 
        date_dim dd ON ws.ws_sold_date_sk = dd.d_date_sk
    WHERE 
        dd.d_year = 2001
    GROUP BY 
        dd.d_month_seq
)
SELECT 
    ca.ca_city,
    ca.ca_state,
    COUNT(DISTINCT c.c_customer_sk) AS num_customers,
    COALESCE(SUM(rs.total_sales), 0) AS total_sales,
    COALESCE(SUM(cr.total_return_amt), 0) AS total_returns,
    COALESCE(SUM(ms.monthly_sales), 0) AS total_monthly_sales
FROM 
    customer c
LEFT JOIN 
    customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
LEFT JOIN 
    RankedSales rs ON c.c_customer_sk = rs.web_site_id
LEFT JOIN 
    CustomerReturns cr ON c.c_customer_sk = cr.wr_returning_customer_sk
LEFT JOIN 
    MonthlySales ms ON EXTRACT(MONTH FROM DATE '2002-10-01') = ms.d_month_seq
WHERE 
    ca.ca_state IS NOT NULL
GROUP BY 
    ca.ca_city, ca.ca_state
HAVING 
    COUNT(DISTINCT c.c_customer_sk) > 5
ORDER BY 
    total_sales DESC, num_customers DESC;
