WITH RECURSIVE RankedReturns AS (
    SELECT 
        sr_item_sk, 
        COUNT(*) AS total_returns,
        ROW_NUMBER() OVER (PARTITION BY sr_item_sk ORDER BY sr_returned_date_sk DESC) AS rnk
    FROM 
        store_returns
    WHERE 
        sr_return_quantity > 0
    GROUP BY 
        sr_item_sk
), 
CustomerStats AS (
    SELECT 
        c.c_customer_sk,
        c.c_first_name,
        c.c_last_name,
        cd.cd_gender,
        cd.cd_marital_status,
        SUM(ws.ws_quantity) AS total_purchases,
        AVG(ws.ws_sales_price) AS avg_purchase_price,
        COUNT(DISTINCT ws.ws_order_number) AS unique_orders,
        COUNT(DISTINCT CASE WHEN ws.ws_sales_price IS NULL THEN 1 END) AS null_price_count
    FROM 
        customer c
    LEFT JOIN 
        customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    LEFT JOIN 
        web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk 
    GROUP BY 
        c.c_customer_sk, c.c_first_name, c.c_last_name, cd.cd_gender, cd.cd_marital_status
),
TopItems AS (
    SELECT 
        i.i_item_sk,
        i.i_item_id,
        i.i_item_desc,
        COALESCE(SUM(ss.ss_quantity), 0) AS total_sold,
        COALESCE(SUM(ss.ss_sales_price), 0) AS total_revenue,
        DENSE_RANK() OVER (ORDER BY COALESCE(SUM(ss.ss_sales_price), 0) DESC) AS rank
    FROM 
        item i
    LEFT JOIN 
        store_sales ss ON i.i_item_sk = ss.ss_item_sk
    GROUP BY 
        i.i_item_sk, i.i_item_id, i.i_item_desc
)
SELECT 
    cs.c_customer_sk,
    cs.c_first_name,
    cs.c_last_name,
    cs.total_purchases,
    cs.avg_purchase_price,
    cs.unique_orders,
    tr.total_returns,
    ti.i_item_id,
    ti.total_sold,
    ti.total_revenue
FROM 
    CustomerStats cs
FULL OUTER JOIN 
    RankedReturns tr ON cs.c_customer_sk = tr.sr_customer_sk
JOIN 
    TopItems ti ON tr.sr_item_sk = ti.i_item_sk
WHERE 
    (cs.total_purchases > 100 OR cs.avg_purchase_price IS NULL)
    AND (ti.total_revenue <> 0 OR ti.total_sold IS NULL)
ORDER BY 
    cs.c_customer_sk, ti.total_revenue DESC
FETCH FIRST 100 ROWS ONLY;