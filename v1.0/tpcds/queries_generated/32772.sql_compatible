
WITH RECURSIVE SalesCTE AS (
    SELECT ws_item_sk, 
           SUM(ws_quantity) AS total_quantity, 
           SUM(ws_net_profit) AS total_profit,
           1 AS level
    FROM web_sales
    GROUP BY ws_item_sk

    UNION ALL

    SELECT c.cs_item_sk, 
           c.cs_quantity + s.total_quantity, 
           c.cs_net_profit + s.total_profit,
           s.level + 1
    FROM catalog_sales c
    JOIN SalesCTE s ON c.cs_item_sk = s.ws_item_sk
    WHERE s.level < 5
),

CustomerSales AS (
    SELECT c.c_customer_sk,
           c.c_first_name,
           c.c_last_name,
           COALESCE(ws.total_sales, 0) AS web_sales,
           COALESCE(ss.total_sales, 0) AS store_sales,
           COALESCE(cs.total_sales, 0) AS catalog_sales
    FROM customer c
    LEFT JOIN (
        SELECT ws_bill_customer_sk, SUM(ws_net_paid) AS total_sales
        FROM web_sales
        GROUP BY ws_bill_customer_sk
    ) ws ON c.c_customer_sk = ws.ws_bill_customer_sk
    LEFT JOIN (
        SELECT ss_customer_sk, SUM(ss_net_paid) AS total_sales
        FROM store_sales
        GROUP BY ss_customer_sk
    ) ss ON c.c_customer_sk = ss.ss_customer_sk
    LEFT JOIN (
        SELECT cs_bill_customer_sk, SUM(cs_net_paid) AS total_sales
        FROM catalog_sales
        GROUP BY cs_bill_customer_sk
    ) cs ON c.c_customer_sk = cs.cs_bill_customer_sk
),

HighValueCustomers AS (
    SELECT c.c_customer_sk,
           c.c_first_name,
           c.c_last_name,
           COALESCE(ws.total_sales, 0) AS total_web_sales,
           COALESCE(ss.total_sales, 0) AS total_store_sales,
           COALESCE(cs.total_sales, 0) AS total_catalog_sales
    FROM customer c
    JOIN CustomerSales cs ON c.c_customer_sk = cs.c_customer_sk
    JOIN (
        SELECT c_customer_sk, SUM(total_sales) AS grand_total_sales
        FROM (
            SELECT ws_bill_customer_sk AS c_customer_sk, SUM(ws_net_paid) AS total_sales
            FROM web_sales
            GROUP BY ws_bill_customer_sk
            UNION ALL
            SELECT ss_customer_sk AS c_customer_sk, SUM(ss_net_paid) AS total_sales
            FROM store_sales
            GROUP BY ss_customer_sk
            UNION ALL
            SELECT cs_bill_customer_sk AS c_customer_sk, SUM(cs_net_paid) AS total_sales
            FROM catalog_sales
            GROUP BY cs_bill_customer_sk
        ) AS combined_sales
        GROUP BY c_customer_sk
        HAVING SUM(total_sales) > 1000
    ) total ON c.c_customer_sk = total.c_customer_sk
)

SELECT c.c_first_name,
       c.c_last_name,
       c.total_web_sales,
       c.total_store_sales,
       c.total_catalog_sales,
       ROW_NUMBER() OVER (ORDER BY c.total_web_sales DESC) AS web_sales_rank,
       COALESCE((SELECT AVG(ws_net_profit) FROM web_sales WHERE ws_bill_customer_sk = c.c_customer_sk), 0) AS avg_web_profit
FROM HighValueCustomers c
WHERE c.total_web_sales > c.total_store_sales
ORDER BY web_sales_rank
LIMIT 10;
