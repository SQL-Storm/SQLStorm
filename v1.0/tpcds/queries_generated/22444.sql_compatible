
WITH RECURSIVE address_hierarchy AS (
    SELECT ca_address_sk, ca_address_id, 
           ROW_NUMBER() OVER (PARTITION BY ca_country ORDER BY ca_city) AS row_num
    FROM customer_address
    WHERE ca_zip IS NOT NULL
), 
item_summary AS (
    SELECT i_item_sk, COUNT(DISTINCT ws_order_number) AS total_orders, 
           SUM(ws_sales_price) AS total_sales
    FROM web_sales
    JOIN item ON ws_item_sk = i_item_sk
    GROUP BY i_item_sk
), 
promo_analysis AS (
    SELECT p.p_promo_sk, p.p_discount_active, 
           COUNT(DISTINCT (CASE WHEN ws_order_number IS NOT NULL THEN ws_order_number END)) AS promo_order_count
    FROM promotion p
    LEFT JOIN web_sales ws ON p.p_promo_sk = ws.ws_promo_sk
    GROUP BY p.p_promo_sk, p.p_discount_active
)
SELECT 
    c.c_customer_id, 
    ca.ca_city, 
    ca.ca_state, 
    COALESCE(SUM(ss.ss_net_profit), CAST(0 AS NUMERIC)) AS total_store_profit,
    COALESCE(SUM(ws.ws_net_profit), CAST(0 AS NUMERIC)) AS total_web_profit,
    MAX(CASE WHEN cd.cd_gender = 'M' THEN cd.cd_dep_count ELSE NULL END) AS max_male_dependents,
    AVG(cd.cd_purchase_estimate) AS avg_purchase_estimate,
    CASE 
        WHEN SUM(inv.inv_quantity_on_hand) IS NULL THEN 'No Inventory' 
        ELSE 'Inventory Available' 
    END AS inventory_status,
    ROW_NUMBER() OVER (PARTITION BY ca.ca_country ORDER BY total_sales DESC) AS sales_rank,
    STRING_AGG(CASE WHEN p.p_discount_active = 'Y' THEN p.p_promo_name END, ', ') AS active_promotions
FROM customer c
LEFT JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
LEFT JOIN store_sales ss ON c.c_customer_sk = ss.ss_customer_sk
LEFT JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
LEFT JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
LEFT JOIN item_summary is ON ss.ss_item_sk = is.i_item_sk OR ws.ws_item_sk = is.i_item_sk
LEFT JOIN promo_analysis p ON p.p_promo_sk = COALESCE(ss.ss_promo_sk, ws.ws_promo_sk)
LEFT JOIN inventory inv ON ws.ws_item_sk = inv.inv_item_sk
WHERE ca.ca_country IS NOT NULL 
    AND (cd.cd_marital_status IS NULL OR cd.cd_marital_status = 'S')
GROUP BY c.c_customer_id, ca.ca_city, ca.ca_state, cd.cd_gender, total_sales, ca.ca_country
ORDER BY total_store_profit DESC, total_web_profit DESC
LIMIT 100;
