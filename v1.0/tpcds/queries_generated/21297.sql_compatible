
WITH RECURSIVE IncomeBandCTE AS (
    SELECT ib_income_band_sk, ib_lower_bound, ib_upper_bound
    FROM income_band
    WHERE ib_lower_bound >= (
        SELECT AVG(cd_purchase_estimate) 
        FROM customer_demographics 
        WHERE cd_demo_sk IN (
            SELECT c_current_cdemo_sk 
            FROM customer 
            WHERE c_current_addr_sk IS NOT NULL
        )
    )
    UNION ALL
    SELECT ib.ib_income_band_sk, ib.ib_lower_bound, ib.ib_upper_bound 
    FROM income_band ib
    JOIN IncomeBandCTE ibcte ON ib.ib_income_band_sk = ibcte.ib_income_band_sk + 1
    WHERE ib.ib_lower_bound < 200000
),
CustomerSales AS (
    SELECT 
        c.c_customer_sk,
        COALESCE(SUM(ws.ws_net_paid), 0) AS total_web_sales,
        COALESCE(SUM(cs.cs_net_paid), 0) AS total_catalog_sales,
        COALESCE(SUM(ss.ss_net_paid), 0) AS total_store_sales,
        COUNT(DISTINCT ws.ws_order_number) AS web_order_count,
        COUNT(DISTINCT cs.cs_order_number) AS catalog_order_count,
        COUNT(DISTINCT ss.ss_ticket_number) AS store_order_count
    FROM customer c
    LEFT JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
    LEFT JOIN catalog_sales cs ON c.c_customer_sk = cs.cs_bill_customer_sk
    LEFT JOIN store_sales ss ON c.c_customer_sk = ss.ss_customer_sk
    GROUP BY c.c_customer_sk
),
SalesSummary AS (
    SELECT 
        cs.c_customer_sk,
        cs.total_web_sales,
        cs.total_catalog_sales,
        cs.total_store_sales,
        ROW_NUMBER() OVER (PARTITION BY CASE 
            WHEN cs.total_web_sales > cs.total_catalog_sales AND cs.total_web_sales > cs.total_store_sales THEN 'web'
            WHEN cs.total_catalog_sales > cs.total_web_sales AND cs.total_catalog_sales > cs.total_store_sales THEN 'catalog'
            ELSE 'store'
        END ORDER BY cs.total_web_sales + cs.total_catalog_sales + cs.total_store_sales DESC) AS rank,
        CASE 
            WHEN cs.total_web_sales = 0 THEN 'No web sales'
            ELSE 'Web sales present'
        END AS web_sales_status
    FROM CustomerSales cs
)
SELECT 
    COALESCE(wp.wp_web_page_id, 'N/A') AS web_page_id,
    cs.c_customer_sk,
    cs.total_web_sales,
    cs.total_catalog_sales,
    cs.total_store_sales,
    ss.rank,
    ss.web_sales_status,
    ib.ib_lower_bound,
    ib.ib_upper_bound,
    CASE 
        WHEN ib.ib_income_band_sk IS NULL THEN 'Band not found'
        ELSE 'Income Band exists'
    END AS income_band_status
FROM SalesSummary ss
JOIN customer c ON ss.c_customer_sk = c.c_customer_sk
LEFT JOIN web_page wp ON wp.wp_customer_sk = c.c_customer_sk
LEFT JOIN IncomeBandCTE ib ON (ss.total_web_sales BETWEEN ib.ib_lower_bound AND ib.ib_upper_bound)
WHERE (ss.total_web_sales < 5000 OR ss.total_catalog_sales < 10000 OR ss.total_store_sales > 20000)
ORDER BY cs.total_web_sales DESC, ss.total_catalog_sales ASC, ss.rank, ib.ib_income_band_sk;
