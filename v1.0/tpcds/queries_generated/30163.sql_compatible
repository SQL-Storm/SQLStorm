
WITH RECURSIVE sales_hierarchy AS (
    SELECT 
        ws.subtotal,
        ws.order_number,
        ws.ws_sold_date_sk,
        ws.ws_ship_date_sk,
        (SELECT COUNT(*) FROM customer WHERE c_customer_sk = ws.bill_customer_sk) AS customer_count,
        0 AS level
    FROM web_sales ws
    WHERE ws.ws_sold_date_sk >= 20220101
    UNION ALL
    SELECT 
        ws.subtotal + sh.subtotal,
        ws.order_number,
        ws.ws_sold_date_sk,
        ws.ws_ship_date_sk,
        (SELECT COUNT(*) FROM customer WHERE c_customer_sk = ws.bill_customer_sk) AS customer_count,
        level + 1
    FROM web_sales ws
    JOIN sales_hierarchy sh ON ws.ws_order_number = sh.order_number
    WHERE ws.ws_sold_date_sk < sh.ws_sold_date_sk
),
max_sales AS (
    SELECT 
        MAX(ws_ext_sales_price) AS max_sales_price,
        MIN(ws_ext_sales_price) AS min_sales_price,
        AVG(ws_ext_sales_price) AS avg_sales_price,
        COUNT(DISTINCT ws_order_number) AS total_orders,
        SUM(ws_ext_sales_price) AS total_revenue
    FROM web_sales
),
current_sales AS (
    SELECT 
        ws_order_number,
        SUM(ws_ext_sales_price) AS total_sales,
        COUNT(ws_item_sk) AS total_items,
        (SELECT r.r_reason_desc 
         FROM reason r 
         WHERE r.r_reason_sk = ws.return_reason_sk) AS return_reason
    FROM web_sales ws
    LEFT JOIN store_returns sr ON ws.ws_order_number = sr.sr_ticket_number
    GROUP BY ws_order_number
)
SELECT 
    cust.c_first_name,
    cust.c_last_name,
    SUM(COALESCE(ws.ws_ext_sales_price, 0)) AS total_sales,
    MAX(ws.ws_sold_date_sk) AS last_purchase_date,
    MAX(CASE WHEN r.r_reason_desc IS NOT NULL THEN 'Returned' ELSE 'Not Returned' END) AS return_status,
    ROW_NUMBER() OVER (PARTITION BY cust.c_customer_sk ORDER BY SUM(ws.ws_ext_sales_price) DESC) AS sales_rank,
    (SELECT MAX(total_revenue) FROM max_sales) AS highest_revenue,
    COALESCE(SUM(CASE WHEN ws.ws_ship_mode_sk = sm.sm_ship_mode_sk THEN ws.ws_net_profit ELSE 0 END), 0) AS ship_mode_profit
FROM customer cust
LEFT JOIN web_sales ws ON cust.c_customer_sk = ws.ws_bill_customer_sk
LEFT JOIN reason r ON r.r_reason_sk = ws.return_reason_sk
LEFT JOIN ship_mode sm ON sm.sm_ship_mode_sk = ws.ws_ship_mode_sk
GROUP BY cust.c_customer_sk, cust.c_first_name, cust.c_last_name
HAVING SUM(COALESCE(ws.ws_ext_sales_price, 0)) > (SELECT AVG(avg_sales_price) FROM max_sales)
ORDER BY total_sales DESC
LIMIT 50;
