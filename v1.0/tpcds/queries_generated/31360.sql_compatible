
WITH RECURSIVE sales_summary AS (
    SELECT 
        w.w_warehouse_id,
        SUM(ss.ss_net_profit) AS total_profit,
        RANK() OVER (PARTITION BY w.w_warehouse_id ORDER BY SUM(ss.ss_net_profit) DESC) AS profit_rank,
        ROW_NUMBER() OVER (PARTITION BY w.w_warehouse_id ORDER BY SUM(ss.ss_net_profit) ASC) AS net_loss_rank
    FROM store_sales ss
    JOIN warehouse w ON ss.ss_store_sk = w.w_warehouse_sk
    WHERE ss.ss_sold_date_sk BETWEEN (SELECT MIN(d_date_sk) FROM date_dim) 
    AND (SELECT MAX(d_date_sk) FROM date_dim)
    GROUP BY w.w_warehouse_id
    UNION ALL
    SELECT 
        NULL AS w_warehouse_id,
        SUM(ss.ss_net_profit) AS total_profit,
        NULL AS profit_rank,
        NULL AS net_loss_rank
    FROM store_sales ss
    WHERE ss.ss_net_profit < 0
    GROUP BY ss.ss_customer_sk
), 
addr_summary AS (
    SELECT 
        ca.ca_city,
        COUNT(DISTINCT c.c_customer_sk) AS num_customers,
        MAX(c.c_birth_year) AS recent_birth_year
    FROM customer_address ca
    JOIN customer c ON ca.ca_address_sk = c.c_current_addr_sk
    GROUP BY ca.ca_city
)

SELECT 
    ss.w_warehouse_id,
    ss.total_profit,
    ss.profit_rank,
    aas.num_customers,
    aas.recent_birth_year
FROM sales_summary ss
LEFT JOIN addr_summary aas ON ss.w_warehouse_id IS NULL OR ss.w_warehouse_id = aas.num_customers
WHERE ss.total_profit IS NOT NULL
AND aas.num_customers IS NOT NULL
ORDER BY ss.total_profit DESC
LIMIT 10;
