
WITH RECURSIVE Sales_Analysis AS (
    SELECT ws_item_sk, 
           SUM(ws_quantity) AS total_quantity, 
           SUM(ws_sales_price) AS total_sales, 
           RANK() OVER (PARTITION BY ws_item_sk ORDER BY SUM(ws_sales_price) DESC) AS sales_rank
    FROM web_sales
    WHERE ws_sold_date_sk BETWEEN 2450000 AND 2459900
    GROUP BY ws_item_sk
), 
Filtered_Items AS (
    SELECT i.i_item_sk,
           i.i_item_desc,
           COALESCE(SA.total_sales, 0) AS sales_total
    FROM item i
    LEFT JOIN Sales_Analysis SA ON i.i_item_sk = SA.ws_item_sk
    WHERE i.i_rec_start_date <= DATE '2002-10-01' AND (i.i_rec_end_date IS NULL OR i.i_rec_end_date > DATE '2002-10-01')
)
SELECT 
    FI.i_item_sk,
    FI.i_item_desc,
    FI.sales_total,
    CD.cd_gender,
    SUM_SR.returned_quantity,
    (SELECT COUNT(*) 
     FROM customer c 
     WHERE c.c_birth_year > 1980 AND c.c_current_cdemo_sk IS NOT NULL) AS customer_count
FROM Filtered_Items FI
JOIN customer_demo CD ON CD.cd_demo_sk = (
    SELECT c.c_current_cdemo_sk 
    FROM customer c 
    WHERE c.c_current_addr_sk = (
        SELECT ca.ca_address_sk
        FROM customer_address ca 
        WHERE ca.ca_city = 'San Francisco' AND ca.ca_state = 'CA'
        LIMIT 1
    )
    LIMIT 1
)
LEFT JOIN (
    SELECT sr_item_sk, 
           SUM(sr_return_quantity) AS returned_quantity
    FROM store_returns
    GROUP BY sr_item_sk
) SUM_SR ON FI.i_item_sk = SUM_SR.sr_item_sk
GROUP BY FI.i_item_sk, FI.i_item_desc, FI.sales_total, CD.cd_gender, SUM_SR.returned_quantity
HAVING FI.sales_total > 1000
ORDER BY FI.sales_total DESC;
