WITH AddressStats AS (
    SELECT
        ca_state,
        COUNT(DISTINCT ca_address_sk) AS address_count,
        AVG(ca_gmt_offset) AS avg_gmt_offset,
        STRING_AGG(DISTINCT ca_city, ', ') AS cities
    FROM
        customer_address
    GROUP BY
        ca_state
),
CustomerStats AS (
    SELECT
        cd_gender,
        COUNT(DISTINCT c_customer_sk) AS customer_count,
        SUM(cd_dep_count) AS total_dependents,
        AVG(cd_purchase_estimate) AS avg_purchase_estimate
    FROM
        customer_demographics cd
    JOIN
        customer c ON cd.cd_demo_sk = c.c_current_cdemo_sk
    GROUP BY
        cd_gender
),
SalesStats AS (
    SELECT
        ws.web_site_id,
        SUM(ws_net_profit) AS total_net_profit,
        AVG(ws_sales_price) AS avg_sales_price,
        COUNT(DISTINCT ws_order_number) AS order_count
    FROM
        web_sales ws
    JOIN
        web_site w ON ws.ws_web_site_sk = w.web_site_sk
    GROUP BY
        ws.web_site_id
)
SELECT
    a.ca_state,
    a.address_count,
    a.avg_gmt_offset,
    a.cities,
    c.cd_gender,
    c.customer_count,
    c.total_dependents,
    c.avg_purchase_estimate,
    s.web_site_id,
    s.total_net_profit,
    s.avg_sales_price,
    s.order_count
FROM
    AddressStats a
JOIN
    CustomerStats c ON a.address_count > 0 
JOIN
    SalesStats s ON c.customer_count > 0 
ORDER BY
    a.ca_state, c.cd_gender, s.total_net_profit DESC;