
WITH RankedSales AS (
    SELECT 
        ws.web_site_sk,
        ws.ws_item_sk,
        SUM(ws.ws_quantity) AS total_quantity,
        SUM(ws.ws_net_paid) AS total_net_paid,
        ROW_NUMBER() OVER (PARTITION BY ws.web_site_sk ORDER BY SUM(ws.ws_net_paid) DESC) AS rank
    FROM web_sales ws
    JOIN item i ON ws.ws_item_sk = i.i_item_sk
    GROUP BY ws.web_site_sk, ws.ws_item_sk
),
FilteredSales AS (
    SELECT 
        ws.web_site_sk, 
        ws.ws_item_sk,
        ws.ws_order_number,
        ws.ws_net_paid,
        ws.ws_sales_price,
        CASE 
            WHEN i.i_color IS NULL THEN 'No Color'
            ELSE i.i_color 
        END AS item_color
    FROM web_sales ws
    JOIN item i ON ws.ws_item_sk = i.i_item_sk
    WHERE i.i_category IN (SELECT DISTINCT i.i_category FROM item WHERE i.i_brand = 'Brand A')
      AND ws.ws_net_paid IS NOT NULL
),
WebReturnStats AS (
    SELECT 
        wr.wr_returning_customer_sk,
        COUNT(DISTINCT wr.wr_order_number) AS total_returns,
        SUM(wr.wr_return_amt) AS total_return_amt
    FROM web_returns wr
    GROUP BY wr.wr_returning_customer_sk
),
SalesInfo AS (
    SELECT 
        f.web_site_sk,
        f.ws_item_sk,
        f.ws_order_number,
        f.ws_net_paid,
        r.total_return_amt,
        r.total_returns,
        CASE 
            WHEN r.total_returns IS NULL THEN 0
            ELSE (f.ws_net_paid - r.total_return_amt) / NULLIF(f.ws_net_paid, 0) * 100
        END AS net_return_percentage
    FROM FilteredSales f
    LEFT JOIN WebReturnStats r ON f.ws_order_number = r.wr_order_number
)
SELECT 
    si.web_site_sk,
    si.ws_item_sk,
    MAX(si.ws_net_paid) AS max_net_paid,
    SUM(si.net_return_percentage) AS cumulative_return_percentage,
    AVG(COALESCE(si.net_return_percentage, 0)) AS average_return_percentage
FROM SalesInfo si
JOIN RankedSales rs ON si.ws_item_sk = rs.ws_item_sk
WHERE rs.rank <= 5
GROUP BY si.web_site_sk, si.ws_item_sk
HAVING SUM(si.net_return_percentage) > 0 AND MAX(si.ws_net_paid) < 500
ORDER BY cumulative_return_percentage DESC;
