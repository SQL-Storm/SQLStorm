
WITH RECURSIVE sales_cte AS (
    SELECT 
        ws.web_site_id,
        SUM(ws.ws_net_profit) AS total_profit,
        ROW_NUMBER() OVER (PARTITION BY ws.web_site_sk ORDER BY SUM(ws.ws_net_profit) DESC) AS rank
    FROM 
        web_sales ws
    WHERE 
        ws.ws_sold_date_sk >= (SELECT d_date_sk FROM date_dim WHERE d_year = 2023 AND d_month_seq = 1)
        AND ws.ws_sold_date_sk <= (SELECT d_date_sk FROM date_dim WHERE d_year = 2023 AND d_month_seq = 12)
    GROUP BY 
        ws.web_site_id, ws.web_site_sk
),
top_sites AS (
    SELECT web_site_id, total_profit 
    FROM sales_cte 
    WHERE rank <= 10
),
customer_info AS (
    SELECT 
        c.c_customer_id,
        cd.cd_gender,
        cd.cd_marital_status,
        ca.ca_city, 
        SUM(ss.ss_net_paid) AS total_spent
    FROM 
        customer c
    JOIN 
        customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    LEFT JOIN 
        store_sales ss ON c.c_customer_sk = ss.ss_customer_sk
    JOIN 
        customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
    WHERE 
        cd.cd_marital_status IN ('M', 'S') 
        AND cd.cd_gender IS NOT NULL
    GROUP BY 
        c.c_customer_id, cd.cd_gender, cd.cd_marital_status, ca.ca_city
),
final_report AS (
    SELECT 
        ci.c_customer_id,
        ci.cd_gender,
        ci.cd_marital_status, 
        ci.ca_city, 
        ci.total_spent,
        CASE 
            WHEN ci.total_spent IS NULL THEN 'No Purchases'
            WHEN ci.total_spent < 100 THEN 'Low Spender'
            WHEN ci.total_spent BETWEEN 100 AND 500 THEN 'Medium Spender'
            ELSE 'High Spender'
        END AS spending_category,
        COUNT(DISTINCT ws.ws_order_number) AS order_count,
        COALESCE(NULLIF(SUM(ws.ws_ext_discount_amt), 0), 0) AS total_discount
    FROM 
        customer_info ci
    LEFT JOIN 
        web_sales ws ON ci.c_customer_id = ws.ws_bill_customer_sk
    GROUP BY 
        ci.c_customer_id, ci.cd_gender, ci.cd_marital_status, ci.ca_city, ci.total_spent
)
SELECT 
    fr.*, 
    ts.web_site_id
FROM 
    final_report fr
JOIN 
    top_sites ts ON fr.total_spent > 0
ORDER BY 
    fr.total_spent DESC, 
    fr.c_customer_id;
