WITH Total_Sales AS (
    SELECT 
        ws.ws_item_sk,
        SUM(ws.ws_sales_price * ws.ws_quantity) AS total_sales,
        SUM(ws.ws_ext_discount_amt) AS total_discount,
        COUNT(DISTINCT ws.ws_order_number) AS total_orders
    FROM web_sales ws
    JOIN date_dim dd ON ws.ws_sold_date_sk = dd.d_date_sk
    WHERE dd.d_year = 2000
    GROUP BY ws.ws_item_sk
), Customer_Info AS (
    SELECT 
        c.c_customer_sk,
        c.c_first_name,
        c.c_last_name,
        cd.cd_gender,
        cd.cd_marital_status,
        cd.cd_purchase_estimate
    FROM customer c
    JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
), Sales_Info AS (
    SELECT 
        ti.t_hour,
        ti.t_minute,
        SUM(ws.ws_ext_sales_price) AS total_ext_sales_price,
        SUM(ws.ws_qty) AS total_quantity_sold
    FROM web_sales ws
    JOIN time_dim ti ON ws.ws_sold_time_sk = ti.t_time_sk
    WHERE ws.ws_bill_customer_sk IN (SELECT c.c_customer_sk FROM customer c WHERE c.c_current_addr_sk IS NOT NULL)
    GROUP BY ti.t_hour, ti.t_minute
)
SELECT 
    ci.c_first_name,
    ci.c_last_name,
    ci.cd_gender,
    ci.cd_marital_status,
    ts.total_sales,
    ts.total_discount,
    ts.total_orders,
    si.total_ext_sales_price,
    si.total_quantity_sold
FROM Customer_Info ci
JOIN Total_Sales ts ON ci.c_customer_sk = (
    SELECT ws.ws_bill_customer_sk
    FROM web_sales ws
    WHERE ws.ws_item_sk = ts.ws_item_sk
    LIMIT 1
)
JOIN Sales_Info si ON EXTRACT(HOUR FROM si.t_hour) = EXTRACT(HOUR FROM cast('2002-10-01 12:34:56' as timestamp)) 
AND EXTRACT(MINUTE FROM si.t_minute) = EXTRACT(MINUTE FROM cast('2002-10-01 12:34:56' as timestamp))
ORDER BY ts.total_sales DESC, ci.c_last_name;