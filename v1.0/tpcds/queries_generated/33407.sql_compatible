
WITH RecursiveSales AS (
    SELECT 
        ws_item_sk,
        SUM(ws_quantity) AS total_quantity,
        SUM(ws_ext_sales_price) AS total_sales
    FROM 
        web_sales
    WHERE 
        ws_sold_date_sk BETWEEN 2458881 AND 2458883  
    GROUP BY 
        ws_item_sk

    UNION ALL

    SELECT 
        cs_item_sk,
        SUM(cs_quantity) AS total_quantity,
        SUM(cs_ext_sales_price) AS total_sales
    FROM 
        catalog_sales
    WHERE 
        cs_sold_date_sk BETWEEN 2458881 AND 2458883
    GROUP BY 
        cs_item_sk
),
SalesSummary AS (
    SELECT 
        item.i_item_id,
        COALESCE(ws.total_quantity, 0) AS web_quantity,
        COALESCE(cs.total_quantity, 0) AS catalog_quantity,
        COALESCE(ws.total_sales, 0) AS web_sales,
        COALESCE(cs.total_sales, 0) AS catalog_sales,
        (COALESCE(ws.total_sales, 0) + COALESCE(cs.total_sales, 0)) AS total_sales,
        ROUND((COALESCE(ws.total_sales, 0) + COALESCE(cs.total_sales, 0)) / NULLIF(SUM(COALESCE(ws.total_quantity, 0) + COALESCE(cs.total_quantity, 0)), 0), 2) AS avg_sales_per_unit
    FROM 
        item
    LEFT JOIN 
        (SELECT ws_item_sk, SUM(ws_quantity) AS total_quantity, SUM(ws_ext_sales_price) AS total_sales FROM web_sales GROUP BY ws_item_sk) AS ws 
        ON item.i_item_sk = ws.ws_item_sk
    LEFT JOIN 
        (SELECT cs_item_sk, SUM(cs_quantity) AS total_quantity, SUM(cs_ext_sales_price) AS total_sales FROM catalog_sales GROUP BY cs_item_sk) AS cs 
        ON item.i_item_sk = cs.cs_item_sk
    GROUP BY 
        item.i_item_id
),
AddressDetails AS (
    SELECT 
        ca_address_id,
        ca_city,
        ca_state,
        COUNT(DISTINCT c_customer_sk) AS customer_count
    FROM 
        customer_address
    JOIN 
        customer ON c_current_addr_sk = ca_address_sk
    GROUP BY 
        ca_address_id, ca_city, ca_state
)
SELECT 
    ss.i_item_id,
    ad.ca_address_id,
    ad.ca_city,
    ad.ca_state,
    ss.web_quantity,
    ss.catalog_quantity,
    ss.total_sales,
    ad.customer_count
FROM 
    SalesSummary ss
LEFT JOIN 
    AddressDetails ad ON ss.total_sales > 0  
ORDER BY 
    ss.total_sales DESC
LIMIT 100;
