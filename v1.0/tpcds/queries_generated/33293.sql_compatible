
WITH RECURSIVE SalesHierarchy AS (
    SELECT
        cs.bill_customer_sk,
        cs.item_sk,
        SUM(cs.net_profit) AS total_profit,
        1 AS level
    FROM
        catalog_sales cs
    GROUP BY
        cs.bill_customer_sk, cs.item_sk
    HAVING
        SUM(cs.net_profit) > 1000

    UNION ALL

    SELECT
        ws.bill_customer_sk,
        ws.item_sk,
        SUM(ws.net_profit) AS total_profit,
        sh.level + 1
    FROM
        web_sales ws
    JOIN
        SalesHierarchy sh ON ws.bill_customer_sk = sh.bill_customer_sk
    GROUP BY
        ws.bill_customer_sk, ws.item_sk, sh.level
    HAVING
        SUM(ws.net_profit) > 500
)
SELECT
    c.c_first_name,
    c.c_last_name,
    ch.item_sk,
    ch.total_profit,
    RANK() OVER (PARTITION BY ch.item_sk ORDER BY ch.total_profit DESC) AS profit_rank,
    DENSE_RANK() OVER (ORDER BY ch.total_profit DESC) AS dense_profit_rank
FROM
    SalesHierarchy ch
JOIN
    customer c ON ch.bill_customer_sk = c.c_customer_sk
WHERE
    c.c_birth_year IS NOT NULL
    AND ch.total_profit IS NOT NULL
ORDER BY
    profit_rank, c.c_last_name;
