
WITH RECURSIVE sales_hierarchy AS (
    SELECT
        ss_store_sk,
        SUM(ss_ext_sales_price) AS total_sales,
        1 AS level
    FROM
        store_sales
    GROUP BY
        ss_store_sk
    UNION ALL
    SELECT
        s.s_store_sk,
        SUM(ss.ss_ext_sales_price) AS total_sales,
        sh.level + 1
    FROM
        sales_hierarchy sh
        JOIN store s ON sh.ss_store_sk = s.s_store_sk
        JOIN store_sales ss ON ss.ss_store_sk = s.s_store_sk
    WHERE
        sh.level < 5
    GROUP BY
        s.s_store_sk, sh.level
),
promotions AS (
    SELECT
        p.p_promo_id,
        SUM(cs.cs_ext_sales_price) AS promo_sales
    FROM
        catalog_sales cs
        JOIN promotion p ON cs.cs_promo_sk = p.p_promo_sk
    GROUP BY
        p.p_promo_id
),
null_sales AS (
    SELECT
        COALESCE(NULLIF(ss.ss_net_profit, 0), 0) AS adjusted_profit,
        ss.ss_item_sk
    FROM
        store_sales ss
    WHERE
        ss.ss_sold_date_sk = (
            SELECT MAX(ss2.ss_sold_date_sk)
            FROM store_sales ss2
        )
        AND ss.ss_net_profit IS NULL
)
SELECT
    d.d_date,
    ca.ca_city,
    SUM(ws.ws_ext_sales_price) AS total_web_sales,
    AVG(CASE WHEN cd.cd_marital_status = 'M' THEN ws.ws_net_paid ELSE NULL END) AS avg_sales_married,
    MAX(ws.ws_ext_discount_amt) AS max_discount,
    MIN(ss.ss_ext_sales_price) AS min_store_sales,
    SUM(ph.promo_sales) AS total_promo_sales,
    COUNT(DISTINCT(ws.ws_order_number)) AS unique_sales_count,
    COUNT(DISTINCT ns.ss_item_sk) AS null_sales_count,
    ROW_NUMBER() OVER (PARTITION BY ca.ca_state ORDER BY SUM(ws.ws_ext_sales_price) DESC) AS state_rank
FROM
    web_sales ws
    JOIN customer_address ca ON ws.ws_bill_addr_sk = ca.ca_address_sk
    LEFT JOIN customer_demographics cd ON ws.ws_bill_cdemo_sk = cd.cd_demo_sk
    JOIN date_dim d ON ws.ws_sold_date_sk = d.d_date_sk
    LEFT JOIN promotions ph ON ws.ws_order_number = ph.p_promo_id
    JOIN sales_hierarchy sh ON ws.ws_ship_addr_sk = sh.ss_store_sk
    LEFT JOIN null_sales ns ON ws.ws_item_sk = ns.ss_item_sk
WHERE
    d.d_year = 2000
    AND d.d_moy IN (5, 6) 
GROUP BY
    d.d_date, ca.ca_city, sh.ss_store_sk, ph.promo_sales, ws.ws_net_paid
HAVING
    SUM(ws.ws_ext_sales_price) > 10000
ORDER BY
    total_web_sales DESC;
