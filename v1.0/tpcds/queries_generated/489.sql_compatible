
WITH Sales AS (
    SELECT 
        ws_sold_date_sk,
        ws_item_sk,
        SUM(ws_quantity) AS total_quantity,
        SUM(ws_net_paid) AS total_sales,
        COUNT(ws_order_number) AS order_count
    FROM 
        web_sales
    GROUP BY 
        ws_sold_date_sk, ws_item_sk
),
returns AS (
    SELECT 
        wr_item_sk,
        SUM(wr_return_quantity) AS total_returns,
        SUM(wr_return_amt) AS total_return_amount
    FROM 
        web_returns
    GROUP BY 
        wr_item_sk
),
customer_info AS (
    SELECT 
        c.c_customer_sk,
        cd.cd_gender,
        cd.cd_marital_status,
        hd.hd_income_band_sk,
        hd.hd_buy_potential
    FROM 
        customer c
    LEFT JOIN 
        customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    LEFT JOIN 
        household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk
),
item_details AS (
    SELECT 
        i_item_sk,
        i_item_desc,
        i_brand,
        i_category
    FROM 
        item
)
SELECT 
    i.i_item_desc,
    i.i_brand,
    i.i_category,
    COALESCE(s.total_quantity, 0) AS total_quantity_sold,
    COALESCE(s.total_sales, 0) AS total_sales_amount,
    COALESCE(r.total_returns, 0) AS total_returns,
    COALESCE(r.total_return_amount, 0) AS total_return_value,
    COUNT(DISTINCT ci.c_customer_sk) AS unique_customer_count,
    COUNT(DISTINCT ci.cd_marital_status) AS distinct_marital_status_count
FROM 
    item_details i
LEFT JOIN 
    Sales s ON i.i_item_sk = s.ws_item_sk
LEFT JOIN 
    returns r ON i.i_item_sk = r.wr_item_sk
LEFT JOIN 
    customer_info ci ON i.i_item_sk IN (SELECT ws_item_sk FROM web_sales WHERE ws_net_paid > 0)
GROUP BY 
    i.i_item_desc, i.i_brand, i.i_category, s.total_quantity, s.total_sales, r.total_returns, r.total_return_amount, ci.c_customer_sk, ci.cd_marital_status
HAVING 
    (COALESCE(s.total_sales, 0) - COALESCE(r.total_return_amount, 0)) > 1000
ORDER BY 
    total_sales_amount DESC
FETCH FIRST 100 ROWS ONLY;
