
WITH demographics AS (
    SELECT 
        cd_demo_sk,
        cd_gender,
        cd_marital_status,
        cd_education_status,
        cd_purchase_estimate,
        cd_credit_rating,
        LEAST(cd_dep_count, cd_dep_employed_count) AS min_deps
    FROM customer_demographics
    WHERE cd_purchase_estimate IS NOT NULL
    AND (cd_gender = 'M' OR cd_gender = 'F')
),
customer_info AS (
    SELECT 
        c.c_customer_sk,
        c.c_first_name,
        c.c_last_name,
        da.ca_city,
        da.ca_state,
        da.ca_country,
        d.d_year,
        COUNT(DISTINCT s.ss_ticket_number) AS total_sales,
        SUM(s.ss_net_profit) AS total_profit,
        ROW_NUMBER() OVER (PARTITION BY da.ca_state ORDER BY SUM(s.ss_net_profit) DESC) AS state_rank
    FROM customer c
    LEFT JOIN customer_address da ON c.c_current_addr_sk = da.ca_address_sk
    LEFT JOIN store_sales s ON c.c_customer_sk = s.ss_customer_sk
    JOIN demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    LEFT JOIN date_dim d ON s.ss_sold_date_sk = d.d_date_sk
    GROUP BY c.c_customer_sk, c.c_first_name, c.c_last_name, da.ca_city, da.ca_state, da.ca_country, d.d_year
),
high_value_customers AS (
    SELECT 
        customer_info.*,
        CASE 
            WHEN total_profit > 1000 THEN 'High Value'
            WHEN total_profit BETWEEN 500 AND 1000 THEN 'Medium Value'
            ELSE 'Low Value'
        END AS value_category
    FROM customer_info
    WHERE total_sales > (
        SELECT AVG(total_sales)
        FROM customer_info
    )
)
SELECT 
    hvc.c_first_name,
    hvc.c_last_name,
    hvc.ca_city,
    hvc.ca_state,
    hvc.value_category,
    SUM(s.ws_net_profit) AS total_web_sales,
    COUNT(DISTINCT s.ws_order_number) AS web_orders,
    MAX(hvc.total_profit) AS max_profit,
    COALESCE(NULLIF(CAST(hvc.total_sales AS VARCHAR(255)), '0'), 'No sales') AS sales_info
FROM high_value_customers hvc
LEFT JOIN web_sales s ON hvc.c_customer_sk = s.ws_ship_customer_sk
WHERE hvc.state_rank <= 5
GROUP BY hvc.c_first_name, hvc.c_last_name, hvc.ca_city, hvc.ca_state, hvc.value_category
ORDER BY total_web_sales DESC, max_profit DESC
LIMIT 20;
