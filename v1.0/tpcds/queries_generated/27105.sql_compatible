
WITH CustomerDetails AS (
    SELECT 
        c.c_customer_sk,
        CONCAT(c.c_first_name, ' ', c.c_last_name) AS full_name,
        cd.cd_gender,
        cd.cd_marital_status,
        cd.cd_education_status,
        ca.ca_city,
        ca.ca_state,
        ca.ca_zip
    FROM 
        customer c
    JOIN 
        customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    JOIN 
        customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
),
AddressSummary AS (
    SELECT 
        ca.city AS ca_city,
        ca.state AS ca_state,
        COUNT(*) AS customer_count,
        STRING_AGG(CONCAT(full_name, ' ', cd_gender, ' ', cd_marital_status) ORDER BY full_name) AS customer_details
    FROM 
        CustomerDetails
    GROUP BY 
        ca.city, ca.state
),
StateSummary AS (
    SELECT 
        ca_state,
        SUM(customer_count) AS total_customers,
        MAX(customer_count) AS max_customers_per_city,
        MIN(customer_count) AS min_customers_per_city,
        AVG(customer_count) AS avg_customers_per_city
    FROM 
        AddressSummary
    GROUP BY 
        ca_state
)
SELECT 
    ss.ca_state,
    ss.total_customers,
    ss.max_customers_per_city,
    ss.min_customers_per_city,
    ss.avg_customers_per_city,
    STRING_AGG(as.customer_details, '; ') AS city_customer_details
FROM 
    StateSummary ss
JOIN 
    AddressSummary as ON ss.ca_state = as.ca_state
GROUP BY 
    ss.ca_state, 
    ss.total_customers, 
    ss.max_customers_per_city, 
    ss.min_customers_per_city, 
    ss.avg_customers_per_city
ORDER BY 
    ss.total_customers DESC;
