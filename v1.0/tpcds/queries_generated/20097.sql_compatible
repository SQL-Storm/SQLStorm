
WITH ranked_sales AS (
    SELECT 
        ws.web_site_id,
        SUM(ws.ws_quantity) AS total_quantity,
        SUM(ws.ws_net_profit) AS total_net_profit,
        RANK() OVER (PARTITION BY ws.web_site_id ORDER BY SUM(ws.ws_net_profit) DESC) AS profit_rank,
        COUNT(*) FILTER(WHERE ws.ws_sales_price IS NULL OR ws.ws_sales_price < 0) AS negative_sales_count
    FROM 
        web_sales ws
    JOIN 
        customer c ON ws.ws_bill_customer_sk = c.c_customer_sk
    WHERE 
        c.c_birth_year IS NOT NULL
        AND c.c_birth_month IS NOT NULL
    GROUP BY 
        ws.web_site_id
),
high_performers AS (
    SELECT 
        r.web_site_id,
        r.total_net_profit,
        r.total_quantity,
        COALESCE(NULLIF(r.profit_rank, 1), 'Not Top Performer') AS performance_status
    FROM 
        ranked_sales r
    WHERE 
        r.profit_rank <= 5
),
all_sales_data AS (
    SELECT 
        w.web_site_id,
        COALESCE(h.total_net_profit, 0) AS total_net_profit,
        COALESCE(h.total_quantity, 0) AS total_quantity,
        (CASE 
            WHEN h.total_quantity = 0 THEN NULL 
            ELSE (h.total_net_profit / NULLIF(h.total_quantity, 0)) 
        END) AS avg_net_profit_per_item,
        h.performance_status
    FROM 
        (SELECT DISTINCT web_site_id FROM web_site) w
    LEFT JOIN 
        high_performers h ON w.web_site_id = h.web_site_id
)
SELECT 
    a.web_site_id,
    a.total_net_profit,
    a.total_quantity,
    ROUND(a.avg_net_profit_per_item, 2) AS avg_net_profit_per_item,
    a.performance_status,
    p.p_promo_name,
    COUNT(DISTINCT ws.ws_order_number) AS order_count
FROM 
    all_sales_data a
LEFT JOIN 
    promotion p ON a.total_net_profit > (SELECT AVG(total_net_profit) FROM all_sales_data) * 0.5
LEFT JOIN 
    web_sales ws ON a.web_site_id = ws.ws_web_site_sk
GROUP BY 
    a.web_site_id, a.total_net_profit, a.total_quantity, a.avg_net_profit_per_item, a.performance_status, p.p_promo_name
HAVING 
    (a.avg_net_profit_per_item IS NOT NULL AND a.total_quantity > 10)
    OR (a.performance_status != 'Not Top Performer' AND a.total_net_profit > 1000)
ORDER BY 
    a.performance_status DESC, a.total_net_profit DESC;
