
WITH RECURSIVE SalesCTE AS (
    SELECT 
        ws_order_number,
        SUM(ws_quantity) AS total_quantity,
        SUM(ws_net_profit) AS total_net_profit,
        ROW_NUMBER() OVER (ORDER BY SUM(ws_net_profit) DESC) AS rn
    FROM web_sales
    GROUP BY ws_order_number
    HAVING SUM(ws_net_profit) > 100
), CustomerReturns AS (
    SELECT 
        wr_returning_customer_sk,
        COUNT(*) AS total_returns,
        SUM(wr_return_amt) AS total_return_amount,
        AVG(wr_return_quantity) AS avg_return_quantity
    FROM web_returns
    GROUP BY wr_returning_customer_sk
    HAVING COUNT(*) > 10
)
SELECT 
    c.c_customer_id,
    c.c_first_name,
    c.c_last_name,
    COALESCE(cr.total_returns, 0) AS total_returns,
    COALESCE(cr.total_return_amount, 0) AS total_return_amount,
    COALESCE(cr.avg_return_quantity, 0) AS avg_return_quantity,
    COALESCE(s.total_quantity, 0) AS total_quantity,
    COALESCE(s.total_net_profit, 0) AS total_net_profit,
    CASE 
        WHEN COALESCE(s.total_net_profit, 0) > 500 THEN 'High Profiler'
        WHEN COALESCE(s.total_net_profit, 0) > 100 THEN 'Medium Profiler'
        ELSE 'Low Profiler'
    END AS customer_profiler
FROM customer c
LEFT JOIN CustomerReturns cr ON c.c_customer_sk = cr.wr_returning_customer_sk
LEFT JOIN SalesCTE s ON s.ws_order_number IN (SELECT ws_order_number FROM web_sales WHERE ws_bill_customer_sk = c.c_customer_sk)
WHERE (c.c_birth_year BETWEEN 1980 AND 2000 OR c.c_preferred_cust_flag = 'Y')
ORDER BY total_net_profit DESC, total_quantity DESC
LIMIT 100;
