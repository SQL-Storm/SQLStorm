WITH RECURSIVE CustomerReturnStats AS (
    SELECT 
        c.c_customer_sk,
        COALESCE(SUM(sr_return_quantity), 0) AS total_return_quantity,
        COALESCE(SUM(sr_return_amt), 0) AS total_return_amt,
        COALESCE(SUM(sr_return_tax), 0) AS total_return_tax,
        ROW_NUMBER() OVER (PARTITION BY c.c_customer_sk ORDER BY SUM(sr_return_quantity) DESC) AS rn
    FROM 
        customer c
    LEFT JOIN 
        store_returns sr ON c.c_customer_sk = sr.sr_customer_sk
    GROUP BY 
        c.c_customer_sk
),
HighValueCustomers AS (
    SELECT 
        c.c_customer_sk, 
        c.c_first_name, 
        c.c_last_name,
        cs.total_return_amt,
        DENSE_RANK() OVER (ORDER BY cs.total_return_amt DESC) AS customer_rank
    FROM 
        customer c
    JOIN 
        CustomerReturnStats cs ON c.c_customer_sk = cs.c_customer_sk
    WHERE
        cs.total_return_amt > (SELECT AVG(total_return_amt) FROM CustomerReturnStats)
)
SELECT 
    c.c_customer_sk,
    c.c_first_name,
    c.c_last_name,
    (CASE 
        WHEN hvc.customer_rank IS NOT NULL THEN 'High-Value'
        ELSE 'Standard'
     END) AS customer_type,
    (SELECT COUNT(*) 
     FROM 
         web_sales ws 
     WHERE 
         ws.ws_bill_customer_sk = c.c_customer_sk 
         AND ws.ws_sold_date_sk BETWEEN d.d_date_sk AND d.d_date_sk + INTERVAL '30 days') AS sales_count_next_month,
    STRING_AGG(DISTINCT CONCAT(wp.wp_url, ' (', wp.wp_type, ')'), ', ') AS web_pages_visited,
    d.d_date AS return_date
FROM 
    date_dim d
LEFT JOIN 
    customer c ON c.c_birth_day = (SELECT MAX(c_birth_day) FROM customer) 
LEFT JOIN 
    HighValueCustomers hvc ON c.c_customer_sk = hvc.c_customer_sk
LEFT JOIN 
    web_page wp ON wp.wp_customer_sk = c.c_customer_sk
WHERE 
    d.d_date = (SELECT MAX(d_date) FROM date_dim WHERE d_dow = 5 AND d_month_seq = 22) 
GROUP BY 
    c.c_customer_sk, c.c_first_name, c.c_last_name, hvc.customer_rank, d.d_date
HAVING 
    SUM(CASE WHEN c.c_birth_country IS NULL THEN 1 ELSE 0 END) > 2
ORDER BY 
    c.c_last_name, c.c_first_name
LIMIT 10 OFFSET 5;