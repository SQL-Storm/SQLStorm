
WITH RankedSales AS (
    SELECT
        ws.web_site_sk,
        ws.order_number,
        ws.quantity,
        ws.net_paid,
        RANK() OVER (PARTITION BY ws.web_site_sk ORDER BY ws.net_paid DESC) AS sales_rank
    FROM
        web_sales ws
    WHERE
        ws.sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_year = 2023)
),
TopSellingItems AS (
    SELECT
        i.i_item_id,
        SUM(COALESCE(ws.quantity, 0)) AS total_quantity_sold,
        SUM(COALESCE(ws.net_paid, 0)) AS total_net_paid
    FROM
        web_sales ws
    JOIN
        item i ON ws.ws_item_sk = i.i_item_sk
    WHERE
        ws.ws_sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_year = 2023)
    GROUP BY
        i.i_item_id
    ORDER BY
        total_net_paid DESC
    LIMIT 10
)
SELECT
    c.c_first_name,
    c.c_last_name,
    ca.ca_city,
    ca.ca_state,
    SUM(ws.quantity) AS total_quantity,
    SUM(ws.net_paid) AS total_net_paid
FROM
    customer c
LEFT JOIN
    customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
INNER JOIN
    web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
WHERE
    ws.ws_item_sk IN (SELECT i.i_item_sk FROM item i WHERE i.i_item_id IN (SELECT i.i_item_id FROM TopSellingItems))
GROUP BY
    c.c_customer_sk,
    c.c_first_name,
    c.c_last_name,
    ca.ca_city,
    ca.ca_state
HAVING
    SUM(ws.net_paid) > (SELECT AVG(total_net_paid) FROM TopSellingItems)
ORDER BY
    total_net_paid DESC;
