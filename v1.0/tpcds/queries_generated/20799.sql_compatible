
WITH RECURSIVE AddressRank AS (
    SELECT ca_address_sk, ca_city,
           ROW_NUMBER() OVER (PARTITION BY ca_city ORDER BY ca_address_sk) AS address_rank
    FROM customer_address
    WHERE ca_state IN ('CA', 'TX') 
),
CustomerInfo AS (
    SELECT c.c_customer_sk, c.c_first_name, c.c_last_name, c.c_email_address,
           cd.cd_gender, cd.cd_marital_status, cd.cd_purchase_estimate,
           COALESCE(hd.hd_buy_potential, 'Unknown') AS buy_potential
    FROM customer c
    LEFT JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    LEFT JOIN household_demographics hd ON c.c_current_hdemo_sk = hd.hd_demo_sk
),
SalesData AS (
    SELECT ws_bill_customer_sk, SUM(ws_sales_price) AS total_sales
    FROM web_sales
    GROUP BY ws_bill_customer_sk
    HAVING SUM(ws_sales_price) > 100
)
SELECT ci.c_first_name, ci.c_last_name, ci.c_email_address,
       ar.ca_city, COUNT(DISTINCT ar.address_rank) AS city_address_count,
       COALESCE(sd.total_sales, 0) AS total_sales_from_web,
       CASE
           WHEN ci.cd_gender = 'F' AND ci.cd_marital_status = 'M' THEN 'Female-Married'
           WHEN ci.cd_gender = 'F' AND ci.cd_marital_status = 'S' THEN 'Female-Single'
           ELSE 'Other'
       END AS demographic_category
FROM CustomerInfo ci
JOIN AddressRank ar ON ci.c_customer_sk = ar.ca_address_sk
LEFT JOIN SalesData sd ON ci.c_customer_sk = sd.ws_bill_customer_sk
WHERE ar.address_rank <= 5 
GROUP BY ci.c_first_name, ci.c_last_name, ci.c_email_address, ar.ca_city, sd.total_sales
HAVING COUNT(DISTINCT ar.address_rank) > 0
ORDER BY total_sales_from_web DESC, ci.c_last_name ASC;
