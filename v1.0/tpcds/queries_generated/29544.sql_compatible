
WITH AddressDetails AS (
    SELECT 
        ca_city,
        ca_state,
        ca_zip,
        CONCAT(ca_street_number, ' ', ca_street_name, ' ', ca_street_type) AS full_address,
        COUNT(*) AS address_count
    FROM customer_address
    WHERE ca_state IN ('CA', 'NY', 'TX')
    GROUP BY ca_city, ca_state, ca_zip, ca_street_number, ca_street_name, ca_street_type
),
CustomerDetails AS (
    SELECT 
        c.c_customer_sk,
        c.c_first_name,
        c.c_last_name,
        cd.cd_gender,
        cd.cd_marital_status,
        cd.cd_education_status,
        ad.full_address,
        ad.address_count
    FROM customer c
    JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    JOIN AddressDetails ad ON c.c_current_addr_sk = ad.ca_address_sk
),
StoreSummary AS (
    SELECT 
        s.s_store_sk,
        s.s_store_name,
        s.s_city,
        COUNT(ss.ticket_number) AS total_sales,
        SUM(ss.ss_net_paid) AS total_revenue
    FROM store s
    LEFT JOIN store_sales ss ON s.s_store_sk = ss.ss_store_sk
    GROUP BY s.s_store_sk, s.s_store_name, s.s_city
)
SELECT 
    cd.c_customer_sk,
    cd.c_first_name,
    cd.c_last_name,
    cd.cd_gender,
    cd.cd_marital_status,
    cd.cd_education_status,
    cd.full_address,
    ss.s_store_name,
    ss.s_city AS store_city,
    ss.total_sales,
    ss.total_revenue
FROM CustomerDetails cd
JOIN StoreSummary ss ON ss.total_sales > 0
ORDER BY cd.c_last_name, cd.c_first_name, ss.total_revenue DESC
FETCH FIRST 100 ROWS ONLY;
