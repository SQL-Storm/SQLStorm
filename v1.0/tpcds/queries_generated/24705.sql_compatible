
WITH RECURSIVE income_bracket AS (
    SELECT ib_income_band_sk, ib_lower_bound, ib_upper_bound 
    FROM income_band
    UNION ALL
    SELECT ib.ib_income_band_sk, ib.ib_lower_bound, ib.ib_upper_bound 
    FROM income_band ib
    INNER JOIN income_bracket ibr ON ib.ib_income_band_sk = ibr.ib_income_band_sk + 1
    WHERE ib.ib_lower_bound BETWEEN 0 AND 100000
),
customer_info AS (
    SELECT 
        c.c_customer_sk,
        c.c_customer_id,
        cd.cd_gender,
        cd.cd_marital_status,
        cd.cd_purchase_estimate,
        cd.cd_credit_rating,
        COALESCE(hd.hd_dep_count, 0) AS hd_dep_count,
        h.hd_income_band_sk,
        ROW_NUMBER() OVER (PARTITION BY c.c_customer_sk ORDER BY cd.cd_purchase_estimate DESC) AS rank
    FROM customer c
    LEFT JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    LEFT JOIN household_demographics hd ON hd.hd_demo_sk = c.c_current_hdemo_sk
    LEFT JOIN income_bracket ib ON ib.ib_income_band_sk = hd.hd_income_band_sk
),
sales_summary AS (
    SELECT 
        ws.ws_item_sk,
        SUM(ws.ws_quantity) AS total_quantity_sold,
        SUM(ws.ws_net_profit) AS total_net_profit,
        COUNT(DISTINCT ws.ws_order_number) AS unique_orders,
        ROW_NUMBER() OVER (PARTITION BY ws.ws_item_sk ORDER BY SUM(ws.ws_net_profit) DESC) AS profitability_rank
    FROM web_sales ws
    LEFT JOIN customer_info ci ON ci.c_customer_sk = ws.ws_bill_customer_sk
    WHERE ci.hd_dep_count IS NOT NULL AND ci.hd_dep_count >= 2
    GROUP BY ws.ws_item_sk
)
SELECT 
    ci.c_customer_id,
    cs.total_quantity_sold,
    cs.total_net_profit,
    ci.cd_gender,
    ci.cd_marital_status,
    CASE 
        WHEN ci.hd_dep_count >= 3 THEN 'High Priority' 
        WHEN ci.hd_dep_count BETWEEN 1 AND 2 THEN 'Low Priority' 
        ELSE 'No Dependents' 
    END AS priority_status,
    (SELECT AVG(total_net_profit) FROM sales_summary) AS average_profit,
    (SELECT COUNT(*) FROM sales_summary WHERE profitability_rank <= 5) AS top_profit_items
FROM customer_info ci
LEFT JOIN sales_summary cs ON ci.c_customer_sk = cs.ws_item_sk
WHERE (ci.cd_gender = 'F' AND ci.cd_marital_status = 'S') OR (ci.cd_gender = 'M' AND ci.cd_marital_status IS NULL)
GROUP BY 
    ci.c_customer_id,
    cs.total_quantity_sold,
    cs.total_net_profit,
    ci.cd_gender,
    ci.cd_marital_status,
    ci.hd_dep_count
ORDER BY cs.total_net_profit DESC, ci.c_customer_id
OFFSET 10 ROWS FETCH NEXT 20 ROWS ONLY;
