
WITH RECURSIVE AddressHierarchy AS (
    SELECT ca_address_sk, ca_city, ca_state, ca_country, 1 AS level
    FROM customer_address
    WHERE ca_city IS NOT NULL
    UNION ALL
    SELECT a.ca_address_sk, a.ca_city, a.ca_state, a.ca_country, ah.level + 1
    FROM customer_address a
    JOIN AddressHierarchy ah ON a.ca_state = ah.ca_state AND a.ca_country = ah.ca_country
    WHERE ah.level < 5
),
CustomerDemographics AS (
    SELECT cd_gender, COUNT(cd_demo_sk) AS demo_count, SUM(cd_dep_count) AS total_dependents
    FROM customer_demographics
    GROUP BY cd_gender
),
SalesMetrics AS (
    SELECT 
        ws_bill_customer_sk,
        SUM(ws_sales_price - ws_ext_discount_amt) AS total_sales,
        SUM(ws_quantity) AS total_items_sold,
        COUNT(DISTINCT ws_order_number) AS order_count,
        DENSE_RANK() OVER (PARTITION BY ws_bill_customer_sk ORDER BY SUM(ws_sales_price - ws_ext_discount_amt) DESC) AS sales_rank
    FROM web_sales
    GROUP BY ws_bill_customer_sk
),
ReturnedItems AS (
    SELECT 
        cr_item_sk,
        COUNT(cr_order_number) AS return_count,
        SUM(cr_return_amount) AS total_returned,
        SUM(cr_return_quantity) AS quantity_returned
    FROM catalog_returns
    GROUP BY cr_item_sk
)
SELECT 
    ah.ca_city,
    ah.ca_state,
    cd.cd_gender,
    sm.total_sales,
    sm.total_items_sold,
    sm.order_count,
    COALESCE(ri.return_count, 0) AS return_count,
    COALESCE(ri.total_returned, 0) AS total_returned,
    COALESCE(ri.quantity_returned, 0) AS quantity_returned
FROM AddressHierarchy ah
JOIN CustomerDemographics cd ON cd.total_dependents > 0
LEFT JOIN SalesMetrics sm ON sm.ws_bill_customer_sk IN (
    SELECT c_customer_sk
    FROM customer
    WHERE c_current_addr_sk IN (SELECT ca_address_sk FROM customer_address WHERE ca_city = ah.ca_city AND ca_state = ah.ca_state)
)
LEFT JOIN ReturnedItems ri ON ri.cr_item_sk IN (
    SELECT DISTINCT ws_item_sk 
    FROM web_sales 
    WHERE ws_bill_customer_sk = sm.ws_bill_customer_sk
)
WHERE (ah.level = 3 OR ah.level IS NULL)
    AND (cd.cd_gender = 'M' OR cd.cd_gender = 'F')
GROUP BY ah.ca_city, ah.ca_state, cd.cd_gender, sm.total_sales, sm.total_items_sold, sm.order_count, ri.return_count, ri.total_returned, ri.quantity_returned
ORDER BY ah.ca_city ASC, total_sales DESC
LIMIT 100;
