WITH RECURSIVE SalesHierarchy AS (
    SELECT 
        s_store_sk,
        SUM(ss_net_profit) AS total_profit,
        1 AS level
    FROM 
        store_sales
    WHERE 
        ss_sold_date_sk BETWEEN 2451545 AND 2451910  
    GROUP BY 
        s_store_sk
    
    UNION ALL
    
    SELECT 
        sh.s_store_sk,
        sh.total_profit,
        sh.level + 1
    FROM 
        SalesHierarchy sh
    JOIN 
        store s ON sh.s_store_sk = s.s_store_sk
    WHERE 
        s.s_number_employees > 50
), 
CustomerSales AS (
    SELECT 
        c.c_customer_id,
        SUM(ws.ws_net_profit) AS customer_profit
    FROM 
        customer c
    JOIN 
        web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
    GROUP BY 
        c.c_customer_id
), 
AverageSales AS (
    SELECT 
        AVG(customer_profit) AS avg_customer_profit
    FROM 
        CustomerSales
), 
HighestStores AS (
    SELECT 
        sh.s_store_sk,
        sh.total_profit,
        RANK() OVER (ORDER BY sh.total_profit DESC) AS profit_rank
    FROM 
        SalesHierarchy sh
)
SELECT 
    s.s_store_name,
    s.s_city,
    h.total_profit AS store_profit,
    CASE 
        WHEN h.total_profit > (SELECT avg_customer_profit FROM AverageSales) THEN 'Above Average'
        ELSE 'Below Average'
    END AS profit_comparison
FROM 
    HighestStores h
JOIN 
    store s ON h.s_store_sk = s.s_store_sk
WHERE 
    h.profit_rank <= 10
ORDER BY 
    store_profit DESC;