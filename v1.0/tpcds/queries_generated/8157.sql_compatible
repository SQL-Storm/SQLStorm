
WITH customer_summary AS (
    SELECT
        c.c_customer_sk,
        COUNT(DISTINCT sr.ticket_number) AS total_store_returns,
        COUNT(DISTINCT wr.order_number) AS total_web_returns,
        SUM(sr.return_quantity) AS total_return_quantity,
        SUM(sr.return_amt) AS total_return_amount,
        SUM(wr.return_quantity) AS total_web_return_quantity,
        SUM(wr.return_amt) AS total_web_return_amount
    FROM
        customer c
    LEFT JOIN
        store_returns sr ON c.c_customer_sk = sr.sr_customer_sk
    LEFT JOIN
        web_returns wr ON c.c_customer_sk = wr.wr_returning_customer_sk
    GROUP BY
        c.c_customer_sk
),
item_sales AS (
    SELECT
        ws.ws_item_sk,
        SUM(ws.ws_quantity) AS total_web_sales,
        SUM(ws.ws_net_profit) AS total_web_profit
    FROM
        web_sales ws
    GROUP BY
        ws.ws_item_sk
),
demographic_analysis AS (
    SELECT
        cd.cd_demo_sk,
        cd.cd_gender,
        cd.cd_marital_status,
        cd.cd_credit_rating,
        COUNT(DISTINCT c.c_customer_sk) AS total_customers,
        SUM(cs.cs_net_profit) AS total_catalog_sales,
        SUM(ss.ss_net_profit) AS total_store_sales
    FROM
        customer_demographics cd
    LEFT JOIN
        customer c ON cd.cd_demo_sk = c.c_current_cdemo_sk
    LEFT JOIN
        catalog_sales cs ON c.c_customer_sk = cs.cs_bill_customer_sk
    LEFT JOIN
        store_sales ss ON c.c_customer_sk = ss.ss_customer_sk
    GROUP BY
        cd.cd_demo_sk, cd.cd_gender, cd.cd_marital_status, cd.cd_credit_rating
)
SELECT
    dem.cd_demo_sk,
    dem.cd_gender,
    dem.cd_marital_status,
    dem.cd_credit_rating,
    dem.total_customers,
    sales.total_web_sales,
    sales.total_web_profit,
    summary.total_store_returns,
    summary.total_web_returns,
    summary.total_return_quantity,
    summary.total_return_amount,
    summary.total_web_return_quantity,
    summary.total_web_return_amount
FROM
    demographic_analysis dem
LEFT JOIN
    customer_summary summary ON dem.total_customers > 0
LEFT JOIN
    item_sales sales ON sales.ws_item_sk = 
        (SELECT ws_item_sk FROM web_sales ORDER BY ws_net_profit DESC LIMIT 1)
ORDER BY
    dem.total_customers DESC, sales.total_web_sales DESC;
