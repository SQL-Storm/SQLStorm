
WITH RECURSIVE SalesCTE AS (
    SELECT 
        ws_item_sk,
        SUM(ws_ext_sales_price) AS total_sales,
        ROW_NUMBER() OVER (PARTITION BY ws_item_sk ORDER BY ws_sold_date_sk DESC) AS rn
    FROM 
        web_sales
    GROUP BY 
        ws_item_sk
),
RecentSales AS (
    SELECT 
        s.i_item_sk,
        ws.total_sales,
        CASE 
            WHEN ws.total_sales IS NULL THEN 'No Sales'
            ELSE 'Sales Active'
        END AS sales_status
    FROM 
        SalesCTE ws
    JOIN 
        item s ON ws.ws_item_sk = s.i_item_sk
    WHERE 
        ws.rn = 1
),
TopItems AS (
    SELECT 
        item.i_item_id,
        item.i_item_desc,
        COALESCE(SUM(ss.ss_net_paid), 0) AS total_store_sales,
        COALESCE(SUM(ws.ws_net_paid), 0) AS total_web_sales
    FROM 
        item
    LEFT JOIN 
        store_sales ss ON item.i_item_sk = ss.ss_item_sk
    LEFT JOIN 
        web_sales ws ON item.i_item_sk = ws.ws_item_sk
    GROUP BY 
        item.i_item_id, item.i_item_desc
    ORDER BY 
        total_store_sales + total_web_sales DESC
    LIMIT 10
)
SELECT 
    rd.c_first_name,
    rd.c_last_name,
    rd.c_email_address,
    ti.i_item_id,
    ti.i_item_desc,
    ti.total_store_sales,
    ti.total_web_sales,
    ra.sales_status
FROM 
    RecentSales ra
JOIN 
    customer rd ON rd.c_current_cdemo_sk IS NOT NULL
JOIN 
    TopItems ti ON TRUE 
WHERE 
    rd.c_birth_year >= 1980
    AND (
        rd.c_first_shipto_date_sk IS NULL OR rd.c_first_sales_date_sk IS NOT NULL
    )
ORDER BY 
    rd.c_last_name, rd.c_first_name;
