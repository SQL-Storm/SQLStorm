
WITH monthly_sales AS (
    SELECT
        d.d_year,
        d.d_month_seq,
        SUM(ws.ws_ext_sales_price) AS total_sales,
        COUNT(DISTINCT ws.ws_order_number) AS order_count
    FROM
        web_sales ws
    JOIN
        date_dim d ON ws.ws_sold_date_sk = d.d_date_sk
    GROUP BY
        d.d_year,
        d.d_month_seq
),
income_distribution AS (
    SELECT 
        COALESCE(h.hd_income_band_sk, -1) AS income_band,
        SUM(ws.ws_ext_sales_price) AS total_sales
    FROM
        household_demographics h
    LEFT JOIN 
        web_sales ws ON ws.ws_bill_cdemo_sk = h.hd_demo_sk
    GROUP BY
        income_band
),
sales_by_date AS (
    SELECT 
        d.d_date AS sales_date,
        SUM(ws.ws_ext_sales_price) AS daily_sales,
        COUNT(DISTINCT ws.ws_order_number) AS daily_order_count
    FROM
        web_sales ws
    JOIN
        date_dim d ON ws.ws_sold_date_sk = d.d_date_sk
    GROUP BY
        d.d_date
),
top_days AS (
    SELECT 
        sales_date,
        daily_sales,
        RANK() OVER (ORDER BY daily_sales DESC) AS sales_rank
    FROM
        sales_by_date
)

SELECT 
    m.d_year,
    m.d_month_seq,
    COALESCE(i.income_band, 'Unknown') AS income_band,
    m.total_sales AS monthly_total_sales,
    i.total_sales AS income_band_sales,
    td.sales_date,
    td.daily_sales,
    td.sales_rank
FROM 
    monthly_sales m
LEFT JOIN 
    income_distribution i ON m.d_month_seq = i.income_band
JOIN 
    top_days td ON m.total_sales = (
        SELECT MAX(total_sales)
        FROM top_days
        WHERE sales_rank = 1
    )
WHERE
    m.total_sales > (SELECT AVG(total_sales) FROM monthly_sales)
ORDER BY 
    m.d_year, 
    m.d_month_seq, 
    td.sales_rank;
