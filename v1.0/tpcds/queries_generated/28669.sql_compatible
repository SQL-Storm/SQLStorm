
WITH AddressInfo AS (
    SELECT 
        ca_address_sk, 
        CONCAT(ca_street_number, ' ', ca_street_name, ' ', ca_street_type, 
               CASE WHEN ca_suite_number IS NOT NULL THEN CONCAT(' Suite ', ca_suite_number) ELSE '' END) AS full_address,
        ca_city, 
        ca_state, 
        ca_zip 
    FROM 
        customer_address
), 
CustomerInfo AS (
    SELECT 
        c_customer_sk, 
        CONCAT(c_salutation, ' ', c_first_name, ' ', c_last_name) AS full_name, 
        cd_gender, 
        cd_marital_status, 
        cd_purchase_estimate 
    FROM 
        customer 
    JOIN 
        customer_demographics ON c_current_cdemo_sk = cd_demo_sk
), 
WebSalesInfo AS (
    SELECT 
        ws_customer_sk, 
        COUNT(ws_order_number) AS total_orders, 
        SUM(ws_sales_price) AS total_sales 
    FROM 
        web_sales 
    GROUP BY 
        ws_customer_sk
) 
SELECT 
    ci.full_name, 
    ci.cd_gender, 
    ci.cd_marital_status, 
    ai.full_address, 
    ai.ca_city, 
    ai.ca_state, 
    ai.ca_zip, 
    COALESCE(wi.total_orders, 0) AS orders_count, 
    COALESCE(wi.total_sales, 0) AS sales_amount 
FROM 
    CustomerInfo ci 
JOIN 
    customer_address ca ON ca.ca_address_sk = ci.c_current_addr_sk 
JOIN 
    AddressInfo ai ON ai.ca_address_sk = ca.ca_address_sk 
LEFT JOIN 
    WebSalesInfo wi ON wi.ws_customer_sk = ci.c_customer_sk 
ORDER BY 
    sales_amount DESC, 
    ci.full_name ASC 
LIMIT 100;
