
WITH RECURSIVE Sales_Hierarchy AS (
    SELECT 
        ss_store_sk,
        ss_item_sk,
        ss_quantity,
        ss_net_paid,
        1 AS level
    FROM 
        store_sales
    WHERE 
        ss_sold_date_sk = (SELECT MAX(ss_sold_date_sk) FROM store_sales)
    
    UNION ALL
    
    SELECT 
        sh.ss_store_sk,
        sh.ss_item_sk,
        sh.ss_quantity + shier.ss_quantity,
        CASE WHEN shier.ss_net_paid IS NULL THEN sh.ss_net_paid ELSE shier.ss_net_paid + sh.ss_net_paid END,
        shier.level + 1
    FROM 
        store_sales sh
    JOIN 
        Sales_Hierarchy shier ON sh.ss_store_sk = shier.ss_store_sk AND sh.ss_item_sk = shier.ss_item_sk
    WHERE 
        shier.level < 5 
)
SELECT 
    ca.ca_state AS location,
    COUNT(DISTINCT c.c_customer_sk) AS total_customers,
    SUM(CASE WHEN cd.cd_gender = 'F' THEN 1 ELSE 0 END) AS female_customers,
    MAX(sh.ss_net_paid) AS highest_net_paid,
    AVG(sh.ss_quantity) AS average_quantity
FROM 
    Sales_Hierarchy sh
JOIN 
    customer c ON sh.ss_store_sk = c.c_customer_sk
LEFT JOIN 
    customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
JOIN 
    customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
WHERE 
    (sh.ss_net_paid > 100 OR sh.ss_quantity > 10) 
    AND cd.cd_marital_status IS NOT NULL
GROUP BY 
    ca.ca_state
HAVING 
    COUNT(DISTINCT c.c_customer_sk) > 10 
ORDER BY 
    total_customers DESC
LIMIT 10;
