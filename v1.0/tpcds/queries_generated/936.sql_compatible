
WITH RankedSales AS (
    SELECT 
        ws.web_site_id,
        ws.ws_order_number,
        ws.ws_sales_price,
        ws.ws_net_profit,
        ROW_NUMBER() OVER (PARTITION BY ws.web_site_id ORDER BY ws.ws_net_profit DESC) AS rnk
    FROM 
        web_sales ws
    JOIN 
        web_site w ON ws.ws_web_site_sk = w.web_site_sk
    WHERE 
        ws.ws_sold_date_sk IN (SELECT d_date_sk FROM date_dim WHERE d_year = 2023)
),
TopSales AS (
    SELECT 
        web_site_id,
        ws_order_number,
        ws_sales_price,
        ws_net_profit
    FROM 
        RankedSales
    WHERE 
        rnk <= 5
),
SalesStats AS (
    SELECT 
        ts.web_site_id,
        SUM(ts.ws_sales_price) AS total_sales,
        AVG(ts.ws_net_profit) AS avg_net_profit
    FROM 
        TopSales ts
    GROUP BY 
        ts.web_site_id
)
SELECT 
    w.web_name,
    ss.total_sales,
    ss.avg_net_profit,
    COALESCE((SELECT COUNT(DISTINCT c.c_customer_id) 
               FROM customer c 
               JOIN web_sales ws1 ON c.c_customer_sk = ws1.ws_bill_customer_sk 
               WHERE ws1.ws_web_page_sk IN (SELECT wp_web_page_sk FROM web_page WHERE wp_web_page_id LIKE '%promo%')), 0) AS customer_count
FROM 
    SalesStats ss
JOIN 
    web_site w ON ss.web_site_id = w.web_site_id
LEFT JOIN 
    (SELECT 
        ws1.ws_web_site_sk,
        COUNT(DISTINCT ws1.ws_order_number) AS total_orders
    FROM 
        web_sales ws1
    GROUP BY 
        ws1.ws_web_site_sk
    HAVING 
        SUM(ws1.ws_net_profit) > 10000) orders ON w.web_site_sk = orders.ws_web_site_sk
WHERE 
    ss.total_sales > 1000
ORDER BY 
    ss.total_sales DESC;
