
WITH RECURSIVE RevenueCTE AS (
    SELECT 
        s_store_sk,
        ss_sold_date_sk,
        SUM(ss_net_paid) AS total_revenue,
        1 AS level
    FROM 
        store_sales
    WHERE 
        ss_sold_date_sk >= (SELECT MIN(d_date_sk) FROM date_dim) 
        AND ss_sold_date_sk <= (SELECT MAX(d_date_sk) FROM date_dim)
    GROUP BY 
        s_store_sk, ss_sold_date_sk
    
    UNION ALL

    SELECT 
        s_store_sk,
        ss_sold_date_sk,
        total_revenue + SUM(ss_net_paid) OVER (PARTITION BY s_store_sk) AS total_revenue,
        level + 1
    FROM 
        RevenueCTE
    WHERE 
        ss_sold_date_sk > (SELECT MAX(ss_sold_date_sk) FROM store_sales WHERE ss_sold_date_sk < CURRENT_DATE)
        AND level < 5
)
SELECT 
    ca_state,
    COUNT(DISTINCT c_customer_sk) AS total_customers,
    AVG(total_revenue) AS avg_revenue,
    SUM(CASE WHEN cd_gender = 'F' THEN total_revenue ELSE 0 END) AS female_revenue,
    SUM(CASE WHEN cd_gender = 'M' THEN total_revenue ELSE 0 END) AS male_revenue
FROM 
    RevenueCTE r
LEFT JOIN 
    store s ON s.s_store_sk = r.s_store_sk
LEFT JOIN 
    customer c ON c.c_current_addr_sk = s.s_store_sk 
LEFT JOIN 
    customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
LEFT JOIN 
    customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
GROUP BY 
    ca_state
HAVING 
    COUNT(DISTINCT c_customer_sk) > 0
ORDER BY 
    ca_state;
