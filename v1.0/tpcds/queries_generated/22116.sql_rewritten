WITH RECURSIVE customer_hierarchy AS (
    SELECT c.c_customer_sk, c.c_first_name, c.c_last_name, c.c_current_cdemo_sk
    FROM customer c
    WHERE c.c_current_cdemo_sk IS NOT NULL
    
    UNION ALL
    
    SELECT c.c_customer_sk, c.c_first_name, c.c_last_name, c.c_current_cdemo_sk
    FROM customer c
    INNER JOIN customer_hierarchy ch ON c.c_current_cdemo_sk = ch.c_customer_sk
),
customer_address_count AS (
    SELECT ca.ca_address_sk, COUNT(DISTINCT c.c_customer_sk) AS customer_count
    FROM customer_address ca
    LEFT JOIN customer c ON ca.ca_address_sk = c.c_current_addr_sk
    GROUP BY ca.ca_address_sk
),
promotions_active AS (
    SELECT p.p_promo_sk, p.p_promo_name, 
           DATEDIFF(DATE(CONVERT_TZ(cast('2002-10-01 12:34:56' as timestamp), 'UTC', ca.ca_gmt_offset)), 
                    DATE(p.p_start_date_sk)) AS days_since_start
    FROM promotion p
    JOIN customer_address ca ON p.p_end_date_sk IS NULL
    WHERE p.p_discount_active = 'Y' AND 
          days_since_start >= 0
),
date_info AS (
    SELECT d.d_date_sk, d.d_year, d.d_month_seq, 
           ROW_NUMBER() OVER (PARTITION BY d.d_year ORDER BY d.d_month_seq) as month_order
    FROM date_dim d
),
sales_summary AS (
    SELECT ws.ws_item_sk, SUM(ws.ws_net_profit) AS total_profit,
           RANK() OVER (PARTITION BY ws.ws_item_sk ORDER BY SUM(ws.ws_net_profit) DESC) AS profit_rank
    FROM web_sales ws
    GROUP BY ws.ws_item_sk
)
SELECT c.c_first_name, c.c_last_name, ca.ca_city, ca.ca_state, 
       COALESCE(st.store_name, 'No Store') AS store_name,
       (SELECT COUNT(*) FROM customer_demographics cd 
        WHERE cd.cd_demo_sk = c.c_current_cdemo_sk AND cd.cd_gender = 'F') AS female_count,
       (SELECT MAX(total_profit) FROM sales_summary ss 
        WHERE ss.ws_item_sk = i.i_item_sk) AS max_profit,
       (SELECT COUNT(*) 
        FROM promotions_active pa 
        WHERE pa.p_promo_sk IN (SELECT p.p_promo_sk FROM promotion p 
                               WHERE p.p_item_sk = i.i_item_sk)) AS active_promotions
FROM customer_c AS c
LEFT JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
LEFT JOIN store st ON st.s_store_sk = (SELECT ss.s_store_sk 
                                         FROM store_sales ss 
                                         WHERE ss.ss_customer_sk = c.c_customer_sk 
                                         ORDER BY ss.ss_net_paid DESC 
                                         LIMIT 1)
INNER JOIN item i ON i.i_item_sk IN (SELECT DISTINCT ws.ws_item_sk 
                                      FROM web_sales ws 
                                      WHERE ws.ws_customer_sk = c.c_customer_sk)
LEFT JOIN date_info di ON di.d_date_sk = c.c_first_sales_date_sk
GROUP BY c.c_first_name, c.c_last_name, ca.ca_city, ca.ca_state, st.store_name, i.i_item_sk
HAVING MAX(coalesce((SELECT SUM(ws.ws_net_paid) 
                      FROM store_sales ws 
                      WHERE ws.ss_customer_sk = c.c_customer_sk), 0)) > 100;