
WITH RECURSIVE address_cte AS (
    SELECT ca_address_sk, ca_city, ca_state, ca_zip, ca_country,
           ROW_NUMBER() OVER (PARTITION BY ca_city ORDER BY ca_address_sk) AS rn
    FROM customer_address
    WHERE ca_state IN ('CA', 'NY') AND ca_country IS NOT NULL
), 
sales_data AS (
    SELECT ws_sold_date_sk, ws_item_sk, ws_ship_date_sk, ws_net_profit,
           SUM(ws_net_paid_inc_tax) OVER (PARTITION BY ws_item_sk ORDER BY ws_sold_date_sk ROWS BETWEEN 6 PRECEDING AND CURRENT ROW) AS running_total
    FROM web_sales
    WHERE ws_net_profit > 0
), 
customer_info AS (
    SELECT c_customer_sk, c_city, COUNT(DISTINCT cd_demo_sk) AS demo_count,
           SUM(CASE WHEN cd_gender = 'F' THEN 1 ELSE 0 END) AS female_count
    FROM customer
    LEFT JOIN customer_demographics ON c_current_cdemo_sk = cd_demo_sk
    GROUP BY c_customer_sk, c_city
), 
compound_query AS (
    SELECT ad.ca_city, ad.ca_state, COUNT(DISTINCT ci.c_customer_sk) AS customer_count,
           AVG(sd.running_total) AS avg_net_profit
    FROM address_cte ad
    LEFT JOIN customer_info ci ON ad.ca_city = ci.c_city
    LEFT JOIN sales_data sd ON sd.ws_sold_date_sk = (SELECT MAX(d_date_sk) FROM date_dim WHERE d_year = 2023 AND d_dow = 1)
    WHERE ad.rn <= 5
    GROUP BY ad.ca_city, ad.ca_state
)
SELECT ci.ca_city, 
       CASE 
           WHEN ci.customer_count IS NULL THEN 'No Customers' 
           ELSE CONCAT('Customers: ', ci.customer_count) 
       END AS customer_status,
       ci.avg_net_profit,
       CASE 
           WHEN ci.avg_net_profit IS NOT NULL AND ci.avg_net_profit > 1000 THEN 'High Profit' 
           ELSE 'Low Profit' 
       END AS profit_type
FROM compound_query ci
ORDER BY ci.ca_city ASC, ci.customer_count DESC
FETCH FIRST 10 ROWS ONLY;
