WITH AddressCounts AS (
    SELECT
        ca_state,
        COUNT(*) AS address_count,
        STRING_AGG(ca_city, '; ') AS cities,
        STRING_AGG(DISTINCT ca_street_name || ' ' || ca_street_number, '; ') AS street_details
    FROM
        customer_address
    GROUP BY
        ca_state
),
DemoStats AS (
    SELECT
        cd_gender,
        COUNT(*) AS demo_count,
        AVG(cd_purchase_estimate) AS avg_purchase_estimate,
        STRING_AGG(DISTINCT cd_education_status, '; ') AS education_levels
    FROM
        customer_demographics
    GROUP BY
        cd_gender
),
SalesSummary AS (
    SELECT
        YEAR(d_date) AS sales_year,
        SUM(ws_ext_sales_price) AS total_sales,
        SUM(ws_net_profit) AS total_profit,
        STRING_AGG(DISTINCT sm_carrier, '; ') AS shipping_methods
    FROM
        web_sales
    JOIN
        date_dim ON ws_sold_date_sk = d_date_sk
    JOIN
        ship_mode ON ws_ship_mode_sk = sm_ship_mode_sk
    GROUP BY
        YEAR(d_date)
)
SELECT
    ac.ca_state,
    ac.address_count,
    ac.cities,
    ac.street_details,
    ds.cd_gender,
    ds.demo_count,
    ds.avg_purchase_estimate,
    ds.education_levels,
    ss.sales_year,
    ss.total_sales,
    ss.total_profit,
    ss.shipping_methods
FROM
    AddressCounts ac
JOIN
    DemoStats ds ON ds.cd_gender IN ('M', 'F')  
JOIN
    SalesSummary ss ON ss.sales_year >= 1998;