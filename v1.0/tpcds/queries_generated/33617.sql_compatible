
WITH RECURSIVE customer_hierarchy AS (
    SELECT c.c_customer_sk, c.c_first_name, c.c_last_name,
           cd.cd_marital_status, cd.cd_gender, cd.cd_dep_count,
           cd.cd_purchase_estimate,
           (SELECT COUNT(*) 
            FROM store_sales ss 
            WHERE ss.ss_customer_sk = c.c_customer_sk) AS total_sales
    FROM customer c
    LEFT JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    WHERE c.c_birth_country = 'USA'
    
    UNION ALL
    
    SELECT c.c_customer_sk, c.c_first_name, c.c_last_name,
           cd.cd_marital_status, cd.cd_gender, cd.cd_dep_count,
           cd.cd_purchase_estimate,
           (SELECT COUNT(*) 
            FROM store_sales ss 
            WHERE ss.ss_customer_sk = c.c_customer_sk) AS total_sales
    FROM customer c
    JOIN customer_hierarchy ch ON c.c_current_cdemo_sk = ch.c_customer_sk
)
SELECT ch.c_first_name, 
       ch.c_last_name,
       ch.total_sales,
       CASE 
           WHEN ch.cd_marital_status = 'S' THEN 'Single'
           WHEN ch.cd_marital_status = 'M' THEN 'Married'
           ELSE 'Unknown' 
       END AS marital_status,
       COUNT(DISTINCT wr.wr_order_number) AS online_returns,
       AVG(ws.ws_ext_sales_price) AS avg_sales_price,
       SUM(ws.ws_ext_discount_amt) AS total_discount
FROM customer_hierarchy ch
LEFT JOIN web_returns wr ON wr.returned_date_sk = (SELECT d_date_sk 
                                                    FROM date_dim 
                                                    WHERE d_date = DATE '2002-10-01')
LEFT JOIN web_sales ws ON ws.ws_ship_customer_sk = ch.c_customer_sk
GROUP BY ch.c_first_name, 
         ch.c_last_name, 
         ch.cd_marital_status,
         ch.total_sales
HAVING SUM(ws.ws_ext_sales_price) > 1000
ORDER BY total_sales DESC
LIMIT 10;
