
WITH CustomerInfo AS (
    SELECT 
        c.c_customer_sk,
        CONCAT(c.c_salutation, ' ', c.c_first_name, ' ', c.c_last_name) AS FullName,
        ca.ca_city,
        ca.ca_state,
        cd.cd_gender,
        cd.cd_marital_status,
        cd.cd_education_status,
        cd.cd_income_band_sk,
        cd.cd_purchase_estimate
    FROM 
        customer c
    JOIN 
        customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
    JOIN 
        customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
),
StateGenderSummary AS (
    SELECT 
        ca_state,
        cd_gender,
        COUNT(*) AS CustomerCount,
        AVG(cd_purchase_estimate) AS AvgPurchaseEstimate
    FROM 
        CustomerInfo
    GROUP BY 
        ca_state, 
        cd_gender
),
StateGenderDetails AS (
    SELECT 
        ca_state AS state,
        cd_gender AS gender,
        CustomerCount,
        AvgPurchaseEstimate,
        CONCAT(cd_gender, ' Customers in ', ca_state) AS Description
    FROM 
        StateGenderSummary
)
SELECT 
    Description,
    CustomerCount,
    AvgPurchaseEstimate,
    SUBSTRING(Description, 1, 30) AS ShortDescription
FROM 
    StateGenderDetails
WHERE 
    CustomerCount > 10
ORDER BY 
    state, gender;
