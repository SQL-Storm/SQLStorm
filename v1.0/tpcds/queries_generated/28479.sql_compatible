
WITH address_summary AS (
    SELECT 
        ca_state,
        COUNT(*) AS total_addresses,
        STRING_AGG(ca_city, ', ') AS cities,
        STRING_AGG(DISTINCT ca_street_type, ', ') AS street_types,
        STRING_AGG(DISTINCT ca_street_name, ', ') AS street_names
    FROM 
        customer_address
    GROUP BY 
        ca_state
),
demographics_summary AS (
    SELECT 
        cd_gender,
        cd_marital_status,
        COUNT(*) AS demographic_count,
        AVG(cd_purchase_estimate) AS avg_purchase_estimate,
        AVG(cd_dep_count) AS avg_dep_count
    FROM 
        customer_demographics
    GROUP BY 
        cd_gender, cd_marital_status
),
sales_summary AS (
    SELECT 
        ws_bill_addr_sk,
        SUM(ws_ext_sales_price) AS total_sales,
        AVG(ws_net_profit) AS avg_net_profit
    FROM 
        web_sales
    WHERE 
        ws_sold_date_sk >= (SELECT MIN(d_date_sk) FROM date_dim) AND 
        ws_sold_date_sk <= (SELECT MAX(d_date_sk) FROM date_dim)
    GROUP BY 
        ws_bill_addr_sk
)
SELECT 
    a.ca_state,
    a.total_addresses,
    a.cities,
    a.street_types,
    a.street_names,
    d.cd_gender,
    d.cd_marital_status,
    d.demographic_count,
    d.avg_purchase_estimate,
    d.avg_dep_count,
    s.total_sales,
    s.avg_net_profit
FROM 
    address_summary a
JOIN 
    demographics_summary d ON RANDOM() < 0.05
LEFT JOIN 
    sales_summary s ON a.ca_address_sk = s.ws_bill_addr_sk
ORDER BY 
    a.total_addresses DESC, d.demographic_count DESC;
