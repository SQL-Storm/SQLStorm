
WITH CTE_SalesData AS (
    SELECT 
        ws.web_site_id,
        SUM(ws.ws_ext_sales_price) AS total_sales,
        COUNT(DISTINCT ws.ws_order_number) AS total_orders,
        AVG(ws.ws_net_profit) AS average_profit
    FROM web_sales ws
    JOIN customer c ON ws.ws_bill_customer_sk = c.c_customer_sk
    LEFT JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    WHERE ws.ws_sold_date_sk >= (SELECT MAX(d.d_date_sk) - 30 FROM date_dim d)
    AND cd.cd_gender = 'F'
    GROUP BY ws.web_site_id
),
CTE_InventoryLevels AS (
    SELECT 
        i.i_item_sk,
        SUM(inv.inv_quantity_on_hand) AS total_inventory
    FROM inventory inv
    JOIN item i ON inv.inv_item_sk = i.i_item_sk
    GROUP BY i.i_item_sk
),
CTE_Returns AS (
    SELECT 
        cr.cr_item_sk,
        SUM(cr.cr_return_quantity) AS total_returns
    FROM catalog_returns cr
    GROUP BY cr.cr_item_sk
)
SELECT 
    sd.web_site_id,
    sd.total_sales,
    sd.total_orders,
    sd.average_profit,
    COALESCE(il.total_inventory, 0) AS total_inventory,
    COALESCE(r.total_returns, 0) AS total_returns,
    ROUND((sd.total_sales - COALESCE(r.total_returns, 0)) / NULLIF(sd.total_orders, 0), 2) AS average_sales_per_order
FROM CTE_SalesData sd
LEFT JOIN CTE_InventoryLevels il ON il.i_item_sk IN (SELECT ws.ws_item_sk FROM web_sales ws WHERE ws.ws_web_site_sk = sd.web_site_id)
LEFT JOIN CTE_Returns r ON r.cr_item_sk IN (SELECT ws.ws_item_sk FROM web_sales ws WHERE ws.ws_web_site_sk = sd.web_site_id)
ORDER BY sd.total_sales DESC
LIMIT 10;
