
WITH AddressDetails AS (
    SELECT 
        ca.city AS city,
        ca.state AS state,
        CONCAT(ca.street_number, ' ', ca.street_name, ' ', ca.street_type) AS full_address,
        COUNT(DISTINCT c.c_customer_sk) AS customer_count
    FROM 
        customer_address ca
    JOIN 
        customer c ON ca.ca_address_sk = c.c_current_addr_sk
    GROUP BY 
        ca.city, ca.state, ca.street_number, ca.street_name, ca.street_type
),
StringProcessedDetails AS (
    SELECT 
        city,
        state,
        full_address,
        customer_count,
        LENGTH(full_address) AS address_length,
        UPPER(full_address) AS address_upper,
        LOWER(full_address) AS address_lower,
        REPLACE(full_address, ' ', '-') AS address_hyphenated
    FROM 
        AddressDetails
),
AddressSummary AS (
    SELECT 
        state,
        COUNT(*) AS address_count,
        SUM(customer_count) AS total_customers,
        MIN(address_length) AS min_address_length,
        MAX(address_length) AS max_address_length,
        AVG(address_length) AS avg_address_length,
        STRING_AGG(full_address, ', ') AS sample_addresses
    FROM 
        StringProcessedDetails
    GROUP BY 
        state
)

SELECT 
    state,
    address_count,
    total_customers,
    min_address_length,
    max_address_length,
    avg_address_length,
    sample_addresses
FROM 
    AddressSummary
ORDER BY 
    total_customers DESC
FETCH FIRST 10 ROWS ONLY;
