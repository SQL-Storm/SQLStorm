WITH RankedSales AS (
    SELECT 
        ws_item_sk,
        ws_sales_price,
        ws_net_profit,
        RANK() OVER (PARTITION BY ws_item_sk ORDER BY ws_net_profit DESC) as SalesRank
    FROM web_sales
    WHERE ws_sold_date_sk BETWEEN 2459393 AND 2459737  
),
CustomerStats AS (
    SELECT 
        c.c_customer_sk,
        ca.ca_city,
        cd.cd_gender,
        SUM(ws.ws_net_profit) AS TotalProfit,
        COUNT(DISTINCT ws.ws_order_number) AS OrderCount
    FROM customer c
    JOIN web_sales ws ON c.c_customer_sk = ws.ws_bill_customer_sk
    JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    JOIN customer_address ca ON c.c_current_addr_sk = ca.ca_address_sk
    WHERE cd.cd_gender = 'F' 
    AND ca.ca_state IN ('CA', 'TX')
    GROUP BY c.c_customer_sk, ca.ca_city, cd.cd_gender
),
HighProfitCustomers AS (
    SELECT c.c_customer_sk, c.c_first_name, c.c_last_name, cs.TotalProfit
    FROM CustomerStats cs
    JOIN customer c ON cs.c_customer_sk = c.c_customer_sk
    WHERE cs.TotalProfit > (SELECT AVG(TotalProfit) FROM CustomerStats)
),
ItemStats AS (
    SELECT 
        i.i_item_id,
        i.i_current_price,
        COUNT(ws.ws_order_number) AS SalesCount,
        AVG(ws.ws_net_profit) AS AvgNetProfit
    FROM item i
    LEFT JOIN web_sales ws ON i.i_item_sk = ws.ws_item_sk
    GROUP BY i.i_item_id, i.i_current_price
),
SalesAnalysis AS (
    SELECT 
        ib.ib_income_band_sk,
        ib.ib_lower_bound,
        ib.ib_upper_bound,
        COUNT(DISTINCT c.c_customer_sk) AS CustomerCount,
        SUM(COALESCE(cs.TotalProfit, 0)) AS CollectiveProfit
    FROM income_band ib
    LEFT JOIN customer c ON c.c_customer_sk = c.c_customer_sk
    LEFT JOIN CustomerStats cs ON c.c_customer_sk = cs.c_customer_sk
    GROUP BY ib.ib_income_band_sk, ib.ib_lower_bound, ib.ib_upper_bound
)

SELECT 
    hpc.c_customer_sk,
    hpc.c_first_name,
    hpc.c_last_name,
    COUNT(DISTINCT rp.ws_item_sk) AS ItemsRanked,
    SUM(ias.SalesCount) AS TotalSalesCount,
    SUM(ias.AvgNetProfit) AS TotalAvgProfit,
    sa.CustomerCount,
    sa.CollectiveProfit
FROM HighProfitCustomers hpc
JOIN RankedSales rp ON hpc.c_customer_sk = rp.ws_item_sk
JOIN ItemStats ias ON rp.ws_item_sk = ias.i_item_id
JOIN SalesAnalysis sa ON sa.ib_income_band_sk = hpc.c_customer_sk
GROUP BY hpc.c_customer_sk, hpc.c_first_name, hpc.c_last_name, sa.CustomerCount, sa.CollectiveProfit
ORDER BY TotalAvgProfit DESC
LIMIT 100;