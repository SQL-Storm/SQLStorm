
WITH RECURSIVE customer_hierarchy AS (
    SELECT c.c_customer_sk, c.c_first_name, c.c_last_name, c.c_preferred_cust_flag, 
           cd.cd_gender, cd.cd_marital_status, hd.hd_income_band_sk
    FROM customer c
    JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    LEFT JOIN household_demographics hd ON cd.cd_demo_sk = hd.hd_demo_sk
    WHERE c.c_preferred_cust_flag = 'Y'
    
    UNION ALL
    
    SELECT c.c_customer_sk, c.c_first_name, c.c_last_name, c.c_preferred_cust_flag, 
           cd.cd_gender, cd.cd_marital_status, hd.hd_income_band_sk
    FROM customer c
    JOIN customer_hierarchy ch ON c.c_current_hdemo_sk = ch.c_customer_sk
    JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    LEFT JOIN household_demographics hd ON cd.cd_demo_sk = hd.hd_demo_sk
),

sales_summary AS (
    SELECT 
        ws.ws_ship_date_sk,
        s.s_store_id,
        SUM(ws.ws_sales_price) AS total_sales,
        COUNT(ws.ws_order_number) AS number_of_orders
    FROM web_sales ws
    JOIN store s ON ws.ws_ship_addr_sk = s.s_store_sk
    GROUP BY ws.ws_ship_date_sk, s.s_store_id
),

filtered_sales AS (
    SELECT 
        ss.ws_ship_date_sk,
        ss.s_store_id,
        ss.total_sales,
        ss.number_of_orders,
        ROW_NUMBER() OVER (PARTITION BY ss.s_store_id ORDER BY ss.total_sales DESC) AS rank
    FROM sales_summary ss
    WHERE ss.total_sales > (SELECT AVG(total_sales) FROM sales_summary)
),

final_report AS (
    SELECT ch.c_first_name, ch.c_last_name, ch.cd_gender, fs.s_store_id, 
           fs.total_sales, fs.number_of_orders
    FROM customer_hierarchy ch
    LEFT JOIN filtered_sales fs ON fs.s_store_id = ch.c_customer_sk
)

SELECT 
    fr.c_first_name,
    fr.c_last_name,
    fr.cd_gender,
    COALESCE(fr.total_sales, 0) AS total_sales,
    COALESCE(fr.number_of_orders, 0) AS number_of_orders
FROM final_report fr
FULL OUTER JOIN filtered_sales fs ON fr.s_store_id = fs.s_store_id
ORDER BY fr.c_last_name, fr.c_first_name, fs.total_sales DESC;
