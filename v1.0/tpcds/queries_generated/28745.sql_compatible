
WITH AddressDetails AS (
    SELECT 
        CONCAT(ca_street_number, ' ', ca_street_name, ' ', ca_street_type) AS full_address,
        ca_city,
        ca_state,
        ca_country
    FROM 
        customer_address
    WHERE 
        ca_country LIKE 'United States'
),
CustomerDemographics AS (
    SELECT 
        cd.cd_demo_sk,
        cd.cd_gender,
        cd.cd_marital_status,
        cd.cd_education_status,
        COUNT(DISTINCT c.c_customer_id) AS customer_count
    FROM 
        customer_demographics cd
    JOIN 
        customer c ON cd.cd_demo_sk = c.c_current_cdemo_sk
    GROUP BY 
        cd.cd_demo_sk, cd.cd_gender, cd.cd_marital_status, cd.cd_education_status
),
SalesInfo AS (
    SELECT 
        SUM(ws.ws_quantity) AS total_sales_quantity,
        SUM(ws.ws_sales_price) AS total_sales_amount,
        ws.ws_bill_cdemo_sk
    FROM 
        web_sales ws
    GROUP BY 
        ws.ws_bill_cdemo_sk
),
CombinedData AS (
    SELECT 
        cd.cd_gender,
        cd.cd_marital_status,
        cd.cd_education_status,
        COALESCE(cu.customer_count, 0) AS customer_count,
        COALESCE(si.total_sales_quantity, 0) AS total_sales_quantity,
        COALESCE(si.total_sales_amount, 0) AS total_sales_amount
    FROM 
        CustomerDemographics cd
    LEFT JOIN 
        SalesInfo si ON cd.cd_demo_sk = si.ws_bill_cdemo_sk
    LEFT JOIN 
        (SELECT COUNT(*) AS customer_count, cd_demo_sk FROM customer GROUP BY cd_demo_sk) cu ON cd.cd_demo_sk = cu.cd_demo_sk
)
SELECT 
    cd.cd_gender AS gender,
    cd.cd_marital_status AS marital_status,
    cd.cd_education_status AS education_status,
    cd.customer_count,
    cd.total_sales_quantity,
    cd.total_sales_amount,
    AVG(cd.total_sales_amount) OVER (PARTITION BY cd.cd_gender) AS avg_sales_per_gender,
    INITCAP(ad.full_address) AS formatted_address
FROM 
    CombinedData cd
JOIN 
    AddressDetails ad ON ad.ca_city = 'Los Angeles' AND ad.ca_state = 'CA'
ORDER BY 
    cd.customer_count DESC
LIMIT 100;
