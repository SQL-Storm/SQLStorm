
WITH RECURSIVE AddressHierarchy AS (
    SELECT ca_address_sk, ca_city, ca_state, ca_country, 1 AS level
    FROM customer_address
    WHERE ca_city IS NOT NULL
    UNION ALL
    SELECT ca.ca_address_sk, ca.ca_city, ca.ca_state, ca.ca_country, ah.level + 1
    FROM customer_address ca
    JOIN AddressHierarchy ah ON ca.ca_state = ah.ca_state AND ca.ca_country = ah.ca_country
    WHERE ah.level < 5
),
CustomerInfo AS (
    SELECT c.c_customer_sk, c.c_first_name, c.c_last_name, cd.cd_gender, cd.cd_marital_status,
           COUNT(DISTINCT s.s_store_sk) AS store_count
    FROM customer c
    LEFT JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    LEFT JOIN store s ON s.s_address_sk = c.c_current_addr_sk
    GROUP BY c.c_customer_sk, c.c_first_name, c.c_last_name, cd.cd_gender, cd.cd_marital_status
),
SalesData AS (
    SELECT ws.ws_customer_sk, SUM(ws.ws_sales_price) AS total_sales,
           ROW_NUMBER() OVER (PARTITION BY ws.ws_customer_sk ORDER BY SUM(ws.ws_sales_price) DESC) AS sales_rank
    FROM web_sales ws
    GROUP BY ws.ws_customer_sk
),
PopularItems AS (
    SELECT i.i_item_id, COUNT(ws.ws_item_sk) AS sales_count
    FROM web_sales ws
    JOIN item i ON ws.ws_item_sk = i.i_item_sk
    GROUP BY i.i_item_id
    HAVING COUNT(ws.ws_item_sk) > (
        SELECT AVG(sales_count) FROM (
            SELECT COUNT(ws_sub.ws_item_sk) AS sales_count
            FROM web_sales ws_sub
            GROUP BY ws_sub.ws_item_sk
        ) AS avg_sales
    )
)
SELECT ci.c_first_name, ci.c_last_name, ci.cd_gender, ah.ca_city, ah.ca_state,
       COALESCE(sd.total_sales, 0) AS total_sales, pi.i_item_id
FROM CustomerInfo ci
JOIN AddressHierarchy ah ON ah.level = 1
LEFT JOIN SalesData sd ON ci.c_customer_sk = sd.ws_customer_sk 
LEFT JOIN PopularItems pi ON pi.sales_count > 10 AND sd.sales_rank <= 5
WHERE ci.store_count IS NOT NULL
  AND (ci.cd_marital_status = 'M' OR ci.cd_marital_status IS NULL)
ORDER BY total_sales DESC;
