WITH RankedSales AS (
    SELECT 
        ws.ws_sold_date_sk,
        ws.ws_item_sk,
        SUM(ws.ws_sales_price) AS total_sales,
        ROW_NUMBER() OVER (PARTITION BY ws.ws_item_sk ORDER BY SUM(ws.ws_sales_price) DESC) AS sales_rank
    FROM 
        web_sales ws
    JOIN 
        item i ON ws.ws_item_sk = i.i_item_sk
    WHERE 
        i.i_current_price IS NOT NULL
        AND i.i_rec_start_date <= cast('2002-10-01' as date) 
        AND (i.i_rec_end_date IS NULL OR i.i_rec_end_date > cast('2002-10-01' as date))
    GROUP BY 
        ws.ws_sold_date_sk, ws.ws_item_sk
    HAVING 
        SUM(ws.ws_sales_price) > 1000
),
CustomerDemographics AS (
    SELECT 
        cd.cd_demo_sk,
        cd.cd_gender,
        cd.cd_marital_status,
        cd.cd_credit_rating,
        hd.hd_income_band_sk,
        COUNT(DISTINCT c.c_customer_sk) AS customer_count
    FROM 
        customer_demographics cd
    LEFT JOIN 
        household_demographics hd ON cd.cd_demo_sk = hd.hd_demo_sk
    LEFT JOIN 
        customer c ON (cd.cd_demo_sk = c.c_current_cdemo_sk OR cd.cd_demo_sk = c.c_current_hdemo_sk)
    WHERE 
        cd.cd_gender IN ('M', 'F')
        AND (hd.hd_income_band_sk IS NOT NULL OR hd.hd_income_band_sk IS NULL)
    GROUP BY 
        cd.cd_demo_sk, cd.cd_gender, cd.cd_marital_status, cd.cd_credit_rating, hd.hd_income_band_sk
),
ReturnStatistics AS (
    SELECT 
        sr.returned_date_sk,
        SUM(sr.return_quantity) AS total_returns,
        COUNT(DISTINCT sr.refunded_customer_sk) AS unique_customers_returned
    FROM 
        store_returns sr
    LEFT JOIN 
        RankedSales rs ON sr.sr_item_sk = rs.ws_item_sk
    GROUP BY 
        sr.returned_date_sk
)

SELECT 
    d.d_date AS sales_date,
    r.total_sales AS web_sales,
    c.customer_count AS total_customers,
    COALESCE(rt.total_returns, 0) AS total_returns,
    COALESCE(rt.unique_customers_returned, 0) AS unique_returning_customers
FROM 
    date_dim d
LEFT JOIN 
    RankedSales r ON d.d_date_sk = r.ws_sold_date_sk
LEFT JOIN 
    CustomerDemographics c ON c.hd_income_band_sk IS NULL OR c.hd_income_band_sk BETWEEN 1 AND 3
LEFT JOIN 
    ReturnStatistics rt ON rt.returned_date_sk = d.d_date_sk
WHERE 
    d.d_date BETWEEN '2001-01-01' AND '2001-12-31'
ORDER BY 
    d.d_date
FETCH FIRST 100 ROWS ONLY;