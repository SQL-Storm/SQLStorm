
WITH CustomerReturns AS (
    SELECT 
        cr.returning_customer_sk,
        SUM(cr.return_amount) AS total_return_amount,
        COUNT(cr.return_order_number) AS total_returns,
        MAX(cr.returned_date_sk) AS last_return_date
    FROM 
        catalog_returns cr
    WHERE 
        cr.return_quantity > 0
    GROUP BY 
        cr.returning_customer_sk
),
CustomerDemographics AS (
    SELECT 
        cd.cd_demo_sk,
        COUNT(c.c_customer_sk) AS customer_count,
        AVG(cd.cd_purchase_estimate) AS avg_purchase_estimate,
        SUM(cd.cd_dep_count) AS total_dependents
    FROM 
        customer c
    JOIN 
        customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
    WHERE 
        cd.cd_gender = 'F' AND
        cd.cd_marital_status = 'M'
    GROUP BY 
        cd.cd_demo_sk
),
SalesSummary AS (
    SELECT 
        ws.web_site_sk,
        SUM(ws.net_paid_inc_tax) AS total_sales,
        COUNT(ws.order_number) AS total_orders
    FROM 
        web_sales ws
    WHERE 
        ws.sold_date_sk IN (SELECT d.d_date_sk FROM date_dim d WHERE d.d_year = 2023)
    GROUP BY 
        ws.web_site_sk
),
RankedReturns AS (
    SELECT 
        cr.returning_customer_sk,
        cr.total_return_amount,
        cr.total_returns,
        RANK() OVER (ORDER BY cr.total_return_amount DESC) AS return_rank
    FROM 
        CustomerReturns cr
)
SELECT 
    cd.cd_demo_sk,
    cd.customer_count,
    cd.avg_purchase_estimate,
    cd.total_dependents,
    COALESCE(sr.total_sales, 0) AS total_sales,
    COALESCE(sr.total_orders, 0) AS total_orders,
    COALESCE(rr.total_returns, 0) AS return_count,
    COALESCE(rr.total_return_amount, 0) AS return_amount,
    rr.return_rank
FROM 
    CustomerDemographics cd
LEFT JOIN 
    SalesSummary sr ON cd.cd_demo_sk = sr.web_site_sk
LEFT JOIN 
    RankedReturns rr ON cd.cd_demo_sk = rr.returning_customer_sk
WHERE 
    cd.total_dependents > 2
ORDER BY 
    total_sales DESC, return_count DESC;
