
WITH RankedSales AS (
    SELECT 
        ws.ship_date_sk,
        ws.item_sk,
        ws.order_number,
        ws.net_profit,
        RANK() OVER (PARTITION BY ws.item_sk ORDER BY ws.net_profit DESC) AS rank_per_item
    FROM 
        web_sales ws
    WHERE 
        ws.ship_date_sk >= (SELECT MAX(d_date_sk) FROM date_dim WHERE d_year = 2001)
),
CustomerProfits AS (
    SELECT 
        c.c_customer_sk,
        SUM(ws.net_profit) AS total_profit
    FROM 
        customer c
        JOIN web_sales ws ON c.c_customer_sk = ws.ws_ship_customer_sk
    GROUP BY 
        c.c_customer_sk
),
TopCustomers AS (
    SELECT 
        cp.c_customer_sk,
        cp.total_profit,
        RANK() OVER (ORDER BY cp.total_profit DESC) AS customer_rank
    FROM 
        CustomerProfits cp
)
SELECT 
    tcu.c_customer_sk,
    tcu.total_profit,
    rs.ship_date_sk,
    rs.item_sk,
    rs.order_number,
    rs.net_profit
FROM 
    TopCustomers tcu
LEFT JOIN 
    RankedSales rs ON tcu.c_customer_sk = (SELECT ws.ws_ship_customer_sk FROM web_sales ws WHERE ws.order_number = rs.order_number)
WHERE 
    tcu.customer_rank <= 10  
    AND rs.rank_per_item <= 5  
ORDER BY 
    tcu.total_profit DESC, rs.net_profit DESC;
