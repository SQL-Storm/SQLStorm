
WITH RECURSIVE SalesHierarchy AS (
    SELECT 
        c_customer_sk,
        c_first_name,
        c_last_name,
        NULL AS parent_customer_sk,
        1 AS level
    FROM customer
    WHERE c_customer_id = 'CUST001'
    
    UNION ALL
    
    SELECT 
        cs.c_customer_sk,
        cs.c_first_name,
        cs.c_last_name,
        sh.c_customer_sk AS parent_customer_sk,
        sh.level + 1
    FROM customer AS cs
    JOIN store_sales AS ss ON cs.c_customer_sk = ss.ss_customer_sk
    JOIN SalesHierarchy AS sh ON ss.ss_customer_sk = sh.c_customer_sk
)

SELECT 
    cd.cd_gender,
    cd.cd_marital_status,
    SUM(COALESCE(ws.ws_net_paid, 0)) AS total_spent,
    COUNT(DISTINCT ws.ws_order_number) AS order_count,
    RANK() OVER (PARTITION BY cd.cd_gender ORDER BY SUM(COALESCE(ws.ws_net_paid, 0)) DESC) AS gender_rank,
    COUNT(DISTINCT ws.ws_order_number) OVER () AS total_orders
FROM 
    SalesHierarchy sh
LEFT JOIN customer_demographics cd ON sh.c_customer_sk = cd.cd_demo_sk
LEFT JOIN web_sales ws ON sh.c_customer_sk = ws.ws_bill_customer_sk
GROUP BY 
    cd.cd_gender, cd.cd_marital_status
HAVING 
    SUM(COALESCE(ws.ws_net_paid, 0)) > 1000
ORDER BY 
    total_spent DESC;
