
WITH RankedSales AS (
    SELECT 
        ws.ws_item_sk,
        ws.ws_order_number,
        SUM(ws.ws_quantity) AS total_quantity,
        SUM(ws.ws_ext_sales_price) AS total_sales,
        ROW_NUMBER() OVER (PARTITION BY ws.ws_item_sk ORDER BY SUM(ws.ws_ext_sales_price) DESC) AS sales_rank
    FROM 
        web_sales AS ws 
    WHERE 
        ws.ws_sold_date_sk BETWEEN (SELECT d_date_sk FROM date_dim WHERE d_date = '2023-01-01') 
        AND (SELECT d_date_sk FROM date_dim WHERE d_date = '2023-12-31')
    GROUP BY 
        ws.ws_item_sk, ws.ws_order_number
),
TopSelling AS (
    SELECT 
        rs.ws_item_sk,
        rs.sales_rank,
        rs.total_quantity,
        rs.total_sales,
        i.i_item_desc,
        i.i_current_price,
        COALESCE(sm.sm_type, 'Not Specified') AS shipping_method
    FROM 
        RankedSales AS rs
    JOIN 
        item AS i ON rs.ws_item_sk = i.i_item_sk
    LEFT JOIN 
        ship_mode AS sm ON sm.sm_ship_mode_sk = (SELECT MAX(sm_ship_mode_sk) FROM ship_mode WHERE sm_ship_mode_id = (SELECT ws.sm_ship_mode_id FROM web_sales AS ws WHERE ws.ws_item_sk = rs.ws_item_sk LIMIT 1))
    WHERE 
        rs.sales_rank <= 10
)
SELECT 
    ts.ws_item_sk,
    ts.i_item_desc,
    ts.total_quantity,
    ts.total_sales,
    ts.shipping_method,
    CASE 
        WHEN ts.total_sales > 50000 THEN 'High Performer'
        WHEN ts.total_sales BETWEEN 20000 AND 50000 THEN 'Medium Performer'
        ELSE 'Low Performer'
    END AS performance_category,
    (SELECT COUNT(DISTINCT ws.ws_bill_customer_sk) FROM web_sales AS ws WHERE ws.ws_item_sk = ts.ws_item_sk) AS distinct_customers
FROM 
    TopSelling AS ts
ORDER BY 
    ts.total_sales DESC
LIMIT 10;
