
WITH CustomerReturns AS (
    SELECT
        cr.returning_customer_sk,
        SUM(cr.return_quantity) AS total_returned_quantity,
        SUM(cr.return_amount) AS total_return_amount
    FROM
        catalog_returns cr
    GROUP BY
        cr.returning_customer_sk
),
ItemSales AS (
    SELECT
        ws.ws_item_sk,
        SUM(ws.ws_quantity) AS total_sales_quantity,
        SUM(ws.ws_ext_sales_price) AS total_sales_amount
    FROM
        web_sales ws
    GROUP BY
        ws.ws_item_sk
),
TopItems AS (
    SELECT
        i.i_item_id,
        i.i_manufact,
        COALESCE(cs.total_sales_quantity, 0) AS sold_quantity,
        COALESCE(cr.total_returned_quantity, 0) AS returned_quantity
    FROM
        item i
    LEFT JOIN
        ItemSales cs ON i.i_item_sk = cs.ws_item_sk
    LEFT JOIN
        CustomerReturns cr ON cr.returning_customer_sk = (SELECT MIN(c.customer_sk) FROM customer c)
    WHERE
        i.i_rec_start_date <= '2002-10-01' AND (i.i_rec_end_date IS NULL OR i.i_rec_end_date > '2002-10-01')
)
SELECT
    ti.i_item_id,
    ti.i_manufact,
    ti.sold_quantity,
    ti.returned_quantity,
    (ti.sold_quantity - ti.returned_quantity) AS net_sales
FROM
    TopItems ti
ORDER BY
    net_sales DESC
FETCH FIRST 20 ROWS ONLY;
