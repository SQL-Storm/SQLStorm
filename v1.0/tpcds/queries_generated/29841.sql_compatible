
WITH AddressProcessing AS (
    SELECT
        ca_address_sk,
        CONCAT(TRIM(ca_street_number), ' ', TRIM(ca_street_name), ' ', TRIM(ca_street_type)) AS FullAddress,
        LOWER(ca_city) AS CityLower,
        UPPER(ca_state) AS StateUpper,
        LENGTH(ca_zip) AS ZipLength
    FROM customer_address
    WHERE ca_country = 'USA'
),
CustomerInfo AS (
    SELECT
        c.c_customer_sk,
        CONCAT(TRIM(c.c_first_name), ' ', TRIM(c.c_last_name)) AS FullName,
        cd.cd_gender,
        cd.cd_marital_status,
        REGEXP_REPLACE(c.c_email_address, '@.*$', '@domain.com') AS NormalizedEmail
    FROM customer c
    JOIN customer_demographics cd ON c.c_current_cdemo_sk = cd.cd_demo_sk
),
SalesInfo AS (
    SELECT
        ws.ws_ship_date_sk,
        SUM(ws.ws_sales_price) AS TotalSales,
        COUNT(ws.ws_order_number) AS OrderCount
    FROM web_sales ws
    GROUP BY ws.ws_ship_date_sk
),
EnhancedSales AS (
    SELECT
        d.d_date_id,
        s.TotalSales,
        s.OrderCount,
        DATE_FORMAT(d.d_date, '%Y-%m') AS SalesMonth,
        DENSE_RANK() OVER (PARTITION BY DATE_FORMAT(d.d_date, '%Y-%m') ORDER BY s.TotalSales DESC) AS SalesRank
    FROM SalesInfo s
    JOIN date_dim d ON s.ws_ship_date_sk = d.d_date_sk
)
SELECT 
    a.FullAddress,
    c.FullName,
    c.cd_gender,
    c.cd_marital_status,
    e.SalesMonth,
    e.TotalSales,
    e.OrderCount,
    e.SalesRank
FROM AddressProcessing a
JOIN CustomerInfo c ON a.ca_address_sk = c.c_customer_sk
JOIN EnhancedSales e ON e.TotalSales > 1000
ORDER BY e.SalesRank, c.FullName;
