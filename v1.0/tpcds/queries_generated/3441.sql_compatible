
WITH CustomerReturns AS (
    SELECT 
        sr_store_sk,
        COUNT(DISTINCT sr_ticket_number) AS total_returns,
        SUM(sr_return_amt_inc_tax) AS total_return_amount,
        AVG(sr_return_quantity) AS avg_return_quantity
    FROM 
        store_returns
    GROUP BY 
        sr_store_sk
), WebReturns AS (
    SELECT 
        wr_web_page_sk,
        COUNT(DISTINCT wr_order_number) AS total_web_returns,
        SUM(wr_return_amt_inc_tax) AS total_web_return_amount,
        AVG(wr_return_quantity) AS avg_web_return_quantity
    FROM 
        web_returns
    GROUP BY 
        wr_web_page_sk
), ItemSales AS (
    SELECT 
        ws_item_sk,
        SUM(ws_quantity) AS total_sold,
        SUM(ws_net_profit) AS total_profit
    FROM 
        web_sales
    GROUP BY 
        ws_item_sk
), SalesData AS (
    SELECT 
        cs_item_sk,
        SUM(cs_quantity) AS total_catalog_sold,
        SUM(cs_net_profit) AS total_catalog_profit
    FROM 
        catalog_sales
    GROUP BY 
        cs_item_sk
)
SELECT 
    i.i_item_id,
    i.i_item_desc,
    COALESCE(cr.total_returns, 0) AS store_returns,
    COALESCE(wr.total_web_returns, 0) AS web_returns,
    COALESCE(IS.total_sold, 0) AS total_sold_web,
    COALESCE(SD.total_catalog_sold, 0) AS total_sold_catalog,
    COALESCE(cr.total_return_amount, 0) AS total_return_amount,
    COALESCE(wr.total_web_return_amount, 0) AS total_web_return_amount,
    (COALESCE(IS.total_profit, 0) + COALESCE(SD.total_catalog_profit, 0)) AS total_profit
FROM 
    item i
LEFT JOIN 
    CustomerReturns cr ON cr.sr_store_sk = (SELECT s_store_sk FROM store WHERE s_item_sk = i.i_item_sk LIMIT 1)
LEFT JOIN 
    WebReturns wr ON wr.wr_web_page_sk = (SELECT wp_web_page_sk FROM web_page WHERE wp_web_page_id = (SELECT ws_web_page_sk FROM web_sales WHERE ws_item_sk = i.i_item_sk LIMIT 1))
LEFT JOIN 
    ItemSales IS ON i.i_item_sk = IS.ws_item_sk
LEFT JOIN 
    SalesData SD ON i.i_item_sk = SD.cs_item_sk
WHERE 
    (COALESCE(cr.total_returns, 0) > 5 OR COALESCE(wr.total_web_returns, 0) > 10)
ORDER BY 
    total_profit DESC
FETCH FIRST 100 ROWS ONLY;
