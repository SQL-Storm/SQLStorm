
WITH RankedMovies AS (
    SELECT
        m.id AS movie_id,
        m.title,
        m.production_year,
        COUNT(DISTINCT c.person_id) AS cast_count,
        STRING_AGG(DISTINCT a.name, ', ') AS aka_names
    FROM
        aka_title a
    JOIN
        title m ON m.id = a.movie_id
    JOIN
        cast_info c ON c.movie_id = m.id
    GROUP BY
        m.id, m.title, m.production_year
),
MoviesWithKeywords AS (
    SELECT
        rm.movie_id,
        rm.title,
        rm.production_year,
        rm.cast_count,
        rk.keywords
    FROM
        RankedMovies rm
    LEFT JOIN (
        SELECT
            mk.movie_id,
            STRING_AGG(k.keyword, ', ') AS keywords
        FROM
            movie_keyword mk
        JOIN
            keyword k ON k.id = mk.keyword_id
        GROUP BY
            mk.movie_id
    ) rk ON rk.movie_id = rm.movie_id
),
MoviesWithCompanyInfo AS (
    SELECT
        mwk.movie_id,
        mwk.title,
        mwk.production_year,
        mwk.cast_count,
        mwk.keywords,
        STRING_AGG(DISTINCT cn.name, ', ') AS company_names
    FROM
        MoviesWithKeywords mwk
    LEFT JOIN
        movie_companies mc ON mc.movie_id = mwk.movie_id
    LEFT JOIN
        company_name cn ON cn.id = mc.company_id
    GROUP BY
        mwk.movie_id, mwk.title, mwk.production_year, mwk.cast_count, mwk.keywords
)
SELECT
    mwa.movie_id,
    mwa.title,
    mwa.production_year,
    mwa.cast_count,
    mwa.keywords,
    mwa.company_names
FROM
    MoviesWithCompanyInfo mwa
WHERE
    mwa.production_year >= 2000
ORDER BY
    mwa.cast_count DESC,
    mwa.production_year DESC
LIMIT 10;
