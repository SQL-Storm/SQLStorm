
WITH RankedMovies AS (
    SELECT 
        t.id AS movie_id, 
        t.title, 
        t.production_year, 
        RANK() OVER (PARTITION BY t.production_year ORDER BY t.title) AS rank_year,
        COUNT(DISTINCT ci.person_id) OVER (PARTITION BY t.id) AS actor_count
    FROM 
        aka_title t 
    LEFT JOIN 
        complete_cast cc ON t.id = cc.movie_id 
    LEFT JOIN 
        cast_info ci ON cc.subject_id = ci.person_id 
    WHERE 
        t.kind_id IN (SELECT id FROM kind_type WHERE kind = 'movie')
),
TopMovies AS (
    SELECT 
        rm.movie_id, 
        rm.title,
        rm.production_year
    FROM 
        RankedMovies rm 
    WHERE 
        rm.rank_year <= 10
),
ActorMovies AS (
    SELECT 
        a.name AS actor_name, 
        tm.title,
        tm.production_year
    FROM 
        TopMovies tm 
    JOIN 
        complete_cast cc ON tm.movie_id = cc.movie_id 
    JOIN 
        aka_name a ON cc.subject_id = a.person_id
    WHERE 
        EXISTS (SELECT 1 
                  FROM person_info pi 
                  WHERE pi.person_id = a.person_id 
                  AND pi.info LIKE '%Award%')
)
SELECT 
    actor_name, 
    ARRAY_AGG(DISTINCT title) AS movies,
    COUNT(DISTINCT production_year) AS distinct_years
FROM 
    ActorMovies 
GROUP BY 
    actor_name
HAVING 
    COUNT(DISTINCT title) > 5
ORDER BY 
    distinct_years DESC, actor_name;
