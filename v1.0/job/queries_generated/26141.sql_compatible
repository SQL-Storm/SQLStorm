
WITH Ranking AS (
    SELECT 
        t.title AS movie_title,
        p.name AS person_name,
        r.role AS role_name,
        kc.keyword AS keyword,
        COUNT(c.movie_id) AS cast_count,
        ROW_NUMBER() OVER (PARTITION BY t.id ORDER BY COUNT(c.movie_id) DESC) AS rank
    FROM 
        title t 
    JOIN 
        cast_info c ON t.id = c.movie_id
    JOIN 
        aka_name p ON p.person_id = c.person_id
    JOIN 
        role_type r ON c.role_id = r.id
    LEFT JOIN 
        movie_keyword mk ON mk.movie_id = t.id
    LEFT JOIN 
        keyword kc ON mk.keyword_id = kc.id
    WHERE 
        t.production_year >= 2000
    GROUP BY 
        t.id, t.title, p.name, r.role, kc.keyword
),
RankedMovies AS (
    SELECT 
        movie_title,
        person_name,
        role_name,
        keyword,
        cast_count,
        rank
    FROM 
        Ranking
    WHERE 
        rank <= 5
)
SELECT 
    rm.movie_title,
    rm.person_name,
    rm.role_name,
    rm.keyword,
    rm.cast_count,
    COALESCE(GROUP_CONCAT(DISTINCT cn.name ORDER BY cn.name), 'No Collaborators') AS collaborators
FROM 
    RankedMovies rm
LEFT JOIN 
    cast_info ci ON rm.movie_title = (SELECT title FROM title WHERE id = ci.movie_id)
LEFT JOIN 
    aka_name cn ON cn.person_id = ci.person_id AND cn.name != rm.person_name
GROUP BY 
    rm.movie_title, rm.person_name, rm.role_name, rm.keyword, rm.cast_count
ORDER BY 
    rm.cast_count DESC, rm.movie_title;
