
WITH RankedTitles AS (
    SELECT 
        a.title, 
        a.production_year, 
        ROW_NUMBER() OVER (PARTITION BY a.production_year ORDER BY a.title) AS title_rank
    FROM 
        aka_title a
    WHERE 
        a.production_year IS NOT NULL
),
MovieRoles AS (
    SELECT 
        ci.movie_id, 
        rt.role, 
        COUNT(*) AS role_count
    FROM 
        cast_info ci
    JOIN 
        role_type rt ON ci.role_id = rt.id
    GROUP BY 
        ci.movie_id, rt.role
),
FilteredMovies AS (
    SELECT 
        mt.movie_id, 
        mt.title, 
        mt.production_year, 
        COALESCE(mr.role_count, 0) AS total_roles
    FROM 
        RankedTitles mt
    LEFT JOIN 
        MovieRoles mr ON mt.id = mr.movie_id
    WHERE 
        mt.production_year > 2000
)
SELECT 
    fm.title, 
    fm.production_year, 
    fm.total_roles,
    (SELECT COUNT(*) 
     FROM movie_keyword mk 
     WHERE mk.movie_id = fm.movie_id) AS keyword_count,
    STRING_AGG(DISTINCT an.name, ', ') AS actor_names
FROM 
    FilteredMovies fm
LEFT JOIN 
    complete_cast cc ON fm.movie_id = cc.movie_id
LEFT JOIN 
    aka_name an ON cc.subject_id = an.person_id
GROUP BY 
    fm.movie_id, fm.title, fm.production_year, fm.total_roles
HAVING 
    COUNT(DISTINCT cc.subject_id) > 2
ORDER BY 
    fm.production_year DESC, fm.total_roles DESC
FETCH FIRST 50 ROWS ONLY;
