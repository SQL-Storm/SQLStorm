
WITH RankedMovies AS (
    SELECT 
        a.title, 
        a.production_year,
        a.kind_id,
        COALESCE(k.keyword, 'No Keyword') AS keyword,
        ROW_NUMBER() OVER (PARTITION BY a.kind_id ORDER BY a.production_year DESC) AS rank
    FROM 
        aka_title a
    LEFT JOIN 
        movie_keyword mk ON a.id = mk.movie_id
    LEFT JOIN 
        keyword k ON mk.keyword_id = k.id
),
TopRankedMovies AS (
    SELECT 
        title, 
        production_year, 
        keyword 
    FROM 
        RankedMovies 
    WHERE 
        rank <= 5
),
ActorsInTopMovies AS (
    SELECT 
        DISTINCT c.person_id, 
        p.name AS actor_name, 
        t.title,
        t.production_year
    FROM 
        cast_info c
    JOIN 
        TopRankedMovies t ON c.movie_id = t.id
    JOIN 
        aka_name p ON c.person_id = p.person_id
)
SELECT 
    actor_name, 
    COUNT(DISTINCT title) AS movie_count, 
    STRING_AGG(CONCAT(title, ' (', production_year, ')'), ', ') AS movies
FROM 
    ActorsInTopMovies
GROUP BY 
    actor_name
ORDER BY 
    movie_count DESC
LIMIT 10;
