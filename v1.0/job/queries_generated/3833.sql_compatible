
WITH MovieDetails AS (
    SELECT
        a.title,
        a.production_year,
        COUNT(DISTINCT c.person_id) AS total_actors,
        STRING_AGG(DISTINCT ak.name, ', ') AS actor_names
    FROM
        aka_title a
    LEFT JOIN
        complete_cast cc ON a.id = cc.movie_id
    LEFT JOIN
        cast_info ci ON cc.subject_id = ci.id
    LEFT JOIN
        aka_name ak ON ci.person_id = ak.person_id
    WHERE
        a.production_year BETWEEN 2000 AND 2023
    GROUP BY
        a.title, a.production_year
),
CompanyInfo AS (
    SELECT
        mc.movie_id,
        GROUP_CONCAT(DISTINCT cn.name ORDER BY cn.name) AS companies,
        COUNT(DISTINCT mc.company_id) AS company_count
    FROM
        movie_companies mc
    JOIN
        company_name cn ON mc.company_id = cn.id
    GROUP BY
        mc.movie_id
),
KeywordInfo AS (
    SELECT 
        mk.movie_id,
        STRING_AGG(k.keyword, ', ') AS keywords
    FROM 
        movie_keyword mk
    JOIN 
        keyword k ON mk.keyword_id = k.id
    GROUP BY 
        mk.movie_id
),
FinalResults AS (
    SELECT 
        md.title,
        md.production_year,
        md.total_actors,
        ci.companies,
        ci.company_count,
        ki.keywords
    FROM 
        MovieDetails md
    LEFT JOIN 
        CompanyInfo ci ON md.title = ci.movie_id
    LEFT JOIN 
        KeywordInfo ki ON md.title = ki.movie_id
)
SELECT 
    *,
    CASE 
        WHEN total_actors IS NULL THEN 'No actors listed'
        ELSE CONCAT(total_actors, ' actors')
    END AS actor_info,
    COALESCE(company_count, 0) AS total_companies
FROM 
    FinalResults
ORDER BY 
    production_year DESC, total_actors DESC NULLS LAST;
