
WITH RECURSIVE MovieCast AS (
    SELECT 
        c.movie_id,
        c.person_id,
        a.name AS actor_name,
        ROW_NUMBER() OVER (PARTITION BY c.movie_id ORDER BY c.nr_order) AS actor_order
    FROM 
        cast_info c
    JOIN 
        aka_name a ON c.person_id = a.person_id
    WHERE 
        a.name IS NOT NULL
),
TopMovies AS (
    SELECT 
        m.id AS movie_id,
        m.title,
        m.production_year,
        COUNT(DISTINCT mc.company_id) AS company_count,
        RANK() OVER (ORDER BY COUNT(DISTINCT mc.company_id) DESC) AS rank_company_count
    FROM 
        aka_title m
    LEFT JOIN 
        movie_companies mc ON m.id = mc.movie_id
    GROUP BY 
        m.id, m.title, m.production_year
    HAVING 
        COUNT(DISTINCT mc.company_id) > 0
),
MoviesWithActors AS (
    SELECT 
        tm.movie_id,
        tm.title,
        tm.production_year,
        mc.actor_name,
        mc.actor_order
    FROM 
        TopMovies tm
    JOIN 
        MovieCast mc ON tm.movie_id = mc.movie_id
    WHERE 
        tm.rank_company_count <= 10  
),
DistinctActors AS (
    SELECT 
        movie_id,
        ARRAY_AGG(DISTINCT actor_name) AS actor_names
    FROM 
        MoviesWithActors
    GROUP BY 
        movie_id
),
MovieInfo AS (
    SELECT 
        m.id AS movie_id,
        mi.info,
        COALESCE(NULLIF(COUNT(mk.keyword_id), 0), 1) AS keyword_count  
    FROM 
        aka_title m
    LEFT JOIN 
        movie_keyword mk ON m.id = mk.movie_id
    LEFT JOIN 
        movie_info mi ON m.id = mi.movie_id AND mi.info_type_id = 1
    GROUP BY 
        m.id, mi.info
)
SELECT 
    mba.movie_id,
    mba.title,
    mba.production_year,
    mba.actor_names,
    MIN(mi.info) AS movie_info,
    SUM(mi.keyword_count) AS total_keywords
FROM 
    DistinctActors mba
JOIN 
    MovieInfo mi ON mba.movie_id = mi.movie_id
WHERE 
    mi.info IS NOT NULL
GROUP BY 
    mba.movie_id, mba.title, mba.production_year, mba.actor_names 
HAVING 
    SUM(mi.keyword_count) > 5  
ORDER BY 
    mba.production_year DESC, 
    total_keywords DESC
LIMIT 20;
