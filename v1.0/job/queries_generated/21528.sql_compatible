
WITH movie_cast AS (
    SELECT
        c.movie_id,
        a.name AS actor_name,
        COUNT(*) OVER (PARTITION BY c.movie_id) AS actor_count,
        ROW_NUMBER() OVER (PARTITION BY c.movie_id ORDER BY a.name) AS actor_rank
    FROM
        cast_info c
    JOIN
        aka_name a ON c.person_id = a.person_id
    WHERE
        a.name IS NOT NULL
),
movie_info_data AS (
    SELECT
        m.movie_id,
        STRING_AGG(DISTINCT mi.info, ', ') AS movie_info
    FROM
        movie_info m
    JOIN
        info_type it ON m.info_type_id = it.id
    WHERE
        it.info LIKE '%Awards%' OR it.info LIKE '%Nomination%'
    GROUP BY
        m.movie_id
),
title_summary AS (
    SELECT
        t.id AS title_id,
        t.title,
        t.production_year,
        COALESCE(mcd.movie_info, 'No Info') AS awards_info,
        COALESCE(mc.actor_count, 0) AS total_actors,
        STRING_AGG(DISTINCT k.keyword, ', ') AS keywords,
        CASE
            WHEN t.production_year IS NULL THEN 'Unknown Year'
            WHEN t.production_year < 2000 THEN 'Before 2000'
            ELSE 'From 2000 On'
        END AS period_category
    FROM
        title t
    LEFT JOIN
        movie_keyword mk ON t.id = mk.movie_id
    LEFT JOIN
        keyword k ON mk.keyword_id = k.id
    LEFT JOIN
        movie_info_data mcd ON t.id = mcd.movie_id
    LEFT JOIN
        movie_cast mc ON t.id = mc.movie_id
    GROUP BY
        t.id, t.title, t.production_year, mcd.movie_info, mc.actor_count
)
SELECT
    ts.title_id,
    ts.title,
    ts.production_year,
    ts.awards_info,
    ts.total_actors,
    ts.keywords,
    ts.period_category,
    COUNT(*) OVER (PARTITION BY ts.period_category) AS category_count,
    (SELECT COUNT(*) 
     FROM movie_companies mc 
     WHERE mc.movie_id = ts.title_id 
       AND mc.company_type_id = (SELECT id FROM company_type WHERE kind = 'Production')) AS production_company_count
FROM
    title_summary ts
WHERE
    ts.total_actors > 1
ORDER BY
    ts.production_year DESC,
    ts.total_actors DESC;
