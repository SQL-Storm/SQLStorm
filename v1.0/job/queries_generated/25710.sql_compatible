
WITH movie_details AS (
    SELECT 
        mt.title AS movie_title,
        mt.production_year,
        STRING_AGG(DISTINCT cn.name, ', ') AS production_companies,
        COUNT(DISTINCT kc.keyword) AS keyword_count,
        STRING_AGG(DISTINCT ak.name, ', ') AS aka_names
    FROM aka_title mt
    LEFT JOIN movie_companies mc ON mt.id = mc.movie_id
    LEFT JOIN company_name cn ON mc.company_id = cn.id
    LEFT JOIN movie_keyword mk ON mt.id = mk.movie_id
    LEFT JOIN keyword kc ON mk.keyword_id = kc.id
    LEFT JOIN complete_cast cc ON mt.id = cc.movie_id
    LEFT JOIN aka_name ak ON cc.subject_id = ak.person_id
    GROUP BY mt.id, mt.title, mt.production_year
), actor_details AS (
    SELECT 
        ak.person_id,
        ak.name,
        COUNT(DISTINCT ci.movie_id) AS movies_count,
        STRING_AGG(DISTINCT mt.title, ', ') AS movies
    FROM aka_name ak
    JOIN cast_info ci ON ak.person_id = ci.person_id
    JOIN aka_title mt ON ci.movie_id = mt.id
    GROUP BY ak.person_id, ak.name
)

SELECT 
    md.movie_title,
    md.production_year,
    md.production_companies,
    md.keyword_count,
    md.aka_names,
    ad.name AS lead_actor,
    ad.movies_count
FROM movie_details md
JOIN actor_details ad ON ad.movies_count > 5
WHERE md.production_year >= 2000
ORDER BY md.production_year DESC, md.keyword_count DESC;
