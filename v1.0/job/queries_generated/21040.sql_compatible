
WITH RECURSIVE cast_hierarchy AS (
    SELECT 
        ci.id AS cast_id,
        ci.person_id,
        ci.movie_id,
        ci.person_role_id,
        ci.nr_order,
        0 AS hierarchy_level,
        ARRAY[ci.person_id] AS person_chain
    FROM 
        cast_info ci
    WHERE 
        ci.nr_order = 1
    
    UNION ALL
    
    SELECT 
        ci.id,
        ci.person_id,
        ci.movie_id,
        ci.person_role_id,
        ci.nr_order,
        ch.hierarchy_level + 1,
        ch.person_chain || ci.person_id
    FROM 
        cast_info ci
    JOIN 
        cast_hierarchy ch ON ci.movie_id = ch.movie_id AND ci.nr_order = ch.nr_order + 1
)

SELECT 
    ta.title AS movie_title,
    ak.name AS actor_name,
    COUNT(DISTINCT ch.cast_id) AS total_cast_count,
    (SELECT COUNT(DISTINCT mc.company_id) FROM movie_companies mc WHERE mc.movie_id = ta.id) AS total_companies,
    STRING_AGG(DISTINCT kt.keyword, ', ') AS associated_keywords,
    CASE 
        WHEN (SELECT COUNT(*) FROM movie_info mi WHERE mi.movie_id = ta.id AND mi.info_type_id = 1) > 0 THEN 'Has Info'
        ELSE 'No Info'
    END AS info_presence,
    CASE 
        WHEN (SELECT COUNT(*) FROM complete_cast cc WHERE cc.movie_id = ta.id) = 0 THEN NULL
        ELSE (SELECT COUNT(*) FROM complete_cast cc WHERE cc.movie_id = ta.id)
    END AS complete_cast_count,
    MAX(cin.hierarchy_level) AS max_hierarchy_level,
    COALESCE((SELECT MIN(ck.keyword) FROM movie_keyword mk JOIN keyword ck ON mk.keyword_id = ck.id WHERE mk.movie_id = ta.id ORDER BY ck.keyword), 'No Keywords') AS min_keyword
FROM 
    aka_title ta
JOIN 
    aka_name ak ON ak.id = (SELECT id FROM aka_name WHERE person_id IN (SELECT DISTINCT person_id FROM cast_info WHERE movie_id = ta.id) LIMIT 1)
LEFT JOIN 
    cast_info ci ON ci.movie_id = ta.id
LEFT JOIN 
    cast_hierarchy ch ON ci.person_id = ch.person_id AND ci.movie_id = ch.movie_id
LEFT JOIN 
    movie_keyword mk ON mk.movie_id = ta.id
LEFT JOIN 
    keyword kt ON mk.keyword_id = kt.id
LEFT JOIN 
    movie_info mi ON mi.movie_id = ta.id 
WHERE 
    ta.production_year >= 2000 
    AND ak.name IS NOT NULL 
    AND (ak.name LIKE '%Action%' OR ak.name IS NULL) 
GROUP BY 
    ta.title, ak.name
HAVING 
    COUNT(DISTINCT ci.id) > 5
ORDER BY 
    total_cast_count DESC, total_companies ASC, min_keyword;
