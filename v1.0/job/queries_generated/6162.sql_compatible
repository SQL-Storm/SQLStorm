
WITH Recursive_Titles AS (
    SELECT t.id, t.title, t.production_year, t.kind_id, t.imdb_id, t.season_nr, t.episode_nr 
    FROM title t 
    WHERE t.production_year >= 2000
    UNION ALL
    SELECT tt.id, tt.title, tt.production_year, tt.kind_id, tt.imdb_id, tt.season_nr, tt.episode_nr 
    FROM title tt 
    INNER JOIN Recursive_Titles rt ON tt.episode_of_id = rt.id
),
Movie_Details AS (
    SELECT mt.movie_id, 
           mt.company_id, 
           c.name AS company_name, 
           ct.kind AS company_type, 
           m.title, 
           m.production_year, 
           m.kind_id, 
           m.imdb_id 
    FROM movie_companies mt 
    JOIN company_name c ON mt.company_id = c.id 
    JOIN company_type ct ON mt.company_type_id = ct.id 
    JOIN Recursive_Titles m ON mt.movie_id = m.id
),
Cast_Role AS (
    SELECT ci.movie_id, 
           a.name AS actor_name, 
           rt.role AS role_name 
    FROM cast_info ci 
    JOIN aka_name a ON ci.person_id = a.person_id 
    JOIN role_type rt ON ci.role_id = rt.id 
    WHERE ci.nr_order = 1
)
SELECT md.title, 
       md.production_year, 
       md.company_name, 
       md.company_type, 
       cr.actor_name, 
       cr.role_name 
FROM Movie_Details md 
LEFT JOIN Cast_Role cr ON md.movie_id = cr.movie_id 
WHERE md.kind_id IN (SELECT k.id FROM keyword k WHERE k.keyword LIKE '%Action%')
ORDER BY md.production_year DESC, md.title;
