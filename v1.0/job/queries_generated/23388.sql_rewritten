WITH RECURSIVE movie_hierarchy AS (
    SELECT m.id AS movie_id, m.title, m.production_year, 0 AS level
    FROM aka_title m
    WHERE m.production_year IS NOT NULL 
    UNION ALL
    SELECT m.id, m.title, m.production_year, level + 1
    FROM aka_title m
    INNER JOIN movie_link ml ON m.id = ml.linked_movie_id
    INNER JOIN movie_hierarchy mh ON ml.movie_id = mh.movie_id
), 
actor_movie AS (
    SELECT a.name AS actor_name, 
           t.title AS movie_title,
           t.production_year,
           ROW_NUMBER() OVER (PARTITION BY a.id ORDER BY t.production_year DESC) as recent_movie_rank
    FROM aka_name a
    JOIN cast_info c ON a.person_id = c.person_id
    JOIN aka_title t ON c.movie_id = t.id
), 
company_info AS (
    SELECT DISTINCT c.name AS company_name, 
                    ct.kind AS company_type, 
                    m.production_year,
                    ROW_NUMBER() OVER (PARTITION BY c.id ORDER BY m.production_year DESC) AS company_rank
    FROM movie_companies mc
    JOIN company_name c ON mc.company_id = c.id
    JOIN company_type ct ON mc.company_type_id = ct.id
    JOIN aka_title m ON mc.movie_id = m.id
), 
actor_company AS (
    SELECT a.actor_name, 
           c.company_name,
           c.company_type,
           c.production_year,
           CASE 
               WHEN c.production_year < 2000 THEN 'Classic'
               WHEN c.production_year >= 2000 AND c.production_year <= 2010 THEN 'Modern'
               ELSE 'Contemporary'
           END AS era
    FROM actor_movie a
    JOIN movie_companies mc ON a.recent_movie_rank = 1
    JOIN company_info c ON mc.movie_id = c.production_year 
)

SELECT 
    ah.movie_id,
    ah.title,
    ah.production_year,
    ac.actor_name,
    ac.company_name,
    ac.company_type,
    ac.era,
    (CASE 
         WHEN ac.era = 'Classic' THEN 'A timeless piece'
         WHEN ac.era = 'Modern' THEN 'A part of recent cinema history'
         ELSE 'A current blockbuster'
     END) AS era_description
FROM movie_hierarchy ah
LEFT JOIN actor_company ac ON ah.production_year = ac.production_year
WHERE ah.production_year BETWEEN 1990 AND 2023 
AND ac.actor_name IS NOT NULL
ORDER BY ah.production_year DESC, ac.era DESC NULLS LAST
LIMIT 100;