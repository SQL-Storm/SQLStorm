
WITH RECURSIVE actor_hierarchy AS (
    SELECT 
        c.person_id AS actor_id, 
        a.name AS actor_name, 
        1 AS level
    FROM cast_info c
    JOIN aka_name a ON c.person_id = a.person_id
    WHERE c.nr_order = 1

    UNION ALL

    SELECT 
        c.person_id, 
        a.name, 
        ah.level + 1
    FROM cast_info c
    JOIN actor_hierarchy ah ON c.movie_id = (SELECT movie_id FROM cast_info WHERE person_id = ah.actor_id LIMIT 1)
    JOIN aka_name a ON c.person_id = a.person_id
    WHERE ah.level < 5
)

SELECT 
    t.title,
    COUNT(DISTINCT c.person_id) AS total_actors,
    AVG(CASE 
            WHEN c.nr_order IS NULL THEN NULL 
            ELSE c.nr_order
        END) AS avg_order,
    STRING_AGG(DISTINCT a.actor_name, ', ') AS actor_names,
    RANK() OVER (PARTITION BY t.production_year ORDER BY COUNT(DISTINCT c.person_id) DESC) AS actor_rank
FROM title t
LEFT JOIN cast_info c ON t.id = c.movie_id
LEFT JOIN aka_name a ON c.person_id = a.person_id
LEFT JOIN actor_hierarchy ah ON a.person_id = ah.actor_id
WHERE 
    (t.production_year BETWEEN 2000 AND 2023) 
    AND (c.note IS NULL OR c.note != 'Cameo') 
    AND (c.person_id IN (SELECT person_id FROM person_info WHERE info_type_id IN (SELECT id FROM info_type WHERE info = 'Director')))
GROUP BY t.title, t.production_year
HAVING COUNT(DISTINCT c.person_id) > 5
ORDER BY actor_rank, t.production_year DESC NULLS LAST;
