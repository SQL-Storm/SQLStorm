
WITH MovieRankings AS (
    SELECT 
        title.title AS movie_title,
        aka_title.title AS aka_title,
        COUNT(DISTINCT cast_info.person_id) AS cast_count,
        AVG(movie_info.info_id) AS avg_info_length,
        AVG(LENGTH(title.title)) AS avg_title_length,
        STRING_AGG(DISTINCT keyword.keyword, ', ') AS associated_keywords
    FROM 
        title
    JOIN 
        aka_title ON title.id = aka_title.movie_id
    JOIN 
        cast_info ON title.id = cast_info.movie_id
    JOIN 
        movie_info ON title.id = movie_info.movie_id
    JOIN 
        movie_keyword ON title.id = movie_keyword.movie_id
    JOIN 
        keyword ON movie_keyword.keyword_id = keyword.id
    GROUP BY 
        title.title, aka_title.title
),

TopRankedMovies AS (
    SELECT 
        movie_title,
        aka_title,
        cast_count,
        avg_info_length,
        avg_title_length,
        associated_keywords,
        RANK() OVER (ORDER BY cast_count DESC, avg_info_length DESC) AS rank
    FROM 
        MovieRankings
)

SELECT 
    movie_title,
    aka_title,
    cast_count,
    avg_info_length,
    avg_title_length,
    associated_keywords
FROM 
    TopRankedMovies
WHERE 
    rank <= 10
ORDER BY 
    rank;
