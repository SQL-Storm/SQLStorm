WITH RankedMovies AS (
    SELECT 
        t.id AS title_id,
        t.title,
        t.production_year,
        COUNT(cm.company_id) AS company_count,
        ROW_NUMBER() OVER (PARTITION BY t.production_year ORDER BY COUNT(cm.company_id) DESC) AS rank
    FROM 
        aka_title t
    LEFT JOIN 
        movie_companies cm ON t.id = cm.movie_id
    GROUP BY 
        t.id
),

CastRoles AS (
    SELECT 
        ci.movie_id,
        ci.person_id,
        r.role AS role_name,
        COUNT(*) OVER (PARTITION BY ci.person_id) AS role_count
    FROM 
        cast_info ci
    JOIN 
        role_type r ON ci.role_id = r.id
    WHERE 
        ci.nr_order IS NOT NULL
),

EssentialInfo AS (
    SELECT 
        p.person_id,
        p.info AS person_award,
        COALESCE(pi.info, 'No Info') AS additional_info
    FROM 
        person_info p
    LEFT JOIN 
        info_type it ON p.info_type_id = it.id
    LEFT JOIN 
        person_info pi ON p.person_id = pi.person_id AND pi.info_type_id != p.info_type_id
    WHERE 
        p.info_type_id IN (SELECT id FROM info_type WHERE info LIKE '%award%')
),

FinalBenchmark AS (
    SELECT 
        rm.title,
        rm.production_year,
        cr.role_name,
        ei.person_award,
        ei.additional_info,
        rm.company_count,
        cr.role_count
    FROM 
        RankedMovies rm
    LEFT JOIN 
        CastRoles cr ON rm.title_id = cr.movie_id
    LEFT JOIN 
        EssentialInfo ei ON cr.person_id = ei.person_id
    WHERE 
        rm.rank <= 5 AND 
        (ei.person_award IS NULL OR ei.additional_info IS NOT NULL) 
    ORDER BY 
        rm.production_year DESC, 
        rm.company_count DESC
)

SELECT 
    title,
    production_year,
    role_name,
    person_award,
    additional_info,
    company_count,
    role_count,
    CASE 
        WHEN company_count > 10 THEN 'High'
        WHEN company_count BETWEEN 5 AND 10 THEN 'Medium'
        ELSE 'Low' 
    END AS company_category 
FROM 
    FinalBenchmark
WHERE 
    production_year > 1990 AND
    (role_name IS NOT NULL OR company_count > 0) 
ORDER BY 
    production_year ASC, 
    title;