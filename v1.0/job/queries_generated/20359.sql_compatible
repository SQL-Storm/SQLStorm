
WITH RECURSIVE actor_hierarchy AS (
    SELECT 
        c.person_id,
        a.name AS actor_name,
        0 AS level
    FROM
        cast_info c
    JOIN
        aka_name a ON c.person_id = a.person_id
    WHERE
        a.name IS NOT NULL

    UNION ALL

    SELECT 
        c.person_id,
        a.name AS actor_name,
        ah.level + 1
    FROM
        cast_info c
    JOIN
        aka_name a ON c.person_id = a.person_id
    JOIN
        actor_hierarchy ah ON c.movie_id = ah.person_id
    WHERE
        a.name IS NOT NULL
)

, movie_details AS (
    SELECT 
        t.title,
        t.production_year,
        COUNT(DISTINCT ci.person_id) AS total_cast,
        STRING_AGG(DISTINCT ak.name, ', ') AS actor_names
    FROM
        aka_title t
    LEFT JOIN 
        cast_info ci ON t.id = ci.movie_id
    LEFT JOIN 
        aka_name ak ON ci.person_id = ak.person_id
    WHERE
        ak.name IS NOT NULL
    GROUP BY 
        t.title, t.production_year
)

, enriched_movies AS (
    SELECT 
        md.title,
        md.production_year,
        md.total_cast,
        md.actor_names,
        CASE 
            WHEN md.total_cast > 10 THEN 'Large Cast'
            WHEN md.total_cast <= 10 AND md.total_cast > 5 THEN 'Medium Cast'
            ELSE 'Small Cast'
        END AS cast_size
    FROM 
        movie_details md
)

SELECT 
    em.title,
    em.production_year,
    em.total_cast,
    em.actor_names,
    em.cast_size,
    ROW_NUMBER() OVER (PARTITION BY em.cast_size ORDER BY em.total_cast DESC) AS rank_within_cast_size,
    LEAD(em.production_year) OVER (ORDER BY em.production_year) AS next_production_year,
    STRING_AGG(DISTINCT CASE 
        WHEN ci.role_id IS NULL THEN 'No Role'
        ELSE rt.role 
    END, ', ') AS roles
FROM 
    enriched_movies em
LEFT JOIN 
    cast_info ci ON em.actor_names LIKE '%' || (SELECT ak.name FROM aka_name ak WHERE ak.person_id = ci.person_id) || '%'
LEFT JOIN 
    role_type rt ON ci.role_id = rt.id
WHERE 
    em.production_year IS NOT NULL
GROUP BY 
    em.title, em.production_year, em.total_cast, em.actor_names, em.cast_size
ORDER BY 
    em.production_year DESC
LIMIT 100 OFFSET 10;
