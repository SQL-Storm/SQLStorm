
WITH movie_with_keywords AS (
    SELECT 
        mt.id AS movie_id,
        mt.title,
        mt.production_year,
        mk.keyword
    FROM 
        aka_title mt
    LEFT JOIN 
        movie_keyword mk ON mt.id = mk.movie_id
),

cast_with_roles AS (
    SELECT 
        ci.movie_id,
        p.name AS actor_name,
        ci.nr_order,
        rt.role
    FROM 
        cast_info ci
    JOIN 
        aka_name p ON ci.person_id = p.person_id
    JOIN 
        role_type rt ON ci.role_id = rt.id
),

movies_with_companies AS (
    SELECT 
        m.id AS movie_id,
        m.title,
        mc.company_id,
        cn.name AS company_name
    FROM 
        aka_title m
    LEFT JOIN 
        movie_companies mc ON m.id = mc.movie_id
    LEFT JOIN 
        company_name cn ON mc.company_id = cn.id
),

keyword_count AS (
    SELECT 
        movie_id,
        COUNT(keyword) AS keyword_count
    FROM 
        movie_with_keywords
    GROUP BY 
        movie_id
)

SELECT 
    mwk.movie_id,
    mwk.title,
    mwk.production_year,
    c.actor_name,
    c.role,
    COALESCE(kc.keyword_count, 0) AS keyword_count,
    mc.company_name,
    ROW_NUMBER() OVER (PARTITION BY mwk.movie_id ORDER BY c.nr_order) AS actor_order
FROM 
    movie_with_keywords mwk
LEFT JOIN 
    cast_with_roles c ON mwk.movie_id = c.movie_id
LEFT JOIN 
    keyword_count kc ON mwk.movie_id = kc.movie_id
LEFT JOIN 
    movies_with_companies mc ON mwk.movie_id = mc.movie_id
WHERE 
    mwk.production_year >= 2000
ORDER BY 
    mwk.production_year DESC, mwk.movie_id, c.nr_order;
