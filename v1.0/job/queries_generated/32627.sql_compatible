
WITH RECURSIVE MovieHierarchy AS (
    SELECT m.id AS movie_id,
           m.title,
           1 AS level,
           ARRAY[m.id] AS path
    FROM aka_title m
    WHERE m.production_year >= 2000

    UNION ALL

    SELECT m.id AS movie_id,
           m.title,
           mh.level + 1,
           mh.path || m.id
    FROM aka_title m
    JOIN MovieHierarchy mh ON m.episode_of_id = mh.movie_id
)

SELECT
    movie.title AS Movie_Title,
    COUNT(cast.id) AS Cast_Count,
    STRING_AGG(DISTINCT a.name, ', ') AS Cast_Names,
    AVG(ci.rating) AS Average_Rating,
    MAX(mo.production_year) AS Latest_Production_Year
FROM
    MovieHierarchy movie
LEFT JOIN
    complete_cast cc ON movie.movie_id = cc.movie_id
LEFT JOIN
    cast_info cast ON cc.subject_id = cast.person_id
LEFT JOIN
    aka_name a ON cast.person_id = a.person_id
LEFT JOIN
    movie_info mo ON movie.movie_id = mo.movie_id
LEFT JOIN 
    (SELECT mi.movie_id, AVG(CAST(mi.info AS FLOAT)) AS rating
     FROM movie_info mi
     JOIN info_type it ON mi.info_type_id = it.id
     WHERE it.info = 'rating'
     GROUP BY mi.movie_id) ci ON movie.movie_id = ci.movie_id
WHERE
    a.name IS NOT NULL AND a.name != ''
GROUP BY 
    movie.title, movie.movie_id
HAVING 
    COUNT(cast.id) > 0
ORDER BY 
    Average_Rating DESC, Latest_Production_Year DESC;
