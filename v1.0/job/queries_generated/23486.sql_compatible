
WITH Recursive_CTE AS (
    SELECT 
        ca.person_id, 
        COUNT(*) AS title_count
    FROM 
        cast_info ca
    INNER JOIN 
        title t ON ca.movie_id = t.id
    WHERE 
        t.production_year >= 2000
    GROUP BY 
        ca.person_id
    HAVING 
        COUNT(*) > 2
), 
Top_Persons AS (
    SELECT 
        rn.person_id,
        ak.name,
        rn.title_count,
        COALESCE(CAST(p.info AS VARCHAR), 'No Info') AS person_info
    FROM 
        Recursive_CTE rn
    INNER JOIN 
        aka_name ak ON rn.person_id = ak.person_id
    LEFT JOIN 
        person_info p ON rn.person_id = p.person_id AND p.info_type_id = 1
    WHERE 
        ak.name IS NOT NULL
), 
Title_With_Keywords AS (
    SELECT 
        t.id AS movie_id,
        t.title,
        STRING_AGG(k.keyword, ', ') AS keywords
    FROM 
        title t
    LEFT JOIN 
        movie_keyword mk ON t.id = mk.movie_id
    LEFT JOIN 
        keyword k ON mk.keyword_id = k.id
    GROUP BY 
        t.id, t.title
),
Final_Output AS (
    SELECT 
        tp.person_id,
        tp.name,
        tp.title_count,
        twk.title,
        twk.keywords,
        CASE 
            WHEN tp.title_count IS NULL THEN 'N/A'
            ELSE ROUND(CAST(tp.title_count AS NUMERIC) / NULLIF(tp.title_count, 0), 2)
        END AS ratio
    FROM 
        Top_Persons tp
    LEFT JOIN 
        Title_With_Keywords twk ON tp.title_count < 5
    ORDER BY 
        tp.title_count DESC, twk.title
)

SELECT 
    person_id,
    name,
    title_count,
    title,
    keywords,
    ratio
FROM 
    Final_Output
WHERE 
    title IS NOT NULL
UNION ALL
SELECT 
    NULL AS person_id,
    'Summary' AS name,
    COUNT(*) AS title_count,
    NULL AS title,
    NULL AS keywords,
    NULL AS ratio
FROM 
    Final_Output
WHERE 
    title_count IS NOT NULL
GROUP BY 
    name
HAVING 
    COUNT(*) > 0;
