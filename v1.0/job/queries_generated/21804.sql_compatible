
WITH RankedTitles AS (
    SELECT
        t.title,
        t.production_year,
        ROW_NUMBER() OVER (PARTITION BY t.production_year ORDER BY t.production_year DESC) AS title_rank
    FROM
        aka_title t
    WHERE
        t.production_year IS NOT NULL
),
ActorInfo AS (
    SELECT 
        a.id AS actor_id,
        a.name,
        COUNT(DISTINCT ci.movie_id) AS movie_count,
        MAX(CASE WHEN ci.nr_order IS NOT NULL THEN ci.nr_order ELSE 0 END) AS max_order,
        SUM(CASE WHEN ci.note IS NOT NULL THEN 1 ELSE 0 END) AS note_count
    FROM
        aka_name a
    LEFT JOIN 
        cast_info ci ON a.person_id = ci.person_id
    GROUP BY
        a.id, a.name
),
FilteredMovies AS (
    SELECT
        m.id AS movie_id,
        m.title,
        m.production_year,
        COUNT(DISTINCT co.company_id) AS company_count
    FROM
        aka_title m
    LEFT JOIN
        movie_companies co ON m.id = co.movie_id
    WHERE
        m.production_year > 2000
    GROUP BY
        m.id, m.title, m.production_year
)
SELECT
    rt.title,
    rt.production_year,
    ai.name AS actor_name,
    ai.movie_count,
    ai.max_order,
    ai.note_count,
    fm.company_count
FROM
    RankedTitles rt
JOIN
    ActorInfo ai ON ai.movie_count > 2 
LEFT JOIN
    FilteredMovies fm ON fm.movie_id = rt.movie_id
WHERE
    rt.title_rank = 1
    AND (fm.company_count IS NULL OR fm.company_count > 0)
ORDER BY
    rt.production_year DESC,
    ai.note_count DESC,
    ai.max_order ASC;
