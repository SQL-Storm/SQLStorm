
WITH MovieDetails AS (
    SELECT 
        t.id AS title_id,
        t.title,
        t.production_year,
        k.keyword AS movie_keyword,
        COUNT(DISTINCT ci.person_id) AS cast_count,
        AVG(CASE 
            WHEN EXTRACT(YEAR FROM m.production_year) < 2000 THEN 5.0
            ELSE 3.0 END) AS avg_rating
    FROM 
        aka_title t
    LEFT JOIN 
        movie_keyword mk ON t.id = mk.movie_id
    LEFT JOIN 
        keyword k ON mk.keyword_id = k.id
    LEFT JOIN 
        complete_cast cct ON t.id = cct.movie_id
    LEFT JOIN 
        cast_info ci ON ci.movie_id = t.id
    JOIN 
        company_name cn ON cn.imdb_id = t.id 
    WHERE 
        t.production_year IS NOT NULL
        AND (t.kind_id IN (SELECT id FROM kind_type WHERE kind IN ('movie', 'tvseries')))
    GROUP BY 
        t.id, t.title, t.production_year, k.keyword
),
ActorAwards AS (
    SELECT 
        a.person_id,
        a.name,
        COUNT(DISTINCT ci.movie_id) AS awards_count
    FROM 
        aka_name a
    JOIN 
        cast_info ci ON a.person_id = ci.person_id
    WHERE 
        a.name IS NOT NULL
        AND a.name NOT LIKE '%Unknown%'
    GROUP BY 
        a.person_id, a.name
    HAVING 
        COUNT(DISTINCT ci.movie_id) > 5
),
HighCasts AS (
    SELECT 
        md.title,
        md.production_year,
        md.cast_count,
        ROW_NUMBER() OVER (PARTITION BY md.production_year ORDER BY md.cast_count DESC) AS rank
    FROM 
        MovieDetails md
    WHERE 
        md.cast_count IS NOT NULL
        AND md.cast_count > 2
)
SELECT 
    h.title,
    h.production_year,
    h.cast_count,
    COALESCE(a.awards_count, 0) AS awards_count,
    CASE 
        WHEN h.rank = 1 THEN 'Top Cast Movie!'
        ELSE 'Good Movie'
    END AS cast_rank,
    CASE 
        WHEN h.cast_count IS NOT NULL THEN 
            'Movie has a solid cast'
        ELSE 
            'Movie has no cast listed'
    END AS cast_summary
FROM 
    HighCasts h
LEFT JOIN 
    ActorAwards a ON h.title = a.name
WHERE 
    h.cast_count > 3
ORDER BY 
    h.production_year, h.cast_count DESC;
