
WITH MovieDetails AS (
    SELECT 
        m.id AS movie_id,
        m.title AS movie_title,
        m.production_year,
        STRING_AGG(DISTINCT k.keyword, ',') AS keywords,
        STRING_AGG(DISTINCT c.name, ',') AS companies,
        STRING_AGG(DISTINCT a.name, ',') AS actors,
        COUNT(DISTINCT i.id) AS info_count
    FROM 
        aka_title AS m
    LEFT JOIN 
        movie_keyword AS mk ON m.id = mk.movie_id
    LEFT JOIN 
        keyword AS k ON mk.keyword_id = k.id
    LEFT JOIN 
        movie_companies AS mc ON m.id = mc.movie_id
    LEFT JOIN 
        company_name AS c ON mc.company_id = c.id
    LEFT JOIN 
        cast_info AS ci ON m.id = ci.movie_id
    LEFT JOIN 
        aka_name AS a ON ci.person_id = a.person_id
    LEFT JOIN 
        movie_info AS i ON m.id = i.movie_id
    GROUP BY 
        m.id, m.title, m.production_year
),
ActorStats AS (
    SELECT
        a.person_id,
        COUNT(ci.movie_id) AS movie_count,
        AVG(m.production_year) AS avg_production_year
    FROM 
        aka_name AS a
    JOIN 
        cast_info AS ci ON a.person_id = ci.person_id
    JOIN 
        aka_title AS m ON ci.movie_id = m.id
    GROUP BY 
        a.person_id
),
CompanyStats AS (
    SELECT
        c.id AS company_id,
        c.name AS company_name,
        COUNT(mc.movie_id) AS movie_count,
        MIN(m.production_year) AS first_movie,
        MAX(m.production_year) AS last_movie
    FROM 
        company_name AS c
    JOIN 
        movie_companies AS mc ON c.id = mc.company_id
    JOIN 
        aka_title AS m ON mc.movie_id = m.id
    GROUP BY 
        c.id, c.name
)
SELECT 
    md.movie_id,
    md.movie_title,
    md.production_year,
    md.keywords,
    md.companies,
    md.actors,
    md.info_count,
    as.movie_count AS actor_count,
    as.avg_production_year AS actor_avg_year,
    cs.movie_count AS company_movie_count,
    cs.first_movie,
    cs.last_movie
FROM 
    MovieDetails AS md
JOIN 
    ActorStats AS as ON md.actors LIKE '%' || as.person_id || '%'
JOIN 
    CompanyStats AS cs ON md.companies LIKE '%' || cs.company_name || '%'
WHERE 
    md.production_year > 2000
ORDER BY 
    md.production_year DESC, 
    as.avg_production_year ASC;
