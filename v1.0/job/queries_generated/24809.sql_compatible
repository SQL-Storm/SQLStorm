
WITH RECURSIVE ActorHierarchy AS (
    SELECT 
        c.person_id,
        a.name AS actor_name,
        a.surname_pcode,
        1 AS depth
    FROM 
        cast_info c
    JOIN 
        aka_name a ON c.person_id = a.person_id
    WHERE 
        c.movie_id IN (SELECT id FROM aka_title WHERE production_year >= 2000)
    
    UNION ALL
    
    SELECT 
        c.person_id,
        a.name,
        a.surname_pcode,
        ah.depth + 1 AS depth
    FROM 
        cast_info c
    JOIN 
        aka_name a ON c.person_id = a.person_id
    JOIN 
        ActorHierarchy ah ON c.movie_id IN (SELECT movie_id FROM cast_info WHERE person_id = ah.person_id)
    WHERE 
        ah.depth < 5
), 

MoviesWithKeywords AS (
    SELECT 
        t.title,
        ARRAY_AGG(DISTINCT k.keyword) AS keywords
    FROM 
        aka_title t
    JOIN 
        movie_keyword mk ON mk.movie_id = t.id
    JOIN 
        keyword k ON mk.keyword_id = k.id
    GROUP BY 
        t.title
),

DetailedMovies AS (
    SELECT 
        t.title,
        t.production_year,
        STRING_AGG(DISTINCT CAST(c.role_id AS text), ', ') AS roles,
        COALESCE(NULLIF(m.info, ''), 'No Info') AS movie_info,
        COALESCE(k.keywords, ARRAY['No Keywords']) AS keywords
    FROM 
        aka_title t
    LEFT JOIN 
        cast_info c ON t.id = c.movie_id
    LEFT JOIN 
        movie_info m ON m.movie_id = t.id AND m.info_type_id = (SELECT id FROM info_type WHERE info = 'Plot')
    LEFT JOIN 
        MoviesWithKeywords k ON k.title = t.title
    WHERE 
        t.production_year BETWEEN 2000 AND 2023 AND
        (c.role_id IS NULL OR c.note IS NOT NULL) 
    GROUP BY 
        t.title, t.production_year
)

SELECT 
    ah.actor_name,
    COUNT(DISTINCT dm.title) AS movie_count,
    STRING_AGG(DISTINCT dm.movie_info, '; ') AS aggregated_info,
    ARRAY_AGG(DISTINCT dm.keywords) AS all_keywords,
    MAX(dm.production_year) AS last_year_worked,
    SUM(CASE WHEN dm.production_year < 2015 THEN 1 ELSE 0 END) AS pre_2015_count
FROM 
    ActorHierarchy ah
JOIN 
    DetailedMovies dm ON ah.person_id = dm.role_id
GROUP BY 
    ah.actor_name, ah.surname_pcode
ORDER BY 
    movie_count DESC, last_year_worked DESC
LIMIT 10;
