
WITH movie_data AS (
    SELECT 
        m.id AS movie_id,
        m.title AS movie_title,
        m.production_year,
        m.kind_id,
        k.keyword AS keyword,
        STRING_AGG(DISTINCT a.name ORDER BY a.name) AS actor_names,
        STRING_AGG(DISTINCT c.kind ORDER BY c.kind) AS company_types,
        COUNT(DISTINCT mci.company_id) AS num_companies
    FROM 
        aka_title m
    JOIN 
        movie_keyword mk ON m.id = mk.movie_id
    JOIN 
        keyword k ON mk.keyword_id = k.id
    JOIN 
        cast_info ci ON m.id = ci.movie_id
    JOIN 
        aka_name a ON ci.person_id = a.person_id
    JOIN 
        movie_companies mci ON m.id = mci.movie_id
    JOIN 
        company_type c ON mci.company_type_id = c.id
    WHERE 
        m.production_year >= 2000
    GROUP BY 
        m.id,
        m.title,
        m.production_year,
        m.kind_id
),
info_data AS (
    SELECT 
        mi.movie_id,
        STRING_AGG(mi.info ORDER BY it.info) AS movie_infos
    FROM 
        movie_info mi
    JOIN 
        info_type it ON mi.info_type_id = it.id
    GROUP BY 
        mi.movie_id
)

SELECT 
    mv.movie_id,
    mv.movie_title,
    mv.production_year,
    mv.kind_id,
    mv.keyword,
    mv.actor_names,
    mv.company_types,
    mv.num_companies,
    COALESCE(id.movie_infos, 'No info available') AS movie_infos
FROM 
    movie_data mv
LEFT JOIN 
    info_data id ON mv.movie_id = id.movie_id
ORDER BY 
    mv.production_year DESC, 
    mv.movie_title ASC;
