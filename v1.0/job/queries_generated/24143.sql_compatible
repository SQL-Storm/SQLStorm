
WITH RankedMovies AS (
    SELECT 
        title.id AS movie_id,
        title.title AS movie_title,
        title.production_year,
        ROW_NUMBER() OVER (PARTITION BY title.production_year ORDER BY title.id) AS rn
    FROM title
    WHERE title.production_year IS NOT NULL
),
ActorRoles AS (
    SELECT 
        aka_name.person_id,
        aka_name.name AS actor_name,
        role_type.role AS role_name,
        COUNT(cast_info.id) AS role_count
    FROM cast_info
    JOIN aka_name ON cast_info.person_id = aka_name.person_id
    JOIN role_type ON cast_info.role_id = role_type.id
    GROUP BY aka_name.person_id, aka_name.name, role_type.role
),
MoviesWithKeywords AS (
    SELECT 
        aka_title.id AS movie_id,
        aka_title.title,
        STRING_AGG(keyword.keyword, ', ') AS keywords
    FROM aka_title
    JOIN movie_keyword ON aka_title.id = movie_keyword.movie_id
    JOIN keyword ON movie_keyword.keyword_id = keyword.id
    GROUP BY aka_title.id, aka_title.title
),
ActorsInMovies AS (
    SELECT 
        t.id AS movie_id,
        COALESCE(STRING_AGG(aka_name.name, ', '), 'No Actors') AS actors_list
    FROM title t
    LEFT JOIN cast_info ci ON t.id = ci.movie_id
    LEFT JOIN aka_name ON ci.person_id = aka_name.person_id
    GROUP BY t.id
),
TopRankedMovies AS (
    SELECT 
        RankedMovies.movie_id,
        RankedMovies.movie_title,
        RankedMovies.production_year,
        RankedMovies.rn,
        ActorsInMovies.actors_list,
        MoviesWithKeywords.keywords
    FROM RankedMovies
    JOIN ActorsInMovies ON RankedMovies.movie_id = ActorsInMovies.movie_id
    LEFT JOIN MoviesWithKeywords ON RankedMovies.movie_id = MoviesWithKeywords.movie_id
    WHERE RankedMovies.rn <= 10
)
SELECT 
    tm.movie_id,
    tm.movie_title,
    COALESCE(tm.actors_list, 'No Actors Found') AS actors,
    COALESCE(tm.keywords, 'No Keywords') AS keywords,
    COUNT(DISTINCT ar.role_name) AS unique_roles
FROM TopRankedMovies tm
LEFT JOIN ActorRoles ar ON tm.movie_id = ar.person_id
GROUP BY 
    tm.movie_id, 
    tm.movie_title, 
    tm.actors_list, 
    tm.keywords
ORDER BY 
    tm.production_year DESC, 
    tm.movie_title ASC
LIMIT 20;
