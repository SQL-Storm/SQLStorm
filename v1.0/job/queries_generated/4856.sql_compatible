
WITH movie_details AS (
    SELECT t.id AS movie_id, 
           t.title, 
           t.production_year, 
           COUNT(DISTINCT c.person_id) AS actor_count,
           STRING_AGG(DISTINCT a.name, ', ') AS actor_names
    FROM aka_title t
    LEFT JOIN cast_info c ON t.id = c.movie_id
    LEFT JOIN aka_name a ON c.person_id = a.person_id
    WHERE t.production_year >= 2000
    GROUP BY t.id, t.title, t.production_year
), 
company_info AS (
    SELECT m.movie_id,
           GROUP_CONCAT(DISTINCT co.name) AS companies,
           SUM(CASE WHEN ct.kind = 'Distributor' THEN 1 ELSE 0 END) AS distributor_count
    FROM movie_companies m
    JOIN company_name co ON m.company_id = co.id
    JOIN company_type ct ON m.company_type_id = ct.id
    GROUP BY m.movie_id
), 
keyword_info AS (
    SELECT mk.movie_id,
           STRING_AGG(DISTINCT k.keyword ORDER BY k.keyword) AS keywords
    FROM movie_keyword mk
    JOIN keyword k ON mk.keyword_id = k.id
    GROUP BY mk.movie_id
)
SELECT md.movie_id,
       md.title,
       md.production_year,
       COALESCE(ci.companies, 'None') AS companies,
       ci.distributor_count,
       md.actor_count,
       md.actor_names,
       COALESCE(ki.keywords, 'No Keywords') AS keywords
FROM movie_details md
LEFT JOIN company_info ci ON md.movie_id = ci.movie_id
LEFT JOIN keyword_info ki ON md.movie_id = ki.movie_id
ORDER BY md.production_year DESC, md.title;
