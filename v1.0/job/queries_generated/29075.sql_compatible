
WITH RankedTitles AS (
    SELECT 
        a.id AS aka_id,
        a.name AS aka_name,
        t.title AS movie_title,
        t.production_year,
        ROW_NUMBER() OVER (PARTITION BY t.production_year ORDER BY LENGTH(t.title) DESC) AS title_rank
    FROM 
        aka_title t
    JOIN 
        aka_name a ON t.id = a.id
    WHERE 
        t.production_year IS NOT NULL
), TitleKeywords AS (
    SELECT 
        t.id AS title_id,
        t.title,
        k.keyword,
        COUNT(k.id) AS keyword_count
    FROM 
        aka_title t
    JOIN 
        movie_keyword mk ON t.id = mk.movie_id
    JOIN 
        keyword k ON k.id = mk.keyword_id
    GROUP BY 
        t.id, t.title, k.keyword
), TitleInfo AS (
    SELECT 
        t.title_id, 
        t.title,
        STRING_AGG(DISTINCT CONCAT(k.keyword, ' (', k.keyword_count, ')'), ', ') AS keyword_summary
    FROM 
        TitleKeywords t
    JOIN 
        (SELECT title_id, COUNT(*) AS keyword_count FROM TitleKeywords GROUP BY title_id) AS keyword_counts
        ON t.title_id = keyword_counts.title_id
    GROUP BY 
        t.title_id, t.title
), FinalResults AS (
    SELECT 
        r.aka_name,
        t.movie_title,
        t.production_year,
        t.keyword_summary
    FROM 
        RankedTitles r
    JOIN 
        TitleInfo t ON r.movie_title = t.title
    WHERE 
        r.title_rank <= 5
)
SELECT 
    aka_name,
    movie_title,
    production_year,
    keyword_summary
FROM 
    FinalResults
ORDER BY
    production_year DESC, 
    aka_name ASC;
