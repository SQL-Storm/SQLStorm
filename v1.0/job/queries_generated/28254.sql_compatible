
WITH RankedTitles AS (
    SELECT 
        AT.title AS movie_title,
        AT.production_year,
        RC.actor_name,
        ROW_NUMBER() OVER (PARTITION BY AT.id ORDER BY RC.role_id) AS rank
    FROM aka_title AT
    JOIN cast_info CI ON AT.id = CI.movie_id
    JOIN aka_name AN ON CI.person_id = AN.person_id
    JOIN (
        SELECT 
            person_id,
            STRING_AGG(name, ', ') AS actor_name,
            role_id
        FROM cast_info CI
        JOIN aka_name AN ON CI.person_id = AN.person_id
        GROUP BY person_id, role_id
    ) RC ON CI.person_id = RC.person_id AND CI.role_id = RC.role_id
),
FilteredActors AS (
    SELECT 
        RT.movie_title,
        RT.production_year,
        RT.actor_name,
        RT.rank
    FROM RankedTitles RT
    WHERE RT.rank <= 3
),
MovieKeywords AS (
    SELECT 
        MT.id AS movie_id,
        STRING_AGG(K.keyword, ', ') AS keywords
    FROM movie_keyword MK
    JOIN keyword K ON MK.keyword_id = K.id
    JOIN title MT ON MK.movie_id = MT.id
    GROUP BY MT.id
)
SELECT 
    TA.movie_title,
    TA.production_year,
    TA.actor_name,
    MK.keywords
FROM FilteredActors TA
JOIN MovieKeywords MK ON TA.movie_title = MK.movie_id
ORDER BY TA.production_year DESC, TA.movie_title;
