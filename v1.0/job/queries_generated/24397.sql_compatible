
WITH RankedTitles AS (
    SELECT 
        a.title,
        a.production_year,
        ROW_NUMBER() OVER (PARTITION BY a.production_year ORDER BY a.title) AS title_rank,
        a.id AS title_id
    FROM aka_title a
    WHERE a.production_year IS NOT NULL
),
CompanyCount AS (
    SELECT 
        mi.movie_id,
        COUNT(DISTINCT mc.company_id) AS num_companies
    FROM movie_companies mc
    JOIN movie_info mi ON mi.movie_id = mc.movie_id
    WHERE mi.info LIKE '%Blockbuster%'
    GROUP BY mi.movie_id
),
TopRankedFilms AS (
    SELECT 
        rt.title,
        rt.production_year,
        cc.num_companies,
        RANK() OVER (ORDER BY rt.production_year DESC, cc.num_companies DESC) AS film_rank
    FROM RankedTitles rt
    LEFT JOIN CompanyCount cc ON rt.title_id = cc.movie_id
    WHERE rt.title_rank <= 5 OR cc.num_companies IS NULL
)
SELECT 
    trf.title,
    trf.production_year,
    COALESCE(tc.num_companies, 0) AS total_companies,
    CASE 
        WHEN tc.num_companies IS NOT NULL AND tc.num_companies > 3 
             THEN 'High Production'
        WHEN tc.num_companies IS NULL 
             THEN 'No Production Companies'
        ELSE 'Standard Production'
    END AS production_status
FROM TopRankedFilms trf
LEFT JOIN (
    SELECT movie_id, COUNT(company_id) AS num_companies
    FROM movie_companies
    GROUP BY movie_id
) tc ON trf.title_id = tc.movie_id
WHERE trf.film_rank <= 20
ORDER BY trf.production_year DESC, production_status;
