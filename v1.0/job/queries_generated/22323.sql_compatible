
WITH RankedMovies AS (
    SELECT 
        t.id AS movie_id,
        t.title,
        t.production_year,
        ROW_NUMBER() OVER (PARTITION BY EXTRACT(YEAR FROM t.production_year) ORDER BY COUNT(c.id) DESC) AS most_popular_rank
    FROM 
        aka_title t
    LEFT JOIN 
        cast_info c ON t.movie_id = c.movie_id
    GROUP BY 
        t.id, t.title, t.production_year
),
PopularActors AS (
    SELECT 
        a.person_id,
        a.name,
        COUNT(c.movie_id) AS movies_count
    FROM 
        aka_name a
    JOIN 
        cast_info c ON a.person_id = c.person_id
    WHERE 
        c.nr_order = 1 
    GROUP BY 
        a.person_id, a.name
    HAVING 
        COUNT(c.movie_id) > 5 
),
MovieDetails AS (
    SELECT 
        rm.movie_id,
        rm.title,
        COALESCE(NULLIF(mk.keyword, ''), 'Unknown') AS keyword,
        mk.id AS keyword_id,
        pm.name AS person_name,
        pm.person_id
    FROM 
        RankedMovies rm
    LEFT JOIN 
        movie_keyword mk ON rm.movie_id = mk.movie_id
    LEFT JOIN 
        cast_info ci ON rm.movie_id = ci.movie_id
    LEFT JOIN 
        PopularActors pa ON ci.person_id = pa.person_id
    LEFT JOIN 
        aka_name pm ON pa.person_id = pm.person_id
    WHERE 
        rm.most_popular_rank <= 3
)
SELECT 
    md.movie_id,
    md.title,
    md.keyword,
    COUNT(DISTINCT md.person_id) AS lead_actors_count,
    STRING_AGG(DISTINCT md.person_name, ', ') AS lead_actor_names,
    STRING_AGG(DISTINCT CASE WHEN md.keyword IS NULL THEN 'NULL Keyword' ELSE md.keyword END, ', ') AS keywords_summary,
    (SELECT 
        COUNT(*) 
     FROM 
        movie_info mi 
     WHERE 
        mi.movie_id = md.movie_id 
        AND mi.info_type_id IN (SELECT id FROM info_type WHERE info = 'Award')) AS award_count
FROM 
    MovieDetails md
GROUP BY 
    md.movie_id, md.title
HAVING 
    COUNT(DISTINCT md.person_id) <= 2
    AND (SELECT COUNT(*)
         FROM complete_cast cc 
         WHERE cc.movie_id = md.movie_id) > 10
ORDER BY 
    md.title, lead_actors_count DESC;
