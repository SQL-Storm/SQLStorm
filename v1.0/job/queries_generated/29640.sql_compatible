
WITH RankedTitles AS (
    SELECT 
        t.title AS movie_title,
        t.production_year,
        a.name AS actor_name,
        RANK() OVER (PARTITION BY t.id ORDER BY t.production_year DESC) AS rank
    FROM 
        aka_title t
    JOIN 
        cast_info c ON t.id = c.movie_id
    JOIN 
        aka_name a ON a.person_id = c.person_id
    WHERE 
        t.production_year >= 2000
        AND a.name IS NOT NULL
),
TitleCount AS (
    SELECT 
        movie_title,
        COUNT(*) AS actor_count
    FROM 
        RankedTitles
    WHERE 
        rank = 1  
    GROUP BY 
        movie_title
),
InfoSummary AS (
    SELECT 
        t.id AS movie_id,
        t.title,
        COUNT(DISTINCT ki.keyword) AS keyword_count,
        COUNT(DISTINCT ci.person_id) AS cast_count,
        MAX(t.production_year) AS latest_year
    FROM 
        aka_title t
    LEFT JOIN 
        movie_keyword mk ON t.id = mk.movie_id
    LEFT JOIN 
        keyword ki ON mk.keyword_id = ki.id
    LEFT JOIN 
        cast_info ci ON t.id = ci.movie_id
    GROUP BY 
        t.id, t.title
),
FinalResults AS (
    SELECT 
        is.title,
        is.latest_year,
        tc.actor_count,
        COALESCE(tc.actor_count, 0) AS actor_count_adjusted,
        COALESCE(tc.actor_count, 0) + COUNT(DISTINCT ci.person_id) AS total_cast
    FROM 
        InfoSummary is
    LEFT JOIN 
        TitleCount tc ON is.title = tc.movie_title
    LEFT JOIN 
        cast_info ci ON is.movie_id = ci.movie_id
    GROUP BY 
        is.title, is.latest_year, tc.actor_count
)
SELECT 
    fr.title,
    fr.latest_year,
    fr.actor_count_adjusted,
    fr.total_cast
FROM 
    FinalResults fr
WHERE 
    fr.latest_year IS NOT NULL
ORDER BY 
    fr.latest_year DESC, fr.title;
