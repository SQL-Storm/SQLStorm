
WITH RankedTitles AS (
    SELECT 
        t.id AS title_id,
        t.title,
        t.production_year,
        t.kind_id,
        ROW_NUMBER() OVER (PARTITION BY t.kind_id ORDER BY t.production_year DESC) AS rank
    FROM 
        aka_title t
),
CastWithRoles AS (
    SELECT 
        c.movie_id,
        p.name AS person_name,
        c.nr_order,
        r.role AS role_name
    FROM 
        cast_info c
    JOIN 
        aka_name p ON c.person_id = p.person_id
    JOIN 
        role_type r ON c.role_id = r.id
    WHERE 
        c.nr_order IS NOT NULL
),
FullCast AS (
    SELECT 
        r.title_id,
        r.title,
        r.production_year,
        r.kind_id,
        COUNT(c.person_name) AS cast_count
    FROM 
        RankedTitles r
    LEFT JOIN 
        CastWithRoles c ON r.title_id = c.movie_id
    GROUP BY 
        r.title_id, r.title, r.production_year, r.kind_id
),
TopGenres AS (
    SELECT 
        k.kind AS genre,
        COUNT(DISTINCT t.title_id) AS title_count
    FROM 
        FullCast t
    JOIN 
        kind_type k ON t.kind_id = k.id
    GROUP BY 
        k.kind
),
MovieStats AS (
    SELECT 
        f.title,
        f.production_year,
        g.genre,
        f.cast_count
    FROM 
        FullCast f
    JOIN 
        TopGenres g ON f.kind_id = g.genre
    ORDER BY 
        f.production_year DESC,
        f.cast_count DESC
)
SELECT 
    m.title,
    m.production_year,
    m.genre,
    m.cast_count,
    CONCAT('This film titled ', m.title, ' was released in ', m.production_year, ' and has a total of ', m.cast_count, ' cast members.') AS movie_description
FROM 
    MovieStats m
WHERE 
    m.cast_count > 5
LIMIT 10;
