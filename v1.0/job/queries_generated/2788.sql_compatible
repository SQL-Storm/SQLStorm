
WITH MovieDetails AS (
    SELECT 
        at.title,
        at.production_year,
        c.comp_cast_id,
        c.nr_order,
        ROW_NUMBER() OVER (PARTITION BY at.id ORDER BY c.nr_order) AS actor_rank
    FROM 
        aka_title at
    JOIN 
        complete_cast cc ON at.id = cc.movie_id
    JOIN 
        cast_info c ON cc.subject_id = c.id
    WHERE 
        at.production_year >= 2000
),
PopularActors AS (
    SELECT 
        ak.name,
        COUNT(DISTINCT md.comp_cast_id) AS movie_count
    FROM 
        aka_name ak
    JOIN 
        cast_info ci ON ak.person_id = ci.person_id
    JOIN 
        MovieDetails md ON ci.movie_id = md.comp_cast_id
    GROUP BY 
        ak.name
    HAVING 
        COUNT(DISTINCT md.comp_cast_id) > 5
),
ActorRankings AS (
    SELECT 
        ak.name,
        COUNT(DISTINCT ci.movie_id) AS movies_worked,
        DENSE_RANK() OVER (ORDER BY COUNT(DISTINCT ci.movie_id) DESC) AS rank
    FROM 
        aka_name ak
    JOIN 
        cast_info ci ON ak.person_id = ci.person_id
    WHERE 
        ci.note IS NULL
    GROUP BY 
        ak.name
)
SELECT 
    ra.name AS actor_name,
    ra.movies_worked,
    ra.rank,
    COALESCE(pa.movie_count, 0) AS movies_with_5plus
FROM 
    ActorRankings ra
LEFT JOIN 
    PopularActors pa ON ra.name = pa.name
WHERE 
    ra.rank <= 10
ORDER BY 
    ra.rank;
