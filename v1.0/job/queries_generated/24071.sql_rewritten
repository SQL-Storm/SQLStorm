WITH RECURSIVE MovieHierarchy AS (
    SELECT 
        mt.id AS movie_id,
        mt.title,
        mt.production_year,
        1 AS level
    FROM 
        aka_title mt
    WHERE 
        mt.production_year IS NOT NULL
    
    UNION ALL

    SELECT 
        ml.linked_movie_id,
        mt.title,
        mt.production_year,
        mh.level + 1
    FROM 
        MovieHierarchy mh
    JOIN 
        movie_link ml ON mh.movie_id = ml.movie_id
    JOIN 
        aka_title mt ON ml.linked_movie_id = mt.id
    WHERE 
        mh.level < 5  
),

FilteredTitles AS (
    SELECT 
        title,
        production_year,
        COUNT(*) OVER (PARTITION BY EXTRACT(YEAR FROM cast('2024-10-01' as date)) - production_year) AS count_by_age
    FROM 
        MovieHierarchy
    WHERE 
        production_year BETWEEN 1980 AND EXTRACT(YEAR FROM cast('2024-10-01' as date))
    ORDER BY 
        production_year DESC
),

PersonAwards AS (
    SELECT 
        ai.person_id,
        COUNT(DISTINCT ai.movie_id) AS award_count
    FROM 
        cast_info ai
    JOIN 
        aka_title at ON ai.movie_id = at.movie_id
    JOIN 
        movie_info mi ON at.id = mi.movie_id
    WHERE 
        mi.info_type_id IN (SELECT id FROM info_type WHERE info = 'Awards')
    GROUP BY 
        ai.person_id
)

SELECT 
    ak.name AS actor_name,
    ft.title AS movie_title,
    ft.production_year,
    ft.count_by_age,
    COALESCE(pa.award_count, 0) AS award_count,
    CASE 
        WHEN pa.award_count IS NULL THEN 'No Awards'
        WHEN pa.award_count < 3 THEN 'Novice'
        ELSE 'Veteran' 
    END AS actor_status,
    CONCAT('Title: ', ft.title, ' | Year: ', ft.production_year, 
           ' | Awards: ', COALESCE(pa.award_count, 0)) AS title_info
FROM 
    FilteredTitles ft
LEFT JOIN 
    aka_name ak ON ak.person_id IN (
        SELECT 
            ci.person_id 
        FROM 
            cast_info ci 
        WHERE 
            ci.movie_id IN (SELECT movie_id FROM MovieHierarchy)
    )
LEFT JOIN 
    PersonAwards pa ON ak.person_id = pa.person_id
WHERE 
    ak.name IS NOT NULL
ORDER BY 
    ft.production_year DESC,
    actor_status ASC
LIMIT 50;