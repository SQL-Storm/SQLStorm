
WITH Filmography AS (
    SELECT
        a.person_id,
        a.name AS actor_name,
        t.title AS movie_title,
        t.production_year,
        t.kind_id,
        ck.kind AS company_kind,
        ROW_NUMBER() OVER (PARTITION BY a.person_id ORDER BY t.production_year DESC) AS film_rank,
        COUNT(*) OVER (PARTITION BY a.person_id) AS total_films
    FROM
        aka_name AS a
    JOIN
        cast_info AS c ON a.person_id = c.person_id
    JOIN
        aka_title AS t ON c.movie_id = t.movie_id
    LEFT JOIN
        movie_companies AS mc ON t.id = mc.movie_id
    LEFT JOIN
        company_type AS ck ON mc.company_type_id = ck.id
    WHERE
        t.production_year IS NOT NULL
        AND ck.kind IS NOT NULL
        AND EXISTS (
            SELECT 1
            FROM role_type AS rt
            WHERE rt.id = c.role_id
            AND rt.role ILIKE '%actor%'
        )
),
TopActors AS (
    SELECT
        person_id,
        actor_name,
        movie_title,  -- Fixed to match column name
        film_rank,
        total_films
    FROM
        Filmography
    WHERE
        film_rank <= 5
)
SELECT 
    ta.actor_name,
    ta.total_films,
    STRING_AGG(DISTINCT ta.movie_title || ' (' || ta.production_year || ')', ', ') AS filmography,
    NULLIF(MAX(CASE WHEN kc.keyword LIKE '%blockbuster%' THEN 1 END), 0) AS has_blockbuster
FROM
    TopActors AS ta
LEFT JOIN 
    movie_keyword AS mk ON mk.movie_id IN (
        SELECT movie_id 
        FROM aka_title 
        WHERE id IN (
            SELECT DISTINCT movie_id 
            FROM cast_info 
            WHERE person_id = ta.person_id
        )
    )
LEFT JOIN 
    keyword AS kc ON mk.keyword_id = kc.id
GROUP BY
    ta.actor_name, ta.total_films  -- Ensure all non-aggregated columns are listed
HAVING
    COUNT(DISTINCT ta.movie_title) > 2
ORDER BY 
    ta.total_films DESC
LIMIT 10;
