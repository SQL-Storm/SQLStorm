
WITH MovieStats AS (
    SELECT 
        t.title AS movie_title,
        COUNT(DISTINCT c.person_id) AS num_actors,
        COUNT(DISTINCT m.company_id) AS num_companies,
        AVG(mp.info) AS avg_runtime
    FROM 
        aka_title t
    LEFT JOIN 
        complete_cast cc ON t.id = cc.movie_id
    LEFT JOIN 
        cast_info c ON cc.subject_id = c.person_id
    LEFT JOIN 
        movie_companies m ON t.id = m.movie_id
    LEFT JOIN 
        movie_info mp ON t.id = mp.movie_id AND mp.info_type_id = (SELECT id FROM info_type WHERE info = 'runtime')
    GROUP BY 
        t.title
),
ActorDetails AS (
    SELECT 
        a.name AS actor_name,
        ak.name AS aka_name,
        c.movie_id,
        ROW_NUMBER() OVER (PARTITION BY c.movie_id ORDER BY a.name) AS actor_rank
    FROM 
        aka_name ak
    INNER JOIN 
        cast_info c ON ak.person_id = c.person_id
    INNER JOIN 
        name a ON a.id = ak.person_id
),
FilteredMovies AS (
    SELECT 
        ms.movie_title, 
        ms.num_actors,
        ms.num_companies,
        ms.avg_runtime
    FROM 
        MovieStats ms
    WHERE 
        ms.num_actors > 5 AND 
        ms.avg_runtime IS NOT NULL
)
SELECT 
    DISTINCT fm.movie_title,
    fm.num_actors,
    fm.num_companies,
    COALESCE(ROUND(fm.avg_runtime, 2), 'N/A') AS avg_runtime_formatted,
    STRING_AGG(ad.actor_name || ' (aka: ' || COALESCE(ad.aka_name, 'N/A') || ')', ', ') AS actors
FROM 
    FilteredMovies fm
LEFT JOIN 
    ActorDetails ad ON ad.movie_id IN (SELECT id FROM aka_title WHERE title = fm.movie_title)
GROUP BY 
    fm.movie_title, fm.num_actors, fm.num_companies, fm.avg_runtime
ORDER BY 
    fm.num_actors DESC, fm.movie_title ASC
LIMIT 20;
