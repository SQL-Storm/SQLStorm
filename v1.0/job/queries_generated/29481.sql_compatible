
WITH movie_title_summary AS (
    SELECT 
        t.id AS title_id,
        t.title AS movie_title,
        t.production_year,
        STRING_AGG(DISTINCT co.name, ', ') AS companies_involved,
        COUNT(DISTINCT mk.keyword) AS total_keywords,
        COALESCE(SUM(CASE WHEN pi.info_type_id = 1 THEN LENGTH(pi.info) END), 0) AS total_info_length
    FROM 
        title t
    LEFT JOIN 
        movie_companies mc ON t.id = mc.movie_id
    LEFT JOIN 
        company_name co ON mc.company_id = co.id
    LEFT JOIN 
        movie_keyword mk ON t.id = mk.movie_id
    LEFT JOIN 
        movie_info mi ON t.id = mi.movie_id
    LEFT JOIN 
        person_info pi ON pi.person_id IN (
            SELECT DISTINCT ci.person_id 
            FROM cast_info ci WHERE ci.movie_id = t.id
        )
    GROUP BY 
        t.id, t.title, t.production_year
),
cast_summary AS (
    SELECT 
        ci.movie_id,
        COUNT(DISTINCT ci.person_id) AS total_cast_members,
        STRING_AGG(DISTINCT r.role ORDER BY r.role) AS roles_assigned
    FROM 
        cast_info ci
    JOIN 
        role_type r ON ci.role_id = r.id
    GROUP BY 
        ci.movie_id
)
SELECT 
    mts.movie_title,
    mts.production_year,
    mts.companies_involved,
    mts.total_keywords,
    mts.total_info_length,
    cs.total_cast_members,
    cs.roles_assigned
FROM 
    movie_title_summary mts
JOIN 
    cast_summary cs ON mts.title_id = cs.movie_id
WHERE 
    mts.production_year >= 2000
ORDER BY 
    mts.production_year DESC,
    mts.total_keywords DESC,
    cs.total_cast_members DESC
LIMIT 100;
