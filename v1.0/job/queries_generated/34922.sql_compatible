
WITH RECURSIVE ActorMovieCount AS (
    SELECT 
        a.person_id,
        COUNT(DISTINCT c.movie_id) AS movie_count
    FROM 
        aka_name a
    JOIN 
        cast_info c ON a.person_id = c.person_id
    GROUP BY 
        a.person_id
),
TopActors AS (
    SELECT 
        person_id,
        movie_count,
        RANK() OVER (ORDER BY movie_count DESC) AS rank
    FROM 
        ActorMovieCount
),
TitleGenres AS (
    SELECT 
        t.id AS title_id,
        t.title,
        k.keyword,
        t.production_year
    FROM 
        aka_title t
    LEFT JOIN 
        movie_keyword mk ON t.id = mk.movie_id
    LEFT JOIN 
        keyword k ON mk.keyword_id = k.id
    WHERE 
        t.kind_id IS NOT NULL
)
SELECT 
    ta.person_id,
    an.name,
    COUNT(DISTINCT tc.title_id) AS titles_joined,
    STRING_AGG(DISTINCT tg.keyword, ', ') AS genres,
    AVG(y.production_year) AS avg_prod_year,
    CASE 
        WHEN COUNT(tc.title_id) = 0 THEN 'No Titles'
        ELSE 'Has Titles'
    END AS title_status
FROM 
    TopActors ta
JOIN 
    aka_name an ON ta.person_id = an.person_id
LEFT JOIN 
    (SELECT 
         title_id, 
         COUNT(DISTINCT c.movie_id) AS movie_count 
     FROM 
         complete_cast c 
     GROUP BY 
         title_id) tc ON tc.title_id = ta.person_id
LEFT JOIN 
    TitleGenres tg ON tg.title_id IN (SELECT c.movie_id FROM cast_info c WHERE c.person_id = ta.person_id)
LEFT JOIN 
    title y ON y.id = tg.title_id 
WHERE 
    ta.rank <= 10
GROUP BY 
    ta.person_id, an.name
HAVING 
    AVG(y.production_year) > 2000
ORDER BY 
    titles_joined DESC;
