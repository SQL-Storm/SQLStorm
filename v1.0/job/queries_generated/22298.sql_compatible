
WITH RankedMovies AS (
    SELECT 
        a.title AS movie_title,
        a.production_year,
        COUNT(DISTINCT ci.person_id) OVER (PARTITION BY a.id) AS total_cast,
        COUNT(DISTINCT mk.keyword) OVER (PARTITION BY a.id) AS total_keywords,
        ROW_NUMBER() OVER (ORDER BY a.production_year DESC, a.title) AS rank
    FROM 
        aka_title a
    LEFT JOIN 
        cast_info ci ON a.id = ci.movie_id
    LEFT JOIN 
        movie_keyword mk ON a.id = mk.movie_id
    WHERE 
        a.production_year IS NOT NULL AND
        a.kind_id IN (SELECT id FROM kind_type WHERE kind IN ('movie', 'tv series'))
        AND a.title NOT LIKE '%untitled%'
),
FilteredMovies AS (
    SELECT 
        movie_title,
        production_year,
        total_cast,
        total_keywords,
        rank
    FROM 
        RankedMovies
    WHERE 
        total_cast > 10 AND
        EXISTS (
            SELECT 1 
            FROM aka_name an 
            WHERE an.id IN (SELECT person_id FROM cast_info WHERE movie_id = RankedMovies.movie_title)
            AND an.name ILIKE '%John%'
        )
),
TopMovies AS (
    SELECT 
        movie_title,
        production_year,
        total_cast,
        total_keywords,
        rank,
        LEAD(movie_title) OVER (ORDER BY rank) AS next_movie
    FROM 
        FilteredMovies
)
SELECT 
    tm.movie_title,
    tm.production_year,
    tm.total_cast,
    tm.total_keywords,
    tm.next_movie,
    CASE 
        WHEN tm.production_year < 2000 THEN 'Classic'
        WHEN tm.production_year >= 2000 AND tm.production_year < 2010 THEN 'Modern'
        ELSE 'Recent'
    END AS era_category
FROM 
    TopMovies tm
WHERE 
    rank <= 20
ORDER BY 
    total_cast DESC, 
    production_year ASC;
