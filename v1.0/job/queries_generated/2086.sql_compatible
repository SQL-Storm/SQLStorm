
WITH ranked_movies AS (
    SELECT 
        t.title, 
        t.production_year, 
        COUNT(DISTINCT c.person_id) AS cast_count, 
        ROW_NUMBER() OVER (PARTITION BY t.production_year ORDER BY COUNT(DISTINCT c.person_id) DESC) AS rn
    FROM title t
    LEFT JOIN cast_info c ON t.id = c.movie_id
    GROUP BY t.title, t.production_year
),
company_movies AS (
    SELECT 
        m.movie_id, 
        co.name AS company_name, 
        ct.kind AS company_type
    FROM movie_companies m
    JOIN company_name co ON m.company_id = co.id
    JOIN company_type ct ON m.company_type_id = ct.id
),
movies_with_keywords AS (
    SELECT 
        t.id AS movie_id,
        STRING_AGG(k.keyword, ', ') AS keywords
    FROM title t
    LEFT JOIN movie_keyword mk ON t.id = mk.movie_id
    LEFT JOIN keyword k ON mk.keyword_id = k.id
    GROUP BY t.id
),
final_selection AS (
    SELECT 
        rm.title, 
        rm.production_year, 
        rm.cast_count, 
        cm.company_name,
        cm.company_type,
        mwk.keywords
    FROM ranked_movies rm
    LEFT JOIN company_movies cm ON rm.title = cm.movie_id
    LEFT JOIN movies_with_keywords mwk ON rm.title = mwk.movie_id
    WHERE rm.rn <= 5
)

SELECT 
    fs.title, 
    fs.production_year,
    COALESCE(fs.cast_count, 0) AS cast_count, 
    COALESCE(fs.company_name, 'Independent') AS company, 
    COALESCE(fs.company_type, 'N/A') AS type,
    COALESCE(fs.keywords, 'No Keywords') AS keywords
FROM final_selection fs
ORDER BY fs.production_year DESC, fs.cast_count DESC;
