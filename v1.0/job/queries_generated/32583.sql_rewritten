WITH RECURSIVE MovieHierarchy AS (
    
    SELECT
        t.id AS movie_id,
        t.title,
        t.production_year,
        0 AS level
    FROM title t
    WHERE t.episode_of_id IS NULL
    
    UNION ALL
    
    
    SELECT
        t.id AS movie_id,
        t.title,
        t.production_year,
        mh.level + 1
    FROM title t
    JOIN MovieHierarchy mh ON t.episode_of_id = mh.movie_id
),
CastDetails AS (
    
    SELECT
        ci.movie_id,
        ak.name AS actor_name,
        rt.role AS role_name,
        ROW_NUMBER() OVER (PARTITION BY ci.movie_id ORDER BY ci.nr_order) AS role_order
    FROM cast_info ci
    JOIN aka_name ak ON ci.person_id = ak.person_id
    JOIN role_type rt ON ci.role_id = rt.id
),
MovieCompanies AS (
    
    SELECT
        mc.movie_id,
        cn.name AS company_name,
        ct.kind AS company_type,
        ROW_NUMBER() OVER (PARTITION BY mc.movie_id ORDER BY mc.note) AS company_order
    FROM movie_companies mc
    JOIN company_name cn ON mc.company_id = cn.id
    JOIN company_type ct ON mc.company_type_id = ct.id
),
FullMovieInfo AS (
    
    SELECT
        mh.movie_id,
        mh.title,
        mh.production_year,
        cd.actor_name,
        cd.role_name,
        mc.company_name,
        mc.company_type,
        mh.level,
        COALESCE(cd.role_order, 0) AS role_order,
        COALESCE(mc.company_order, 0) AS company_order
    FROM MovieHierarchy mh
    LEFT JOIN CastDetails cd ON mh.movie_id = cd.movie_id
    LEFT JOIN MovieCompanies mc ON mh.movie_id = mc.movie_id
)
SELECT
    f.movie_id,
    f.title,
    f.production_year,
    f.actor_name,
    f.role_name,
    f.company_name,
    f.company_type,
    f.level,
    COUNT(f.actor_name) OVER (PARTITION BY f.movie_id) AS total_actors,
    COUNT(DISTINCT f.company_name) OVER (PARTITION BY f.movie_id) AS unique_company_count,
    STRING_AGG(DISTINCT f.role_name, ', ') AS all_roles,
    CASE 
        WHEN f.level = 0 THEN 'Main Movie'
        ELSE 'Episode'
    END AS movie_type
FROM FullMovieInfo f
WHERE f.level >= 0
ORDER BY f.movie_id, f.level, f.role_order, f.company_order;