
WITH RankedMovies AS (
    SELECT 
        m.id AS movie_id, 
        m.title AS movie_title,
        m.production_year, 
        ROW_NUMBER() OVER (PARTITION BY m.production_year ORDER BY m.production_year DESC) AS movie_rank
    FROM 
        aka_title m
    WHERE 
        m.production_year IS NOT NULL
),
ActorRoles AS (
    SELECT 
        c.movie_id, 
        a.name AS actor_name, 
        r.role AS role_name, 
        c.nr_order
    FROM 
        cast_info c
    JOIN 
        aka_name a ON c.person_id = a.person_id
    JOIN 
        role_type r ON c.role_id = r.id
),
MoviesWithKeyword AS (
    SELECT 
        m.id AS movie_id, 
        k.keyword
    FROM 
        aka_title m
    JOIN 
        movie_keyword mk ON m.id = mk.movie_id
    JOIN 
        keyword k ON k.id = mk.keyword_id
)
SELECT 
    rm.movie_title,
    rm.production_year,
    ar.actor_name,
    ar.role_name,
    COALESCE(mkw.keyword, 'No Keyword') AS movie_keyword,
    COUNT(DISTINCT ar.actor_name) OVER (PARTITION BY rm.movie_id) AS actor_count,
    MAX(ar.nr_order) OVER (PARTITION BY rm.movie_id) AS max_order
FROM 
    RankedMovies rm
LEFT JOIN 
    ActorRoles ar ON rm.movie_id = ar.movie_id
LEFT JOIN 
    MoviesWithKeyword mkw ON rm.movie_id = mkw.movie_id
WHERE 
    rm.movie_rank <= 5
AND 
    (rm.production_year >= 2000 OR mkw.keyword IS NOT NULL)
GROUP BY 
    rm.movie_title, 
    rm.production_year, 
    ar.actor_name, 
    ar.role_name, 
    mkw.keyword, 
    rm.movie_id
ORDER BY 
    rm.production_year DESC, 
    rm.movie_title;
