
WITH RECURSIVE MovieActorCTE AS (
    SELECT 
        c.movie_id,
        c.person_id,
        ROW_NUMBER() OVER (PARTITION BY c.movie_id ORDER BY c.nr_order) AS actor_order
    FROM 
        cast_info c
    WHERE 
        c.note IS NOT NULL
),
MovieDetails AS (
    SELECT 
        t.id AS movie_id,
        t.title,
        t.production_year,
        COUNT(DISTINCT ca.person_id) AS actor_count,
        STRING_AGG(DISTINCT ak.name, ', ') AS actor_names
    FROM 
        aka_title t
        LEFT JOIN MovieActorCTE ma ON t.id = ma.movie_id
        LEFT JOIN aka_name ak ON ma.person_id = ak.person_id
    WHERE 
        t.production_year IS NOT NULL
        AND (t.kind_id IN (SELECT id FROM kind_type WHERE kind LIKE 'movie%') OR t.note IS NOT NULL)
    GROUP BY 
        t.id, t.title, t.production_year
),
FilmFestivalWins AS (
    SELECT 
        t.id,
        COUNT(DISTINCT f.festival_id) AS win_count
    FROM 
        (SELECT DISTINCT movie_id AS id FROM movie_info WHERE info_type_id = (SELECT id FROM info_type WHERE info = 'Awards')) t
    LEFT JOIN film_festival_winners f ON t.id = f.movie_id
    GROUP BY 
        t.id
),
DramaticTitles AS (
    SELECT 
        dt.id AS title_id,
        dt.title,
        COALESCE(m.actor_count, 0) AS actor_count,
        COALESCE(ff.win_count, 0) AS win_count
    FROM 
        title dt
    LEFT JOIN MovieDetails m ON dt.id = m.movie_id
    LEFT JOIN FilmFestivalWins ff ON dt.id = ff.id
    WHERE 
        dt.title ILIKE '%drama%' OR dt.production_year > 2000
),
TopDramas AS (
    SELECT 
        title,
        actor_count,
        win_count,
        (actor_count + win_count) AS popularity_score
    FROM 
        DramaticTitles
    WHERE 
        actor_count > 0
    ORDER BY 
        popularity_score DESC
    LIMIT 10
)
SELECT 
    dt.title AS "Dramatic Title",
    dt.actor_count AS "Number of Actors",
    dt.win_count AS "Awards Won",
    CASE 
        WHEN dt.actor_count IS NULL THEN 'Unknown'
        ELSE 'Known'
    END AS "Actor Status",
    CASE 
        WHEN dt.win_count > 0 THEN 'Award Winning'
        ELSE 'Non Award Winning'
    END AS "Award Status"
FROM 
    TopDramas dt
UNION ALL
SELECT 
    t.title AS "Dramatic Title",
    NULL AS "Number of Actors",
    NULL AS "Awards Won",
    'Unknown' AS "Actor Status",
    'Non Award Winning' AS "Award Status"
FROM 
    title t
WHERE 
    t.production_year < 2000
ORDER BY 
    "Dramatic Title" ASC;
