
WITH RECURSIVE movie_hierarchy AS (
    SELECT
        m.id AS movie_id,
        m.title,
        m.production_year,
        0 AS level
    FROM
        aka_title m
    WHERE
        m.kind_id = 1  

    UNION ALL

    SELECT
        m.id AS movie_id,
        m.title,
        m.production_year,
        mh.level + 1
    FROM
        aka_title m
    JOIN
        movie_link ml ON ml.linked_movie_id = m.id
    JOIN
        movie_hierarchy mh ON mh.movie_id = ml.movie_id
)

SELECT
    a.name AS actor_name,
    m.title AS movie_title,
    m.production_year,
    ROW_NUMBER() OVER (PARTITION BY a.id ORDER BY m.production_year DESC) AS movie_rank,
    COALESCE(p.info, 'No additional info') AS person_info,
    COUNT(DISTINCT kw.keyword) AS keyword_count
FROM
    cast_info c
JOIN
    aka_name a ON c.person_id = a.person_id
JOIN
    movie_hierarchy m ON c.movie_id = m.movie_id
LEFT JOIN
    person_info p ON p.person_id = c.person_id AND p.info_type_id = 1  
LEFT JOIN
    movie_keyword mw ON mw.movie_id = m.movie_id
LEFT JOIN
    keyword kw ON mw.keyword_id = kw.id
WHERE
    m.production_year >= 2000
    AND a.name IS NOT NULL
GROUP BY
    a.id, a.name, m.title, m.production_year, p.info
HAVING
    COUNT(DISTINCT kw.keyword) > 2
ORDER BY
    movie_rank, a.name;
