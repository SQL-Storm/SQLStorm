
WITH ranked_titles AS (
    SELECT
        a.title AS movie_title,
        a.production_year,
        k.keyword AS keyword,
        ROW_NUMBER() OVER (PARTITION BY a.id ORDER BY a.production_year DESC) AS rank
    FROM
        aka_title a
    JOIN
        movie_keyword mk ON a.id = mk.movie_id
    JOIN
        keyword k ON mk.keyword_id = k.id
    WHERE
        a.kind_id IN (SELECT id FROM kind_type WHERE kind = 'movie')
),
top_movies AS (
    SELECT
        title,
        production_year,
        STRING_AGG(keyword, ', ') AS keywords
    FROM
        ranked_titles
    WHERE
        rank = 1
    GROUP BY
        title, production_year
),
cast_summary AS (
    SELECT
        a.id AS movie_id,
        STRING_AGG(DISTINCT ak.name, ', ') AS cast_names,
        COUNT(c.person_id) AS total_cast
    FROM
        aka_title a
    JOIN
        cast_info c ON a.id = c.movie_id
    JOIN
        aka_name ak ON c.person_id = ak.person_id
    GROUP BY
        a.id
)
SELECT
    tm.movie_title,
    tm.production_year,
    tm.keywords,
    cs.cast_names,
    cs.total_cast
FROM
    top_movies tm
JOIN
    cast_summary cs ON tm.movie_title = cs.movie_id
ORDER BY
    tm.production_year DESC, tm.movie_title;
