
WITH RankedTitles AS (
    SELECT 
        t.id AS title_id, 
        t.title, 
        t.production_year, 
        ROW_NUMBER() OVER (PARTITION BY t.production_year ORDER BY t.production_year DESC) AS rank
    FROM 
        title t
    WHERE 
        t.production_year IS NOT NULL
),
ActorTitles AS (
    SELECT 
        a.person_id, 
        a.name AS actor_name, 
        rt.title, 
        rt.production_year
    FROM 
        aka_name a
    JOIN 
        cast_info c ON a.person_id = c.person_id
    JOIN 
        RankedTitles rt ON c.movie_id = rt.title_id
),
CompanyMovies AS (
    SELECT 
        mc.movie_id, 
        COUNT(DISTINCT cn.name) AS company_count
    FROM 
        movie_companies mc
    JOIN 
        company_name cn ON mc.company_id = cn.id
    GROUP BY 
        mc.movie_id
)
SELECT 
    at.actor_name,
    STRING_AGG(DISTINCT at.title, ', ') AS titles,
    COALESCE(cm.company_count, 0) AS total_companies,
    COUNT(DISTINCT at.production_year) AS production_year_count
FROM 
    ActorTitles at
LEFT JOIN 
    CompanyMovies cm ON at.title_id = cm.movie_id
GROUP BY 
    at.actor_name
HAVING 
    COUNT(DISTINCT at.title) > 5 OR COALESCE(cm.company_count, 0) > 3
ORDER BY 
    production_year_count DESC, 
    at.actor_name
LIMIT 10;
