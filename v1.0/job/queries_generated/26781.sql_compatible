
WITH movie_cast AS (
    SELECT 
        t.title AS movie_title,
        a.name AS actor_name,
        cc.kind AS cast_type,
        m.production_year,
        COUNT(*) OVER (PARTITION BY t.id) AS actor_count
    FROM 
        aka_title AS t
    JOIN 
        cast_info AS ci ON ci.movie_id = t.id
    JOIN 
        aka_name AS a ON a.person_id = ci.person_id
    LEFT JOIN 
        comp_cast_type AS cc ON ci.person_role_id = cc.id
    WHERE 
        t.production_year BETWEEN 2000 AND 2023
        AND t.kind_id IN (SELECT id FROM kind_type WHERE kind LIKE '%Movie%')
),
actor_movies AS (
    SELECT 
        actor_name,
        ARRAY_AGG(movie_title ORDER BY production_year) AS movies,
        SUM(actor_count) AS total_movies
    FROM 
        movie_cast
    GROUP BY 
        actor_name
    HAVING 
        SUM(actor_count) > 5
),
top_actors AS (
    SELECT 
        actor_name,
        movies,
        RANK() OVER (ORDER BY total_movies DESC) AS actor_rank
    FROM 
        actor_movies
)
SELECT 
    actor_name,
    movies,
    actor_rank
FROM 
    top_actors
WHERE 
    actor_rank <= 10
ORDER BY 
    actor_rank;
