
WITH RECURSIVE title_hierarchy AS (
    SELECT t.id AS title_id, t.title, t.production_year, t.season_nr, t.episode_nr, 
           1 AS level, 
           t.episode_of_id
    FROM title t
    WHERE t.episode_of_id IS NULL
    
    UNION ALL
    
    SELECT t2.id, t2.title, t2.production_year, t2.season_nr, t2.episode_nr, 
           th.level + 1 AS level, 
           t2.episode_of_id
    FROM title t2
    JOIN title_hierarchy th ON t2.episode_of_id = th.title_id
)

SELECT 
    ak.name AS actor_name,
    t.title AS movie_title,
    t.production_year,
    SUM(CASE WHEN ak.name IS NOT NULL THEN 1 ELSE 0 END) OVER (PARTITION BY t.production_year) AS total_actors_per_year,
    COUNT(DISTINCT c.id) AS total_cast,
    ARRAY_AGG(DISTINCT k.keyword) AS keywords,
    COUNT(DISTINCT CASE 
        WHEN (ci.role_id IS NULL AND ci.note IS NOT NULL) THEN ci.note 
        ELSE NULL END) AS non_role_notes
FROM aka_name ak
LEFT JOIN cast_info ci ON ak.person_id = ci.person_id
JOIN title t ON ci.movie_id = t.id
LEFT JOIN movie_keyword mk ON t.id = mk.movie_id
LEFT JOIN keyword k ON mk.keyword_id = k.id
LEFT JOIN complete_cast cc ON t.id = cc.movie_id
WHERE ak.name IS NOT NULL
AND (t.production_year > 2000 OR t.production_year IS NULL)
GROUP BY ak.name, t.title, t.production_year
HAVING COUNT(DISTINCT t.id) > 1
ORDER BY t.production_year DESC, COUNT(DISTINCT ci.id) DESC;
