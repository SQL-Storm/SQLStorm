WITH RankedMovies AS (
    SELECT 
        a.person_id,
        c.movie_id,
        title.title,
        ROW_NUMBER() OVER (PARTITION BY c.person_id ORDER BY title.production_year DESC) AS rank
    FROM 
        cast_info c
    JOIN 
        aka_name a ON c.person_id = a.person_id
    JOIN 
        aka_title title ON c.movie_id = title.movie_id
    WHERE 
        title.production_year IS NOT NULL
),

CombinedData AS (
    SELECT
        rm.person_id,
        count(DISTINCT rm.movie_id) AS movie_count,
        AVG(EXTRACT(YEAR FROM cast('2024-10-01' as date)) - rm.rank) AS avg_year_difference
    FROM
        RankedMovies rm
    GROUP BY
        rm.person_id
),

CompanyCertainty AS (
    SELECT 
        mc.movie_id,
        COUNT(DISTINCT cc.id) AS company_count,
        MAX(CASE WHEN cc.country_code IS NULL THEN 0 ELSE 1 END) AS has_country
    FROM 
        movie_companies mc 
    LEFT JOIN 
        company_name cc ON mc.company_id = cc.id
    GROUP BY 
        mc.movie_id
),

FilteredCompanies AS (
    SELECT 
        movie_id,
        company_count,
        has_country
    FROM 
        CompanyCertainty
    WHERE 
        has_country = 1 AND company_count > 2
),

CastTitles AS (
    SELECT 
        c.movie_id,
        string_agg(DISTINCT a.name, ', ') AS cast_names
    FROM 
        cast_info c
    JOIN 
        aka_name a ON c.person_id = a.person_id
    GROUP BY c.movie_id
)

SELECT 
    title.title AS movie_title,
    COALESCE(cd.movie_count, 0) AS unique_actors_count,
    COALESCE(ct.cast_names, 'No cast available') AS cast_details,
    cc.company_count AS num_companies
FROM 
    aka_title title
LEFT JOIN 
    CombinedData cd ON title.movie_id = cd.movie_id
LEFT JOIN 
    FilteredCompanies cc ON title.movie_id = cc.movie_id
LEFT JOIN 
    CastTitles ct ON title.movie_id = ct.movie_id
WHERE 
    title.production_year BETWEEN 1990 AND 2020 
    AND title.kind_id IN (SELECT id FROM kind_type WHERE kind LIKE 'fe%')
ORDER BY 
    unique_actors_count DESC, 
    title.production_year ASC;