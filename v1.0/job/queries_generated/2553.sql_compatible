
WITH MovieDetails AS (
    SELECT 
        t.id AS movie_id, 
        t.title, 
        t.production_year, 
        ARRAY_AGG(DISTINCT k.keyword) AS keywords,
        COUNT(DISTINCT cc.person_id) AS cast_count
    FROM 
        aka_title t
    LEFT JOIN 
        movie_keyword mk ON t.id = mk.movie_id
    LEFT JOIN 
        keyword k ON mk.keyword_id = k.id
    LEFT JOIN 
        complete_cast cc ON t.id = cc.movie_id
    GROUP BY 
        t.id, t.title, t.production_year
),
DirectorCount AS (
    SELECT 
        m.movie_id, 
        COUNT(DISTINCT c.person_id) AS director_count
    FROM 
        MovieDetails m
    JOIN 
        cast_info c ON m.movie_id = c.movie_id
    INNER JOIN 
        role_type r ON c.role_id = r.id 
    WHERE 
        r.role = 'Director'
    GROUP BY 
        m.movie_id
),
RankedMovies AS (
    SELECT 
        md.movie_id, 
        md.title, 
        md.production_year, 
        md.keywords, 
        dc.director_count,
        RANK() OVER (ORDER BY md.production_year DESC, dc.director_count DESC) AS movie_rank
    FROM 
        MovieDetails md
    LEFT JOIN 
        DirectorCount dc ON md.movie_id = dc.movie_id
)
SELECT 
    rm.movie_id, 
    rm.title, 
    rm.production_year, 
    rm.keywords, 
    COALESCE(rm.director_count, 0) AS director_count,
    CASE 
        WHEN rm.director_count IS NULL THEN 'No Directors'
        WHEN rm.director_count > 5 THEN 'Many Directors'
        ELSE 'Few Directors' 
    END AS director_status
FROM 
    RankedMovies rm
WHERE 
    rm.movie_rank <= 10 
ORDER BY 
    rm.movie_rank;
