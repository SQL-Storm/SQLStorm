
WITH movie_data AS (
    SELECT 
        t.id AS movie_id,
        t.title,
        t.production_year,
        COALESCE(NULLIF(t.season_nr, 0), 'N/A') AS season_number,
        COALESCE(NULLIF(t.episode_nr, 0), 'N/A') AS episode_number,
        CASE 
            WHEN t.kind_id IN (1, 2) THEN 'Film'
            WHEN t.kind_id IN (3, 4) THEN 'Series'
            ELSE 'Other'
        END AS kind_classification
    FROM
        aka_title AS t
    WHERE 
        t.production_year IS NOT NULL
        AND t.title IS NOT NULL
),
cast_summary AS (
    SELECT 
        c.movie_id,
        COUNT(DISTINCT c.person_id) AS total_cast,
        STRING_AGG(DISTINCT a.name, ', ') AS actors
    FROM 
        cast_info AS c
    JOIN 
        aka_name AS a ON c.person_id = a.person_id
    WHERE 
        c.note IS NULL
    GROUP BY 
        c.movie_id
),
movie_keywords AS (
    SELECT 
        mk.movie_id,
        STRING_AGG(k.keyword, ', ') AS keywords
    FROM 
        movie_keyword AS mk
    JOIN 
        keyword AS k ON mk.keyword_id = k.id
    GROUP BY 
        mk.movie_id
),
combined_data AS (
    SELECT 
        md.movie_id,
        md.title,
        md.production_year,
        md.season_number,
        md.episode_number,
        md.kind_classification,
        cs.total_cast,
        cs.actors,
        COALESCE(mk.keywords, 'No keywords') AS keywords
    FROM 
        movie_data AS md
    LEFT JOIN 
        cast_summary AS cs ON md.movie_id = cs.movie_id
    LEFT JOIN 
        movie_keywords AS mk ON md.movie_id = mk.movie_id
)
SELECT 
    cd.title,
    cd.production_year,
    cd.kind_classification,
    cd.total_cast,
    cd.actors,
    cd.keywords,
    CASE 
        WHEN cd.total_cast IS NULL THEN 'No Cast Available'
        WHEN cd.total_cast > 5 THEN 'High Cast Count'
        WHEN cd.total_cast BETWEEN 3 AND 5 THEN 'Moderate Cast Count'
        ELSE 'Low Cast Count'
    END AS cast_count_classification
FROM 
    combined_data AS cd
WHERE 
    cd.production_year > 2000
ORDER BY 
    cd.production_year DESC,
    cd.total_cast DESC
LIMIT 100;
