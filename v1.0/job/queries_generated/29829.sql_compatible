
WITH ranked_movies AS (
  SELECT 
    mt.id AS movie_id,
    mt.title AS movie_title,
    mt.production_year,
    COUNT(DISTINCT ca.person_id) AS num_cast_members,
    STRING_AGG(DISTINCT ak.name, ', ') AS aka_names
  FROM 
    aka_title ak
  JOIN 
    title mt ON ak.movie_id = mt.id
  LEFT JOIN 
    cast_info ca ON ca.movie_id = mt.id
  GROUP BY 
    mt.id, mt.title, mt.production_year
),
top_movies AS (
  SELECT 
    movie_id,
    movie_title,
    production_year,
    num_cast_members,
    aka_names,
    ROW_NUMBER() OVER (ORDER BY num_cast_members DESC) AS rank
  FROM 
    ranked_movies
  WHERE 
    production_year >= 2000
)
SELECT 
  tm.movie_id,
  tm.movie_title,
  tm.production_year,
  tm.num_cast_members,
  tm.aka_names,
  JSON_AGG(JSON_BUILD_OBJECT('name', cn.name, 'country', cn.country_code)) AS company_info
FROM 
  top_movies tm
LEFT JOIN 
  movie_companies mc ON mc.movie_id = tm.movie_id
LEFT JOIN 
  company_name cn ON cn.id = mc.company_id
WHERE 
  tm.rank <= 10
GROUP BY 
  tm.movie_id, tm.movie_title, tm.production_year, tm.num_cast_members, tm.aka_names
ORDER BY 
  tm.num_cast_members DESC;
