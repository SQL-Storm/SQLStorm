
WITH ranked_movies AS (
    SELECT
        at.title,
        at.production_year,
        COUNT(ci.person_id) AS actor_count,
        ROW_NUMBER() OVER (PARTITION BY at.production_year ORDER BY COUNT(ci.person_id) DESC) AS rank
    FROM
        aka_title at
    LEFT JOIN
        cast_info ci ON at.movie_id = ci.movie_id
    GROUP BY
        at.title, at.production_year
),
top_movies AS (
    SELECT
        title,
        production_year,
        actor_count
    FROM
        ranked_movies
    WHERE
        rank <= 5
),
actor_details AS (
    SELECT
        ak.name AS actor_name,
        at.title AS movie_title,
        at.production_year,
        COUNT(DISTINCT mc.company_id) AS company_count
    FROM
        cast_info ci
    INNER JOIN
        aka_name ak ON ci.person_id = ak.person_id
    INNER JOIN
        aka_title at ON ci.movie_id = at.movie_id
    LEFT JOIN
        movie_companies mc ON at.movie_id = mc.movie_id
    WHERE
        ak.name IS NOT NULL
    GROUP BY
        ak.name, at.title, at.production_year
)
SELECT
    t.title AS movie_title,
    t.production_year,
    a.actor_name,
    a.company_count,
    COALESCE(NULLIF(t.actor_count, 0), 'N/A') AS total_actors
FROM
    top_movies t
JOIN
    actor_details a ON t.title = a.movie_title AND t.production_year = a.production_year
ORDER BY
    t.production_year DESC, t.actor_count DESC;
