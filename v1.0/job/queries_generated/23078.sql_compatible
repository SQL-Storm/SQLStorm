
WITH RankedMovies AS (
    SELECT
        title.id AS movie_id,
        title.title,
        title.production_year,
        ROW_NUMBER() OVER (PARTITION BY title.production_year ORDER BY title.title) AS year_rank
    FROM
        title
    WHERE
        title.production_year IS NOT NULL
),
ActorRoles AS (
    SELECT
        ak.name AS actor_name,
        ct.kind AS role_type,
        m.title AS movie_title,
        m.production_year,
        ROW_NUMBER() OVER (PARTITION BY ak.person_id ORDER BY m.production_year DESC) AS role_rank
    FROM
        aka_name ak
        JOIN cast_info ci ON ak.person_id = ci.person_id
        JOIN aka_title m ON ci.movie_id = m.movie_id
        JOIN role_type ct ON ci.role_id = ct.id
    WHERE
        ak.name IS NOT NULL
)
SELECT
    rm.movie_id,
    rm.title AS movie_title,
    rm.production_year,
    ar.actor_name,
    ar.role_type,
    CASE 
        WHEN ar.role_rank = 1 THEN 'Main Role'
        ELSE 'Supporting Role'
    END AS role_indicator,
    COALESCE(NULLIF(rm.title, ''), 'Untitled') AS safe_title
FROM
    RankedMovies rm
LEFT JOIN
    ActorRoles ar ON rm.movie_id = ar.movie_title AND rm.production_year = ar.production_year
WHERE
    rm.year_rank <= 5
GROUP BY
    rm.movie_id,
    rm.title,
    rm.production_year,
    ar.actor_name,
    ar.role_type,
    ar.role_rank
ORDER BY
    rm.production_year DESC,
    ar.actor_name ASC NULLS LAST;
