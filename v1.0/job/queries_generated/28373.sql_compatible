
WITH RankedTitles AS (
    SELECT 
        a.title AS movie_title,
        a.production_year,
        a.kind_id,
        t.name AS genre,
        ROW_NUMBER() OVER (PARTITION BY a.production_year ORDER BY a.title) AS rank
    FROM 
        aka_title a
    JOIN 
        kind_type t ON a.kind_id = t.id
),
PopularActors AS (
    SELECT 
        ak.name AS actor_name,
        COUNT(ci.movie_id) AS movie_count
    FROM 
        aka_name ak
    JOIN 
        cast_info ci ON ak.person_id = ci.person_id
    GROUP BY 
        ak.name
    HAVING 
        COUNT(ci.movie_id) > 5
),
MovieDetails AS (
    SELECT 
        rt.movie_title,
        rt.production_year,
        rt.genre,
        pa.actor_name,
        COUNT(mk.keyword_id) AS keyword_count
    FROM 
        RankedTitles rt
    JOIN 
        complete_cast cc ON rt.id = cc.movie_id
    JOIN 
        PopularActors pa ON pa.actor_name = (
            SELECT ak.name
            FROM aka_name ak
            JOIN cast_info ci ON ak.person_id = ci.person_id
            WHERE ci.movie_id = cc.movie_id
            LIMIT 1
        )
    LEFT JOIN 
        movie_keyword mk ON mk.movie_id = cc.movie_id
    GROUP BY 
        rt.movie_title, rt.production_year, rt.genre, pa.actor_name
)
SELECT 
    movie_title,
    production_year,
    genre,
    actor_name,
    keyword_count
FROM 
    MovieDetails
ORDER BY 
    production_year DESC, keyword_count DESC;
