
WITH RankedTitles AS (
    SELECT 
        t.title,
        t.production_year,
        ROW_NUMBER() OVER (PARTITION BY t.production_year ORDER BY RANDOM()) AS random_rank
    FROM title t
    WHERE t.kind_id = (SELECT id FROM kind_type WHERE kind = 'movie')
),
ExpandedCast AS (
    SELECT 
        c.movie_id,
        a.name AS actor_name,
        cc.kind AS cast_type,
        ROW_NUMBER() OVER (PARTITION BY c.movie_id ORDER BY c.nr_order) AS actor_order
    FROM cast_info c
    JOIN aka_name a ON c.person_id = a.person_id
    JOIN comp_cast_type cc ON c.person_role_id = cc.id
    WHERE cc.kind IS NOT NULL
),
MovieKeywords AS (
    SELECT 
        mk.movie_id,
        STRING_AGG(k.keyword, ', ') AS all_keywords
    FROM movie_keyword mk
    JOIN keyword k ON mk.keyword_id = k.id
    GROUP BY mk.movie_id
),
FilteredMovies AS (
    SELECT 
        mt.title,
        mt.production_year,
        ec.actor_name,
        ec.cast_type,
        mk.all_keywords,
        COUNT(ec.actor_name) OVER (PARTITION BY mt.title, mt.production_year) AS total_actors
    FROM RankedTitles mt
    LEFT JOIN ExpandedCast ec ON mt.title = ec.movie_id
    LEFT JOIN MovieKeywords mk ON mt.title = mk.movie_id
    WHERE mt.random_rank <= 5  
)
SELECT 
    COALESCE(fm.title, 'Unknown Title') AS Title,
    COALESCE(fm.production_year, 0) AS Production_Year,
    COALESCE(fm.actor_name, 'Unknown Actor') AS Actor,
    COALESCE(fm.cast_type, 'Unknown Role') AS Role,
    COALESCE(fm.all_keywords, 'No Keywords') AS Keywords,
    (CASE 
        WHEN fm.total_actors > 0 THEN CONCAT(fm.total_actors, ' actors')
        ELSE 'No actors in this movie'
    END) AS Actor_Info
FROM FilteredMovies fm
ORDER BY fm.production_year DESC, fm.total_actors DESC
LIMIT 50;
