WITH RECURSIVE movie_hierarchy AS (
    SELECT
        m.id AS movie_id,
        m.title,
        m.production_year,
        m.kind_id,
        1 AS level
    FROM
        aka_title m
    WHERE
        m.production_year >= 2000  

    UNION ALL

    SELECT
        m.id AS movie_id,
        m.title,
        m.production_year,
        m.kind_id,
        mh.level + 1
    FROM
        movie_hierarchy mh
    JOIN
        aka_title m ON mh.movie_id = m.episode_of_id
)

SELECT
    a.name AS actor_name,
    mt.title AS movie_title,
    mt.production_year,
    ct.kind AS character_type,
    COALESCE(GROUP_CONCAT(DISTINCT kw.keyword), 'No Keywords') AS keywords,
    COUNT(DISTINCT cc.person_id) AS number_of_actors,
    SUM(CASE WHEN mp.info_type_id IS NOT NULL THEN 1 ELSE 0 END) AS info_count
FROM
    cast_info cc
JOIN
    aka_name a ON cc.person_id = a.person_id
JOIN
    movie_hierarchy mt ON cc.movie_id = mt.movie_id
JOIN
    role_type rt ON cc.role_id = rt.id
LEFT JOIN
    company_name cn ON cn.id = (SELECT company_id FROM movie_companies mc WHERE mc.movie_id = cc.movie_id LIMIT 1)
LEFT JOIN
    movie_keyword mk ON mk.movie_id = cc.movie_id
LEFT JOIN
    keyword kw ON mk.keyword_id = kw.id
LEFT JOIN
    movie_info mp ON mp.movie_id = mt.movie_id AND mp.info_type_id = (SELECT id FROM info_type WHERE info = 'Budget')
JOIN
    comp_cast_type ct ON ct.id = cc.person_role_id
WHERE
    mt.production_year BETWEEN 2000 AND 2023
    AND (a.name IS NOT NULL OR rt.role IS NOT NULL)
GROUP BY
    a.name, mt.title, mt.production_year, ct.kind
ORDER BY
    mt.production_year DESC, a.name
LIMIT 100;