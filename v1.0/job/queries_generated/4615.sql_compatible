
WITH RankedMovies AS (
    SELECT 
        t.title,
        t.production_year,
        t.kind_id,
        ROW_NUMBER() OVER (PARTITION BY t.kind_id ORDER BY t.production_year DESC) AS rank
    FROM 
        aka_title t
    WHERE 
        t.production_year IS NOT NULL
), 
CastDetails AS (
    SELECT 
        c.movie_id, 
        p.name AS actor_name,
        COUNT(c.person_id) AS total_actors
    FROM 
        cast_info c
    JOIN 
        aka_name p ON c.person_id = p.person_id
    GROUP BY 
        c.movie_id, p.name
), 
FilteredMovies AS (
    SELECT 
        rm.*,
        cc.total_actors
    FROM 
        RankedMovies rm
    LEFT JOIN 
        CastDetails cc ON rm.id = cc.movie_id
    WHERE 
        rm.rank <= 3
)
SELECT 
    fm.title,
    fm.production_year,
    kt.kind,
    COALESCE(fm.total_actors, 0) AS actor_count,
    STRING_AGG(DISTINCT p.name, ', ') AS actor_list
FROM 
    FilteredMovies fm
LEFT JOIN 
    kind_type kt ON fm.kind_id = kt.id
LEFT JOIN 
    cast_info ci ON fm.id = ci.movie_id
LEFT JOIN 
    aka_name p ON ci.person_id = p.person_id
GROUP BY 
    fm.title, fm.production_year, kt.kind, fm.total_actors
HAVING 
    COALESCE(fm.total_actors, 0) > 0
ORDER BY 
    fm.production_year DESC, fm.title;
