
WITH RankedTitles AS (
    SELECT 
        a.title,
        a.production_year,
        ROW_NUMBER() OVER (PARTITION BY a.production_year ORDER BY a.title) AS title_rank
    FROM 
        aka_title a
    WHERE 
        a.production_year IS NOT NULL
),
CompanyCounts AS (
    SELECT 
        m.movie_id,
        COUNT(DISTINCT mc.company_id) AS num_companies
    FROM 
        movie_companies mc
    JOIN 
        complete_cast m ON mc.movie_id = m.movie_id
    GROUP BY 
        m.movie_id
),
RoleCounts AS (
    SELECT 
        ci.movie_id,
        COUNT(DISTINCT ci.person_id) AS num_roles
    FROM 
        cast_info ci
    GROUP BY 
        ci.movie_id
),
KeywordCounts AS (
    SELECT 
        mk.movie_id,
        COUNT(mk.keyword_id) AS num_keywords
    FROM 
        movie_keyword mk
    JOIN 
        keyword k ON mk.keyword_id = k.id
    GROUP BY 
        mk.movie_id
),
ExtendedInfo AS (
    SELECT 
        COALESCE(t.title, 'Unknown Title') AS title,
        COALESCE(RC.num_roles, 0) AS role_count,
        COALESCE(CC.num_companies, 0) AS company_count,
        COALESCE(KC.num_keywords, 0) AS keyword_count,
        t.production_year
    FROM 
        RankedTitles t
    LEFT JOIN 
        RoleCounts RC ON t.id = RC.movie_id
    LEFT JOIN 
        CompanyCounts CC ON t.id = CC.movie_id
    LEFT JOIN 
        KeywordCounts KC ON t.id = KC.movie_id
)
SELECT 
    e.title,
    e.production_year,
    e.role_count,
    e.company_count,
    e.keyword_count,
    CASE
        WHEN e.role_count > 10 THEN 'Many Roles'
        WHEN e.role_count BETWEEN 5 AND 10 THEN 'Moderate Roles'
        ELSE 'Few Roles'
    END AS role_category
FROM 
    ExtendedInfo e
WHERE 
    e.production_year >= 2000
ORDER BY 
    e.production_year DESC, 
    e.title;
