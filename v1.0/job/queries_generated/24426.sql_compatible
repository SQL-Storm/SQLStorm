
WITH RECURSIVE actor_hierarchy AS (
    SELECT 
        ai.person_id AS actor_id,
        a.name AS actor_name,
        1 AS level
    FROM 
        aka_name a
    JOIN 
        cast_info ci ON a.person_id = ci.person_id
    WHERE 
        a.name IS NOT NULL
    UNION ALL
    SELECT 
        ai.person_id,
        a.name,
        ah.level + 1
    FROM 
        actor_hierarchy ah
    JOIN 
        cast_info ci ON ah.actor_id = ci.person_id
    JOIN 
        aka_name a ON ci.person_id = a.person_id
    WHERE 
        a.name IS NOT NULL
),
movie_details AS (
    SELECT 
        mt.movie_id,
        mt.title AS movie_title,
        mt.production_year,
        STRING_AGG(ka.name, ', ') AS cast_names,
        COUNT(DISTINCT ci.person_id) AS cast_count,
        SUM(CASE WHEN ci.note IS NOT NULL THEN 1 ELSE 0 END) AS noted_casts
    FROM 
        aka_title mt
    LEFT JOIN 
        cast_info ci ON mt.movie_id = ci.movie_id
    LEFT JOIN 
        aka_name ka ON ci.person_id = ka.person_id
    WHERE 
        mt.production_year IS NOT NULL
    GROUP BY 
        mt.movie_id, mt.title, mt.production_year
)
SELECT 
    md.movie_title,
    COALESCE(CAST(md.production_year AS VARCHAR), 'Unknown Year') AS year,
    md.cast_names,
    md.cast_count,
    NULLIF(md.noted_casts, 0) AS active_cast,
    ah.actor_name,
    ah.level,
    ROW_NUMBER() OVER (PARTITION BY md.movie_id ORDER BY ah.level DESC) AS rank_level
FROM 
    movie_details md
LEFT JOIN 
    actor_hierarchy ah ON md.cast_count > 0
WHERE 
    EXISTS (
        SELECT 1 
        FROM movie_keyword mk 
        WHERE mk.movie_id = md.movie_id AND mk.keyword_id IN (SELECT id FROM keyword WHERE keyword LIKE '%Action%')
    )
ORDER BY 
    md.production_year DESC,
    md.cast_count DESC
LIMIT 
    10;
