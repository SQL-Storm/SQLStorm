WITH MovieDetails AS (
    SELECT 
        t.title,
        t.production_year,
        COUNT(DISTINCT c.person_id) AS actor_count,
        AVG(years_since_debut) AS avg_years_since_debut
    FROM title t
    LEFT JOIN (
        SELECT 
            ci.movie_id,
            p.person_id,
            (EXTRACT(YEAR FROM cast('2024-10-01' as date)) - MIN(pi.info::integer)) AS years_since_debut
        FROM cast_info ci
        JOIN person_info pi ON ci.person_id = pi.person_id
        GROUP BY ci.movie_id, p.person_id
    ) AS debut ON t.id = debut.movie_id
    LEFT JOIN cast_info c ON t.id = c.movie_id
    GROUP BY t.id, t.title, t.production_year
),
KeywordDetails AS (
    SELECT 
        m.movie_id,
        STRING_AGG(k.keyword, ', ') AS keywords
    FROM movie_keyword m
    JOIN keyword k ON m.keyword_id = k.id
    GROUP BY m.movie_id
),
CompanyInfo AS (
    SELECT 
        mc.movie_id,
        STRING_AGG(DISTINCT CONCAT(cn.name, ' (', ct.kind, ')'), '; ') AS companies
    FROM movie_companies mc
    JOIN company_name cn ON mc.company_id = cn.id
    JOIN company_type ct ON mc.company_type_id = ct.id
    GROUP BY mc.movie_id
)

SELECT 
    md.title,
    md.production_year,
    COALESCE(kd.keywords, 'No Keywords') AS keywords,
    COALESCE(ci.companies, 'No Companies') AS companies,
    md.actor_count,
    md.avg_years_since_debut
FROM MovieDetails md
LEFT JOIN KeywordDetails kd ON md.movie_id = kd.movie_id
LEFT JOIN CompanyInfo ci ON md.movie_id = ci.movie_id
WHERE md.production_year IS NOT NULL
  AND md.actor_count > 0
ORDER BY md.production_year DESC, md.actor_count DESC;