
WITH RECURSIVE cast_hierarchy AS (
    SELECT ci.id AS cast_id, ci.movie_id, ci.person_id, ci.nr_order, 
           1 AS level, 
           ak.name AS actor_name
    FROM cast_info ci
    JOIN aka_name ak ON ci.person_id = ak.person_id
    WHERE ci.nr_order = 1
    
    UNION ALL
    
    SELECT ci.id AS cast_id, ci.movie_id, ci.person_id, ci.nr_order, 
           ch.level + 1, 
           ak.name AS actor_name
    FROM cast_info ci
    JOIN aka_name ak ON ci.person_id = ak.person_id
    JOIN cast_hierarchy ch ON ci.movie_id = ch.movie_id AND ci.nr_order = ch.nr_order + 1
),
ranked_movies AS (
    SELECT ci.movie_id, 
           tit.title, 
           tit.production_year, 
           ROW_NUMBER() OVER (PARTITION BY ci.movie_id ORDER BY COUNT(DISTINCT ci.person_id) DESC) AS actor_rank
    FROM cast_info ci
    JOIN title tit ON ci.movie_id = tit.id
    JOIN complete_cast cc ON cc.movie_id = ci.movie_id 
    LEFT JOIN company_name cn ON cn.id = (
        SELECT mc.company_id 
        FROM movie_companies mc 
        WHERE mc.movie_id = ci.movie_id 
        LIMIT 1
    )
    GROUP BY ci.movie_id, tit.title, tit.production_year
),
agg_genre AS (
    SELECT mt.movie_id, 
           STRING_AGG(kt.keyword, ', ') AS genres
    FROM movie_keyword mt
    JOIN keyword kt ON mt.keyword_id = kt.id
    GROUP BY mt.movie_id
)
SELECT mh.movie_id,
       mh.title,
       mh.production_year,
       ak.actor_name,
       COALESCE(g.genres, 'No Genre') AS genres,
       COUNT(DISTINCT ch.person_id) AS total_actor_count,
       SUM(CASE WHEN ci.note IS NOT NULL THEN 1 ELSE 0 END) AS note_count,
       AVG(mvi.info) AS average_rating
FROM ranked_movies mh
JOIN cast_hierarchy ch ON mh.movie_id = ch.movie_id
LEFT JOIN agg_genre g ON mh.movie_id = g.movie_id
JOIN movie_info mvi ON mvi.movie_id = mh.movie_id AND mvi.info_type_id = (SELECT id FROM info_type WHERE info = 'Rating')
JOIN aka_name ak ON ch.person_id = ak.person_id
WHERE mh.actor_rank = 1
GROUP BY mh.movie_id, mh.title, mh.production_year, ak.actor_name, g.genres
ORDER BY mh.production_year DESC, total_actor_count DESC
LIMIT 100;
