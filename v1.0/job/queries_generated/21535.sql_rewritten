WITH RankedMovies AS (
    SELECT 
        t.id AS movie_id,
        t.title,
        t.production_year,
        ROW_NUMBER() OVER (PARTITION BY t.production_year ORDER BY t.production_year DESC, t.title) AS title_rank
    FROM 
        aka_title t
    WHERE 
        t.production_year IS NOT NULL
),
ActorRoles AS (
    SELECT 
        p.id AS person_id,
        ak.name AS actor_name,
        c.movie_id,
        r.role AS actor_role,
        ROW_NUMBER() OVER (PARTITION BY c.movie_id ORDER BY ak.name) AS role_rank
    FROM
        cast_info c
    JOIN 
        aka_name ak ON ak.person_id = c.person_id
    JOIN 
        role_type r ON r.id = c.role_id
    WHERE 
        ak.name IS NOT NULL
),
MoviesWithTopActors AS (
    SELECT 
        rm.movie_id,
        rm.title,
        rm.production_year,
        ar.actor_name,
        ar.actor_role,
        ar.role_rank
    FROM 
        RankedMovies rm
    LEFT JOIN 
        ActorRoles ar ON rm.movie_id = ar.movie_id
    WHERE 
        rm.title_rank <= 2 
),
MoviesWithCompanies AS (
    SELECT 
        m.movie_id,
        m.title,
        m.production_year,
        STRING_AGG(DISTINCT cn.name, ', ') AS production_companies
    FROM 
        MoviesWithTopActors m
    LEFT JOIN 
        movie_companies mc ON mc.movie_id = m.movie_id
    LEFT JOIN 
        company_name cn ON cn.id = mc.company_id
    GROUP BY 
        m.movie_id, m.title, m.production_year
),
FinalOutput AS (
    SELECT 
        m.title,
        m.production_year,
        COALESCE(m.production_companies, 'No Companies') AS production_companies,
        COUNT(ar.actor_name) AS number_of_actors,
        MAX(CASE WHEN ar.role_rank = 1 THEN ar.actor_name END) AS top_actor,
        COUNT(DISTINCT CASE WHEN ar.actor_role LIKE '%Director%' THEN ar.actor_name END) AS number_of_directors
    FROM 
        MoviesWithCompanies m
    LEFT JOIN 
        ActorRoles ar ON m.movie_id = ar.movie_id
    GROUP BY 
        m.title, m.production_year, m.production_companies
    HAVING 
        COUNT(ar.actor_name) > 0
)

SELECT 
    title,
    production_year,
    production_companies,
    number_of_actors,
    top_actor,
    number_of_directors
FROM 
    FinalOutput
WHERE 
    production_year BETWEEN 2000 AND 2023
ORDER BY 
    production_year DESC, title;