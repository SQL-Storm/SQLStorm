WITH RankedMovies AS (
    SELECT 
        mt.title,
        mt.production_year,
        COUNT(DISTINCT mk.keyword) AS keyword_count,
        ROW_NUMBER() OVER (PARTITION BY mt.production_year ORDER BY COUNT(DISTINCT mk.keyword) DESC) AS rank
    FROM 
        aka_title mt
    LEFT JOIN 
        movie_keyword mk ON mt.id = mk.movie_id
    GROUP BY 
        mt.id, mt.title, mt.production_year
),
TopMovies AS (
    SELECT 
        title,
        production_year
    FROM 
        RankedMovies
    WHERE 
        rank <= 5
),
ActorRoles AS (
    SELECT 
        ak.name AS actor_name,
        COUNT(DISTINCT ci.movie_id) AS total_movies,
        STRING_AGG(DISTINCT at.title, ', ') AS movie_titles
    FROM 
        aka_name ak
    JOIN 
        cast_info ci ON ak.person_id = ci.person_id
    JOIN 
        aka_title at ON ci.movie_id = at.id
    WHERE 
        ak.name IS NOT NULL
    GROUP BY 
        ak.id
),
TheatreActors AS (
    SELECT 
        ca.id AS actor_id,
        ca.name AS actor_name,
        COALESCE(ar.total_movies, 0) AS total_movies,
        COALESCE(ar.movie_titles, 'No movies') AS movie_titles
    FROM 
        char_name ca
    LEFT JOIN 
        ActorRoles ar ON ca.name = ar.actor_name
)
SELECT 
    ta.actor_id,
    ta.actor_name,
    ta.total_movies,
    ta.movie_titles,
    tm.title AS top_movie,
    tm.production_year
FROM 
    TheatreActors ta
LEFT JOIN 
    TopMovies tm ON ta.total_movies > 0 
WHERE 
    ta.actor_name IS NOT NULL AND 
    (tm.production_year IS NULL OR tm.production_year > 2000)
ORDER BY 
    ta.total_movies DESC, 
    COALESCE(tm.production_year, 9999) ASC;