WITH RECURSIVE movie_hierarchy AS (
    SELECT t.id AS movie_id, 
           t.title, 
           t.production_year, 
           t.kind_id, 
           CAST(NULL AS INTEGER) AS parent_id
      FROM aka_title t
     WHERE t.kind_id IN (SELECT id FROM kind_type WHERE kind = 'movie')
    
    UNION ALL
    
    SELECT t.id, 
           t.title, 
           t.production_year, 
           t.kind_id, 
           h.movie_id
      FROM aka_title t
      JOIN movie_hierarchy h ON t.episode_of_id = h.movie_id
),
ranked_cast AS (
    SELECT c.movie_id,
           a.name AS actor_name,
           ROW_NUMBER() OVER (PARTITION BY c.movie_id ORDER BY c.nr_order) AS actor_order,
           COUNT(*) OVER (PARTITION BY c.movie_id) AS total_cast
      FROM cast_info c
      JOIN aka_name a ON c.person_id = a.person_id
     WHERE a.name IS NOT NULL
),
aggregate_info AS (
    SELECT m.movie_id,
           COUNT(DISTINCT c.person_id) AS unique_actors,
           STRING_AGG(DISTINCT a.actor_name, ', ') AS all_actors,
           MAX(m.production_year) AS last_produced_year
      FROM movie_hierarchy m
      LEFT JOIN cast_info c ON m.movie_id = c.movie_id
      LEFT JOIN aka_name a ON c.person_id = a.person_id AND a.name IS NOT NULL
     GROUP BY m.movie_id
)
SELECT h.movie_id,
       h.title,
       h.production_year,
       h.kind_id,
       COALESCE(ai.unique_actors, 0) AS unique_actors_count,
       ai.all_actors,
       CASE 
           WHEN ai.last_produced_year IS NOT NULL 
           THEN 'Produced after ' || (ai.last_produced_year - 5) || ' years ago'
           ELSE 'Production year unknown'
       END AS production_status,
       RANK() OVER (ORDER BY ai.unique_actors DESC) AS actor_ranking
  FROM movie_hierarchy h
  LEFT JOIN aggregate_info ai ON h.movie_id = ai.movie_id
 WHERE h.production_year > 2000
   AND (h.kind_id, COALESCE(ai.unique_actors, 0)) NOT IN (
        SELECT kind_id, unique_actors FROM aggregate_info WHERE unique_actors < 5
   )
ORDER BY actor_ranking, h.production_year DESC
LIMIT 50 OFFSET 10;