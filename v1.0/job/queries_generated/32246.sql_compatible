
WITH RECURSIVE ActorHierarchy AS (
    SELECT 
        a.id AS actor_id,
        a.name AS actor_name,
        0 AS level
    FROM 
        aka_name a
    WHERE 
        a.name LIKE 'A%'  

    UNION ALL

    SELECT 
        a.id AS actor_id,
        a.name AS actor_name,
        ah.level + 1
    FROM 
        aka_name a
    JOIN 
        cast_info c ON c.person_id = a.person_id
    JOIN 
        title t ON t.id = c.movie_id
    JOIN 
        ActorHierarchy ah ON ah.actor_id = c.person_id
    WHERE 
        t.production_year > 2000
)

SELECT 
    ah.actor_name,
    COALESCE(t.production_year, 'Unknown') AS production_year,
    COUNT(DISTINCT c.movie_id) AS movie_count,
    STRING_AGG(DISTINCT t.title, ', ') AS movie_titles,
    AVG(window_ranks) AS avg_ranking
FROM 
    ActorHierarchy ah
LEFT JOIN 
    cast_info c ON c.person_id = ah.actor_id
LEFT JOIN 
    title t ON t.id = c.movie_id
LEFT JOIN LATERAL (
    SELECT 
        RANK() OVER (PARTITION BY c.person_id ORDER BY t.production_year DESC) AS window_ranks
) AS ranking ON TRUE
GROUP BY 
    ah.actor_name, t.production_year
ORDER BY 
    movie_count DESC NULLS LAST, 
    ah.actor_name;
