
WITH RECURSIVE ActorHierarchy AS (
    SELECT
        a.person_id,
        a.name,
        1 AS Level
    FROM
        aka_name a
    WHERE
        a.name IS NOT NULL
    UNION ALL
    SELECT
        ca.person_id,
        ca.name,
        ah.Level + 1
    FROM
        cast_info ci
    JOIN
        aka_name ca ON ci.person_id = ca.person_id
    JOIN
        ActorHierarchy ah ON ci.movie_id = (SELECT m.id FROM title m WHERE m.title = 'The Godfather' LIMIT 1)
)
, MovieDetails AS (
    SELECT
        t.title,
        t.production_year,
        STRING_AGG(DISTINCT pn.name ORDER BY pn.name) AS cast_names,
        COUNT(DISTINCT mc.company_id) AS company_count,
        COUNT(DISTINCT mk.keyword) AS keyword_count
    FROM
        title t
    LEFT JOIN
        complete_cast cc ON t.id = cc.movie_id
    LEFT JOIN
        cast_info ci ON cc.subject_id = ci.id
    LEFT JOIN
        aka_name pn ON ci.person_id = pn.person_id
    LEFT JOIN
        movie_companies mc ON t.id = mc.movie_id
    LEFT JOIN
        movie_keyword mk ON t.id = mk.movie_id
    WHERE
        t.production_year BETWEEN 1990 AND 2023
    GROUP BY
        t.title, t.production_year
)
SELECT
    md.title,
    md.production_year,
    md.cast_names,
    md.company_count,
    md.keyword_count,
    ah.Level AS actor_level
FROM
    MovieDetails md
LEFT JOIN
    ActorHierarchy ah ON ah.person_id IN (SELECT DISTINCT ci.person_id FROM cast_info ci WHERE ci.movie_id = (SELECT id FROM title WHERE title = md.title LIMIT 1))
ORDER BY
    md.production_year DESC,
    md.company_count DESC,
    md.keyword_count DESC;
