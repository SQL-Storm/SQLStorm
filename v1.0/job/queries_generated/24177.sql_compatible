
WITH RankedMovies AS (
    SELECT 
        t.id AS movie_id,
        t.title,
        t.production_year,
        RANK() OVER (PARTITION BY t.production_year ORDER BY t.production_year DESC, t.title) AS year_rank
    FROM 
        aka_title t
    WHERE 
        t.production_year IS NOT NULL
),
MovieDetails AS (
    SELECT 
        mk.movie_id,
        COALESCE(GROUP_CONCAT(DISTINCT c.name ORDER BY c.name SEPARATOR ', '), 'No Cast') AS cast_names,
        COALESCE(GROUP_CONCAT(DISTINCT k.keyword ORDER BY k.keyword SEPARATOR ', '), 'No Keywords') AS keywords,
        COUNT(mk.keyword_id) AS keyword_count,
        MAX(CASE WHEN mi.production_year IS NOT NULL THEN mi.production_year ELSE -1 END) AS production_year
    FROM 
        movie_keyword mk
    JOIN 
        movie_info mi ON mk.movie_id = mi.movie_id
    JOIN 
        aka_title t ON mk.movie_id = t.id
    LEFT JOIN 
        cast_info c ON mi.movie_id = c.movie_id
    LEFT JOIN 
        keyword k ON mk.keyword_id = k.id
    GROUP BY 
        mk.movie_id
)
SELECT 
    m.movie_id,
    m.title,
    m.production_year,
    md.cast_names,
    md.keywords,
    md.keyword_count,
    RANK() OVER (ORDER BY md.keyword_count DESC, m.production_year) AS keyword_rank
FROM 
    RankedMovies m
LEFT JOIN 
    MovieDetails md ON m.movie_id = md.movie_id
WHERE 
    md.keyword_count > 0 OR m.title LIKE '%Game%'
ORDER BY 
    COALESCE(m.production_year, -1) DESC, 
    md.keyword_count DESC,
    m.title;
