WITH RECURSIVE MovieHierarchy AS (
    SELECT 
        mt.id AS movie_id,
        mt.title,
        1 AS level
    FROM 
        aka_title AS mt
    WHERE 
        mt.kind_id = (SELECT id FROM kind_type WHERE kind = 'movie')
    
    UNION ALL
    
    SELECT 
        ml.linked_movie_id,
        at.title,
        mh.level + 1
    FROM 
        MovieHierarchy AS mh
    JOIN 
        movie_link AS ml ON mh.movie_id = ml.movie_id
    JOIN 
        aka_title AS at ON ml.linked_movie_id = at.id
    WHERE 
        at.kind_id = (SELECT id FROM kind_type WHERE kind = 'movie')
),
ActorMovieCount AS (
    SELECT 
        ai.person_id,
        COUNT(DISTINCT ci.movie_id) AS movie_count
    FROM 
        cast_info AS ci
    JOIN 
        aka_name AS ai ON ci.person_id = ai.person_id
    GROUP BY 
        ai.person_id
),
TitleReviews AS (
    SELECT 
        a.title,
        STRING_AGG(CASE WHEN (mi.info IS NOT NULL AND mi.info <> '') THEN mi.info ELSE 'No review' END, '; ') AS reviews
    FROM 
        aka_title AS a
    LEFT JOIN 
        movie_info AS mi ON a.movie_id = mi.movie_id AND mi.info_type_id = (SELECT id FROM info_type WHERE info = 'review')
    WHERE 
        a.production_year >= 2000
    GROUP BY 
        a.title
),
MovieTitles AS (
    SELECT 
        mt.id,
        mt.title,
        mt.production_year,
        mh.level AS hierarchy_level,
        COALESCE(ac.movie_count, 0) AS actor_count,
        COALESCE(tr.reviews, 'No reviews available') AS reviews
    FROM 
        aka_title AS mt
    LEFT JOIN 
        MovieHierarchy AS mh ON mt.id = mh.movie_id
    LEFT JOIN 
        ActorMovieCount AS ac ON mt.id = (SELECT movie_id FROM cast_info WHERE person_id = ac.person_id LIMIT 1) 
    LEFT JOIN 
        TitleReviews AS tr ON mt.title = tr.title
    WHERE 
        mt.production_year BETWEEN 2000 AND 2023
)
SELECT 
    mt.title,
    mt.production_year,
    mt.hierarchy_level,
    mt.actor_count,
    mt.reviews
FROM 
    MovieTitles AS mt
ORDER BY 
    mt.production_year DESC, 
    mt.hierarchy_level, 
    mt.actor_count DESC
LIMIT 50;