WITH RECURSIVE ActorHierarchy AS (
    SELECT ci.person_id, 
           a.name AS actor_name, 
           0 AS level
    FROM cast_info ci
    JOIN aka_name a ON ci.person_id = a.person_id
    WHERE ci.movie_id IN (SELECT id FROM aka_title WHERE production_year >= 2000)
    
    UNION ALL

    SELECT ci.person_id, 
           a.name AS actor_name, 
           ah.level + 1
    FROM cast_info ci
    JOIN aka_name a ON ci.person_id = a.person_id
    JOIN ActorHierarchy ah ON ci.movie_id = ah.person_id
),

MovieStats AS (
    SELECT at.id AS movie_id,
           at.title AS movie_title,
           COUNT(DISTINCT ci.person_id) AS total_cast,
           COUNT(DISTINCT mk.keyword) AS keyword_count
    FROM aka_title at
    LEFT JOIN cast_info ci ON at.id = ci.movie_id
    LEFT JOIN movie_keyword mk ON at.id = mk.movie_id
    WHERE at.production_year >= 2000
    GROUP BY at.id, at.title
),

DirectorStats AS (
    SELECT mc.movie_id,
           COUNT(DISTINCT mc.company_id) AS total_companies,
           STRING_AGG(DISTINCT cn.name, ', ') AS company_names
    FROM movie_companies mc
    JOIN company_name cn ON mc.company_id = cn.id
    GROUP BY mc.movie_id
)

SELECT ms.movie_id,
       ms.movie_title,
       ms.total_cast,
       ms.keyword_count,
       ds.total_companies,
       ds.company_names,
       ah.actor_name AS cast_member,
       ah.level AS hierarchy_level
FROM MovieStats ms
LEFT JOIN DirectorStats ds ON ms.movie_id = ds.movie_id
LEFT JOIN ActorHierarchy ah ON ms.movie_id = ah.person_id
WHERE ms.keyword_count > 3
ORDER BY ms.total_cast DESC, ds.total_companies DESC, ah.level ASC
LIMIT 10;