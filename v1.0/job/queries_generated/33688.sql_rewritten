WITH RECURSIVE MovieHierarchy AS (
    
    SELECT mt.id AS movie_id, mt.title, mt.production_year, 1 AS level
    FROM aka_title mt
    WHERE mt.kind_id = 1  

    UNION ALL

    
    SELECT m.id AS movie_id, m.title, m.production_year, mh.level + 1
    FROM movie_link ml
    JOIN title m ON ml.linked_movie_id = m.id
    JOIN MovieHierarchy mh ON ml.movie_id = mh.movie_id
)
SELECT
    m.title AS Movie_Title,
    m.production_year AS Production_Year,
    COALESCE(a.name, 'Unknown') AS Actor_Name,
    COUNT(DISTINCT mc.company_id) FILTER (WHERE mc.note IS NOT NULL) AS Number_of_Production_Companies,
    STRING_AGG(DISTINCT kw.keyword, ', ') AS Keywords,
    ROW_NUMBER() OVER (PARTITION BY m.id ORDER BY NULL) AS Row_Number,
    MAX(CASE WHEN pi.info_type_id = 1 THEN pi.info END) AS Director,  
    count(DISTINCT ci.person_id) AS Total_Cast
FROM
    MovieHierarchy m
LEFT JOIN cast_info ci ON ci.movie_id = m.movie_id
LEFT JOIN aka_name a ON a.person_id = ci.person_id
LEFT JOIN movie_companies mc ON mc.movie_id = m.movie_id
LEFT JOIN movie_keyword mk ON mk.movie_id = m.movie_id
LEFT JOIN keyword kw ON kw.id = mk.keyword_id
LEFT JOIN person_info pi ON pi.person_id = ci.person_id
GROUP BY
    m.movie_id, m.title, m.production_year, a.name
HAVING
    COUNT(DISTINCT ci.person_id) > 5 AND Number_of_Production_Companies > 1
ORDER BY
    Production_Year DESC, Movie_Title;