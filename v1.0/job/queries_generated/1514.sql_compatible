
WITH RankedMovies AS (
    SELECT 
        t.title, 
        t.production_year,
        ROW_NUMBER() OVER (PARTITION BY t.production_year ORDER BY t.production_year DESC) AS rn,
        COUNT(*) OVER (PARTITION BY t.production_year) AS movie_count
    FROM 
        aka_title t
    WHERE 
        t.kind_id IN (SELECT id FROM kind_type WHERE kind = 'movie')
        AND t.production_year >= 2000
),
ActorStats AS (
    SELECT 
        a.name AS actor_name,
        COUNT(DISTINCT c.movie_id) AS movies_starred,
        AVG(CASE WHEN c.nr_order IS NOT NULL THEN c.nr_order ELSE 0 END) AS avg_order,
        MAX(tm.title) AS latest_movie
    FROM 
        aka_name a
    JOIN 
        cast_info c ON a.person_id = c.person_id
    LEFT JOIN 
        title tm ON c.movie_id = tm.id
    GROUP BY 
        a.name
),
CompanyDetails AS (
    SELECT 
        cn.name AS company_name,
        COUNT(mc.movie_id) AS movies_produced,
        STRING_AGG(DISTINCT k.keyword, ', ') AS associated_keywords
    FROM 
        company_name cn
    JOIN 
        movie_companies mc ON cn.id = mc.company_id
    LEFT JOIN 
        movie_keyword mk ON mc.movie_id = mk.movie_id
    LEFT JOIN 
        keyword k ON mk.keyword_id = k.id
    GROUP BY 
        cn.name
)
SELECT 
    rm.title,
    rm.production_year,
    as.actor_name,
    as.movies_starred,
    as.avg_order,
    as.latest_movie,
    cd.company_name,
    cd.movies_produced,
    COALESCE(cd.associated_keywords, 'None') AS associated_keywords
FROM 
    RankedMovies rm
JOIN 
    ActorStats as ON rm.rn = 1
JOIN 
    CompanyDetails cd ON rm.movie_count > 1
WHERE 
    rm.production_year = 2021
ORDER BY 
    rm.production_year DESC, as.movies_starred DESC;
