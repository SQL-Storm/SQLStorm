
WITH RankedTitles AS (
    SELECT 
        t.id AS title_id,
        t.title,
        t.production_year,
        t.kind_id,
        ROW_NUMBER() OVER (PARTITION BY t.kind_id ORDER BY t.production_year DESC) AS rank
    FROM title t
    WHERE t.kind_id IN (SELECT id FROM kind_type WHERE kind IN ('movie', 'tv series'))
),
FilteredAkaNames AS (
    SELECT 
        a.name,
        COUNT(DISTINCT ci.movie_id) AS movie_count
    FROM aka_name a
    JOIN cast_info ci ON a.person_id = ci.person_id
    GROUP BY a.name
    HAVING COUNT(DISTINCT ci.movie_id) > 5
),
CompanyInformation AS (
    SELECT 
        c.name AS company_name,
        ct.kind AS company_type,
        mc.note AS company_note,
        COUNT(m.movie_id) AS produced_movies
    FROM company_name c
    JOIN movie_companies mc ON c.id = mc.company_id
    JOIN company_type ct ON mc.company_type_id = ct.id
    JOIN aka_title at ON mc.movie_id = at.movie_id
    JOIN title t ON at.movie_id = t.id
    GROUP BY c.name, ct.kind, mc.note
)
SELECT 
    rt.title,
    rt.production_year,
    fa.name AS actor_name,
    ci.role_id,
    ci.nr_order,
    ci.note AS cast_note,
    ci.movie_id,
    ci.person_id,
    co.company_name,
    co.company_type,
    co.company_note,
    co.produced_movies
FROM RankedTitles rt
JOIN cast_info ci ON rt.title_id = ci.movie_id
JOIN FilteredAkaNames fa ON ci.person_id = fa.person_id
JOIN CompanyInformation co ON ci.movie_id IN (SELECT mc.movie_id FROM movie_companies mc WHERE mc.company_id IN (SELECT c.id FROM company_name c WHERE c.country_code = 'USA'))
WHERE rt.rank <= 10
ORDER BY rt.production_year DESC, rt.title;
