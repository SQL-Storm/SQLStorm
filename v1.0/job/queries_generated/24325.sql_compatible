
WITH MovieDetails AS (
    SELECT 
        t.title,
        t.production_year,
        STRING_AGG(DISTINCT c.name, ', ') AS cast_names,
        COUNT(DISTINCT mc.company_id) AS production_company_count,
        ROW_NUMBER() OVER (PARTITION BY t.id ORDER BY t.production_year DESC) AS rn
    FROM 
        aka_title t
    LEFT JOIN 
        cast_info ci ON t.movie_id = ci.movie_id
    LEFT JOIN 
        aka_name c ON ci.person_id = c.person_id
    LEFT JOIN 
        movie_companies mc ON t.movie_id = mc.movie_id
    GROUP BY 
        t.title, t.production_year, t.id
),
TopMovies AS (
    SELECT 
        title,
        production_year,
        cast_names,
        production_company_count
    FROM 
        MovieDetails
    WHERE 
        production_company_count > 2
),
FilteredMovies AS (
    SELECT 
        title,
        production_year,
        cast_names,
        production_company_count,
        CASE 
            WHEN production_year IS NULL THEN 'Unknown Year'
            WHEN production_year >= 2000 THEN 'Modern Era'
            ELSE 'Classic'
        END AS era
    FROM 
        TopMovies
),
RankedMovies AS (
    SELECT 
        title,
        production_year,
        cast_names,
        production_company_count,
        era,
        RANK() OVER (PARTITION BY era ORDER BY production_year DESC) AS rank_within_era
    FROM 
        FilteredMovies
)
SELECT 
    f.movie_id,
    f.title,
    f.production_year,
    f.cast_names,
    f.era,
    r.rank_within_era
FROM 
    RankedMovies r
INNER JOIN 
    aka_title f ON r.title = f.title AND f.production_year = r.production_year
WHERE 
    r.rank_within_era <= 5
ORDER BY 
    f.production_year DESC, f.title;
